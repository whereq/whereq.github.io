<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Tech Stack and Target Environment Architecture Design Flow Descriptions Spark Job Submission Flow   Sequence Diagrams Components Design Configuration and Code Job Queue Management Spark Job Submissio">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark as a Service with Spring Boot">
<meta property="og:url" content="https://www.whereq.com/2024/11/05/Spark-as-a-Service-with-Spring-Boot/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:description" content="Tech Stack and Target Environment Architecture Design Flow Descriptions Spark Job Submission Flow   Sequence Diagrams Components Design Configuration and Code Job Queue Management Spark Job Submissio">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-11-05T15:39:15.000Z">
<meta property="article:modified_time" content="2025-11-21T21:23:35.870Z">
<meta property="article:author" content="Dazhi Zhang">
<meta property="article:tag" content="Spring Boot">
<meta property="article:tag" content="Spark">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/2024/11/05/Spark-as-a-Service-with-Spring-Boot/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.whereq.com/2024/11/05/Spark-as-a-Service-with-Spring-Boot/","path":"2024/11/05/Spark-as-a-Service-with-Spring-Boot/","title":"Spark as a Service with Spring Boot"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spark as a Service with Spring Boot | WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">WhereQ</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tech-Stack-and-Target-Environment"><span class="nav-number">1.</span> <span class="nav-text">Tech Stack and Target Environment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spark-Cluster"><span class="nav-number">1.1.</span> <span class="nav-text">Spark Cluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot-WebFlux-Application"><span class="nav-number">1.2.</span> <span class="nav-text">Spring Boot WebFlux Application</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Queue-and-Database"><span class="nav-number">1.3.</span> <span class="nav-text">Queue and Database</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture-Design"><span class="nav-number">2.</span> <span class="nav-text">Architecture Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#High-Level-Architecture"><span class="nav-number">2.1.</span> <span class="nav-text">High-Level Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Components"><span class="nav-number">2.2.</span> <span class="nav-text">Components</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Architecture-Diagram"><span class="nav-number">2.3.</span> <span class="nav-text">Architecture Diagram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Detailed-Architecture"><span class="nav-number">2.4.</span> <span class="nav-text">Detailed Architecture</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Flow-Descriptions"><span class="nav-number">3.</span> <span class="nav-text">Flow Descriptions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Task-Submission-Flow"><span class="nav-number">3.1.</span> <span class="nav-text">Task Submission Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spark-Job-Submission-Flow"><span class="nav-number">3.2.</span> <span class="nav-text">Spark Job Submission Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Job-History-Query"><span class="nav-number">3.3.</span> <span class="nav-text">Job History Query</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">4.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Components-Design"><span class="nav-number">5.</span> <span class="nav-text">Components Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Job-Request-Model"><span class="nav-number">5.1.</span> <span class="nav-text">1. Job Request Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Job-State-and-Status-Enums"><span class="nav-number">5.2.</span> <span class="nav-text">2. Job State and Status Enums</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Redis-Queue-Service"><span class="nav-number">5.3.</span> <span class="nav-text">3. Redis Queue Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-PostgreSQL-Service"><span class="nav-number">5.4.</span> <span class="nav-text">4. PostgreSQL Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Spark-REST-API-Service"><span class="nav-number">5.5.</span> <span class="nav-text">5. Spark REST API Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Job-Executor-Service"><span class="nav-number">5.6.</span> <span class="nav-text">6. Job Executor Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-RESTful-Endpoints"><span class="nav-number">5.7.</span> <span class="nav-text">7. RESTful Endpoints</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-1"><span class="nav-number">6.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration-and-Code"><span class="nav-number">7.</span> <span class="nav-text">Configuration and Code</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Spring-Boot-Application-Configuration"><span class="nav-number">7.1.</span> <span class="nav-text">1. Spring Boot Application Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Spark-REST-API-Configuration"><span class="nav-number">7.2.</span> <span class="nav-text">2. Spark REST API Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Redis-Configuration"><span class="nav-number">7.3.</span> <span class="nav-text">3. Redis Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-R2DBC-Configuration"><span class="nav-number">7.4.</span> <span class="nav-text">4. R2DBC Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Swagger-Configuration"><span class="nav-number">7.5.</span> <span class="nav-text">5. Swagger Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-2"><span class="nav-number">8.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Job-Queue-Management"><span class="nav-number">9.</span> <span class="nav-text">Job Queue Management</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Job-Queue-Service"><span class="nav-number">9.1.</span> <span class="nav-text">1. Job Queue Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Job-State-Management"><span class="nav-number">9.2.</span> <span class="nav-text">2. Job State Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Job-Execution"><span class="nav-number">9.3.</span> <span class="nav-text">3. Job Execution</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-3"><span class="nav-number">10.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spark-Job-Submission"><span class="nav-number">11.</span> <span class="nav-text">Spark Job Submission</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Job-Submission-Endpoint"><span class="nav-number">11.1.</span> <span class="nav-text">1. Job Submission Endpoint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Job-Execution"><span class="nav-number">11.2.</span> <span class="nav-text">2. Job Execution</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-4"><span class="nav-number">12.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-Cases"><span class="nav-number">13.</span> <span class="nav-text">Test Cases</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Job-Submission-Test"><span class="nav-number">13.1.</span> <span class="nav-text">1. Job Submission Test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Job-Execution-Test"><span class="nav-number">13.2.</span> <span class="nav-text">2. Job Execution Test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Job-History-Query-Test"><span class="nav-number">13.3.</span> <span class="nav-text">3. Job History Query Test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Job-Status-Query-Test"><span class="nav-number">13.4.</span> <span class="nav-text">4. Job Status Query Test</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-5"><span class="nav-number">14.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Global-Exception-Handler"><span class="nav-number">15.</span> <span class="nav-text">Global Exception Handler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Global-Exception-Handler-Configuration"><span class="nav-number">15.1.</span> <span class="nav-text">1. Global Exception Handler Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#-6"><span class="nav-number">16.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Project-Structure"><span class="nav-number">17.</span> <span class="nav-text">Project Structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Project-Structure-Diagram"><span class="nav-number">17.1.</span> <span class="nav-text">Project Structure Diagram</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Listening-to-Redis-Queue"><span class="nav-number">18.</span> <span class="nav-text">Listening to Redis Queue</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Redis-Queue-Listener-Configuration"><span class="nav-number">18.1.</span> <span class="nav-text">1. Redis Queue Listener Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Redis-Queue-Listener-Service"><span class="nav-number">18.2.</span> <span class="nav-text">2. Redis Queue Listener Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Redis-Configuration-for-Pub-Sub"><span class="nav-number">18.3.</span> <span class="nav-text">3. Redis Configuration for Pub&#x2F;Sub</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">126</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/11/05/Spark-as-a-Service-with-Spring-Boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Spark as a Service with Spring Boot | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spark as a Service with Spring Boot
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-11-05 10:39:15" itemprop="dateCreated datePublished" datetime="2024-11-05T10:39:15-05:00">2024-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spark/" itemprop="url" rel="index"><span itemprop="name">Spark</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spark/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><ol>
<li><a href="#tech-stack-and-environment">Tech Stack and Target Environment</a></li>
<li><a href="#architecture-design">Architecture Design</a></li>
<li><a href="#flow-description">Flow Descriptions</a><ul>
<li><a href="#spark-job-submission-flow">Spark Job Submission Flow</a></li>
</ul>
</li>
<li><a href="#sequence-diagrams">Sequence Diagrams</a></li>
<li><a href="#components-design">Components Design</a></li>
<li><a href="#configuration-and-code">Configuration and Code</a></li>
<li><a href="#job-queue-management">Job Queue Management</a></li>
<li><a href="#spark-job-submission">Spark Job Submission</a></li>
<li><a href="#test-cases">Test Cases</a></li>
<li><a href="#global-exception-handler">Global Exception Handler</a></li>
<li><a href="#project-structure">Project Structure</a></li>
</ol>
<p>In this article, we will explore the development of a stateless Spring Boot application using Spring WebFlux 3.3.5 and Apache Spark 3.5.4. This application will serve as a Spark-as-a-Service, designed to run in a Kubernetes (K8s) environment with multiple replicas. The application will use a centralized queue in Redis to manage Spark job requests, with a copy of the job queue also maintained in PostgreSQL for job history and tracking. The application will ensure that each job is executed only once, manage job states and statuses correctly, and provide RESTful endpoints for client interaction and monitoring.</p>
<p><a name="tech-stack-and-environment"></a></p>
<h2 id="Tech-Stack-and-Target-Environment"><a href="#Tech-Stack-and-Target-Environment" class="headerlink" title="Tech Stack and Target Environment"></a>Tech Stack and Target Environment</h2><h3 id="Spark-Cluster"><a href="#Spark-Cluster" class="headerlink" title="Spark Cluster"></a>Spark Cluster</h3><ul>
<li><strong>Version</strong>: 3.5.4</li>
<li><strong>Deployment</strong>: Kubernetes namespace <code>whereq-saas-spark</code></li>
<li><strong>Configuration</strong>: Default Bitnami Helm chart (1 master, 2 workers)</li>
</ul>
<h3 id="Spring-Boot-WebFlux-Application"><a href="#Spring-Boot-WebFlux-Application" class="headerlink" title="Spring Boot WebFlux Application"></a>Spring Boot WebFlux Application</h3><ul>
<li><strong>Version</strong>: 3.3.5</li>
<li><strong>Deployment</strong>: Kubernetes namespace <code>whereq-saas-web</code></li>
<li><strong>Replicas</strong>: 2</li>
<li><strong>Ingress</strong>: Exposed for frontend access</li>
</ul>
<h3 id="Queue-and-Database"><a href="#Queue-and-Database" class="headerlink" title="Queue and Database"></a>Queue and Database</h3><ul>
<li><strong>Queue</strong>: Redis (for job queue management)</li>
<li><strong>Database</strong>: PostgreSQL with R2DBC driver</li>
<li><strong>Container Orchestration</strong>: Kubernetes</li>
</ul>
<hr>
<p><a name="architecture-design"></a></p>
<h2 id="Architecture-Design"><a href="#Architecture-Design" class="headerlink" title="Architecture Design"></a>Architecture Design</h2><p>The application is structured to be stateless and scalable. It integrates with Redis to queue job submissions, PostgreSQL for persistent storage, and the Spark REST API for job submission and tracking.</p>
<h3 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h3><pre><code class="highlight mermaid">graph TD
    A[Client] --&gt;|Submit Task| B[Spring Boot Application]
    B --&gt;|Store Task Request| C[Redis Queue]
    C --&gt;|Sync Job Request| D[PostgreSQL]
    D --&gt;|Fetch Job| B
    B --&gt;|Check Cluster Status| E[Spark REST API]
    E --&gt;|Determine Resources| B
    B --&gt;|Submit Job| F[Spark Master]
    F --&gt;|Execute Job| G[Spark Worker]
    G --&gt;|Store Result| D
    B --&gt;|Query Job History| D
    B --&gt;|Monitor Job Queue| C</code></pre>

<h3 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h3><ul>
<li><strong>Job Controller</strong>: Accepts job submissions via HTTP POST and returns a task ID.</li>
<li><strong>Job Queue Service</strong>: Handles job insertion into Redis and PostgreSQL.</li>
<li><strong>Job Monitor Service</strong>: Monitors Redis, submits jobs to Spark, and tracks job status.</li>
<li><strong>Spark Service</strong>: Interfaces with the Spark REST API for job submission and status updates.</li>
<li><strong>State Machine</strong>: Manages job state transitions (e.g., ready, running, completed) and status updates (success, failed).</li>
</ul>
<h3 id="Architecture-Diagram"><a href="#Architecture-Diagram" class="headerlink" title="Architecture Diagram"></a>Architecture Diagram</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+---------------+       +---------------------+        +----------------+</span><br><span class="line">| Job Controller| ----&gt; | Job Queue Service   | -----&gt; | Redis Queue    |</span><br><span class="line">+---------------+       +---------------------+        +----------------+</span><br><span class="line">                                                            |</span><br><span class="line">   +--------------------------------------------------------+</span><br><span class="line">   |</span><br><span class="line">+-------------------+        +------------------+         +------------------+</span><br><span class="line">| Job Monitor       | -----&gt; | Spark Service    | &lt;-----&gt; | Spark Master Pod |</span><br><span class="line">| (Background Task) |        +------------------+         +------------------+</span><br><span class="line">+-------------------+             |</span><br><span class="line">                                  |</span><br><span class="line">                     +-------------------------------+</span><br><span class="line">                     |  PostgreSQL (Sync Job State)  |</span><br><span class="line">                     +-------------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="Detailed-Architecture"><a href="#Detailed-Architecture" class="headerlink" title="Detailed Architecture"></a>Detailed Architecture</h3><ol>
<li><strong>Client</strong>: Submits Spark job requests via RESTful endpoints.</li>
<li><strong>Spring Boot Application</strong>:<ul>
<li>Receives job requests.</li>
<li>Stores job requests in the Redis queue.</li>
<li>Syncs job requests with PostgreSQL.</li>
<li>Checks cluster status via Spark REST API.</li>
<li>Submits jobs to Spark Master based on available resources.</li>
<li>Manages job states and statuses.</li>
<li>Provides RESTful endpoints for job history queries and monitoring.</li>
</ul>
</li>
<li><strong>Redis Queue</strong>: Stores job requests.</li>
<li><strong>PostgreSQL</strong>: Stores job requests and history.</li>
<li><strong>Spark REST API</strong>: Provides cluster status information.</li>
<li><strong>Spark Master</strong>: Receives job submissions.</li>
<li><strong>Spark Worker</strong>: Executes Spark jobs.</li>
<li><strong>PostgreSQL</strong>: Stores job results and history.</li>
</ol>
<p><a name="flow-descriptions"></a></p>
<h2 id="Flow-Descriptions"><a href="#Flow-Descriptions" class="headerlink" title="Flow Descriptions"></a>Flow Descriptions</h2><p><a name="task-submission-flow"></a></p>
<h3 id="Task-Submission-Flow"><a href="#Task-Submission-Flow" class="headerlink" title="Task Submission Flow"></a>Task Submission Flow</h3><ol>
<li><strong>Task Controller</strong> receives task requests via HTTP POST.</li>
<li><strong>Task Queue Service</strong> validates the request, assigns a task ID, stores it in Redis with a <code>READY</code> state, and syncs it to PostgreSQL.</li>
<li>The service returns a task ID to the client.</li>
</ol>
<p><a name="spark-job-submission-flow"></a></p>
<h3 id="Spark-Job-Submission-Flow"><a href="#Spark-Job-Submission-Flow" class="headerlink" title="Spark Job Submission Flow"></a>Spark Job Submission Flow</h3><ol>
<li><strong>Job Monitor Service</strong> picks up jobs in the <code>READY</code> state from the Redis queue using FIFO.</li>
<li>The job is submitted to the Spark master via the <strong>Spark Service</strong>, and the job state is updated to <code>SUBMITTED</code>.</li>
<li>The state is synced to PostgreSQL.</li>
<li>The <strong>Job Monitor Service</strong> starts tracking the job status until completion or failure.</li>
<li>The final state (<code>COMPLETED</code> or <code>FAILED</code>) is updated in both Redis and PostgreSQL.</li>
</ol>
<hr>
<pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant SpringBootApp
    participant RedisQueue
    participant PostgreSQL
    participant SparkRESTAPI
    participant SparkMaster
    participant SparkWorker

    Client -&gt;&gt; SpringBootApp: Submit Job Request
    SpringBootApp -&gt;&gt; RedisQueue: Store Job Request
    RedisQueue -&gt;&gt; PostgreSQL: Sync Job Request
    SpringBootApp -&gt;&gt; SparkRESTAPI: Check Cluster Status
    SparkRESTAPI --&gt;&gt; SpringBootApp: Cluster Status
    SpringBootApp -&gt;&gt; SparkMaster: Submit Job
    SparkMaster -&gt;&gt; SparkWorker: Execute Job
    SparkWorker --&gt;&gt; PostgreSQL: Store Job Result
    SpringBootApp --&gt;&gt; Client: Job Status</code></pre>

<h3 id="Job-History-Query"><a href="#Job-History-Query" class="headerlink" title="Job History Query"></a>Job History Query</h3><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant SpringBootApp
    participant PostgreSQL

    Client -&gt;&gt; SpringBootApp: Query Job History
    SpringBootApp -&gt;&gt; PostgreSQL: Fetch Job History
    PostgreSQL --&gt;&gt; SpringBootApp: Job History
    SpringBootApp --&gt;&gt; Client: Job History</code></pre>

<h2 id=""><a href="#" class="headerlink" title=""></a><a name="components-design"></a></h2><h2 id="Components-Design"><a href="#Components-Design" class="headerlink" title="Components Design"></a>Components Design</h2><h3 id="1-Job-Request-Model"><a href="#1-Job-Request-Model" class="headerlink" title="1. Job Request Model"></a>1. Job Request Model</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobRequest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> String jobConfig;</span><br><span class="line">    <span class="keyword">private</span> JobState state;</span><br><span class="line">    <span class="keyword">private</span> JobStatus status;</span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Job-State-and-Status-Enums"><a href="#2-Job-State-and-Status-Enums" class="headerlink" title="2. Job State and Status Enums"></a>2. Job State and Status Enums</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">JobState</span> &#123;</span><br><span class="line">    READY, PENDING, RUNNING, COMPLETED</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">JobStatus</span> &#123;</span><br><span class="line">    SUCCESS, FAILED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Redis-Queue-Service"><a href="#3-Redis-Queue-Service" class="headerlink" title="3. Redis Queue Service"></a>3. Redis Queue Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisQueueService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, JobRequest&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisQueueService</span><span class="params">(ReactiveRedisTemplate&lt;String, JobRequest&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">enqueueJob</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().rightPush(<span class="string">&quot;jobQueue&quot;</span>, jobRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;JobRequest&gt; <span class="title function_">dequeueJob</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().leftPop(<span class="string">&quot;jobQueue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">updateJobStatusInQueue</span><span class="params">(String jobId, JobState state, JobStatus status)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().indexOf(<span class="string">&quot;jobQueue&quot;</span>, jobId)</span><br><span class="line">                .flatMap(index -&gt; redisTemplate.opsForList().set(index, <span class="keyword">new</span> <span class="title class_">JobRequest</span>(jobId, state, status)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-PostgreSQL-Service"><a href="#4-PostgreSQL-Service" class="headerlink" title="4. PostgreSQL Service"></a>4. PostgreSQL Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostgresService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> R2dbcEntityTemplate r2dbcEntityTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PostgresService</span><span class="params">(R2dbcEntityTemplate r2dbcEntityTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.r2dbcEntityTemplate = r2dbcEntityTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;JobRequest&gt; <span class="title function_">saveJobRequest</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r2dbcEntityTemplate.insert(jobRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;JobRequest&gt; <span class="title function_">getJobById</span><span class="params">(String jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r2dbcEntityTemplate.selectOne(Query.query(Criteria.where(<span class="string">&quot;id&quot;</span>).is(jobId)), JobRequest.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Integer&gt; <span class="title function_">updateJobStatus</span><span class="params">(String jobId, JobState state, JobStatus status)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r2dbcEntityTemplate.update(JobRequest.class)</span><br><span class="line">                .matching(Query.query(Criteria.where(<span class="string">&quot;id&quot;</span>).is(jobId)))</span><br><span class="line">                .apply(Update.update(<span class="string">&quot;state&quot;</span>, state).set(<span class="string">&quot;status&quot;</span>, status));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;JobRequest&gt; <span class="title function_">getJobHistory</span><span class="params">(Map&lt;String, String&gt; queryParams)</span> &#123;</span><br><span class="line">        <span class="comment">// Fetch job history from PostgreSQL</span></span><br><span class="line">        <span class="keyword">return</span> r2dbcEntityTemplate.select(JobRequest.class).all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-Spark-REST-API-Service"><a href="#5-Spark-REST-API-Service" class="headerlink" title="5. Spark REST API Service"></a>5. Spark REST API Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SparkRestApiService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SparkRestApiService</span><span class="params">(WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClientBuilder.baseUrl(<span class="string">&quot;http://spark-master:8080&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ClusterStatus&gt; <span class="title function_">getClusterStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.get()</span><br><span class="line">                .uri(<span class="string">&quot;/api/v1/applications&quot;</span>)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .bodyToMono(String.class)</span><br><span class="line">                .map(response -&gt; &#123;</span><br><span class="line">                    <span class="comment">// Parse response and return ClusterStatus</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClusterStatus</span>();</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;JobStatus&gt; <span class="title function_">monitorJobStatus</span><span class="params">(String jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.get()</span><br><span class="line">                .uri(<span class="string">&quot;/api/v1/submissions/status/&#123;jobId&#125;&quot;</span>, jobId)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .bodyToMono(String.class)</span><br><span class="line">                .map(response -&gt; &#123;</span><br><span class="line">                    <span class="comment">// Parse response and return JobStatus</span></span><br><span class="line">                    <span class="keyword">return</span> JobStatus.SUCCESS; <span class="comment">// Example</span></span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-Job-Executor-Service"><a href="#6-Job-Executor-Service" class="headerlink" title="6. Job Executor Service"></a>6. Job Executor Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisQueueService redisQueueService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostgresService postgresService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparkRestApiService sparkRestApiService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JobExecutorService</span><span class="params">(RedisQueueService redisQueueService, PostgresService postgresService, SparkRestApiService sparkRestApiService, WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisQueueService = redisQueueService;</span><br><span class="line">        <span class="built_in">this</span>.postgresService = postgresService;</span><br><span class="line">        <span class="built_in">this</span>.sparkRestApiService = sparkRestApiService;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClientBuilder.baseUrl(<span class="string">&quot;http://spark-master:8080&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">executeNextJob</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisQueueService.dequeueJob()</span><br><span class="line">                .flatMap(jobRequest -&gt; &#123;</span><br><span class="line">                    jobRequest.setState(JobState.PENDING);</span><br><span class="line">                    <span class="keyword">return</span> postgresService.updateJobStatus(jobRequest.getId(), JobState.PENDING, JobStatus.SUCCESS)</span><br><span class="line">                            .then(sparkRestApiService.getClusterStatus())</span><br><span class="line">                            .flatMap(clusterStatus -&gt; &#123;</span><br><span class="line">                                <span class="keyword">if</span> (clusterStatus.hasAvailableResources()) &#123;</span><br><span class="line">                                    <span class="keyword">return</span> submitJobToSpark(jobRequest);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">return</span> redisQueueService.enqueueJob(jobRequest).then();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">submitJobToSpark</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.post()</span><br><span class="line">                .uri(<span class="string">&quot;/v1/submissions/create&quot;</span>)</span><br><span class="line">                .bodyValue(jobRequest)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .toBodilessEntity()</span><br><span class="line">                .flatMap(response -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                        jobRequest.setState(JobState.RUNNING);</span><br><span class="line">                        <span class="keyword">return</span> postgresService.updateJobStatus(jobRequest.getId(), JobState.RUNNING, JobStatus.SUCCESS)</span><br><span class="line">                                .then(monitorJobResult(jobRequest));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        jobRequest.setState(JobState.COMPLETED);</span><br><span class="line">                        jobRequest.setStatus(JobStatus.FAILED);</span><br><span class="line">                        <span class="keyword">return</span> updateJobStatus(jobRequest);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">monitorJobResult</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sparkRestApiService.monitorJobStatus(jobRequest.getId())</span><br><span class="line">                .flatMap(jobStatus -&gt; &#123;</span><br><span class="line">                    jobRequest.setState(JobState.COMPLETED);</span><br><span class="line">                    jobRequest.setStatus(jobStatus);</span><br><span class="line">                    <span class="keyword">return</span> updateJobStatus(jobRequest);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">updateJobStatus</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisQueueService.updateJobStatusInQueue(jobRequest.getId(), jobRequest.getState(), jobRequest.getStatus())</span><br><span class="line">                .then(postgresService.updateJobStatus(jobRequest.getId(), jobRequest.getState(), jobRequest.getStatus()))</span><br><span class="line">                .then();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-RESTful-Endpoints"><a href="#7-RESTful-Endpoints" class="headerlink" title="7. RESTful Endpoints"></a>7. RESTful Endpoints</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/jobs&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobExecutorService jobExecutorService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostgresService postgresService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JobController</span><span class="params">(JobExecutorService jobExecutorService, PostgresService postgresService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jobExecutorService = jobExecutorService;</span><br><span class="line">        <span class="built_in">this</span>.postgresService = postgresService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;String&gt;&gt; <span class="title function_">submitJob</span><span class="params">(<span class="meta">@RequestBody</span> JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jobExecutorService.submitJob(jobRequest)</span><br><span class="line">                .thenReturn(ResponseEntity.ok(<span class="string">&quot;Job submitted successfully&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/history&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;JobRequest&gt; <span class="title function_">getJobHistory</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, String&gt; queryParams)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> postgresService.getJobHistory(queryParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/status&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;String&gt;&gt; <span class="title function_">getJobStatus</span><span class="params">(<span class="meta">@RequestParam</span> String jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> postgresService.getJobById(jobId)</span><br><span class="line">                .map(jobRequest -&gt; ResponseEntity.ok(jobRequest.getStatus().name()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="-1"><a href="#-1" class="headerlink" title=""></a><a name="configuration-and-code"></a></h2><h2 id="Configuration-and-Code"><a href="#Configuration-and-Code" class="headerlink" title="Configuration and Code"></a>Configuration and Code</h2><h3 id="1-Spring-Boot-Application-Configuration"><a href="#1-Spring-Boot-Application-Configuration" class="headerlink" title="1. Spring Boot Application Configuration"></a>1. Spring Boot Application Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">r2dbc:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">r2dbc:postgresql://localhost:5432/spark_jobs</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">webclient:</span></span><br><span class="line">    <span class="attr">baseUrl:</span> <span class="string">http://spark-master:8080</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Spark-REST-API-Configuration"><a href="#2-Spark-REST-API-Configuration" class="headerlink" title="2. Spark REST API Configuration"></a>2. Spark REST API Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SparkRestApiConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebClient.Builder <span class="title function_">webClientBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WebClient.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Redis-Configuration"><a href="#3-Redis-Configuration" class="headerlink" title="3. Redis Configuration"></a>3. Redis Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ReactiveRedisTemplate&lt;String, JobRequest&gt; <span class="title function_">reactiveRedisTemplate</span><span class="params">(ReactiveRedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisSerializationContext&lt;String, JobRequest&gt; serializationContext = RedisSerializationContext</span><br><span class="line">                .newSerializationContext(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>())</span><br><span class="line">                .value(<span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(JobRequest.class))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveRedisTemplate</span>&lt;&gt;(factory, serializationContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-R2DBC-Configuration"><a href="#4-R2DBC-Configuration" class="headerlink" title="4. R2DBC Configuration"></a>4. R2DBC Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R2dbcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConnectionFactory <span class="title function_">connectionFactory</span><span class="params">(R2dbcProperties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ConnectionFactories.get(properties.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> R2dbcEntityTemplate <span class="title function_">r2dbcEntityTemplate</span><span class="params">(ConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        <span class="type">DatabaseClient</span> <span class="variable">databaseClient</span> <span class="operator">=</span> DatabaseClient.create(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R2dbcEntityTemplate</span>(databaseClient);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-Swagger-Configuration"><a href="#5-Swagger-Configuration" class="headerlink" title="5. Swagger Configuration"></a>5. Swagger Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2WebFlux</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">api</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.example.sparkasaservice.controller&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><a name="job-queue-management"></a></h2><h2 id="Job-Queue-Management"><a href="#Job-Queue-Management" class="headerlink" title="Job Queue Management"></a>Job Queue Management</h2><h3 id="1-Job-Queue-Service"><a href="#1-Job-Queue-Service" class="headerlink" title="1. Job Queue Service"></a>1. Job Queue Service</h3><p>The <code>RedisQueueService</code> class is responsible for managing the job queue in Redis.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisQueueService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, JobRequest&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisQueueService</span><span class="params">(ReactiveRedisTemplate&lt;String, JobRequest&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">enqueueJob</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().rightPush(<span class="string">&quot;jobQueue&quot;</span>, jobRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;JobRequest&gt; <span class="title function_">dequeueJob</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().leftPop(<span class="string">&quot;jobQueue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">updateJobStatusInQueue</span><span class="params">(String jobId, JobState state, JobStatus status)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList().indexOf(<span class="string">&quot;jobQueue&quot;</span>, jobId)</span><br><span class="line">                .flatMap(index -&gt; redisTemplate.opsForList().set(index, <span class="keyword">new</span> <span class="title class_">JobRequest</span>(jobId, state, status)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Job-State-Management"><a href="#2-Job-State-Management" class="headerlink" title="2. Job State Management"></a>2. Job State Management</h3><p>The <code>JobRequest</code> class includes fields for <code>JobState</code> and <code>JobStatus</code> to manage the state and status of each job.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobRequest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> String jobConfig;</span><br><span class="line">    <span class="keyword">private</span> JobState state;</span><br><span class="line">    <span class="keyword">private</span> JobStatus status;</span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Job-Execution"><a href="#3-Job-Execution" class="headerlink" title="3. Job Execution"></a>3. Job Execution</h3><p>The <code>JobExecutorService</code> class is responsible for executing jobs from the queue. It ensures that each job is executed only once and updates the job state and status accordingly.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisQueueService redisQueueService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostgresService postgresService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparkRestApiService sparkRestApiService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JobExecutorService</span><span class="params">(RedisQueueService redisQueueService, PostgresService postgresService, SparkRestApiService sparkRestApiService, WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisQueueService = redisQueueService;</span><br><span class="line">        <span class="built_in">this</span>.postgresService = postgresService;</span><br><span class="line">        <span class="built_in">this</span>.sparkRestApiService = sparkRestApiService;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClientBuilder.baseUrl(<span class="string">&quot;http://spark-master:8080&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">executeNextJob</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisQueueService.dequeueJob()</span><br><span class="line">                .flatMap(jobRequest -&gt; &#123;</span><br><span class="line">                    jobRequest.setState(JobState.PENDING);</span><br><span class="line">                    <span class="keyword">return</span> postgresService.updateJobStatus(jobRequest.getId(), JobState.PENDING, JobStatus.SUCCESS)</span><br><span class="line">                            .then(sparkRestApiService.getClusterStatus())</span><br><span class="line">                            .flatMap(clusterStatus -&gt; &#123;</span><br><span class="line">                                <span class="keyword">if</span> (clusterStatus.hasAvailableResources()) &#123;</span><br><span class="line">                                    <span class="keyword">return</span> submitJobToSpark(jobRequest);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">return</span> redisQueueService.enqueueJob(jobRequest).then();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">submitJobToSpark</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.post()</span><br><span class="line">                .uri(<span class="string">&quot;/v1/submissions/create&quot;</span>)</span><br><span class="line">                .bodyValue(jobRequest)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .toBodilessEntity()</span><br><span class="line">                .flatMap(response -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                        jobRequest.setState(JobState.RUNNING);</span><br><span class="line">                        <span class="keyword">return</span> postgresService.updateJobStatus(jobRequest.getId(), JobState.RUNNING, JobStatus.SUCCESS)</span><br><span class="line">                                .then(monitorJobResult(jobRequest));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        jobRequest.setState(JobState.COMPLETED);</span><br><span class="line">                        jobRequest.setStatus(JobStatus.FAILED);</span><br><span class="line">                        <span class="keyword">return</span> updateJobStatus(jobRequest);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">monitorJobResult</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sparkRestApiService.monitorJobStatus(jobRequest.getId())</span><br><span class="line">                .flatMap(jobStatus -&gt; &#123;</span><br><span class="line">                    jobRequest.setState(JobState.COMPLETED);</span><br><span class="line">                    jobRequest.setStatus(jobStatus);</span><br><span class="line">                    <span class="keyword">return</span> updateJobStatus(jobRequest);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">updateJobStatus</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisQueueService.updateJobStatusInQueue(jobRequest.getId(), jobRequest.getState(), jobRequest.getStatus())</span><br><span class="line">                .then(postgresService.updateJobStatus(jobRequest.getId(), jobRequest.getState(), jobRequest.getStatus()))</span><br><span class="line">                .then();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="-3"><a href="#-3" class="headerlink" title=""></a><a name="spark-job-submission"></a></h2><h2 id="Spark-Job-Submission"><a href="#Spark-Job-Submission" class="headerlink" title="Spark Job Submission"></a>Spark Job Submission</h2><h3 id="1-Job-Submission-Endpoint"><a href="#1-Job-Submission-Endpoint" class="headerlink" title="1. Job Submission Endpoint"></a>1. Job Submission Endpoint</h3><p>The <code>JobController</code> class provides an endpoint for submitting jobs. It uses the <code>JobExecutorService</code> to handle job submission.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/jobs&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobExecutorService jobExecutorService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostgresService postgresService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JobController</span><span class="params">(JobExecutorService jobExecutorService, PostgresService postgresService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jobExecutorService = jobExecutorService;</span><br><span class="line">        <span class="built_in">this</span>.postgresService = postgresService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;String&gt;&gt; <span class="title function_">submitJob</span><span class="params">(<span class="meta">@RequestBody</span> JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jobExecutorService.submitJob(jobRequest)</span><br><span class="line">                .thenReturn(ResponseEntity.ok(<span class="string">&quot;Job submitted successfully&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/history&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;JobRequest&gt; <span class="title function_">getJobHistory</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, String&gt; queryParams)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> postgresService.getJobHistory(queryParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/status&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;String&gt;&gt; <span class="title function_">getJobStatus</span><span class="params">(<span class="meta">@RequestParam</span> String jobId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> postgresService.getJobById(jobId)</span><br><span class="line">                .map(jobRequest -&gt; ResponseEntity.ok(jobRequest.getStatus().name()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Job-Execution"><a href="#2-Job-Execution" class="headerlink" title="2. Job Execution"></a>2. Job Execution</h3><p>The <code>JobExecutorService</code> class is responsible for executing jobs from the queue. It ensures that each job is executed only once and updates the job state and status accordingly.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisQueueService redisQueueService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostgresService postgresService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparkRestApiService sparkRestApiService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JobExecutorService</span><span class="params">(RedisQueueService redisQueueService, PostgresService postgresService, SparkRestApiService sparkRestApiService, WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisQueueService = redisQueueService;</span><br><span class="line">        <span class="built_in">this</span>.postgresService = postgresService;</span><br><span class="line">        <span class="built_in">this</span>.sparkRestApiService = sparkRestApiService;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClientBuilder.baseUrl(<span class="string">&quot;http://spark-master:8080&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">executeNextJob</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisQueueService.dequeueJob()</span><br><span class="line">                .flatMap(jobRequest -&gt; &#123;</span><br><span class="line">                    jobRequest.setState(JobState.PENDING);</span><br><span class="line">                    <span class="keyword">return</span> postgresService.updateJobStatus(jobRequest.getId(), JobState.PENDING, JobStatus.SUCCESS)</span><br><span class="line">                            .then(sparkRestApiService.getClusterStatus())</span><br><span class="line">                            .flatMap(clusterStatus -&gt; &#123;</span><br><span class="line">                                <span class="keyword">if</span> (clusterStatus.hasAvailableResources()) &#123;</span><br><span class="line">                                    <span class="keyword">return</span> submitJobToSpark(jobRequest);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">return</span> redisQueueService.enqueueJob(jobRequest).then();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">submitJobToSpark</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.post()</span><br><span class="line">                .uri(<span class="string">&quot;/v1/submissions/create&quot;</span>)</span><br><span class="line">                .bodyValue(jobRequest)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .toBodilessEntity()</span><br><span class="line">                .flatMap(response -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                        jobRequest.setState(JobState.RUNNING);</span><br><span class="line">                        <span class="keyword">return</span> postgresService.updateJobStatus(jobRequest.getId(), JobState.RUNNING, JobStatus.SUCCESS)</span><br><span class="line">                                .then(monitorJobResult(jobRequest));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        jobRequest.setState(JobState.COMPLETED);</span><br><span class="line">                        jobRequest.setStatus(JobStatus.FAILED);</span><br><span class="line">                        <span class="keyword">return</span> updateJobStatus(jobRequest);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">monitorJobResult</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sparkRestApiService.monitorJobStatus(jobRequest.getId())</span><br><span class="line">                .flatMap(jobStatus -&gt; &#123;</span><br><span class="line">                    jobRequest.setState(JobState.COMPLETED);</span><br><span class="line">                    jobRequest.setStatus(jobStatus);</span><br><span class="line">                    <span class="keyword">return</span> updateJobStatus(jobRequest);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">updateJobStatus</span><span class="params">(JobRequest jobRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisQueueService.updateJobStatusInQueue(jobRequest.getId(), jobRequest.getState(), jobRequest.getStatus())</span><br><span class="line">                .then(postgresService.updateJobStatus(jobRequest.getId(), jobRequest.getState(), jobRequest.getStatus()))</span><br><span class="line">                .then();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="-4"><a href="#-4" class="headerlink" title=""></a><a name="test-cases"></a></h2><h2 id="Test-Cases"><a href="#Test-Cases" class="headerlink" title="Test Cases"></a>Test Cases</h2><h3 id="1-Job-Submission-Test"><a href="#1-Job-Submission-Test" class="headerlink" title="1. Job Submission Test"></a>1. Job Submission Test</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureWebTestClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobControllerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebTestClient webTestClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJobSubmission</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JobRequest</span> <span class="variable">jobRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobRequest</span>();</span><br><span class="line">        jobRequest.setId(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        jobRequest.setJobName(<span class="string">&quot;TestJob&quot;</span>);</span><br><span class="line">        jobRequest.setJobConfig(<span class="string">&quot;SELECT * FROM test_table&quot;</span>);</span><br><span class="line"></span><br><span class="line">        webTestClient.post().uri(<span class="string">&quot;/api/jobs&quot;</span>)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .bodyValue(jobRequest)</span><br><span class="line">                .exchange()</span><br><span class="line">                .expectStatus().isOk()</span><br><span class="line">                .expectBody(String.class).isEqualTo(<span class="string">&quot;Job submitted successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Job-Execution-Test"><a href="#2-Job-Execution-Test" class="headerlink" title="2. Job Execution Test"></a>2. Job Execution Test</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobExecutorServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobExecutorService jobExecutorService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisQueueService redisQueueService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PostgresService postgresService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJobExecution</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JobRequest</span> <span class="variable">jobRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobRequest</span>();</span><br><span class="line">        jobRequest.setId(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        jobRequest.setJobName(<span class="string">&quot;TestJob&quot;</span>);</span><br><span class="line">        jobRequest.setJobConfig(<span class="string">&quot;SELECT * FROM test_table&quot;</span>);</span><br><span class="line"></span><br><span class="line">        StepVerifier.create(redisQueueService.enqueueJob(jobRequest)</span><br><span class="line">                .then(jobExecutorService.executeNextJob())</span><br><span class="line">                .then(postgresService.getJobById(<span class="string">&quot;1&quot;</span>)))</span><br><span class="line">                .expectNextMatches(executedJob -&gt; &#123;</span><br><span class="line">                    assertNotNull(executedJob);</span><br><span class="line">                    assertEquals(JobState.COMPLETED, executedJob.getState());</span><br><span class="line">                    assertEquals(JobStatus.SUCCESS, executedJob.getStatus());</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                .verifyComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Job-History-Query-Test"><a href="#3-Job-History-Query-Test" class="headerlink" title="3. Job History Query Test"></a>3. Job History Query Test</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureWebTestClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobControllerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebTestClient webTestClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJobHistoryQuery</span><span class="params">()</span> &#123;</span><br><span class="line">        webTestClient.get().uri(uriBuilder -&gt; uriBuilder</span><br><span class="line">                .path(<span class="string">&quot;/api/jobs/history&quot;</span>)</span><br><span class="line">                .queryParam(<span class="string">&quot;jobName&quot;</span>, <span class="string">&quot;TestJob&quot;</span>)</span><br><span class="line">                .build())</span><br><span class="line">                .exchange()</span><br><span class="line">                .expectStatus().isOk()</span><br><span class="line">                .expectBodyList(JobRequest.class)</span><br><span class="line">                .value(jobRequests -&gt; &#123;</span><br><span class="line">                    assertNotNull(jobRequests);</span><br><span class="line">                    assertTrue(jobRequests.stream().anyMatch(jobRequest -&gt; <span class="string">&quot;TestJob&quot;</span>.equals(jobRequest.getJobName())));</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Job-Status-Query-Test"><a href="#4-Job-Status-Query-Test" class="headerlink" title="4. Job Status Query Test"></a>4. Job Status Query Test</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureWebTestClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobControllerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebTestClient webTestClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJobStatusQuery</span><span class="params">()</span> &#123;</span><br><span class="line">        webTestClient.get().uri(<span class="string">&quot;/api/jobs/status?jobId=1&quot;</span>)</span><br><span class="line">                .exchange()</span><br><span class="line">                .expectStatus().isOk()</span><br><span class="line">                .expectBody(String.class).isEqualTo(<span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="-5"><a href="#-5" class="headerlink" title=""></a><a name="global-exception-handler"></a></h2><h2 id="Global-Exception-Handler"><a href="#Global-Exception-Handler" class="headerlink" title="Global Exception Handler"></a>Global Exception Handler</h2><h3 id="1-Global-Exception-Handler-Configuration"><a href="#1-Global-Exception-Handler-Configuration" class="headerlink" title="1. Global Exception Handler Configuration"></a>1. Global Exception Handler Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handleException</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(<span class="string">&quot;An error occurred: &quot;</span> + ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(WebClientResponseException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handleWebClientResponseException</span><span class="params">(WebClientResponseException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(ex.getStatusCode()).body(<span class="string">&quot;WebClient error: &quot;</span> + ex.getResponseBodyAsString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(R2dbcDataIntegrityViolationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handleDataIntegrityViolationException</span><span class="params">(R2dbcDataIntegrityViolationException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST).body(<span class="string">&quot;Data integrity violation: &quot;</span> + ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="-6"><a href="#-6" class="headerlink" title=""></a><a name="project-structure"></a></h2><h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><h3 id="Project-Structure-Diagram"><a href="#Project-Structure-Diagram" class="headerlink" title="Project Structure Diagram"></a>Project Structure Diagram</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">spark-as-a-service/</span><br><span class="line"> src/</span><br><span class="line">    main/</span><br><span class="line">       java/</span><br><span class="line">          com/</span><br><span class="line">              example/</span><br><span class="line">                  sparkasaservice/</span><br><span class="line">                      config/</span><br><span class="line">                         RedisConfig.java</span><br><span class="line">                         SparkRestApiConfig.java</span><br><span class="line">                         R2dbcConfig.java</span><br><span class="line">                         SwaggerConfig.java</span><br><span class="line">                      controller/</span><br><span class="line">                         JobController.java</span><br><span class="line">                      exception/</span><br><span class="line">                         GlobalExceptionHandler.java</span><br><span class="line">                      model/</span><br><span class="line">                         JobRequest.java</span><br><span class="line">                         JobState.java</span><br><span class="line">                         JobStatus.java</span><br><span class="line">                      repository/</span><br><span class="line">                         JobRepository.java</span><br><span class="line">                      service/</span><br><span class="line">                         JobExecutorService.java</span><br><span class="line">                         PostgresService.java</span><br><span class="line">                         RedisQueueService.java</span><br><span class="line">                         SparkRestApiService.java</span><br><span class="line">                      SparkAsAServiceApplication.java</span><br><span class="line">       resources/</span><br><span class="line">           application.yml</span><br><span class="line">           schema.sql</span><br><span class="line">    test/</span><br><span class="line">        java/</span><br><span class="line">           com/</span><br><span class="line">               example/</span><br><span class="line">                   sparkasaservice/</span><br><span class="line">                       controller/</span><br><span class="line">                          JobControllerTest.java</span><br><span class="line">                       service/</span><br><span class="line">                          JobExecutorServiceTest.java</span><br><span class="line">                       SparkAsAServiceApplicationTests.java</span><br><span class="line">        resources/</span><br><span class="line">            application-test.yml</span><br><span class="line"> pom.xml</span><br></pre></td></tr></table></figure>

<h2 id="Listening-to-Redis-Queue"><a href="#Listening-to-Redis-Queue" class="headerlink" title="Listening to Redis Queue"></a>Listening to Redis Queue</h2><h3 id="1-Redis-Queue-Listener-Configuration"><a href="#1-Redis-Queue-Listener-Configuration" class="headerlink" title="1. Redis Queue Listener Configuration"></a>1. Redis Queue Listener Configuration</h3><p>To listen to the Redis queue and trigger the <code>executeNextJob</code> method, we can use Spring Data Rediss reactive support with Lettuce as the Redis client.</p>
<h3 id="2-Redis-Queue-Listener-Service"><a href="#2-Redis-Queue-Listener-Service" class="headerlink" title="2. Redis Queue Listener Service"></a>2. Redis Queue Listener Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisQueueListenerService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobExecutorService jobExecutorService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, JobRequest&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisQueueListenerService</span><span class="params">(JobExecutorService jobExecutorService, ReactiveRedisTemplate&lt;String, JobRequest&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jobExecutorService = jobExecutorService;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startListening</span><span class="params">()</span> &#123;</span><br><span class="line">        redisTemplate.listenToPattern(<span class="string">&quot;__keyevent@*__:rpush&quot;</span>)</span><br><span class="line">                .doOnNext(message -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (message.getChannel().equals(<span class="string">&quot;__keyevent@0__:rpush&quot;</span>) &amp;&amp; message.getMessage().equals(<span class="string">&quot;jobQueue&quot;</span>)) &#123;</span><br><span class="line">                        jobExecutorService.executeNextJob().subscribe();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Redis-Configuration-for-Pub-Sub"><a href="#3-Redis-Configuration-for-Pub-Sub" class="headerlink" title="3. Redis Configuration for Pub&#x2F;Sub"></a>3. Redis Configuration for Pub&#x2F;Sub</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ReactiveRedisTemplate&lt;String, JobRequest&gt; <span class="title function_">reactiveRedisTemplate</span><span class="params">(ReactiveRedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisSerializationContext&lt;String, JobRequest&gt; serializationContext = RedisSerializationContext</span><br><span class="line">                .newSerializationContext(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>())</span><br><span class="line">                .value(<span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(JobRequest.class))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveRedisTemplate</span>&lt;&gt;(factory, serializationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ReactiveRedisConnectionFactory <span class="title function_">reactiveRedisConnectionFactory</span><span class="params">(RedisProperties redisProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(redisProperties.getHost(), redisProperties.getPort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This article provides a comprehensive guide to developing a stateless Spring Boot application for Spark as a Service, along with detailed explanations of job queue management, Spark job submission, and test cases. Each section is designed to be detailed and actionable, ensuring that readers can implement the concepts effectively.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spring-Boot/" rel="tag"><i class="fa fa-tag"></i> Spring Boot</a>
              <a href="/tags/Spark/" rel="tag"><i class="fa fa-tag"></i> Spark</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/11/04/Design-Pattern-Template-Method/" rel="prev" title="Design Pattern - Template Method">
                  <i class="fa fa-angle-left"></i> Design Pattern - Template Method
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/11/05/Kubernetes-Node-Lifecycle-Overview/" rel="next" title="Kubernetes Node Lifecycle Overview">
                  Kubernetes Node Lifecycle Overview <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
