<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Architecture Overview Diagram: Architecture Overview   Prerequisites 1. Configuring Google Cloud Storage (GCS) Bucket 2. Deploying PostgreSQL for Hive Metadata PostgreSQL YAML   3. Installing Hive Me">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark in Kubernetes">
<meta property="og:url" content="https://www.whereq.com/2024/10/28/Spark-in-Kubernetes/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:description" content="Architecture Overview Diagram: Architecture Overview   Prerequisites 1. Configuring Google Cloud Storage (GCS) Bucket 2. Deploying PostgreSQL for Hive Metadata PostgreSQL YAML   3. Installing Hive Me">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-10-28T15:55:22.000Z">
<meta property="article:modified_time" content="2024-10-28T16:09:57.835Z">
<meta property="article:author" content="Dazhi Zhang">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Spark">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/2024/10/28/Spark-in-Kubernetes/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://www.whereq.com/2024/10/28/Spark-in-Kubernetes/","path":"2024/10/28/Spark-in-Kubernetes/","title":"Spark in Kubernetes"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spark in Kubernetes | WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">WhereQ</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture-Overview"><span class="nav-number">1.</span> <span class="nav-text">Architecture Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Diagram-Architecture-Overview"><span class="nav-number">1.1.</span> <span class="nav-text">Diagram: Architecture Overview</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prerequisites"><span class="nav-number">2.</span> <span class="nav-text">Prerequisites</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Configuring-Google-Cloud-Storage-GCS-Bucket"><span class="nav-number">3.</span> <span class="nav-text">1. Configuring Google Cloud Storage (GCS) Bucket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Deploying-PostgreSQL-for-Hive-Metadata"><span class="nav-number">4.</span> <span class="nav-text">2. Deploying PostgreSQL for Hive Metadata</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PostgreSQL-YAML"><span class="nav-number">4.1.</span> <span class="nav-text">PostgreSQL YAML</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Installing-Hive-Metastore"><span class="nav-number">5.</span> <span class="nav-text">3. Installing Hive Metastore</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive-Configuration"><span class="nav-number">5.1.</span> <span class="nav-text">Hive Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Deploying-Spark-Master-and-Workers"><span class="nav-number">6.</span> <span class="nav-text">4. Deploying Spark Master and Workers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spark-Master-and-Worker-StatefulSet-YAML"><span class="nav-number">6.1.</span> <span class="nav-text">Spark Master and Worker StatefulSet YAML</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Setting-Up-the-Spark-History-Server"><span class="nav-number">7.</span> <span class="nav-text">5. Setting Up the Spark History Server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spark-History-Server-YAML"><span class="nav-number">7.1.</span> <span class="nav-text">Spark History Server YAML</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Configuring-Ingress"><span class="nav-number">8.</span> <span class="nav-text">6. Configuring Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ingress-YAML"><span class="nav-number">8.1.</span> <span class="nav-text">Ingress YAML</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Testing-the-Deployment-with-Spark-Job"><span class="nav-number">9.</span> <span class="nav-text">7. Testing the Deployment with Spark Job</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Furthermore"><span class="nav-number">10.</span> <span class="nav-text">Furthermore</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#StatefulSet-vs-Deployment"><span class="nav-number">10.1.</span> <span class="nav-text">StatefulSet vs Deployment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Spark-Master-and-Worker-as-StatefulSets"><span class="nav-number">10.2.</span> <span class="nav-text">1. Spark Master and Worker as StatefulSets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Spark-History-Server-as-a-Deployment"><span class="nav-number">10.3.</span> <span class="nav-text">2. Spark History Server as a Deployment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary-Table"><span class="nav-number">11.</span> <span class="nav-text">Summary Table</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">138</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">123</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">82</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Spark-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Spark in Kubernetes | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spark in Kubernetes
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 11:55:22 / Modified: 12:09:57" itemprop="dateCreated datePublished" datetime="2024-10-28T11:55:22-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/Spark/" itemprop="url" rel="index"><span itemprop="name">Spark</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><ul>
<li><a href="#architecture-overview">Architecture Overview</a><ul>
<li><a href="#diagram-architecture-overview">Diagram: Architecture Overview</a></li>
</ul>
</li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#1-configuring-google-cloud-storage-gcs-bucket">1. Configuring Google Cloud Storage (GCS) Bucket</a></li>
<li><a href="#2-deploying-postgresql-for-hive-metadata">2. Deploying PostgreSQL for Hive Metadata</a><ul>
<li><a href="#postgresql-yaml">PostgreSQL YAML</a></li>
</ul>
</li>
<li><a href="#3-installing-hive-metastore">3. Installing Hive Metastore</a><ul>
<li><a href="#hive-configuration">Hive Configuration</a></li>
</ul>
</li>
<li><a href="#4-deploying-spark-master-and-workers">4. Deploying Spark Master and Workers</a><ul>
<li><a href="#spark-master-and-worker-statefulset-yaml">Spark Master and Worker StatefulSet YAML</a></li>
</ul>
</li>
<li><a href="#5-setting-up-the-spark-history-server">5. Setting Up the Spark History Server</a><ul>
<li><a href="#spark-history-server-yaml">Spark History Server YAML</a></li>
</ul>
</li>
<li><a href="#6-configuring-ingress">6. Configuring Ingress</a><ul>
<li><a href="#ingress-yaml">Ingress YAML</a></li>
</ul>
</li>
<li><a href="#7-testing-the-deployment-with-spark-job">7. Testing the Deployment with Spark Job</a></li>
<li><a href="#furthermore">Furthermore</a><ul>
<li><a href="#statefulset-vs-deployment">StatefulSet vs Deployment</a></li>
<li><a href="#1-spark-master-and-worker-as-statefulsets">1. <strong>Spark Master and Worker as StatefulSets</strong></a></li>
<li><a href="#2-spark-history-server-as-a-deployment">2. <strong>Spark History Server as a Deployment</strong></a></li>
</ul>
</li>
<li><a href="#summary-table">Summary Table</a></li>
</ul>
<hr>
<p>This guide covers the steps to deploy an Apache Spark cluster with a master, two workers, and a Spark History Server on Kubernetes. It configures a GCS bucket as the default file system and installs Hive with PostgreSQL as its backend. An Ingress is set up for accessing the Spark UI and History Server.</p>
<p><a name="architecture-overview"></a></p>
<h2 id="Architecture-Overview"><a href="#Architecture-Overview" class="headerlink" title="Architecture Overview"></a>Architecture Overview</h2><p>The setup includes the following components:</p>
<ul>
<li><strong>Spark Master and Workers</strong>: Deployed using StatefulSets for stable identity and persistence.</li>
<li><strong>History Server</strong>: Deployed using a Deployment and configured to store Spark event logs in GCS.</li>
<li><strong>Hive and PostgreSQL</strong>: PostgreSQL is used as the backend for Hive metadata, and Hive is deployed to store Spark tables.</li>
<li><strong>Ingress</strong>: Provides external access to Spark Master UI and History Server UI.</li>
</ul>
<h3 id="Diagram-Architecture-Overview"><a href="#Diagram-Architecture-Overview" class="headerlink" title="Diagram: Architecture Overview"></a>Diagram: Architecture Overview</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------+</span><br><span class="line">|                           |</span><br><span class="line">|        Kubernetes         |</span><br><span class="line">|                           |</span><br><span class="line">+---------------------------+</span><br><span class="line">|                           |</span><br><span class="line">|  +---------+   +---------+|</span><br><span class="line">|  |  Spark  |   |  Spark  ||</span><br><span class="line">|  |  Master |   | Workers ||</span><br><span class="line">|  +---------+   +---------+|</span><br><span class="line">|                           |</span><br><span class="line">|        +-----------+      |</span><br><span class="line">|        |  History  |      |</span><br><span class="line">|        |  Server   |      |</span><br><span class="line">|        +-----------+      |</span><br><span class="line">|            |              |</span><br><span class="line">|         Ingress           |</span><br><span class="line">+---------------------------+</span><br><span class="line">           |</span><br><span class="line">    External Access</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="prerequisites"></a></p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li><strong>Kubernetes Cluster</strong> with access to deploy resources.</li>
<li><strong>kubectl</strong> command-line tool configured to access the cluster.</li>
<li><strong>Helm</strong> for deploying Hive and PostgreSQL.</li>
<li><strong>Google Cloud Storage (GCS)</strong> bucket created for Spark event logs.</li>
<li><strong>Google Cloud SDK</strong> installed and configured for authentication to GCS.</li>
</ul>
<hr>
<p><a name="1-configuring-google-cloud-storage-gcs-bucket"></a></p>
<h2 id="1-Configuring-Google-Cloud-Storage-GCS-Bucket"><a href="#1-Configuring-Google-Cloud-Storage-GCS-Bucket" class="headerlink" title="1. Configuring Google Cloud Storage (GCS) Bucket"></a>1. Configuring Google Cloud Storage (GCS) Bucket</h2><ol>
<li><p>Create a GCS bucket if not already created:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gsutil mb gs://your-spark-event-logs</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set up a GCS service account key and save it as a Kubernetes secret. This will allow Spark to access GCS:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic gcs-key \</span><br><span class="line">--from-file=key.json=/path/to/gcs-service-account-key.json</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p><a name="2-deploying-postgresql-for-hive-metadata"></a></p>
<h2 id="2-Deploying-PostgreSQL-for-Hive-Metadata"><a href="#2-Deploying-PostgreSQL-for-Hive-Metadata" class="headerlink" title="2. Deploying PostgreSQL for Hive Metadata"></a>2. Deploying PostgreSQL for Hive Metadata</h2><p>PostgreSQL will act as the relational database for Hive’s metadata.</p>
<h3 id="PostgreSQL-YAML"><a href="#PostgreSQL-YAML" class="headerlink" title="PostgreSQL YAML"></a>PostgreSQL YAML</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgresql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;hive_metastore&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;hiveuser&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;hivepassword&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/var/lib/postgresql/data&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">postgresql-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql-data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">postgresql-pvc</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="3-installing-hive-metastore"></a></p>
<h2 id="3-Installing-Hive-Metastore"><a href="#3-Installing-Hive-Metastore" class="headerlink" title="3. Installing Hive Metastore"></a>3. Installing Hive Metastore</h2><p>Hive Metastore will manage metadata for Spark. </p>
<h3 id="Hive-Configuration"><a href="#Hive-Configuration" class="headerlink" title="Hive Configuration"></a>Hive Configuration</h3><ol>
<li><p>Download and install Hive Helm chart:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm install hive bitnami/hive --<span class="built_in">set</span> postgresql.enabled=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Update Hive configuration to use PostgreSQL.</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Values.yaml for Hive</span></span><br><span class="line"><span class="attr">hive:</span></span><br><span class="line">  <span class="attr">metastore:</span></span><br><span class="line">    <span class="attr">databaseType:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">jdbcUrl:</span> <span class="string">jdbc:postgresql://postgresql-service/hive_metastore</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">hiveuser</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hivepassword</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="4-deploying-spark-master-and-workers"></a></p>
<h2 id="4-Deploying-Spark-Master-and-Workers"><a href="#4-Deploying-Spark-Master-and-Workers" class="headerlink" title="4. Deploying Spark Master and Workers"></a>4. Deploying Spark Master and Workers</h2><h3 id="Spark-Master-and-Worker-StatefulSet-YAML"><a href="#Spark-Master-and-Worker-StatefulSet-YAML" class="headerlink" title="Spark Master and Worker StatefulSet YAML"></a>Spark Master and Worker StatefulSet YAML</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">spark-master</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">spark-master</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">spark</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">spark</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">spark-master</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">spark:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">7077</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPARK_MASTER_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;spark-master&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">spark-worker</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">spark</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">spark</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">spark-worker</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">spark:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPARK_WORKER_CORES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPARK_WORKER_MEMORY</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1G&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPARK_MASTER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;spark://spark-master:7077&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="5-setting-up-the-spark-history-server"></a></p>
<h2 id="5-Setting-Up-the-Spark-History-Server"><a href="#5-Setting-Up-the-Spark-History-Server" class="headerlink" title="5. Setting Up the Spark History Server"></a>5. Setting Up the Spark History Server</h2><p>The History Server will read event logs from the GCS bucket for job history.</p>
<h3 id="Spark-History-Server-YAML"><a href="#Spark-History-Server-YAML" class="headerlink" title="Spark History Server YAML"></a>Spark History Server YAML</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">spark-history-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">spark-history</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">spark-history</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">spark-history-server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">spark:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPARK_HISTORY_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-Dspark.history.fs.logDirectory=gs://your-spark-event-logs&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/spark/work-dir</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gcs-key</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">key.json</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcs-key</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">gcs-key</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="6-configuring-ingress"></a></p>
<h2 id="6-Configuring-Ingress"><a href="#6-Configuring-Ingress" class="headerlink" title="6. Configuring Ingress"></a>6. Configuring Ingress</h2><p>Ingress will expose the Spark Master UI and History Server UI.</p>
<h3 id="Ingress-YAML"><a href="#Ingress-YAML" class="headerlink" title="Ingress YAML"></a>Ingress YAML</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">spark-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">spark.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/master</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">spark-master</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/history</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">spark-history-server</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">18080</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="7-testing-the-deployment-with-spark-job"></a></p>
<h2 id="7-Testing-the-Deployment-with-Spark-Job"><a href="#7-Testing-the-Deployment-with-Spark-Job" class="headerlink" title="7. Testing the Deployment with Spark Job"></a>7. Testing the Deployment with Spark Job</h2><p>To verify the installation, use <code>spark-submit</code> to run a simple calculation for PI.</p>
<ol>
<li><p>Submit a PI calculation job using <code>spark-submit</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it spark-master-0 -- spark-submit \</span><br><span class="line">--class org.apache.spark.examples.SparkPi \</span><br><span class="line">--master spark://spark-master:7077 \</span><br><span class="line">/opt/spark/examples/jars/spark-examples_2.12-3.0.1.jar 1000</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check the Spark Master and History Server UIs</p>
</li>
</ol>
<p> to confirm job execution and view logs.</p>
<h2 id="Furthermore"><a href="#Furthermore" class="headerlink" title="Furthermore"></a>Furthermore</h2><h3 id="StatefulSet-vs-Deployment"><a href="#StatefulSet-vs-Deployment" class="headerlink" title="StatefulSet vs Deployment"></a>StatefulSet vs Deployment</h3><p>In the official Helm chart for Apache Spark, the choice of <strong>StatefulSet</strong> for Spark Master and Worker, and <strong>Deployment</strong> for the Spark History Server, aligns with the specific requirements and behaviors of each component. Here’s a breakdown of the reasons for these design choices:</p>
<h3 id="1-Spark-Master-and-Worker-as-StatefulSets"><a href="#1-Spark-Master-and-Worker-as-StatefulSets" class="headerlink" title="1. Spark Master and Worker as StatefulSets"></a>1. <strong>Spark Master and Worker as StatefulSets</strong></h3><ul>
<li><strong>Persistence and Stability</strong>: The Spark Master and Worker nodes need stable, unique identities to communicate reliably. Using <strong>StatefulSet</strong> ensures that each replica (instance) has a stable network identity (hostname) and, if configured, persistent storage.</li>
<li><strong>Leader Election and Failover</strong>: Spark Master in standalone mode has a primary leader and backup node architecture, where the leader is responsible for the cluster state. StatefulSets allow these nodes to maintain consistent, unique identifiers, which is crucial for leader election and failover without disrupting the Spark cluster.</li>
<li><strong>Worker Registration</strong>: Spark Workers register with the Master, and having a unique, stable network identity ensures workers don’t inadvertently re-register or conflict with each other after restarts or failures. StatefulSets are the preferred way to handle this kind of behavior.</li>
</ul>
<h3 id="2-Spark-History-Server-as-a-Deployment"><a href="#2-Spark-History-Server-as-a-Deployment" class="headerlink" title="2. Spark History Server as a Deployment"></a>2. <strong>Spark History Server as a Deployment</strong></h3><ul>
<li><strong>Stateless Operation</strong>: The Spark History Server is fundamentally a stateless application. It reads from a pre-configured storage (such as HDFS or S3) where application logs are stored but doesn’t require persistent storage for its own operation. Using a <strong>Deployment</strong> is appropriate here, as the history server can be easily replicated or scaled without maintaining unique identities.</li>
<li><strong>Easier Scaling and Update Management</strong>: Deployments provide automatic scaling and rolling updates, which are more suitable for stateless services. If you need to increase the availability of the history server, you can simply increase the replica count in the Deployment, and Kubernetes will handle the scaling automatically.</li>
<li><strong>Failure Recovery</strong>: Since there’s no dependency on unique network identities or persistent state, if the History Server pod fails, it can be easily recreated without any additional orchestration, which is exactly what Deployments are optimized for.</li>
</ul>
<h2 id="Summary-Table"><a href="#Summary-Table" class="headerlink" title="Summary Table"></a>Summary Table</h2><table>
<thead>
<tr>
<th>Component</th>
<th>Kubernetes Kind</th>
<th>Purpose</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Spark Master</strong></td>
<td>StatefulSet</td>
<td>Primary and backup master for Spark cluster</td>
<td>Needs stable identity for cluster coordination and leader election</td>
</tr>
<tr>
<td><strong>Spark Worker</strong></td>
<td>StatefulSet</td>
<td>Worker nodes that register with Spark Master</td>
<td>Stable network identity ensures reliable registration and communication with Master</td>
</tr>
<tr>
<td><strong>Spark History Server</strong></td>
<td>Deployment</td>
<td>Reads logs and provides historical application data</td>
<td>Stateless and doesn’t need unique identities; easier to scale and restart as a Deployment</td>
</tr>
</tbody></table>
<p>This setup optimizes the deployment structure for each Spark component’s unique requirements, leveraging Kubernetes’ StatefulSet and Deployment resources for their intended purposes.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"><i class="fa fa-tag"></i> Kubernetes</a>
              <a href="/tags/Spark/" rel="tag"><i class="fa fa-tag"></i> Spark</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/10/28/Comprehensive-Guide-to-Kubernetes/" rel="prev" title="Comprehensive Guide to Kubernetes">
                  <i class="fa fa-angle-left"></i> Comprehensive Guide to Kubernetes
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/10/28/Building-a-ChatGPT-like-System/" rel="next" title="Building a ChatGPT-like System">
                  Building a ChatGPT-like System <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
