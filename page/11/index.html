<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/page/11/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/page/11/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/11/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">89</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Troubleshooting-High-Currency-Issues-in-Kubernetes-Continued/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Troubleshooting-High-Currency-Issues-in-Kubernetes-Continued/" class="post-title-link" itemprop="url">Troubleshooting High Currency Issues in Kubernetes - Continued</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 21:30:37" itemprop="dateCreated datePublished" datetime="2024-10-27T21:30:37-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/Troubleshooting/" itemprop="url" rel="index"><span itemprop="name">Troubleshooting</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#pod-restart-crashloopbackoff-loop-due-to-high-concurrency-continued">Pod Restart <code>CrashLoopBackOff</code> Loop Due to High Concurrency (Continued)</a><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#problem-background">Problem Background</a></li>
<li><a href="#cause-analysis">Cause Analysis</a></li>
<li><a href="#verification-of-previous-fixes">Verification of Previous Fixes</a></li>
<li><a href="#exploring-additional-causes">Exploring Additional Causes</a></li>
<li><a href="#identifying-file-descriptor-limits">Identifying File Descriptor Limits</a></li>
<li><a href="#solution">Solution</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<hr>
<h1 id="Pod-Restart-CrashLoopBackOff-Loop-Due-to-High-Concurrency-Continued"><a href="#Pod-Restart-CrashLoopBackOff-Loop-Due-to-High-Concurrency-Continued" class="headerlink" title="Pod Restart CrashLoopBackOff Loop Due to High Concurrency (Continued)"></a>Pod Restart <code>CrashLoopBackOff</code> Loop Due to High Concurrency (Continued)</h1><hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Following the previous issue, the environment experienced another instance of Harbor and Calico pods restarting due to failed health checks. Additionally, using <code>kubectl</code> commands to enter the pods was extremely slow or timed out. This article continues the troubleshooting process to identify and resolve the root cause.</p>
<hr>
<p><a name="problem-background"></a></p>
<h2 id="Problem-Background"><a href="#Problem-Background" class="headerlink" title="Problem Background"></a>Problem Background</h2><p>After a period, the environment again faced issues with Harbor and Calico pods restarting due to failed health checks. Using <code>kubectl</code> commands to enter the pods was slow or timed out.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# kubectl <span class="built_in">exec</span> -it -n system node1-59c9475bc6-zkhq5 bash</span><br><span class="line">^</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="cause-analysis"></a></p>
<h2 id="Cause-Analysis"><a href="#Cause-Analysis" class="headerlink" title="Cause Analysis"></a>Cause Analysis</h2><p>The root cause of the repeated restarts was previously identified as health check timeouts, with TCP connections stuck in the <code>SYN_SENT</code> phase.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# netstat -anp | grep 23380</span><br><span class="line">tcp        0      0 127.0.0.1:23380         0.0.0.0:*               LISTEN      38914/kubelet</span><br><span class="line">tcp        0      0 127.0.0.1:38983         127.0.0.1:23380         SYN_SENT    -</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="verification-of-previous-fixes"></a></p>
<h2 id="Verification-of-Previous-Fixes"><a href="#Verification-of-Previous-Fixes" class="headerlink" title="Verification of Previous Fixes"></a>Verification of Previous Fixes</h2><p>First, check if the previous kernel parameter adjustments are still in place.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 32768</span><br><span class="line">net.core.somaxconn = 32768</span><br></pre></td></tr></table></figure>

<p>Verify if the changes have taken effect.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# ss -lnt</span><br><span class="line">State      Recv-Q   Send-Q     Local Address:Port      Peer Address:Port          </span><br><span class="line">LISTEN     0        32768      127.0.0.1:23380         *:*</span><br></pre></td></tr></table></figure>

<p>Despite the parameters being correctly set, the issue persisted.</p>
<hr>
<p><a name="exploring-additional-causes"></a></p>
<h2 id="Exploring-Additional-Causes"><a href="#Exploring-Additional-Causes" class="headerlink" title="Exploring Additional Causes"></a>Exploring Additional Causes</h2><p>Given the global impact of the issue, it was likely due to a system-level performance bottleneck. High business load affects CPU, memory, disk, and connection counts. Since the connections were long-lived, the file descriptor limit could be a factor.</p>
<hr>
<p><a name="identifying-file-descriptor-limits"></a></p>
<h2 id="Identifying-File-Descriptor-Limits"><a href="#Identifying-File-Descriptor-Limits" class="headerlink" title="Identifying File Descriptor Limits"></a>Identifying File Descriptor Limits</h2><p>Check the number of open file descriptors.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# lsof -p 45775 | <span class="built_in">wc</span> -l</span><br><span class="line">17974</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# lsof -p 45775 | grep <span class="string">&quot;sock&quot;</span> | <span class="built_in">wc</span> -l</span><br><span class="line">12051</span><br></pre></td></tr></table></figure>

<p>The process had over 10,000 open sockets, exceeding the default limit of 1024.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">ulimit</span> -n</span><br><span class="line">1024</span><br></pre></td></tr></table></figure>

<p>Despite exceeding the limit, the business pod did not report “too many open files” errors.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# kubectl logs -n system node1-59c9475bc6-zkhq5</span><br><span class="line">start config</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="solution"></a></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Temporarily increase the file descriptor limit.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">ulimit</span> -n 65535</span><br><span class="line">[root@node01 ~]# <span class="built_in">ulimit</span> -n</span><br><span class="line">65535</span><br></pre></td></tr></table></figure>

<p>After the adjustment, <code>kubectl</code> commands responded normally, and the <code>SYN_SENT</code> phase issue was resolved.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# kubectl <span class="built_in">exec</span> -it -n system node1-59c9475bc6-zkhq5 bash</span><br><span class="line">[root@node1-59c9475bc6-zkhq5]# <span class="built_in">exit</span></span><br><span class="line">[root@node01 ~]# kubectl <span class="built_in">exec</span> -it -n system node1-59c9475bc6-zkhq5 bash</span><br><span class="line">[root@node1-59c9475bc6-zkhq5]# <span class="built_in">exit</span></span><br><span class="line">[root@node01 ~]# kubectl <span class="built_in">exec</span> -it -n system node1-59c9475bc6-zkhq5 bash</span><br><span class="line">[root@node1-59c9475bc6-zkhq5]# <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@node01 ~]# netstat -anp | grep 23380</span><br><span class="line">tcp        0      0 127.0.0.1:23380         0.0.0.0:*               LISTEN      38914/kubelet</span><br><span class="line">tcp        0      0 127.0.0.1:56369         127.0.0.1:23380         TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:23380         127.0.0.1:57601         TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:23380         127.0.0.1:57479         TIME_WAIT   -</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This case study highlights the importance of considering system-level parameters, such as file descriptor limits, in high-concurrency scenarios. Adjusting these parameters can resolve performance bottlenecks and ensure stable operation of Kubernetes environments. For environments with high business load, it is strongly recommended to perform comprehensive operating system-level performance optimizations.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Troubleshooting-High-Currency-Issues-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Troubleshooting-High-Currency-Issues-in-Kubernetes/" class="post-title-link" itemprop="url">Troubleshooting High Currency Issues in Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 21:20:30" itemprop="dateCreated datePublished" datetime="2024-10-27T21:20:30-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/Troubleshooting/" itemprop="url" rel="index"><span itemprop="name">Troubleshooting</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#pod-restart-crashloopbackoff-loop-due-to-high-concurrency">Pod Restart <code>CrashLoopBackOff</code> Loop Due to High Concurrency</a><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#problem-background">Problem Background</a></li>
<li><a href="#analysis-process">Analysis Process</a></li>
<li><a href="#investigating-the-issue">Investigating the Issue</a></li>
<li><a href="#tcp-connection-timeout">TCP Connection Timeout</a></li>
<li><a href="#understanding-cpu-load">Understanding CPU Load</a></li>
<li><a href="#kernel-parameter-tuning">Kernel Parameter Tuning</a><ul>
<li><a href="#tcp-state-transition-diagram">TCP State Transition Diagram</a></li>
<li><a href="#adjusting-kernel-parameters">Adjusting Kernel Parameters</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<hr>
<h1 id="Pod-Restart-CrashLoopBackOff-Loop-Due-to-High-Concurrency"><a href="#Pod-Restart-CrashLoopBackOff-Loop-Due-to-High-Concurrency" class="headerlink" title="Pod Restart CrashLoopBackOff Loop Due to High Concurrency"></a>Pod Restart <code>CrashLoopBackOff</code> Loop Due to High Concurrency</h1><hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In a Kubernetes cluster environment, a business operation involving extensive configuration distribution (lasting several hours or more) led to repeated restarts of Calico pods. This article details the troubleshooting process, focusing on identifying the root cause and implementing a solution.</p>
<hr>
<p><a name="problem-background"></a></p>
<h2 id="Problem-Background"><a href="#Problem-Background" class="headerlink" title="Problem Background"></a>Problem Background</h2><p>During a high-concurrency operation, Calico pods in the Kubernetes cluster began to restart repeatedly.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# kubectl get pod -n kube-system -owide | grep node01</span><br><span class="line">calico-kube-controllers-6f59b8cdd8-8v2qw   1/1     Running            0          4h45m   10.10.119.238    node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-b8w2b                          1/1     CrashLoopBackOff   43         3d19h   10.10.119.238    node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-795cc9c45c-k7qpb                   1/1     Running            0          4h45m   177.177.237.42    node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="analysis-process"></a></p>
<h2 id="Analysis-Process"><a href="#Analysis-Process" class="headerlink" title="Analysis Process"></a>Analysis Process</h2><p>Upon observing the <code>CrashLoopBackOff</code> state of the pods, the first step was to use <code>kubectl describe</code> to gather more information.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# kubectl describe pod -n kube-system calico-node-b8w2b</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                      From               Message</span><br><span class="line">  ----     ------     ----                     ----               -------</span><br><span class="line">  Warning  Unhealthy  58m (x111 over 3h12m)    kubelet, node01  (combined from similar events): Liveness probe failed: Get http://localhost:9099/liveness: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  Normal   Pulled     43m (x36 over 3d19h)     kubelet, node01  Container image <span class="string">&quot;calico/node:v3.15.1&quot;</span> already present on machine</span><br><span class="line">  Warning  Unhealthy  8m16s (x499 over 3h43m)  kubelet, node01  Liveness probe failed: Get http://localhost:9099/liveness: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  Warning  BackOff    3m31s (x437 over 3h3m)   kubelet, node01  Back-off restarting failed container</span><br></pre></td></tr></table></figure>

<p>The events indicated that the liveness probe was failing due to a connection timeout.</p>
<hr>
<p><a name="investigating-the-issue"></a></p>
<h2 id="Investigating-the-Issue"><a href="#Investigating-the-Issue" class="headerlink" title="Investigating the Issue"></a>Investigating the Issue</h2><p>Manual execution of the health check command revealed slow response times, which were significantly higher than the usual millisecond-level response.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# time curl -i http://localhost:9099/liveness</span><br><span class="line">HTTP/1.1 204 No Content</span><br><span class="line">Date: Tue, 15 Jun 2021 06:24:35 GMT</span><br><span class="line">real    0m1.012s</span><br><span class="line">user    0m0.003s</span><br><span class="line">sys     0m0.005s</span><br></pre></td></tr></table></figure>

<p>Logs from Calico’s bird, confd, and felix components did not show any apparent errors. Checking the port status indicated that it was listening correctly.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# netstat -anp | grep 9099</span><br><span class="line">tcp        0      0 127.0.0.1:9099          0.0.0.0:*               LISTEN      1202/calico-node    </span><br><span class="line">tcp        0      0 127.0.0.1:9099          127.0.0.1:56728         TIME_WAIT   -                   </span><br><span class="line">tcp        0      0 127.0.0.1:56546         127.0.0.1:9099          TIME_WAIT   -</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="tcp-connection-timeout"></a></p>
<h2 id="TCP-Connection-Timeout"><a href="#TCP-Connection-Timeout" class="headerlink" title="TCP Connection Timeout"></a>TCP Connection Timeout</h2><p>Given the connection timeout error, the TCP connection state was observed.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# netstat -na | awk <span class="string">&#x27;/^tcp/&#123;s[$6]++&#125;END&#123;for(key in s) print key,s[key]&#125;&#x27;</span></span><br><span class="line">LISTEN 49</span><br><span class="line">ESTABLISHED 284</span><br><span class="line">SYN_SENT 4</span><br><span class="line">TIME_WAIT 176</span><br></pre></td></tr></table></figure>

<p>The <code>top</code> command showed that the business Java process was consuming high CPU, peaking at over 2000%.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# top</span><br><span class="line">top - 14:28:57 up 13 days, 27 min,  2 <span class="built_in">users</span>,  load average: 9.55, 9.93, 9.91</span><br><span class="line">Tasks: 1149 total,   1 running, 1146 sleeping,   0 stopped,   2 zombie</span><br><span class="line">%Cpu(s): 16.0 us,  2.9 sy,  0.0 ni, 80.9 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.1 si,  0.0 st</span><br><span class="line">KiB Mem : 15249982+total, 21419184 free, 55542588 used, 75538048 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 94226176 avail Mem </span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                        </span><br><span class="line"> 6754 root      20   0   66.8g  25.1g 290100 S 700.0 17.3   2971:49 java                                                                                           </span><br><span class="line">25214 root      20   0 6309076 179992  37016 S  36.8  0.1 439:06.29 kubelet                                                                                        </span><br><span class="line">20331 root      20   0 3196660 172364  24908 S  21.1  0.1 349:56.64 dockerd</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="understanding-cpu-load"></a></p>
<h2 id="Understanding-CPU-Load"><a href="#Understanding-CPU-Load" class="headerlink" title="Understanding CPU Load"></a>Understanding CPU Load</h2><p>Checking the total number of CPU cores and comparing it with the load average and CPU usage indicated that the load was not excessively high.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /proc/cpuinfo | grep <span class="string">&quot;physical id&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | <span class="built_in">wc</span> -l</span><br><span class="line">48</span><br><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /proc/cpuinfo | grep <span class="string">&quot;cpu cores&quot;</span> | <span class="built_in">uniq</span></span><br><span class="line">cpu cores: 1</span><br></pre></td></tr></table></figure>

<p>Given the high concurrency, the issue was likely related to the TCP connection setup. Understanding the TCP connection phases helped pinpoint the problem.</p>
<hr>
<p><a name="kernel-parameter-tuning"></a></p>
<h2 id="Kernel-Parameter-Tuning"><a href="#Kernel-Parameter-Tuning" class="headerlink" title="Kernel Parameter Tuning"></a>Kernel Parameter Tuning</h2><p>The issue was traced to the <code>SYN_SENT</code> phase of TCP connections. Adjusting kernel parameters related to TCP connections resolved the problem.</p>
<h3 id="TCP-State-Transition-Diagram"><a href="#TCP-State-Transition-Diagram" class="headerlink" title="TCP State Transition Diagram"></a>TCP State Transition Diagram</h3><pre><code class="highlight mermaid">graph TD
    CLOSED --&gt;|Client sends SYN| SYN_SENT
    SYN_SENT --&gt;|Server responds with SYN+ACK| SYN_RECV
    SYN_RECV --&gt;|Client sends ACK| ESTABLISHED
    ESTABLISHED --&gt;|Connection closed by either party| FIN_WAIT_1
    FIN_WAIT_1 --&gt;|ACK received| FIN_WAIT_2
    FIN_WAIT_2 --&gt;|FIN received| TIME_WAIT
    TIME_WAIT --&gt;|Timeout| CLOSED
    FIN_WAIT_1 --&gt;|FIN received| CLOSING
    CLOSING --&gt;|ACK received| TIME_WAIT
    SYN_RECV --&gt;|Server sends FIN| LAST_ACK
    LAST_ACK --&gt;|Client sends ACK| CLOSED</code></pre>

<h3 id="Adjusting-Kernel-Parameters"><a href="#Adjusting-Kernel-Parameters" class="headerlink" title="Adjusting Kernel Parameters"></a>Adjusting Kernel Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /etc/sysctl.conf </span><br><span class="line">...</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 32768</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# sysctl -p</span><br><span class="line">...</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 32768</span><br><span class="line">net.core.somaxconn = 32768</span><br></pre></td></tr></table></figure>

<p>After applying these changes, the health check commands executed without delay, and the pods returned to normal.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# time curl -i http://localhost:9099/liveness</span><br><span class="line">HTTP/1.1 204 No Content</span><br><span class="line">Date: Tue, 15 Jun 2021 14:48:38 GMT</span><br><span class="line">real    0m0.011s</span><br><span class="line">user    0m0.004s</span><br><span class="line">sys     0m0.004s</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This case study highlights the importance of understanding and tuning kernel parameters in high-concurrency scenarios. By adjusting parameters related to TCP connection handling, the issue of repeated pod restarts due to high CPU load and connection timeouts was resolved. This approach can be applied to similar issues in Kubernetes environments to ensure stable and efficient operation.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Analyzing-High-Memory-Usage-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Analyzing-High-Memory-Usage-in-Kubernetes/" class="post-title-link" itemprop="url">Analyzing High Memory Usage in Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 19:28:43" itemprop="dateCreated datePublished" datetime="2024-10-27T19:28:43-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/Troubleshooting/" itemprop="url" rel="index"><span itemprop="name">Troubleshooting</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#problem-background">Problem Background</a></li>
<li><a href="#cause-analysis">Cause Analysis</a><ul>
<li><a href="#using-docker-stats">Using <code>docker stats</code></a></li>
</ul>
</li>
<li><a href="#verification-of-memory-calculation">Verification of Memory Calculation</a><ul>
<li><a href="#verifying-with-memory_stats">Verifying with <code>memory_stats</code></a></li>
</ul>
</li>
<li><a href="#understanding-cache-usage">Understanding Cache Usage</a></li>
<li><a href="#solution">Solution</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In Kubernetes environments, monitoring resource usage is crucial for maintaining optimal performance and resource allocation. This article delves into a specific case where a user observed high memory usage by a Harbor pod on one of the nodes, leading to a discrepancy between <code>kubectl top</code> and <code>docker stats</code> results. We will analyze the cause, verify the memory calculation methods, and provide a solution to accurately monitor memory usage.</p>
<hr>
<p><a name="problem-background"></a></p>
<h2 id="Problem-Background"><a href="#Problem-Background" class="headerlink" title="Problem Background"></a>Problem Background</h2><p>A user observed that one of the nodes in their Kubernetes cluster showed high memory usage by a Harbor pod, approximately 3.7G, which seemed unusually high compared to other pods.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# kubectl get node -owide</span><br><span class="line">NAME    STATUS   ROLES    AGE   VERSION    INTERNAL-IP   EXTERNAL-IP    </span><br><span class="line">node01  Ready    master   10d   v1.15.12   100.1.0.10   &lt;none&gt;   </span><br><span class="line">node02  Ready    master   12d   v1.15.12   100.1.0.11   &lt;none&gt;  </span><br><span class="line">node03  Ready    master   10d   v1.15.12   100.1.0.12   &lt;none&gt; </span><br><span class="line"></span><br><span class="line">[root@node02 ~]# kubectl top pod -A | grep harbor</span><br><span class="line">kube-system         harbor-master1-sxg2l                   15m           150Mi</span><br><span class="line">kube-system         harbor-master2-ncvb8                   8m            3781Mi</span><br><span class="line">kube-system         harbor-master3-2gdsn                   14m           227Mi</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="cause-analysis"></a></p>
<h2 id="Cause-Analysis"><a href="#Cause-Analysis" class="headerlink" title="Cause Analysis"></a>Cause Analysis</h2><p>To understand the memory usage, the user compared the results from <code>kubectl top</code> and <code>docker stats</code>. Theoretically, <code>docker stats</code> should provide a more accurate result.</p>
<h3 id="Using-docker-stats"><a href="#Using-docker-stats" class="headerlink" title="Using docker stats"></a>Using <code>docker stats</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# docker stats | grep harbor</span><br><span class="line">CONTAINER ID        NAME                                  CPU %    MEM USAGE / LIMIT     MEM %</span><br><span class="line">10a230bee3c7        k8s_nginx_harbor-master2-xxx          0.02%    14.15MiB / 94.26GiB   0.01%</span><br><span class="line">6ba14a04fd77        k8s_harbor-portal_harbor-master2-xxx  0.01%    13.73MiB / 94.26GiB   0.01%</span><br><span class="line">324413da20a9        k8s_harbor-jobservice_harbor-master2-xxx  0.11%    21.54MiB / 94.26GiB   0.02%</span><br><span class="line">d880b61cf4cb        k8s_harbor-core_harbor-master2-xxx    0.12%    33.2MiB / 94.26GiB    0.03%</span><br><span class="line">186c064d0930        k8s_harbor-registryctl_harbor-master2-xxx 0.01%    8.34MiB / 94.26GiB    0.01%</span><br><span class="line">52a50204a962        k8s_harbor-registry_harbor-master2-xxx 0.06%    29.99MiB / 94.26GiB   0.03%</span><br><span class="line">86031ddd0314        k8s_harbor-redis_harbor-master2-xxx   0.14%    11.51MiB / 94.26GiB   0.01%</span><br><span class="line">6366207680f2        k8s_harbor-database_harbor-master2-xxx 0.45%    8.859MiB / 94.26GiB   0.01%</span><br></pre></td></tr></table></figure>

<p>The total memory usage from <code>docker stats</code> was around 140M, significantly lower than the 3.7G reported by <code>kubectl top</code>.</p>
<hr>
<p><a name="verification-of-memory-calculation"></a></p>
<h2 id="Verification-of-Memory-Calculation"><a href="#Verification-of-Memory-Calculation" class="headerlink" title="Verification of Memory Calculation"></a>Verification of Memory Calculation</h2><p>The discrepancy arises from the different methods used by <code>kubectl top</code> and <code>docker stats</code> to calculate memory usage.</p>
<ul>
<li><strong><code>kubectl top</code> Calculation</strong>: <code>memory.usage_in_bytes - inactive_file</code></li>
<li><strong><code>docker stats</code> Calculation</strong>: <code>memory.usage_in_bytes - cache</code></li>
</ul>
<p>If the cache is large, <code>kubectl top</code> will report a higher memory usage.</p>
<h3 id="Verifying-with-memory-stats"><a href="#Verifying-with-memory-stats" class="headerlink" title="Verifying with memory_stats"></a>Verifying with <code>memory_stats</code></h3><p>To verify, the user fetched the <code>memory_stats</code> data using Docker’s API:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s --unix-socket /var/run/docker.sock http:/v1.24/containers/xxx/stats | jq .<span class="string">&quot;memory_stats&quot;</span></span><br></pre></td></tr></table></figure>

<p>Sample <code>memory_stats</code> data:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;memory_stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span> <span class="number">14913536</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_usage&quot;</span><span class="punctuation">:</span> <span class="number">15183872</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;active_anon&quot;</span><span class="punctuation">:</span> <span class="number">14835712</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;active_file&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="number">77824</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dirty&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hierarchical_memory_limit&quot;</span><span class="punctuation">:</span> <span class="number">101205622784</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hierarchical_memsw_limit&quot;</span><span class="punctuation">:</span> <span class="number">9223372036854772000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inactive_anon&quot;</span><span class="punctuation">:</span> <span class="number">4096</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inactive_file&quot;</span><span class="punctuation">:</span> <span class="number">73728</span><span class="punctuation">,</span></span><br><span class="line">      ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>By applying the formulas, the user confirmed that the results from <code>kubectl top</code> and <code>docker stats</code> were consistent with the expected calculations.</p>
<hr>
<p><a name="understanding-cache-usage"></a></p>
<h2 id="Understanding-Cache-Usage"><a href="#Understanding-Cache-Usage" class="headerlink" title="Understanding Cache Usage"></a>Understanding Cache Usage</h2><p>The high cache usage in Harbor was primarily due to the <code>registry</code> component, which handles Docker image storage and involves extensive read&#x2F;write operations on image layers.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;memory_stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span> <span class="number">5845127168</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_usage&quot;</span><span class="punctuation">:</span> <span class="number">22050988032</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;active_anon&quot;</span><span class="punctuation">:</span> <span class="number">31576064</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_file&quot;</span><span class="punctuation">:</span> <span class="number">3778052096</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="number">5813551104</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dirty&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hierarchical_memory_limit&quot;</span><span class="punctuation">:</span> <span class="number">101205622784</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hierarchical_memsw_limit&quot;</span><span class="punctuation">:</span> <span class="number">9223372036854772000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;inactive_anon&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;inactive_file&quot;</span><span class="punctuation">:</span> <span class="number">2035499008</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="solution"></a></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>To address the discrepancy, the user was informed that <code>kubectl top</code> includes cache usage, which can be misleading. The cache, being non-critical, can be reclaimed by the system during memory pressure or manually released. The user was advised to use <code>docker stats</code> for a more accurate representation of actual memory usage.</p>
<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This case study highlights the importance of understanding the different methods used by Kubernetes and Docker to calculate memory usage. By verifying the calculations and understanding the role of cache, users can make more informed decisions about resource management in their Kubernetes clusters. Using <code>docker stats</code> provides a more accurate view of memory usage, especially in scenarios where cache usage is significant.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Deep-Dive-into-Finding-Numbers-in-Strings-with-Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Deep-Dive-into-Finding-Numbers-in-Strings-with-Python/" class="post-title-link" itemprop="url">Deep Dive into Finding Numbers in Strings with Python</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 19:22:12" itemprop="dateCreated datePublished" datetime="2024-10-27T19:22:12-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#why-find-numbers-in-strings">Why Find Numbers in Strings?</a></li>
<li><a href="#using-strings-isnumeric-method">Using String’s <code>isnumeric()</code> Method</a></li>
<li><a href="#using-regular-expressions-to-find-numbers">Using Regular Expressions to Find Numbers</a><ul>
<li><a href="#example-using-regular-expressions">Example: Using Regular Expressions</a></li>
</ul>
</li>
<li><a href="#finding-numbers-with-decimal-points">Finding Numbers with Decimal Points</a></li>
<li><a href="#using-list-comprehension-to-extract-numbers">Using List Comprehension to Extract Numbers</a><ul>
<li><a href="#example-using-list-comprehension">Example: Using List Comprehension</a></li>
</ul>
</li>
<li><a href="#filtering-numbers-with-filter-function">Filtering Numbers with <code>filter()</code> Function</a><ul>
<li><a href="#example-using-filter-function">Example: Using <code>filter()</code> Function</a></li>
</ul>
</li>
<li><a href="#splitting-strings-to-extract-numbers">Splitting Strings to Extract Numbers</a><ul>
<li><a href="#example-using-split-method">Example: Using <code>split()</code> Method</a></li>
</ul>
</li>
<li><a href="#using-astliteral_eval-to-parse-numbers">Using <code>ast.literal_eval</code> to Parse Numbers</a><ul>
<li><a href="#example-using-astliteral_eval">Example: Using <code>ast.literal_eval</code></a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Handling strings that contain a mix of numbers and text is a common task in everyday programming. For example, you might need to extract numbers from complex text or identify whether certain strings contain numbers. In Python, there are various ways to tackle this problem, depending on your specific needs. This article will detail how to find numbers in strings using Python, providing concrete example code to help developers quickly master these techniques.</p>
<hr>
<p><a name="why-find-numbers-in-strings"></a></p>
<h2 id="Why-Find-Numbers-in-Strings"><a href="#Why-Find-Numbers-in-Strings" class="headerlink" title="Why Find Numbers in Strings?"></a>Why Find Numbers in Strings?</h2><ul>
<li><strong>Data Processing and Cleaning</strong>: Extract useful numeric information from web crawlers or log files, such as order numbers, timestamps, amounts, etc.</li>
<li><strong>Input Validation</strong>: Detect whether user input strings contain numbers to ensure the validity of the input content.</li>
<li><strong>Text Analysis</strong>: Extract numbers from text data for further data analysis or statistics.</li>
</ul>
<hr>
<p><a name="using-strings-isnumeric-method"></a></p>
<h2 id="Using-String’s-isnumeric-Method"><a href="#Using-String’s-isnumeric-Method" class="headerlink" title="Using String’s isnumeric() Method"></a>Using String’s <code>isnumeric()</code> Method</h2><p>Python’s string type (<code>str</code>) provides several methods to determine character types, one of which is <code>isnumeric()</code>. The <code>isnumeric()</code> method checks whether a string contains only numeric characters. If all characters in the string are numeric, the method returns <code>True</code>; otherwise, it returns <code>False</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string = <span class="string">&quot;12345&quot;</span></span><br><span class="line"><span class="keyword">if</span> string.isnumeric():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;&#x27;<span class="subst">&#123;string&#125;</span>&#x27; contains only numbers&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;&#x27;<span class="subst">&#123;string&#125;</span>&#x27; contains more than just numbers&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this example, <code>isnumeric()</code> checks if the string “12345” consists entirely of numeric characters. Although this method can determine if a string is entirely numeric, it cannot extract numbers from mixed strings.</p>
<hr>
<p><a name="using-regular-expressions-to-find-numbers"></a></p>
<h2 id="Using-Regular-Expressions-to-Find-Numbers"><a href="#Using-Regular-Expressions-to-Find-Numbers" class="headerlink" title="Using Regular Expressions to Find Numbers"></a>Using Regular Expressions to Find Numbers</h2><p>Regular expressions (regex) are a powerful tool for text processing, ideal for finding and extracting numbers from strings. Python’s <code>re</code> module provides comprehensive regex support, making it easy to match numbers in strings.</p>
<h3 id="Example-Using-Regular-Expressions"><a href="#Example-Using-Regular-Expressions" class="headerlink" title="Example: Using Regular Expressions"></a>Example: Using Regular Expressions</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define a string containing numbers</span></span><br><span class="line">text = <span class="string">&quot;Order number is 12345, amount is 678.90 dollar&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use regex to find all numbers</span></span><br><span class="line">numbers = re.findall(<span class="string">r&#x27;\d+&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Numbers found in the string: <span class="subst">&#123;numbers&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this example, <code>re.findall()</code> uses the regex <code>\d+</code>, which matches one or more consecutive digits. <code>re.findall()</code> returns a list containing all matched numbers in the string. The output is: <code>[&#39;12345&#39;, &#39;678&#39;]</code>.</p>
<hr>
<p><a name="finding-numbers-with-decimal-points"></a></p>
<h2 id="Finding-Numbers-with-Decimal-Points"><a href="#Finding-Numbers-with-Decimal-Points" class="headerlink" title="Finding Numbers with Decimal Points"></a>Finding Numbers with Decimal Points</h2><p>If you need to find numbers with decimal points in a string, you can use the following regex:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;Order number is 12345, amount is 678.90 dollar&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Find integers and decimals</span></span><br><span class="line">numbers = re.findall(<span class="string">r&#x27;\d+\.?\d*&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Numbers found in the string: <span class="subst">&#123;numbers&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this regex, <code>\d+</code> matches one or more digits, <code>\.</code> matches the decimal point, and <code>\d*</code> matches zero or more digits following the decimal point. The result is: <code>[&#39;12345&#39;, &#39;678.90&#39;]</code>.</p>
<hr>
<p><a name="using-list-comprehension-to-extract-numbers"></a></p>
<h2 id="Using-List-Comprehension-to-Extract-Numbers"><a href="#Using-List-Comprehension-to-Extract-Numbers" class="headerlink" title="Using List Comprehension to Extract Numbers"></a>Using List Comprehension to Extract Numbers</h2><p>For simple scenarios, you can use Python’s list comprehension to quickly extract numbers from a string. By checking each character in the string to see if it is a digit, you can extract them.</p>
<h3 id="Example-Using-List-Comprehension"><a href="#Example-Using-List-Comprehension" class="headerlink" title="Example: Using List Comprehension"></a>Example: Using List Comprehension</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;Order number 12345, amount 678.90 dollar&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract digit characters</span></span><br><span class="line">digits = [char <span class="keyword">for</span> char <span class="keyword">in</span> text <span class="keyword">if</span> char.isdigit()]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Extracted digit characters: <span class="subst">&#123;digits&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this example, <code>isdigit()</code> is used to check each character in the string, resulting in a list of all digit characters: <code>[&#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;0&#39;]</code>. If you need to combine the extracted digits into a complete numeric string, you can use the <code>join()</code> method:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Combine extracted digit characters into a complete numeric string</span></span><br><span class="line">number_str = <span class="string">&#x27;&#x27;</span>.join(digits)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Complete numeric string: <span class="subst">&#123;number_str&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>The output is: <code>&quot;1234567890&quot;</code>.</p>
<hr>
<p><a name="filtering-numbers-with-filter-function"></a></p>
<h2 id="Filtering-Numbers-with-filter-Function"><a href="#Filtering-Numbers-with-filter-Function" class="headerlink" title="Filtering Numbers with filter() Function"></a>Filtering Numbers with <code>filter()</code> Function</h2><p>Python’s built-in <code>filter()</code> function can be used to filter out non-numeric characters from a string, thereby extracting numeric characters. The <code>filter()</code> function works similarly to list comprehension but is more functional in style.</p>
<h3 id="Example-Using-filter-Function"><a href="#Example-Using-filter-Function" class="headerlink" title="Example: Using filter() Function"></a>Example: Using <code>filter()</code> Function</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;Order number 12345, amount 678.90 dollar&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use the filter function to extract numbers</span></span><br><span class="line">numbers = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">filter</span>(<span class="built_in">str</span>.isdigit, text))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Extracted numbers: <span class="subst">&#123;numbers&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this example, the <code>filter()</code> function checks each character in the string, keeping only those that satisfy <code>isdigit()</code>, and then joins the extracted numeric characters into a complete string.</p>
<hr>
<p><a name="splitting-strings-to-extract-numbers"></a></p>
<h2 id="Splitting-Strings-to-Extract-Numbers"><a href="#Splitting-Strings-to-Extract-Numbers" class="headerlink" title="Splitting Strings to Extract Numbers"></a>Splitting Strings to Extract Numbers</h2><p>In some scenarios, you can split the string first and then process each segment to extract numbers. The <code>split()</code> method can split a string into multiple parts based on a specified delimiter, suitable for handling structured text.</p>
<h3 id="Example-Using-split-Method"><a href="#Example-Using-split-Method" class="headerlink" title="Example: Using split() Method"></a>Example: Using <code>split()</code> Method</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;Order number: 12345, amount: 678.90&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Split the string by spaces or punctuation</span></span><br><span class="line">parts = re.split(<span class="string">r&#x27;[，：: ]+&#x27;</span>, text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract numeric parts</span></span><br><span class="line">numbers = [part <span class="keyword">for</span> part <span class="keyword">in</span> parts <span class="keyword">if</span> part.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">1</span>).isdigit()]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Extracted numbers: <span class="subst">&#123;numbers&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this example, <code>re.split()</code> is used to split the string, and then list comprehension extracts all numeric parts. <code>replace(&#39;.&#39;, &#39;&#39;, 1)</code> ensures that decimal points are handled correctly.</p>
<hr>
<p><a name="using-astliteral_eval-to-parse-numbers"></a></p>
<h2 id="Using-ast-literal-eval-to-Parse-Numbers"><a href="#Using-ast-literal-eval-to-Parse-Numbers" class="headerlink" title="Using ast.literal_eval to Parse Numbers"></a>Using <code>ast.literal_eval</code> to Parse Numbers</h2><p>In some applications, you may need to extract numeric values from complex strings and parse them into numeric types (integers or floats). Python’s <code>ast.literal_eval()</code> method can safely parse a string into a Python data type.</p>
<h3 id="Example-Using-ast-literal-eval"><a href="#Example-Using-ast-literal-eval" class="headerlink" title="Example: Using ast.literal_eval"></a>Example: Using <code>ast.literal_eval</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;Amount: 678.90&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract the numeric part of the string</span></span><br><span class="line">number_str = re.search(<span class="string">r&#x27;\d+\.?\d*&#x27;</span>, text).group()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Parse the string into a number</span></span><br><span class="line">number = ast.literal_eval(number_str)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Parsed number: <span class="subst">&#123;number&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>In this example, the regex extracts the numeric part, and <code>ast.literal_eval()</code> converts it into the actual numeric type (float). This method is useful for extracting and converting numbers from text.</p>
<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Finding and extracting numbers from strings is a common task in Python programming, whether for data cleaning, user input validation, or text analysis. This article has introduced various methods to find numbers in Python, including using string methods, regular expressions, list comprehension, the <code>filter()</code> function, and <code>ast.literal_eval()</code>. Each method has its strengths and can be chosen based on different application scenarios. With these tools, developers can quickly and efficiently extract and process numeric data from strings, enhancing code flexibility and processing capabilities.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/One-Real-Production-Issue-Fix-About-Race-Condition-in-Adobe-LiveCycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/One-Real-Production-Issue-Fix-About-Race-Condition-in-Adobe-LiveCycle/" class="post-title-link" itemprop="url">One Real Production Issue Fix About Race Condition in Adobe LiveCycle</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 18:48:58" itemprop="dateCreated datePublished" datetime="2024-10-27T18:48:58-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Weird-Issue/" itemprop="url" rel="index"><span itemprop="name">Weird Issue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-introduction">1. Introduction</a></li>
<li><a href="#2-real-life-production-issue">2. Real-Life Production Issue</a></li>
<li><a href="#3-what-is-a-race-condition">3. What is a Race Condition?</a><ul>
<li><a href="#example">Example:</a></li>
</ul>
</li>
<li><a href="#4-how-race-conditions-occur-in-apache-velocity">4. How Race Conditions Occur in Apache Velocity</a><ul>
<li><a href="#key-factors">Key Factors:</a></li>
</ul>
</li>
<li><a href="#5-example-scenario">5. Example Scenario</a><ul>
<li><a href="#code-example">Code Example:</a></li>
</ul>
</li>
<li><a href="#6-solutions-to-race-conditions">6. Solutions to Race Conditions</a><ul>
<li><a href="#1-use-a-thread-safe-velocity-engine">1. Use a Thread-Safe Velocity Engine</a></li>
<li><a href="#2-synchronization">2. Synchronization</a></li>
<li><a href="#3-connection-pooling">3. Connection Pooling</a></li>
<li><a href="#4-lightweight-objects">4. Lightweight Objects</a></li>
</ul>
</li>
<li><a href="#7-sample-code-and-configuration">7. Sample Code and Configuration</a><ul>
<li><a href="#configuration-example">Configuration Example:</a></li>
<li><a href="#verifying-the-configuration">Verifying the Configuration</a></li>
</ul>
</li>
<li><a href="#8-conclusion">8. Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>In software development, race conditions can lead to unpredictable behavior, particularly in multi-threaded environments. This article explores race conditions, particularly in the context of using the Apache Velocity templating engine, and provides insights into avoiding such issues in production systems.</p>
<p><a name="real-life-production-issue"></a></p>
<h2 id="2-Real-Life-Production-Issue"><a href="#2-Real-Life-Production-Issue" class="headerlink" title="2. Real-Life Production Issue"></a>2. Real-Life Production Issue</h2><p>During my time at a major telecommunications company, I was involved in a project that utilized Apache Velocity within Adobe LiveCycle to generate PDFs from templates. Although PDF generation had been functioning smoothly, we encountered a serious issue in the production environment where, on certain days each month, PDF generation would intermittently result in <code>NullPointerExceptions</code> (NPEs). </p>
<p>The production environment was more robust than development and UAT, resulting in higher concurrency levels. The frequent NPEs led to the application needing to be rebooted to restore functionality. Initial investigations did not yield immediate clues, as the errors stemmed deep within the Adobe LiveCycle source code, obscuring the connection to Apache Velocity. </p>
<p>Despite increasing system resources and tuning the template generator’s maximum thread limit, the issue persisted and even worsened. After extensive debugging, including analyzing process dumps during PDF rendering and testing various concurrency scenarios, I identified that the root cause was tied to the <code>VelocityEngine</code>. This engine was being instantiated for every template rendering request, leading to <code>Race Conditions</code> due to concurrent access.</p>
<p><a name="what-is-a-race-condition"></a></p>
<h2 id="3-What-is-a-Race-Condition"><a href="#3-What-is-a-Race-Condition" class="headerlink" title="3. What is a Race Condition?"></a>3. What is a Race Condition?</h2><p>A race condition occurs when multiple threads or processes attempt to change shared data at the same time. This can lead to inconsistent results, unexpected behavior, or application crashes, particularly when the sequence of thread execution is not managed correctly.</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example:"></a>Example:</h3><p>Imagine two threads updating the same bank account balance simultaneously. If both threads read the current balance before either has written back the new balance, one thread’s update could overwrite the other, leading to a final balance that doesn’t reflect both transactions.</p>
<p><a name="how-race-conditions-occur-in-apache-velocity"></a></p>
<h2 id="4-How-Race-Conditions-Occur-in-Apache-Velocity"><a href="#4-How-Race-Conditions-Occur-in-Apache-Velocity" class="headerlink" title="4. How Race Conditions Occur in Apache Velocity"></a>4. How Race Conditions Occur in Apache Velocity</h2><p>In the case of Apache Velocity, the <code>VelocityEngine</code> is not thread-safe by default. If multiple threads instantiate and manipulate the same <code>VelocityEngine</code> instance concurrently, it can lead to race conditions and unpredictable behaviors, such as <code>NullPointerExceptions</code>. This is particularly critical in a high-throughput environment, such as the one experienced in the production instance at Rogers.</p>
<h3 id="Key-Factors"><a href="#Key-Factors" class="headerlink" title="Key Factors:"></a>Key Factors:</h3><ul>
<li><strong>Multiple Concurrent Requests</strong>: In high-concurrency scenarios, simultaneous requests can create contention for resources managed by shared instances.</li>
<li><strong>Stateful Objects</strong>: Objects like <code>VelocityEngine</code> that maintain state can exhibit unexpected behaviors when accessed by multiple threads.</li>
</ul>
<p><a name="example-scenario"></a></p>
<h2 id="5-Example-Scenario"><a href="#5-Example-Scenario" class="headerlink" title="5. Example Scenario"></a>5. Example Scenario</h2><p>In our case, PDF generation would involve creating a <code>VelocityEngine</code> instance for each template rendering request. The absence of synchronization or proper handling of concurrent requests led to conditions where one thread’s updates conflicted with another’s, causing NPEs during PDF rendering.</p>
<h3 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example:"></a>Code Example:</h3><p>Here’s a simplified representation of how <code>VelocityEngine</code> was used improperly:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PdfGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generatePdf</span><span class="params">(String template, Map&lt;String, Object&gt; context)</span> &#123;</span><br><span class="line">        <span class="type">VelocityEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityEngine</span>();</span><br><span class="line">        engine.init();</span><br><span class="line">        <span class="type">Template</span> <span class="variable">tpl</span> <span class="operator">=</span> engine.getTemplate(template);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Merging context with template</span></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        tpl.merge(<span class="keyword">new</span> <span class="title class_">VelocityContext</span>(context), writer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Further PDF generation logic...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, every call to <code>generatePdf</code> creates a new instance of <code>VelocityEngine</code>, leading to potential race conditions.</p>
<p><a name="solutions-to-race-conditions"></a></p>
<h2 id="6-Solutions-to-Race-Conditions"><a href="#6-Solutions-to-Race-Conditions" class="headerlink" title="6. Solutions to Race Conditions"></a>6. Solutions to Race Conditions</h2><p>To mitigate race conditions in Apache Velocity, several approaches can be employed:</p>
<h3 id="1-Use-a-Thread-Safe-Velocity-Engine"><a href="#1-Use-a-Thread-Safe-Velocity-Engine" class="headerlink" title="1. Use a Thread-Safe Velocity Engine"></a>1. Use a Thread-Safe Velocity Engine</h3><p>Utilize a single shared instance of <code>VelocityEngine</code>, initialized once and reused across multiple requests.</p>
<h3 id="2-Synchronization"><a href="#2-Synchronization" class="headerlink" title="2. Synchronization"></a>2. Synchronization</h3><p>Wrap access to the <code>VelocityEngine</code> in synchronized blocks to ensure that only one thread can access it at a time.</p>
<h3 id="3-Connection-Pooling"><a href="#3-Connection-Pooling" class="headerlink" title="3. Connection Pooling"></a>3. Connection Pooling</h3><p>Implement connection pooling for managing <code>VelocityEngine</code> instances, allowing for better resource management and concurrency handling.</p>
<h3 id="4-Lightweight-Objects"><a href="#4-Lightweight-Objects" class="headerlink" title="4. Lightweight Objects"></a>4. Lightweight Objects</h3><p>If possible, use lighter objects that do not maintain state or can be safely reused.</p>
<p><a name="sample-code-and-configuration"></a></p>
<h2 id="7-Sample-Code-and-Configuration"><a href="#7-Sample-Code-and-Configuration" class="headerlink" title="7. Sample Code and Configuration"></a>7. Sample Code and Configuration</h2><p>Here’s an improved approach using a singleton <code>VelocityEngine</code> instance:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.runtime.resource.ResourceManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.runtime.resource.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PdfGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">VelocityEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityEngine</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        engine.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generatePdf</span><span class="params">(String template, Map&lt;String, Object&gt; context)</span> &#123;</span><br><span class="line">        <span class="type">Template</span> <span class="variable">tpl</span> <span class="operator">=</span> engine.getTemplate(template);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Merging context with template</span></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        tpl.merge(<span class="keyword">new</span> <span class="title class_">VelocityContext</span>(context), writer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Further PDF generation logic...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Configuration-Example"><a href="#Configuration-Example" class="headerlink" title="Configuration Example:"></a>Configuration Example:</h3><p>To ensure that the <code>VelocityEngine</code> is properly configured, the following configuration might be included:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># velocity.properties</span></span><br><span class="line"><span class="attr">resource.loader</span> = <span class="string">file</span></span><br><span class="line"><span class="attr">file.resource.loader.path</span> = <span class="string">/path/to/templates</span></span><br></pre></td></tr></table></figure>

<h3 id="Verifying-the-Configuration"><a href="#Verifying-the-Configuration" class="headerlink" title="Verifying the Configuration"></a>Verifying the Configuration</h3><p>To check if the <code>VelocityEngine</code> is initialized properly and functioning as expected:</p>
<ul>
<li><strong>Logging</strong>: Enable logging within the Velocity framework to capture initialization events and errors.</li>
<li><strong>Unit Tests</strong>: Implement unit tests that trigger concurrent PDF generation requests and verify output consistency.</li>
</ul>
<p><a name="conclusion"></a></p>
<h2 id="8-Conclusion"><a href="#8-Conclusion" class="headerlink" title="8. Conclusion"></a>8. Conclusion</h2><p>Race conditions in multi-threaded environments, especially when using libraries like Apache Velocity, can lead to severe application issues. Understanding how these conditions arise and employing strategies to mitigate them is crucial for building robust systems. By adopting best practices, such as using a singleton <code>VelocityEngine</code>, synchronizing access, and implementing pooling strategies, developers can significantly reduce the likelihood of encountering race conditions, ensuring smooth operation even under high-load scenarios.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Race-Conditions-in-Apache-Velocity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Race-Conditions-in-Apache-Velocity/" class="post-title-link" itemprop="url">Race Conditions in Apache Velocity</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 18:27:48" itemprop="dateCreated datePublished" datetime="2024-10-27T18:27:48-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Weird-Issue/" itemprop="url" rel="index"><span itemprop="name">Weird Issue</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-introduction-to-race-conditions">1. Introduction to Race Conditions</a><ul>
<li><a href="#key-characteristics-of-race-conditions">Key Characteristics of Race Conditions:</a></li>
</ul>
</li>
<li><a href="#2-understanding-apache-velocity-and-velocityengine">2. Understanding Apache Velocity and VelocityEngine</a><ul>
<li><a href="#velocityengine">VelocityEngine</a></li>
</ul>
</li>
<li><a href="#3-race-condition-explained">3. Race Condition Explained</a><ul>
<li><a href="#example">Example:</a></li>
</ul>
</li>
<li><a href="#4-real-life-scenario-with-apache-velocity">4. Real-Life Scenario with Apache Velocity</a><ul>
<li><a href="#example-scenario">Example Scenario:</a></li>
</ul>
</li>
<li><a href="#5-sample-code-demonstrating-the-issue">5. Sample Code Demonstrating the Issue</a><ul>
<li><a href="#explanation">Explanation:</a></li>
</ul>
</li>
<li><a href="#6-solutions-to-avoid-race-conditions">6. Solutions to Avoid Race Conditions</a><ul>
<li><a href="#1-thread-safe-velocityengine-initialization">1. Thread-Safe VelocityEngine Initialization</a></li>
<li><a href="#2-create-a-separate-context-per-request">2. Create a Separate Context per Request</a></li>
<li><a href="#3-synchronization-mechanisms">3. Synchronization Mechanisms</a></li>
<li><a href="#4-upgrade-to-latest-versions">4. Upgrade to Latest Versions</a></li>
<li><a href="#example-of-safe-usage">Example of Safe Usage</a></li>
</ul>
</li>
<li><a href="#7-conclusion">7. Conclusion</a></li>
</ul>
<p><a name="introduction-to-race-conditions"></a></p>
<h2 id="1-Introduction-to-Race-Conditions"><a href="#1-Introduction-to-Race-Conditions" class="headerlink" title="1. Introduction to Race Conditions"></a>1. Introduction to Race Conditions</h2><p>A <strong>race condition</strong> occurs in a concurrent system when two or more threads access shared data and try to change it simultaneously. The final outcome depends on the timing of how the threads are scheduled, leading to unpredictable behavior. This can result in inconsistent data states, application crashes, or even security vulnerabilities.</p>
<h3 id="Key-Characteristics-of-Race-Conditions"><a href="#Key-Characteristics-of-Race-Conditions" class="headerlink" title="Key Characteristics of Race Conditions:"></a>Key Characteristics of Race Conditions:</h3><ul>
<li><strong>Concurrent Execution</strong>: More than one thread accesses shared resources simultaneously.</li>
<li><strong>Timing Dependency</strong>: The result depends on the order and timing of execution.</li>
<li><strong>Non-Deterministic Behavior</strong>: The outcome is not predictable.</li>
</ul>
<p><a name="understanding-apache-velocity-and-velocityengine"></a></p>
<h2 id="2-Understanding-Apache-Velocity-and-VelocityEngine"><a href="#2-Understanding-Apache-Velocity-and-VelocityEngine" class="headerlink" title="2. Understanding Apache Velocity and VelocityEngine"></a>2. Understanding Apache Velocity and VelocityEngine</h2><p><strong>Apache Velocity</strong> is a Java-based template engine that allows developers to create dynamic web pages by combining templates with data sources. It uses the <code>VelocityEngine</code> class to manage the rendering of templates.</p>
<h3 id="VelocityEngine"><a href="#VelocityEngine" class="headerlink" title="VelocityEngine"></a>VelocityEngine</h3><ul>
<li>It is responsible for loading templates and rendering them.</li>
<li>Creating a <code>VelocityEngine</code> instance is resource-intensive, which makes it inefficient to instantiate it multiple times per request.</li>
<li>In older versions like 1.7, reusing a single <code>VelocityEngine</code> instance can lead to thread safety issues, including race conditions.</li>
</ul>
<p><a name="race-condition-explained"></a></p>
<h2 id="3-Race-Condition-Explained"><a href="#3-Race-Condition-Explained" class="headerlink" title="3. Race Condition Explained"></a>3. Race Condition Explained</h2><p>When multiple threads share the same instance of <code>VelocityEngine</code>, they might access or modify the state of the engine at the same time. If the engine’s internal state is not properly synchronized, this can lead to unexpected behaviors, such as:</p>
<ul>
<li><strong>Incorrect Template Rendering</strong>: Two threads might try to modify the same template context.</li>
<li><strong>Inconsistent Data Output</strong>: The output can vary based on the order of execution.</li>
<li><strong>Application Crashes</strong>: If an unexpected state is encountered, it might lead to exceptions.</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example:"></a>Example:</h3><p>Imagine a web application where multiple users trigger requests to generate reports using the same <code>VelocityEngine</code>. If one thread updates the template context while another thread is rendering a report, it may lead to incomplete or corrupted outputs.</p>
<p><a name="real-life-scenario-with-apache-velocity"></a></p>
<h2 id="4-Real-Life-Scenario-with-Apache-Velocity"><a href="#4-Real-Life-Scenario-with-Apache-Velocity" class="headerlink" title="4. Real-Life Scenario with Apache Velocity"></a>4. Real-Life Scenario with Apache Velocity</h2><p>Consider a web application that generates user-specific reports based on data fetched from a database. This application utilizes Apache Velocity to format the reports. If the application is under heavy load, multiple requests for report generation may come in simultaneously.</p>
<h3 id="Example-Scenario"><a href="#Example-Scenario" class="headerlink" title="Example Scenario:"></a>Example Scenario:</h3><ol>
<li>User A requests a report for their account.</li>
<li>User B requests a report for their account almost simultaneously.</li>
<li>The application uses a shared <code>VelocityEngine</code> instance.</li>
<li>Both requests modify the shared state of the <code>VelocityEngine</code>, leading to inconsistencies in the generated reports.</li>
</ol>
<p><a name="sample-code-demonstrating-the-issue"></a></p>
<h2 id="5-Sample-Code-Demonstrating-the-Issue"><a href="#5-Sample-Code-Demonstrating-the-Issue" class="headerlink" title="5. Sample Code Demonstrating the Issue"></a>5. Sample Code Demonstrating the Issue</h2><p>Here’s an example demonstrating how a race condition can occur with <code>VelocityEngine</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.Template;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">VelocityEngine</span> <span class="variable">velocityEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityEngine</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateReport</span><span class="params">(String userName, String reportData)</span> &#123;</span><br><span class="line">        <span class="comment">// Creating a new context for each request</span></span><br><span class="line">        <span class="type">VelocityContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line">        context.put(<span class="string">&quot;userName&quot;</span>, userName);</span><br><span class="line">        context.put(<span class="string">&quot;reportData&quot;</span>, reportData);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the template</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> velocityEngine.getTemplate(<span class="string">&quot;reportTemplate.vm&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Render the template</span></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        template.merge(context, writer);</span><br><span class="line">        <span class="keyword">return</span> writer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation:"></a>Explanation:</h3><p>In the above code, multiple threads may call <code>generateReport</code> simultaneously. If the <code>VelocityEngine</code> instance has mutable state that is not synchronized, it could lead to inconsistent outputs.</p>
<p><a name="solutions-to-avoid-race-conditions"></a></p>
<h2 id="6-Solutions-to-Avoid-Race-Conditions"><a href="#6-Solutions-to-Avoid-Race-Conditions" class="headerlink" title="6. Solutions to Avoid Race Conditions"></a>6. Solutions to Avoid Race Conditions</h2><p>To prevent race conditions when using <code>VelocityEngine</code>, consider the following strategies:</p>
<h3 id="1-Thread-Safe-VelocityEngine-Initialization"><a href="#1-Thread-Safe-VelocityEngine-Initialization" class="headerlink" title="1. Thread-Safe VelocityEngine Initialization"></a>1. Thread-Safe VelocityEngine Initialization</h3><ul>
<li>Ensure that <code>VelocityEngine</code> is initialized only once in a thread-safe manner. Use a singleton pattern or dependency injection frameworks (e.g., Spring) to manage the lifecycle.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VelocityEngineProvider</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">VelocityEngine</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityEngine</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">VelocityEngineProvider</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> VelocityEngine <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Create-a-Separate-Context-per-Request"><a href="#2-Create-a-Separate-Context-per-Request" class="headerlink" title="2. Create a Separate Context per Request"></a>2. Create a Separate Context per Request</h3><ul>
<li>Always create a new <code>VelocityContext</code> for each request. This ensures that each thread works with its own context and avoids shared mutable state.</li>
</ul>
<h3 id="3-Synchronization-Mechanisms"><a href="#3-Synchronization-Mechanisms" class="headerlink" title="3. Synchronization Mechanisms"></a>3. Synchronization Mechanisms</h3><ul>
<li>Use synchronization mechanisms like <code>synchronized</code> blocks or <code>ReentrantLock</code> if shared state modifications are necessary. However, this may impact performance.</li>
</ul>
<h3 id="4-Upgrade-to-Latest-Versions"><a href="#4-Upgrade-to-Latest-Versions" class="headerlink" title="4. Upgrade to Latest Versions"></a>4. Upgrade to Latest Versions</h3><ul>
<li>Upgrade to newer versions of Apache Velocity that may have addressed these concurrency issues. Newer versions might provide better handling of thread safety.</li>
</ul>
<h3 id="Example-of-Safe-Usage"><a href="#Example-of-Safe-Usage" class="headerlink" title="Example of Safe Usage"></a>Example of Safe Usage</h3><p>Here’s a revised example that incorporates the aforementioned solutions:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.Template;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">VelocityEngine</span> <span class="variable">velocityEngine</span> <span class="operator">=</span> VelocityEngineProvider.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateReport</span><span class="params">(String userName, String reportData)</span> &#123;</span><br><span class="line">        <span class="type">VelocityContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line">        context.put(<span class="string">&quot;userName&quot;</span>, userName);</span><br><span class="line">        context.put(<span class="string">&quot;reportData&quot;</span>, reportData);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the template in a thread-safe manner</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> velocityEngine.getTemplate(<span class="string">&quot;reportTemplate.vm&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        template.merge(context, writer);</span><br><span class="line">        <span class="keyword">return</span> writer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="conclusion"></a></p>
<h2 id="7-Conclusion"><a href="#7-Conclusion" class="headerlink" title="7. Conclusion"></a>7. Conclusion</h2><p>Race conditions pose a significant risk in multi-threaded environments, especially when dealing with shared resources like <code>VelocityEngine</code>. By understanding the nature of race conditions, applying proper design patterns, and ensuring thread safety, developers can create robust and reliable applications using Apache Velocity. Always keep your libraries up-to-date to benefit from the latest improvements and security patches.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Deep-Dive-Test-Automation-of-Spring-Boot-Application/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Deep-Dive-Test-Automation-of-Spring-Boot-Application/" class="post-title-link" itemprop="url">Deep Dive Test Automation of Spring Boot Application</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 17:57:50" itemprop="dateCreated datePublished" datetime="2024-10-27T17:57:50-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring-Boot/Test-Automation/" itemprop="url" rel="index"><span itemprop="name">Test Automation</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring-Boot/Test-Automation/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Testing Spring Boot applications is crucial for validating functionality across the persistence, service, and controller layers, especially when deployed in containerized environments. This guide covers everything from configuring each layer’s tests to handling parallel endpoint testing and leveraging Docker for containerized environments.</p>
<hr>
<ul>
<li><a href="#1-overview">1. Overview</a></li>
<li><a href="#2-testing-the-persistence-layer">2. Testing the Persistence Layer</a><ul>
<li><a href="#embedded-database-for-testing">Embedded Database for Testing</a></li>
<li><a href="#integration-testing-with-testcontainers">Integration Testing with Testcontainers</a></li>
</ul>
</li>
<li><a href="#3-testing-the-service-layer">3. Testing the Service Layer</a><ul>
<li><a href="#unit-tests-with-mocks">Unit Tests with Mocks</a></li>
<li><a href="#integration-testing-with-dependencies">Integration Testing with Dependencies</a></li>
</ul>
</li>
<li><a href="#4-testing-the-controller-layer">4. Testing the Controller Layer</a><ul>
<li><a href="#mockmvc-for-isolated-controller-testing">MockMvc for Isolated Controller Testing</a></li>
<li><a href="#testing-real-endpoints-in-a-container">Testing Real Endpoints in a Container</a></li>
<li><a href="#parallel-testing-for-api-endpoints">Parallel Testing for API Endpoints</a></li>
</ul>
</li>
<li><a href="#5-end-to-end-testing-in-containerized-environments">5. End-to-End Testing in Containerized Environments</a><ul>
<li><a href="#using-docker-compose-for-integration-testing">Using Docker Compose for Integration Testing</a></li>
</ul>
</li>
<li><a href="#6-sample-code-and-configuration-summary">6. Sample Code and Configuration Summary</a><ul>
<li><a href="#maven-dependencies">Maven Dependencies</a></li>
<li><a href="#sample-application-properties">Sample Application Properties</a></li>
<li><a href="#persistence-layer-test-example">Persistence Layer Test Example</a></li>
<li><a href="#service-layer-test-example">Service Layer Test Example</a></li>
<li><a href="#controller-layer-test-example">Controller Layer Test Example</a></li>
<li><a href="#integration-testing-with-testcontainers-1">Integration Testing with Testcontainers</a></li>
<li><a href="#docker-compose-configuration">Docker Compose Configuration</a></li>
<li><a href="#running-tests-in-docker">Running Tests in Docker</a></li>
</ul>
</li>
</ul>
<hr>
<p><a name="overview"></a></p>
<h2 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h2><p>Testing a Spring Boot application ensures each layer functions as expected and that the system performs cohesively. Tests should cover:</p>
<ul>
<li><strong>Persistence Layer</strong>: Verifying data access and manipulation.</li>
<li><strong>Service Layer</strong>: Ensuring business logic functions correctly.</li>
<li><strong>Controller Layer</strong>: Testing API endpoints and interactions.</li>
</ul>
<p>This article includes testing strategies for both development and containerized environments, plus configurations for parallel endpoint testing.</p>
<hr>
<p><a name="testing-the-persistence-layer"></a></p>
<h2 id="2-Testing-the-Persistence-Layer"><a href="#2-Testing-the-Persistence-Layer" class="headerlink" title="2. Testing the Persistence Layer"></a>2. Testing the Persistence Layer</h2><p>The persistence layer involves data storage and access. To test without connecting to production databases, use embedded databases for unit testing and Testcontainers for more complex integration tests.</p>
<p><a name="embedded-database-for-testing"></a></p>
<h3 id="Embedded-Database-for-Testing"><a href="#Embedded-Database-for-Testing" class="headerlink" title="Embedded Database for Testing"></a>Embedded Database for Testing</h3><p>Embedded databases (like H2) are ideal for simple, fast tests:</p>
<ol>
<li><p><strong>Add H2 dependency</strong> in <code>pom.xml</code>:</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Application configuration</strong> for testing (<code>src/test/resources/application-test.yml</code>):</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:testdb</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">create-drop</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Persistence Layer Test</strong>:</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepositoryTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">savedUser</span> <span class="operator">=</span> userRepository.save(user);</span><br><span class="line">        assertNotNull(savedUser.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a name="integration-testing-with-testcontainers"></a></p>
<h3 id="Integration-Testing-with-Testcontainers"><a href="#Integration-Testing-with-Testcontainers" class="headerlink" title="Integration Testing with Testcontainers"></a>Integration Testing with Testcontainers</h3><p>For more realistic integration tests with databases (e.g., PostgreSQL), use <strong>Testcontainers</strong>:</p>
<ol>
<li><p><strong>Add Testcontainers dependency</strong>:</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Set up Testcontainers for PostgreSQL</strong>:</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepositoryTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">        .withDatabaseName(<span class="string">&quot;testdb&quot;</span>)</span><br><span class="line">        .withUsername(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">        .withPassword(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamicPropertySource</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureProperties</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        postgres.start();</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.url&quot;</span>, postgres::getJdbcUrl);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.username&quot;</span>, postgres::getUsername);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.password&quot;</span>, postgres::getPassword);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindUserById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p><a name="testing-the-service-layer"></a></p>
<h2 id="3-Testing-the-Service-Layer"><a href="#3-Testing-the-Service-Layer" class="headerlink" title="3. Testing the Service Layer"></a>3. Testing the Service Layer</h2><p>The service layer holds business logic. Use mocks for isolated unit tests and real dependencies for integration tests.</p>
<p><a name="unit-tests-with-mocks"></a></p>
<h3 id="Unit-Tests-with-Mocks"><a href="#Unit-Tests-with-Mocks" class="headerlink" title="Unit Tests with Mocks"></a>Unit Tests with Mocks</h3><ol>
<li><strong>Define a test with <code>@MockBean</code></strong>: <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line">        when(userRepository.save(any(User.class))).thenReturn(user);</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">savedUser</span> <span class="operator">=</span> userService.createUser(user);</span><br><span class="line">        assertEquals(<span class="string">&quot;Alice&quot;</span>, savedUser.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a name="integration-testing-with-dependencies"></a></p>
<h3 id="Integration-Testing-with-Dependencies"><a href="#Integration-Testing-with-Dependencies" class="headerlink" title="Integration Testing with Dependencies"></a>Integration Testing with Dependencies</h3><p>For full service layer integration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceIntegrationTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = userService.findAllUsers();</span><br><span class="line">        assertNotNull(users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="testing-the-controller-layer"></a></p>
<h2 id="4-Testing-the-Controller-Layer"><a href="#4-Testing-the-Controller-Layer" class="headerlink" title="4. Testing the Controller Layer"></a>4. Testing the Controller Layer</h2><p>Controller tests validate API endpoints. <code>MockMvc</code> is used for isolated testing, while containerized setups allow testing real endpoints.</p>
<p><a name="mockmvc-for-isolated-controller-testing"></a></p>
<h3 id="MockMvc-for-Isolated-Controller-Testing"><a href="#MockMvc-for-Isolated-Controller-Testing" class="headerlink" title="MockMvc for Isolated Controller Testing"></a>MockMvc for Isolated Controller Testing</h3><p>MockMvc allows API testing without starting a full web server.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebMvcTest(UserController.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetUser</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        when(userService.getUserById(anyLong())).thenReturn(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Alice&quot;</span>));</span><br><span class="line"></span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/users/1&quot;</span>))</span><br><span class="line">            .andExpect(status().isOk())</span><br><span class="line">            .andExpect(jsonPath(<span class="string">&quot;$.name&quot;</span>).value(<span class="string">&quot;Alice&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="testing-real-endpoints-in-a-container"></a></p>
<h3 id="Testing-Real-Endpoints-in-a-Container"><a href="#Testing-Real-Endpoints-in-a-Container" class="headerlink" title="Testing Real Endpoints in a Container"></a>Testing Real Endpoints in a Container</h3><p>For real endpoint testing, use <code>RestTemplate</code> with a server running on a random port:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerIntegrationTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@LocalServerPort</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetUser</span><span class="params">()</span> &#123;</span><br><span class="line">        ResponseEntity&lt;User&gt; response = restTemplate.getForEntity(<span class="string">&quot;http://localhost:&quot;</span> + port + <span class="string">&quot;/users/1&quot;</span>, User.class);</span><br><span class="line">        assertEquals(HttpStatus.OK, response.getStatusCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="parallel-testing-for-api-endpoints"></a></p>
<h3 id="Parallel-Testing-for-API-Endpoints"><a href="#Parallel-Testing-for-API-Endpoints" class="headerlink" title="Parallel Testing for API Endpoints"></a>Parallel Testing for API Endpoints</h3><p>When testing multiple endpoints simultaneously, use <code>RANDOM_PORT</code> to prevent port conflicts.</p>
<hr>
<p><a name="end-to-end-testing-in-containerized-environments"></a></p>
<h2 id="5-End-to-End-Testing-in-Containerized-Environments"><a href="#5-End-to-End-Testing-in-Containerized-Environments" class="headerlink" title="5. End-to-End Testing in Containerized Environments"></a>5. End-to-End Testing in Containerized Environments</h2><p>Using Docker Compose, spin up services to perform full integration tests in a controlled environment.</p>
<p><a name="using-docker-compose-for-integration-testing"></a></p>
<h3 id="Using-Docker-Compose-for-Integration-Testing"><a href="#Using-Docker-Compose-for-Integration-Testing" class="headerlink" title="Using Docker Compose for Integration Testing"></a>Using Docker Compose for Integration Testing</h3><ol>
<li><p><strong>Docker Compose File</strong>:</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">my-spring-app:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=test</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">testdb</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Run and Tear Down Tests</strong>:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># Run integration tests</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p><a name="sample-code-and-configuration-summary"></a></p>
<h2 id="6-Sample-Code-and-Configuration-Summary"><a href="#6-Sample-Code-and-Configuration-Summary" class="headerlink" title="6. Sample Code and Configuration Summary"></a>6. Sample Code and Configuration Summary</h2><p>This section provides practical code snippets and configurations to help automate testing in Spring Boot applications. The examples cover the persistence layer, service layer, controller layer, and containerized testing.</p>
<h3 id="Maven-Dependencies"><a href="#Maven-Dependencies" class="headerlink" title="Maven Dependencies"></a>Maven Dependencies</h3><p>Make sure to include the necessary dependencies in your <code>pom.xml</code> for testing:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter for Testing --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- H2 Database for In-Memory Testing --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- Testcontainers for Integration Testing --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Sample-Application-Properties"><a href="#Sample-Application-Properties" class="headerlink" title="Sample Application Properties"></a>Sample Application Properties</h3><p>Define properties for the test environment in <code>src/test/resources/application-test.yml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:testdb</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">create-drop</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Persistence-Layer-Test-Example"><a href="#Persistence-Layer-Test-Example" class="headerlink" title="Persistence Layer Test Example"></a>Persistence Layer Test Example</h3><p>Example of testing a repository with an embedded H2 database:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepositoryTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">savedUser</span> <span class="operator">=</span> userRepository.save(user);</span><br><span class="line">        assertNotNull(savedUser.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Layer-Test-Example"><a href="#Service-Layer-Test-Example" class="headerlink" title="Service Layer Test Example"></a>Service Layer Test Example</h3><p>Example of unit testing the service layer with Mockito:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line">        when(userRepository.save(any(User.class))).thenReturn(user);</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">savedUser</span> <span class="operator">=</span> userService.createUser(user);</span><br><span class="line">        assertEquals(<span class="string">&quot;Alice&quot;</span>, savedUser.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Layer-Test-Example"><a href="#Controller-Layer-Test-Example" class="headerlink" title="Controller Layer Test Example"></a>Controller Layer Test Example</h3><p>Example of testing a controller using <code>MockMvc</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebMvcTest(UserController.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetUser</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        when(userService.getUserById(anyLong())).thenReturn(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;Alice&quot;</span>));</span><br><span class="line"></span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/users/1&quot;</span>))</span><br><span class="line">            .andExpect(status().isOk())</span><br><span class="line">            .andExpect(jsonPath(<span class="string">&quot;$.name&quot;</span>).value(<span class="string">&quot;Alice&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing-with-Testcontainers-1"><a href="#Integration-Testing-with-Testcontainers-1" class="headerlink" title="Integration Testing with Testcontainers"></a>Integration Testing with Testcontainers</h3><p>Example of a test that uses Testcontainers to spin up a PostgreSQL instance for integration tests:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepositoryIntegrationTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;testdb&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamicPropertySource</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureProperties</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        postgres.start();</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.url&quot;</span>, postgres::getJdbcUrl);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.username&quot;</span>, postgres::getUsername);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.password&quot;</span>, postgres::getPassword);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindUserById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line"></span><br><span class="line">        Optional&lt;User&gt; foundUser = userRepository.findById(user.getId());</span><br><span class="line">        assertTrue(foundUser.isPresent());</span><br><span class="line">        assertEquals(<span class="string">&quot;Alice&quot;</span>, foundUser.get().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Docker-Compose-Configuration"><a href="#Docker-Compose-Configuration" class="headerlink" title="Docker Compose Configuration"></a>Docker Compose Configuration</h3><p>An example of a <code>docker-compose.yml</code> file for running your application and PostgreSQL for testing:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">my-spring-app:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_URL:</span> <span class="string">jdbc:postgresql://postgres:5432/testdb</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_USERNAME:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_PASSWORD:</span> <span class="string">password</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">testdb</span></span><br></pre></td></tr></table></figure>

<h3 id="Running-Tests-in-Docker"><a href="#Running-Tests-in-Docker" class="headerlink" title="Running Tests in Docker"></a>Running Tests in Docker</h3><p>Run your integration tests with Docker Compose:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># Run tests</span></span><br><span class="line">mvn <span class="built_in">test</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>

<p>This guide offers configurations and code samples to help set up automated testing for Spring Boot applications in both development and containerized environments, suitable for integration into CI&#x2F;CD pipelines.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Nginx-as-HTTPS-Proxy-for-HTTP-and-TCP-Backend-Services/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Nginx-as-HTTPS-Proxy-for-HTTP-and-TCP-Backend-Services/" class="post-title-link" itemprop="url">Nginx as HTTPS Proxy for HTTP and TCP Backend Services</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 17:33:02" itemprop="dateCreated datePublished" datetime="2024-10-27T17:33:02-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>We’ll configure NGINX to act as an HTTPS proxy in front of the following backend services:</p>
<ul>
<li><strong>Kafka Cluster</strong> (TCP-based)</li>
<li><strong>Elasticsearch Cluster</strong> (HTTP-based)</li>
<li><strong>Avro Schema Registry</strong> (HTTP-based)</li>
<li><strong>MinIO Cluster</strong> (HTTP-based)</li>
</ul>
<p>NGINX will be set up to:</p>
<ol>
<li>Route requests to different backend services based on ports.</li>
<li>Securely serve HTTPS traffic.</li>
<li>Enable and configure the required NGINX modules for HTTP and TCP traffic management.</li>
</ol>
<hr>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><h3 id="NGINX-Installation-with-Required-Modules"><a href="#NGINX-Installation-with-Required-Modules" class="headerlink" title="NGINX Installation with Required Modules"></a>NGINX Installation with Required Modules</h3><p>Ensure that NGINX is installed with both the HTTP and Stream modules enabled:</p>
<ul>
<li><strong>HTTP Module</strong> (<code>ngx_http_module</code>): Enabled by default and necessary for HTTP-based services.</li>
<li><strong>Stream Module</strong> (<code>ngx_stream_module</code>): Required for TCP-based services, like Kafka.</li>
</ul>
<h3 id="Verifying-Installed-Modules"><a href="#Verifying-Installed-Modules" class="headerlink" title="Verifying Installed Modules"></a>Verifying Installed Modules</h3><p>Run the following command to check if these modules are enabled:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V 2&gt;&amp;1 | grep -o <span class="string">&#x27;with-http\|with-stream&#x27;</span></span><br></pre></td></tr></table></figure>

<p>If <code>--with-stream</code> is missing, install NGINX with the Stream module. On most Linux distributions, the full version of NGINX (<code>nginx-full</code> or <code>nginx-extras</code>) will include the Stream module:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># On Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install nginx-full</span><br><span class="line"></span><br><span class="line"><span class="comment"># On CentOS/RHEL</span></span><br><span class="line"><span class="built_in">sudo</span> yum install nginx</span><br></pre></td></tr></table></figure>

<p>To verify that both modules are available:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V 2&gt;&amp;1 | grep -o <span class="string">&#x27;with-http\|with-stream&#x27;</span></span><br></pre></td></tr></table></figure>

<p>You should see both <code>with-http</code> and <code>with-stream</code> in the output.</p>
<hr>
<h2 id="NGINX-Configuration"><a href="#NGINX-Configuration" class="headerlink" title="NGINX Configuration"></a>NGINX Configuration</h2><p>This configuration assumes that we’re using separate ports to route traffic to each backend service through NGINX.</p>
<h3 id="Step-1-General-NGINX-HTTPS-Configuration"><a href="#Step-1-General-NGINX-HTTPS-Configuration" class="headerlink" title="Step 1: General NGINX HTTPS Configuration"></a>Step 1: General NGINX HTTPS Configuration</h3><p>Set up SSL&#x2F;TLS to handle HTTPS traffic. Here’s an example configuration with SSL settings:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># Define SSL settings for all services</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> your-nginx-domain.com;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_certificate</span> /path/to/your_certificate.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /path/to/your_private_key.key;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># TLS configuration for security</span></span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>;</span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Redirect based on port to respective services</span></span><br><span class="line">        <span class="section">location</span> /elasticsearch/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://elasticsearch_cluster/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /schema-registry/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://schema_registry/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /minio/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://minio_cluster/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Configure-Each-Backend-Service"><a href="#Step-2-Configure-Each-Backend-Service" class="headerlink" title="Step 2: Configure Each Backend Service"></a>Step 2: Configure Each Backend Service</h3><h4 id="HTTP-based-Services-Elasticsearch-Avro-Schema-Registry-MinIO"><a href="#HTTP-based-Services-Elasticsearch-Avro-Schema-Registry-MinIO" class="headerlink" title="HTTP-based Services (Elasticsearch, Avro Schema Registry, MinIO)"></a>HTTP-based Services (Elasticsearch, Avro Schema Registry, MinIO)</h4><ol>
<li><strong>Elasticsearch</strong> (port <code>9200</code>):<ul>
<li>Direct HTTP requests to the Elasticsearch cluster.</li>
</ul>
</li>
<li><strong>Avro Schema Registry</strong> (port <code>8081</code>):<ul>
<li>Redirect requests on <code>/schema-registry</code> to Avro Schema Registry.</li>
</ul>
</li>
<li><strong>MinIO</strong> (port <code>9000</code>):<ul>
<li>Redirect MinIO requests for storage management.</li>
</ul>
</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> elasticsearch_cluster &#123;</span><br><span class="line">        <span class="attribute">server</span> es1:<span class="number">9200</span>;</span><br><span class="line">        <span class="attribute">server</span> es2:<span class="number">9200</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> schema_registry &#123;</span><br><span class="line">        <span class="attribute">server</span> schema-registry1:<span class="number">8081</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> minio_cluster &#123;</span><br><span class="line">        <span class="attribute">server</span> minio1:<span class="number">9000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> your-nginx-domain.com;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_certificate</span> /path/to/your_certificate.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /path/to/your_private_key.key;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /elasticsearch/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://elasticsearch_cluster;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /schema-registry/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://schema_registry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /minio/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://minio_cluster;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TCP-based-Service-Kafka"><a href="#TCP-based-Service-Kafka" class="headerlink" title="TCP-based Service (Kafka)"></a>TCP-based Service (Kafka)</h4><ol>
<li>Kafka will require a separate configuration block under <code>stream</code> to handle TCP-based traffic on port <code>9092</code>.</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Stream block for TCP traffic</span></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="comment"># Kafka upstream cluster</span></span><br><span class="line">    <span class="section">upstream</span> kafka_cluster &#123;</span><br><span class="line">        <span class="attribute">server</span> kafka1:<span class="number">9092</span>;</span><br><span class="line">        <span class="attribute">server</span> kafka2:<span class="number">9092</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TCP Proxy for Kafka</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">9092</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> kafka_cluster;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Logging (optional for debugging)</span></span><br><span class="line">        <span class="attribute">access_log</span> /var/log/nginx/kafka_access.log;</span><br><span class="line">        <span class="attribute">error_log</span> /var/log/nginx/kafka_error.log;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Step-3-Complete-Configuration-Example"><a href="#Step-3-Complete-Configuration-Example" class="headerlink" title="Step 3: Complete Configuration Example"></a>Step 3: Complete Configuration Example</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># HTTP services upstreams</span></span><br><span class="line">    <span class="section">upstream</span> elasticsearch_cluster &#123;</span><br><span class="line">        <span class="attribute">server</span> es1:<span class="number">9200</span>;</span><br><span class="line">        <span class="attribute">server</span> es2:<span class="number">9200</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> schema_registry &#123;</span><br><span class="line">        <span class="attribute">server</span> schema-registry1:<span class="number">8081</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> minio_cluster &#123;</span><br><span class="line">        <span class="attribute">server</span> minio1:<span class="number">9000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SSL and HTTP proxy configurations</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> your-nginx-domain.com;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_certificate</span> /path/to/your_certificate.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /path/to/your_private_key.key;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>;</span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /elasticsearch/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://elasticsearch_cluster;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /schema-registry/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://schema_registry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /minio/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://minio_cluster;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stream block for TCP traffic to Kafka</span></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> kafka_cluster &#123;</span><br><span class="line">        <span class="attribute">server</span> kafka1:<span class="number">9092</span>;</span><br><span class="line">        <span class="attribute">server</span> kafka2:<span class="number">9092</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">9092</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> kafka_cluster;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">access_log</span> /var/log/nginx/kafka_access.log;</span><br><span class="line">        <span class="attribute">error_log</span> /var/log/nginx/kafka_error.log;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Verifying-the-Configuration"><a href="#Verifying-the-Configuration" class="headerlink" title="Verifying the Configuration"></a>Verifying the Configuration</h2><ol>
<li><strong>Test Configuration Syntax</strong>: Ensure there are no syntax errors in the configuration file.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nginx -t</span><br></pre></td></tr></table></figure></li>
<li><strong>Reload NGINX</strong>: Apply changes.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl reload nginx</span><br></pre></td></tr></table></figure></li>
<li><strong>Confirm Stream Module Availability</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V 2&gt;&amp;1 | grep -- <span class="string">&#x27;with-stream&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>Check Connection to Services</strong>: Using <code>curl</code> for HTTP services or Kafka client tools, verify that requests are correctly routed.</li>
</ol>
<hr>
<p>This setup provides a secure, flexible solution to route requests to both HTTP and TCP-based backend services via NGINX, using HTTPS for secure communications and the necessary modules for protocol compatibility.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Kubernetes-StatefulSet-and-Deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Kubernetes-StatefulSet-and-Deployment/" class="post-title-link" itemprop="url">Kubernetes StatefulSet and Deployment</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 16:57:24" itemprop="dateCreated datePublished" datetime="2024-10-27T16:57:24-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In Kubernetes, <strong>StatefulSet</strong> and <strong>Deployment</strong> are two important concepts for managing workloads, each tailored to specific types of applications. </p>
<hr>
<h3 id="Overview-StatefulSet-vs-Deployment"><a href="#Overview-StatefulSet-vs-Deployment" class="headerlink" title="Overview: StatefulSet vs. Deployment"></a>Overview: StatefulSet vs. Deployment</h3><h4 id="1-Deployment"><a href="#1-Deployment" class="headerlink" title="1. Deployment"></a>1. <strong>Deployment</strong></h4><ul>
<li>A <strong>Deployment</strong> manages stateless applications, where each instance (Pod) is identical and can be easily replaced without any dependency on the previous instance’s state.</li>
<li>It allows for easy scaling up or down, rolling updates, and rollback.</li>
<li>Deployments are ideal for applications that don’t need unique identities or persistent storage tied to each Pod.</li>
</ul>
<h4 id="2-StatefulSet"><a href="#2-StatefulSet" class="headerlink" title="2. StatefulSet"></a>2. <strong>StatefulSet</strong></h4><ul>
<li>A <strong>StatefulSet</strong> is used to manage stateful applications where each Pod maintains a unique identity and persistent storage.</li>
<li>Pods created by StatefulSets are given fixed identities, which are essential for applications that depend on stable network IDs or persistent data volumes.</li>
<li>It ensures an ordered and predictable sequence for Pod creation, deletion, and scaling operations, making it suitable for stateful applications.</li>
</ul>
<hr>
<h3 id="Key-Differences-Between-Deployment-and-StatefulSet"><a href="#Key-Differences-Between-Deployment-and-StatefulSet" class="headerlink" title="Key Differences Between Deployment and StatefulSet"></a>Key Differences Between Deployment and StatefulSet</h3><table>
<thead>
<tr>
<th>Feature</th>
<th><strong>Deployment</strong></th>
<th><strong>StatefulSet</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Use Case</strong></td>
<td>Stateless applications</td>
<td>Stateful applications</td>
</tr>
<tr>
<td><strong>Pod Identity</strong></td>
<td>All Pods are identical</td>
<td>Each Pod has a unique, stable identity</td>
</tr>
<tr>
<td><strong>Persistent Storage</strong></td>
<td>Not tied to specific Pods; ephemeral by default</td>
<td>Persistent Volume Claims (PVC) linked to each Pod</td>
</tr>
<tr>
<td><strong>Pod Management</strong></td>
<td>Unordered Pod creation, deletion, or scaling</td>
<td>Ordered Pod creation, deletion, and scaling</td>
</tr>
<tr>
<td><strong>Scaling</strong></td>
<td>Independent scaling; any Pod can be replaced</td>
<td>Scaling maintains Pod identity; Pods are replaced in order</td>
</tr>
<tr>
<td><strong>Networking</strong></td>
<td>Pods are accessed via a common service name</td>
<td>Each Pod gets a unique DNS endpoint</td>
</tr>
</tbody></table>
<hr>
<h3 id="When-to-Use-Deployment-vs-StatefulSet"><a href="#When-to-Use-Deployment-vs-StatefulSet" class="headerlink" title="When to Use Deployment vs. StatefulSet"></a>When to Use Deployment vs. StatefulSet</h3><h4 id="Deployment-Use-Cases"><a href="#Deployment-Use-Cases" class="headerlink" title="Deployment Use Cases:"></a><strong>Deployment</strong> Use Cases:</h4><ul>
<li><strong>Stateless Applications</strong>: For applications that don’t require persistent storage or a unique identity, like web servers, RESTful APIs, front-end services, and microservices.</li>
<li><strong>Scale-Out Workloads</strong>: When you need to scale the application horizontally with many replicas, such as with compute-intensive tasks (e.g., image processing).</li>
<li><strong>CI&#x2F;CD Pipelines</strong>: Deployment objects are suitable for managing frequent updates and rollbacks in stateless applications.</li>
<li><strong>Load-Balanced Services</strong>: For applications where all instances serve the same purpose and can respond to requests in a round-robin or load-balanced fashion.</li>
</ul>
<p>   Example:<br>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure></p>
<h4 id="StatefulSet-Use-Cases"><a href="#StatefulSet-Use-Cases" class="headerlink" title="StatefulSet Use Cases:"></a><strong>StatefulSet</strong> Use Cases:</h4><ul>
<li><strong>Databases</strong>: For databases like MySQL, PostgreSQL, or Cassandra, where each instance needs persistent storage and must be able to rejoin the cluster with the same identity after a restart.</li>
<li><strong>Distributed Applications</strong>: For clustered or distributed applications that need stable network identities, such as Apache Kafka, Zookeeper, or Redis in a master-slave configuration.</li>
<li><strong>Ordered Processing</strong>: For workloads that require ordered startup and shutdown, maintaining consistency across the replicas.</li>
<li><strong>Persistent Storage Requirements</strong>: For applications that need durable storage across restarts, such as analytics applications or logging systems that rely on data persistence.</li>
</ul>
<p>   Example:<br>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">database</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;database-service&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">database</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="Real-World-Scenarios"><a href="#Real-World-Scenarios" class="headerlink" title="Real-World Scenarios"></a>Real-World Scenarios</h3><ol>
<li><p><strong>Use StatefulSet for a Database Cluster</strong>: </p>
<ul>
<li>Applications like Cassandra or MongoDB require that each node (or replica) has a unique identifier, stable storage, and maintains a specific order in the cluster.</li>
<li>StatefulSet will ensure each database Pod keeps its persistent storage (e.g., transaction logs) and its network identity, allowing for seamless cluster membership and fault recovery.</li>
</ul>
</li>
<li><p><strong>Use Deployment for a Web Application Front-End</strong>:</p>
<ul>
<li>Stateless applications like front-end services, web servers, and microservices, which don’t require persistent storage, are best managed by Deployments.</li>
<li>Deployments allow fast horizontal scaling to handle fluctuating traffic, automated rolling updates to support frequent releases, and easy recovery from failure.</li>
</ul>
</li>
<li><p><strong>Use StatefulSet for Messaging Queues</strong>:</p>
<ul>
<li>Applications like Kafka, RabbitMQ, and Redis often require ordered replica management, durable storage, and unique identifiers for cluster consistency.</li>
<li>StatefulSet will ensure that the pods are started in sequence and keep their storage intact across restarts.</li>
</ul>
</li>
<li><p><strong>Use Deployment for API Gateways</strong>:</p>
<ul>
<li>API Gateways, which act as proxies or load balancers for backend services, are stateless by design. Deployments allow for fast failover and load distribution while handling updates without data dependency concerns.</li>
</ul>
</li>
</ol>
<hr>
<p>In summary, choose <strong>StatefulSet</strong> for workloads needing state persistence, stable identities, and ordered management (typically databases and clustered applications). Opt for <strong>Deployment</strong> for stateless, load-balanced, and horizontally scalable applications that need easy updates and high availability.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/27/Deep-Dive-Redis-Integration-With-Spring-Boot-Application/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/27/Deep-Dive-Redis-Integration-With-Spring-Boot-Application/" class="post-title-link" itemprop="url">Deep Dive Redis Integration With Spring Boot Application</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-27 16:49:33" itemprop="dateCreated datePublished" datetime="2024-10-27T16:49:33-04:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Cache/" itemprop="url" rel="index"><span itemprop="name">Cache</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Cache/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Cache/Redis/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Deep-Dive-into-Cache-Mechanisms-for-Distributed-Systems"><a href="#Deep-Dive-into-Cache-Mechanisms-for-Distributed-Systems" class="headerlink" title="Deep Dive into Cache Mechanisms for Distributed Systems"></a>Deep Dive into Cache Mechanisms for Distributed Systems</h1><h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h2><ul>
<li><a href="#deep-dive-into-cache-mechanisms-for-distributed-systems">Deep Dive into Cache Mechanisms for Distributed Systems</a><ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#high-level-architecture-design">High-Level Architecture Design</a><ul>
<li><a href="#diagram">Diagram</a></li>
<li><a href="#explanation">Explanation</a></li>
</ul>
</li>
<li><a href="#detail-designs">Detail Designs</a><ul>
<li><a href="#cache-layer">Cache Layer</a><ul>
<li><a href="#redis-setup-and-integration">Redis Setup and Integration</a><ul>
<li><a href="#step-1-install-redis">Step 1: Install Redis</a></li>
<li><a href="#step-2-start-redis-server">Step 2: Start Redis Server</a></li>
<li><a href="#step-3-verify-redis-installation">Step 3: Verify Redis Installation</a></li>
</ul>
</li>
<li><a href="#redis-configuration">Redis Configuration</a></li>
<li><a href="#redis-integration-with-spring-boot">Redis Integration with Spring Boot</a><ul>
<li><a href="#step-1-add-dependencies">Step 1: Add Dependencies</a></li>
<li><a href="#step-2-configure-redis-connection">Step 2: Configure Redis Connection</a></li>
<li><a href="#step-3-enable-caching">Step 3: Enable Caching</a></li>
<li><a href="#step-4-use-redis-cache">Step 4: Use Redis Cache</a></li>
</ul>
</li>
<li><a href="#best-practices-for-redis-in-kubernetes">Best Practices for Redis in Kubernetes</a><ul>
<li><a href="#step-1-deploy-redis-in-kubernetes">Step 1: Deploy Redis in Kubernetes</a></li>
<li><a href="#step-2-create-a-headless-service">Step 2: Create a Headless Service</a></li>
<li><a href="#step-3-configure-redis-access-in-spring-boot">Step 3: Configure Redis Access in Spring Boot</a></li>
<li><a href="#step-4-enable-redis-persistence">Step 4: Enable Redis Persistence</a></li>
<li><a href="#step-5-secure-redis">Step 5: Secure Redis</a></li>
<li><a href="#step-6-monitor-redis">Step 6: Monitor Redis</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#data-storage-layer">Data Storage Layer</a><ul>
<li><a href="#diagram-1">Diagram</a></li>
<li><a href="#sample-code">Sample Code</a></li>
</ul>
</li>
<li><a href="#service-layer">Service Layer</a><ul>
<li><a href="#diagram-2">Diagram</a></li>
<li><a href="#sample-code-1">Sample Code</a></li>
</ul>
</li>
<li><a href="#load-balancer">Load Balancer</a><ul>
<li><a href="#diagram-3">Diagram</a></li>
<li><a href="#sample-code-2">Sample Code</a></li>
</ul>
</li>
<li><a href="#monitoring-and-metrics">Monitoring and Metrics</a><ul>
<li><a href="#diagram-4">Diagram</a></li>
<li><a href="#sample-code-3">Sample Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#complex-scenario-1-flow-control-and-backpressure-handling">Complex Scenario 1: Flow Control and Backpressure Handling</a><ul>
<li><a href="#problem-statement">Problem Statement</a></li>
<li><a href="#solution-architecture">Solution Architecture</a></li>
<li><a href="#flow-chart">Flow Chart</a></li>
<li><a href="#sample-code-4">Sample Code</a></li>
</ul>
</li>
<li><a href="#complex-scenario-2-cache-invalidation-and-data-synchronization">Complex Scenario 2: Cache Invalidation and Data Synchronization</a><ul>
<li><a href="#problem-statement-1">Problem Statement</a></li>
<li><a href="#solution-architecture-1">Solution Architecture</a></li>
<li><a href="#sequence-diagram">Sequence Diagram</a></li>
<li><a href="#sample-code-5">Sample Code</a></li>
</ul>
</li>
<li><a href="#complex-scenario-3-cache-stampede-prevention">Complex Scenario 3: Cache Stampede Prevention</a><ul>
<li><a href="#problem-statement-2">Problem Statement</a></li>
<li><a href="#solution-architecture-2">Solution Architecture</a></li>
<li><a href="#flow-chart-1">Flow Chart</a></li>
<li><a href="#sample-code-6">Sample Code</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In distributed systems, caching is a critical mechanism to improve performance by reducing the load on backend services and databases. This article delves into the design and implementation of cache mechanisms for distributed systems, covering high-level architecture, detailed designs, and sample code for various scenarios.</p>
<hr>
<p><a name="high-level-architecture-design"></a></p>
<h2 id="High-Level-Architecture-Design"><a href="#High-Level-Architecture-Design" class="headerlink" title="High-Level Architecture Design"></a>High-Level Architecture Design</h2><h3 id="Diagram"><a href="#Diagram" class="headerlink" title="Diagram"></a>Diagram</h3><pre><code class="highlight mermaid">graph TD
    A[Client] --&gt; B[Load Balancer]
    B --&gt; C[Service Layer]
    C --&gt; D[Cache Layer]
    C --&gt; E[Data Storage Layer]
    D --&gt; E
    F[Monitoring and Metrics] --&gt; C
    F --&gt; D
    F --&gt; E</code></pre>

<h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h3><ol>
<li><strong>Client</strong>: The client sends requests to the distributed system.</li>
<li><strong>Load Balancer</strong>: Distributes incoming requests across multiple instances of the service layer.</li>
<li><strong>Service Layer</strong>: Handles business logic and interacts with the cache and data storage layers.</li>
<li><strong>Cache Layer</strong>: Stores frequently accessed data to reduce the load on the data storage layer.</li>
<li><strong>Data Storage Layer</strong>: The primary data store (e.g., database) where data is persisted.</li>
<li><strong>Monitoring and Metrics</strong>: Collects and monitors performance metrics for the entire system.</li>
</ol>
<hr>
<p><a name="detail-designs"></a></p>
<h2 id="Detail-Designs"><a href="#Detail-Designs" class="headerlink" title="Detail Designs"></a>Detail Designs</h2><h3 id="Cache-Layer"><a href="#Cache-Layer" class="headerlink" title="Cache Layer"></a><a name="cache-layer"></a>Cache Layer</h3><p>The cache layer is responsible for storing frequently accessed data to reduce the load on the data storage layer. It can be implemented using distributed caching solutions like Redis or Hazelcast.</p>
<h4 id="Redis-Setup-and-Integration"><a href="#Redis-Setup-and-Integration" class="headerlink" title="Redis Setup and Integration"></a><a name="redis-setup-and-integration"></a>Redis Setup and Integration</h4><p>Redis is an in-memory data structure store that can be used as a distributed cache. It supports various data structures like strings, hashes, lists, sets, and sorted sets.</p>
<h5 id="Step-1-Install-Redis"><a href="#Step-1-Install-Redis" class="headerlink" title="Step 1: Install Redis"></a>Step 1: Install Redis</h5><p>You can install Redis on your local machine or use a cloud-based Redis service like AWS ElastiCache or Redis Labs.</p>
<p>For local installation on Linux:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install redis-server</span><br></pre></td></tr></table></figure>

<p>For local installation on macOS:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure>

<h5 id="Step-2-Start-Redis-Server"><a href="#Step-2-Start-Redis-Server" class="headerlink" title="Step 2: Start Redis Server"></a>Step 2: Start Redis Server</h5><p>Start the Redis server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></table></figure>

<h5 id="Step-3-Verify-Redis-Installation"><a href="#Step-3-Verify-Redis-Installation" class="headerlink" title="Step 3: Verify Redis Installation"></a>Step 3: Verify Redis Installation</h5><p>Verify that Redis is running:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli ping</span><br></pre></td></tr></table></figure>

<p>If Redis is running correctly, you should see <code>PONG</code> as the response.</p>
<h4 id="Redis-Configuration"><a href="#Redis-Configuration" class="headerlink" title="Redis Configuration"></a><a name="redis-configuration"></a>Redis Configuration</h4><p>Redis configuration can be managed through the <code>redis.conf</code> file. Common configurations include setting the maximum memory limit, configuring persistence, and setting up replication.</p>
<p>Example <code>redis.conf</code> snippet:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">maxmemory 256mb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br></pre></td></tr></table></figure>

<h4 id="Redis-Integration-with-Spring-Boot"><a href="#Redis-Integration-with-Spring-Boot" class="headerlink" title="Redis Integration with Spring Boot"></a><a name="redis-integration-with-spring-boot"></a>Redis Integration with Spring Boot</h4><p>To integrate Redis with a Spring Boot application, you need to add the necessary dependencies and configure the Redis connection.</p>
<h5 id="Step-1-Add-Dependencies"><a href="#Step-1-Add-Dependencies" class="headerlink" title="Step 1: Add Dependencies"></a>Step 1: Add Dependencies</h5><p>Add the following dependencies to your <code>pom.xml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="Step-2-Configure-Redis-Connection"><a href="#Step-2-Configure-Redis-Connection" class="headerlink" title="Step 2: Configure Redis Connection"></a>Step 2: Configure Redis Connection</h5><p>Configure the Redis connection in your <code>application.yml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<h5 id="Step-3-Enable-Caching"><a href="#Step-3-Enable-Caching" class="headerlink" title="Step 3: Enable Caching"></a>Step 3: Enable Caching</h5><p>Enable caching in your Spring Boot application by adding the <code>@EnableCaching</code> annotation to your main application class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Step-4-Use-Redis-Cache"><a href="#Step-4-Use-Redis-Cache" class="headerlink" title="Step 4: Use Redis Cache"></a>Step 4: Use Redis Cache</h5><p>Use the <code>@Cacheable</code> annotation to cache method results in Redis:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;userCache&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Fetch user from data storage layer</span></span><br><span class="line">        <span class="keyword">return</span> fetchUserFromDatabase(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">fetchUserFromDatabase</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Database query logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Best-Practices-for-Redis-in-Kubernetes"><a href="#Best-Practices-for-Redis-in-Kubernetes" class="headerlink" title="Best Practices for Redis in Kubernetes"></a><a name="best-practices-for-redis-in-kubernetes"></a>Best Practices for Redis in Kubernetes</h4><p>When deploying Redis in Kubernetes, it’s important to follow best practices to ensure high availability, scalability, and security.</p>
<h5 id="Step-1-Deploy-Redis-in-Kubernetes"><a href="#Step-1-Deploy-Redis-in-Kubernetes" class="headerlink" title="Step 1: Deploy Redis in Kubernetes"></a>Step 1: Deploy Redis in Kubernetes</h5><p>You can deploy Redis in Kubernetes using a StatefulSet for stateful applications or a Deployment for stateless applications. Here’s an example of deploying Redis using a StatefulSet:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<h5 id="Step-2-Create-a-Headless-Service"><a href="#Step-2-Create-a-Headless-Service" class="headerlink" title="Step 2: Create a Headless Service"></a>Step 2: Create a Headless Service</h5><p>Create a headless service to manage the Redis StatefulSet:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<h5 id="Step-3-Configure-Redis-Access-in-Spring-Boot"><a href="#Step-3-Configure-Redis-Access-in-Spring-Boot" class="headerlink" title="Step 3: Configure Redis Access in Spring Boot"></a>Step 3: Configure Redis Access in Spring Boot</h5><p>When deploying your Spring Boot application in Kubernetes, you should use the service name to access Redis. Update your <code>application.yml</code> to use the service name:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<h5 id="Step-4-Enable-Redis-Persistence"><a href="#Step-4-Enable-Redis-Persistence" class="headerlink" title="Step 4: Enable Redis Persistence"></a>Step 4: Enable Redis Persistence</h5><p>To enable Redis persistence, configure the <code>redis.conf</code> file to use either RDB (Redis Database Backup) or AOF (Append-Only File) persistence:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>

<h5 id="Step-5-Secure-Redis"><a href="#Step-5-Secure-Redis" class="headerlink" title="Step 5: Secure Redis"></a>Step 5: Secure Redis</h5><p>Secure Redis by setting a password and enabling TLS:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">requirepass yourpassword</span><br><span class="line">tls-port 6379</span><br><span class="line">tls-cert-file /path/to/redis.crt</span><br><span class="line">tls-key-file /path/to/redis.key</span><br><span class="line">tls-ca-cert-file /path/to/ca.crt</span><br></pre></td></tr></table></figure>

<h5 id="Step-6-Monitor-Redis"><a href="#Step-6-Monitor-Redis" class="headerlink" title="Step 6: Monitor Redis"></a>Step 6: Monitor Redis</h5><p>Use Prometheus and Grafana to monitor Redis performance and health. Deploy a Redis exporter to expose Redis metrics:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">oliver006/redis_exporter:latest</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--redis.addr=redis:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--redis.password=yourpassword</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9121</span></span><br></pre></td></tr></table></figure>

<p>Create a service to expose the Redis exporter:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis-exporter</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9121</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9121</span></span><br></pre></td></tr></table></figure>

<h3 id="Data-Storage-Layer"><a href="#Data-Storage-Layer" class="headerlink" title="Data Storage Layer"></a><a name="data-storage-layer"></a>Data Storage Layer</h3><p>The data storage layer is the primary data store where data is persisted. It can be a relational database, NoSQL database, or any other storage solution.</p>
<h4 id="Diagram-1"><a href="#Diagram-1" class="headerlink" title="Diagram"></a>Diagram</h4><pre><code class="highlight mermaid">graph TD
    A[Service Layer] --&gt; B[Data Storage Layer]
    B --&gt; C[Relational Database]
    B --&gt; D[NoSQL Database]</code></pre>

<h4 id="Sample-Code"><a href="#Sample-Code" class="headerlink" title="Sample Code"></a>Sample Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findById</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Database query logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="comment">// Database save logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Layer"><a href="#Service-Layer" class="headerlink" title="Service Layer"></a><a name="service-layer"></a>Service Layer</h3><p>The service layer handles business logic and interacts with the cache and data storage layers. It is responsible for managing the flow of data between the client, cache, and data storage.</p>
<h4 id="Diagram-2"><a href="#Diagram-2" class="headerlink" title="Diagram"></a>Diagram</h4><pre><code class="highlight mermaid">graph TD
    A[Client] --&gt; B[Service Layer]
    B --&gt; C[Cache Layer]
    B --&gt; D[Data Storage Layer]</code></pre>

<h4 id="Sample-Code-1"><a href="#Sample-Code-1" class="headerlink" title="Sample Code"></a>Sample Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> cacheService.getUserById(userId);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            user = userRepository.findById(userId);</span><br><span class="line">            cacheService.saveUser(user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">        cacheService.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a><a name="load-balancer"></a>Load Balancer</h3><p>The load balancer distributes incoming requests across multiple instances of the service layer to ensure high availability and scalability.</p>
<h4 id="Diagram-3"><a href="#Diagram-3" class="headerlink" title="Diagram"></a>Diagram</h4><pre><code class="highlight mermaid">graph TD
    A[Client] --&gt; B[Load Balancer]
    B --&gt; C[Service Instance 1]
    B --&gt; D[Service Instance 2]
    B --&gt; E[Service Instance 3]</code></pre>

<h4 id="Sample-Code-2"><a href="#Sample-Code-2" class="headerlink" title="Sample Code"></a>Sample Code</h4><p>Load balancers are typically implemented using infrastructure components like NGINX, HAProxy, or cloud-provided load balancers (e.g., AWS ELB, Google Cloud Load Balancer).</p>
<h3 id="Monitoring-and-Metrics"><a href="#Monitoring-and-Metrics" class="headerlink" title="Monitoring and Metrics"></a><a name="monitoring-and-metrics"></a>Monitoring and Metrics</h3><p>Monitoring and metrics collection are essential for tracking the performance and health of the distributed system. Tools like Prometheus, Grafana, and ELK stack can be used for this purpose.</p>
<h4 id="Diagram-4"><a href="#Diagram-4" class="headerlink" title="Diagram"></a>Diagram</h4><pre><code class="highlight mermaid">graph TD
    A[Service Layer] --&gt; B[Monitoring and Metrics]
    B --&gt; C[Prometheus]
    B --&gt; D[Grafana]
    B --&gt; E[ELK Stack]</code></pre>

<h4 id="Sample-Code-3"><a href="#Sample-Code-3" class="headerlink" title="Sample Code"></a>Sample Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.Counter;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.Gauge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricsCollector</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">cacheHits</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">            .name(<span class="string">&quot;cache_hits_total&quot;</span>)</span><br><span class="line">            .help(<span class="string">&quot;Total number of cache hits.&quot;</span>)</span><br><span class="line">            .register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">cacheMisses</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">            .name(<span class="string">&quot;cache_misses_total&quot;</span>)</span><br><span class="line">            .help(<span class="string">&quot;Total number of cache misses.&quot;</span>)</span><br><span class="line">            .register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Gauge</span> <span class="variable">cacheSize</span> <span class="operator">=</span> Gauge.build()</span><br><span class="line">            .name(<span class="string">&quot;cache_size&quot;</span>)</span><br><span class="line">            .help(<span class="string">&quot;Current size of the cache.&quot;</span>)</span><br><span class="line">            .register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordCacheHit</span><span class="params">()</span> &#123;</span><br><span class="line">        cacheHits.inc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recordCacheMiss</span><span class="params">()</span> &#123;</span><br><span class="line">        cacheMisses.inc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setCacheSize</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        cacheSize.set(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-1-flow-control-and-backpressure-handling"></a></p>
<h2 id="Complex-Scenario-1-Flow-Control-and-Backpressure-Handling"><a href="#Complex-Scenario-1-Flow-Control-and-Backpressure-Handling" class="headerlink" title="Complex Scenario 1: Flow Control and Backpressure Handling"></a>Complex Scenario 1: Flow Control and Backpressure Handling</h2><h3 id="Problem-Statement"><a href="#Problem-Statement" class="headerlink" title="Problem Statement"></a>Problem Statement</h3><p>In high-traffic scenarios, the cache might become a bottleneck if not properly managed. Flow control and backpressure handling are essential to prevent the cache from being overwhelmed.</p>
<h3 id="Solution-Architecture"><a href="#Solution-Architecture" class="headerlink" title="Solution Architecture"></a>Solution Architecture</h3><ol>
<li><strong>Rate Limiting</strong>: Implement rate limiting to control the number of requests hitting the cache.</li>
<li><strong>Circuit Breaker</strong>: Use a circuit breaker to handle failures gracefully and prevent cascading failures.</li>
<li><strong>Backpressure Handling</strong>: Implement backpressure mechanisms to manage the flow of data between services.</li>
</ol>
<h3 id="Flow-Chart"><a href="#Flow-Chart" class="headerlink" title="Flow Chart"></a>Flow Chart</h3><pre><code class="highlight mermaid">graph TD
    A[Client Request] --&gt; B&#123;Rate Limiter&#125;
    B --&gt;|Allowed| C[Cache Lookup]
    B --&gt;|Denied| D[Fallback to Database]
    C --&gt; E&#123;Cache Hit?&#125;
    E --&gt;|Yes| F[Return Cached Data]
    E --&gt;|No| G[Fetch from Database]
    G --&gt; H[Update Cache]
    H --&gt; F
    D --&gt; G</code></pre>

<h3 id="Sample-Code-4"><a href="#Sample-Code-4" class="headerlink" title="Sample Code"></a>Sample Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;userCache&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Fetch user from database</span></span><br><span class="line">        <span class="keyword">return</span> fetchUserFromDatabase(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">fetchUserFromDatabase</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Database query logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-2-cache-invalidation-and-data-synchronization"></a></p>
<h2 id="Complex-Scenario-2-Cache-Invalidation-and-Data-Synchronization"><a href="#Complex-Scenario-2-Cache-Invalidation-and-Data-Synchronization" class="headerlink" title="Complex Scenario 2: Cache Invalidation and Data Synchronization"></a>Complex Scenario 2: Cache Invalidation and Data Synchronization</h2><h3 id="Problem-Statement-1"><a href="#Problem-Statement-1" class="headerlink" title="Problem Statement"></a>Problem Statement</h3><p>Ensuring that the cache remains consistent with the underlying data store is challenging, especially in distributed systems.</p>
<h3 id="Solution-Architecture-1"><a href="#Solution-Architecture-1" class="headerlink" title="Solution Architecture"></a>Solution Architecture</h3><ol>
<li><strong>Event-Driven Invalidation</strong>: Use event-driven mechanisms to invalidate the cache when data changes.</li>
<li><strong>Distributed Locking</strong>: Use distributed locking to ensure that only one service updates the cache at a time.</li>
<li><strong>TTL-Based Invalidation</strong>: Use Time-to-Live (TTL) to automatically invalidate cache entries after a certain period.</li>
</ol>
<h3 id="Sequence-Diagram"><a href="#Sequence-Diagram" class="headerlink" title="Sequence Diagram"></a>Sequence Diagram</h3><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant Service
    participant Cache
    participant Database

    Client-&gt;&gt;Service: Update User
    Service-&gt;&gt;Database: Update User in Database
    Database--&gt;&gt;Service: User Updated
    Service-&gt;&gt;Cache: Invalidate User Cache
    Cache--&gt;&gt;Service: Cache Invalidated
    Service--&gt;&gt;Client: User Updated</code></pre>

<h3 id="Sample-Code-5"><a href="#Sample-Code-5" class="headerlink" title="Sample Code"></a>Sample Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;userCache&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(Long userId, User user)</span> &#123;</span><br><span class="line">        <span class="comment">// Update user in database</span></span><br><span class="line">        updateUserInDatabase(userId, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateUserInDatabase</span><span class="params">(Long userId, User user)</span> &#123;</span><br><span class="line">        <span class="comment">// Database update logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-3-cache-stampede-prevention"></a></p>
<h2 id="Complex-Scenario-3-Cache-Stampede-Prevention"><a href="#Complex-Scenario-3-Cache-Stampede-Prevention" class="headerlink" title="Complex Scenario 3: Cache Stampede Prevention"></a>Complex Scenario 3: Cache Stampede Prevention</h2><h3 id="Problem-Statement-2"><a href="#Problem-Statement-2" class="headerlink" title="Problem Statement"></a>Problem Statement</h3><p>A cache stampede occurs when multiple requests for the same data hit the cache simultaneously, leading to a spike in database load.</p>
<h3 id="Solution-Architecture-2"><a href="#Solution-Architecture-2" class="headerlink" title="Solution Architecture"></a>Solution Architecture</h3><ol>
<li><strong>Probabilistic Early Expiration</strong>: Use probabilistic early expiration to spread out cache expiration times.</li>
<li><strong>Locking Mechanism</strong>: Implement a locking mechanism to ensure that only one request populates the cache at a time.</li>
<li><strong>Background Refresh</strong>: Use background refresh to keep the cache up-to-date without impacting the user experience.</li>
</ol>
<h3 id="Flow-Chart-1"><a href="#Flow-Chart-1" class="headerlink" title="Flow Chart"></a>Flow Chart</h3><pre><code class="highlight mermaid">graph TD
    A[Client Request] --&gt; B&#123;Cache Hit?&#125;
    B --&gt;|Yes| C[Return Cached Data]
    B --&gt;|No| D&#123;Lock Acquired?&#125;
    D --&gt;|Yes| E[Fetch from Database]
    D --&gt;|No| F[Wait for Lock]
    E --&gt; G[Update Cache]
    G --&gt; C
    F --&gt; B</code></pre>

<h3 id="Sample-Code-6"><a href="#Sample-Code-6" class="headerlink" title="Sample Code"></a>Sample Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;userCache&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">// Double-check to ensure the cache is still empty</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">cachedUser</span> <span class="operator">=</span> fetchUserFromCache(userId);</span><br><span class="line">            <span class="keyword">if</span> (cachedUser != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> cachedUser;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Fetch user from database</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> fetchUserFromDatabase(userId);</span><br><span class="line">            <span class="comment">// Update cache</span></span><br><span class="line">            updateCache(userId, user);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">fetchUserFromCache</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Cache lookup logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">fetchUserFromDatabase</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="comment">// Database query logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateCache</span><span class="params">(Long userId, User user)</span> &#123;</span><br><span class="line">        <span class="comment">// Cache update logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Caching is a powerful mechanism for improving the performance and scalability of distributed systems. By understanding the high-level architecture and detailed designs, you can effectively implement cache mechanisms that handle various complex scenarios like flow control, cache invalidation, and cache stampede prevention. Use the provided sample code and diagrams to implement efficient caching in your distributed system.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
