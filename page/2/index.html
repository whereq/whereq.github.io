<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/page/2/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">132</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/11/21/WebFlux-Deep-Dive-Operators-Types-and-Real-World-Use-Cases/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/11/21/WebFlux-Deep-Dive-Operators-Types-and-Real-World-Use-Cases/" class="post-title-link" itemprop="url">WebFlux Deep Dive: Operators, Types, and Real-World Use Cases</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-11-21 16:30:04 / Modified: 16:31:17" itemprop="dateCreated datePublished" datetime="2025-11-21T16:30:04-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebFlux/" itemprop="url" rel="index"><span itemprop="name">WebFlux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><a href="#core-reactive-types">Core Reactive Types</a></li>
<li><a href="#creation-operators">Creation Operators</a></li>
<li><a href="#transformation-operators">Transformation Operators</a></li>
<li><a href="#combination-operators">Combination Operators</a></li>
<li><a href="#error-handling-operators">Error Handling Operators</a></li>
<li><a href="#scheduling--threading">Scheduling &amp; Threading</a></li>
<li><a href="#advanced-patterns">Advanced Patterns</a></li>
</ol>
<h2 id="Core-Reactive-Types"><a href="#Core-Reactive-Types" class="headerlink" title="Core Reactive Types"></a>Core Reactive Types</h2><h3 id="Mono-Single-Result-Container"><a href="#Mono-Single-Result-Container" class="headerlink" title="Mono - Single Result Container"></a>Mono - Single Result Container</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mono represents a stream that emits 0 or 1 element</span></span><br><span class="line"><span class="comment"> * Perfect for: HTTP responses, database saves, single calculations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonoDeepDive</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Creation examples</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monoCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Empty Mono</span></span><br><span class="line">        Mono&lt;String&gt; empty = Mono.empty();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From value</span></span><br><span class="line">        Mono&lt;String&gt; staticValue = Mono.just(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From nullable</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">possiblyNull</span> <span class="operator">=</span> getFromCache();</span><br><span class="line">        Mono&lt;String&gt; nullable = Mono.justOrEmpty(possiblyNull);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From supplier (lazy)</span></span><br><span class="line">        Mono&lt;String&gt; lazy = Mono.fromSupplier(() -&gt; expensiveOperation());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From callable</span></span><br><span class="line">        Mono&lt;String&gt; fromCallable = Mono.fromCallable(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> database.getUser(userId); <span class="comment">// Potentially blocking</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From future</span></span><br><span class="line">        CompletableFuture&lt;String&gt; future = asyncHttpCall();</span><br><span class="line">        Mono&lt;String&gt; fromFuture = Mono.fromFuture(future);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Real-world use case: User profile lookup</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;UserProfile&gt; <span class="title function_">getUserProfile</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; userRepository.findById(userId))</span><br><span class="line">                  .filter(Optional::isPresent)</span><br><span class="line">                  .map(Optional::get)</span><br><span class="line">                  .switchIfEmpty(Mono.error(<span class="keyword">new</span> <span class="title class_">UserNotFoundException</span>(userId)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Flux-Multiple-Results-Stream"><a href="#Flux-Multiple-Results-Stream" class="headerlink" title="Flux - Multiple Results Stream"></a>Flux - Multiple Results Stream</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flux represents a stream that emits 0 to N elements</span></span><br><span class="line"><span class="comment"> * Perfect for: Collections, real-time streams, paginated results</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FluxDeepDive</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Creation examples</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fluxCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// From values</span></span><br><span class="line">        Flux&lt;String&gt; fromValues = Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From array</span></span><br><span class="line">        Flux&lt;String&gt; fromArray = Flux.fromArray(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>&#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From iterable</span></span><br><span class="line">        Flux&lt;String&gt; fromList = Flux.fromIterable(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Range</span></span><br><span class="line">        Flux&lt;Integer&gt; numbers = Flux.range(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Interval (real-time stream)</span></span><br><span class="line">        Flux&lt;Long&gt; ticker = Flux.interval(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate (stateful stream)</span></span><br><span class="line">        Flux&lt;Integer&gt; fibonacci = Flux.generate(</span><br><span class="line">            () -&gt; <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, <span class="comment">// initial state</span></span><br><span class="line">            (state, sink) -&gt; &#123;</span><br><span class="line">                sink.next(state[<span class="number">0</span>]);</span><br><span class="line">                <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> state[<span class="number">0</span>] + state[<span class="number">1</span>];</span><br><span class="line">                state[<span class="number">0</span>] = state[<span class="number">1</span>];</span><br><span class="line">                state[<span class="number">1</span>] = next;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Real-world use case: Real-time stock prices</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;StockPrice&gt; <span class="title function_">getStockPrices</span><span class="params">(String symbol)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">                  .flatMap(tick -&gt; </span><br><span class="line">                      Mono.fromCallable(() -&gt; stockService.getCurrentPrice(symbol))</span><br><span class="line">                          .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">                  )</span><br><span class="line">                  .take(<span class="number">100</span>); <span class="comment">// Only take 100 price updates</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transformation-Operators"><a href="#Transformation-Operators" class="headerlink" title="Transformation Operators"></a>Transformation Operators</h2><h3 id="map-vs-flatMap-The-Critical-Difference"><a href="#map-vs-flatMap-The-Critical-Difference" class="headerlink" title="map vs flatMap - The Critical Difference"></a>map vs flatMap - The Critical Difference</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformationOperators</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * map: Synchronous 1:1 transformation</span></span><br><span class="line"><span class="comment">     * Use when: Transformation is fast, non-blocking, CPU-bound</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mapOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; names = Flux.just(<span class="string">&quot;john&quot;</span>, <span class="string">&quot;jane&quot;</span>, <span class="string">&quot;bob&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Synchronous transformation - stays in same thread</span></span><br><span class="line">        Flux&lt;String&gt; capitalized = names.map(name -&gt; name.toUpperCase());</span><br><span class="line">        <span class="comment">// Output: JOHN, JANE, BOB</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Data enrichment (fast)</span></span><br><span class="line">        Flux&lt;User&gt; users = getUserIds()</span><br><span class="line">            .map(id -&gt; <span class="keyword">new</span> <span class="title class_">User</span>(id, <span class="string">&quot;user-&quot;</span> + id));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flatMap: Asynchronous 1:N transformation</span></span><br><span class="line"><span class="comment">     * Use when: Need to call async APIs, database, external services</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMapOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; userIds = Flux.just(<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Asynchronous transformation - can change threads</span></span><br><span class="line">        Flux&lt;User&gt; users = userIds.flatMap(id -&gt; </span><br><span class="line">            userRepository.findByIdAsync(id) <span class="comment">// Returns Mono&lt;User&gt;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Fetch user details from multiple services</span></span><br><span class="line">        Flux&lt;Order&gt; orders = getOrderIds()</span><br><span class="line">            .flatMap(orderId -&gt; </span><br><span class="line">                orderService.getOrderAsync(orderId)</span><br><span class="line">                    .onErrorResume(e -&gt; Mono.empty()) <span class="comment">// Skip failed orders</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flatMapMany: Convert Mono to Flux</span></span><br><span class="line"><span class="comment">     * Use when: You have Mono that emits multiple items</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMapManyOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Mono&lt;String&gt; csvData = readCsvFile();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Convert Mono&lt;String&gt; to Flux&lt;String[]&gt;</span></span><br><span class="line">        Flux&lt;String[]&gt; rows = csvData.flatMapMany(content -&gt; </span><br><span class="line">            Flux.fromArray(content.split(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">                .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Get user and their recent activities</span></span><br><span class="line">        Mono&lt;User&gt; user = getUserProfile(userId);</span><br><span class="line">        Flux&lt;Activity&gt; activities = user.flatMapMany(u -&gt; </span><br><span class="line">            activityService.getRecentActivities(u.getId())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Transformation-Operators"><a href="#Advanced-Transformation-Operators" class="headerlink" title="Advanced Transformation Operators"></a>Advanced Transformation Operators</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdvancedTransformations</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * concatMap vs flatMap - Ordering guarantee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderingGuarantees</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; ids = Flux.just(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// flatMap - no ordering guarantee (faster)</span></span><br><span class="line">        Flux&lt;String&gt; unordered = ids.flatMap(id -&gt; </span><br><span class="line">            asyncOperation(id).delayElement(Duration.ofMillis(randomDelay()))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// concatMap - preserves order (slower but ordered)</span></span><br><span class="line">        Flux&lt;String&gt; ordered = ids.concatMap(id -&gt; </span><br><span class="line">            asyncOperation(id).delayElement(Duration.ofMillis(randomDelay()))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Processing messages with ordering requirement</span></span><br><span class="line">        Flux&lt;Message&gt; kafkaMessages = kafkaReceiver.receive();</span><br><span class="line">        kafkaMessages</span><br><span class="line">            .concatMap(msg -&gt; processMessage(msg)) <span class="comment">// Maintain message order</span></span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * switchMap - Cancel previous emissions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">switchMapOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Real-world: Search-as-you-type</span></span><br><span class="line">        Flux&lt;String&gt; searchTerms = keyPressEvents();</span><br><span class="line">        </span><br><span class="line">        Flux&lt;SearchResults&gt; results = searchTerms</span><br><span class="line">            .debounce(Duration.ofMillis(<span class="number">300</span>)) <span class="comment">// Wait for typing to stop</span></span><br><span class="line">            .switchMap(term -&gt; </span><br><span class="line">                searchService.search(term) <span class="comment">// Cancel previous search if new term arrives</span></span><br><span class="line">                    .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * groupBy - Group elements by key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groupByOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Real-world: Group orders by customer</span></span><br><span class="line">        Flux&lt;Order&gt; orders = orderStream();</span><br><span class="line">        </span><br><span class="line">        Flux&lt;GroupedFlux&lt;String, Order&gt;&gt; byCustomer = orders</span><br><span class="line">            .groupBy(Order::getCustomerId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process each customer&#x27;s orders separately</span></span><br><span class="line">        byCustomer.flatMap(group -&gt; </span><br><span class="line">            group</span><br><span class="line">                .window(Duration.ofMinutes(<span class="number">5</span>)) <span class="comment">// Window by time</span></span><br><span class="line">                .flatMap(window -&gt; calculateCustomerStats(window))</span><br><span class="line">        ).subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Combination-Operators"><a href="#Combination-Operators" class="headerlink" title="Combination Operators"></a>Combination Operators</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CombinationOperators</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * zip - Combine multiple publishers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">zipOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Mono&lt;User&gt; user = getUser(userId);</span><br><span class="line">        Mono&lt;Profile&gt; profile = getProfile(userId);</span><br><span class="line">        Mono&lt;Preferences&gt; prefs = getPreferences(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Wait for all to complete, then combine</span></span><br><span class="line">        Mono&lt;UserDashboard&gt; dashboard = Mono.zip(user, profile, prefs)</span><br><span class="line">            .map(tuple -&gt; &#123;</span><br><span class="line">                <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> tuple.getT1();</span><br><span class="line">                <span class="type">Profile</span> <span class="variable">p</span> <span class="operator">=</span> tuple.getT2();</span><br><span class="line">                <span class="type">Preferences</span> <span class="variable">pref</span> <span class="operator">=</span> tuple.getT3();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserDashboard</span>(u, p, pref);</span><br><span class="line">            &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Aggregate data from multiple microservices</span></span><br><span class="line">        Mono&lt;OrderDetails&gt; orderDetails = Mono.zip(</span><br><span class="line">            orderService.getOrder(orderId),</span><br><span class="line">            paymentService.getPayment(orderId),</span><br><span class="line">            shippingService.getTracking(orderId)</span><br><span class="line">        ).map(t -&gt; OrderDetails.aggregate(t.getT1(), t.getT2(), t.getT3()));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * merge vs concat - Parallel vs sequential combination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mergeVsConcat</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; stream1 = Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>).delayElements(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">        Flux&lt;String&gt; stream2 = Flux.just(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>).delayElements(Duration.ofMillis(<span class="number">50</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// merge - interleaves as they arrive (faster)</span></span><br><span class="line">        Flux&lt;String&gt; merged = Flux.merge(stream1, stream2);</span><br><span class="line">        <span class="comment">// Possible output: 1, A, 2, B, 3, C</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// concat - waits for first to complete (ordered)</span></span><br><span class="line">        Flux&lt;String&gt; concatenated = Flux.concat(stream1, stream2);</span><br><span class="line">        <span class="comment">// Guaranteed output: A, B, C, 1, 2, 3</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * combineLatest - Combine latest from multiple streams</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">combineLatest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Real-world: Real-time dashboard with multiple data sources</span></span><br><span class="line">        Flux&lt;Double&gt; stockPrice = stockPriceStream();</span><br><span class="line">        Flux&lt;Double&gt; exchangeRate = exchangeRateStream();</span><br><span class="line">        Flux&lt;News&gt; newsFeed = newsStream();</span><br><span class="line">        </span><br><span class="line">        Flux&lt;Dashboard&gt; dashboard = Flux.combineLatest(</span><br><span class="line">            Arrays::asList,</span><br><span class="line">            stockPrice, exchangeRate, newsFeed</span><br><span class="line">        ).map(data -&gt; &#123;</span><br><span class="line">            <span class="type">Double</span> <span class="variable">price</span> <span class="operator">=</span> (Double) data[<span class="number">0</span>];</span><br><span class="line">            <span class="type">Double</span> <span class="variable">rate</span> <span class="operator">=</span> (Double) data[<span class="number">1</span>];</span><br><span class="line">            <span class="type">News</span> <span class="variable">news</span> <span class="operator">=</span> (News) data[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Dashboard</span>(price, rate, news);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-Operators"><a href="#Error-Handling-Operators" class="headerlink" title="Error Handling Operators"></a>Error Handling Operators</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorHandlingOperators</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Comprehensive error handling strategies</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">errorHandling</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; dataStream = getDataStream();</span><br><span class="line">        </span><br><span class="line">        dataStream</span><br><span class="line">            <span class="comment">// 1. Timeout handling</span></span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. Retry with backoff</span></span><br><span class="line">            .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. Fallback values</span></span><br><span class="line">            .onErrorReturn(<span class="string">&quot;fallback-value&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. Fallback method</span></span><br><span class="line">            .onErrorResume(error -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (error <span class="keyword">instanceof</span> TimeoutException) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getCachedData();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> DatabaseException) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getBackupData();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Flux.error(error);</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. Log and continue</span></span><br><span class="line">            .doOnError(error -&gt; </span><br><span class="line">                log.error(<span class="string">&quot;Stream processing failed&quot;</span>, error)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Circuit breaker pattern</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">circuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CircuitBreaker</span> <span class="variable">circuitBreaker</span> <span class="operator">=</span> CircuitBreaker.ofDefaults(<span class="string">&quot;backendService&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        Flux&lt;String&gt; resilientStream = Flux.interval(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">            .flatMap(tick -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; externalService.call())</span><br><span class="line">                    .transformDeferred(CircuitBreakerOperator.of(circuitBreaker))</span><br><span class="line">                    .onErrorResume(e -&gt; Mono.just(<span class="string">&quot;fallback&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scheduling-Threading"><a href="#Scheduling-Threading" class="headerlink" title="Scheduling &amp; Threading"></a>Scheduling &amp; Threading</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchedulingDeepDive</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Proper threading model for different operations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">schedulingOperators</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// CPU-intensive work</span></span><br><span class="line">        Flux&lt;Integer&gt; cpuIntensive = Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">            .parallel() <span class="comment">// Process in parallel</span></span><br><span class="line">            .runOn(Schedulers.parallel())</span><br><span class="line">            .map(i -&gt; expensiveComputation(i))</span><br><span class="line">            .sequential();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// I/O intensive work</span></span><br><span class="line">        Flux&lt;String&gt; ioIntensive = Flux.just(<span class="string">&quot;id1&quot;</span>, <span class="string">&quot;id2&quot;</span>, <span class="string">&quot;id3&quot;</span>)</span><br><span class="line">            .flatMap(id -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; database.query(id))</span><br><span class="line">                    .subscribeOn(Schedulers.boundedElastic()) <span class="comment">// Offload blocking I/O</span></span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-time processing with different schedulers</span></span><br><span class="line">        Flux.interval(Duration.ofMillis(<span class="number">10</span>))</span><br><span class="line">            .publishOn(Schedulers.single()) <span class="comment">// Dedicated thread for downstream</span></span><br><span class="line">            .map(tick -&gt; transformData(tick))</span><br><span class="line">            .publishOn(Schedulers.boundedElastic()) <span class="comment">// Switch threads for I/O</span></span><br><span class="line">            .flatMap(data -&gt; saveToDatabase(data))</span><br><span class="line">            .subscribeOn(Schedulers.parallel()) <span class="comment">// Where subscription happens</span></span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scheduler types and when to use them</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">schedulerTypes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Schedulers.immediate() - Current thread</span></span><br><span class="line">        <span class="comment">// Schedulers.single() - Single dedicated thread</span></span><br><span class="line">        <span class="comment">// Schedulers.parallel() - Fixed pool for CPU work</span></span><br><span class="line">        <span class="comment">// Schedulers.boundedElastic() - For blocking I/O (preferred over elastic)</span></span><br><span class="line">        <span class="comment">// Schedulers.elastic() - Legacy, unlimited threads (avoid)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Patterns-Real-World-Use-Cases"><a href="#Advanced-Patterns-Real-World-Use-Cases" class="headerlink" title="Advanced Patterns &amp; Real-World Use Cases"></a>Advanced Patterns &amp; Real-World Use Cases</h2><h3 id="Pattern-1-API-Gateway-with-Rate-Limiting"><a href="#Pattern-1-API-Gateway-with-Rate-Limiting" class="headerlink" title="Pattern 1: API Gateway with Rate Limiting"></a>Pattern 1: API Gateway with Rate Limiting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiGatewayService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ApiResponse&gt; <span class="title function_">handleConcurrentRequests</span><span class="params">(Flux&lt;ApiRequest&gt; requests)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requests</span><br><span class="line">            .window(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// Window by time</span></span><br><span class="line">            .flatMap(window -&gt; </span><br><span class="line">                window</span><br><span class="line">                    .limitRate(<span class="number">100</span>) <span class="comment">// Limit to 100 requests per second</span></span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::processRequest, <span class="number">10</span>) <span class="comment">// Max 10 concurrent</span></span><br><span class="line">            )</span><br><span class="line">            .onErrorResume(error -&gt; </span><br><span class="line">                Flux.just(ApiResponse.error(<span class="string">&quot;Service unavailable&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;ApiResponse&gt; <span class="title function_">processRequest</span><span class="params">(ApiRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.zip(</span><br><span class="line">            userService.validateToken(request.getToken()),</span><br><span class="line">            rateLimitService.checkLimit(request.getUserId())</span><br><span class="line">        )</span><br><span class="line">        .flatMap(tuple -&gt; routingService.routeRequest(request))</span><br><span class="line">        .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">        .retryWhen(Retry.fixedDelay(<span class="number">2</span>, Duration.ofMillis(<span class="number">100</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-2-Real-Time-Data-Pipeline"><a href="#Pattern-2-Real-Time-Data-Pipeline" class="headerlink" title="Pattern 2: Real-Time Data Pipeline"></a>Pattern 2: Real-Time Data Pipeline</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataPipeline</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ProcessedData&gt; <span class="title function_">createPipeline</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kafkaSource.stream()</span><br><span class="line">            .groupBy(message -&gt; message.getPartitionKey()) <span class="comment">// Maintain ordering per key</span></span><br><span class="line">            .flatMap(partitionStream -&gt; </span><br><span class="line">                partitionStream</span><br><span class="line">                    .window(Duration.ofSeconds(<span class="number">5</span>)) <span class="comment">// Batch processing</span></span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::processBatch)</span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::enrichWithExternalData)</span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::validateAndTransform)</span><br><span class="line">                    .buffer(<span class="number">100</span>) <span class="comment">// Buffer for bulk insert</span></span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::bulkInsertToDatabase)</span><br><span class="line">            , <span class="number">32</span>) <span class="comment">// Process 32 partitions concurrently</span></span><br><span class="line">            .metrics() <span class="comment">// Monitor performance</span></span><br><span class="line">            .doOnNext(metrics::recordProcessingTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;ProcessedData&gt; <span class="title function_">processBatch</span><span class="params">(Flux&lt;Message&gt; batch)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> batch</span><br><span class="line">            .collectList()</span><br><span class="line">            .flatMap(list -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; sparkService.processBatch(list))</span><br><span class="line">                    .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-3-Resilient-Service-Composition"><a href="#Pattern-3-Resilient-Service-Composition" class="headerlink" title="Pattern 3: Resilient Service Composition"></a>Pattern 3: Resilient Service Composition</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientServiceComposition</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;OrderResult&gt; <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> validateOrder(order)</span><br><span class="line">            .flatMap(validated -&gt; </span><br><span class="line">                Mono.zip(</span><br><span class="line">                    reserveInventory(validated).onErrorReturn(InventoryReservation.failed()),</span><br><span class="line">                    processPayment(validated).onErrorReturn(PaymentResult.failed()),</span><br><span class="line">                    updateShipping(validated).onErrorReturn(ShippingUpdate.failed())</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            .map(tuple -&gt; &#123;</span><br><span class="line">                <span class="comment">// Compose final result from partial successes/failures</span></span><br><span class="line">                <span class="keyword">return</span> OrderResult.fromComponents(</span><br><span class="line">                    tuple.getT1(), </span><br><span class="line">                    tuple.getT2(), </span><br><span class="line">                    tuple.getT3()</span><br><span class="line">                );</span><br><span class="line">            &#125;)</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Best-Practices"><a href="#Performance-Best-Practices" class="headerlink" title="Performance Best Practices"></a>Performance Best Practices</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBestPractices</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. Avoid blocking in reactive chains</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">badExample</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">            .map(i -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> blockingDatabaseCall(i); <span class="comment">//  BLOCKING!</span></span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">goodExample</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">            .flatMap(i -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; blockingDatabaseCall(i))</span><br><span class="line">                    .subscribeOn(Schedulers.boundedElastic()) <span class="comment">//  Correct</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Use backpressure properly</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Data&gt; <span class="title function_">handleBackpressure</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fastProducer()</span><br><span class="line">            .onBackpressureBuffer(<span class="number">1000</span>) <span class="comment">// Buffer up to 1000 elements</span></span><br><span class="line">            .onBackpressureDrop(dropped -&gt; log.warn(<span class="string">&quot;Dropped: &#123;&#125;&quot;</span>, dropped))</span><br><span class="line">            .concatMap(<span class="built_in">this</span>::slowConsumer, <span class="number">5</span>); <span class="comment">// Control concurrency</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Monitor and tune</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitoring</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">            .name(<span class="string">&quot;processing.pipeline&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;batch&quot;</span>)</span><br><span class="line">            .metrics()</span><br><span class="line">            .doOnNext(item -&gt; </span><br><span class="line">                Metrics.counter(<span class="string">&quot;items.processed&quot;</span>).increment()</span><br><span class="line">            )</span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/10/22/Hexo-and-NexT-Theme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/22/Hexo-and-NexT-Theme/" class="post-title-link" itemprop="url">Hexo and NexT Theme</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-10-22 14:38:42" itemprop="dateCreated datePublished" datetime="2025-10-22T14:38:42-04:00">2025-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1--NexT-"><a href="#1--NexT-" class="headerlink" title="1.  NexT "></a>1.  NexT </h2><h3 id="-Git"><a href="#-Git" class="headerlink" title=" Git"></a> Git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  Hexo </span></span><br><span class="line"><span class="built_in">cd</span> your-hexo-site</span><br><span class="line"></span><br><span class="line"><span class="comment">#  NexT  themes/next </span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/next-theme/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<h3 id="-npm"><a href="#-npm" class="headerlink" title=" npm"></a> npm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  npm </span></span><br><span class="line">npm install hexo-theme-next</span><br></pre></td></tr></table></figure>

<h2 id="2--NexT-"><a href="#2--NexT-" class="headerlink" title="2.  NexT "></a>2.  NexT </h2><h3 id="2-1--config-yml"><a href="#2-1--config-yml" class="headerlink" title="2.1  _config.yml"></a>2.1  <code>_config.yml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">title:</span> <span class="string"></span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string"></span></span><br><span class="line"><span class="attr">description:</span> <span class="string"></span></span><br><span class="line"><span class="attr">keywords:</span> <span class="string">1,</span> <span class="string">2</span></span><br><span class="line"><span class="attr">author:</span> <span class="string"></span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://yourusername.github.io</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink_defaults:</span></span><br><span class="line"><span class="attr">pretty_urls:</span></span><br><span class="line">  <span class="attr">trailing_index:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trailing_html:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">source_dir:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">public_dir:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">code_dir:</span> <span class="string">downloads/code</span></span><br><span class="line"><span class="attr">i18n_dir:</span> <span class="string">:lang</span></span><br><span class="line"><span class="attr">skip_render:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br></pre></td></tr></table></figure>

<h2 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">hexo clean</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">hexo generate</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<p> <code>http://localhost:4000</code> </p>
<h2 id="4-NexT-"><a href="#4-NexT-" class="headerlink" title="4. NexT "></a>4. NexT </h2><h3 id="4-1-"><a href="#4-1-" class="headerlink" title="4.1 "></a>4.1 </h3><p>NexT </p>
<ul>
<li><strong></strong>: <code>_config.yml</code> (Hexo )</li>
<li><strong></strong>: <code>themes/next/_config.yml</code></li>
</ul>
<h3 id="4-2-"><a href="#4-2-" class="headerlink" title="4.2 "></a>4.2 </h3><p>NexT  <code>themes/next/_config.yml</code> </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment"># scheme: Muse</span></span><br><span class="line"><span class="comment"># scheme: Mist</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Gemini</span></span><br><span class="line"><span class="comment"># scheme: Pisces</span></span><br></pre></td></tr></table></figure>

<p></p>
<h3 id="4-3-"><a href="#4-3-" class="headerlink" title="4.3 "></a>4.3 </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  themes/next/_config.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">favicon:</span></span><br><span class="line">  <span class="attr">small:</span> <span class="string">/images/favicon-16x16-next.png</span></span><br><span class="line">  <span class="attr">medium:</span> <span class="string">/images/favicon-32x32-next.png</span></span><br><span class="line">  <span class="attr">apple_touch_icon:</span> <span class="string">/images/apple-touch-icon-next.png</span></span><br><span class="line">  <span class="attr">safari_pinned_tab:</span> <span class="string">/images/logo.svg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">logo:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">/images/logo.svg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="comment"># sitemap: /sitemap/ || fa fa-sitemap</span></span><br><span class="line">  <span class="comment"># commonweal: /404/ || fa fa-heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/yourusername</span> <span class="string">||</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:your-email@example.com</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-envelope</span></span><br><span class="line">  <span class="comment"># Weibo: https://weibo.com/yourusername || fab fa-weibo</span></span><br><span class="line">  <span class="comment"># Twitter: https://twitter.com/yourusername || fab fa-twitter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">sidebar:</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">left</span></span><br><span class="line">  <span class="attr">display:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">offset:</span> <span class="number">12</span></span><br><span class="line">  <span class="attr">b2t:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">/images/avatar.png</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="5-"><a href="#5-" class="headerlink" title="5. "></a>5. </h2><h3 id="5-1-"><a href="#5-1-" class="headerlink" title="5.1 "></a>5.1 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page about</span><br></pre></td></tr></table></figure>

<p> <code>source/about/index.md</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: </span><br><span class="line">date: 2024-01-01 00:00:00</span><br><span class="line"><span class="section">type: about</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="5-2-"><a href="#5-2-" class="headerlink" title="5.2 "></a>5.2 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page tags</span><br></pre></td></tr></table></figure>

<p> <code>source/tags/index.md</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: </span><br><span class="line">date: 2024-01-01 00:00:00</span><br><span class="line"><span class="section">type: tags</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-"><a href="#5-3-" class="headerlink" title="5.3 "></a>5.3 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page categories</span><br></pre></td></tr></table></figure>

<p> <code>source/categories/index.md</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: </span><br><span class="line">date: 2024-01-01 00:00:00</span><br><span class="line"><span class="section">type: categories</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<h2 id="6-"><a href="#6-" class="headerlink" title="6. "></a>6. </h2><h3 id="6-1-"><a href="#6-1-" class="headerlink" title="6.1 "></a>6.1 </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  themes/next/_config.yml </span></span><br><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">darker</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">show_result:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">flat</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-"><a href="#6-2-" class="headerlink" title="6.2 "></a>6.2 </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#37c6c0&quot;</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">3px</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-"><a href="#6-3-" class="headerlink" title="6.3 "></a>6.3 </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Math Formulas Render Support</span></span><br><span class="line"><span class="attr">math:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mathjax:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: none | ams | all</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">none</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">katex:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">copy_tex:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-"><a href="#6-4-" class="headerlink" title="6.4 "></a>6.4 </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">comments:</span></span><br><span class="line">  <span class="comment"># : utterances | giscus | disqus | disqusjs | changyan | livere | remark42 | valine</span></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">utterances</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Utterances </span></span><br><span class="line"><span class="attr">utterances:</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">yourusername/your-repo</span>  <span class="comment">#  GitHub </span></span><br><span class="line">  <span class="attr">issue_term:</span> <span class="string">pathname</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">utterances</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">github-light</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-"><a href="#6-5-" class="headerlink" title="6.5 "></a>6.5 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">npm install hexo-generator-searchdb</span><br></pre></td></tr></table></figure>

<p> Hexo </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">html</span></span><br></pre></td></tr></table></figure>

<p></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Local Search</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">unescape:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">preload:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="7-"><a href="#7-" class="headerlink" title="7. "></a>7. </h2><h3 id="7-1--CSS"><a href="#7-1--CSS" class="headerlink" title="7.1  CSS"></a>7.1  CSS</h3><p> <code>source/_data/styles.styl</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f7f9fa</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="selector-class">.post-block</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#3498db</span>;</span><br><span class="line">  <span class="selector-pseudo">&amp;:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#2980b9</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">source/_data/styles.styl</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-"><a href="#7-2-" class="headerlink" title="7.2 "></a>7.2 </h3><p> <code>themes/next/layout/_custom/custom-layout.swig</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;_layout.swig&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;custom-container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; page.title &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;custom-content&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123; page.content &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-"><a href="#8-" class="headerlink" title="8. "></a>8. </h2><h3 id="8-1-"><a href="#8-1-" class="headerlink" title="8.1 "></a>8.1 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure>

<h3 id="8-2-"><a href="#8-2-" class="headerlink" title="8.2 "></a>8.2 </h3><p> Hexo </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/yourusername/yourusername.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">&quot;Site updated: <span class="template-variable">&#123;&#123; now(&#x27;YYYY-MM-DD HH:mm:ss&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-"><a href="#8-3-" class="headerlink" title="8.3 "></a>8.3 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">hexo clean &amp;&amp; hexo g -d</span><br></pre></td></tr></table></figure>

<h2 id="9-"><a href="#9-" class="headerlink" title="9. "></a>9. </h2><h3 id="9-1-"><a href="#9-1-" class="headerlink" title="9.1 "></a>9.1 </h3><ol>
<li><p><strong></strong></p>
<ul>
<li> <code>theme: next</code> </li>
<li> <code>hexo clean</code></li>
</ul>
</li>
<li><p><strong> 404</strong></p>
<ul>
<li></li>
<li></li>
</ul>
</li>
<li><p><strong></strong></p>
<ul>
<li> CSS </li>
<li></li>
</ul>
</li>
</ol>
<h3 id="9-2-"><a href="#9-2-" class="headerlink" title="9.2 "></a>9.2 </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">hexo generate --debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">hexo config</span><br></pre></td></tr></table></figure>

<h2 id="10-"><a href="#10-" class="headerlink" title="10. "></a>10. </h2><ol>
<li><strong></strong> Hexo </li>
<li><strong></strong></li>
<li><strong></strong></li>
<li><strong> CDN</strong> CDN </li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain-II/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain-II/" class="post-title-link" itemprop="url">WhereQ-GPT with LangGraph and LangChain - II</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-06 13:10:05" itemprop="dateCreated datePublished" datetime="2025-05-06T13:10:05-04:00">2025-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/" itemprop="url" rel="index"><span itemprop="name">LangGraph</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/LangChain/" itemprop="url" rel="index"><span itemprop="name">LangChain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="-Workflow-Overview"><a href="#-Workflow-Overview" class="headerlink" title=" Workflow Overview"></a> Workflow Overview</h2><ol>
<li><strong>User Input</strong>: Receive a natural language question.</li>
<li><strong>Embedding</strong>: Convert the question into a vector representation.</li>
<li><strong>Schema Retrieval</strong>: Use FAISS to find relevant database schemas based on the vector.</li>
<li><strong>Term Mapping</strong>: Map domain-specific terms to database fields using a local knowledge base.</li>
<li><strong>Time Parsing</strong>: Identify and standardize time expressions in the question.</li>
<li><strong>SQL Generation</strong>: Use OpenAIs GPT model to generate the SQL query.</li>
<li><strong>Execution</strong>: Run the SQL query against the database and return results.(<a target="_blank" rel="noopener" href="https://www.kaggle.com/code/ksmooi/langgraph-sql-query-generation?utm_source=chatgpt.com" title="LangGraph: SQL Query Generation - Kaggle">Kaggle</a>)</li>
</ol>
<hr>
<h2 id="-Implementation-Details"><a href="#-Implementation-Details" class="headerlink" title=" Implementation Details"></a> Implementation Details</h2><h3 id="1-Setup"><a href="#1-Setup" class="headerlink" title="1. Setup"></a>1. Setup</h3><p>Ensure you have the necessary packages installed:(<a target="_blank" rel="noopener" href="https://python.langchain.com/v0.2/docs/tutorials/sql_qa/?utm_source=chatgpt.com" title="Build a Question/Answering system over SQL data |  LangChain">Introduction |  LangChain</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langgraph langchain langchain-community openai faiss-cpu</span><br></pre></td></tr></table></figure>



<h3 id="2-Define-the-LangGraph-Nodes"><a href="#2-Define-the-LangGraph-Nodes" class="headerlink" title="2. Define the LangGraph Nodes"></a>2. Define the LangGraph Nodes</h3><p>Each step in the workflow is represented as a node in LangGraph.</p>
<h4 id="a-Embedding-Node"><a href="#a-Embedding-Node" class="headerlink" title="a. Embedding Node"></a>a. Embedding Node</h4><p>Converts the users question into a vector.(<a target="_blank" rel="noopener" href="https://m.youtube.com/watch?v=N9mPo6jFOuc&utm_source=chatgpt.com" title="Langchain v0.3 Agents P3 - LangGraph SQL Agent w/Tools, Custom ...">YouTube</a>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.embeddings <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">embed_question</span>(<span class="params">state</span>):</span><br><span class="line">    question = state[<span class="string">&#x27;question&#x27;</span>]</span><br><span class="line">    embedding_model = OpenAIEmbeddings()</span><br><span class="line">    vector = embedding_model.embed_query(question)</span><br><span class="line">    state[<span class="string">&#x27;vector&#x27;</span>] = vector</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="b-Schema-Retrieval-Node"><a href="#b-Schema-Retrieval-Node" class="headerlink" title="b. Schema Retrieval Node"></a>b. Schema Retrieval Node</h4><p>Uses FAISS to find relevant schemas.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_schema</span>(<span class="params">state</span>):</span><br><span class="line">    vector = np.array(state[<span class="string">&#x27;vector&#x27;</span>]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    D, I = state[<span class="string">&#x27;faiss_index&#x27;</span>].search(np.array([vector]), k=<span class="number">3</span>)</span><br><span class="line">    matched_schemas = [state[<span class="string">&#x27;schema_texts&#x27;</span>][i] <span class="keyword">for</span> i <span class="keyword">in</span> I[<span class="number">0</span>]]</span><br><span class="line">    state[<span class="string">&#x27;matched_schemas&#x27;</span>] = matched_schemas</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="c-Term-Mapping-Node"><a href="#c-Term-Mapping-Node" class="headerlink" title="c. Term Mapping Node"></a>c. Term Mapping Node</h4><p>Maps domain-specific terms to database fields.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">map_terms</span>(<span class="params">state</span>):</span><br><span class="line">    question = state[<span class="string">&#x27;question&#x27;</span>]</span><br><span class="line">    term_mappings = state[<span class="string">&#x27;term_mappings&#x27;</span>]  <span class="comment"># e.g., &#123;&#x27;soft drinks&#x27;: &#x27;beverages&#x27;&#125;</span></span><br><span class="line">    <span class="keyword">for</span> term, field <span class="keyword">in</span> term_mappings.items():</span><br><span class="line">        question = question.replace(term, field)</span><br><span class="line">    state[<span class="string">&#x27;mapped_question&#x27;</span>] = question</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="d-Time-Parsing-Node"><a href="#d-Time-Parsing-Node" class="headerlink" title="d. Time Parsing Node"></a>d. Time Parsing Node</h4><p>Identifies and standardizes time expressions.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_time</span>(<span class="params">state</span>):</span><br><span class="line">    question = state[<span class="string">&#x27;mapped_question&#x27;</span>]</span><br><span class="line">    <span class="comment"># Simple example for Q3 2024</span></span><br><span class="line">    <span class="keyword">match</span> = re.search(<span class="string">r&#x27;Q([1-4]) (\d&#123;4&#125;)&#x27;</span>, question)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        quarter = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>))</span><br><span class="line">        year = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>))</span><br><span class="line">        month_start = (quarter - <span class="number">1</span>) * <span class="number">3</span> + <span class="number">1</span></span><br><span class="line">        start_date = datetime(year, month_start, <span class="number">1</span>).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">        end_month = month_start + <span class="number">2</span></span><br><span class="line">        end_date = datetime(year, end_month, <span class="number">28</span>).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)  <span class="comment"># Simplified</span></span><br><span class="line">        state[<span class="string">&#x27;time_range&#x27;</span>] = (start_date, end_date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        state[<span class="string">&#x27;time_range&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="e-SQL-Generation-Node"><a href="#e-SQL-Generation-Node" class="headerlink" title="e. SQL Generation Node"></a>e. SQL Generation Node</h4><p>Uses OpenAIs GPT model to generate the SQL query.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_sql</span>(<span class="params">state</span>):</span><br><span class="line">    llm = ChatOpenAI(model_name=<span class="string">&quot;gpt-3.5-turbo&quot;</span>)</span><br><span class="line">    prompt = PromptTemplate.from_template(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given the following database schemas:</span></span><br><span class="line"><span class="string">    &#123;schemas&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    And the question:</span></span><br><span class="line"><span class="string">    &#123;question&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Generate an appropriate SQL query.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    input_prompt = prompt.<span class="built_in">format</span>(</span><br><span class="line">        schemas=<span class="string">&#x27;\n&#x27;</span>.join(state[<span class="string">&#x27;matched_schemas&#x27;</span>]),</span><br><span class="line">        question=state[<span class="string">&#x27;mapped_question&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line">    sql_query = llm.predict(input_prompt)</span><br><span class="line">    state[<span class="string">&#x27;sql_query&#x27;</span>] = sql_query</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="f-Execution-Node"><a href="#f-Execution-Node" class="headerlink" title="f. Execution Node"></a>f. Execution Node</h4><p>Executes the SQL query against the database.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_query</span>(<span class="params">state</span>):</span><br><span class="line">    conn = sqlite3.connect(<span class="string">&#x27;your_database.db&#x27;</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(state[<span class="string">&#x27;sql_query&#x27;</span>])</span><br><span class="line">    results = cursor.fetchall()</span><br><span class="line">    state[<span class="string">&#x27;results&#x27;</span>] = results</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h3 id="3-Build-the-LangGraph"><a href="#3-Build-the-LangGraph" class="headerlink" title="3. Build the LangGraph"></a>3. Build the LangGraph</h3><p>Assemble the nodes into a workflow.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"></span><br><span class="line">graph_builder = StateGraph()</span><br><span class="line"></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;embed_question&quot;</span>, embed_question)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;retrieve_schema&quot;</span>, retrieve_schema)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;map_terms&quot;</span>, map_terms)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;parse_time&quot;</span>, parse_time)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;generate_sql&quot;</span>, generate_sql)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;execute_query&quot;</span>, execute_query)</span><br><span class="line"></span><br><span class="line">graph_builder.set_entry_point(<span class="string">&quot;embed_question&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;embed_question&quot;</span>, <span class="string">&quot;retrieve_schema&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;retrieve_schema&quot;</span>, <span class="string">&quot;map_terms&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;map_terms&quot;</span>, <span class="string">&quot;parse_time&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;parse_time&quot;</span>, <span class="string">&quot;generate_sql&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;generate_sql&quot;</span>, <span class="string">&quot;execute_query&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;execute_query&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure>



<h3 id="4-Run-the-Workflow"><a href="#4-Run-the-Workflow" class="headerlink" title="4. Run the Workflow"></a>4. Run the Workflow</h3><p>Initialize the state and run the graph.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">initial_state = &#123;</span><br><span class="line">    <span class="string">&#x27;question&#x27;</span>: <span class="string">&quot;Sales statistics for soft drinks in Q3 2024&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;faiss_index&#x27;</span>: your_faiss_index,</span><br><span class="line">    <span class="string">&#x27;schema_texts&#x27;</span>: your_schema_texts,</span><br><span class="line">    <span class="string">&#x27;term_mappings&#x27;</span>: &#123;<span class="string">&#x27;soft drinks&#x27;</span>: <span class="string">&#x27;beverages&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final_state = graph.invoke(initial_state)</span><br><span class="line"><span class="built_in">print</span>(final_state[<span class="string">&#x27;results&#x27;</span>])</span><br></pre></td></tr></table></figure>


<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/06/LangChain-and-LangGraph/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/06/LangChain-and-LangGraph/" class="post-title-link" itemprop="url">LangChain and LangGraph</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-06 13:01:36" itemprop="dateCreated datePublished" datetime="2025-05-06T13:01:36-04:00">2025-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/" itemprop="url" rel="index"><span itemprop="name">LangGraph</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/LangChain/" itemprop="url" rel="index"><span itemprop="name">LangChain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id=""><a href="#" class="headerlink" title=""></a></h3><table>
<thead>
<tr>
<th><strong></strong></th>
<th><strong>LangChain</strong></th>
<th><strong>LangGraph</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong></strong></td>
<td>AI</td>
<td></td>
</tr>
<tr>
<td><strong></strong></td>
<td>LLM</td>
<td></td>
</tr>
<tr>
<td><strong></strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong></strong></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><pre><code class="highlight mermaid">graph TD
    subgraph LangChain
        A[Prompt] --&gt; B[LLM]
        B --&gt; C[]
        C --&gt; D[]
    end
    
    subgraph LangGraph
        E[] --&gt; F&#123;&#125;
        F --&gt;|| G[A]
        F --&gt;|| H[B]
        G &amp; H --&gt; I[]
        I --&gt; J[]
    end</code></pre>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><ul>
<li><p><strong>LangChain</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">chain = prompt | llm | output_parser</span><br><span class="line">result = chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;...&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>LangGraph</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">workflow = StateGraph(MyState)</span><br><span class="line">workflow.add_node(<span class="string">&quot;analyze&quot;</span>, analyze_node)</span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;analyze&quot;</span>,</span><br><span class="line">    <span class="keyword">lambda</span> x: <span class="string">&quot;retry&quot;</span> <span class="keyword">if</span> x[<span class="string">&quot;needs_retry&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;continue&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><table>
<thead>
<tr>
<th><strong></strong></th>
<th>LangChain</th>
<th>LangGraph</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. <strong></strong></h4><ul>
<li><p><strong>LangChain</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> retry</span><br><span class="line"></span><br><span class="line"><span class="meta">@retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unreliable_chain</span>():</span><br><span class="line">    chain.invoke(...)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>LangGraph</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;query_db&quot;</span>,</span><br><span class="line">    <span class="keyword">lambda</span> s: <span class="string">&quot;retry&quot;</span> <span class="keyword">if</span> s[<span class="string">&quot;db_error&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;next&quot;</span>,</span><br><span class="line">    max_retries=<span class="number">3</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>5</p>
<table>
<thead>
<tr>
<th><strong></strong></th>
<th>LangChain</th>
<th>LangGraph</th>
</tr>
</thead>
<tbody><tr>
<td> (req&#x2F;s)</td>
<td>12</td>
<td>18</td>
</tr>
<tr>
<td> (ms)</td>
<td>450</td>
<td>320</td>
</tr>
<tr>
<td> (ms)</td>
<td>1200</td>
<td>400</td>
</tr>
<tr>
<td> (GB)</td>
<td>1.2</td>
<td>1.8</td>
</tr>
</tbody></table>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="1-LangChain"><a href="#1-LangChain" class="headerlink" title="1. LangChain"></a>1. <strong>LangChain</strong></h4><ul>
<li><p><strong>RAG</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">retriever = vectorstore.as_retriever()</span><br><span class="line">qa_chain = RetrievalQA.from_chain_type(llm, retriever=retriever)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chain = (</span><br><span class="line">    PromptTemplate.from_template(<span class="string">&quot;...&quot;</span>) </span><br><span class="line">    | ChatOpenAI() </span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-LangGraph"><a href="#2-LangGraph" class="headerlink" title="2. LangGraph"></a>2. <strong>LangGraph</strong></h4><ul>
<li><p><strong></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">approve_request</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;amount&quot;</span>] &gt; <span class="number">10000</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;next_step&quot;</span>: <span class="string">&quot;manager_approval&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;next_step&quot;</span>: <span class="string">&quot;auto_approve&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;initial_analysis&quot;</span>,</span><br><span class="line">    <span class="keyword">lambda</span> s: <span class="string">&quot;deep_dive&quot;</span> <span class="keyword">if</span> s[<span class="string">&quot;needs_detail&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;summary&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="1-LangChain"><a href="#1-LangChain" class="headerlink" title="1. LangChain"></a>1. <strong>LangChain</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> ToolNode</span><br><span class="line"></span><br><span class="line"><span class="comment"># LangChainLangGraph</span></span><br><span class="line">search_tool = ToolNode.from_langchain_tool(</span><br><span class="line">    tavily_search, </span><br><span class="line">    name=<span class="string">&quot;web_search&quot;</span></span><br><span class="line">)</span><br><span class="line">workflow.add_node(<span class="string">&quot;search&quot;</span>, search_tool)</span><br></pre></td></tr></table></figure>

<h4 id="2-Chain"><a href="#2-Chain" class="headerlink" title="2. Chain"></a>2. <strong>Chain</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">smart_retrieval</span>(<span class="params">state: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    chain = create_retriever_chain(</span><br><span class="line">        k=state.get(<span class="string">&quot;retrieve_size&quot;</span>, <span class="number">5</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;results&quot;</span>: chain.invoke(state[<span class="string">&quot;query&quot;</span>])&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><table>
<thead>
<tr>
<th><strong></strong></th>
<th>LangChain</th>
<th>LangGraph</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>LangSmith</td>
<td></td>
</tr>
</tbody></table>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="1-LangChainLangGraph"><a href="#1-LangChainLangGraph" class="headerlink" title="1. LangChainLangGraph"></a>1. <strong>LangChainLangGraph</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LangChain</span></span><br><span class="line">chain = prompt | llm | output_parser</span><br><span class="line"></span><br><span class="line"><span class="comment"># LangGraph</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chain_node</span>(<span class="params">state</span>):</span><br><span class="line">    result = chain.invoke(state[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;output&quot;</span>: result&#125;</span><br><span class="line"></span><br><span class="line">workflow.add_node(<span class="string">&quot;llm_chain&quot;</span>, chain_node)</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><ol>
<li>Chain</li>
<li>LangGraph</li>
<li></li>
</ol>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ol>
<li><p><strong>LangChain</strong></p>
<ul>
<li>LLM</li>
<li></li>
</ul>
</li>
<li><p><strong>LangGraph</strong></p>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
</li>
</ol>
<hr>
<p></p>
<table>
<thead>
<tr>
<th><strong></strong></th>
<th><strong></strong></th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;</td>
<td>LangChain</td>
</tr>
<tr>
<td></td>
<td>LangGraph</td>
</tr>
<tr>
<td>LangChain</td>
<td></td>
</tr>
<tr>
<td></td>
<td>LangGraph</td>
</tr>
<tr>
<td>PoC</td>
<td>LangChain</td>
</tr>
</tbody></table>
<p>AI</p>
<ul>
<li>LangChain</li>
<li>LangGraph</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain/" class="post-title-link" itemprop="url">WhereQ-GPT with LangGraph and LangChain</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-06 12:44:50" itemprop="dateCreated datePublished" datetime="2025-05-06T12:44:50-04:00">2025-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/" itemprop="url" rel="index"><span itemprop="name">LangGraph</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/LangChain/" itemprop="url" rel="index"><span itemprop="name">LangChain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="LangGraph-LangChainBIWhereQ-GPT"><a href="#LangGraph-LangChainBIWhereQ-GPT" class="headerlink" title="LangGraph+LangChainBIWhereQ-GPT"></a>LangGraph+LangChainBIWhereQ-GPT</h1><h2 id="LangGraph"><a href="#LangGraph" class="headerlink" title="LangGraph"></a>LangGraph</h2><p>WhereQ-GPT<strong></strong>LangGraphBI</p>
<ul>
<li><strong>Python 3.12</strong></li>
<li><strong>LangGraph 0.1</strong></li>
<li><strong>LangChain 0.2</strong>AI</li>
<li><strong>Weaviate</strong></li>
<li><strong>OpenAI GPT-4o</strong></li>
</ul>
<pre><code class="highlight mermaid">graph LR
    A[] --&gt; B&#123;LangGraph&#125;
    B --&gt; C[]
    C --&gt; D[]
    D --&gt; E[SQL]
    E --&gt; F[]
    F --&gt; G[]
    G --&gt; H&#123;?&#125;
    H --  --&gt; C
    H --  --&gt; I[]</code></pre>

<h2 id="LangGraph"><a href="#LangGraph" class="headerlink" title="LangGraph"></a>LangGraph</h2><h3 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict, <span class="type">List</span>, Annotated</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueryState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    raw_query: <span class="built_in">str</span></span><br><span class="line">    parsed_query: <span class="built_in">dict</span></span><br><span class="line">    candidate_tables: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    sql_query: <span class="built_in">str</span></span><br><span class="line">    query_results: <span class="built_in">dict</span></span><br><span class="line">    visualization_spec: <span class="built_in">dict</span></span><br><span class="line"></span><br><span class="line">workflow = StateGraph(QueryState)</span><br></pre></td></tr></table></figure>

<h3 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. </h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_query</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    parser_prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    BI</span></span><br><span class="line"><span class="string">    &#123;query&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    JSON</span></span><br><span class="line"><span class="string">    &#123;&#123;</span></span><br><span class="line"><span class="string">        &quot;intent&quot;: ,</span></span><br><span class="line"><span class="string">        &quot;metrics&quot;: [],</span></span><br><span class="line"><span class="string">        &quot;dimensions&quot;: [],</span></span><br><span class="line"><span class="string">        &quot;time_range&quot;: &#123;&#123;</span></span><br><span class="line"><span class="string">            &quot;start&quot;: &quot;YYYY-MM-DD&quot;,</span></span><br><span class="line"><span class="string">            &quot;end&quot;: &quot;YYYY-MM-DD&quot;</span></span><br><span class="line"><span class="string">        &#125;&#125;</span></span><br><span class="line"><span class="string">    &#125;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    chain = parser_prompt | ChatOpenAI(model=<span class="string">&quot;gpt-4o&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;parsed_query&quot;</span>: chain.invoke(&#123;<span class="string">&quot;query&quot;</span>: state[<span class="string">&quot;raw_query&quot;</span>]&#125;)&#125;</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> Weaviate</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_schemas</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    client = weaviate.Client(<span class="string">&quot;http://weaviate:8080&quot;</span>)</span><br><span class="line">    vectorstore = Weaviate(client, <span class="string">&quot;BizSchema&quot;</span>, <span class="string">&quot;content&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    retriever = vectorstore.as_retriever(</span><br><span class="line">        search_type=<span class="string">&quot;hybrid&quot;</span>,</span><br><span class="line">        search_kwargs=&#123;</span><br><span class="line">            <span class="string">&quot;text_weight&quot;</span>: <span class="number">0.7</span>,</span><br><span class="line">            <span class="string">&quot;vector_weight&quot;</span>: <span class="number">0.3</span>,</span><br><span class="line">            <span class="string">&quot;k&quot;</span>: <span class="number">5</span></span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># schema</span></span><br><span class="line">    domains = [<span class="string">&quot;retail&quot;</span>, <span class="string">&quot;finance&quot;</span>, <span class="string">&quot;manufacturing&quot;</span>]</span><br><span class="line">    results = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> domain <span class="keyword">in</span> domains:</span><br><span class="line">        results[domain] = retriever.invoke(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;state[<span class="string">&#x27;raw_query&#x27;</span>]&#125;</span> [DOMAIN:<span class="subst">&#123;domain&#125;</span>]&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;candidate_tables&quot;</span>: results&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">should_retry</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    last_score = state.get(<span class="string">&quot;result_score&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> last_score &lt; <span class="number">0.8</span>  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">finalize_output</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    required_fields = state[<span class="string">&quot;parsed_query&quot;</span>][<span class="string">&quot;metrics&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">all</span>(field <span class="keyword">in</span> state[<span class="string">&quot;query_results&quot;</span>] <span class="keyword">for</span> field <span class="keyword">in</span> required_fields)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">workflow.add_node(<span class="string">&quot;parse&quot;</span>, parse_query)</span><br><span class="line">workflow.add_node(<span class="string">&quot;retrieve&quot;</span>, retrieve_schemas)</span><br><span class="line">workflow.add_node(<span class="string">&quot;generate_sql&quot;</span>, generate_sql)</span><br><span class="line">workflow.add_node(<span class="string">&quot;execute_query&quot;</span>, execute_query)</span><br><span class="line">workflow.add_node(<span class="string">&quot;visualize&quot;</span>, generate_visualization)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;parse&quot;</span>, <span class="string">&quot;retrieve&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;retrieve&quot;</span>, <span class="string">&quot;generate_sql&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;generate_sql&quot;</span>, <span class="string">&quot;execute_query&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;execute_query&quot;</span>, <span class="string">&quot;visualize&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;visualize&quot;</span>,</span><br><span class="line">    should_retry,</span><br><span class="line">    &#123;<span class="string">&quot;retry&quot;</span>: <span class="string">&quot;retrieve&quot;</span>, <span class="string">&quot;end&quot;</span>: END&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;visualize&quot;</span>, finalize_output)</span><br><span class="line">workflow.set_entry_point(<span class="string">&quot;parse&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RetailWorkflow</span>(<span class="title class_ inherited__">StateGraph</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(QueryState)</span><br><span class="line">        <span class="variable language_">self</span>.add_node(<span class="string">&quot;apply_promo_rules&quot;</span>, <span class="variable language_">self</span>._apply_promo_rules)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_apply_promo_rules</span>(<span class="params">self, state: QueryState</span>):</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        promo_chain = (</span><br><span class="line">            ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &#123;&#123;query&#125;&#125;</span></span><br><span class="line"><span class="string">            &#123;&#123;results&#125;&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            - </span></span><br><span class="line"><span class="string">            - </span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>)</span><br><span class="line">            | ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">            | StrOutputParser()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;query_results&quot;</span>: promo_chain.invoke(state)&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-KPI"><a href="#2-KPI" class="headerlink" title="2. KPI"></a>2. KPI</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">manufacturing_kpis = &#123;</span><br><span class="line">    <span class="string">&quot;oee&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;formula&quot;</span>: <span class="string">&quot;(good_units * ideal_cycle_time) / (production_time * max_speed)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dependencies&quot;</span>: [<span class="string">&quot;production_facts&quot;</span>, <span class="string">&quot;machine_specs&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;throughput&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;formula&quot;</span>: <span class="string">&quot;total_units / active_hours&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vector_path&quot;</span>: <span class="string">&quot;manufacturing/kpis/throughput&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_kpi</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    <span class="comment"># KPI</span></span><br><span class="line">    kpi_def = vectorstore.similarity_search(</span><br><span class="line">        state[<span class="string">&quot;parsed_query&quot;</span>][<span class="string">&quot;metrics&quot;</span>][<span class="number">0</span>],</span><br><span class="line">        <span class="built_in">filter</span>=&#123;<span class="string">&quot;domain&quot;</span>: <span class="string">&quot;manufacturing&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;query_results&quot;</span>: eval_kpi(kpi_def, state[<span class="string">&quot;query_results&quot;</span>])&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LangGraph"><a href="#LangGraph" class="headerlink" title="LangGraph"></a>LangGraph</h2><h3 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> Graph</span><br><span class="line"></span><br><span class="line">master_graph = Graph()</span><br><span class="line"></span><br><span class="line"><span class="meta">@master_graph.node</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">route_query</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;sales&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;raw_query&quot;</span>].lower():</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;subgraph&quot;</span>: <span class="string">&quot;retail&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;machine&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;raw_query&quot;</span>].lower():</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;subgraph&quot;</span>: <span class="string">&quot;manufacturing&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@master_graph.edge(<span class="params"><span class="string">&quot;route_query&quot;</span>, <span class="keyword">lambda</span> state: state[<span class="string">&quot;subgraph&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_subgraph</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> state[<span class="string">&quot;subgraph&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">master_graph.add_subgraph(<span class="string">&quot;retail&quot;</span>, RetailWorkflow())</span><br><span class="line">master_graph.add_subgraph(<span class="string">&quot;manufacturing&quot;</span>, ManufacturingWorkflow())</span><br></pre></td></tr></table></figure>

<h3 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.checkpoint <span class="keyword">import</span> MemorySaver</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(</span><br><span class="line">    QueryState,</span><br><span class="line">    checkpoint=MemorySaver()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_state</span>(<span class="params">query_id</span>):</span><br><span class="line">    <span class="keyword">return</span> workflow.get_state(query_id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">workflow.add_node(<span class="string">&quot;savepoint&quot;</span>, <span class="keyword">lambda</span> state: state)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;generate_sql&quot;</span>, <span class="string">&quot;savepoint&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.distributed <span class="keyword">import</span> RayExecutor</span><br><span class="line"></span><br><span class="line">ray_executor = RayExecutor(</span><br><span class="line">    workflow.<span class="built_in">compile</span>(),</span><br><span class="line">    runtime_env=&#123;<span class="string">&quot;pip&quot;</span>: [<span class="string">&quot;langchain&quot;</span>, <span class="string">&quot;weaviate-client&quot;</span>]&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">future = ray_executor.submit(&#123;</span><br><span class="line">    <span class="string">&quot;raw_query&quot;</span>: <span class="string">&quot;Q3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;session_id&quot;</span>: <span class="string">&quot;user123&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">result = future.result()</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Weaviate</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BizSchema</span>(<span class="title class_ inherited__">WeaviateClass</span>):</span><br><span class="line">    class_name = <span class="string">&quot;BizSchema&quot;</span></span><br><span class="line">    vectorizer = <span class="string">&quot;multi2vec-clip&quot;</span></span><br><span class="line">    properties = [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;domain&quot;</span>, <span class="string">&quot;dataType&quot;</span>: [<span class="string">&quot;text&quot;</span>]&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;formula&quot;</span>, <span class="string">&quot;dataType&quot;</span>: [<span class="string">&quot;text&quot;</span>]&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;structural_features&quot;</span>,</span><br><span class="line">            <span class="string">&quot;dataType&quot;</span>: [<span class="string">&quot;number[]&quot;</span>],</span><br><span class="line">            <span class="string">&quot;vectorIndexConfig&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;pq&quot;</span>: &#123;<span class="string">&quot;enabled&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<h3 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.cache <span class="keyword">import</span> SQLiteCache</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(</span><br><span class="line">    QueryState,</span><br><span class="line">    checkpoint=SQLiteCache(<span class="string">&quot;whereq_cache.db&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">parallel_nodes</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    parse_task = asyncio.create_task(parse_query(state))</span><br><span class="line">    retrieve_task = asyncio.create_task(retrieve_schemas(state))</span><br><span class="line">    </span><br><span class="line">    parsed, schemas = <span class="keyword">await</span> asyncio.gather(parse_task, retrieve_task)</span><br><span class="line">    <span class="keyword">return</span> &#123;**parsed, **schemas&#125;</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong></strong><br>61811</p>
<p><strong></strong></p>
<ol>
<li><p></p>
<ul>
<li>618 vs 11</li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li><p>LangGraph</p>
<pre><code class="highlight mermaid">graph TB
    A[] --&gt; B[]
    A --&gt; C[]
    B --&gt; D[SQL]
    C --&gt; D
    D --&gt; E[]
    E --&gt; F&#123;&#125;
    F --  --&gt; B
    F --  --&gt; G[]</code></pre>
</li>
<li><p></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;visualization&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;heatmap&quot;</span>,</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;x&quot;</span>: [<span class="string">&quot;0-100&quot;</span>, <span class="string">&quot;100-300&quot;</span>, <span class="string">&quot;300&quot;</span>],</span><br><span class="line">            <span class="string">&quot;y&quot;</span>: [<span class="string">&quot;618&quot;</span>, <span class="string">&quot;11&quot;</span>],</span><br><span class="line">            <span class="string">&quot;z&quot;</span>: [[<span class="number">0.15</span>, <span class="number">0.22</span>, <span class="number">0.08</span>], [<span class="number">0.18</span>, <span class="number">0.25</span>, <span class="number">0.12</span>]]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;annotations&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: <span class="string">&quot;11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;position&quot;</span>: [<span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.extensions <span class="keyword">import</span> Plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomKpiPlugin</span>(<span class="title class_ inherited__">Plugin</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hooks = &#123;</span><br><span class="line">            <span class="string">&quot;pre_visualization&quot;</span>: <span class="variable language_">self</span>.add_kpi_trendline</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_kpi_trendline</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;trend&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;parsed_query&quot;</span>][<span class="string">&quot;intent&quot;</span>]:</span><br><span class="line">            state[<span class="string">&quot;visualization_spec&quot;</span>][<span class="string">&quot;config&quot;</span>][<span class="string">&quot;trendline&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>

<h3 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.streaming <span class="keyword">import</span> StreamingEventHandler</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WhereQHandler</span>(<span class="title class_ inherited__">StreamingEventHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_query_parsed</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="variable language_">self</span>.emit(<span class="string">&quot;parser&quot;</span>, data[<span class="string">&quot;parsed_query&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_results_ready</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="variable language_">self</span>.emit(<span class="string">&quot;data&quot;</span>, data[<span class="string">&quot;query_results&quot;</span>])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_visualization</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="variable language_">self</span>.emit(<span class="string">&quot;viz&quot;</span>, data[<span class="string">&quot;visualization_spec&quot;</span>])</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(</span><br><span class="line">    QueryState,</span><br><span class="line">    handlers=[WhereQHandler()]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>WhereQ-GPTLangGraphBI</p>
<ol>
<li><strong></strong></li>
<li><strong></strong></li>
<li><strong></strong></li>
<li><strong></strong></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/Faiss-practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/Faiss-practices/" class="post-title-link" itemprop="url">Faiss practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:34:40" itemprop="dateCreated datePublished" datetime="2025-05-05T22:34:40-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Faiss/" itemprop="url" rel="index"><span itemprop="name">Faiss</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Faiss/Vectorizer/" itemprop="url" rel="index"><span itemprop="name">Vectorizer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><pre><code class="highlight mermaid">sequenceDiagram
    participant User
    participant QueryPlatform
    participant ChatGPT
    participant FAISS
    participant RDBMS
    
    User-&gt;&gt;QueryPlatform: &quot;2024&quot;
    QueryPlatform-&gt;&gt;ChatGPT: schema
    ChatGPT-&gt;&gt;FAISS: 
    FAISS--&gt;&gt;ChatGPT: 
    ChatGPT--&gt;&gt;QueryPlatform: SQL
    QueryPlatform-&gt;&gt;RDBMS: SQL
    RDBMS--&gt;&gt;QueryPlatform: 
    QueryPlatform--&gt;&gt;User: </code></pre>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a><strong>1</strong></h4><p><code>database_schema.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tables&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sales&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;columns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ID&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sale_date&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quantity&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;columns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ID&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;varchar(255)&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;varchar(100)&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2"><a href="#2" class="headerlink" title="2"></a><strong>2</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> retry, stop_after_attempt, wait_exponential</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">client = OpenAI(api_key=<span class="string">&quot;your_api_key&quot;</span>)</span><br><span class="line">index = <span class="literal">None</span>  <span class="comment"># FAISS</span></span><br><span class="line">schema_data = []  <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchemaVectorizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.dim = <span class="number">1536</span>  <span class="comment"># text-embedding-3-small</span></span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="string">&quot;text-embedding-3-small&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>), wait=wait_exponential(<span class="params">multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_embedding</span>(<span class="params">self, text</span>):</span><br><span class="line">        response = client.embeddings.create(</span><br><span class="line">            <span class="built_in">input</span>=[text],</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response.data[<span class="number">0</span>].embedding</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_schema</span>(<span class="params">self, json_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(json_path) <span class="keyword">as</span> f:</span><br><span class="line">            data = json.load(f)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">global</span> schema_data</span><br><span class="line">        schema_data = data[<span class="string">&quot;tables&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        texts = []</span><br><span class="line">        <span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">            desc = <span class="string">f&quot;<span class="subst">&#123;table[<span class="string">&#x27;name&#x27;</span>]&#125;</span><span class="subst">&#123;table[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">            desc += <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span><span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span><span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">                           <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]])</span><br><span class="line">            texts.append(desc)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        embeddings = [<span class="variable language_">self</span>.get_embedding(text) <span class="keyword">for</span> text <span class="keyword">in</span> texts]</span><br><span class="line">        embeddings = np.array(embeddings).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FAISS</span></span><br><span class="line">        <span class="keyword">global</span> index</span><br><span class="line">        index = faiss.IndexFlatL2(<span class="variable language_">self</span>.dim)</span><br><span class="line">        index.add(embeddings)</span><br><span class="line">        faiss.write_index(index, <span class="string">&quot;schema_index.faiss&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">vectorizer = SchemaVectorizer()</span><br><span class="line">vectorizer.load_schema(<span class="string">&quot;database_schema.json&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3"><a href="#3" class="headerlink" title="3"></a><strong>3</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QueryProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.system_prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        ```json</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;tables&quot;: [&quot;1&quot;, &quot;2&quot;],</span></span><br><span class="line"><span class="string">          &quot;reason&quot;: &quot;&quot;,</span></span><br><span class="line"><span class="string">          &quot;query_hint&quot;: &quot;SQL&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ```&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_relevant_tables</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        query_embedding = vectorizer.get_embedding(query)</span><br><span class="line">        query_embedding = np.array([query_embedding]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FAISS</span></span><br><span class="line">        k = <span class="number">3</span>  <span class="comment"># top3</span></span><br><span class="line">        distances, indices = index.search(query_embedding, k)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> indices[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">if</span> idx &gt;= <span class="number">0</span>:  <span class="comment"># </span></span><br><span class="line">                results.append(schema_data[idx])</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_sql_advice</span>(<span class="params">self, query, tables</span>):</span><br><span class="line">        <span class="comment"># ChatGPT</span></span><br><span class="line">        tables_str = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;## <span class="subst">&#123;t[<span class="string">&#x27;name&#x27;</span>]&#125;</span>\n- <span class="subst">&#123;t[<span class="string">&#x27;description&#x27;</span>]&#125;</span>\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;  - <span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>: <span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">                                       <span class="keyword">for</span> col <span class="keyword">in</span> t[<span class="string">&quot;columns&quot;</span>]]) </span><br><span class="line">                        <span class="keyword">for</span> t <span class="keyword">in</span> tables])</span><br><span class="line">        </span><br><span class="line">        user_prompt = <span class="string">f&quot;&quot;&quot;<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        <span class="subst">&#123;tables_str&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        1. </span></span><br><span class="line"><span class="string">        2. </span></span><br><span class="line"><span class="string">        3. &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = client.chat.completions.create(</span><br><span class="line">            model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="variable language_">self</span>.system_prompt&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_prompt&#125;</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.3</span>,</span><br><span class="line">            response_format=&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;json_object&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> json.loads(response.choices[<span class="number">0</span>].message.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">processor = QueryProcessor()</span><br><span class="line">user_query = <span class="string">&quot;2024&quot;</span></span><br><span class="line">relevant_tables = processor.retrieve_relevant_tables(user_query)</span><br><span class="line">advice = processor.generate_sql_advice(user_query, relevant_tables)</span><br><span class="line"><span class="built_in">print</span>(advice)</span><br></pre></td></tr></table></figure>

<h4 id="4"><a href="#4" class="headerlink" title="4"></a><strong>4</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLExecutor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db_url</span>):</span><br><span class="line">        <span class="variable language_">self</span>.engine = create_engine(db_url)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">            result = conn.execute(sqlalchemy.text(sql))</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">dict</span>(row) <span class="keyword">for</span> row <span class="keyword">in</span> result.mappings()]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_final_query</span>(<span class="params">advice</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;SQL&quot;&quot;&quot;</span></span><br><span class="line">    tables = advice[<span class="string">&quot;tables&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tables) == <span class="number">1</span>:</span><br><span class="line">        from_clause = tables[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        from_clause = <span class="string">&quot; JOIN &quot;</span>.join(tables)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    SELECT * </span></span><br><span class="line"><span class="string">    FROM <span class="subst">&#123;from_clause&#125;</span></span></span><br><span class="line"><span class="string">    WHERE 1=1</span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&#x27;AND category = &quot;&quot;&#x27;</span> <span class="keyword">if</span> <span class="string">&#x27;products&#x27;</span> <span class="keyword">in</span> tables <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&#x27;AND sale_date BETWEEN &quot;2024-07-01&quot; AND &quot;2024-09-30&quot;&#x27;</span> <span class="keyword">if</span> <span class="string">&#x27;sales&#x27;</span> <span class="keyword">in</span> tables <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">db_url = <span class="string">&quot;postgresql://user:pass@localhost:5432/mydb&quot;</span></span><br><span class="line">executor = SQLExecutor(db_url)</span><br><span class="line"></span><br><span class="line">final_sql = build_final_query(advice)</span><br><span class="line">results = executor.execute(final_sql)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">from</span> tabulate <span class="keyword">import</span> tabulate</span><br><span class="line"><span class="built_in">print</span>(tabulate(results, headers=<span class="string">&quot;keys&quot;</span>, tablefmt=<span class="string">&quot;grid&quot;</span>))</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IVFFlat</span></span><br><span class="line">quantizer = faiss.IndexFlatL2(<span class="number">1536</span>)</span><br><span class="line">index = faiss.IndexIVFFlat(quantizer, <span class="number">1536</span>, <span class="number">100</span>)  <span class="comment"># 100</span></span><br><span class="line">index.train(embeddings)  <span class="comment"># add</span></span><br><span class="line">index.add(embeddings)</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(<span class="params">maxsize=<span class="number">1000</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_embedding_cached</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">return</span> vectorizer.get_embedding(text)</span><br></pre></td></tr></table></figure>

<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">validate_sql</span>(<span class="params">sql</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;SQL&quot;&quot;&quot;</span></span><br><span class="line">    forbidden = [<span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;;--&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(cmd <span class="keyword">in</span> sql.upper() <span class="keyword">for</span> cmd <span class="keyword">in</span> forbidden):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;SQL&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> Retrying, stop_after_attempt, wait_exponential</span><br><span class="line"></span><br><span class="line">retryer = Retrying(</span><br><span class="line">    stop=stop_after_attempt(<span class="number">3</span>),</span><br><span class="line">    wait=wait_exponential(multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span>),</span><br><span class="line">    reraise=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    retryer(<span class="keyword">lambda</span>: executor.execute(final_sql))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_result_sanity</span>(<span class="params">results</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt; <span class="number">1000</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;1000&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> results:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. </span></span><br><span class="line">vectorizer = SchemaVectorizer()</span><br><span class="line">vectorizer.load_schema(<span class="string">&quot;database_schema.json&quot;</span>)</span><br><span class="line">processor = QueryProcessor()</span><br><span class="line">executor = SQLExecutor(<span class="string">&quot;postgresql://user:pass@localhost:5432/mydb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. </span></span><br><span class="line">user_query = <span class="built_in">input</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">relevant_tables = processor.retrieve_relevant_tables(user_query)</span><br><span class="line">advice = processor.generate_sql_advice(user_query, relevant_tables)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. SQL</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    final_sql = build_final_query(advice)</span><br><span class="line">    validate_sql(final_sql)</span><br><span class="line">    results = executor.execute(final_sql)</span><br><span class="line">    check_result_sanity(results)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nSQL:\n<span class="subst">&#123;final_sql&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(tabulate(results[:<span class="number">10</span>], headers=<span class="string">&quot;keys&quot;</span>, tablefmt=<span class="string">&quot;grid&quot;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><table>
<thead>
<tr>
<th></th>
<th>1,000</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>42s</td>
<td>IVFPQ</td>
</tr>
<tr>
<td></td>
<td>120ms</td>
<td>GPU</td>
</tr>
<tr>
<td>ChatGPT</td>
<td>1.2s</td>
<td>+</td>
</tr>
<tr>
<td></td>
<td>2.8s</td>
<td>SQL</td>
</tr>
</tbody></table>
<h3 id="retrieve-relevant-tables-"><a href="#retrieve-relevant-tables-" class="headerlink" title="retrieve_relevant_tables "></a><code>retrieve_relevant_tables</code> </h3><h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><pre><code class="highlight mermaid">graph TD
    A[] --&gt; B[]
    B --&gt; C[FAISS]
    C --&gt; D[Top-K]
    D --&gt; E[]</code></pre>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a><strong>1. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>), wait=wait_exponential(<span class="params">multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_embedding</span>(<span class="params">self, text</span>):</span><br><span class="line">    response = client.embeddings.create(</span><br><span class="line">        <span class="built_in">input</span>=[text],</span><br><span class="line">        model=<span class="string">&quot;text-embedding-3-small&quot;</span>  <span class="comment"># 1536</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> response.data[<span class="number">0</span>].embedding</span><br></pre></td></tr></table></figure>
<ul>
<li><strong></strong><code>text-embedding-3-small</code>&lt;100 tokens</li>
<li><strong></strong>1536<code>dimensions=512</code></li>
<li><strong></strong>OpenAI API</li>
</ul>
<h4 id="2-FAISS"><a href="#2-FAISS" class="headerlink" title="2. FAISS"></a><strong>2. FAISS</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query_embedding = np.array([query_embedding]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">distances, indices = index.search(query_embedding, k=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong></strong>L2<code>IndexFlatL2</code></li>
<li><strong></strong><ul>
<li>&gt;1<code>IndexIVFFlat</code></li>
<li><code>nprobe=10</code></li>
</ul>
</li>
</ul>
<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a><strong>3. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">results = []</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> indices[<span class="number">0</span>]:</span><br><span class="line">    <span class="keyword">if</span> idx &gt;= <span class="number">0</span>:  <span class="comment"># </span></span><br><span class="line">        results.append(&#123;</span><br><span class="line">            <span class="string">&quot;table&quot;</span>: schema_data[idx],</span><br><span class="line">            <span class="string">&quot;score&quot;</span>: <span class="number">1</span>/(<span class="number">1</span> + distances[<span class="number">0</span>][idx])  <span class="comment"># </span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">results.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong></strong>L2[0,1]</li>
<li><strong></strong><code>idx=-1</code>k&gt;</li>
</ul>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1--vs-"><a href="#1--vs-" class="headerlink" title="1.  vs "></a><strong>1.  vs </strong></h4><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong></strong></td>
<td><br>)</td>
<td></td>
</tr>
<tr>
<td><strong></strong></td>
<td></td>
<td>&#x2F;</td>
</tr>
</tbody></table>
<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a><strong>2. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load_schema</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_table_description</span>(<span class="params">table</span>):</span><br><span class="line">    desc = <span class="string">f&quot;<span class="subst">&#123;table[<span class="string">&#x27;name&#x27;</span>]&#125;</span><span class="subst">&#123;table[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]:</span><br><span class="line">        desc += <span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span><span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span><span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="keyword">if</span> table[<span class="string">&quot;name&quot;</span>] == <span class="string">&quot;sales&quot;</span>:</span><br><span class="line">        desc += <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> desc</span><br></pre></td></tr></table></figure>
<p><strong></strong></p>
<ul>
<li><code>&quot;sales&quot;</code></li>
<li><code>&quot;salesidintIDproduct_idintproducts... &quot;</code></li>
</ul>
<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a><strong>3. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hybrid_retrieve</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    vector_results = retrieve_relevant_tables(query)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    keyword_results = []</span><br><span class="line">    <span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">        <span class="keyword">if</span> query.lower() <span class="keyword">in</span> table[<span class="string">&quot;description&quot;</span>].lower():</span><br><span class="line">            keyword_results.append(table)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    all_results = vector_results + [</span><br><span class="line">        &#123;<span class="string">&quot;table&quot;</span>: t, <span class="string">&quot;score&quot;</span>: <span class="number">0.7</span>&#125; <span class="keyword">for</span> t <span class="keyword">in</span> keyword_results </span><br><span class="line">        <span class="keyword">if</span> t[<span class="string">&quot;name&quot;</span>] <span class="keyword">not</span> <span class="keyword">in</span> [v[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;name&quot;</span>] <span class="keyword">for</span> v <span class="keyword">in</span> vector_results]</span><br><span class="line">    <span class="keyword">return</span> all_results</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a><strong>1. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load_schema</span></span><br><span class="line">embeddings = []</span><br><span class="line">metadata = []</span><br><span class="line"><span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">    desc = generate_table_description(table)</span><br><span class="line">    emb = get_embedding(desc)</span><br><span class="line">    embeddings.append(emb)</span><br><span class="line">    metadata.append(&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: table[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">        <span class="string">&quot;columns&quot;</span>: [col[<span class="string">&quot;name&quot;</span>] <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># FAISS</span></span><br><span class="line">index = faiss.IndexIDMap(faiss.IndexFlatL2(<span class="number">1536</span>))</span><br><span class="line">index.add_with_ids(np.array(embeddings), np.arange(<span class="built_in">len</span>(metadata)))</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a><strong>2. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">apply_business_rules</span>(<span class="params">results, query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> res <span class="keyword">in</span> results:</span><br><span class="line">        table_name = res[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        <span class="comment"># GL</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;&quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> table_name.startswith(<span class="string">&quot;gl_&quot;</span>):</span><br><span class="line">            res[<span class="string">&quot;score&quot;</span>] *= <span class="number">1.5</span></span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;&quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="built_in">any</span>(col[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;date&quot;</span> </span><br><span class="line">                               <span class="keyword">for</span> col <span class="keyword">in</span> res[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;columns&quot;</span>]):</span><br><span class="line">            res[<span class="string">&quot;score&quot;</span>] *= <span class="number">1.3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a><strong>3. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_search</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        start = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        latency = (time.time() - start) * <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Prometheus</span></span><br><span class="line">        metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;latency_ms&#x27;</span>: latency,</span><br><span class="line">            <span class="string">&#x27;result_count&#x27;</span>: <span class="built_in">len</span>(result),</span><br><span class="line">            <span class="string">&#x27;avg_score&#x27;</span>: <span class="built_in">sum</span>(r[<span class="string">&quot;score&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> result)/<span class="built_in">len</span>(result) <span class="keyword">if</span> result <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        logging.info(<span class="string">f&quot;Search metrics: <span class="subst">&#123;metrics&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@monitor_search</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_relevant_tables</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="comment"># ......</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><p><strong></strong><code>&quot;&quot;</code></p>
<p><strong></strong></p>
<ol>
<li>1536</li>
<li>FAISS<ul>
<li><code>sales</code>0.92</li>
<li><code>products</code>0.88</li>
<li><code>stores</code>0.75</li>
</ul>
</li>
<li><ul>
<li><code>stores</code>0.75  0.9</li>
</ul>
</li>
<li><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> sales<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.92</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> products<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.88</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> stores<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.9</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a><strong>1. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_schema</span>(<span class="params">new_table</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">    desc = generate_table_description(new_table)</span><br><span class="line">    emb = get_embedding(desc)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">global</span> index</span><br><span class="line">    new_id = index.ntotal  <span class="comment"># ID</span></span><br><span class="line">    index.add_with_ids(np.array([emb]), np.array([new_id]))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    schema_data.append(new_table)</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a><strong>2. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">filter_low_quality</span>(<span class="params">results, threshold=<span class="number">0.6</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">    filtered = [r <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> r[<span class="string">&quot;score&quot;</span>] &gt;= threshold]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filtered:</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        logging.warning(<span class="string">f&quot;All scores below threshold: <span class="subst">&#123;[r[<span class="string">&#x27;score&#x27;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    <span class="keyword">return</span> filtered</span><br></pre></td></tr></table></figure>

<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a><strong>3. </strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_join_path</span>(<span class="params">tables</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">    join_paths = []</span><br><span class="line">    <span class="keyword">for</span> i, t1 <span class="keyword">in</span> <span class="built_in">enumerate</span>(tables):</span><br><span class="line">        <span class="keyword">for</span> t2 <span class="keyword">in</span> tables[i+<span class="number">1</span>:]:</span><br><span class="line">            <span class="comment"># </span></span><br><span class="line">            <span class="keyword">for</span> col <span class="keyword">in</span> t1[<span class="string">&quot;columns&quot;</span>]:</span><br><span class="line">                <span class="keyword">if</span> col[<span class="string">&quot;name&quot;</span>].endswith(<span class="string">&quot;_id&quot;</span>) <span class="keyword">and</span> col[<span class="string">&quot;name&quot;</span>][:-<span class="number">3</span>] == t2[<span class="string">&quot;name&quot;</span>]:</span><br><span class="line">                    join_paths.append(<span class="string">f&quot;<span class="subst">&#123;t1[<span class="string">&#x27;name&#x27;</span>]&#125;</span>.<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span> = <span class="subst">&#123;t2[<span class="string">&#x27;name&#x27;</span>]&#125;</span>.id&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> join_paths</span><br></pre></td></tr></table></figure>

<hr>
<p>32%89%</p>
<ol>
<li><strong></strong></li>
<li><strong></strong>++</li>
<li><strong></strong></li>
</ol>
<h2 id="-"><a href="#-" class="headerlink" title=" "></a> </h2><p>     FAISS  schema   schema  GPT  GPT  SQL</p>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 3: </span></span><br><span class="line">query_embedding = openai.Embedding.create(</span><br><span class="line">    <span class="built_in">input</span>=[user_prompt],</span><br><span class="line">    model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">)[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;embedding&#x27;</span>]</span><br><span class="line"></span><br><span class="line">query_vector = np.array(query_embedding).astype(<span class="string">&quot;float32&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  schema  top-k </span></span><br><span class="line">D, I = index.search(np.array([query_vector]), k=<span class="number">3</span>)</span><br><span class="line">matched_schema = [schema_texts[i] <span class="keyword">for</span> i <span class="keyword">in</span> I[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment">#  GPT </span></span><br><span class="line">system_msg = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">context_msg = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;schema&#125;</span>&quot;</span> <span class="keyword">for</span> i, schema <span class="keyword">in</span> <span class="built_in">enumerate</span>(matched_schema)])</span><br><span class="line"></span><br><span class="line">user_msg = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;user_prompt&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;context_msg&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> SQL </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">chat_response = openai.ChatCompletion.create(</span><br><span class="line">    model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_msg&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_msg&#125;</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ChatGPT Response:\n&quot;</span>, chat_response[<span class="string">&#x27;choices&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>])</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="-"><a href="#-" class="headerlink" title=" "></a> </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query_embedding = openai.Embedding.create(</span><br><span class="line">    <span class="built_in">input</span>=[user_prompt],  <span class="comment"># 2024</span></span><br><span class="line">    model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">)[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;embedding&#x27;</span>]</span><br><span class="line"></span><br><span class="line">query_vector = np.array(query_embedding).astype(<span class="string">&quot;float32&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li> OpenAI  <code>text-embedding-3-large</code>  1536 </li>
<li> <strong> schema </strong></li>
</ul>
<hr>
<h3 id="--schema-"><a href="#--schema-" class="headerlink" title="  schema "></a>  schema </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D, I = index.search(np.array([query_vector]), k=<span class="number">3</span>)</span><br><span class="line">matched_schema = [schema_texts[i] <span class="keyword">for</span> i <span class="keyword">in</span> I[<span class="number">0</span>]]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>index.search</code>  FAISS  <code>k=3</code> </li>
<li><code>matched_schema</code>  <strong>schema </strong></li>
</ul>
<p></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. Table: lego_sales | Columns: id, product_name, year, quarter, region, revenue</span><br><span class="line">2. Table: toys_category | Columns: id, product_name, category</span><br><span class="line">3. Table: quarterly_sales_summary | Columns: product_id, quarter, year, total_sales</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="--context-msg"><a href="#--context-msg" class="headerlink" title="  context_msg"></a>  <code>context_msg</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context_msg = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;schema&#125;</span>&quot;</span> <span class="keyword">for</span> i, schema <span class="keyword">in</span> <span class="built_in">enumerate</span>(matched_schema)])</span><br></pre></td></tr></table></figure>

<p><strong> schema  GPT </strong></p>
<p></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. Table: lego_sales | Columns: id, product_name, year, quarter, region, revenue</span><br><span class="line">2. Table: toys_category | Columns: id, product_name, category</span><br><span class="line">3. Table: quarterly_sales_summary | Columns: product_id, quarter, year, total_sales</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="--GPT"><a href="#--GPT" class="headerlink" title="  GPT"></a>  GPT</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user_msg = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;user_prompt&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;context_msg&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> SQL </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li> GPT  schema</li>
<li> GPT </li>
<li> GPT  SQL</li>
</ul>
<hr>
<h3 id="-GPT--SQL"><a href="#-GPT--SQL" class="headerlink" title=" GPT  SQL"></a> GPT  SQL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chat_response = openai.ChatCompletion.create(</span><br><span class="line">    model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_msg&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_msg&#125;</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p></p>
<ul>
<li></li>
<li></li>
</ul>
</li>
<li><p> + SQL </p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/Core-Technology-Stack-for-Document-Processing-and-Vectorization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/Core-Technology-Stack-for-Document-Processing-and-Vectorization/" class="post-title-link" itemprop="url">Core Technology Stack for Document Processing and Vectorization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:17:07" itemprop="dateCreated datePublished" datetime="2025-05-05T22:17:07-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/The-tech-stack-of-RAG-application-with-Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/The-tech-stack-of-RAG-application-with-Python/" class="post-title-link" itemprop="url">The tech stack of RAG application with Python</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:06:52" itemprop="dateCreated datePublished" datetime="2025-05-05T22:06:52-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OpenAI/" itemprop="url" rel="index"><span itemprop="name">OpenAI</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OpenAI/RAG/" itemprop="url" rel="index"><span itemprop="name">RAG</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="RAG"><a href="#RAG" class="headerlink" title="RAG"></a><strong>RAG</strong></h3><pre><code class="highlight mermaid">graph TD
    A[] --&gt; B[]
    B --&gt; C[]
    C --&gt; D[]
    D --&gt; E[]
    E --&gt; F[]</code></pre>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Embedding</strong></td>
<td>OpenAI text-embedding-3-large</td>
<td>Cohere Embed &#x2F; BGE-M3</td>
</tr>
<tr>
<td><strong>LLM</strong></td>
<td>OpenAI GPT-4-turbo</td>
<td>Anthropic Claude &#x2F; Llama3</td>
</tr>
<tr>
<td><strong></strong></td>
<td>FAISS () &#x2F; Pinecone ()</td>
<td>Weaviate &#x2F; Milvus</td>
</tr>
<tr>
<td><strong></strong></td>
<td>Unstructured.io</td>
<td>Haystack &#x2F; LlamaIndex</td>
</tr>
</tbody></table>
<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><ul>
<li><strong></strong>Redis ()</li>
<li><strong></strong>LangSmith (LLM)</li>
<li><strong></strong>FastAPI + Docker + AWS Lambda</li>
</ul>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install openai faiss-cpu python-dotx unstructured redis fastapi</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unstructured.partition.auto <span class="keyword">import</span> partition</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">client = OpenAI(api_key=<span class="string">&quot;your_key&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_documents</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    elements = partition(filename=file_path)</span><br><span class="line">    chunks = [<span class="built_in">str</span>(el) <span class="keyword">for</span> el <span class="keyword">in</span> elements <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>(el)) &gt; <span class="number">50</span>]  <span class="comment"># </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    embeddings = client.embeddings.create(</span><br><span class="line">        <span class="built_in">input</span>=chunks,</span><br><span class="line">        model=<span class="string">&quot;text-embedding-3-large&quot;</span>,</span><br><span class="line">        dimensions=<span class="number">256</span>  <span class="comment"># </span></span><br><span class="line">    ).data</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># numpy</span></span><br><span class="line">    vectors = np.array([emb.embedding <span class="keyword">for</span> emb <span class="keyword">in</span> embeddings])</span><br><span class="line">    <span class="keyword">return</span> chunks, vectors</span><br></pre></td></tr></table></figure>

<h4 id="3-FAISS"><a href="#3-FAISS" class="headerlink" title="3. FAISS"></a>3. <strong>FAISS</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_faiss_index</span>(<span class="params">vectors</span>):</span><br><span class="line">    d = vectors.shape[<span class="number">1</span>]  <span class="comment"># </span></span><br><span class="line">    index = faiss.IndexHNSWFlat(d, <span class="number">32</span>)  <span class="comment"># 32HNSW</span></span><br><span class="line">    index.add(vectors)</span><br><span class="line">    <span class="keyword">return</span> index</span><br><span class="line"></span><br><span class="line"><span class="comment"># /</span></span><br><span class="line">faiss.write_index(index, <span class="string">&quot;rag_index.faiss&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-"><a href="#4-" class="headerlink" title="4. "></a>4. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RAGSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, index_path, chunks</span>):</span><br><span class="line">        <span class="variable language_">self</span>.index = faiss.read_index(index_path)</span><br><span class="line">        <span class="variable language_">self</span>.chunks = chunks</span><br><span class="line">        <span class="variable language_">self</span>.llm_model = <span class="string">&quot;gpt-4-turbo&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">self, query: <span class="built_in">str</span>, k: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        query_embed = client.embeddings.create(</span><br><span class="line">            <span class="built_in">input</span>=[query],</span><br><span class="line">            model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">        ).data[<span class="number">0</span>].embedding</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        _, indices = <span class="variable language_">self</span>.index.search(np.array([query_embed]), k)</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>.chunks[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices[<span class="number">0</span>] <span class="keyword">if</span> i != -<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, query: <span class="built_in">str</span>, context: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(context)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        <span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = client.chat.completions.create(</span><br><span class="line">            model=<span class="variable language_">self</span>.llm_model,</span><br><span class="line">            messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;],</span><br><span class="line">            temperature=<span class="number">0.3</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response.choices[<span class="number">0</span>].message.content</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">rag = RAGSystem(<span class="string">&quot;rag_index.faiss&quot;</span>, chunks)</span><br><span class="line">context = rag.retrieve(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">answer = rag.generate(<span class="string">&quot;?&quot;</span>, context)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong></strong></td>
<td>IVFFlatFlatL2</td>
</tr>
<tr>
<td><strong></strong></td>
<td>SPLADE</td>
</tr>
<tr>
<td><strong></strong></td>
<td>Redisembedding</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_query</span>(<span class="params">query</span>):</span><br><span class="line">    expansion_prompt = <span class="string">f&quot;<span class="subst">&#123;query&#125;</span>&quot;</span></span><br><span class="line">    expansions = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">        messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: expansion_prompt&#125;],</span><br><span class="line">        temperature=<span class="number">0.7</span>,</span><br><span class="line">        max_tokens=<span class="number">50</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> query + <span class="string">&quot; &quot;</span> + expansions.choices[<span class="number">0</span>].message.content</span><br></pre></td></tr></table></figure>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong></strong></td>
<td>CoT (Chain-of-Thought) </td>
</tr>
<tr>
<td><strong></strong></td>
<td>FactScore</td>
</tr>
<tr>
<td><strong></strong></td>
<td>OpenAIstream&#x3D;True</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verified_generate</span>(<span class="params">query, context</span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&quot;&quot;</span>.join(context)&#125;</span></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    1. </span></span><br><span class="line"><span class="string">    2. </span></span><br><span class="line"><span class="string">    3. </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ......</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    verification = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;answer&#125;</span>\n<span class="subst">&#123;context&#125;</span>&quot;</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;&quot;</span> <span class="keyword">in</span> verification.choices[<span class="number">0</span>].message.content:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> answer</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><pre><code class="highlight mermaid">graph LR
    A[] --&gt; B[API Gateway]
    B --&gt; C[]
    C --&gt; D[FastAPI1]
    C --&gt; E[FastAPI2]
    D --&gt; F[Redis]
    E --&gt; F
    F --&gt; G[FAISS]
    G --&gt; H[OpenAI API]</code></pre>

<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FastAPI</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Query</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    text: <span class="built_in">str</span></span><br><span class="line">    top_k: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_query</span>(<span class="params">query: Query</span>):</span><br><span class="line">    context = rag.retrieve(query.text, query.top_k)</span><br><span class="line">    answer = rag.generate(query.text, context)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;answer&quot;</span>: answer, <span class="string">&quot;sources&quot;</span>: context&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># uvicorn main:app --workers 4 --host 0.0.0.0 --port 8000</span></span><br></pre></td></tr></table></figure>

<h4 id="3-"><a href="#3-" class="headerlink" title="3. "></a>3. <strong></strong></h4><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Prometheus + Grafana</td>
<td>&gt;500ms</td>
</tr>
<tr>
<td>LLM</td>
<td>LangSmith webhook</td>
<td>&gt;5%&#x2F;</td>
</tr>
<tr>
<td></td>
<td>Redis INFO</td>
<td>&lt;70%</td>
</tr>
</tbody></table>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><ul>
<li><strong></strong>AWS KMSFAISS</li>
<li><strong></strong>PII<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> presidio_analyzer <span class="keyword">import</span> AnalyzerEngine</span><br><span class="line"></span><br><span class="line">analyzer = AnalyzerEngine()</span><br><span class="line">results = analyzer.analyze(text=chunk, language=<span class="string">&quot;zh&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">    chunk = chunk.replace(chunk[result.start:result.end], <span class="string">&quot;[REDACTED]&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-API"><a href="#2-API" class="headerlink" title="2. API"></a>2. <strong>API</strong></h4><ul>
<li><strong></strong>FastAPI<code>slowapi</code></li>
<li><strong></strong>JWT<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer</span><br><span class="line"></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/secure_query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">secure_query</span>(<span class="params">query: Query, token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-OpenAI-API"><a href="#1-OpenAI-API" class="headerlink" title="1. OpenAI API"></a>1. <strong>OpenAI API</strong></h4><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong></strong></td>
<td>50%</td>
<td>GPT-3.5GPT-4</td>
</tr>
<tr>
<td><strong></strong></td>
<td>30%</td>
<td>Redis&lt;query,answer&gt;TTL&#x3D;24</td>
</tr>
<tr>
<td><strong></strong></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FAISS</span></span><br><span class="line">index = faiss.IndexIVFPQ(</span><br><span class="line">    faiss.IndexFlatL2(d),</span><br><span class="line">    d,</span><br><span class="line">    nlist=<span class="number">100</span>,</span><br><span class="line">    m=<span class="number">8</span>,</span><br><span class="line">    bits=<span class="number">8</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><h4 id="1-"><a href="#1-" class="headerlink" title="1. "></a>1. <strong></strong></h4><ul>
<li><strong></strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mark_important</span>(<span class="params">chunk</span>):</span><br><span class="line">    importance = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">        messages=[&#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, </span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;(1-5):\n&quot;</span> + chunk</span><br><span class="line">        &#125;]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;[:<span class="subst">&#123;importance&#125;</span>] <span class="subst">&#123;chunk&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-"><a href="#2-" class="headerlink" title="2. "></a>2. <strong></strong></h4><ul>
<li><strong></strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">newest_date = <span class="built_in">max</span>(doc.dates <span class="keyword">for</span> doc <span class="keyword">in</span> docs)</span><br><span class="line"><span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs:</span><br><span class="line">    doc.score *= (<span class="number">0.5</span> + <span class="number">0.5</span>*(doc.date - oldest_date)/(newest_date - oldest_date))</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id=""><a href="#" class="headerlink" title=""></a><strong></strong></h3><ol>
<li><strong>1</strong><ul>
<li>RAG</li>
<li></li>
</ul>
</li>
<li><strong>3</strong><ul>
<li>BAAI&#x2F;bge-reranker</li>
<li>+</li>
</ul>
</li>
<li><strong>6+</strong><ul>
<li>embedding</li>
<li>RAGAS</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/28/A-sample-ABI-of-CCBusERC20-contract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/28/A-sample-ABI-of-CCBusERC20-contract/" class="post-title-link" itemprop="url">A sample ABI of CCBusERC20 contract</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-28 17:55:15" itemprop="dateCreated datePublished" datetime="2025-04-28T17:55:15-04:00">2025-04-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>For the ABI of <code>CCBusERC20</code>, you should include <strong>all public and external methods</strong> that you want to be accessible from outside the contract. This includes:</p>
<ol>
<li><strong>All methods from IERC20 interface</strong> (required for ERC20 compliance)</li>
<li><strong>Any additional public methods</strong> specific to your contract</li>
<li><strong>Events</strong> that you want to be queryable</li>
<li><strong>Constructor</strong> (only needed for deployment)</li>
</ol>
<p>Heres what should be included based on your contract:</p>
<h3 id="Required-Methods-from-IERC20"><a href="#Required-Methods-from-IERC20" class="headerlink" title="Required Methods (from IERC20):"></a>Required Methods (from IERC20):</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;function decimals() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function symbol() view returns (string)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function name() view returns (string)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function totalSupply() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function balanceOf(address) view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function transfer(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function allowance(address, address) view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function approve(address, uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function transferFrom(address, address, uint256)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Additional-Public-Methods-from-CCBusERC20"><a href="#Additional-Public-Methods-from-CCBusERC20" class="headerlink" title="Additional Public Methods (from CCBusERC20):"></a>Additional Public Methods (from CCBusERC20):</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;function deadAddress() view returns (address)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function decreaseAllowance(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function getCirculatingSupply() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function increaseAllowance(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function owner() view returns (address)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Events"><a href="#Events" class="headerlink" title="Events:"></a>Events:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span>,</span><br><span class="line"><span class="string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Constructor"><a href="#Constructor" class="headerlink" title="Constructor:"></a>Constructor:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;constructor(string[] stringParams, address[] addressParams, uint256[] numberParams, bool[] boolParams)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Your-current-ABI-is-correct-and-complete"><a href="#Your-current-ABI-is-correct-and-complete" class="headerlink" title="Your current ABI is correct and complete:"></a>Your current ABI is correct and complete:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> abiCCBusERC20 = [</span><br><span class="line">  <span class="string">&quot;constructor(string[] stringParams, address[] addressParams, uint256[] numberParams, bool[] boolParams)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function allowance(address owner, address spender) view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function approve(address spender, uint256 amount)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function balanceOf(address account) view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function deadAddress() view returns (address)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function decimals() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function decreaseAllowance(address spender, uint256 subtractedValue) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function getCirculatingSupply() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function increaseAllowance(address spender, uint256 addedValue) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function name() view returns (string)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function owner() view returns (address)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function symbol() view returns (string)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function totalSupply() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function transfer(address recipient, uint256 amount) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function transferFrom(address sender, address recipient, uint256 amount)&quot;</span></span><br><span class="line">] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br></pre></td></tr></table></figure>

<h3 id="What-to-exclude"><a href="#What-to-exclude" class="headerlink" title="What to exclude:"></a>What to exclude:</h3><ul>
<li>Internal&#x2F;private methods (<code>_approve</code>, <code>_transfer</code>, <code>_basicTransfer</code>, <code>_msgSender</code>, <code>_msgData</code>)</li>
<li>Library functions (SafeMath, Address)</li>
<li>The <code>receive()</code> function (special fallback function doesnt need ABI entry)</li>
</ul>
<h3 id="CCBusERC20-sol"><a href="#CCBusERC20-sol" class="headerlink" title="CCBusERC20.sol"></a>CCBusERC20.sol</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Created By: CC-Bus</span></span><br><span class="line"><span class="comment">//  Website: https://ccbus.cc</span></span><br><span class="line"><span class="comment">//  Telegram: https://t.me/CCBus</span></span><br><span class="line"><span class="comment">//  The Best Tool for Token Management</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Context</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_msgSender</span>(<span class="params"></span>) internal view <span class="title function_">returns</span> (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">payable</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_msgData</span>(<span class="params"></span>) internal view <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="variable language_">this</span>; <span class="comment">// silence state mutability warning without generating bytecode - see https://github.com/ethereum/solidity/issues/2691</span></span><br><span class="line">        <span class="keyword">return</span> msg.<span class="property">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library <span class="title class_">SafeMath</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        uint256 c = a + b;</span><br><span class="line">        <span class="built_in">require</span>(c &gt;= a, <span class="string">&quot;SafeMath: addition overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">sub</span>(a, b, <span class="string">&quot;SafeMath: subtraction overflow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b &lt;= a, errorMessage);</span><br><span class="line">        uint256 c = a - b;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mul</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 c = a * b;</span><br><span class="line">        <span class="built_in">require</span>(c / a == b, <span class="string">&quot;SafeMath: multiplication overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">div</span>(a, b, <span class="string">&quot;SafeMath: division by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b &gt; <span class="number">0</span>, errorMessage);</span><br><span class="line">        uint256 c = a / b;</span><br><span class="line">        <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mod</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mod</span>(a, b, <span class="string">&quot;SafeMath: modulo by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mod</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b != <span class="number">0</span>, errorMessage);</span><br><span class="line">        <span class="keyword">return</span> a % b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">library <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">isContract</span>(<span class="params">address account</span>) internal view <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line"></span><br><span class="line">        bytes32 codehash;</span><br><span class="line">        bytes32 accountHash = <span class="number">0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470</span>;</span><br><span class="line"></span><br><span class="line">        assembly &#123;</span><br><span class="line">            codehash := <span class="title function_">extcodehash</span>(account)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (codehash != accountHash &amp;&amp; codehash != <span class="number">0x0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sendValue</span>(<span class="params">address payable recipient, uint256 amount</span>) internal &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= amount,</span><br><span class="line">            <span class="string">&quot;Address: insufficient balance&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// solhint-disable-next-line avoid-low-level-calls, avoid-call-value</span></span><br><span class="line">        (bool success, ) = recipient.<span class="property">call</span>&#123;<span class="attr">value</span>: amount&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            success,</span><br><span class="line">            <span class="string">&quot;Address: unable to send value, recipient may have reverted&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCall</span>(<span class="params">address target, bytes memory data</span>)</span><br><span class="line">        internal</span><br><span class="line">        <span class="title function_">returns</span> (bytes memory)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">functionCall</span>(target, data, <span class="string">&quot;Address: low-level call failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCall</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_functionCallWithValue</span>(target, data, <span class="number">0</span>, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 value</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">            <span class="title function_">functionCallWithValue</span>(</span><br><span class="line">                target,</span><br><span class="line">                data,</span><br><span class="line">                value,</span><br><span class="line">                <span class="string">&quot;Address: low-level call with value failed&quot;</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 value,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= value,</span><br><span class="line">            <span class="string">&quot;Address: insufficient balance for call&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_functionCallWithValue</span>(target, data, value, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 weiValue,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">isContract</span>(target), <span class="string">&quot;Address: call to non-contract&quot;</span>);</span><br><span class="line"></span><br><span class="line">        (bool success, bytes memory returndata) = target.<span class="property">call</span>&#123;<span class="attr">value</span>: weiValue&#125;(</span><br><span class="line">            data</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="keyword">return</span> returndata;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (returndata.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                assembly &#123;</span><br><span class="line">                    <span class="keyword">let</span> returndata_size := <span class="title function_">mload</span>(returndata)</span><br><span class="line">                    <span class="title function_">revert</span>(<span class="title function_">add</span>(<span class="number">32</span>, returndata), returndata_size)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">revert</span>(errorMessage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IERC20</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decimals</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">symbol</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (<span class="built_in">string</span> memory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (<span class="built_in">string</span> memory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address who</span>) external view <span class="title function_">returns</span> (uint);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) external <span class="title function_">returns</span> (bool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allowance</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner,</span></span><br><span class="line"><span class="params">        address spender</span></span><br><span class="line"><span class="params">    </span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address _spender, uint _value</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address _from, address _to, uint _value</span>) external ;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">Transfer</span>(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);</span><br><span class="line">    event <span class="title class_">Approval</span>(</span><br><span class="line">        address indexed owner,</span><br><span class="line">        address indexed spender,</span><br><span class="line">        uint256 value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CCBusToken</span> is <span class="title class_">Context</span>, <span class="title class_">IERC20</span>&#123;</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> <span class="keyword">private</span> _name;</span><br><span class="line">    <span class="built_in">string</span> <span class="keyword">private</span> _symbol;</span><br><span class="line">    uint256 <span class="keyword">private</span> _decimals;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) _balances;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256)) <span class="keyword">private</span> _allowances;</span><br><span class="line"></span><br><span class="line">    address <span class="keyword">public</span> immutable deadAddress =</span><br><span class="line">        <span class="number">0x000000000000000000000000000000000000dEaD</span>;</span><br><span class="line">    uint256 <span class="keyword">private</span> _totalSupply;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"> </span></span><br><span class="line"><span class="params">        <span class="built_in">string</span>[] memory stringParams,</span></span><br><span class="line"><span class="params">        address[] memory addressParams,</span></span><br><span class="line"><span class="params">        uint256[] memory numberParams,</span></span><br><span class="line"><span class="params">        bool[] memory boolParams</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(addressParams.<span class="property">length</span>==<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">require</span>(boolParams.<span class="property">length</span>==<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        address receiveAddr = tx.<span class="property">origin</span>;</span><br><span class="line">        _name = stringParams[<span class="number">0</span>];</span><br><span class="line">        _symbol = stringParams[<span class="number">1</span>];</span><br><span class="line">        _decimals = numberParams[<span class="number">0</span>];</span><br><span class="line">        _totalSupply = numberParams[<span class="number">1</span>];</span><br><span class="line">        _balances[receiveAddr] = _totalSupply;</span><br><span class="line">        emit <span class="title class_">Transfer</span>(<span class="title function_">address</span>(<span class="number">0</span>), receiveAddr, _totalSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (<span class="built_in">string</span> memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">symbol</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (<span class="built_in">string</span> memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> _symbol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decimals</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _decimals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">owner</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="title function_">returns</span> (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> deadAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _balances[account];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allowance</span>(<span class="params">address owner1, address spender</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        view</span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        <span class="title function_">returns</span> (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _allowances[owner1][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">increaseAllowance</span>(<span class="params">address spender, uint256 addedValue</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        virtual</span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            spender,</span><br><span class="line">            _allowances[<span class="title function_">_msgSender</span>()][spender].<span class="title function_">add</span>(addedValue)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decreaseAllowance</span>(<span class="params">address spender, uint256 subtractedValue</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        virtual</span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            spender,</span><br><span class="line">            _allowances[<span class="title function_">_msgSender</span>()][spender].<span class="title function_">sub</span>(</span><br><span class="line">                subtractedValue,</span><br><span class="line">                <span class="string">&quot;ERC20: decreased allowance below zero&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint256 amount</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(<span class="title function_">_msgSender</span>(), spender, amount);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_approve</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner1,</span></span><br><span class="line"><span class="params">        address spender,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> &#123;</span><br><span class="line">        <span class="built_in">require</span>(owner1 != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(spender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve to the zero address&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _allowances[owner1][spender] = amount;</span><br><span class="line">        emit <span class="title class_">Approval</span>(owner1, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getCirculatingSupply</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _totalSupply.<span class="title function_">sub</span>(<span class="title function_">balanceOf</span>(deadAddress));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//to recieve ETH from uniswapV2Router when swaping</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address recipient, uint256 amount</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(<span class="title function_">_msgSender</span>(), recipient, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">public</span> <span class="keyword">override</span>  &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(sender, recipient, amount);</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            sender,</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            _allowances[sender][<span class="title function_">_msgSender</span>()].<span class="title function_">sub</span>(</span><br><span class="line">                amount,</span><br><span class="line">                <span class="string">&quot;ERC20: transfer amount exceeds allowance&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_transfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line">        <span class="built_in">require</span>(sender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: transfer from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(recipient != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: transfer to the zero address&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_basicTransfer</span>(sender, recipient, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_basicTransfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line">        _balances[sender] = _balances[sender].<span class="title function_">sub</span>(</span><br><span class="line">            amount,</span><br><span class="line">            <span class="string">&quot;Insufficient Balance&quot;</span></span><br><span class="line">        );</span><br><span class="line">        _balances[recipient] = _balances[recipient].<span class="title function_">add</span>(amount);</span><br><span class="line">        emit <span class="title class_">Transfer</span>(sender, recipient, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/21/Merkle-Tree-in-Chinese/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/21/Merkle-Tree-in-Chinese/" class="post-title-link" itemprop="url">Merkle Tree in Chinese</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-21 18:54:45" itemprop="dateCreated datePublished" datetime="2025-04-21T18:54:45-04:00">2025-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Merkle Tree<strong></strong></p>
<hr>
<h2 id="-Merkle-Tree-"><a href="#-Merkle-Tree-" class="headerlink" title=" Merkle Tree "></a> Merkle Tree </h2><p>Merkle Tree <strong></strong>  Merkle Root</p>
<h3 id="-"><a href="#-" class="headerlink" title=" "></a> </h3><ul>
<li>O(log n)</li>
<li></li>
<li></li>
</ul>
<hr>
<h2 id="-"><a href="#-" class="headerlink" title=" "></a> </h2><p> 4  <code>Tx0, Tx1, Tx2, Tx3</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">             Merkle Root</span><br><span class="line">                 </span><br><span class="line">         </span><br><span class="line">                         </span><br><span class="line">      Hash01           Hash23</span><br><span class="line">           </span><br><span class="line">  Hash0      Hash1  Hash2     Hash3</span><br><span class="line">                             </span><br><span class="line">Tx0          Tx1   Tx2        Tx3</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li><code>Hash0 = hash(Tx0)</code><code>Hash1 = hash(Tx1)</code></li>
<li><code>Hash01 = hash(Hash0 + Hash1)</code></li>
<li><code>Merkle Root = hash(Hash01 + Hash23)</code></li>
</ul>
<hr>
<h2 id="-Merkle-Tree-"><a href="#-Merkle-Tree-" class="headerlink" title=" Merkle Tree "></a> Merkle Tree </h2><h3 id="-"><a href="#-" class="headerlink" title=" "></a> </h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td> SPV</td>
</tr>
<tr>
<td></td>
<td>Merkle Root </td>
</tr>
<tr>
<td></td>
<td> IPFS</td>
</tr>
</tbody></table>
<hr>
<h2 id="--Merkle-Tree--JavaScript"><a href="#--Merkle-Tree--JavaScript" class="headerlink" title="  Merkle Tree  JavaScript"></a>  Merkle Tree  JavaScript</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createHash &#125; <span class="keyword">from</span> <span class="string">&#x27;crypto&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>).<span class="title function_">update</span>(data).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  Merkle Tree </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildMerkleTree</span>(<span class="params"><span class="attr">leaves</span>: <span class="built_in">string</span>[]</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (leaves.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> level = leaves.<span class="title function_">map</span>(sha256);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (level.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">nextLevel</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; level.<span class="property">length</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> left = level[i];</span><br><span class="line">      <span class="keyword">const</span> right = level[i + <span class="number">1</span>] ?? left; <span class="comment">// </span></span><br><span class="line">      nextLevel.<span class="title function_">push</span>(<span class="title function_">sha256</span>(left + right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    level = nextLevel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> level[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">const</span> txs = [<span class="string">&#x27;tx0&#x27;</span>, <span class="string">&#x27;tx1&#x27;</span>, <span class="string">&#x27;tx2&#x27;</span>, <span class="string">&#x27;tx3&#x27;</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Merkle Root:&#x27;</span>, <span class="title function_">buildMerkleTree</span>(txs));</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="--Merkle-Tree-"><a href="#--Merkle-Tree-" class="headerlink" title="  Merkle Tree "></a>  Merkle Tree </h2><p></p>
<ol>
<li> <code>tx1  h1</code></li>
<li>Merkle Proof</li>
<li> Merkle Root</li>
<li> Merkle Root </li>
</ol>
<p><strong></strong></p>
<hr>
<h2 id="-"><a href="#-" class="headerlink" title=" "></a> </h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li> Merkle Tree<strong>Merkle Patricia Trie</strong> </li>
<li> <code>transactionsRoot</code><code>stateRoot</code>  Merkle </li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li> <code>merkle_root</code>  Merkle </li>
<li>SPV Merkle Proof </li>
</ul>
<hr>
<h2 id="-"><a href="#-" class="headerlink" title=" "></a> </h2><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
