<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/page/3/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/30/Best-Practices-of-Deploying-PostgreSQL-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/30/Best-Practices-of-Deploying-PostgreSQL-in-Kubernetes/" class="post-title-link" itemprop="url">Best Practices of Deploying PostgreSQL in Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-30 23:32:42" itemprop="dateCreated datePublished" datetime="2024-10-30T23:32:42-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-11-03 13:45:16" itemprop="dateModified" datetime="2024-11-03T13:45:16-05:00">2024-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Kubernetes/PostgreSQL/" itemprop="url" rel="index"><span itemprop="name">PostgreSQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>This guide walks through deploying PostgreSQL in a Kubernetes Pod with a sidecar container that collects PostgreSQL logs and forwards them to Elasticsearch. We’ll use Helm to manage deployments, including setting up necessary ConfigMaps and Secrets for configuration.</p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgresql-logging/</span><br><span class="line">├── charts/</span><br><span class="line">│   └── postgresql-log-sidecar/</span><br><span class="line">│       ├── Chart.yaml</span><br><span class="line">│       ├── templates/</span><br><span class="line">│       │   ├── configmap.yaml</span><br><span class="line">│       │   ├── deployment.yaml</span><br><span class="line">│       │   ├── secret.yaml</span><br><span class="line">│       │   ├── service.yaml</span><br><span class="line">│       ├── values.yaml</span><br><span class="line">├── README.md</span><br></pre></td></tr></table></figure>

<h2 id="1-Architecture-Overview"><a href="#1-Architecture-Overview" class="headerlink" title="1. Architecture Overview"></a>1. Architecture Overview</h2><p>The following diagram shows how the PostgreSQL Pod and the sidecar interact for log collection:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------+</span><br><span class="line">|        PostgreSQL Pod             |</span><br><span class="line">|                                   |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">|  |  PostgreSQL Container       |  |</span><br><span class="line">|  |  - Exposes Port 5432        |  |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">|                                   |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">|  |  Log Collector              |  |</span><br><span class="line">|  |  - Collects Logs            |  |</span><br><span class="line">|  |  - Pushes to Elasticsearch  |  |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">+-----------------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="2-Helm-Chart-Configuration"><a href="#2-Helm-Chart-Configuration" class="headerlink" title="2. Helm Chart Configuration"></a>2. Helm Chart Configuration</h2><h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a><code>Chart.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">postgresql-log-sidecar</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">PostgreSQL</span> <span class="string">with</span> <span class="string">log</span> <span class="string">sidecar</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">&quot;13&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a><code>values.yaml</code></h3><p>Define values for PostgreSQL configuration and the sidecar container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresql:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">password123</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">appdb</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;elasticsearch:9200&quot;</span></span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;postgresql-logs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sidecar:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">fluent/fluent-bit</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&quot;1.8&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-ConfigMap-and-Secret"><a href="#3-ConfigMap-and-Secret" class="headerlink" title="3. ConfigMap and Secret"></a>3. ConfigMap and Secret</h2><h3 id="configmap-yaml"><a href="#configmap-yaml" class="headerlink" title="configmap.yaml"></a><code>configmap.yaml</code></h3><p>This ConfigMap includes log configuration for the sidecar container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [SERVICE]</span></span><br><span class="line"><span class="string">        Flush 1</span></span><br><span class="line"><span class="string">        Log_Level info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span><br><span class="line">        <span class="string">Path</span> <span class="string">/var/log/postgresql/postgresql.log</span></span><br><span class="line">        <span class="string">Tag</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span>  <span class="string">es</span></span><br><span class="line">        <span class="string">Match</span> <span class="string">*</span></span><br><span class="line">        <span class="string">Host</span>  &#123;&#123; <span class="string">.Values.elasticsearch.host</span> &#125;&#125;</span><br><span class="line">        <span class="string">Port</span>  <span class="number">9200</span></span><br><span class="line">        <span class="string">Index</span> &#123;&#123; <span class="string">.Values.elasticsearch.index</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="secret-yaml"><a href="#secret-yaml" class="headerlink" title="secret.yaml"></a><code>secret.yaml</code></h3><p>Create a Secret for PostgreSQL credentials.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">postgresql-username:</span> &#123;&#123; <span class="string">.Values.postgresql.username</span> <span class="string">|</span> <span class="string">b64enc</span> &#125;&#125;</span><br><span class="line">  <span class="attr">postgresql-password:</span> &#123;&#123; <span class="string">.Values.postgresql.password</span> <span class="string">|</span> <span class="string">b64enc</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Deployment-Configuration"><a href="#4-Deployment-Configuration" class="headerlink" title="4. Deployment Configuration"></a>4. Deployment Configuration</h2><h3 id="deployment-yaml"><a href="#deployment-yaml" class="headerlink" title="deployment.yaml"></a><code>deployment.yaml</code></h3><p>The main deployment file sets up PostgreSQL and the Fluent Bit sidecar container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgresql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> &#123;&#123; <span class="string">.Values.postgresql.database</span> &#125;&#125;</span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">postgresql-secret</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">postgresql-username</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">postgresql-secret</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">postgresql-password</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-logs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/postgresql</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-collector</span></span><br><span class="line">          <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.sidecar.image</span> &#125;&#125;<span class="string">:&#123;&#123;</span> <span class="string">.Values.sidecar.tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/fluent-bit/etc/fluent-bit.conf&quot;</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-logs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/postgresql</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/fluent-bit/etc</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">fluent-bit.conf</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> &#123;&#123; <span class="string">.Values.sidecar.resources.limits.memory</span> &#125;&#125;</span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> &#123;&#123; <span class="string">.Values.sidecar.resources.requests.memory</span> &#125;&#125;</span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-logs</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br></pre></td></tr></table></figure>

<h3 id="service-yaml"><a href="#service-yaml" class="headerlink" title="service.yaml"></a><code>service.yaml</code></h3><p>Create a Service to expose PostgreSQL internally within the cluster.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgresql</span></span><br></pre></td></tr></table></figure>

<h2 id="5-Deploying-the-Helm-Chart"><a href="#5-Deploying-the-Helm-Chart" class="headerlink" title="5. Deploying the Helm Chart"></a>5. Deploying the Helm Chart</h2><p>Install the chart with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install postgresql-log-sidecar ./charts/postgresql-log-sidecar</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/30/Understanding-Kubernetes-Pods-and-Services/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/30/Understanding-Kubernetes-Pods-and-Services/" class="post-title-link" itemprop="url">Understanding Kubernetes Pods and Services</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-30 23:24:27 / Modified: 23:43:49" itemprop="dateCreated datePublished" datetime="2024-10-30T23:24:27-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In Kubernetes, <strong>Pods</strong> and <strong>Services</strong> are fundamental components, each with distinct responsibilities that work together to provide scalable, resilient applications. Here’s an in-depth look into how these units interact, their roles, and how they communicate.</p>
<h2 id="1-Kubernetes-Pod-The-Basic-Unit-of-Deployment"><a href="#1-Kubernetes-Pod-The-Basic-Unit-of-Deployment" class="headerlink" title="1. Kubernetes Pod: The Basic Unit of Deployment"></a>1. Kubernetes Pod: The Basic Unit of Deployment</h2><p>A <strong>Pod</strong> is the smallest deployable unit in Kubernetes, representing one or more containers. Containers within the same Pod:</p>
<ul>
<li><strong>Share resources</strong>: Same IP address, storage volumes, and network namespace.</li>
<li><strong>Enable inter-container communication</strong>: Containers in a Pod can access each other on <code>localhost</code>.</li>
<li><strong>Are ephemeral</strong>: When a Pod fails, it is replaced by a new Pod instance, often with a new IP address.</li>
</ul>
<h3 id="Pod-Architecture"><a href="#Pod-Architecture" class="headerlink" title="Pod Architecture"></a>Pod Architecture</h3><p>Each Pod contains one or more containers with shared resources. Below is a textual representation of a typical Pod structure:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+</span><br><span class="line">|        Pod            |</span><br><span class="line">|  IP: 10.244.1.5       |</span><br><span class="line">|                       |</span><br><span class="line">| +------------------+  |</span><br><span class="line">| | Container A      |  |</span><br><span class="line">| | - Application    |  |</span><br><span class="line">| +------------------+  |</span><br><span class="line">|                       |</span><br><span class="line">| +------------------+  |</span><br><span class="line">| | Container B      |  |</span><br><span class="line">| | - Sidecar Proxy  |  |</span><br><span class="line">| +------------------+  |</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>

<p>In this structure, <code>Container A</code> might run the main application, while <code>Container B</code> is a helper (e.g., proxy or logging container). These containers share an IP address and can communicate directly.</p>
<h2 id="2-Real-Scenario-Explaination"><a href="#2-Real-Scenario-Explaination" class="headerlink" title="2. Real Scenario Explaination"></a>2. Real Scenario Explaination</h2><p>In this setup, the sidecar container collects logs from the PostgreSQL container by sharing a directory between them. Here’s a breakdown of how it works:</p>
<ol>
<li><p><strong>Shared Volume</strong>: A shared <code>emptyDir</code> volume, <code>postgres-logs</code>, is mounted in both the PostgreSQL and sidecar containers. PostgreSQL is configured to output logs to <code>/var/log/postgresql</code> within its filesystem, which maps to the shared volume.</p>
</li>
<li><p><strong>Log Collector Configuration</strong>: The sidecar container, running Fluent Bit, is configured to read from <code>/var/log/postgresql</code> (also mapped to the shared volume). Fluent Bit’s configuration specifies the <code>tail</code> input plugin to read new entries as they are appended.</p>
</li>
<li><p><strong>Log Processing and Output</strong>: Fluent Bit processes the logs, then sends them to Elasticsearch through its output configuration, allowing centralized log analysis and monitoring.</p>
</li>
</ol>
<p>This method ensures that logs are constantly accessible to the sidecar without modifying the PostgreSQL container directly.</p>
<h3 id="Example-Fluent-Bit-Configuration-in-configmap-yaml"><a href="#Example-Fluent-Bit-Configuration-in-configmap-yaml" class="headerlink" title="Example Fluent Bit Configuration in configmap.yaml"></a>Example Fluent Bit Configuration in <code>configmap.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [SERVICE]</span></span><br><span class="line"><span class="string">        Flush 1</span></span><br><span class="line"><span class="string">        Log_Level info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span><br><span class="line">        <span class="string">Path</span> <span class="string">/var/log/postgresql/postgresql.log</span></span><br><span class="line">        <span class="string">Tag</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">es</span></span><br><span class="line">        <span class="string">Match</span> <span class="string">*</span></span><br><span class="line">        <span class="string">Host</span> &#123;&#123; <span class="string">.Values.elasticsearch.host</span> &#125;&#125;</span><br><span class="line">        <span class="string">Port</span> <span class="number">9200</span></span><br><span class="line">        <span class="string">Index</span> &#123;&#123; <span class="string">.Values.elasticsearch.index</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>This setup allows the sidecar to monitor log updates efficiently, pushing each entry to Elasticsearch as it appears in the log file.</p>
<h2 id="2-Kubernetes-Service-Stable-Networking-for-Dynamic-Pods"><a href="#2-Kubernetes-Service-Stable-Networking-for-Dynamic-Pods" class="headerlink" title="2. Kubernetes Service: Stable Networking for Dynamic Pods"></a>2. Kubernetes Service: Stable Networking for Dynamic Pods</h2><p>A <strong>Service</strong> is an abstraction that provides a stable, permanent network interface for a set of Pods. Since Pod IP addresses are temporary, a Service routes requests to Pods and handles the load balancing across them.</p>
<h3 id="Key-Service-Types"><a href="#Key-Service-Types" class="headerlink" title="Key Service Types"></a>Key Service Types</h3><ul>
<li><strong>ClusterIP</strong>: Exposes the Service only within the cluster.</li>
<li><strong>NodePort</strong>: Exposes the Service on each node’s IP at a specific port.</li>
<li><strong>LoadBalancer</strong>: Exposes the Service externally, often through a cloud provider’s load balancer.</li>
<li><strong>Headless Service</strong>: Exposes each Pod individually, without load balancing, often used for direct client-to-Pod connections.</li>
</ul>
<h3 id="Example-Service-Architecture"><a href="#Example-Service-Architecture" class="headerlink" title="Example Service Architecture"></a>Example Service Architecture</h3><p>The Service selects Pods with specific labels and routes traffic to them dynamically. Here’s a simplified text diagram for a Service:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+             +------------------+</span><br><span class="line">|  Client Request   |------------&gt;|  Service         |</span><br><span class="line">+-------------------+             |  (ClusterIP)     |</span><br><span class="line">                                  +--------+---------+</span><br><span class="line">                                           |</span><br><span class="line">                                           |</span><br><span class="line">                              +------------+-----------+</span><br><span class="line">                              |                        |</span><br><span class="line">                              |                        |</span><br><span class="line">                      +-------v------+       +---------v------+</span><br><span class="line">                      |    Pod       |       |    Pod         |</span><br><span class="line">                      |  IP: Dynamic |       |  IP: Dynamic   |</span><br><span class="line">                      +--------------+       +----------------+</span><br></pre></td></tr></table></figure>

<p>The Service maintains a list of Pods based on matching labels and routes incoming requests to any healthy Pod in the group, providing an abstraction layer for easy access.</p>
<h2 id="3-Communication-Between-Pods-and-Services"><a href="#3-Communication-Between-Pods-and-Services" class="headerlink" title="3. Communication Between Pods and Services"></a>3. Communication Between Pods and Services</h2><p>Kubernetes manages Pod-to-Service and Service-to-Pod communication using:</p>
<ol>
<li><strong>Labels and Selectors</strong>: Services target Pods by their labels.</li>
<li><strong>Cluster DNS</strong>: Each Service receives a unique hostname, which can be used within the cluster to resolve the Service IP.</li>
<li><strong>Load Balancing</strong>: Services distribute requests across Pods, using internal load balancing mechanisms (IP tables, kube-proxy).</li>
</ol>
<p>When a client inside the cluster calls a Service, Kubernetes DNS resolves the Service name to a virtual IP, and the Service routes the request to one of the associated Pods.</p>
<h3 id="Dynamic-Pod-Communication-Example"><a href="#Dynamic-Pod-Communication-Example" class="headerlink" title="Dynamic Pod Communication Example"></a>Dynamic Pod Communication Example</h3><p>The following diagram illustrates how a Service enables stable access to multiple Pods, even if the Pods are added or removed over time:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+                  +-----------------+</span><br><span class="line">|    Client         |-----------------&gt;| Service: my-app |</span><br><span class="line">+-------------------+                  |  IP: 10.96.0.1  |</span><br><span class="line">                                       +-------+---------+</span><br><span class="line">                                               |</span><br><span class="line">                           +-------------------+-------------------+</span><br><span class="line">                           |                                       |</span><br><span class="line">                  +--------v-----------+                  +--------v------------+</span><br><span class="line">                  |      Pod           |                  |       Pod           |</span><br><span class="line">                  |  Label: app=my-app |                  |   Label: app=my-app |</span><br><span class="line">                  +--------------------+                  +---------------------+</span><br></pre></td></tr></table></figure>

<p>Here, the client accesses <code>my-app</code>, and the Service dynamically routes the request to an available Pod with the matching label.</p>
<h2 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h2><ul>
<li><strong>Pods</strong>: Contain containers, share IP addresses, ephemeral in nature.</li>
<li><strong>Services</strong>: Provide stable, permanent access to a group of Pods with specific labels, enable load balancing, and ensure that applications can consistently reach the backend Pods, even with dynamic scaling.</li>
</ul>
<p>By decoupling Pod IP addresses from the client-facing endpoint, Services ensure reliable, scalable, and high-availability communication within Kubernetes applications.</p>
<h3 id="Example-Fluent-Bit-Configuration-in-configmap-yaml-1"><a href="#Example-Fluent-Bit-Configuration-in-configmap-yaml-1" class="headerlink" title="Example Fluent Bit Configuration in configmap.yaml"></a>Example Fluent Bit Configuration in <code>configmap.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [SERVICE]</span></span><br><span class="line"><span class="string">        Flush 1</span></span><br><span class="line"><span class="string">        Log_Level info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span><br><span class="line">        <span class="string">Path</span> <span class="string">/var/log/postgresql/postgresql.log</span></span><br><span class="line">        <span class="string">Tag</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">es</span></span><br><span class="line">        <span class="string">Match</span> <span class="string">*</span></span><br><span class="line">        <span class="string">Host</span> &#123;&#123; <span class="string">.Values.elasticsearch.host</span> &#125;&#125;</span><br><span class="line">        <span class="string">Port</span> <span class="number">9200</span></span><br><span class="line">        <span class="string">Index</span> &#123;&#123; <span class="string">.Values.elasticsearch.index</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>This setup allows the sidecar to monitor log updates efficiently, pushing each entry to Elasticsearch as it appears in the log file.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/30/Microservice-Spring-Cloud-Gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/30/Microservice-Spring-Cloud-Gateway/" class="post-title-link" itemprop="url">Microservice - Spring Cloud Gateway</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-30 11:51:38 / Modified: 18:55:48" itemprop="dateCreated datePublished" datetime="2024-10-30T11:51:38-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/" itemprop="url" rel="index"><span itemprop="name">Microservice</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/Spring-Cloud/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#why-we-need-api-gateway">Why We Need API Gateway</a></li>
<li><a href="#build-api-gateway">Build API Gateway</a></li>
<li><a href="#setting-up-api-gateway">Setting Up API Gateway</a></li>
<li><a href="#route-configuration">Route Configuration</a></li>
<li><a href="#security-and-jwt-authentication">Security and JWT Authentication</a></li>
<li><a href="#dockerfile-configuration">Dockerfile Configuration</a></li>
<li><a href="#helm-chart-configuration">Helm Chart Configuration</a></li>
<li><a href="#project-structure">Project Structure</a></li>
<li><a href="#api-gateway-architecture">API Gateway Architecture</a></li>
<li><a href="#sequence-diagrams">Sequence Diagrams</a></li>
<li><a href="#https-configuration-for-api-gateway">HTTPS Configuration for API Gateway</a></li>
<li><a href="#difference-between-lb-and-http-protocols">Difference Between <code>lb://</code> and <code>http://</code> Protocols</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ol>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In a microservices architecture, an API Gateway acts as a single entry point for client requests, routing them to the appropriate microservices within the Kubernetes cluster. This article will delve into the setup and configuration of a Spring Cloud API Gateway, focusing on JWT authentication validation, route management, and deployment using Docker and Helm.</p>
<hr>
<p><a name="why-we-need-api-gateway"></a></p>
<h2 id="Why-We-Need-API-Gateway"><a href="#Why-We-Need-API-Gateway" class="headerlink" title="Why We Need API Gateway"></a>Why We Need API Gateway</h2><h3 id="Single-Entry-Point"><a href="#Single-Entry-Point" class="headerlink" title="Single Entry Point"></a>Single Entry Point</h3><p>An API Gateway provides a single entry point for all client requests, simplifying client-side code and reducing the number of endpoints clients need to interact with.</p>
<h3 id="Routing-and-Load-Balancing"><a href="#Routing-and-Load-Balancing" class="headerlink" title="Routing and Load Balancing"></a>Routing and Load Balancing</h3><p>The gateway routes requests to the appropriate microservices and handles load balancing across multiple instances of each service.</p>
<h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><p>It centralizes security concerns such as authentication and authorization, reducing the need for each microservice to implement these features independently.</p>
<h3 id="Protocol-Translation"><a href="#Protocol-Translation" class="headerlink" title="Protocol Translation"></a>Protocol Translation</h3><p>The gateway can handle protocol translation, allowing clients to use a single protocol (e.g., HTTP&#x2F;2) while communicating with microservices using different protocols.</p>
<hr>
<p><a name="build-api-gateway"></a></p>
<h2 id="Build-API-Gateway"><a href="#Build-API-Gateway" class="headerlink" title="Build API Gateway"></a>Build API Gateway</h2><p><strong>Is there an official API Gateway image?</strong></p>
<ul>
<li><p>Currently, <strong>Spring Cloud Gateway</strong> does not offer an official pre-built Docker image, developers build a Spring Boot application with <code>spring-cloud-starter-gateway</code> and custom configurations (routes, JWT filter, etc.). </p>
</li>
<li><p>As gateway services are often customized for specific routing, load balancing, security and potentially other cross-cutting concerns and needs. It acts as the main entry point for all external requests to your microservices. The gateway can either pull routing configurations from a service discovery mechanism(like Spring Cloud Kubernetes Discovery) or have the configurations set explicitly.</p>
</li>
</ul>
<p><strong>Steps to Build a Production-Ready API Gateway</strong></p>
<ol>
<li><strong>Route Configuration</strong>: Define routing rules either in <code>application.yml</code> or using Java annotations.</li>
<li><strong>Security Setup</strong>: Add JWT validation (e.g., <code>JwtAuthenticationFilter</code>) and configure security policies in the gateway.</li>
<li><strong>Service Discovery</strong>: Use Spring Cloud Kubernetes for service discovery, allowing the gateway to dynamically discover services.</li>
<li><strong>Containerization and Deployment</strong>: Build a Docker image and deploy it to Kubernetes with a Helm chart for scalability and configuration management.</li>
</ol>
<p><a name="setting-up-api-gateway"></a></p>
<h2 id="Setting-Up-API-Gateway"><a href="#Setting-Up-API-Gateway" class="headerlink" title="Setting Up API Gateway"></a>Setting Up API Gateway</h2><h3 id="Step-1-Add-Dependencies"><a href="#Step-1-Add-Dependencies" class="headerlink" title="Step 1: Add Dependencies"></a>Step 1: Add Dependencies</h3><p>Add the necessary dependencies to your <code>pom.xml</code> file.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Cloud Gateway --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Security --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- JWT --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Create-the-Main-Application-Class"><a href="#Step-2-Create-the-Main-Application-Class" class="headerlink" title="Step 2: Create the Main Application Class"></a>Step 2: Create the Main Application Class</h3><p>Create the main application class for the Spring Cloud Gateway.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiGatewayApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ApiGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><a name="service-discovery-and-routing-configuration"></a></p>
<h2 id="Service-Discovery-and-Routing-Configuration"><a href="#Service-Discovery-and-Routing-Configuration" class="headerlink" title="Service Discovery and Routing Configuration"></a>Service Discovery and Routing Configuration</h2><h3 id="YAML-based-Configuration"><a href="#YAML-based-Configuration" class="headerlink" title="YAML-based Configuration"></a>YAML-based Configuration</h3><p>Configure routes in the <code>application.yml</code> file.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span>  <span class="comment"># Ensures lowercase naming for services</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://profile-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://order-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">shipment_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://shipment-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/shipment/**</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">kubernetes:</span></span><br><span class="line">        <span class="attr">discovery:</span></span><br><span class="line">          <span class="attr">all-namespaces:</span> <span class="literal">true</span>  <span class="comment"># Discover services across all namespaces</span></span><br><span class="line">          <span class="attr">service-labels:</span>       <span class="comment"># Optional: filter based on labels</span></span><br><span class="line">            <span class="attr">environment:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>lb:&#x2F;&#x2F;</strong> *&#x2F; scheme: Enables load balancing across multiple instances of each microservice.</li>
<li><strong>Service Discovery</strong>: The gateway will detect microservices like <code>inventory-service</code> or <code>shipment-service</code> using Kubernetes service discovery, eliminating the need for hardcoding service addresses.</li>
</ul>
<h3 id="Annotation-based-Configuration"><a href="#Annotation-based-Configuration" class="headerlink" title="Annotation-based Configuration"></a>Annotation-based Configuration</h3><p>Alternatively, configure routes programmatically using annotations.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayRoutesConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">gatewayRoutes</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(<span class="string">&quot;profile_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/profile/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://profile-svc&quot;</span>))</span><br><span class="line">            .route(<span class="string">&quot;inventory_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/inventory/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://inventory-svc&quot;</span>))</span><br><span class="line">            .route(<span class="string">&quot;order_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/order/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://order-svc&quot;</span>))</span><br><span class="line">            .route(<span class="string">&quot;shipment_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/shipment/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://shipment-svc&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Enable Service Discovery</strong><br>To enable service discovery, you can use the <code>@EnableDiscoveryClient</code> annotation. This annotation is typically placed in a configuration class.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscoveryConfig</span> &#123;</span><br><span class="line">    <span class="comment">// Additional configuration for service discovery can be added here if needed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="application-yml-Configuration-for-Service-Discovery"><a href="#application-yml-Configuration-for-Service-Discovery" class="headerlink" title="application.yml Configuration for Service Discovery"></a><code>application.yml</code> Configuration for Service Discovery</h3><p>Ensure that the following configuration is present in your <code>application.yml</code> or <code>application.properties</code> file to enable service discovery and other settings:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kubernetes:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">all-namespaces:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-labels:</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li><strong>Annotation-based Configuration</strong>: The <code>GatewayRoutesConfig</code> class defines the routes using the <code>RouteLocatorBuilder</code>.</li>
<li><strong>Service Discovery</strong>: The <code>DiscoveryConfig</code> class enables service discovery using the <code>@EnableDiscoveryClient</code> annotation.</li>
<li><strong>YAML Configuration</strong>: The <code>application.yml</code> file contains the necessary settings for service discovery and gateway configuration.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: The discovery settings, such as enabling discovery locator and configuring Kubernetes discovery, cannot be directly configured using annotations in the configuration class. These settings are typically configured in the <code>application.yml</code> or <code>application.properties</code> file.</p>
</blockquote>
<hr>
<p><a name="security-and-jwt-authentication"></a></p>
<h2 id="Security-and-JWT-Authentication"><a href="#Security-and-JWT-Authentication" class="headerlink" title="Security and JWT Authentication"></a>Security and JWT Authentication</h2><blockquote>
<p><strong>Add Dependencies</strong> Include <code>spring-boot-starter-oauth2-resource-server</code> and <code>spring-cloud-starter-gateway</code> in your <code>pom.xml</code>:</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Gateway Application Properties Configuration</strong>: Configure <code>application.yml</code> for JWT validation. This includes specifying the JWT issuer URI and enabling authorization.</p>
</blockquote>
   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">TokenRelay</span>  <span class="comment"># Forward the token to the downstream services</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">issuer-uri:</span> <span class="string">https://&lt;your-auth-provider&gt;/realms/your-realm</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>TokenRelay Filter</strong>: Passes the JWT token along with requests to the backend services.</li>
<li><strong>Issuer URI</strong>: This points to your authentication provider, e.g., an OpenID Connect provider like Keycloak or Auth0.</li>
</ul>
<blockquote>
<p><strong>Enable JWT Authentication</strong>: Set up <code>SecurityConfig</code> to enable JWT authentication and configure routes for authorized access.</p>
</blockquote>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">securityWebFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeExchange()</span><br><span class="line">            .pathMatchers(<span class="string">&quot;/inventory/**&quot;</span>, <span class="string">&quot;/shipment/**&quot;</span>).authenticated()  <span class="comment">// Require auth for specified paths</span></span><br><span class="line">            .anyExchange().permitAll()</span><br><span class="line">            .and()</span><br><span class="line">            .oauth2ResourceServer()</span><br><span class="line">            .jwt();  <span class="comment">// Enable JWT authentication</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>This configuration restricts access to <code>/inventory/**</code> and <code>/shipment/**</code> endpoints to authenticated users, while allowing others as specified.</li>
</ul>
<blockquote>
<p><strong>Annotation-based Configuration for Routes and Filters</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayRoutesConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">gatewayRoutes</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(<span class="string">&quot;inventory-service&quot;</span>, r -&gt; r.path(<span class="string">&quot;/inventory/**&quot;</span>)</span><br><span class="line">                .filters(f -&gt; f.filter(<span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(<span class="string">&quot;ROLE_USER,ROLE_ADMIN&quot;</span>)))</span><br><span class="line">                .uri(<span class="string">&quot;lb://inventory-service&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeExchange()</span><br><span class="line">            .anyExchange().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .oauth2ResourceServer()</span><br><span class="line">            .jwt()</span><br><span class="line">            .jwkSetUri(<span class="string">&quot;https://example-issuer.com/.well-known/jwks.json&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().disable();</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;**Note**: **Annotation-based Configuration**: The `GatewayRoutesConfig` <span class="keyword">class</span> <span class="title class_">defines</span> the routes and filters using the `RouteLocatorBuilder`. It also configures security settings using Spring Security annotations.</span><br></pre></td></tr></table></figure>

<h3 id="JWT-Authentication-Filter"><a href="#JWT-Authentication-Filter" class="headerlink" title="JWT Authentication Filter"></a>JWT Authentication Filter</h3><p>Create a JWT authentication filter to verify incoming requests.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authentication.AuthenticationWebFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.JwtDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.ReactiveJwtDecoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtDecoder jwtDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">        <span class="type">AuthenticationWebFilter</span> <span class="variable">jwtAuthFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationWebFilter</span>(authenticationManager());</span><br><span class="line">        http</span><br><span class="line">            .authorizeExchange()</span><br><span class="line">            .pathMatchers(<span class="string">&quot;/oauth2/**&quot;</span>).permitAll()</span><br><span class="line">            .pathMatchers(<span class="string">&quot;/inventory/**&quot;</span>, <span class="string">&quot;/shipment/**&quot;</span>).authenticated().permitAll()</span><br><span class="line">            .anyExchange().authenticated()</span><br><span class="line">            .and().addFilterAt(jwtAuthFilter, SecurityWebFiltersOrder.AUTHENTICATION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationManager</span>(jwtDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JWT-Decoder-Configuration"><a href="#JWT-Decoder-Configuration" class="headerlink" title="JWT Decoder Configuration"></a>JWT Decoder Configuration</h3><p>Configure the JWT decoder to validate tokens.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.JwtDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.NimbusJwtDecoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtDecoder <span class="title function_">jwtDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NimbusJwtDecoder.withPublicKey(publicKey).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="service-to-service-communication-via-gateway"></a></p>
<h2 id="Service-to-Service-Communication-via-Gateway"><a href="#Service-to-Service-Communication-via-Gateway" class="headerlink" title="Service-to-Service Communication via Gateway"></a>Service-to-Service Communication via Gateway</h2><p>To communicate between services, such as <strong>shipment-service</strong> needing to communicate with <strong>inventory-service</strong>, microservices can send requests through the <strong>API Gateway</strong>. </p>
<p>This method simplifies routing, as services only need to know the <strong>gateway address</strong> and the <strong>service paths</strong> (e.g., <code>/inventory/**</code>). This approach enhances security and centralizes cross-cutting concerns like authentication, logging, and rate limiting.</p>
<h4 id="Benefits-of-Gateway-based-Communication"><a href="#Benefits-of-Gateway-based-Communication" class="headerlink" title="Benefits of Gateway-based Communication"></a>Benefits of Gateway-based Communication</h4><ol>
<li><strong>Centralized Security</strong>: JWT and other auth mechanisms can be handled at the gateway.</li>
<li><strong>Simplified Routing</strong>: Each service interacts with others via a single entry point.</li>
<li><strong>Enhanced Scalability</strong>: Kubernetes manages load balancing for each service, and the gateway balances requests across pods.</li>
</ol>
<hr>
<h3 id="Service-Discovery-and-Routing-Workflow"><a href="#Service-Discovery-and-Routing-Workflow" class="headerlink" title="Service Discovery and Routing Workflow"></a>Service Discovery and Routing Workflow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[External Client] --&gt; [API Gateway]</span><br><span class="line">                          |</span><br><span class="line">                          | (Discovers routes from Kubernetes Discovery)</span><br><span class="line">                          |</span><br><span class="line">                   [inventory-service] &lt;--+-- &quot;lb://inventory-service&quot;</span><br><span class="line">                   [shipment-service]   &lt;--+-- &quot;lb://shipment-service&quot;</span><br><span class="line">                   [other-service]      &lt;--+-- Discovered automatically</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Sequence Diagram: Inventory and Shipment Communication via Gateway</p>
</blockquote>
<ol>
<li><strong>Shipment Service</strong> sends a request to <strong>API Gateway</strong> at <code>/inventory/items</code>.</li>
<li><strong>API Gateway</strong> validates the JWT token, looks up <strong>inventory-service</strong> route, and forwards the request.</li>
<li><strong>Inventory Service</strong> responds with the requested data.</li>
<li><strong>API Gateway</strong> relays the response to <strong>Shipment Service</strong>.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Shipment Service --&gt; API Gateway: Request /inventory/items with JWT</span><br><span class="line">API Gateway --&gt; inventory-service: Validate JWT and route to inventory</span><br><span class="line">inventory-service --&gt; API Gateway: Return data</span><br><span class="line">API Gateway --&gt; Shipment Service: Relay data response</span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<p><strong>Example</strong>: Sending an Authenticated Request to Another Microservice via the Gateway</p>
</blockquote>
<p>In <strong>shipment-service</strong>, use Spring’s <strong>WebClient</strong> to call the <strong>inventory-service</strong> through the API Gateway.</p>
<ol>
<li><p><strong>Define WebClient Bean</strong> for Consistency Across Calls</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebClient.Builder <span class="title function_">webClientBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> WebClient.builder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Send Authenticated Request through Gateway</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WebClient.Builder webClientBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> InventoryResponse <span class="title function_">fetchInventoryItems</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> webClientBuilder</span><br><span class="line">        .build()</span><br><span class="line">        .get()</span><br><span class="line">        .uri(<span class="string">&quot;http://api-gateway/inventory/items&quot;</span>)</span><br><span class="line">        .header(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + token)</span><br><span class="line">        .retrieve()</span><br><span class="line">        .bodyToMono(InventoryResponse.class)</span><br><span class="line">        .block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Token Forwarding</strong>: The token is forwarded with the request, allowing the gateway to validate it before routing to the target service.</li>
<li><strong>Gateway URI</strong>: Requests go through <code>http://api-gateway/inventory/items</code>, routing based on service discovery.</li>
</ul>
</li>
</ol>
<blockquote>
<p>In this example:</p>
</blockquote>
<ul>
<li>The <strong>gateway is deployed separately</strong> in Kubernetes and handles dynamic service discovery and routing via <code>lb://</code> URIs.</li>
<li>Service-to-service calls leverage the <strong>API Gateway</strong> for ease of scaling, simplified routing, and centralized security. Each service only needs to know the <strong>API Gateway’s address and service paths</strong>.</li>
</ul>
<hr>
<h3 id="Comparison-Gateway-vs-Direct-Service-to-Service-Calls"><a href="#Comparison-Gateway-vs-Direct-Service-to-Service-Calls" class="headerlink" title="Comparison: Gateway vs. Direct Service-to-Service Calls"></a>Comparison: Gateway vs. Direct Service-to-Service Calls</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>API Gateway Routing</th>
<th>Direct Service-to-Service Calls</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Routing</strong></td>
<td>Centralized, via API Gateway</td>
<td>Direct, each service must know other services</td>
</tr>
<tr>
<td><strong>JWT Validation</strong></td>
<td>Centralized in Gateway</td>
<td>Each service needs to validate tokens</td>
</tr>
<tr>
<td><strong>Scaling</strong></td>
<td>Gateway handles scaling and balancing</td>
<td>Each service scales independently</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>JWT validated once at the gateway</td>
<td>JWT validation needed in each service</td>
</tr>
<tr>
<td><strong>Use Case</strong></td>
<td>Best for external and internal calls</td>
<td>Ideal for internal-only, tightly integrated</td>
</tr>
</tbody></table>
<hr>
<p><a name="dockerfile-configuration"></a></p>
<h2 id="Dockerfile-Configuration"><a href="#Dockerfile-Configuration" class="headerlink" title="Dockerfile Configuration"></a>Dockerfile Configuration</h2><p>Create a <code>Dockerfile</code> for building the API Gateway image.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start with the base image for Java</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set working directory</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy the API Gateway JAR to the image</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/api-gateway.jar api-gateway.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expose port 8443 for the API Gateway</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the API Gateway application</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;api-gateway.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Build-and-Push-the-Docker-Image"><a href="#Build-and-Push-the-Docker-Image" class="headerlink" title="Build and Push the Docker Image"></a>Build and Push the Docker Image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myregistry/api-gateway:latest .</span><br><span class="line">docker push myregistry/api-gateway:latest</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="helm-chart-configuration"></a></p>
<h2 id="Helm-Chart-Configuration"><a href="#Helm-Chart-Configuration" class="headerlink" title="Helm Chart Configuration"></a>Helm Chart Configuration</h2><h3 id="Helm-Chart-Structure"><a href="#Helm-Chart-Structure" class="headerlink" title="Helm Chart Structure"></a>Helm Chart Structure</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">api-gateway/</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── values.yaml</span><br><span class="line">└── templates/</span><br><span class="line">    ├── deployment.yaml</span><br><span class="line">    ├── service.yaml</span><br><span class="line">    └── ingress.yaml</span><br></pre></td></tr></table></figure>

<h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">API</span> <span class="string">Gateway</span> <span class="string">for</span> <span class="string">Microservices</span></span><br></pre></td></tr></table></figure>

<h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">myregistry/api-gateway</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">api-gateway-tls</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">api.example.com</span></span><br></pre></td></tr></table></figure>

<h3 id="templates-deployment-yaml"><a href="#templates-deployment-yaml" class="headerlink" title="templates&#x2F;deployment.yaml"></a>templates&#x2F;deployment.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.replicaCount</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Values.image.repository &#125;&#125;</span>:<span class="template-variable">&#123;&#123; .Values.image.tag &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure>

<h3 id="templates-service-yaml"><a href="#templates-service-yaml" class="headerlink" title="templates&#x2F;service.yaml"></a>templates&#x2F;service.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> &#123;&#123; <span class="string">.Values.service.type</span> &#125;&#125;</span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> &#123;&#123; <span class="string">.Values.service.port</span> &#125;&#125;</span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">api-gateway</span></span><br></pre></td></tr></table></figure>

<h3 id="templates-ingress-yaml"><a href="#templates-ingress-yaml" class="headerlink" title="templates&#x2F;ingress.yaml"></a>templates&#x2F;ingress.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">api-gateway-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="project-structure"></a></p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">api-gateway/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── main/</span><br><span class="line">│   │   ├── java/</span><br><span class="line">│   │   │   └── com/</span><br><span class="line">│   │   │       └── example/</span><br><span class="line">│   │   │           └── apigateway/</span><br><span class="line">│   │   │               ├── ApiGatewayApplication.java</span><br><span class="line">│   │   │               ├── config/</span><br><span class="line">│   │   │               │   ├── GatewayRoutesConfig.java</span><br><span class="line">│   │   │               │   ├── SecurityConfig.java</span><br><span class="line">│   │   │               │   └── JwtConfig.java</span><br><span class="line">│   │   └── resources/</span><br><span class="line">│   │       └── application.yml</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── pom.xml</span><br><span class="line">└── helm/</span><br><span class="line">    └── api-gateway/</span><br><span class="line">        ├── Chart.yaml</span><br><span class="line">        ├── values.yaml</span><br><span class="line">        └── templates/</span><br><span class="line">            ├── deployment.yaml</span><br><span class="line">            ├── service.yaml</span><br><span class="line">            └── ingress.yaml</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="api-gateway-architecture"></a></p>
<h2 id="API-Gateway-Architecture"><a href="#API-Gateway-Architecture" class="headerlink" title="API Gateway Architecture"></a>API Gateway Architecture</h2><pre><code class="highlight mermaid">graph TD
    A[Client] --&gt;|HTTPS| B[API Gateway]
    B --&gt;|lb://| C[Profile Service]
    B --&gt;|lb://| D[Inventory Service]
    B --&gt;|lb://| E[Order Service]
    B --&gt;|lb://| F[Shipment Service]
    B --&gt;|lb://| G[OAuth2 Service]</code></pre>

<h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h3><ol>
<li><strong>Client</strong>: Sends requests to the API Gateway over HTTPS.</li>
<li><strong>API Gateway</strong>: Routes requests to the appropriate microservice using <code>lb://</code> protocol.</li>
<li><strong>Microservices</strong>: Each service handles requests and returns responses to the API Gateway.</li>
</ol>
<hr>
<p><a name="sequence-diagrams"></a></p>
<h2 id="Sequence-Diagrams"><a href="#Sequence-Diagrams" class="headerlink" title="Sequence Diagrams"></a>Sequence Diagrams</h2><h3 id="Sequence-Diagram-for-Client-Request"><a href="#Sequence-Diagram-for-Client-Request" class="headerlink" title="Sequence Diagram for Client Request"></a>Sequence Diagram for Client Request</h3><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant Profile Service
    participant Inventory Service
    participant Order Service
    participant Shipment Service

    Client-&gt;&gt;API Gateway: HTTPS Request
    API Gateway-&gt;&gt;Profile Service: lb://profile-svc
    API Gateway-&gt;&gt;Inventory Service: lb://inventory-svc
    API Gateway-&gt;&gt;Order Service: lb://order-svc
    API Gateway-&gt;&gt;Shipment Service: lb://shipment-svc
    Profile Service--&gt;&gt;API Gateway: Response
    Inventory Service--&gt;&gt;API Gateway: Response
    Order Service--&gt;&gt;API Gateway: Response
    Shipment Service--&gt;&gt;API Gateway: Response
    API Gateway--&gt;&gt;Client: HTTPS Response</code></pre>

<h3 id="Sequence-Diagram-for-JWT-Authentication"><a href="#Sequence-Diagram-for-JWT-Authentication" class="headerlink" title="Sequence Diagram for JWT Authentication"></a>Sequence Diagram for JWT Authentication</h3><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant OAuth2 Service

    Client-&gt;&gt;API Gateway: HTTPS Request with JWT
    API Gateway-&gt;&gt;OAuth2 Service: Validate JWT
    OAuth2 Service--&gt;&gt;API Gateway: JWT Valid
    API Gateway--&gt;&gt;Client: HTTPS Response</code></pre>

<hr>
<p><a name="https-configuration-for-api-gateway"></a></p>
<h2 id="HTTPS-Configuration-for-API-Gateway"><a href="#HTTPS-Configuration-for-API-Gateway" class="headerlink" title="HTTPS Configuration for API Gateway"></a>HTTPS Configuration for API Gateway</h2><h3 id="Step-1-Generate-SSL-Certificate"><a href="#Step-1-Generate-SSL-Certificate" class="headerlink" title="Step 1: Generate SSL Certificate"></a>Step 1: Generate SSL Certificate</h3><p>Generate a self-signed SSL certificate or obtain one from a Certificate Authority (CA).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generate a self-signed certificate (for testing purposes)</span></span><br><span class="line">keytool -genkeypair -<span class="built_in">alias</span> api-gateway -keyalg RSA -keysize 2048 -storetype PKCS12 -keystore api-gateway-keystore.p12 -validity 365</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Configure-HTTPS-in-application-yml"><a href="#Step-2-Configure-HTTPS-in-application-yml" class="headerlink" title="Step 2: Configure HTTPS in application.yml"></a>Step 2: Configure HTTPS in <code>application.yml</code></h3><p>Add the keystore settings to <code>application.yml</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">ssl:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">key-store:</span> <span class="string">classpath:api-gateway-keystore.p12</span></span><br><span class="line">    <span class="attr">key-store-password:</span> <span class="string">your_password_here</span></span><br><span class="line">    <span class="attr">key-store-type:</span> <span class="string">PKCS12</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-3-Update-Routes-to-Use-lb"><a href="#Step-3-Update-Routes-to-Use-lb" class="headerlink" title="Step 3: Update Routes to Use lb://"></a>Step 3: Update Routes to Use <code>lb://</code></h3><p>Ensure that the routes use <code>lb://</code> to leverage service discovery and load balancing.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://profile-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://order-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">shipment_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://shipment-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/shipment/**</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-4-Update-Kubernetes-Ingress-for-HTTPS"><a href="#Step-4-Update-Kubernetes-Ingress-for-HTTPS" class="headerlink" title="Step 4: Update Kubernetes Ingress for HTTPS"></a>Step 4: Update Kubernetes Ingress for HTTPS</h3><p>Configure the Kubernetes Ingress to redirect traffic to the API Gateway’s HTTPS endpoint.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">api-gateway-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="difference-between-lb-and-http-protocols"></a></p>
<h2 id="Difference-Between-lb-and-http-Protocols"><a href="#Difference-Between-lb-and-http-Protocols" class="headerlink" title="Difference Between lb:// and http:// Protocols"></a>Difference Between <code>lb://</code> and <code>http://</code> Protocols</h2><h3 id="lb-Protocol"><a href="#lb-Protocol" class="headerlink" title="lb:// Protocol"></a><code>lb://</code> Protocol</h3><ul>
<li><strong>Service Discovery</strong>: Uses Kubernetes service discovery to find the appropriate service instance.</li>
<li><strong>Load Balancing</strong>: Automatically load balances requests across multiple instances of the service.</li>
<li><strong>Dynamic Routing</strong>: Routes can be dynamically updated based on service availability.</li>
</ul>
<p>Example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://profile-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br></pre></td></tr></table></figure>

<h3 id="http-Protocol"><a href="#http-Protocol" class="headerlink" title="http:// Protocol"></a><code>http://</code> Protocol</h3><ul>
<li><strong>Direct Routing</strong>: Routes requests directly to a specific URL.</li>
<li><strong>No Load Balancing</strong>: Does not provide load balancing or service discovery.</li>
<li><strong>Static Routing</strong>: Routes are static and do not change based on service availability.</li>
</ul>
<p>Example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://profile-svc:8080</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br></pre></td></tr></table></figure>

<h3 id="When-to-Use-Each-Protocol"><a href="#When-to-Use-Each-Protocol" class="headerlink" title="When to Use Each Protocol"></a>When to Use Each Protocol</h3><ul>
<li><strong>Use <code>lb://</code></strong> for routes within Kubernetes service discovery, allowing the gateway to leverage load balancing.</li>
<li><strong>Use <code>http://</code></strong> for direct routes to a specific URL or when no service discovery is available.</li>
</ul>
<p><a name="the-other-option"></a></p>
<h1 id="The-other-option"><a href="#The-other-option" class="headerlink" title="The other option"></a>The other option</h1><p>Here’s a step-by-step setup for building the API Gateway with JWT authentication and routing configurations:</p>
<h3 id="Step-1-Configure-API-Gateway-with-JWT-Authentication-and-Routing"><a href="#Step-1-Configure-API-Gateway-with-JWT-Authentication-and-Routing" class="headerlink" title="Step 1: Configure API Gateway with JWT Authentication and Routing"></a>Step 1: Configure API Gateway with JWT Authentication and Routing</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JwtAuthenticationFilter</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">roles:</span> <span class="string">&quot;ROLE_USER,ROLE_ADMIN&quot;</span>  <span class="comment"># Add roles if role-based access is needed</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># Enables dynamic route lookup from discovery service</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">StripPrefix=1</span>  <span class="comment"># Adjusts the path for downstream services</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">issuer-uri:</span> <span class="string">https://example-issuer.com</span>  <span class="comment"># Point to the JWT issuer</span></span><br><span class="line">          <span class="attr">jwk-set-uri:</span> <span class="string">https://example-issuer.com/.well-known/jwks.json</span>  <span class="comment"># Set up for validation</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Implement-JWT-Authentication-Filter-for-Gateway"><a href="#Step-2-Implement-JWT-Authentication-Filter-for-Gateway" class="headerlink" title="Step 2: Implement JWT Authentication Filter for Gateway"></a>Step 2: Implement JWT Authentication Filter for Gateway</h3><p>The custom JWT filter ensures each request includes a valid JWT token.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JwtAuthenticationFilter.java</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">GatewayFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtDecoder jwtDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(JwtDecoder jwtDecoder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jwtDecoder = jwtDecoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authHeader</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span> (authHeader != <span class="literal">null</span> &amp;&amp; authHeader.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> authHeader.substring(<span class="number">7</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> jwtDecoder.decode(token);  <span class="comment">// Validates the JWT</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);       <span class="comment">// If valid, proceed with the request</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">                exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">                <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Add the filter in <code>application.yml</code> for it to be applied to specific routes (like <code>inventory-service</code> in this case).</p>
<h3 id="Step-3-Building-and-Deploying-the-API-Gateway-as-a-Docker-Image"><a href="#Step-3-Building-and-Deploying-the-API-Gateway-as-a-Docker-Image" class="headerlink" title="Step 3: Building and Deploying the API Gateway as a Docker Image"></a>Step 3: Building and Deploying the API Gateway as a Docker Image</h3><ol>
<li><p><strong>Dockerfile</strong> for the API Gateway:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile for api-gateway</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE=target/api-gateway.jar</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;JAR_FILE&#125;</span> api-gateway.jar</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/api-gateway.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Build the Docker Image</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myregistry/api-gateway:latest .</span><br><span class="line">docker push myregistry/api-gateway:latest  <span class="comment"># Push to your registry</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes Deployment Configuration</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api-gateway-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">myregistry/api-gateway:latest</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Step-4-Service-to-Service-Communication-via-Gateway"><a href="#Step-4-Service-to-Service-Communication-via-Gateway" class="headerlink" title="Step 4: Service-to-Service Communication via Gateway"></a>Step 4: Service-to-Service Communication via Gateway</h3><p>Now, other services can call the gateway (using <code>api-gateway</code> service DNS) and append the target service’s route (<code>/inventory/*</code>) to the request path.</p>
<h4 id="Sample-Code-for-a-Downstream-Service-Request-Using-WebClient-with-JWT"><a href="#Sample-Code-for-a-Downstream-Service-Request-Using-WebClient-with-JWT" class="headerlink" title="Sample Code for a Downstream Service Request Using WebClient with JWT"></a>Sample Code for a Downstream Service Request Using WebClient with JWT</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ShipmentService.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShipmentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ShipmentService</span><span class="params">(WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClientBuilder</span><br><span class="line">                .baseUrl(<span class="string">&quot;http://api-gateway&quot;</span>)  <span class="comment">// Gateway URL in Kubernetes DNS</span></span><br><span class="line">                .defaultHeader(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + jwtToken)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Inventory <span class="title function_">getInventory</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.get()</span><br><span class="line">                .uri(<span class="string">&quot;/inventory/&quot;</span> + id)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .bodyToMono(Inventory.class)</span><br><span class="line">                .block();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Comparison-Gateway-vs-Interceptor-Based-JWT-Validation"><a href="#Comparison-Gateway-vs-Interceptor-Based-JWT-Validation" class="headerlink" title="Comparison: Gateway vs. Interceptor-Based JWT Validation"></a>Comparison: Gateway vs. Interceptor-Based JWT Validation</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>Gateway with JWT Filter</th>
<th>Service-Level JWT Interceptors</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Centralized Control</strong></td>
<td>All JWT validation centralized at gateway</td>
<td>Each service has independent JWT validation</td>
</tr>
<tr>
<td><strong>Configuration Complexity</strong></td>
<td>Easier for microservices, managed in gateway</td>
<td>More complex across multiple services</td>
</tr>
<tr>
<td><strong>Performance Overhead</strong></td>
<td>Can cause bottleneck at gateway if overloaded</td>
<td>Distributed load, but duplicate processing</td>
</tr>
<tr>
<td><strong>Resilience</strong></td>
<td>Single point of failure without redundancy</td>
<td>More resilient, distributed across services</td>
</tr>
<tr>
<td><strong>Authorization Flexibility</strong></td>
<td>Offers consistent authentication policy</td>
<td>Each service can implement role-based restrictions</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Microservice-meet-with-Spring-Cloud-and-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Microservice-meet-with-Spring-Cloud-and-Kubernetes/" class="post-title-link" itemprop="url">Microservice meet with Spring Cloud and Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-29 23:07:56" itemprop="dateCreated datePublished" datetime="2024-10-29T23:07:56-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-10-30 17:46:47" itemprop="dateModified" datetime="2024-10-30T17:46:47-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/" itemprop="url" rel="index"><span itemprop="name">Microservice</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/Spring-Cloud/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#high-level-architecture">High-Level Architecture</a></li>
<li><a href="#service-design">Service Design</a><ul>
<li><a href="#1-profile-service">1. Profile Service</a></li>
<li><a href="#2-inventory-service">2. Inventory Service</a></li>
<li><a href="#3-order-service">3. Order Service</a></li>
<li><a href="#4-shipment-service">4. Shipment Service</a></li>
<li><a href="#5-oauth2-service">5. OAuth2 Service</a></li>
</ul>
</li>
<li><a href="#kubernetes-deployment-and-service-discovery">Kubernetes Deployment and Service Discovery</a><ul>
<li><a href="#configuring-kubernetes-service-discovery-for-each-microservice">Configuring Kubernetes Service Discovery for Each Microservice</a></li>
<li><a href="#service-registration">Service Registration</a></li>
</ul>
</li>
<li><a href="#load-balancing-with-spring-cloud-loadbalancer">Load Balancing with Spring Cloud LoadBalancer</a></li>
<li><a href="#api-gateway-setup">API Gateway Setup</a><ul>
<li><a href="#routing-and-load-balancing">Routing and Load Balancing</a></li>
<li><a href="#configuring-jwt-authentication">Configuring JWT Authentication</a></li>
</ul>
</li>
<li><a href="#microservice-communication">Microservice Communication</a><ul>
<li><a href="#using-webclient-with-load-balancer">Using WebClient with Load Balancer</a></li>
<li><a href="#example-order-service-calls-profile-service">Example: Order Service Calls Profile Service</a></li>
</ul>
</li>
<li><a href="#securing-microservices">Securing Microservices</a><ul>
<li><a href="#jwt-authentication-with-api-gateway">JWT Authentication with API Gateway</a></li>
<li><a href="#alternative-jwt-validation-in-interceptors">Alternative: JWT Validation in Interceptors</a></li>
<li><a href="#pros-and-cons-of-jwt-and-mtls">Pros and Cons of JWT and mTLS</a></li>
</ul>
</li>
<li><a href="#ensuring-secure-microservice-communication">Ensuring Secure Microservice Communication</a><ul>
<li><a href="#step-1-configure-mutual-tls-mtls">Step 1: Configure Mutual TLS (mTLS)</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The objective is to design and deploy a group of microservices: Profile Service, Inventory Service, Order Service, Shipment Service, and an OAuth2 Service for centralized authentication. Key requirements include robust service discovery, API Gateway setup, secure communication, and efficient load balancing for high availability and fault tolerance in Kubernetes.</p>
<p><a name="high-level-architecture"></a></p>
<h2 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h2><p>Each microservice will be deployed in a Kubernetes cluster with multiple replicas, leveraging <strong>Spring Cloud Kubernetes Discovery</strong> for service registration and <strong>Spring Cloud LoadBalancer</strong> for client-side load balancing. An <strong>API Gateway</strong> will handle external requests, providing routing, load balancing, and JWT-based authentication. Communication between services is secured with <strong>JWT tokens</strong> generated by the <strong>OAuth2 Service</strong>.</p>
<p><a name="service-design"></a></p>
<h2 id="Service-Design"><a href="#Service-Design" class="headerlink" title="Service Design"></a>Service Design</h2><p>Each microservice is structured independently, deployed as a standalone Spring Boot application with individual responsibilities and access rules. Here’s an overview of the key services:</p>
<p><a name="profile-service"></a></p>
<h3 id="1-Profile-Service"><a href="#1-Profile-Service" class="headerlink" title="1. Profile Service"></a>1. Profile Service</h3><p>Manages customer profiles, providing endpoints for CRUD operations on profile data. Accessible to services like Order and Shipment for customer information retrieval.</p>
<p><a name="inventory-service"></a></p>
<h3 id="2-Inventory-Service"><a href="#2-Inventory-Service" class="headerlink" title="2. Inventory Service"></a>2. Inventory Service</h3><p>Tracks inventory levels and provides endpoints to update, retrieve, and manage inventory data. Called by the Order Service for real-time inventory status updates.</p>
<p><a name="order-service"></a></p>
<h3 id="3-Order-Service"><a href="#3-Order-Service" class="headerlink" title="3. Order Service"></a>3. Order Service</h3><p>Processes customer orders, calculates totals, and interfaces with Inventory and Profile Services. This service is central to the architecture, relying on other services for a smooth customer experience.</p>
<p><a name="shipment-service"></a></p>
<h3 id="4-Shipment-Service"><a href="#4-Shipment-Service" class="headerlink" title="4. Shipment Service"></a>4. Shipment Service</h3><p>Manages shipment tracking and logistics for orders, called by the Order Service once an order is processed and confirmed.</p>
<p><a name="oauth2-service"></a></p>
<h3 id="5-OAuth2-Service"><a href="#5-OAuth2-Service" class="headerlink" title="5. OAuth2 Service"></a>5. OAuth2 Service</h3><p>Acts as the authentication provider, issuing and validating JWT tokens for secure communication. The API Gateway uses these tokens to authenticate requests.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Order-Service              Auth-Service              Inventory-Service</span><br><span class="line">     |                              |                             |</span><br><span class="line">     |--- Request JWT -------------&gt;|                             |</span><br><span class="line">     |                              |                             |</span><br><span class="line">     |&lt;-- Receive JWT --------------|                             |</span><br><span class="line">     |                              |                             |</span><br><span class="line">     |--- Call Inventory ----------&gt;|                             |</span><br><span class="line">     |     (with JWT)               |                             |</span><br><span class="line">     |                              |--- Validate JWT------------&gt;|</span><br><span class="line">     |                              |                             |</span><br><span class="line">     |                              |&lt;-- JWT Valid/Invalid--------|</span><br><span class="line">     |                              |                             |</span><br><span class="line">     |&lt;-- Receive Inventory Data -- |                             |</span><br></pre></td></tr></table></figure>

<p><a name="kubernetes-deployment-and-service-discovery"></a></p>
<h2 id="Kubernetes-Deployment-and-Service-Discovery"><a href="#Kubernetes-Deployment-and-Service-Discovery" class="headerlink" title="Kubernetes Deployment and Service Discovery"></a>Kubernetes Deployment and Service Discovery</h2><p>Each service will be deployed to Kubernetes as a <code>Deployment</code> with multiple replicas and exposed via a <code>Service</code> to enable discovery. <strong>Spring Cloud Kubernetes</strong> is used for service registration and discovery.</p>
<p><a name="configuring-kubernetes-service-discovery-for-each-microservice"></a></p>
<h3 id="Configuring-Kubernetes-Service-Discovery-for-Each-Microservice"><a href="#Configuring-Kubernetes-Service-Discovery-for-Each-Microservice" class="headerlink" title="Configuring Kubernetes Service Discovery for Each Microservice"></a>Configuring Kubernetes Service Discovery for Each Microservice</h3><p>To set up service discovery in Kubernetes, add the following dependencies to your <code>pom.xml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-kubernetes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-kubernetes-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Configure the <code>application.yml</code> in <strong>each service</strong> to enable discovery:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">kubernetes:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#Enable service discovery</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">loadbalancer:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#Enable loadbalancer</span></span><br></pre></td></tr></table></figure>
<p>This configuration registers each service with Kubernetes’ internal DNS, allowing them to be discoverable by service name within the namespace. This way, each microservice is registered under its own Kubernetes service name, and can resolve other services (e.g., <a target="_blank" rel="noopener" href="http://inventory-service:8080/">http://inventory-service:8080</a>) when communicating with them. This configuration, combined with <code>Kubernetes DNS</code>, helps maintain an efficient, loosely coupled architecture.</p>
<blockquote>
<p><strong>Note</strong>: The <strong>Kubernetes Service Discovery configuration</strong> should indeed be included in each individual microservice’s configuration to ensure they can all register themselves with the Kubernetes DNS and be discoverable by other services in the namespace. This setup allows each microservice to dynamically locate and communicate with other services via Kubernetes’ internal DNS naming conventions.</p>
</blockquote>
<blockquote>
<p><strong>Why Configure Service Discovery in Each Microservice?</strong></p>
</blockquote>
<p>Each microservice is an independently deployed unit, so configuring <strong>Spring Cloud Kubernetes Discovery</strong> in each service’s <code>application.yml</code> allows it to:</p>
<ol>
<li><strong>Register with Kubernetes DNS</strong> under a unique service name, enabling internal routing across services.</li>
<li><strong>Access other services</strong> by simply using their service names, as Kubernetes DNS provides a consistent way to locate services within the cluster.</li>
</ol>
<blockquote>
<p><strong>Note</strong> Here you might be noticed that both the discovery and load balancer components are configured within each microservice. This design allows each microservice to dynamically discover the current instances of other services (using the <code>spring-cloud-kubernetes-discovery</code> integration) and balance requests among those instances using the <code>spring-cloud-loadbalancer</code> component.</p>
</blockquote>
<p><a name="service-registration"></a></p>
<h3 id="Service-Registration"><a href="#Service-Registration" class="headerlink" title="Service Registration"></a>Service Registration</h3><p>Each microservice is deployed as a separate <code>Deployment</code> and <code>Service</code> in Kubernetes. Here’s an example of the <code>inventory-service</code> Kubernetes configuration:</p>
<p>To deploy and register microservices like an <strong>Inventory Service</strong> in Kubernetes, we use Spring Cloud’s Kubernetes Discovery capabilities, allowing services to register with Kubernetes’ DNS-based service registry automatically.</p>
<blockquote>
<p><strong>Step 1</strong>: <strong>Create a Kubernetes Service and Deployment</strong> for each microservice:</p>
</blockquote>
<blockquote>
<blockquote>
<p>YAML files for defining the service and deployment:</p>
</blockquote>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># inventory-service-deployment.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">inventory-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">inventory</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>  <span class="comment"># Internal access within the cluster</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">inventory-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>  <span class="comment"># Number of instances (pods) of the Inventory Service</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">inventory</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">inventory</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">inventory</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myregistry/inventory-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>This configuration deploys <code>inventory-service</code> with two replicas, registered under the service name <code>inventory-service</code>. Other services can communicate with it via <code>http://inventory-service:8080</code>.</p>
<blockquote>
<blockquote>
<p><strong>More comprehensive explainations</strong><br>When deploying an <code>inventory-deployment</code> with two replicas, you will indeed see two pods running in parallel in the specified namespace. Kubernetes names these pods based on the deployment name, followed by a unique suffix (not just sequential numbers), so you may see pod names like <code>inventory-deployment-abc12</code> and <code>inventory-deployment-def34</code>.</p>
</blockquote>
</blockquote>
<p>In Kubernetes, these two pods are managed by a single <code>inventory-service</code> which acts as a layer of abstraction. When the client load balancer targets <code>inventory-service</code>, the service uses Kubernetes’ built-in load balancing to forward requests to one of the available <code>inventory-deployment</code> pods.</p>
<blockquote>
<blockquote>
<blockquote>
<p><strong>How Kubernetes Service Load Balancing Works</strong>:</p>
</blockquote>
</blockquote>
</blockquote>
<ol>
<li><strong>Service Abstraction:</strong> The <code>inventory-service</code> has a Cluster IP that exposes the service within the cluster. </li>
<li><strong>Endpoints Selection:</strong> The service maintains an updated list of active pod IPs (called “endpoints”) that match the deployment selector.</li>
<li><strong>Round-Robin Load Balancing:</strong> Kubernetes uses a round-robin approach by default. When a request reaches <code>inventory-service</code>, it selects one of the pod IPs associated with the deployment, balancing requests across pods automatically. The service doesn’t keep state; each request is independently forwarded to one of the pod replicas.</li>
</ol>
<blockquote>
<blockquote>
<blockquote>
<p><strong>Example Flow</strong>:</p>
</blockquote>
</blockquote>
</blockquote>
<ol>
<li><strong>Client Request:</strong> A client load balancer sends a request to the <code>inventory-service</code> endpoint.</li>
<li><strong>Service to Pod Routing:</strong> Kubernetes service routing picks an endpoint (pod IP) from the <code>inventory-deployment</code> pods and forwards the request to it.</li>
</ol>
<p>For better control and observability, custom load balancer configurations can also be implemented to fine-tune how the requests are distributed, especially in setups requiring sticky sessions or advanced routing.</p>
<blockquote>
<p><strong>Step 2</strong>: <strong>Register Service with Kubernetes Discovery</strong>:</p>
<blockquote>
<p>Spring Cloud Kubernetes automatically registers <code>inventory-service</code> based on the deployment labels. Enable Spring Cloud Discovery in your Spring Boot application via <code>@EnableDiscoveryClient</code>:<br>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryServiceApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(InventoryServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
</blockquote>
<blockquote>
<p><strong>Step 3</strong>: <strong>Configure Discovery in application.yml</strong>:<br>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">kubernetes:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">all-namespaces:</span> <span class="literal">true</span>  <span class="comment"># Optional: enables discovery across namespaces</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><a name="load-balancing"></a></p>
<h2 id="Load-Balancing-with-Spring-Cloud-LoadBalancer"><a href="#Load-Balancing-with-Spring-Cloud-LoadBalancer" class="headerlink" title="Load Balancing with Spring Cloud LoadBalancer"></a>Load Balancing with Spring Cloud LoadBalancer</h2><p>To efficiently distribute incoming requests across available instances, <strong>Spring Cloud LoadBalancer</strong> provides a client-side load-balancing solution, automatically distributing traffic among instances of a service.</p>
<blockquote>
<p>Enable Spring Cloud LoadBalancer by adding Spring Cloud LoadBalancer dependency:<br>   <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>Configure a <code>ServiceInstanceListSupplier</code> bean for custom load balancing behavior if required:<br>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.ServiceInstanceListSupplier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadBalancerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceListSupplier <span class="title function_">discoveryClientServiceInstanceListSupplier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceInstanceListSupplier.builder()</span><br><span class="line">                .withDiscoveryClient()</span><br><span class="line">                .withCaching()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>Set Up Load Balancer with WebClient</strong>:</p>
</blockquote>
<ul>
<li>Configure a <code>WebClient</code> bean with load balancing to distribute requests among <code>inventory-service</code> instances.</li>
</ul>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.client.WebClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> WebClient.Builder <span class="title function_">loadBalancedWebClientBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WebClient.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Use Load-Balanced WebClient</strong> in the calling service:<br>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient.Builder webClientBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InventoryClient</span><span class="params">(WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClientBuilder = webClientBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Product&gt; <span class="title function_">getProductById</span><span class="params">(String productId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClientBuilder.build()</span><br><span class="line">                .get()</span><br><span class="line">                .uri(<span class="string">&quot;http://inventory-service/products/&#123;id&#125;&quot;</span>, productId)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .bodyToMono(Product.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><strong>How Load Balancing Works</strong>:</p>
</blockquote>
<ul>
<li>Spring Cloud LoadBalancer, by default, uses a round-robin strategy to distribute requests.</li>
<li>It balances requests between the two <code>inventory-service</code> pods and automatically updates when new instances are added or removed.</li>
</ul>
<hr>
<ol start="3">
<li>By default, Spring Cloud LoadBalancer will round-robin requests to different instances, or customize by implementing a custom <code>LoadBalancerRequestTransformer</code>.</li>
</ol>
<p><a name="api-gateway-setup"></a></p>
<h2 id="API-Gateway-Setup"><a href="#API-Gateway-Setup" class="headerlink" title="API Gateway Setup"></a>API Gateway Setup</h2><p>The <strong>Spring Cloud API Gateway</strong> is deployed as a separate microservice, managing traffic and providing JWT-based authentication. The gateway routes requests to the appropriate services and load-balances among available replicas.</p>
<p><a name="routing-and-load-balancing"></a></p>
<h3 id="Routing-and-Load-Balancing"><a href="#Routing-and-Load-Balancing" class="headerlink" title="Routing and Load Balancing"></a>Routing and Load Balancing</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[External Client] --&gt; [API Gateway]</span><br><span class="line">                          |</span><br><span class="line">                          | (Discovers routes from Kubernetes Discovery)</span><br><span class="line">                          |</span><br><span class="line">                   [inventory-service] &lt;--+-- &quot;lb://inventory-service&quot;</span><br><span class="line">                   [shipment-service]  &lt;--+-- &quot;lb://shipment-service&quot;</span><br><span class="line">                   [order-service]     &lt;--+-- &quot;lb://order-service&quot;</span><br><span class="line">                   [profile-service]   &lt;--+-- &quot;lb://profile-service&quot;</span><br><span class="line">                   [other-service]     &lt;--+-- Discovered automatically</span><br></pre></td></tr></table></figure>

<p>Configure the gateway’s <code>application.yml</code> to define routes to each service:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://profile-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://inventory-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">TokenRelay</span></span><br></pre></td></tr></table></figure>

<p>The <strong>TokenRelay</strong> filter enables the gateway to forward JWT tokens to downstream services for authenticated requests.</p>
<p><a name="configuring-jwt-authentication"></a></p>
<h3 id="Configuring-JWT-Authentication"><a href="#Configuring-JWT-Authentication" class="headerlink" title="Configuring JWT Authentication"></a>Configuring JWT Authentication</h3><p>For security, JWT validation can be implemented in the gateway or within each service. Here’s how to configure JWT validation in the gateway:</p>
<ol>
<li><p>Add OAuth2 dependencies to the gateway:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Configure JWT validation in the gateway’s <code>application.yml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">issuer-uri:</span> <span class="string">https://auth-server/oauth2/default</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><a name="microservice-communication"></a></p>
<h2 id="Microservice-Communication"><a href="#Microservice-Communication" class="headerlink" title="Microservice Communication"></a>Microservice Communication</h2><p>Microservices communicate through <strong>Spring Cloud LoadBalancer</strong> and <strong>WebClient</strong>.</p>
<p><a name="using-webclient-with-load-balancer"></a></p>
<h3 id="Using-WebClient-with-Load-Balancer"><a href="#Using-WebClient-with-Load-Balancer" class="headerlink" title="Using WebClient with Load Balancer"></a>Using WebClient with Load Balancer</h3><p>To call the <code>inventory-service</code> from the <code>order-service</code>, configure <code>WebClient</code> with load balancing:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebClientConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebClient.Builder <span class="title function_">webClientBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WebClient.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="example-order-service-calls-profile-service"></a></p>
<h3 id="Example-Order-Service-Calls-Profile-Service"><a href="#Example-Order-Service-Calls-Profile-Service" class="headerlink" title="Example: Order Service Calls Profile Service"></a>Example: Order Service Calls Profile Service</h3><p>Here’s how <code>order-service</code> might call <code>profile-service</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient.Builder webClientBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderController</span><span class="params">(WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClientBuilder = webClientBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;OrderDetails&gt; <span class="title function_">getOrderDetails</span><span class="params">(<span class="meta">@PathVariable</span> String orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClientBuilder.build()</span><br><span class="line">            .get()</span><br><span class="line">            .uri(<span class="string">&quot;http://profile-service/profile/&#123;orderId&#125;&quot;</span>, orderId) <span class="comment">// The uri can be either http or lb(load balancer)</span></span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToMono(OrderDetails.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="securing-microservices"></a></p>
<h2 id="Securing-Microservices"><a href="#Securing-Microservices" class="headerlink" title="Securing Microservices"></a>Securing Microservices</h2><blockquote>
<p>Secure Communication with mTLS and JWT</p>
</blockquote>
<p><strong>mTLS (mutual TLS)</strong> and <strong>JWT (JSON Web Token)</strong> are two primary ways to secure communication between microservices.</p>
<ul>
<li><strong>mTLS</strong>: Ensures that both the client and server authenticate each other, useful in a zero-trust network.</li>
<li><strong>JWT</strong>: Adds stateless authentication, where each request includes a signed token with user and session data.</li>
</ul>
<p>Each microservice validates JWT tokens received from the gateway, ensuring secure and authenticated communication.</p>
<p><a name="jwt-authentication-with-api-gateway"></a></p>
<h3 id="JWT-Authentication-with-API-Gateway"><a href="#JWT-Authentication-with-API-Gateway" class="headerlink" title="JWT Authentication with API Gateway"></a>JWT Authentication with API Gateway</h3><p>JWT Authentication is often managed at the <strong>API Gateway</strong>, validating tokens and authorizing requests before forwarding them to services.</p>
<p>In this approach, JWT validation is centralized in the gateway. Tokens are verified at the gateway and forwarded to services, reducing the validation load on individual services.</p>
<blockquote>
<ol>
<li><strong>Add Spring Security Dependency</strong> for JWT support:<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li><strong>Configure JWT Verification in Gateway</strong>:<blockquote>
<p>Validate JWTs at the gateway level, allowing only authorized requests to reach downstream services.</p>
</blockquote>
</li>
</ol>
</blockquote>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/api/**&quot;</span>).authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .oauth2ResourceServer().jwt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="alternative-jwt-validation-in-interceptors"></a></p>
<h3 id="Alternative-JWT-Validation-in-Interceptors"><a href="#Alternative-JWT-Validation-in-Interceptors" class="headerlink" title="Alternative: JWT Validation in Interceptors"></a>Alternative: JWT Validation in Interceptors</h3><p>Alternatively, JWT validation can be handled within each microservice using a custom <strong>Interceptor</strong>, within services, add an <strong>Interceptor</strong> to validate JWTs before processing requests.</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="comment">// Verify the JWT token</span></span><br><span class="line">        <span class="comment">// Decode and validate claims</span></span><br><span class="line">        <span class="keyword">return</span> isValidToken(token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="pros-and-cons-of-jwt-and-mtls"></a></p>
<h3 id="Pros-and-Cons-of-JWT-and-mTLS"><a href="#Pros-and-Cons-of-JWT-and-mTLS" class="headerlink" title="Pros and Cons of JWT and mTLS"></a>Pros and Cons of JWT and mTLS</h3><table>
<thead>
<tr>
<th>Approach</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody><tr>
<td><strong>mTLS</strong></td>
<td>High security with mutual authentication.</td>
<td>Requires certificate management, adds complexity.</td>
</tr>
<tr>
<td><strong>JWT</strong></td>
<td>Stateless, easily scalable, widely supported.</td>
<td>Token expiration handling; replay attacks if not carefully implemented.</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;a name=&quot;kubernetes-deployment-and-auto-scaling&quot;&gt;&lt;/a&gt;</span><br><span class="line">## Kubernetes Deployment and Auto-scaling</span><br><span class="line"></span><br><span class="line">Scaling services dynamically is fundamental in Kubernetes. Kubernetes provides an effective way to handle **auto-scaling** of microservices based on resource utilization, e.g. CPU, memory, or custom metrics.</span><br><span class="line"></span><br><span class="line">Each microservice is balanced using **Spring Cloud LoadBalancer**, ensuring even distribution across replicas.</span><br><span class="line"></span><br><span class="line">&gt; **Step 1**: Configuring Horizontal Pod Autoscaler (HPA)</span><br><span class="line"></span><br><span class="line">1. Enable auto-scaling in Kubernetes based on CPU usage by defining an HPA resource.</span><br><span class="line"></span><br><span class="line">**inventory-hpa.yaml**</span><br><span class="line">```yaml</span><br><span class="line">apiVersion: autoscaling/v2beta2</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: inventory-hpa</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: inventory-deployment</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  targetCPUUtilizationPercentage: 75</span><br><span class="line">  metrics:</span><br><span class="line">    - type: Resource</span><br><span class="line">      resource:</span><br><span class="line">        name: cpu</span><br><span class="line">        target:</span><br><span class="line">          type: Utilization</span><br><span class="line">          averageUtilization: 50</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Step 2</strong>: Implementing Cluster Scaling</p>
</blockquote>
<p>Use Kubernetes’ Cluster Autoscaler for scaling nodes as workload demand grows, ensuring optimal resource use without manual intervention.</p>
<hr>
<p><a name="ensuring-secure-microservice-communication"></a></p>
<h2 id="Ensuring-Secure-Microservice-Communication"><a href="#Ensuring-Secure-Microservice-Communication" class="headerlink" title="Ensuring Secure Microservice Communication"></a>Ensuring Secure Microservice Communication</h2><p>Securing communication between services is critical. Use <strong>mTLS</strong> (mutual TLS) and <strong>JWT</strong> tokens for service-to-service authentication within Kubernetes clusters.</p>
<h3 id="Step-1-Configure-Mutual-TLS-mTLS"><a href="#Step-1-Configure-Mutual-TLS-mTLS" class="headerlink" title="Step 1: Configure Mutual TLS (mTLS)"></a>Step 1: Configure Mutual TLS (mTLS)</h3><p>Istio or Linkerd can help enforce mTLS between services:<br>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">your-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span></span><br></pre></td></tr></table></figure></p>
<hr>
<p><a name="summary"></a></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ol>
<li>Use <strong>ConfigMaps</strong> and <strong>Secrets</strong> for configuration.</li>
<li>Implement <strong>autoscaling</strong> with HPA.</li>
<li>Secure communication with <strong>mTLS</strong> and <strong>JWT</strong>.</li>
<li>Monitor with readiness&#x2F;liveness probes and <strong>Prometheus&#x2F;Grafana</strong>.</li>
</ol>
<p>This guide provides an architecture blueprint for deploying secure, scalable, and efficient microservices in Kubernetes using Spring Cloud. The API Gateway simplifies external access, service discovery, and JWT-based authentication, while Kubernetes ensures high availability and resilience across services.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Deep-Dive-into-Executors-and-ThreadPoolExecutor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Deep-Dive-into-Executors-and-ThreadPoolExecutor/" class="post-title-link" itemprop="url">Deep Dive into Executors and ThreadPoolExecutor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 11:08:29 / Modified: 12:22:51" itemprop="dateCreated datePublished" datetime="2024-10-29T11:08:29-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-overview-of-thread-pool-scaling-strategies">1. Overview of Thread Pool Scaling Strategies</a></li>
<li><a href="#2-fixedthreadpool---predictable-task-loads">2. FixedThreadPool - Predictable Task Loads</a></li>
<li><a href="#3-cachedthreadpool---unpredictable-short-lived-tasks">3. CachedThreadPool - Unpredictable, Short-Lived Tasks</a></li>
<li><a href="#4-dynamic-scaling-with-flexible-configuration">4. Dynamic Scaling with Flexible Configuration</a></li>
<li><a href="#detailed-steps">Detailed Steps</a></li>
<li><a href="#5-thread-pool-strategy-decision">5. Thread Pool Strategy Decision</a></li>
<li><a href="#6-drawbacks-of-using-executors-to-create-thread-pools">6. Drawbacks of Using <code>Executors</code> to Create Thread Pools</a></li>
<li><a href="#7-best-practices-solution-using-threadpoolexecutor-directly">7. Best Practices Solution: Using <code>ThreadPoolExecutor</code> Directly</a></li>
<li><a href="#8-threadpoolexecutor-with-best-practice-configurations">8. <code>ThreadPoolExecutor</code> with Best Practice Configurations</a></li>
<li><a href="#9-summary">9. Summary</a></li>
</ul>
<hr>
<p>Scaling a <strong>thread pool</strong> efficiently is essential to balance resource usage with workload demands, ensuring performance without over-provisioning or exhausting system resources. Below are common scaling strategies, including scenarios for using each and detailed production code examples with comments.</p>
<p><a name="1-overview-thread-pool-scaling-strategies"></a></p>
<h3 id="1-Overview-of-Thread-Pool-Scaling-Strategies"><a href="#1-Overview-of-Thread-Pool-Scaling-Strategies" class="headerlink" title="1. Overview of Thread Pool Scaling Strategies"></a>1. Overview of Thread Pool Scaling Strategies</h3><p>In thread pool management, the primary goal is to allocate <strong>just enough threads</strong> to handle tasks effectively without overloading the CPU or running into resource constraints. The <strong>Executor framework</strong> in Java provides tools for <strong>dynamic scaling</strong> via multiple built-in pool types and strategies, such as <code>FixedThreadPool</code> for predictable workloads and <code>CachedThreadPool</code> for on-demand scaling.</p>
<hr>
<p><a name="2-fixedthreadpool---predictable-task-loads"></a></p>
<h3 id="2-FixedThreadPool-Predictable-Task-Loads"><a href="#2-FixedThreadPool-Predictable-Task-Loads" class="headerlink" title="2. FixedThreadPool - Predictable Task Loads"></a>2. FixedThreadPool - Predictable Task Loads</h3><p>For workloads where the number of concurrent tasks is consistent or predictable, using a <code>FixedThreadPool</code> is efficient. The pool is created with a predefined number of threads, ensuring no new threads are added or removed during runtime. This strategy is suitable for <strong>batch processing</strong> or tasks with <strong>steady arrival rates</strong>.</p>
<p><strong>Sample Code</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="comment">// Define a pool with a fixed number of threads for predictable task load</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_POOL_SIZE</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(THREAD_POOL_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Simulate task submission to the fixed thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executorService.submit(() -&gt; processTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the executor service to release resources after processing</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">processTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Processing Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulating task processing duration</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Processing Task ID: 0 with thread pool-1-thread-1</span><br><span class="line">Processing Task ID: 1 with thread pool-1-thread-2</span><br><span class="line">Processing Task ID: 2 with thread pool-1-thread-3</span><br><span class="line">Processing Task ID: 3 with thread pool-1-thread-4</span><br><span class="line">Processing Task ID: 4 with thread pool-1-thread-5</span><br><span class="line">Processing Task ID: 5 with thread pool-1-thread-1</span><br><span class="line">Processing Task ID: 6 with thread pool-1-thread-2</span><br><span class="line">Processing Task ID: 7 with thread pool-1-thread-3</span><br><span class="line">Processing Task ID: 8 with thread pool-1-thread-4</span><br><span class="line">Processing Task ID: 9 with thread pool-1-thread-5</span><br></pre></td></tr></table></figure>

<p><strong>Explanation</strong>:</p>
<ol>
<li><p><strong>Thread Pool Initialization</strong>:</p>
<ul>
<li>A <strong>fixed number of threads</strong> (5) handle the tasks sequentially.</li>
<li>The thread pool is initialized with 5 threads, named <code>pool-1-thread-1</code> to <code>pool-1-thread-5</code>.</li>
</ul>
</li>
<li><p><strong>Task Submission</strong>:</p>
<ul>
<li>The <code>for</code> loop submits 10 tasks to the thread pool.</li>
<li>Each task is assigned a unique <code>taskId</code> from 0 to 9.</li>
</ul>
</li>
<li><p><strong>Task Execution</strong>:</p>
<ul>
<li>The tasks are executed by the available threads in the thread pool.</li>
<li>Since there are 5 threads, the first 5 tasks (0 to 4) are executed concurrently by the 5 threads.</li>
<li>After the first 5 tasks are completed, the next 5 tasks (5 to 9) are executed by the same threads, but the order of execution may vary.</li>
</ul>
</li>
<li><p><strong>Thread Reuse</strong>:</p>
<ul>
<li>The executor will <strong>reuse threads</strong>, limiting thread creation overhead.</li>
<li>The threads in the thread pool are reused to execute subsequent tasks. For example, <code>pool-1-thread-1</code> might execute task 0 and then task 5.</li>
</ul>
</li>
<li><p>The <strong><code>shutdown</code> method</strong> releases resources once all tasks complete.</p>
</li>
</ol>
<p><strong>Advantages:</strong> Predictable memory usage and better <strong>performance control</strong> for tasks with a steady rate.</p>
<hr>
<p><a name="cachedthreadpool---unpredictable-short-lived-tasks"></a></p>
<h3 id="3-CachedThreadPool-Unpredictable-Short-Lived-Tasks"><a href="#3-CachedThreadPool-Unpredictable-Short-Lived-Tasks" class="headerlink" title="3. CachedThreadPool - Unpredictable, Short-Lived Tasks"></a>3. CachedThreadPool - Unpredictable, Short-Lived Tasks</h3><p>A <code>CachedThreadPool</code> dynamically adjusts the pool size depending on task demand. This pool is ideal for handling <strong>bursty</strong> or <strong>sporadic loads</strong>. Threads are created as needed and, if idle, removed after a timeout period, allowing the system to scale back.</p>
<p><strong>Sample Code</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachedThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="comment">// Using CachedThreadPool for sporadic and short-lived tasks</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Simulate submitting bursty tasks</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executorService.submit(() -&gt; handleBurstTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown executor once all tasks are completed</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleBurstTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling Burst Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulating brief processing</span></span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Handling Burst Task ID: 0 with thread pool-1-thread-1</span><br><span class="line">Handling Burst Task ID: 1 with thread pool-1-thread-2</span><br><span class="line">Handling Burst Task ID: 2 with thread pool-1-thread-3</span><br><span class="line">Handling Burst Task ID: 3 with thread pool-1-thread-4</span><br><span class="line">Handling Burst Task ID: 4 with thread pool-1-thread-5</span><br><span class="line">Handling Burst Task ID: 5 with thread pool-1-thread-6</span><br><span class="line">Handling Burst Task ID: 6 with thread pool-1-thread-7</span><br><span class="line">Handling Burst Task ID: 7 with thread pool-1-thread-8</span><br><span class="line">Handling Burst Task ID: 8 with thread pool-1-thread-9</span><br><span class="line">Handling Burst Task ID: 9 with thread pool-1-thread-10</span><br></pre></td></tr></table></figure>

<p><strong>Explanation:</strong></p>
<ol>
<li><p><strong>Thread Pool Initialization</strong>:</p>
<ul>
<li>The <code>CachedThreadPool</code> <strong>adds threads on demand</strong> up to <code>Integer.MAX_VALUE</code>, suitable for short-lived tasks.</li>
<li>The <code>CachedThreadPool</code> dynamically creates new threads as needed and reuses previously constructed threads when they are available.</li>
</ul>
</li>
<li><p><strong>Task Submission</strong>:</p>
<ul>
<li>The <code>for</code> loop submits 10 tasks to the thread pool.</li>
<li>Each task is assigned a unique <code>taskId</code> from 0 to 9.</li>
</ul>
</li>
<li><p><strong>Task Execution</strong>:</p>
<ul>
<li>The tasks are executed by the available threads in the thread pool.</li>
<li>Since the <code>CachedThreadPool</code> creates new threads as needed, it will create up to 10 threads to handle the 10 tasks.</li>
</ul>
</li>
<li><p><strong>Thread Creation and Reuse</strong>:</p>
<ul>
<li>Threads that are <strong>idle for 60 seconds</strong> are removed, preventing memory buildup.</li>
<li>Ideal for systems that handle <strong>irregular spikes</strong> without knowing task demand in advance.</li>
<li>The <code>CachedThreadPool</code> creates new threads for each task initially because no threads are available.</li>
<li>The threads are named <code>pool-1-thread-1</code> to <code>pool-1-thread-10</code>.</li>
</ul>
</li>
</ol>
<p><strong>Advantages:</strong> Scalability and flexibility for <strong>dynamic task arrival rates</strong>.</p>
<hr>
<p><a name="4-dynamic-scaling-with-flexible-configuration"></a></p>
<h3 id="4-Dynamic-Scaling-with-Flexible-Configuration"><a href="#4-Dynamic-Scaling-with-Flexible-Configuration" class="headerlink" title="4. Dynamic Scaling with Flexible Configuration"></a>4. Dynamic Scaling with Flexible Configuration</h3><p>In a production environment, scaling thread pools dynamically may involve using the <code>ThreadPoolExecutor</code> with customized parameters, such as adjustable core pool size and task queue types. This allows for <strong>on-the-fly adjustments</strong> based on real-time performance metrics.</p>
<p><strong>Sample Code</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicThreadPoolScaling</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Custom ThreadPoolExecutor with flexible parameters for dynamic scaling</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">2</span>, <span class="comment">// corePoolSize</span></span><br><span class="line">            <span class="number">10</span>, <span class="comment">// maximumPoolSize</span></span><br><span class="line">            <span class="number">60L</span>, <span class="comment">// keepAliveTime</span></span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">5</span>), <span class="comment">// workQueue</span></span><br><span class="line">            Executors.defaultThreadFactory(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// Rejection policy</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executor.submit(() -&gt; performDynamicTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shut down the executor after tasks completion</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">performDynamicTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Performing Dynamic Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Explanation of Parameters:</strong></p>
<ul>
<li><code>corePoolSize</code>: Defines the <strong>minimum</strong> number of threads.</li>
<li><code>maximumPoolSize</code>: Sets a <strong>scalable limit</strong> for threads.</li>
<li><code>LinkedBlockingQueue</code>: Limits task queue to prevent memory overflows.</li>
<li><code>CallerRunsPolicy</code>: Ensures tasks run in the caller’s thread if limits are reached, providing <strong>backpressure control</strong>.</li>
</ul>
<p><strong>Output</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Performing Dynamic Task ID: 0 with thread pool-1-thread-1</span><br><span class="line">Performing Dynamic Task ID: 1 with thread pool-1-thread-2</span><br><span class="line">Performing Dynamic Task ID: 2 with thread pool-1-thread-1</span><br><span class="line">Performing Dynamic Task ID: 3 with thread pool-1-thread-2</span><br><span class="line">Performing Dynamic Task ID: 4 with thread pool-1-thread-1</span><br><span class="line">Performing Dynamic Task ID: 5 with thread pool-1-thread-2</span><br><span class="line">Performing Dynamic Task ID: 6 with thread pool-1-thread-1</span><br><span class="line">Performing Dynamic Task ID: 7 with thread pool-1-thread-2</span><br><span class="line">Performing Dynamic Task ID: 8 with thread pool-1-thread-1</span><br><span class="line">Performing Dynamic Task ID: 9 with thread pool-1-thread-2</span><br><span class="line">Performing Dynamic Task ID: 10 with thread pool-1-thread-3</span><br><span class="line">Performing Dynamic Task ID: 11 with thread pool-1-thread-4</span><br><span class="line">Performing Dynamic Task ID: 12 with thread pool-1-thread-5</span><br><span class="line">Performing Dynamic Task ID: 13 with thread pool-1-thread-6</span><br><span class="line">Performing Dynamic Task ID: 14 with thread pool-1-thread-7</span><br><span class="line">Performing Dynamic Task ID: 15 with thread pool-1-thread-8</span><br><span class="line">Performing Dynamic Task ID: 16 with thread pool-1-thread-9</span><br><span class="line">Performing Dynamic Task ID: 17 with thread pool-1-thread-10</span><br><span class="line">Performing Dynamic Task ID: 18 with thread main</span><br><span class="line">Performing Dynamic Task ID: 19 with thread main</span><br></pre></td></tr></table></figure>

<p><strong>Explaination of Output</strong>:</p>
<ol>
<li><p><strong>ThreadPoolExecutor Initialization</strong>:</p>
<ul>
<li>The <code>ThreadPoolExecutor</code> is initialized with:<ul>
<li><code>corePoolSize</code>: 2</li>
<li><code>maximumPoolSize</code>: 10</li>
<li><code>keepAliveTime</code>: 60 seconds</li>
<li><code>workQueue</code>: <code>LinkedBlockingQueue</code> with a capacity of 5</li>
<li><code>threadFactory</code>: Default thread factory</li>
<li><code>rejectionPolicy</code>: <code>CallerRunsPolicy</code></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Task Submission</strong>:</p>
<ul>
<li>The <code>for</code> loop submits 20 tasks to the thread pool.</li>
<li>Each task is assigned a unique <code>taskId</code> from 0 to 19.</li>
</ul>
</li>
<li><p><strong>Task Execution</strong>:</p>
<ul>
<li>Initially, the core threads (<code>pool-1-thread-1</code> and <code>pool-1-thread-2</code>) handle the first 2 tasks.</li>
<li>The next 5 tasks are queued in the <code>LinkedBlockingQueue</code>.</li>
<li>As the core threads finish their tasks, they pick up tasks from the queue.</li>
<li>When the queue is full (5 tasks), new threads are created up to the <code>maximumPoolSize</code> (10 threads) to handle the remaining tasks.</li>
<li>When all 10 threads are busy and the queue is full, the <code>CallerRunsPolicy</code> kicks in, and the remaining tasks are executed by the main thread (<code>main</code>).</li>
</ul>
</li>
</ol>
<h3 id="Detailed-Steps"><a href="#Detailed-Steps" class="headerlink" title="Detailed Steps"></a>Detailed Steps</h3><ol>
<li><p><strong>Task 0 to 1 Execution</strong>:</p>
<ul>
<li>Task 0 is executed by <code>pool-1-thread-1</code>.</li>
<li>Task 1 is executed by <code>pool-1-thread-2</code>.</li>
</ul>
</li>
<li><p><strong>Task 2 to 6 Queued</strong>:</p>
<ul>
<li>Tasks 2 to 6 are queued in the <code>LinkedBlockingQueue</code>.</li>
</ul>
</li>
<li><p><strong>Task 2 to 6 Execution</strong>:</p>
<ul>
<li>Tasks 2 to 6 are executed by <code>pool-1-thread-1</code> and <code>pool-1-thread-2</code> as they finish their initial tasks.</li>
</ul>
</li>
<li><p><strong>Task 7 to 11 Queued</strong>:</p>
<ul>
<li>Tasks 7 to 11 are queued in the <code>LinkedBlockingQueue</code>.</li>
</ul>
</li>
<li><p><strong>Task 7 to 11 Execution</strong>:</p>
<ul>
<li>Tasks 7 to 11 are executed by <code>pool-1-thread-1</code> and <code>pool-1-thread-2</code> as they finish their previous tasks.</li>
</ul>
</li>
<li><p><strong>Task 12 to 16 Execution</strong>:</p>
<ul>
<li>New threads (<code>pool-1-thread-3</code> to <code>pool-1-thread-7</code>) are created to handle tasks 12 to 16.</li>
</ul>
</li>
<li><p><strong>Task 17 to 19 Execution</strong>:</p>
<ul>
<li>New threads (<code>pool-1-thread-8</code> to <code>pool-1-thread-10</code>) are created to handle tasks 17 to 19.</li>
</ul>
</li>
<li><p><strong>Task 18 and 19 Execution by Main Thread</strong>:</p>
<ul>
<li>Since all threads are busy and the queue is full, the <code>CallerRunsPolicy</code> causes the main thread to execute tasks 18 and 19.</li>
</ul>
</li>
</ol>
<hr>
<p><a name="5-thread-pool-strategy-decision"></a></p>
<h3 id="5-Thread-Pool-Strategy-Decision"><a href="#5-Thread-Pool-Strategy-Decision" class="headerlink" title="5. Thread Pool Strategy Decision"></a>5. Thread Pool Strategy Decision</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        +-------------------------+</span><br><span class="line">        |  Task Load Predictable? |</span><br><span class="line">        +-----------+-------------+</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">           Yes      |       No</span><br><span class="line">         +----------+------------+</span><br><span class="line">         |                       |</span><br><span class="line"> +-------v----------+     +------v------------+</span><br><span class="line"> |  FixedThreadPool |     |  CachedThreadPool |</span><br><span class="line"> +-------+----------+     +-----+-------------+</span><br><span class="line">         |                      |</span><br><span class="line">         |                      |</span><br><span class="line">Use if tasks are steady    Use if tasks are bursty or</span><br><span class="line">and concurrent             unpredictable</span><br></pre></td></tr></table></figure>

<p>Using <code>Executors</code> to create thread pools (e.g., via <code>Executors.newFixedThreadPool()</code> or <code>Executors.newCachedThreadPool()</code>) is convenient but introduces hidden risks and drawbacks in certain production scenarios. Let’s look at the specific drawbacks and explore best practices for mitigating these issues.</p>
<hr>
<p><a name="6-drawbacks-of-using-executors-to-create-thread-pools"></a></p>
<h3 id="6-Drawbacks-of-Using-Executors-to-Create-Thread-Pools"><a href="#6-Drawbacks-of-Using-Executors-to-Create-Thread-Pools" class="headerlink" title="6. Drawbacks of Using Executors to Create Thread Pools"></a>6. Drawbacks of Using <code>Executors</code> to Create Thread Pools</h3><ol>
<li><p><strong>Unbounded Queue with <code>newFixedThreadPool</code></strong>:</p>
<ul>
<li>The <code>newFixedThreadPool(int nThreads)</code> method uses a <strong><code>LinkedBlockingQueue</code></strong> without a maximum size limit for its task queue. This <strong>unbounded queue</strong> can lead to <strong>memory exhaustion</strong> if tasks are submitted faster than they can be processed.</li>
<li>When a large number of tasks are added, the queue will keep growing, which can lead to <strong>OutOfMemoryError</strong> and system instability.</li>
</ul>
</li>
<li><p><strong>Unbounded Thread Creation in <code>newCachedThreadPool</code></strong>:</p>
<ul>
<li>The <code>newCachedThreadPool()</code> uses a <strong><code>SynchronousQueue</code></strong> that directly hands off tasks to threads. If no threads are idle to handle new tasks, it <strong>creates new threads</strong> up to <code>Integer.MAX_VALUE</code>.</li>
<li>With a high load, this pool may create excessive threads, leading to <strong>CPU saturation</strong> and potential <strong>memory exhaustion</strong>, especially in long-running applications.</li>
</ul>
</li>
<li><p><strong>Lack of Control Over Rejection Policy</strong>:</p>
<ul>
<li>The methods in <code>Executors</code> do not allow explicit configuration of <strong>rejection policies</strong> for when tasks exceed pool capacity. Default policies can fail to handle high-load scenarios gracefully, often leading to performance degradation and unhandled task rejections.</li>
</ul>
</li>
<li><p><strong>Harder to Manage Idle Threads</strong>:</p>
<ul>
<li>For pools like <code>newCachedThreadPool</code>, idle threads remain for a default <strong>60 seconds</strong> before being terminated. While this may be appropriate for some workloads, it can lead to inefficiencies in scenarios where <strong>shorter idle times</strong> would conserve resources.</li>
</ul>
</li>
</ol>
<hr>
<p><a name="7-best-practices-solution-using-threadpoolexecutor-directly"></a></p>
<h3 id="7-Best-Practices-Solution-Using-ThreadPoolExecutor-Directly"><a href="#7-Best-Practices-Solution-Using-ThreadPoolExecutor-Directly" class="headerlink" title="7. Best Practices Solution: Using ThreadPoolExecutor Directly"></a>7. Best Practices Solution: Using <code>ThreadPoolExecutor</code> Directly</h3><p>To avoid these pitfalls, it’s best to directly instantiate a <code>ThreadPoolExecutor</code> where you can <strong>explicitly configure</strong> the task queue size, rejection policies, and timeout values. Here’s how to address each issue with recommended configurations:</p>
<p>A. <strong>Configure Bounded Queues to Prevent Memory Leaks</strong>:</p>
<ul>
<li>Use a bounded task queue, like <code>ArrayBlockingQueue</code> or a sized <code>LinkedBlockingQueue</code>, to <strong>control the number of waiting tasks</strong> and prevent out-of-memory errors.</li>
<li>This limits the number of tasks waiting in the queue, ensuring system stability by capping memory use.</li>
</ul>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    corePoolSize,</span><br><span class="line">    maxPoolSize,</span><br><span class="line">    keepAliveTime,</span><br><span class="line">    TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(queueSize)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>B. <strong>Limit Thread Growth to Prevent Resource Exhaustion</strong>:</p>
<ul>
<li><p>Use a capped <code>maximumPoolSize</code> when tasks can surge unexpectedly. Setting a limit, e.g., based on the number of available CPU cores, helps prevent CPU saturation.</p>
<p>When tasks can surge unexpectedly, it’s crucial to set a capped <code>maximumPoolSize</code> to prevent the thread pool from creating an excessive number of threads. An unbounded <code>maximumPoolSize</code> can lead to CPU saturation, excessive memory usage, and degraded performance due to excessive context switching.</p>
<p><strong>CPU Saturation</strong><br>CPU saturation occurs when the CPU is overwhelmed with too many threads, leading to:</p>
<ul>
<li><strong>High CPU Utilization</strong>: The CPU spends most of its time executing threads, leaving little time for other system processes.</li>
<li><strong>Context Switching Overhead</strong>: Frequent context switching between threads consumes CPU cycles, reducing overall efficiency.</li>
<li><strong>Memory Pressure</strong>: Each thread consumes memory, and a large number of threads can lead to memory exhaustion.</li>
</ul>
<p>To prevent CPU saturation, it’s recommended to set a <code>maximumPoolSize</code> based on the number of available CPU cores. This ensures that the thread pool can handle a reasonable number of concurrent tasks without overwhelming the CPU.</p>
<p>A common approach is to set the <code>maximumPoolSize</code> to a value slightly higher than the number of CPU cores to account for both CPU-bound and I&#x2F;O-bound tasks. A simple formula is <code>maximumPoolSize = N * U</code></p>
<p>Where:</p>
<ul>
<li><strong>N</strong>: Number of available CPU cores.</li>
<li><strong>U</strong>: Utilization factor (typically between 1.0 and 2.0).<ul>
<li><strong>U &#x3D; 1.0</strong>: For CPU-bound tasks where each thread is expected to fully utilize a CPU core.</li>
<li><strong>U &#x3D; 1.5 to 2.0</strong>: For mixed CPU-bound and I&#x2F;O-bound tasks, where some threads may be waiting on I&#x2F;O operations.</li>
</ul>
</li>
</ul>
<p><strong>Example Calculation</strong><br>Suppose you have a system with 8 CPU cores and you expect a mix of CPU-bound and I&#x2F;O-bound tasks. You can set the <code>maximumPoolSize</code> as follows <code>maximumPoolSize = 8 * 1.5 = 12</code></p>
</li>
<li><p>For highly concurrent applications, you can use dynamic sizing strategies with <strong>monitoring metrics</strong> (like CPU and memory usage) to inform adjustments to pool parameters.</p>
</li>
</ul>
<p>C. <strong>Explicitly Set Rejection Policies</strong>:</p>
<ul>
<li>When tasks exceed the pool’s capacity, control the pool’s behavior with rejection policies. <code>ThreadPoolExecutor</code> provides options like <code>CallerRunsPolicy</code>, <code>DiscardPolicy</code>, and <code>DiscardOldestPolicy</code>:<ul>
<li><strong>CallerRunsPolicy</strong>: Executes tasks in the caller thread, which helps slow down task submissions under heavy load.</li>
<li><strong>DiscardOldestPolicy</strong>: Removes the oldest queued task, making room for newer, high-priority tasks.</li>
</ul>
</li>
<li>This choice depends on your application’s tolerance for unprocessed tasks.</li>
</ul>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    corePoolSize,</span><br><span class="line">    maxPoolSize,</span><br><span class="line">    keepAliveTime,</span><br><span class="line">    TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(queueSize),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>   <strong>Adjust Idle Timeout for Cached Threads</strong>:</p>
<ul>
<li>For pools similar to <code>CachedThreadPool</code>, customize the <strong>idle timeout</strong> to conserve resources by releasing threads sooner when they are not needed. <code>ThreadPoolExecutor</code> allows control over idle time with <code>setKeepAliveTime</code>.</li>
</ul>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">cachedPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">    <span class="number">30L</span>, TimeUnit.SECONDS, <span class="comment">// Reduced keep-alive time</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;(),</span><br><span class="line">    Executors.defaultThreadFactory()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="8-threadpoolexecutor-with-best-practice-configurations"></a></p>
<h3 id="8-ThreadPoolExecutor-with-Best-Practice-Configurations"><a href="#8-ThreadPoolExecutor-with-Best-Practice-Configurations" class="headerlink" title="8. ThreadPoolExecutor with Best Practice Configurations"></a>8. <code>ThreadPoolExecutor</code> with Best Practice Configurations</h3><p>Below is a best practice setup using <code>ThreadPoolExecutor</code> that incorporates bounded queues, a limited thread count, a suitable rejection policy, and a controlled idle timeout:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BestPracticeThreadPool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">createThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxPoolSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">keepAliveTime</span> <span class="operator">=</span> <span class="number">30L</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">queueCapacity</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                corePoolSize,</span><br><span class="line">                maxPoolSize,</span><br><span class="line">                keepAliveTime,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(queueCapacity),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// Rejection policy to handle overloads</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> createThreadPool();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submitting example tasks</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.submit(() -&gt; processTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Properly shutdown to free resources</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">processTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Processing Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>); <span class="comment">// Simulate work</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Explanation of Configurations:</strong></p>
<ul>
<li><code>ArrayBlockingQueue</code> limits queue size to 50, managing memory consumption.</li>
<li><code>CallerRunsPolicy</code> applies backpressure to slow down submissions.</li>
<li><code>corePoolSize</code> and <code>maxPoolSize</code> control CPU utilization.</li>
<li><code>keepAliveTime</code> of 30 seconds clears idle threads efficiently.</li>
</ul>
<hr>
<p><a name="9-summary"></a></p>
<h3 id="9-Summary"><a href="#9-Summary" class="headerlink" title="9. Summary"></a>9. Summary</h3><p>Using <code>ThreadPoolExecutor</code> directly provides complete control over pool configurations:</p>
<ul>
<li><strong>Bounded queues</strong> prevent memory overflows.</li>
<li><strong>Limited threads</strong> avoid CPU exhaustion.</li>
<li><strong>Rejection policies</strong> ensure controlled behavior under load.</li>
<li><strong>Idle timeouts</strong> conserve system resources.</li>
</ul>
<p>These adjustments create a resilient and scalable thread pool setup suitable for high-performance, resource-intensive applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Programming-Standards-of-Java-Concurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Programming-Standards-of-Java-Concurrency/" class="post-title-link" itemprop="url">Programming Standards of Java Concurrency</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 00:56:32 / Modified: 01:04:22" itemprop="dateCreated datePublished" datetime="2024-10-29T00:56:32-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Concurrency/" itemprop="url" rel="index"><span itemprop="name">Concurrency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Concurrency/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-thread-safety-in-singleton-objects">1. Thread Safety in Singleton Objects</a></li>
<li><a href="#2-meaningful-thread-naming">2. Meaningful Thread Naming</a></li>
<li><a href="#3-thread-pool-usage">3. Thread Pool Usage</a></li>
<li><a href="#4-explicit-threadpoolexecutor-configuration">4. Explicit ThreadPoolExecutor Configuration</a></li>
<li><a href="#5-thread-safe-date-formatting">5. Thread-Safe Date Formatting</a></li>
<li><a href="#6-threadlocal-variable-cleanup">6. ThreadLocal Variable Cleanup</a></li>
<li><a href="#7-locking-performance-considerations">7. Locking Performance Considerations</a></li>
<li><a href="#8-consistent-locking-order">8. Consistent Locking Order</a></li>
<li><a href="#9-exception-handling-in-locking">9. Exception Handling in Locking</a></li>
<li><a href="#10-optimistic-and-pessimistic-locking">10. Optimistic and Pessimistic Locking</a></li>
<li><a href="#11-scheduledexecutorservice-for-timed-tasks">11. ScheduledExecutorService for Timed Tasks</a></li>
<li><a href="#12-countdownlatch-for-synchronization">12. CountDownLatch for Synchronization</a></li>
<li><a href="#13-random-instance-management">13. Random Instance Management</a></li>
<li><a href="#14-double-checked-locking">14. Double-Checked Locking</a></li>
<li><a href="#15-volatile-and-atomic-operations">15. Volatile and Atomic Operations</a></li>
<li><a href="#16-hashmap-resize-risks">16. HashMap Resize Risks</a></li>
<li><a href="#17-threadlocal-usage">17. ThreadLocal Usage</a></li>
</ul>
<hr>
<p>Thread safety is a critical aspect of building robust and scalable Java applications. Ensuring that your application handles concurrent operations correctly can prevent many common issues such as race conditions, deadlocks, and data inconsistencies. This article provides best practices and detailed guidelines for achieving thread safety in Java applications.</p>
<hr>
<p><a name="1-thread-safety-in-singleton-objects"></a></p>
<h1 id="1-Thread-Safety-in-Singleton-Objects"><a href="#1-Thread-Safety-in-Singleton-Objects" class="headerlink" title="1. Thread Safety in Singleton Objects"></a>1. Thread Safety in Singleton Objects</h1><ul>
<li><strong>Requirement</strong>: Ensure that singleton objects and their methods are thread-safe.</li>
<li><strong>Explanation</strong>: Resource-driven classes, utility classes, and singleton factory classes must be thread-safe to prevent race conditions.</li>
</ul>
<p><a name="2-meaningful-thread-naming"></a></p>
<h1 id="2-Meaningful-Thread-Naming"><a href="#2-Meaningful-Thread-Naming" class="headerlink" title="2. Meaningful Thread Naming"></a>2. Meaningful Thread Naming</h1><ul>
<li><strong>Requirement</strong>: Assign meaningful names to threads and thread pools for easier debugging.</li>
<li><strong>Example</strong>: Custom thread factory with grouping based on external features (e.g., datacenter ID).</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">nextId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    UserThreadFactory(String whatFeaturOfGroup) &#123;</span><br><span class="line">        namePrefix = <span class="string">&quot;From UserThreadFactory&#x27;s &quot;</span> + whatFeaturOfGroup + <span class="string">&quot;-Worker-&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> namePrefix + nextId.getAndIncrement();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="literal">null</span>, task, name, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">        System.out.println(thread.getName());</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a name="3-thread-pool-usage"></a></p>
<h1 id="3-Thread-Pool-Usage"><a href="#3-Thread-Pool-Usage" class="headerlink" title="3. Thread Pool Usage"></a>3. Thread Pool Usage</h1><ul>
<li><strong>Requirement</strong>: Use thread pools instead of creating threads manually.</li>
<li><strong>Explanation</strong>: Thread pools reduce the overhead of thread creation and destruction, preventing resource exhaustion and excessive context switching.</li>
</ul>
<hr>
<p><a name="4-explicit-threadpoolexecutor-configuration"></a></p>
<h1 id="4-Explicit-ThreadPoolExecutor-Configuration"><a href="#4-Explicit-ThreadPoolExecutor-Configuration" class="headerlink" title="4. Explicit ThreadPoolExecutor Configuration"></a>4. Explicit ThreadPoolExecutor Configuration</h1><ul>
<li><strong>Requirement</strong>: Use <code>ThreadPoolExecutor</code> instead of <code>Executors</code> for creating thread pools.</li>
<li><strong>Explanation</strong>: <code>Executors</code> can lead to resource exhaustion due to unbounded queues and thread creation.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    corePoolSize, maxPoolSize, keepAliveTime, TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(queueCapacity),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">UserThreadFactory</span>(<span class="string">&quot;Datacenter-1&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="5-thread-safe-date-formatting"></a></p>
<h1 id="5-Thread-Safe-Date-Formatting"><a href="#5-Thread-Safe-Date-Formatting" class="headerlink" title="5. Thread-Safe Date Formatting"></a>5. Thread-Safe Date Formatting</h1><ul>
<li><strong>Requirement</strong>: Use thread-safe date formatting.</li>
<li><strong>Example</strong>: Use <code>ThreadLocal</code> for <code>SimpleDateFormat</code> or switch to <code>DateTimeFormatter</code> in JDK 8.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DateFormat&gt; df = ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>));</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="6-threadlocal-variable-cleanup"></a></p>
<h1 id="6-ThreadLocal-Variable-Cleanup"><a href="#6-ThreadLocal-Variable-Cleanup" class="headerlink" title="6. ThreadLocal Variable Cleanup"></a>6. ThreadLocal Variable Cleanup</h1><ul>
<li><strong>Requirement</strong>: Clean up <code>ThreadLocal</code> variables, especially in thread pools.</li>
<li><strong>Example</strong>: Use <code>try-finally</code> blocks to ensure cleanup.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">objectThreadLocal.set(userInfo);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    objectThreadLocal.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="7-locking-performance-considerations"></a></p>
<h1 id="7-Locking-Performance-Considerations"><a href="#7-Locking-Performance-Considerations" class="headerlink" title="7. Locking Performance Considerations"></a>7. Locking Performance Considerations</h1><ul>
<li><strong>Requirement</strong>: Minimize the performance impact of locks.</li>
<li><strong>Explanation</strong>: Prefer lock-free data structures, lock only necessary code blocks, and use object-level locks instead of class-level locks.</li>
</ul>
<hr>
<p><a name="8-consistent-locking-order"></a></p>
<h1 id="8-Consistent-Locking-Order"><a href="#8-Consistent-Locking-Order" class="headerlink" title="8. Consistent Locking Order"></a>8. Consistent Locking Order</h1><ul>
<li><strong>Requirement</strong>: Maintain consistent locking order to prevent deadlocks.</li>
<li><strong>Explanation</strong>: Ensure that all threads acquire locks in the same order to avoid circular wait conditions.</li>
</ul>
<hr>
<p><a name="9-exception-handling-in-locking"></a></p>
<h1 id="9-Exception-Handling-in-Locking"><a href="#9-Exception-Handling-in-Locking" class="headerlink" title="9. Exception Handling in Locking"></a>9. Exception Handling in Locking</h1><ul>
<li><strong>Requirement</strong>: Handle exceptions properly to avoid lock leaks.</li>
<li><strong>Example</strong>: Ensure that locks are released even if exceptions occur.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLocked</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line"><span class="keyword">if</span> (isLocked) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doSomething();</span><br><span class="line">        doOthers();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="10-optimistic-and-pessimistic-locking"></a></p>
<h1 id="10-Optimistic-and-Pessimistic-Locking"><a href="#10-Optimistic-and-Pessimistic-Locking" class="headerlink" title="10. Optimistic and Pessimistic Locking"></a>10. Optimistic and Pessimistic Locking</h1><ul>
<li><strong>Requirement</strong>: Use appropriate locking strategies based on conflict probability.</li>
<li><strong>Explanation</strong>: Use optimistic locking for low conflict scenarios and pessimistic locking for high conflict scenarios.</li>
</ul>
<hr>
<p><a name="11-scheduledexecutorservice-for-timed-tasks"></a></p>
<h1 id="11-ScheduledExecutorService-for-Timed-Tasks"><a href="#11-ScheduledExecutorService-for-Timed-Tasks" class="headerlink" title="11. ScheduledExecutorService for Timed Tasks"></a>11. ScheduledExecutorService for Timed Tasks</h1><ul>
<li><strong>Requirement</strong>: Use <code>ScheduledExecutorService</code> instead of <code>Timer</code> for concurrent timed tasks.</li>
<li><strong>Explanation</strong>: <code>Timer</code> can terminate all tasks if one throws an uncaught exception.</li>
</ul>
<hr>
<p><a name="12-countdownlatch-for-synchronization"></a></p>
<h1 id="12-CountDownLatch-for-Synchronization"><a href="#12-CountDownLatch-for-Synchronization" class="headerlink" title="12. CountDownLatch for Synchronization"></a>12. CountDownLatch for Synchronization</h1><ul>
<li><strong>Requirement</strong>: Use <code>CountDownLatch</code> for synchronization in multi-threaded tasks.</li>
<li><strong>Explanation</strong>: Ensure that all threads call <code>countDown</code> and handle exceptions to avoid blocking the main thread.</li>
</ul>
<hr>
<p><a name="13-random-instance-management"></a></p>
<h1 id="13-Random-Instance-Management"><a href="#13-Random-Instance-Management" class="headerlink" title="13. Random Instance Management"></a>13. Random Instance Management</h1><ul>
<li><strong>Requirement</strong>: Avoid sharing <code>Random</code> instances across threads.</li>
<li><strong>Example</strong>: Use <code>ThreadLocalRandom</code> in JDK 7+ or ensure each thread has its own <code>Random</code> instance.</li>
</ul>
<hr>
<p><a name="14-double-checked-locking"></a></p>
<h1 id="14-Double-Checked-Locking"><a href="#14-Double-Checked-Locking" class="headerlink" title="14. Double-Checked Locking"></a>14. Double-Checked Locking</h1><ul>
<li><strong>Requirement</strong>: Use <code>volatile</code> for double-checked locking to avoid initialization issues.</li>
<li><strong>Example</strong>: Declare the target variable as <code>volatile</code>.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">Helper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="15-volatile-and-atomic-operations"></a></p>
<h1 id="15-Volatile-and-Atomic-Operations"><a href="#15-Volatile-and-Atomic-Operations" class="headerlink" title="15. Volatile and Atomic Operations"></a>15. Volatile and Atomic Operations</h1><ul>
<li><strong>Requirement</strong>: Use <code>volatile</code> for one-write-many-read scenarios and <code>Atomic</code> classes for multi-write scenarios.</li>
<li><strong>Example</strong>: Use <code>AtomicInteger</code> or <code>LongAdder</code> for atomic operations.</li>
</ul>
<hr>
<p><a name="hashmap-resize-risks"></a></p>
<h1 id="16-HashMap-Resize-Risks"><a href="#16-HashMap-Resize-Risks" class="headerlink" title="16. HashMap Resize Risks"></a>16. HashMap Resize Risks</h1><ul>
<li><strong>Requirement</strong>: Be cautious of <code>HashMap</code> resizing in high-concurrency scenarios.</li>
<li><strong>Explanation</strong>: Resizing can lead to deadlocks and high CPU usage.</li>
</ul>
<hr>
<p><a name="threadlocal-usage"></a></p>
<h1 id="17-ThreadLocal-Usage"><a href="#17-ThreadLocal-Usage" class="headerlink" title="17. ThreadLocal Usage"></a>17. ThreadLocal Usage</h1><ul>
<li><strong>Requirement</strong>: Use <code>ThreadLocal</code> with static variables carefully.</li>
<li><strong>Explanation</strong>: <code>ThreadLocal</code> variables are shared within a thread but can cause issues if not managed properly.</li>
</ul>
<hr>
<p>By following these best practices, you can ensure that your Java application is thread-safe, scalable, and robust. These guidelines cover a wide range of scenarios, from basic thread safety to advanced concurrency patterns, helping you build high-performance applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Deep-Dive-into-Spring-Boot-Multi-Threading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Deep-Dive-into-Spring-Boot-Multi-Threading/" class="post-title-link" itemprop="url">Deep Dive into Spring Boot Multi-Threading</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 00:40:38 / Modified: 00:48:38" itemprop="dateCreated datePublished" datetime="2024-10-29T00:40:38-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Spring-Boot/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction-to-spring-boot-multi-threading">Introduction to Spring Boot Multi-Threading</a></li>
<li><a href="#best-practices-for-spring-boot-multi-threading">Best Practices for Spring Boot Multi-Threading</a></li>
<li><a href="#annotation-based-configuration">Annotation-Based Configuration</a></li>
<li><a href="#diagram-of-multi-threading-in-spring-boot">Diagram of Multi-Threading in Spring Boot</a></li>
<li><a href="#sample-code-with-detailed-comments">Sample Code with Detailed Comments</a><ul>
<li><a href="#configuration-class">Configuration Class</a></li>
<li><a href="#service-class">Service Class</a></li>
<li><a href="#controller-class">Controller Class</a></li>
<li><a href="#application-class">Application Class</a></li>
</ul>
</li>
<li><a href="#complex-scenario-1-flow-control-and-backpressure-handling">Complex Scenario 1: Flow Control and Backpressure Handling</a><ul>
<li><a href="#configuration-class-1">Configuration Class</a></li>
<li><a href="#service-class-1">Service Class</a></li>
<li><a href="#controller-class-1">Controller Class</a></li>
</ul>
</li>
<li><a href="#complex-scenario-2-task-prioritization">Complex Scenario 2: Task Prioritization</a><ul>
<li><a href="#configuration-class-2">Configuration Class</a></li>
<li><a href="#task-decorator">Task Decorator</a></li>
<li><a href="#service-class-2">Service Class</a></li>
<li><a href="#controller-class-2">Controller Class</a></li>
</ul>
</li>
<li><a href="#complex-scenario-3-handling-long-running-tasks">Complex Scenario 3: Handling Long-Running Tasks</a><ul>
<li><a href="#configuration-class-3">Configuration Class</a></li>
<li><a href="#service-class-3">Service Class</a></li>
<li><a href="#controller-class-3">Controller Class</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction-to-spring-boot-multi-threading"></a></p>
<h1 id="Introduction-to-Spring-Boot-Multi-Threading"><a href="#Introduction-to-Spring-Boot-Multi-Threading" class="headerlink" title="Introduction to Spring Boot Multi-Threading"></a>Introduction to Spring Boot Multi-Threading</h1><p>Spring Boot provides robust support for multi-threading, enabling developers to build highly concurrent and scalable applications. Leveraging multi-threading in Spring Boot can significantly improve the performance and responsiveness of your application. This article delves into best practices, annotation-based configuration, and real-life production scenarios to help you master multi-threading in Spring Boot.</p>
<hr>
<p><a name="best-practices-for-spring-boot-multi-threading"></a></p>
<h1 id="Best-Practices-for-Spring-Boot-Multi-Threading"><a href="#Best-Practices-for-Spring-Boot-Multi-Threading" class="headerlink" title="Best Practices for Spring Boot Multi-Threading"></a>Best Practices for Spring Boot Multi-Threading</h1><ol>
<li><strong>Use <code>@Async</code> for Asynchronous Processing</strong>: The <code>@Async</code> annotation allows methods to run in a separate thread, making it easy to implement asynchronous processing.</li>
<li><strong>Configure Thread Pools</strong>: Use <code>TaskExecutor</code> to configure thread pools with specific characteristics like core pool size, max pool size, and queue capacity.</li>
<li><strong>Handle Exceptions Gracefully</strong>: Implement exception handling mechanisms to manage exceptions that occur in asynchronous tasks.</li>
<li><strong>Monitor Thread Pools</strong>: Use Spring Boot Actuator to monitor thread pool metrics and ensure optimal performance.</li>
<li><strong>Avoid Blocking Operations</strong>: Ensure that asynchronous methods do not perform blocking operations, which can degrade performance.</li>
</ol>
<hr>
<p><a name="annotation-based-configuration"></a></p>
<h1 id="Annotation-Based-Configuration"><a href="#Annotation-Based-Configuration" class="headerlink" title="Annotation-Based Configuration"></a>Annotation-Based Configuration</h1><p>Spring Boot provides several annotations to configure and manage multi-threading:</p>
<ul>
<li><strong><code>@EnableAsync</code></strong>: Enables asynchronous processing in the application.</li>
<li><strong><code>@Async</code></strong>: Marks a method as asynchronous, meaning it will run in a separate thread.</li>
<li><strong><code>@Configuration</code></strong>: Indicates that a class declares one or more <code>@Bean</code> methods and may be processed by the Spring container to generate bean definitions.</li>
<li><strong><code>@Bean</code></strong>: Indicates that a method produces a bean to be managed by the Spring container.</li>
</ul>
<hr>
<p><a name="diagram-of-multi-threading-in-spring-boot"></a></p>
<h1 id="Diagram-of-Multi-Threading-in-Spring-Boot"><a href="#Diagram-of-Multi-Threading-in-Spring-Boot" class="headerlink" title="Diagram of Multi-Threading in Spring Boot"></a>Diagram of Multi-Threading in Spring Boot</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">| Spring Boot Application |</span><br><span class="line">| - @EnableAsync          |</span><br><span class="line">| - @Configuration        |</span><br><span class="line">| - @Bean                 |</span><br><span class="line">+-------------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| TaskExecutor      |</span><br><span class="line">| - corePoolSize    |</span><br><span class="line">| - maxPoolSize     |</span><br><span class="line">| - queueCapacity   |</span><br><span class="line">+-------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| @Async Methods    |</span><br><span class="line">| - Method1         |</span><br><span class="line">| - Method2         |</span><br><span class="line">+-------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| Thread Pool       |</span><br><span class="line">| - Thread 1        |</span><br><span class="line">| - Thread 2        |</span><br><span class="line">| - Thread 3        |</span><br><span class="line">+-------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| Task Execution    |</span><br><span class="line">| - Task 1          |</span><br><span class="line">| - Task 2          |</span><br><span class="line">| - Task 3          |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="sample-code-with-detailed-comments"></a></p>
<h1 id="Sample-Code-with-Detailed-Comments"><a href="#Sample-Code-with-Detailed-Comments" class="headerlink" title="Sample Code with Detailed Comments"></a>Sample Code with Detailed Comments</h1><h3 id="Configuration-Class"><a href="#Configuration-Class" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// Enable asynchronous processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;taskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">20</span>);  <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;AsyncThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class"><a href="#Service-Class" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;taskExecutor&quot;)</span> <span class="comment">// Use the taskExecutor bean for this method</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performAsyncTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Starting task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class"><a href="#Controller-Class" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/performTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">performTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        asyncService.performAsyncTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Task &quot;</span> + taskName + <span class="string">&quot; has been submitted for asynchronous processing.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Application-Class"><a href="#Application-Class" class="headerlink" title="Application Class"></a>Application Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// Enable asynchronous processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(AsyncApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-1-flow-control-and-backpressure-handling"></a></p>
<h1 id="Complex-Scenario-1-Flow-Control-and-Backpressure-Handling"><a href="#Complex-Scenario-1-Flow-Control-and-Backpressure-Handling" class="headerlink" title="Complex Scenario 1: Flow Control and Backpressure Handling"></a>Complex Scenario 1: Flow Control and Backpressure Handling</h1><p>In high-throughput systems, it’s crucial to manage the flow of tasks to avoid overwhelming the system. Backpressure handling ensures that the system can gracefully handle a large number of incoming tasks.</p>
<h3 id="Configuration-Class-1"><a href="#Configuration-Class-1" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackpressureConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;backpressureExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">backpressureExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">5</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>); <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">50</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;BackpressureThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class-1"><a href="#Service-Class-1" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackpressureService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;backpressureExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed handling task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class-1"><a href="#Controller-Class-1" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackpressureController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BackpressureService backpressureService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/handleTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        backpressureService.handleTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Task &quot;</span> + taskName + <span class="string">&quot; has been submitted for backpressure handling.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-2-task-prioritization"></a></p>
<h1 id="Complex-Scenario-2-Task-Prioritization"><a href="#Complex-Scenario-2-Task-Prioritization" class="headerlink" title="Complex Scenario 2: Task Prioritization"></a>Complex Scenario 2: Task Prioritization</h1><p>In some scenarios, certain tasks may need to be prioritized over others. Spring Boot allows you to configure task executors with priority queues to handle such cases.</p>
<h3 id="Configuration-Class-2"><a href="#Configuration-Class-2" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.PriorityBlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;priorityExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">priorityExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">5</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>); <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">50</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;PriorityThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.setTaskDecorator(<span class="keyword">new</span> <span class="title class_">PriorityTaskDecorator</span>()); <span class="comment">// Set task decorator for priority</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Task-Decorator"><a href="#Task-Decorator" class="headerlink" title="Task Decorator"></a>Task Decorator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.core.task.TaskDecorator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityTaskDecorator</span> <span class="keyword">implements</span> <span class="title class_">TaskDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Runnable <span class="title function_">decorate</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">            <span class="comment">// Set priority logic here</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Setting priority for task: &quot;</span> + runnable);</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class-2"><a href="#Service-Class-2" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;priorityExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">prioritizeTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Prioritizing task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed prioritizing task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class-2"><a href="#Controller-Class-2" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PriorityService priorityService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prioritizeTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">prioritizeTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        priorityService.prioritizeTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Task &quot;</span> + taskName + <span class="string">&quot; has been submitted for prioritization.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-3-handling-long-running-tasks"></a></p>
<h1 id="Complex-Scenario-3-Handling-Long-Running-Tasks"><a href="#Complex-Scenario-3-Handling-Long-Running-Tasks" class="headerlink" title="Complex Scenario 3: Handling Long-Running Tasks"></a>Complex Scenario 3: Handling Long-Running Tasks</h1><p>Long-running tasks can block threads and degrade system performance. Spring Boot provides mechanisms to handle such tasks efficiently.</p>
<h3 id="Configuration-Class-3"><a href="#Configuration-Class-3" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongRunningConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;longRunningExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">longRunningExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">5</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>); <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">50</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;LongRunningThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class-3"><a href="#Service-Class-3" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongRunningService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;longRunningExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLongRunningTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling long-running task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate long-running task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed handling long-running task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class-3"><a href="#Controller-Class-3" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongRunningController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LongRunningService longRunningService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/handleLongRunningTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleLongRunningTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        longRunningService.handleLongRunningTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Long-running task &quot;</span> + taskName + <span class="string">&quot; has been submitted for processing.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Spring Boot’s support for multi-threading allows developers to build highly concurrent and scalable applications. By following best practices and leveraging annotation-based configuration, you can efficiently manage asynchronous tasks, handle backpressure, prioritize tasks, and manage long-running tasks. This article provides a comprehensive guide to mastering multi-threading in Spring Boot, complete with detailed sample code and real-life production scenarios.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Create-a-Java-Thread-Pool-From-Scratch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Create-a-Java-Thread-Pool-From-Scratch/" class="post-title-link" itemprop="url">Create a Java Thread Pool From Scratch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-28 23:32:51" itemprop="dateCreated datePublished" datetime="2024-10-28T23:32:51-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-10-29 09:27:33" itemprop="dateModified" datetime="2024-10-29T09:27:33-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#custom-java-thread-pool-proof-of-concept">Custom Java Thread Pool: Proof of Concept</a><ul>
<li><a href="#implementation-of-simplethreadpool">Implementation of <code>SimpleThreadPool</code></a></li>
<li><a href="#explanation-of-key-concepts">Explanation of Key Concepts</a></li>
<li><a href="#sample-code-to-use-the-simplethreadpool">Sample Code to Use the <code>SimpleThreadPool</code></a><ul>
<li><a href="#explanation-of-sample-usage-code">Explanation of Sample Usage Code</a></li>
<li><a href="#expected-output">Expected Output</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#custom-java-thread-pool-with-separate-task-class">Custom Java Thread Pool with Separate Task Class</a><ul>
<li><a href="#task-class-implementation"><code>Task</code> Class Implementation</a></li>
<li><a href="#simplethreadpool-implementation"><code>SimpleThreadPool</code> Implementation</a></li>
<li><a href="#sample-code-to-use-the-custom-thread-pool-with-task">Sample Code to Use the Custom Thread Pool with <code>Task</code></a><ul>
<li><a href="#explanation-of-sample-usage">Explanation of Sample Usage</a></li>
<li><a href="#expected-output-1">Expected Output</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#wait-but-what-happened-to-the-terminated-thread">Wait but what happened to the terminated thread?</a><ul>
<li><a href="#enhanced-simplethreadpool-implementation">Enhanced <code>SimpleThreadPool</code> Implementation</a></li>
<li><a href="#enhanced-task-class-implementation">Enhanced <code>Task</code> Class Implementation</a></li>
<li><a href="#usage-and-state-transition-simulation">Usage and State Transition Simulation</a></li>
<li><a href="#explanation-of-the-workflow-and-state-transitions">Explanation of the Workflow and State Transitions</a></li>
<li><a href="#expected-output-sample">Expected Output (Sample)</a></li>
</ul>
</li>
<li><a href="#how-thread-being-actually-reused">How thread being actually reused?</a><ul>
<li><a href="#thread-states-in-a-thread-pool">Thread States in a Thread Pool</a></li>
<li><a href="#how-threads-are-reused">How Threads Are Reused</a></li>
<li><a href="#example-of-thread-reuse-in-simplethreadpool">Example of Thread Reuse in <code>SimpleThreadPool</code></a></li>
<li><a href="#code-example">Code Example</a></li>
<li><a href="#key-points">Key Points</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</li>
</ul>
<hr>
<p><a name="custom-java-thread-pool-proof-of-concept"></a></p>
<h1 id="Custom-Java-Thread-Pool-Proof-of-Concept"><a href="#Custom-Java-Thread-Pool-Proof-of-Concept" class="headerlink" title="Custom Java Thread Pool: Proof of Concept"></a>Custom Java Thread Pool: Proof of Concept</h1><p>In this article, we will create a simple but complete custom thread pool. We’ll build a <code>SimpleThreadPool</code> class that includes key features such as managing worker threads, a task queue, and shutdown capabilities. We’ll break down the code into logical components, explain the design concepts, and provide sample usage.</p>
<hr>
<p><a name="implementation-of-simplethreadpool"></a></p>
<h2 id="Implementation-of-SimpleThreadPool"><a href="#Implementation-of-SimpleThreadPool" class="headerlink" title="Implementation of SimpleThreadPool"></a>Implementation of <code>SimpleThreadPool</code></h2><p>The core classes in our implementation are:</p>
<ul>
<li><code>SimpleThreadPool</code>: Manages the thread pool and task queue.</li>
<li><code>Worker</code>: Represents the worker threads that execute tasks.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start worker threads</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>();</span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Submit a task to the thread pool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify workers that a task is available</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiates an orderly shutdown</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupt each worker to stop waiting</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Worker class represents threads in the pool</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Runnable task;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If shutdown and no tasks, end thread</span></span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Take task from queue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">// Execute task outside synchronized block</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="explanation-of-key-concepts"></a></p>
<h2 id="Explanation-of-Key-Concepts"><a href="#Explanation-of-Key-Concepts" class="headerlink" title="Explanation of Key Concepts"></a>Explanation of Key Concepts</h2><ol>
<li><strong>Task Queue</strong>: A <code>LinkedList</code> serves as the task queue, holding <code>Runnable</code> tasks for worker threads.</li>
<li><strong>Worker Threads</strong>: <code>PoolWorker</code> threads execute tasks. Each worker loops to fetch a task from the queue and processes it if available.</li>
<li><strong>Synchronization with <code>wait</code> and <code>notify</code></strong>:<ul>
<li><code>wait()</code>: Called when no tasks are available, putting the thread in a waiting state to save CPU resources.</li>
<li><code>notify()</code>: Called when a new task is added, waking up a worker thread to execute the task.</li>
</ul>
</li>
<li><strong>Graceful Shutdown</strong>:<ul>
<li><code>shutdown()</code>: Sets the <code>isShutdown</code> flag to stop accepting tasks and interrupts all worker threads, allowing them to exit if they’re waiting for a task.</li>
</ul>
</li>
</ol>
<hr>
<p><a name="sample-code-to-use-the-simplethreadpool"></a></p>
<h2 id="Sample-Code-to-Use-the-SimpleThreadPool"><a href="#Sample-Code-to-Use-the-SimpleThreadPool" class="headerlink" title="Sample Code to Use the SimpleThreadPool"></a>Sample Code to Use the <code>SimpleThreadPool</code></h2><p>This example demonstrates how to use the custom <code>SimpleThreadPool</code> to run tasks, including graceful shutdown.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with 3 threads</span></span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; is starting on thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>); <span class="comment">// Simulate task execution time</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the thread pool after tasks complete</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation-of-Sample-Usage-Code"><a href="#Explanation-of-Sample-Usage-Code" class="headerlink" title="Explanation of Sample Usage Code"></a>Explanation of Sample Usage Code</h3><ol>
<li><strong>Creating a Thread Pool</strong>: A <code>SimpleThreadPool</code> instance with 3 threads is created.</li>
<li><strong>Submitting Tasks</strong>: Five tasks are submitted to the pool, each of which simulates a brief work period.</li>
<li><strong>Shutting Down the Pool</strong>: After submitting the tasks, the pool is gracefully shut down using <code>shutdown()</code>.</li>
</ol>
<h3 id="Expected-Output"><a href="#Expected-Output" class="headerlink" title="Expected Output"></a>Expected Output</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Task 1 is starting on thread Thread-0</span><br><span class="line">Task 2 is starting on thread Thread-1</span><br><span class="line">Task 3 is starting on thread Thread-2</span><br><span class="line">Task 1 completed.</span><br><span class="line">Task 2 completed.</span><br><span class="line">Task 3 completed.</span><br><span class="line">Task 4 is starting on thread Thread-0</span><br><span class="line">Task 5 is starting on thread Thread-1</span><br><span class="line">Task 4 completed.</span><br><span class="line">Task 5 completed.</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This <code>SimpleThreadPool</code> is a demonstration of how a basic thread pool is structured and works:</p>
<ul>
<li><strong>Worker Threads</strong> repeatedly pick up and execute tasks from a shared queue.</li>
<li><strong>Synchronization</strong> between task producers and worker threads prevents busy-waiting.</li>
<li><strong>Graceful Shutdown</strong> lets worker threads exit safely after processing all queued tasks.</li>
</ul>
<p>This POC lays the foundation for understanding and extending Java thread pool management by illustrating how resources are managed and synchronized in a concurrent environment.</p>
<hr>
<p><a name="custom-java-thread-pool-with-separate-task-class"></a></p>
<h1 id="Custom-Java-Thread-Pool-with-Separate-Task-Class"><a href="#Custom-Java-Thread-Pool-with-Separate-Task-Class" class="headerlink" title="Custom Java Thread Pool with Separate Task Class"></a>Custom Java Thread Pool with Separate Task Class</h1><p>Separating the <code>Task</code> as an individual class will enhance the code’s modularity and flexibility, making it easier to reuse or extend for specific task-related features. Let’s modify the <code>SimpleThreadPool</code> implementation to include an external <code>Task</code> class.</p>
<p>Here’s the updated implementation:</p>
<ol>
<li><strong><code>SimpleThreadPool</code></strong>: Manages worker threads and the task queue.</li>
<li><strong><code>Task</code></strong>: Represents individual tasks, implementing <code>Runnable</code>.</li>
<li><strong><code>PoolWorker</code></strong>: Represents the worker threads that pick up tasks from the queue and execute them.</li>
</ol>
<hr>
<h2 id="Task-Class-Implementation"><a href="#Task-Class-Implementation" class="headerlink" title="Task Class Implementation"></a><code>Task</code> Class Implementation</h2><p>We’ll define <code>Task</code> as a standalone class that implements <code>Runnable</code>. Each task can have custom logic.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; is starting on thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// Simulate task execution time</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt(); <span class="comment">// Handle interruption</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>taskId</code></strong>: Each task is given an ID to identify it during execution.</li>
<li><strong><code>run()</code> Method</strong>: Defines the task’s actions, including a simulated delay.</li>
</ul>
<hr>
<h2 id="SimpleThreadPool-Implementation"><a href="#SimpleThreadPool-Implementation" class="headerlink" title="SimpleThreadPool Implementation"></a><code>SimpleThreadPool</code> Implementation</h2><p>The <code>SimpleThreadPool</code> class manages the task queue and distributes tasks among worker threads.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize and start each worker thread</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>();</span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Method to submit a task to the thread pool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify a waiting worker thread about the new task</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down and cannot accept tasks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiates shutdown and interrupts all waiting worker threads</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupts workers waiting for tasks</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Worker class that executes tasks from the queue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Runnable task;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a new task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// Exit if shutdown and no tasks are left</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Fetch a task</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">// Execute the task outside the synchronized block</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Sample-Code-to-Use-the-Custom-Thread-Pool-with-Task"><a href="#Sample-Code-to-Use-the-Custom-Thread-Pool-with-Task" class="headerlink" title="Sample Code to Use the Custom Thread Pool with Task"></a>Sample Code to Use the Custom Thread Pool with <code>Task</code></h2><p>This example demonstrates submitting <code>Task</code> instances to the <code>SimpleThreadPool</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with 3 threads</span></span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task</span>(i); <span class="comment">// Create a new Task with a unique ID</span></span><br><span class="line">            threadPool.submit(task);  <span class="comment">// Submit the Task to the thread pool</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the thread pool after tasks are complete</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation-of-Sample-Usage"><a href="#Explanation-of-Sample-Usage" class="headerlink" title="Explanation of Sample Usage"></a>Explanation of Sample Usage</h3><ol>
<li><strong>Task Creation</strong>: Each <code>Task</code> object has a unique ID, making it easy to track execution progress.</li>
<li><strong>Task Submission</strong>: Tasks are added to the <code>SimpleThreadPool</code>’s task queue.</li>
<li><strong>Shutdown</strong>: Once all tasks are submitted, <code>shutdown()</code> stops the pool after finishing queued tasks.</li>
</ol>
<h3 id="Expected-Output-1"><a href="#Expected-Output-1" class="headerlink" title="Expected Output"></a>Expected Output</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Task 1 is starting on thread Thread-0</span><br><span class="line">Task 2 is starting on thread Thread-1</span><br><span class="line">Task 3 is starting on thread Thread-2</span><br><span class="line">Task 1 completed.</span><br><span class="line">Task 2 completed.</span><br><span class="line">Task 3 completed.</span><br><span class="line">Task 4 is starting on thread Thread-0</span><br><span class="line">Task 5 is starting on thread Thread-1</span><br><span class="line">Task 4 completed.</span><br><span class="line">Task 5 completed.</span><br></pre></td></tr></table></figure>

<hr>
<p>This implementation improves modularity by allowing different <code>Task</code> implementations and extends the reusability of <code>SimpleThreadPool</code>. Each component (<code>Task</code>, <code>PoolWorker</code>, and <code>SimpleThreadPool</code>) is designed for flexible use in varied production scenarios.</p>
<hr>
<p><a name="wait-but-what-happened-to-the-terminated-thread"></a></p>
<h1 id="Wait-but-what-happened-to-the-terminated-thread"><a href="#Wait-but-what-happened-to-the-terminated-thread" class="headerlink" title="Wait but what happened to the terminated thread?"></a>Wait but what happened to the terminated thread?</h1><p>To demonstrate the behavior where a terminated thread in a thread pool is repurposed and moves back to the runnable state when a new task is added, we need to tweak the <code>SimpleThreadPool</code> to simulate this behavior. </p>
<p>Typically, when threads in a pool complete their tasks, they wait for new tasks rather than fully terminating (they don’t reach the “TERMINATED” state in Java’s built-in <code>ThreadPoolExecutor</code>). However, for demonstration, I’ll create logic that represents threads reaching a “stopped” state and being reactivated for new tasks.</p>
<p>Let’s add a mechanism to track the states and illustrate the thread reusability behavior.</p>
<hr>
<h3 id="Enhanced-SimpleThreadPool-Implementation"><a href="#Enhanced-SimpleThreadPool-Implementation" class="headerlink" title="Enhanced SimpleThreadPool Implementation"></a>Enhanced <code>SimpleThreadPool</code> Implementation</h3><p>Below is an enhanced version of <code>SimpleThreadPool</code> with thread state tracking. We’ll add logging and state simulation to show when threads are “terminated” and later reactivated when new tasks arrive.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize and start each worker thread</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>(i + <span class="number">1</span>); <span class="comment">// Assign a unique ID to each worker</span></span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Method to submit a task to the thread pool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify a waiting worker thread about the new task</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down and cannot accept tasks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiates shutdown and interrupts all waiting worker threads</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupts workers waiting for tasks</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Worker class that executes tasks from the queue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> workerId;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isTerminated</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">PoolWorker</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.workerId = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Runnable task;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is waiting for a task...&quot;</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a new task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is terminated.&quot;</span>);</span><br><span class="line">                            isTerminated = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is terminated as pool shuts down.&quot;</span>);</span><br><span class="line">                        isTerminated = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// Exit if shutdown and no tasks are left</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Fetch a task</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    isTerminated = <span class="literal">false</span>; <span class="comment">// Worker is active</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is executing task.&quot;</span>);</span><br><span class="line">                    task.run(); <span class="comment">// Execute the task</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; completed task and goes back to waiting.&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed in Worker-&quot;</span> + workerId + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Enhanced-Task-Class-Implementation"><a href="#Enhanced-Task-Class-Implementation" class="headerlink" title="Enhanced Task Class Implementation"></a>Enhanced <code>Task</code> Class Implementation</h3><p>The <code>Task</code> class remains mostly the same, but we can add unique identifiers to differentiate tasks.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; is starting on thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// Simulate task execution time</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt(); <span class="comment">// Handle interruption</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Usage-and-State-Transition-Simulation"><a href="#Usage-and-State-Transition-Simulation" class="headerlink" title="Usage and State Transition Simulation"></a>Usage and State Transition Simulation</h3><p>Let’s add a usage example showing how to submit tasks, observe workers entering a “terminated” state, and then reactivating to process new tasks.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with 2 workers</span></span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit initial tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">            threadPool.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait to let initial tasks complete</span></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit additional tasks to show reactivation</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Adding more tasks to test thread reactivation...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">4</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            threadPool.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Give some time for tasks to be picked up</span></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the thread pool</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation-of-the-Workflow-and-State-Transitions"><a href="#Explanation-of-the-Workflow-and-State-Transitions" class="headerlink" title="Explanation of the Workflow and State Transitions"></a>Explanation of the Workflow and State Transitions</h3><ol>
<li><strong>Initial Task Submission</strong>: Three tasks are submitted, and two workers pick them up immediately since the pool size is 2.</li>
<li><strong>Worker Reactivation</strong>: After the initial tasks complete, we add two more tasks, which are picked up by waiting workers.</li>
<li><strong>Shutdown Process</strong>: Finally, we shut down the thread pool, and the workers gracefully terminate after completing their tasks.</li>
</ol>
<h3 id="Expected-Output-Sample"><a href="#Expected-Output-Sample" class="headerlink" title="Expected Output (Sample)"></a>Expected Output (Sample)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Worker-1 is waiting for a task...</span><br><span class="line">Worker-2 is waiting for a task...</span><br><span class="line">Worker-1 is executing task.</span><br><span class="line">Task 1 is starting on thread Worker-1</span><br><span class="line">Worker-2 is executing task.</span><br><span class="line">Task 2 is starting on thread Worker-2</span><br><span class="line">Task 1 completed.</span><br><span class="line">Worker-1 completed task and goes back to waiting.</span><br><span class="line">Task 2 completed.</span><br><span class="line">Worker-2 completed task and goes back to waiting.</span><br><span class="line">Worker-1 is executing task.</span><br><span class="line">Task 3 is starting on thread Worker-1</span><br><span class="line">Task 3 completed.</span><br><span class="line">Worker-1 completed task and goes back to waiting.</span><br><span class="line">Worker-1 is waiting for a task...</span><br><span class="line">Worker-2 is waiting for a task...</span><br><span class="line"></span><br><span class="line">Adding more tasks to test thread reactivation...</span><br><span class="line">Worker-1 is executing task.</span><br><span class="line">Task 4 is starting on thread Worker-1</span><br><span class="line">Worker-2 is executing task.</span><br><span class="line">Task 5 is starting on thread Worker-2</span><br><span class="line">Task 4 completed.</span><br><span class="line">Worker-1 completed task and goes back to waiting.</span><br><span class="line">Task 5 completed.</span><br><span class="line">Worker-2 completed task and goes back to waiting.</span><br><span class="line">Worker-1 is terminated as pool shuts down.</span><br><span class="line">Worker-2 is terminated as pool shuts down.</span><br></pre></td></tr></table></figure>

<p>This output demonstrates that the workers remain active, go back to a waiting state after completing tasks, and terminate only after <code>shutdown()</code> is called.</p>
<p><a name="how-thread-being-acutally-reused"></a></p>
<h1 id="How-thread-being-actually-reused"><a href="#How-thread-being-actually-reused" class="headerlink" title="How thread being actually reused?"></a>How thread being actually reused?</h1><p>In a typical thread pool implementation, once a thread completes its task, it does not transition to the “TERMINATED” state and then back to the “RUNNABLE” state. Instead, the thread remains in a waiting state (often referred to as “idle” or “waiting for work”) until a new task is available. This waiting state is different from the “TERMINATED” state, which indicates that the thread has finished execution and cannot be reused.</p>
<p>Here’s a more detailed explanation:</p>
<h3 id="Thread-States-in-a-Thread-Pool"><a href="#Thread-States-in-a-Thread-Pool" class="headerlink" title="Thread States in a Thread Pool"></a>Thread States in a Thread Pool</h3><ol>
<li><strong>NEW</strong>: The thread has been created but not yet started.</li>
<li><strong>RUNNABLE</strong>: The thread is executing in the JVM.</li>
<li><strong>BLOCKED</strong>: The thread is blocked waiting for a monitor lock.</li>
<li><strong>WAITING</strong>: The thread is waiting indefinitely for another thread to perform a particular action.</li>
<li><strong>TIMED_WAITING</strong>: The thread is waiting for another thread to perform an action for up to a specified waiting time.</li>
<li><strong>TERMINATED</strong>: The thread has completed execution.</li>
</ol>
<p>In a thread pool, threads typically cycle between the <strong>RUNNABLE</strong> and <strong>WAITING</strong> states:</p>
<ul>
<li><strong>RUNNABLE</strong>: When a thread is actively executing a task.</li>
<li><strong>WAITING</strong>: When a thread is idle, waiting for a new task to be added to the queue.</li>
</ul>
<h3 id="How-Threads-Are-Reused"><a href="#How-Threads-Are-Reused" class="headerlink" title="How Threads Are Reused"></a>How Threads Are Reused</h3><p>When a thread completes its task, it checks the task queue for new tasks. If no tasks are available, the thread waits (using <code>wait()</code> or a similar mechanism) until a new task is submitted. This waiting state is not the same as the “TERMINATED” state. A thread in the “TERMINATED” state cannot be reused; it must be recreated, which is inefficient.</p>
<h3 id="Example-of-Thread-Reuse-in-SimpleThreadPool"><a href="#Example-of-Thread-Reuse-in-SimpleThreadPool" class="headerlink" title="Example of Thread Reuse in SimpleThreadPool"></a>Example of Thread Reuse in <code>SimpleThreadPool</code></h3><p>In the <code>SimpleThreadPool</code> example, threads are reused as follows:</p>
<ol>
<li><strong>Thread Creation</strong>: When the thread pool is created, a fixed number of worker threads are started.</li>
<li><strong>Task Execution</strong>: Each worker thread fetches a task from the queue and executes it.</li>
<li><strong>Waiting for New Tasks</strong>: After completing a task, the worker thread checks the queue for new tasks. If no tasks are available, it waits (<code>wait()</code>) until a new task is submitted.</li>
<li><strong>Reactivation</strong>: When a new task is submitted, the waiting threads are notified (<code>notify()</code>), and one of them wakes up to execute the new task.</li>
</ol>
<h3 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h3><p>Here’s a simplified version of the <code>SimpleThreadPool</code> to illustrate this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start worker threads</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>();</span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify a waiting worker thread</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupt each worker to stop waiting</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Runnable task;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// Exit if shutdown and no tasks are left</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Take task from queue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">// Execute task</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Key-Points"><a href="#Key-Points" class="headerlink" title="Key Points"></a>Key Points</h3><ul>
<li><strong>Thread Reuse</strong>: Threads do not transition to the “TERMINATED” state after completing a task. Instead, they wait for new tasks.</li>
<li><strong>Task Queue</strong>: The task queue holds tasks that are waiting to be executed. When a new task is submitted, a waiting thread is notified and picks up the task.</li>
<li><strong>Graceful Shutdown</strong>: The <code>shutdown()</code> method sets the <code>isShutdown</code> flag to stop accepting new tasks and interrupts all worker threads to ensure they exit if they are waiting.</li>
</ul>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>In Java’s <code>ThreadPoolExecutor</code> (or our custom pool example), the worker threads do <strong>not</strong> actually terminate after completing a task. Instead, they enter a <strong>waiting</strong> or <strong>idle state</strong> and wait to pick up the next task. The main goal of a thread pool is to reuse threads efficiently, keeping them alive for as long as the pool is running and ready to transition back to the <strong>runnable</strong> state whenever a new task becomes available. </p>
<p>Here’s how it works:</p>
<ol>
<li><strong>Runnable → Running</strong>: A thread in the pool becomes <strong>running</strong> when it starts executing a task.</li>
<li><strong>Running → Waiting&#x2F;Idle</strong>: Once it finishes the task, it doesn’t terminate. Instead, it returns to an <strong>idle state</strong> within the pool, waiting for more tasks to be added to the queue.</li>
<li><strong>Waiting → Runnable</strong>: When a new task is submitted, an idle worker transitions to <strong>runnable</strong> and executes the task.</li>
</ol>
<p>The threads only reach a <strong>terminated state</strong> when the pool itself is <strong>shut down</strong> (e.g., calling <code>shutdown()</code> in <code>ThreadPoolExecutor</code>). Only then will the threads stop, exit the idle&#x2F;waiting state, and go to terminated. This approach keeps the pool flexible and efficient, reducing the overhead of creating and destroying threads for every task. </p>
<p>So in short: threads in a thread pool <strong>do not reach terminated after completing tasks</strong>. They go back to idle&#x2F;waiting and can accept new tasks. And threads in a thread pool do not go back to the “RUNNABLE” state from the “TERMINATED” state neither. Instead, they remain in a waiting state until new tasks are available, ensuring efficient reuse of thread resources.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Deep-Dive-into-Java-Core-Multi-Threading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Deep-Dive-into-Java-Core-Multi-Threading/" class="post-title-link" itemprop="url">Deep Dive into Java Core Multi-Threading</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 23:17:03 / Modified: 23:31:03" itemprop="dateCreated datePublished" datetime="2024-10-28T23:17:03-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-introduction">1. Introduction</a></li>
<li><a href="#2-java-thread-pool-overview-and-components">2. Java Thread Pool: Overview and Components</a></li>
<li><a href="#3-core-terms-explained">3. Core Terms Explained</a><ul>
<li><a href="#task">Task</a></li>
<li><a href="#thread">Thread</a></li>
<li><a href="#worker">Worker</a></li>
<li><a href="#thread-pool">Thread Pool</a></li>
</ul>
</li>
<li><a href="#4-thread-lifecycle-in-a-thread-pool">4. Thread Lifecycle in a Thread Pool</a></li>
<li><a href="#5-thread-state-transitions">5. Thread State Transitions</a></li>
<li><a href="#6-sample-code-and-explanation">6. Sample Code and Explanation</a></li>
<li><a href="#7-handling-terminated-threads">7. Handling TERMINATED Threads</a><ul>
<li><a href="#what-happens-when-a-thread-reaches-terminated">What Happens When a Thread Reaches TERMINATED?</a></li>
<li><a href="#reuse-in-fixed-pools">Reuse in Fixed Pools</a></li>
<li><a href="#state-machine-transition">State Machine Transition</a></li>
</ul>
</li>
<li><a href="#8-conclusion">8. Conclusion</a></li>
</ul>
<hr>
<p>This article explores Java’s thread pool concept, detailing each component and state involved. We’ll cover tasks, threads, workers, thread pools, and the state transitions that occur during task execution. Detailed diagrams and annotated code examples demonstrate how each part interacts, making this a practical reference for developing multithreaded Java applications.</p>
<hr>
<p><a name="introduction"></a></p>
<h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>Java’s <code>ThreadPoolExecutor</code> provides a robust framework for managing a pool of worker threads that can efficiently process a series of asynchronous tasks. It’s designed to handle tasks without creating new threads for every request, conserving resources and reducing overhead. This article breaks down each term and component involved in a Java thread pool to provide a clear, practical understanding.</p>
<hr>
<p><a name="java-thread-pool-overview-and-components"></a></p>
<h2 id="2-Java-Thread-Pool-Overview-and-Components"><a href="#2-Java-Thread-Pool-Overview-and-Components" class="headerlink" title="2. Java Thread Pool: Overview and Components"></a>2. Java Thread Pool: Overview and Components</h2><p>A thread pool is a collection of threads that are managed to execute tasks concurrently. Rather than creating a new thread for every task, a pool of threads is reused, allowing efficient execution without constant thread creation and destruction.</p>
<p>Here’s a textual diagram illustrating a typical Java thread pool architecture:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------+</span><br><span class="line">|              Thread Pool                  |</span><br><span class="line">|-------------------------------------------|</span><br><span class="line">|                                           |</span><br><span class="line">|   Task Queue --&gt; [Task1] [Task2] [TaskN]  |</span><br><span class="line">|                                           |</span><br><span class="line">|        +-------------------------------+  |</span><br><span class="line">|        |           Worker Thread       |  |</span><br><span class="line">|        |-------------------------------|  |</span><br><span class="line">|        |    |--Thread-1--|--Running--| |  |</span><br><span class="line">|        |    |--Thread-2--|--Runnable-| |  |</span><br><span class="line">|        |    |--Thread-N--|--Waiting--| |  |</span><br><span class="line">|        +-------------------------------+  |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="core-terms-explained"></a></p>
<h2 id="3-Core-Terms-Explained"><a href="#3-Core-Terms-Explained" class="headerlink" title="3. Core Terms Explained"></a>3. Core Terms Explained</h2><h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><ul>
<li><strong>Definition</strong>: A <code>Runnable</code> or <code>Callable</code> object representing a unit of work.</li>
<li><strong>Purpose</strong>: The task contains logic that needs to be executed by a thread in the pool.</li>
</ul>
<h3 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h3><ul>
<li><strong>Definition</strong>: An individual worker capable of executing a task.</li>
<li><strong>States</strong>: Threads can be in various states, including <code>NEW</code>, <code>RUNNABLE</code>, <code>WAITING</code>, <code>TIMED_WAITING</code>, <code>BLOCKED</code>, and <code>TERMINATED</code>.</li>
</ul>
<h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><ul>
<li><strong>Definition</strong>: An entity within the thread pool that wraps a thread, providing task management.</li>
<li><strong>Role</strong>: Handles the execution of tasks by submitting them to a thread in the pool.</li>
</ul>
<h3 id="Thread-Pool"><a href="#Thread-Pool" class="headerlink" title="Thread Pool"></a>Thread Pool</h3><ul>
<li><strong>Definition</strong>: A collection of threads managed by an executor that oversees thread lifecycle and task allocation.</li>
<li><strong>Purpose</strong>: To improve performance by reusing threads for multiple tasks, avoiding the cost of creating and destroying threads frequently.</li>
</ul>
<hr>
<p><a name="thread-lifecycle-in-a-thread-pool"></a></p>
<h2 id="4-Thread-Lifecycle-in-a-Thread-Pool"><a href="#4-Thread-Lifecycle-in-a-Thread-Pool" class="headerlink" title="4. Thread Lifecycle in a Thread Pool"></a>4. Thread Lifecycle in a Thread Pool</h2><p>A thread in a pool goes through multiple states throughout its lifecycle. Let’s illustrate these states and transitions with a state diagram.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+-----------+</span><br><span class="line">|   NEW     |   -- Thread created</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| RUNNABLE  |   -- Thread ready to execute</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| RUNNING   |   -- Thread actively executing a task</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| BLOCKED   |   -- Thread blocked, waiting for a resource</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| WAITING   |   -- Thread waiting indefinitely for a condition</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| TERMINATED|   -- Thread completed execution or terminated</span><br><span class="line">+-----------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="thread-state-transitions"></a></p>
<h2 id="5-Thread-State-Transitions"><a href="#5-Thread-State-Transitions" class="headerlink" title="5. Thread State Transitions"></a>5. Thread State Transitions</h2><p>Each thread’s state changes as it progresses through its lifecycle:</p>
<ol>
<li><strong>NEW</strong>: The thread is created but has not yet started.</li>
<li><strong>RUNNABLE</strong>: The thread is ready to run but is waiting for CPU availability.</li>
<li><strong>RUNNING</strong>: The thread is actively running its assigned task.</li>
<li><strong>BLOCKED</strong>: The thread is waiting to acquire a lock to access a synchronized resource.</li>
<li><strong>WAITING&#x2F;TIMED_WAITING</strong>: The thread is waiting indefinitely or for a specified time, typically for task completion or resource availability.</li>
<li><strong>TERMINATED</strong>: The thread has completed its task and will either be recycled for a new task or discarded if no longer needed.</li>
</ol>
<hr>
<p><a name="sample-code-and-explanation"></a></p>
<h2 id="6-Sample-Code-and-Explanation"><a href="#6-Sample-Code-and-Explanation" class="headerlink" title="6. Sample Code and Explanation"></a>6. Sample Code and Explanation</h2><p>Below is a sample code demonstrating a thread pool with comments explaining each part of the process.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with a fixed number of threads</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit multiple tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            threadPool.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the pool after tasks are completed</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Task class implementing Runnable, representing a unit of work for the pool</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Executing Task &quot;</span> + taskId + <span class="string">&quot; with &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>); <span class="comment">// Simulate task duration</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example:</p>
<ul>
<li><strong>ThreadPoolExecutor</strong>: Manages a pool of three threads.</li>
<li><strong>Task</strong>: Each task simulates a job that runs for two seconds, allowing us to observe thread reuse.</li>
<li><strong>Thread</strong>: Each task is assigned a thread by the thread pool, which either executes it immediately or queues it until a thread becomes available.</li>
</ul>
<hr>
<p><a name="handling-terminated-threads"></a></p>
<h2 id="7-Handling-TERMINATED-Threads"><a href="#7-Handling-TERMINATED-Threads" class="headerlink" title="7. Handling TERMINATED Threads"></a>7. Handling TERMINATED Threads</h2><h3 id="What-Happens-When-a-Thread-Reaches-TERMINATED"><a href="#What-Happens-When-a-Thread-Reaches-TERMINATED" class="headerlink" title="What Happens When a Thread Reaches TERMINATED?"></a>What Happens When a Thread Reaches TERMINATED?</h3><p>Once a thread in the pool completes its task and reaches the <code>TERMINATED</code> state, it does not automatically return to <code>RUNNABLE</code>. In a fixed pool, the terminated thread is replaced by a new one, ensuring the pool maintains its core size. In cached pools, the thread may be recycled if the task load increases, maintaining efficiency.</p>
<h3 id="Reuse-in-Fixed-Pools"><a href="#Reuse-in-Fixed-Pools" class="headerlink" title="Reuse in Fixed Pools"></a>Reuse in Fixed Pools</h3><p>In fixed-size pools, a thread that terminates due to completion is usually retained within the pool as a worker for future tasks.</p>
<h3 id="State-Machine-Transition"><a href="#State-Machine-Transition" class="headerlink" title="State Machine Transition"></a>State Machine Transition</h3><p>The Java thread pool manages thread lifecycles by detecting <code>TERMINATED</code> threads and maintaining the required pool size by creating new threads as needed. This automatic management ensures the pool maintains availability and task-handling capacity.</p>
<hr>
<p><a name="conclusion"></a></p>
<h2 id="8-Conclusion"><a href="#8-Conclusion" class="headerlink" title="8. Conclusion"></a>8. Conclusion</h2><p>Java’s thread pool provides an efficient way to handle concurrent tasks by reusing threads and managing their lifecycles. Key concepts like tasks, threads, and workers work together to ensure a scalable, resource-efficient application structure. By understanding thread pool states, configurations, and transition mechanisms, developers can design more resilient and optimized concurrent applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Best-Practices-of-Java-Core-ThreadPoolExecutor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Best-Practices-of-Java-Core-ThreadPoolExecutor/" class="post-title-link" itemprop="url">Best Practices of Java Core ThreadPoolExecutor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-28 23:01:49" itemprop="dateCreated datePublished" datetime="2024-10-28T23:01:49-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-10-29 10:28:54" itemprop="dateModified" datetime="2024-10-29T10:28:54-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-why-executors-is-discouraged">1. Why Executors is Discouraged</a><ul>
<li><a href="#example-code-not-recommended">Example Code (Not Recommended)</a></li>
</ul>
</li>
<li><a href="#2-threadpoolexecutor-introduction">2. ThreadPoolExecutor Introduction</a></li>
<li><a href="#3-overview-of-threadpoolexecutor">3. Overview of <code>ThreadPoolExecutor</code></a></li>
<li><a href="#4-recommended-usage-threadpoolexecutor">4. Recommended Usage: ThreadPoolExecutor</a></li>
<li><a href="#5-core-configuration-parameters">5. Core Configuration Parameters</a><ul>
<li><a href="#best-practice-choose-configuration-values-based-on-workload-type-and-system-capacity">Best Practice: Choose configuration values based on workload type and system capacity.</a></li>
</ul>
</li>
<li><a href="#6-analyzing-executors-source-code">6. Analyzing Executors Source Code</a></li>
<li><a href="#7-threadpoolexecutor-constructors-and-parameters">7. ThreadPoolExecutor Constructors and Parameters</a><ul>
<li><a href="#parameter-breakdown">Parameter Breakdown</a></li>
</ul>
</li>
<li><a href="#8-advanced-queue-management">8. Advanced Queue Management</a><ul>
<li><a href="#relationships-between-corepoolsize-and-maximumpoolsize">Relationships between <code>corePoolSize</code> and <code>maximumPoolSize</code></a></li>
<li><a href="#understanding-workqueue-types">Understanding workQueue Types</a></li>
</ul>
</li>
<li><a href="#9-thread-pool-scaling-strategies">9. Thread Pool Scaling Strategies</a><ul>
<li><a href="#recommended-scaling">Recommended Scaling:</a></li>
</ul>
</li>
<li><a href="#10-rejectedexecutionhandler-strategies-for-handling-excess-tasks">10. RejectedExecutionHandler: Strategies for Handling Excess Tasks</a></li>
<li><a href="#11-enhanced-monitoring-techniques">11. Enhanced Monitoring Techniques</a></li>
<li><a href="#12-backpressure-handling-in-production">12. Backpressure Handling in Production</a><ul>
<li><a href="#diagram-dynamic-task-flow-and-backpressure">Diagram: Dynamic Task Flow and Backpressure</a></li>
</ul>
</li>
<li><a href="#13-example">13. Example</a></li>
<li><a href="#14-conclusion">14. Conclusion</a></li>
</ul>
<p><a name="1-why-executors-is-discouraged"></a></p>
<h2 id="1-Why-Executors-is-Discouraged"><a href="#1-Why-Executors-is-Discouraged" class="headerlink" title="1. Why Executors is Discouraged"></a>1. Why Executors is Discouraged</h2><p>Java’s <strong><code>Executors</code></strong> class provides several factory methods to create various types of thread pools:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newSingleThreadScheduledExecutor</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span></span><br></pre></td></tr></table></figure>

<p>These convenience methods simplify thread pool creation, but they do not allow fine-tuning. <strong>Using <code>Executors</code> to create thread pools is generally discouraged</strong> due to potential risks, such as resource exhaustion. The official guidance is to use <strong><code>ThreadPoolExecutor</code></strong> directly, enabling full control over pool configurations, ensuring stability under varying load conditions.</p>
<h3 id="Example-Code-Not-Recommended"><a href="#Example-Code-Not-Recommended" class="headerlink" title="Example Code (Not Recommended)"></a>Example Code (Not Recommended)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">es</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Why it’s discouraged</strong>: Creating a thread pool this way can lead to issues like uncontrolled resource usage. <strong>Best practice</strong>: use <code>ThreadPoolExecutor</code> instead.</p>
<p><a name="2-threadpoolexecutor-introduction"></a></p>
<h2 id="2-ThreadPoolExecutor-Introduction"><a href="#2-ThreadPoolExecutor-Introduction" class="headerlink" title="2. ThreadPoolExecutor Introduction"></a>2. ThreadPoolExecutor Introduction</h2><p>Java’s <code>ThreadPoolExecutor</code> is a cornerstone of concurrent programming. It provides a high-performance, versatile API for managing threads and handling tasks, but it requires careful configuration to prevent resource wastage, improve system responsiveness, and enhance maintainability.</p>
<hr>
<p><a name="3-overview-of-threadpoolexecutor"></a></p>
<h2 id="3-Overview-of-ThreadPoolExecutor"><a href="#3-Overview-of-ThreadPoolExecutor" class="headerlink" title="3. Overview of ThreadPoolExecutor"></a>3. Overview of <code>ThreadPoolExecutor</code></h2><p>The <code>ThreadPoolExecutor</code> manages thread allocation, scaling, and task queueing while optimizing thread lifecycle to minimize system overhead. Here is a basic textual model of a <code>ThreadPoolExecutor</code> lifecycle and memory model:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">          +-----------------------------+</span><br><span class="line">          |         Task Queue          |</span><br><span class="line">          |   (BlockingQueue&lt;Runnable&gt;) |</span><br><span class="line">          +------------+----------------+</span><br><span class="line">                       |</span><br><span class="line">     +-----------------v-----------------+</span><br><span class="line">     |                                   |</span><br><span class="line">     |       ThreadPoolExecutor          |</span><br><span class="line">     |                                   |</span><br><span class="line">     +----------------+------------------+</span><br><span class="line">                       |</span><br><span class="line">+----------------------+--------------------+</span><br><span class="line">|      Worker Threads                       |</span><br><span class="line">|   +-----------------------------------+   |</span><br><span class="line">|   |           Worker Thread 1         |   |</span><br><span class="line">|   |-----------------------------------|   |</span><br><span class="line">|   |           Worker Thread 2         |   |</span><br><span class="line">|   |-----------------------------------|   |</span><br><span class="line">|   |           Worker Thread N         |   |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Worker Threads</strong>: Execute tasks within a controlled environment.</li>
<li><strong>Task Queue</strong>: Holds tasks awaiting execution, preventing unnecessary thread creation.</li>
<li><strong>ThreadPoolExecutor</strong>: Controls the execution strategy, pool scaling, and task rejection policies.</li>
</ul>
<hr>
<p><a name="4-recommended-usage-threadpoolexecutor"></a></p>
<h2 id="4-Recommended-Usage-ThreadPoolExecutor"><a href="#4-Recommended-Usage-ThreadPoolExecutor" class="headerlink" title="4. Recommended Usage: ThreadPoolExecutor"></a>4. Recommended Usage: ThreadPoolExecutor</h2><p>To avoid risks, <strong>use <code>ThreadPoolExecutor</code></strong> directly for creating thread pools:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">es</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">10</span>), Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="5-core-configuration-parameters"></a></p>
<h2 id="5-Core-Configuration-Parameters"><a href="#5-Core-Configuration-Parameters" class="headerlink" title="5. Core Configuration Parameters"></a>5. Core Configuration Parameters</h2><p>The <code>ThreadPoolExecutor</code> relies on several key configuration parameters:</p>
<ul>
<li><strong>corePoolSize</strong>: Minimum number of threads in the pool.</li>
<li><strong>maximumPoolSize</strong>: Maximum threads allowed in the pool.</li>
<li><strong>keepAliveTime</strong>: The time a thread can remain idle before termination if beyond corePoolSize.</li>
<li><strong>workQueue</strong>: Queue holding tasks before they are assigned to threads.</li>
</ul>
<h4 id="Best-Practice-Choose-configuration-values-based-on-workload-type-and-system-capacity"><a href="#Best-Practice-Choose-configuration-values-based-on-workload-type-and-system-capacity" class="headerlink" title="Best Practice: Choose configuration values based on workload type and system capacity."></a>Best Practice: Choose configuration values based on workload type and system capacity.</h4><hr>
<p><a name="6-analyzing-executors-source-code"></a></p>
<h2 id="6-Analyzing-Executors-Source-Code"><a href="#6-Analyzing-Executors-Source-Code" class="headerlink" title="6. Analyzing Executors Source Code"></a>6. Analyzing Executors Source Code</h2><p>The methods <code>newSingleThreadExecutor()</code>, <code>newFixedThreadPool(int nThreads)</code>, and <code>newCachedThreadPool()</code> all internally use <strong><code>ThreadPoolExecutor</code></strong>. Below are the source code implementations from JDK 8:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;())</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All three methods use <strong><code>ThreadPoolExecutor</code></strong> but provide different default configurations. These static methods abstract parameters, which can lead to undesired behaviors under high loads.</p>
<p><a name="7-threadpoolexecutor-constructors-and-parameters"></a></p>
<h2 id="7-ThreadPoolExecutor-Constructors-and-Parameters"><a href="#7-ThreadPoolExecutor-Constructors-and-Parameters" class="headerlink" title="7. ThreadPoolExecutor Constructors and Parameters"></a>7. ThreadPoolExecutor Constructors and Parameters</h2><p>When creating thread pools with <code>ThreadPoolExecutor</code>, initializing parameters must be specified. One of its constructors takes the following parameters:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize, <span class="type">int</span> maximumPoolSize, <span class="type">long</span> keepAliveTime, TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>

<h3 id="Parameter-Breakdown"><a href="#Parameter-Breakdown" class="headerlink" title="Parameter Breakdown"></a>Parameter Breakdown</h3><ul>
<li><strong><code>corePoolSize</code></strong>: Number of threads to keep in the pool.</li>
<li><strong><code>maximumPoolSize</code></strong>: Maximum number of threads allowed.</li>
<li><strong><code>keepAliveTime</code></strong>: Time limit for idle threads over <code>corePoolSize</code> before termination.</li>
<li><strong><code>unit</code></strong>: Unit of time for <code>keepAliveTime</code>.</li>
<li><strong><code>workQueue</code></strong>: Queue to hold tasks before execution.</li>
<li><strong><code>threadFactory</code></strong>: Factory for creating threads, usually <code>Executors.defaultThreadFactory()</code>.</li>
<li><strong><code>handler</code></strong>: Policy for handling tasks when the pool reaches its limit.</li>
</ul>
<p><a name="8-advanced-queue-management"></a></p>
<h2 id="8-Advanced-Queue-Management"><a href="#8-Advanced-Queue-Management" class="headerlink" title="8. Advanced Queue Management"></a>8. Advanced Queue Management</h2><p><strong>Choosing the Right Queue</strong>:</p>
<ol>
<li><strong>SynchronousQueue</strong>: No internal capacity, ideal for transient spikes.</li>
<li><strong>LinkedBlockingQueue</strong>: Unbounded, suitable for long-running processes.</li>
<li><strong>ArrayBlockingQueue</strong>: Fixed size, optimal for bounded workloads.</li>
</ol>
<blockquote>
<p><strong>Note</strong>: Select a queue type aligned with task load, duration, and resource availability.</p>
</blockquote>
<h3 id="Relationships-between-corePoolSize-and-maximumPoolSize"><a href="#Relationships-between-corePoolSize-and-maximumPoolSize" class="headerlink" title="Relationships between corePoolSize and maximumPoolSize"></a>Relationships between <code>corePoolSize</code> and <code>maximumPoolSize</code></h3><ul>
<li>If <strong><code>thread count &lt; corePoolSize</code></strong>, a new thread is created for each task.</li>
<li>If <strong><code>thread count &gt;= corePoolSize</code></strong>, tasks are added to the <strong>task queue</strong>.</li>
<li>If the <strong>queue is full</strong> and <strong><code>thread count &lt; maximumPoolSize</code></strong>, a new thread is created.</li>
<li>If <strong><code>thread count &gt;= maximumPoolSize</code></strong>, the <code>handler</code> policy determines the behavior.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: These relationships vary with the type of queue (bounded or unbounded). Unbounded queues will prevent maximum thread creation from being reached.</p>
</blockquote>
<p><a name="understanding-workqueue-types"></a></p>
<h3 id="Understanding-workQueue-Types"><a href="#Understanding-workQueue-Types" class="headerlink" title="Understanding workQueue Types"></a>Understanding workQueue Types</h3><p>The <strong><code>workQueue</code></strong> holds pending tasks that await execution. Different queue types handle tasks differently:</p>
<ul>
<li><strong><code>SynchronousQueue</code></strong>: A <strong>direct hand-off</strong> mechanism with no capacity. If no thread is immediately available, a new one is created or the task is rejected based on <code>maximumPoolSize</code>.</li>
<li><strong><code>LinkedBlockingQueue</code></strong>: An <strong>unbounded queue</strong>. When tasks exceed <code>corePoolSize</code>, they are added to the queue instead of creating new threads. <strong>Warning</strong>: Unbounded growth may exhaust memory if tasks are generated faster than processed.</li>
<li></li>
</ul>
<hr>
<p><a name="9-thread-pool-scaling-strategies"></a></p>
<h2 id="9-Thread-Pool-Scaling-Strategies"><a href="#9-Thread-Pool-Scaling-Strategies" class="headerlink" title="9. Thread Pool Scaling Strategies"></a>9. Thread Pool Scaling Strategies</h2><p>Efficient scaling balances resource use against workload demands. Consider using dynamic scaling mechanisms for responsive systems.</p>
<h4 id="Recommended-Scaling"><a href="#Recommended-Scaling" class="headerlink" title="Recommended Scaling:"></a>Recommended Scaling:</h4><ul>
<li><strong>FixedThreadPool</strong>: When task load and timing are predictable.</li>
<li><strong>CachedThreadPool</strong>: For unpredictable or short-lived task loads.</li>
</ul>
<hr>
<p><a name="10-rejectedexecutionhandler-strategies-for-handling-excess-tasks"></a></p>
<h2 id="10-RejectedExecutionHandler-Strategies-for-Handling-Excess-Tasks"><a href="#10-RejectedExecutionHandler-Strategies-for-Handling-Excess-Tasks" class="headerlink" title="10. RejectedExecutionHandler: Strategies for Handling Excess Tasks"></a>10. RejectedExecutionHandler: Strategies for Handling Excess Tasks</h2><p>When the pool and queue are full, the <strong><code>handler</code></strong> parameter specifies a strategy to handle tasks. Java provides four built-in policies:</p>
<ul>
<li><strong><code>DiscardOldestPolicy</code></strong>: Removes the oldest task in the queue to accommodate the new task.</li>
<li><strong><code>CallerRunsPolicy</code></strong>: Executes the task in the <strong>caller thread</strong> if the pool is busy, providing a backpressure mechanism.</li>
<li><strong><code>DiscardPolicy</code></strong>: Silently discards the task without further action.</li>
<li><strong><code>AbortPolicy</code></strong>: Throws an <strong>exception</strong> to signal that the pool is at capacity.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: Customize <code>RejectedExecutionHandler</code> based on workload characteristics. Expecially for applications where resilience is critical, <strong>consider implementing a custom rejection handler</strong> or using <code>CallerRunsPolicy</code> to limit load. Proper configuration can prevent issues like out-of-memory errors.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RejectedExecutionHandler</span> <span class="variable">customHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionHandler</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task rejected: &quot;</span> + r.toString());</span><br><span class="line">        <span class="comment">// custom logic for rejected task</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="11-enhanced-monitoring-techniques"></a></p>
<h2 id="11-Enhanced-Monitoring-Techniques"><a href="#11-Enhanced-Monitoring-Techniques" class="headerlink" title="11. Enhanced Monitoring Techniques"></a>11. Enhanced Monitoring Techniques</h2><p>Monitoring thread and queue activity is essential for real-time scaling and troubleshooting. Use the following tools and approaches:</p>
<ul>
<li><strong>JMX (Java Management Extensions)</strong>: For real-time metrics on threads, tasks, and system load.</li>
<li><strong>Thread Pool Executor’s <code>getPoolSize</code> and <code>getQueue().size()</code> Methods</strong>: To track runtime capacity and pending task counts.</li>
</ul>
<hr>
<p><a name="12-backpressure-handling-in-production"></a></p>
<h2 id="12-Backpressure-Handling-in-Production"><a href="#12-Backpressure-Handling-in-Production" class="headerlink" title="12. Backpressure Handling in Production"></a>12. Backpressure Handling in Production</h2><p>Backpressure handling in high-demand environments prevents overloads by controlling the flow of tasks:</p>
<ul>
<li><strong>Rejection Policies</strong>: Define fallback strategies for rejected tasks.</li>
<li><strong>Queue Sizing</strong>: Set boundaries on task input rate.</li>
</ul>
<h4 id="Diagram-Dynamic-Task-Flow-and-Backpressure"><a href="#Diagram-Dynamic-Task-Flow-and-Backpressure" class="headerlink" title="Diagram: Dynamic Task Flow and Backpressure"></a>Diagram: Dynamic Task Flow and Backpressure</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Client Requests</span><br><span class="line">      |</span><br><span class="line"> +----v----+     Backpressure Control</span><br><span class="line"> | Task    |--------------------+</span><br><span class="line"> | Queue   |                    |</span><br><span class="line"> +---------+                    |</span><br><span class="line">       |                        |</span><br><span class="line">+------v-------+                |</span><br><span class="line">| Thread       |                |</span><br><span class="line">| Pool         |                |</span><br><span class="line">+--------------+----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="13-example"></a></p>
<h2 id="13-Example"><a href="#13-Example" class="headerlink" title="13. Example"></a>13. Example</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedThreadPoolExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Configure core parameters with scaling strategy</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">4</span>,                <span class="comment">// core pool size</span></span><br><span class="line">            <span class="number">10</span>,               <span class="comment">// maximum pool size</span></span><br><span class="line">            <span class="number">30</span>,               <span class="comment">// keep-alive time</span></span><br><span class="line">            TimeUnit.SECONDS, <span class="comment">// keep-alive time unit</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">100</span>), <span class="comment">// task queue type</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// rejection policy</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Simulate task submission</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">            executor.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">        Task(<span class="type">int</span> taskId) &#123;</span><br><span class="line">            <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Executing Task &quot;</span> + taskId);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>); <span class="comment">// Simulate work</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="14-conclusion"></a></p>
<h2 id="14-Conclusion"><a href="#14-Conclusion" class="headerlink" title="14. Conclusion"></a>14. Conclusion</h2><p><strong>Summary</strong>: Use <code>ThreadPoolExecutor</code> directly with appropriately sized pools, tailored queue types, and effective rejection policies to ensure optimal, safe performance. Mastering <code>ThreadPoolExecutor</code> for complex, production-grade applications requires an understanding of core parameters, workload patterns, and monitoring needs. These best practices are intended to improve performance, efficiency, and system resilience in multithreaded environments.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
