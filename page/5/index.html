<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/page/5/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">112</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/11/03/Best-Practices-of-Using-the-find-Command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/03/Best-Practices-of-Using-the-find-Command/" class="post-title-link" itemprop="url">Best Practices of Using the find Command</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-11-03 11:34:35 / Modified: 11:51:16" itemprop="dateCreated datePublished" datetime="2024-11-03T11:34:35-05:00">2024-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/CLI/" itemprop="url" rel="index"><span itemprop="name">CLI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#basic-usage">Basic Usage</a><ul>
<li><a href="#-find-files-by-name"> Find Files by Name</a></li>
<li><a href="#-find-files-by-wildcard-pattern"> Find Files by Wildcard Pattern</a></li>
<li><a href="#-find-files-by-content"> Find Files by Content</a></li>
<li><a href="#-search-in-subdirectories"> Search in Subdirectories</a></li>
</ul>
</li>
<li><a href="#advanced-search-criteria">Advanced Search Criteria</a><ul>
<li><a href="#-find-files-by-owner"> Find Files by Owner</a></li>
<li><a href="#-find-files-by-date-and-time"> Find Files by Date and Time</a></li>
</ul>
</li>
<li><a href="#combining-with-other-commands">Combining with Other Commands</a><ul>
<li><a href="#-using-xargs"> Using <code>xargs</code></a></li>
<li><a href="#-using-grep"> Using <code>grep</code></a></li>
<li><a href="#-using-awk"> Using <code>awk</code></a></li>
</ul>
</li>
<li><a href="#advanced-scenarios">Advanced Scenarios</a><ul>
<li><a href="#-find-and-delete-files"> Find and Delete Files</a></li>
<li><a href="#-find-and-move-files"> Find and Move Files</a></li>
<li><a href="#-find-and-copy-files"> Find and Copy Files</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#appendix">Appendix</a><ul>
<li><a href="#using-xargs">Using <code>xargs</code></a></li>
<li><a href="#explanation">Explanation</a></li>
<li><a href="#benefits-of-using-xargs">Benefits of Using <code>xargs</code></a></li>
<li><a href="#example">Example</a></li>
<li><a href="#using-curly-brackets-">Using curly brackets <code>&#123;&#125;</code></a></li>
<li><a href="#command-breakdown">Command Breakdown</a></li>
<li><a href="#example-1">Example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The <code>find</code> command is a powerful tool in Unix-like operating systems for searching files and directories based on various criteria such as name, type, size, owner, date, and more. This article provides a comprehensive guide to the best practices of using the <code>find</code> command, covering various scenarios such as finding files by name, content, owner, date, and combining <code>find</code> with other commands using pipelines.</p>
<hr>
<p><a name="basic-usage"></a></p>
<h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><h3 id="Find-Files-by-Name"><a href="#Find-Files-by-Name" class="headerlink" title=" Find Files by Name"></a><a name="find-files-by-name"></a> Find Files by Name</h3><p>To find files by name, use the <code>-name</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;filename.txt&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Find-Files-by-Wildcard-Pattern"><a href="#Find-Files-by-Wildcard-Pattern" class="headerlink" title=" Find Files by Wildcard Pattern"></a><a name="find-files-by-wildcard-pattern"></a> Find Files by Wildcard Pattern</h3><p>To find files using a wildcard pattern, use the <code>-name</code> option with wildcards:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.log&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Find-Files-by-Content"><a href="#Find-Files-by-Content" class="headerlink" title=" Find Files by Content"></a><a name="find-files-by-content"></a> Find Files by Content</h3><p>To find files containing specific content, use the <code>-exec</code> option with <code>grep</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -<span class="built_in">type</span> f -<span class="built_in">exec</span> grep -l <span class="string">&quot;search_string&quot;</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<h3 id="Search-in-Subdirectories"><a href="#Search-in-Subdirectories" class="headerlink" title=" Search in Subdirectories"></a><a name="search-in-subdirectories"></a> Search in Subdirectories</h3><p>By default, <code>find</code> searches in all subdirectories. You can specify the starting directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;filename.txt&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="advanced-search-criteria"></a></p>
<h2 id="Advanced-Search-Criteria"><a href="#Advanced-Search-Criteria" class="headerlink" title="Advanced Search Criteria"></a>Advanced Search Criteria</h2><h3 id="Find-Files-by-Owner"><a href="#Find-Files-by-Owner" class="headerlink" title=" Find Files by Owner"></a><a name="find-files-by-owner"></a> Find Files by Owner</h3><p>To find files owned by a specific user, use the <code>-user</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -user username</span><br></pre></td></tr></table></figure>

<h3 id="Find-Files-by-Date-and-Time"><a href="#Find-Files-by-Date-and-Time" class="headerlink" title=" Find Files by Date and Time"></a><a name="find-files-by-date-and-time"></a> Find Files by Date and Time</h3><p>To find files modified within a specific time range, use the <code>-mtime</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -mtime -7  <span class="comment"># Files modified in the last 7 days</span></span><br><span class="line">find /path/to/search -mtime +7  <span class="comment"># Files modified more than 7 days ago</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="combining-with-other-commands"></a></p>
<h2 id="Combining-with-Other-Commands"><a href="#Combining-with-Other-Commands" class="headerlink" title="Combining with Other Commands"></a>Combining with Other Commands</h2><h3 id="Using-xargs"><a href="#Using-xargs" class="headerlink" title=" Using xargs"></a><a name="using-xargs"></a> Using <code>xargs</code></h3><p>To perform an action on the found files, use <code>xargs</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.log&quot;</span> | xargs <span class="built_in">rm</span></span><br></pre></td></tr></table></figure>

<h3 id="Using-grep"><a href="#Using-grep" class="headerlink" title=" Using grep"></a><a name="using-grep"></a> Using <code>grep</code></h3><p>To search for files containing specific content, use <code>grep</code> with <code>find</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -<span class="built_in">type</span> f -<span class="built_in">exec</span> grep -l <span class="string">&quot;search_string&quot;</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<h3 id="Using-awk"><a href="#Using-awk" class="headerlink" title=" Using awk"></a><a name="using-awk"></a> Using <code>awk</code></h3><p>To process the output of <code>find</code> with <code>awk</code>, use a pipeline:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.txt&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="advanced-scenarios"></a></p>
<h2 id="Advanced-Scenarios"><a href="#Advanced-Scenarios" class="headerlink" title="Advanced Scenarios"></a>Advanced Scenarios</h2><h3 id="Find-and-Delete-Files"><a href="#Find-and-Delete-Files" class="headerlink" title=" Find and Delete Files"></a><a name="find-and-delete-files"></a> Find and Delete Files</h3><p>To find and delete files, use the <code>-delete</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.bak&quot;</span> -delete</span><br></pre></td></tr></table></figure>

<h3 id="Find-and-Move-Files"><a href="#Find-and-Move-Files" class="headerlink" title=" Find and Move Files"></a><a name="find-and-move-files"></a> Find and Move Files</h3><p>To find and move files, use the <code>-exec</code> option with <code>mv</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.log&quot;</span> -<span class="built_in">exec</span> <span class="built_in">mv</span> &#123;&#125; /path/to/destination/ \;</span><br></pre></td></tr></table></figure>

<h3 id="Find-and-Copy-Files"><a href="#Find-and-Copy-Files" class="headerlink" title=" Find and Copy Files"></a><a name="find-and-copy-files"></a> Find and Copy Files</h3><p>To find and copy files, use the <code>-exec</code> option with <code>cp</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.txt&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; /path/to/destination/ \;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The <code>find</code> command is a versatile and powerful tool for searching files and directories based on various criteria. By mastering the various options and scenarios covered in this article, you can effectively use <code>find</code> for a wide range of tasks, from simple file searches to complex operations involving multiple commands and pipelines.</p>
<hr>
<p><a name="appendix"></a></p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><p><a name="using-xargs"></a></p>
<h3 id="Using-xargs-1"><a href="#Using-xargs-1" class="headerlink" title="Using xargs"></a>Using <code>xargs</code></h3><p>The command <code>find /path/to/search -type f -exec grep -l &quot;search_string&quot; &#123;&#125; \;</code> can be rewritten using <code>xargs</code>. The <code>xargs</code> command is useful for building and executing command lines from standard input. Here’s how you can rewrite the command using <code>xargs</code>:</p>
<p>Using <code>xargs</code> to rewrite the <code>find</code> command with <code>-exec</code> can make your command more efficient and easier to read. By leveraging <code>xargs</code>, you can handle large numbers of files more effectively and streamline your command-line operations.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -<span class="built_in">type</span> f | xargs grep -l <span class="string">&quot;search_string&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h3><ol>
<li><strong><code>find /path/to/search -type f</code></strong>: This part of the command finds all files (<code>-type f</code>) in the specified directory and its subdirectories.</li>
<li><strong><code>| xargs grep -l &quot;search_string&quot;</code></strong>: The <code>|</code> (pipe) symbol passes the list of files found by <code>find</code> to <code>xargs</code>. <code>xargs</code> then constructs and executes the <code>grep</code> command for each file, searching for the specified string (<code>&quot;search_string&quot;</code>) and printing the names of files that contain the string (<code>-l</code> option).</li>
</ol>
<h3 id="Benefits-of-Using-xargs"><a href="#Benefits-of-Using-xargs" class="headerlink" title="Benefits of Using xargs"></a>Benefits of Using <code>xargs</code></h3><ul>
<li><strong>Efficiency</strong>: <code>xargs</code> can handle a large number of files more efficiently than the <code>-exec</code> option, especially when dealing with a large number of files.</li>
<li><strong>Simplification</strong>: The <code>xargs</code> version is often simpler and more concise.</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>Suppose you want to find all files in the <code>/var/log</code> directory that contain the string “error”. You can use the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log -<span class="built_in">type</span> f | xargs grep -l <span class="string">&quot;error&quot;</span></span><br></pre></td></tr></table></figure>

<p>This command will output the names of all files in the <code>/var/log</code> directory and its subdirectories that contain the string “error”.</p>
<p><a name="using-curly-brackets-"></a></p>
<h3 id="Using-curly-brackets"><a href="#Using-curly-brackets" class="headerlink" title="Using curly brackets {}"></a>Using curly brackets <code>&#123;&#125;</code></h3><p>The <code>&#123;&#125;</code> in the command <code>find /path/to/search -name &quot;*.log&quot; -exec mv &#123;&#125; /path/to/destination/ \;</code> is a placeholder that represents the current file being processed by the <code>find</code> command. Let’s break down the command and understand the role of <code>&#123;&#125;</code>.</p>
<p>The <code>&#123;&#125;</code> placeholder in the <code>find</code> command with <code>-exec</code> is a powerful feature that allows you to dynamically insert the current file path into the command being executed. This makes it easy to perform operations on each file found by <code>find</code>, such as moving, copying, or deleting files.</p>
<h3 id="Command-Breakdown"><a href="#Command-Breakdown" class="headerlink" title="Command Breakdown"></a>Command Breakdown</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.log&quot;</span> -<span class="built_in">exec</span> <span class="built_in">mv</span> &#123;&#125; /path/to/destination/ \;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong><code>find /path/to/search -name &quot;*.log&quot;</code></strong>: This part of the command searches for all files in the <code>/path/to/search</code> directory and its subdirectories that match the pattern <code>*.log</code>.</p>
</li>
<li><p><strong><code>-exec mv &#123;&#125; /path/to/destination/ \;</code></strong>: This part of the command executes the <code>mv</code> command for each file found by <code>find</code>.</p>
<ul>
<li><strong><code>&#123;&#125;</code></strong>: This placeholder is replaced by the full path of the current file found by <code>find</code>. For example, if <code>find</code> finds a file named <code>example.log</code> in the directory <code>/path/to/search/subdir</code>, <code>&#123;&#125;</code> will be replaced by <code>/path/to/search/subdir/example.log</code>.</li>
<li><strong><code>/path/to/destination/</code></strong>: This is the destination directory where the files will be moved.</li>
<li><strong><code>\;</code></strong>: This is the terminator for the <code>-exec</code> command. It tells <code>find</code> that the command is complete.</li>
</ul>
</li>
</ol>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><p>Suppose you have the following directory structure:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/path/to/search/</span><br><span class="line">├── file1.log</span><br><span class="line">├── file2.log</span><br><span class="line">└── subdir/</span><br><span class="line">    └── file3.log</span><br></pre></td></tr></table></figure>

<p>Running the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/search -name <span class="string">&quot;*.log&quot;</span> -<span class="built_in">exec</span> <span class="built_in">mv</span> &#123;&#125; /path/to/destination/ \;</span><br></pre></td></tr></table></figure>

<p>will result in the following actions:</p>
<ol>
<li><code>find</code> will locate <code>file1.log</code>, <code>file2.log</code>, and <code>subdir/file3.log</code>.</li>
<li>For each file found, <code>find</code> will execute the <code>mv</code> command:<ul>
<li><code>mv /path/to/search/file1.log /path/to/destination/</code></li>
<li><code>mv /path/to/search/file2.log /path/to/destination/</code></li>
<li><code>mv /path/to/search/subdir/file3.log /path/to/destination/</code></li>
</ul>
</li>
</ol>
<p>After the command completes, all <code>.log</code> files will be moved to the <code>/path/to/destination/</code> directory.</p>
<p><a name="references"></a></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/find.1.html">find Man Page</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/findutils/manual/html_mono/find.html">GNU findutils Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/xargs.1.html">xargs Man Page</a></li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/grep.1.html">grep Man Page</a></li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/awk.1p.html">awk Man Page</a></li>
</ol>
<p>By following these best practices, you can leverage the <code>find</code> command to its full potential and efficiently manage your file searches and operations from the command line.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/11/03/Best-Practices-of-Using-curl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/03/Best-Practices-of-Using-curl/" class="post-title-link" itemprop="url">Best Practices of Using curl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-11-03 11:26:54 / Modified: 12:01:57" itemprop="dateCreated datePublished" datetime="2024-11-03T11:26:54-05:00">2024-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Network/CLI/" itemprop="url" rel="index"><span itemprop="name">CLI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#basic-usage">Basic Usage</a><ul>
<li><a href="#-check-if-an-url-is-alive"> Check if an URL is Alive</a></li>
<li><a href="#-download-a-file"> Download a File</a></li>
</ul>
</li>
<li><a href="#http-methods">HTTP Methods</a><ul>
<li><a href="#-http-get"> HTTP GET</a></li>
<li><a href="#-http-post-with-json-payload"> HTTP POST with JSON Payload</a></li>
</ul>
</li>
<li><a href="#authentication">Authentication</a><ul>
<li><a href="#-http-basic-authentication"> HTTP Basic Authentication</a></li>
<li><a href="#-bearer-token-authentication"> Bearer Token Authentication</a></li>
</ul>
</li>
<li><a href="#https-and-certificates">HTTPS and Certificates</a><ul>
<li><a href="#-https-with-certificate"> HTTPS with Certificate</a></li>
<li><a href="#-ignore-https-certificate"> Ignore HTTPS Certificate</a></li>
</ul>
</li>
<li><a href="#advanced-scenarios">Advanced Scenarios</a><ul>
<li><a href="#-custom-headers"> Custom Headers</a></li>
<li><a href="#-follow-redirects"> Follow Redirects</a></li>
<li><a href="#-verbose-output"> Verbose Output</a></li>
<li><a href="#-timeouts"> Timeouts</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>curl</code> is a powerful command-line tool used for transferring data with URLs. It supports a wide range of protocols, including HTTP, HTTPS, FTP, and more. This article provides a comprehensive guide to the best practices of using <code>curl</code>, covering various scenarios such as checking if an URL is alive, downloading files, making HTTP GET&#x2F;POST requests, handling authentication, and dealing with HTTPS certificates.</p>
<hr>
<p><a name="basic-usage"></a></p>
<h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><h3 id="Check-if-an-URL-is-Alive"><a href="#Check-if-an-URL-is-Alive" class="headerlink" title=" Check if an URL is Alive"></a><a name="check-if-an-url-is-alive"></a> Check if an URL is Alive</h3><p>To check if an URL is alive, you can use the <code>-I</code> (or <code>--head</code>) option to send a HEAD request:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I https://example.com</span><br></pre></td></tr></table></figure>

<p>This command will return the HTTP headers without downloading the content, allowing you to quickly check if the URL is accessible.</p>
<h3 id="Download-a-File"><a href="#Download-a-File" class="headerlink" title=" Download a File"></a><a name="download-a-file"></a> Download a File</h3><p>To download a file from a URL, simply use the <code>curl</code> command followed by the URL:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://example.com/file.zip</span><br></pre></td></tr></table></figure>

<p>The <code>-O</code> option saves the file with the same name as the remote file. If you want to save the file with a different name, use the <code>-o</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o myfile.zip https://example.com/file.zip</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="http-methods"></a></p>
<h2 id="HTTP-Methods"><a href="#HTTP-Methods" class="headerlink" title="HTTP Methods"></a>HTTP Methods</h2><h3 id="HTTP-GET"><a href="#HTTP-GET" class="headerlink" title=" HTTP GET"></a><a name="http-get"></a> HTTP GET</h3><p>To make an HTTP GET request, use the <code>curl</code> command followed by the URL:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<h3 id="HTTP-POST-with-JSON-Payload"><a href="#HTTP-POST-with-JSON-Payload" class="headerlink" title=" HTTP POST with JSON Payload"></a><a name="http-post-with-json-payload"></a> HTTP POST with JSON Payload</h3><p>To make an HTTP POST request with a JSON payload, use the <code>-X POST</code> option and specify the JSON data using the <code>-d</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;key1&quot;:&quot;value1&quot;, &quot;key2&quot;:&quot;value2&quot;&#125;&#x27;</span> https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="authentication"></a></p>
<h2 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h2><h3 id="HTTP-Basic-Authentication"><a href="#HTTP-Basic-Authentication" class="headerlink" title=" HTTP Basic Authentication"></a><a name="http-basic-authentication"></a> HTTP Basic Authentication</h3><p>To use HTTP Basic Authentication, use the <code>-u</code> option to specify the username and password:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u username:password https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<h3 id="Bearer-Token-Authentication"><a href="#Bearer-Token-Authentication" class="headerlink" title=" Bearer Token Authentication"></a><a name="bearer-token-authentication"></a> Bearer Token Authentication</h3><p>To use Bearer Token Authentication, use the <code>-H</code> option to set the <code>Authorization</code> header:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">&quot;Authorization: Bearer YOUR_TOKEN&quot;</span> https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="https-and-certificates"></a></p>
<h2 id="HTTPS-and-Certificates"><a href="#HTTPS-and-Certificates" class="headerlink" title="HTTPS and Certificates"></a>HTTPS and Certificates</h2><h3 id="HTTPS-with-Certificate"><a href="#HTTPS-with-Certificate" class="headerlink" title=" HTTPS with Certificate"></a><a name="https-with-certificate"></a> HTTPS with Certificate</h3><p>To use HTTPS with a client certificate, use the <code>--cert</code> and <code>--key</code> options:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --cert client.crt --key client.key https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<h3 id="Ignore-HTTPS-Certificate"><a href="#Ignore-HTTPS-Certificate" class="headerlink" title=" Ignore HTTPS Certificate"></a><a name="ignore-https-certificate"></a> Ignore HTTPS Certificate</h3><p>To ignore HTTPS certificate validation (not recommended for production), use the <code>-k</code> (or <code>--insecure</code>) option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="advanced-scenarios"></a></p>
<h2 id="Advanced-Scenarios"><a href="#Advanced-Scenarios" class="headerlink" title="Advanced Scenarios"></a>Advanced Scenarios</h2><h3 id="Custom-Headers"><a href="#Custom-Headers" class="headerlink" title=" Custom Headers"></a><a name="custom-headers"></a> Custom Headers</h3><p>To send custom headers, use the <code>-H</code> option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">&quot;X-Custom-Header: value&quot;</span> https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<h3 id="Follow-Redirects"><a href="#Follow-Redirects" class="headerlink" title=" Follow Redirects"></a><a name="follow-redirects"></a> Follow Redirects</h3><p>To follow HTTP redirects, use the <code>-L</code> (or <code>--location</code>) option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://example.com/redirect</span><br></pre></td></tr></table></figure>

<h3 id="Verbose-Output"><a href="#Verbose-Output" class="headerlink" title=" Verbose Output"></a><a name="verbose-output"></a> Verbose Output</h3><p>To get verbose output, use the <code>-v</code> (or <code>--verbose</code>) option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<h3 id="Timeouts"><a href="#Timeouts" class="headerlink" title=" Timeouts"></a><a name="timeouts"></a> Timeouts</h3><p>To set a timeout for the request, use the <code>--connect-timeout</code> and <code>--max-time</code> options:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --connect-timeout 5 --max-time 10 https://example.com/api/resource</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><code>curl</code> is a versatile and powerful tool for interacting with web services and downloading files from the command line. By mastering the various options and scenarios covered in this article, you can effectively use <code>curl</code> for a wide range of tasks, from simple URL checks to complex HTTP requests with authentication and custom headers.</p>
<hr>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://curl.se/docs/">curl Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://curl.se/docs/manpage.html">curl Man Page</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">HTTP Methods</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication">HTTP Authentication</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/HTTPS">HTTPS</a></li>
</ol>
<p>By following these best practices, you can leverage <code>curl</code> to its full potential and efficiently manage your web interactions from the command line.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/11/03/AI-LLM-Tool-Ollama-Architecture-and-Conversation-Processing-Flow-Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/03/AI-LLM-Tool-Ollama-Architecture-and-Conversation-Processing-Flow-Analysis/" class="post-title-link" itemprop="url">AI LLM Tool Ollama: Architecture and Conversation Processing Flow Analysis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-11-03 11:02:38" itemprop="dateCreated datePublished" datetime="2024-11-03T11:02:38-05:00">2024-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-11-07 16:42:23" itemprop="dateModified" datetime="2024-11-07T16:42:23-05:00">2024-11-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#overview-of-ollama">Overview of Ollama</a></li>
<li><a href="#ollama-architecture">Ollama Architecture</a></li>
<li><a href="#ollama-storage-structure">Ollama Storage Structure</a></li>
<li><a href="#ollama-conversation-processing-flow">Ollama Conversation Processing Flow</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References:</a></li>
</ul>
<p><a name="overview-of-ollama"></a></p>
<h2 id="Overview-of-Ollama"><a href="#Overview-of-Ollama" class="headerlink" title="Overview of Ollama"></a>Overview of Ollama</h2><p><code>Ollama</code> is a convenient tool for running <code>LLM</code> (Large Language Models) quickly. With <code>Ollama</code>, users can easily interact with large language models without complex environment configurations.</p>
<p>This article will analyze the overall architecture of <code>Ollama</code> and detail the specific processing flow when users engage in conversations with <code>Ollama</code>.</p>
<p><a name="ollama-architecture"></a></p>
<h2 id="Ollama-Architecture"><a href="#Ollama-Architecture" class="headerlink" title="Ollama Architecture"></a>Ollama Architecture</h2><p><img src="/images/AI-LLM-Tool-Ollama-Architecture-and-Conversation-Processing-Flow-Analysis/Image-1.png" alt="Ollama Architecture"></p>
<p><code>Ollama</code> employs a classic CS (Client-Server) architecture, where:</p>
<ul>
<li><strong>Client</strong>: Interacts with the user via the command line.</li>
<li><strong>Server</strong>: Can be started via the command line, desktop application (based on the Electron framework), or Docker. Regardless of the startup method, the same executable file is ultimately invoked.</li>
<li><strong>Communication</strong>: Client and Server communicate using HTTP.</li>
</ul>
<p>The <code>Ollama Server</code> consists of two core components:</p>
<ul>
<li><strong><code>ollama-http-server</code></strong>: Handles interactions with the client.</li>
<li><strong><code>llama.cpp</code></strong>: Serves as the LLM inference engine, responsible for loading and running large language models, processing inference requests, and returning results.</li>
<li><strong>Interaction</strong>: <code>ollama-http-server</code> and <code>llama.cpp</code> also communicate via HTTP.</li>
</ul>
<p><strong>Note</strong>: <code>llama.cpp</code> is an independent open-source project that is cross-platform and hardware-friendly, capable of running on devices without GPUs, including Raspberry Pi.</p>
<p><a name="ollama-storage-structure"></a></p>
<h2 id="Ollama-Storage-Structure"><a href="#Ollama-Storage-Structure" class="headerlink" title="Ollama Storage Structure"></a>Ollama Storage Structure</h2><p><img src="/images/AI-LLM-Tool-Ollama-Architecture-and-Conversation-Processing-Flow-Analysis/Image-2.png" alt="Ollama Storage Architecture"></p>
<p><code>Ollama</code> uses the default local storage folder path <code>$HOME/.ollama</code>. The file structure is as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$HOME/.ollama/</span><br><span class="line">├── blobs/</span><br><span class="line">├── manifests/</span><br><span class="line">├── logs/</span><br><span class="line">│   └── server.log</span><br><span class="line">├── history</span><br><span class="line">├── id_ed25519</span><br><span class="line">└── id_ed25519.pub</span><br></pre></td></tr></table></figure>

<p>Files can be categorized into three types:</p>
<ul>
<li><strong>Log Files</strong>: Includes the <code>history</code> file, which records user conversation inputs, and the <code>logs/server.log</code> server log file.</li>
<li><strong>Key Files</strong>: Includes the <code>id_ed25519</code> private key and <code>id_ed25519.pub</code> public key.</li>
<li><strong>Model Files</strong>: Includes <code>blobs</code> raw data files and <code>manifests</code> metadata files.</li>
</ul>
<p>The metadata files, such as <code>models/manifests/registry.ollama.ai/library/llama3.2/latest</code>, contain the following content:</p>
<p><img src="/images/AI-LLM-Tool-Ollama-Architecture-and-Conversation-Processing-Flow-Analysis/Image-3.png" alt="llama3.2-latest"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;digest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:abcdef1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">123456789</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;org.opencontainers.image.title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;llama3.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;org.opencontainers.image.version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>As shown above, <code>manifests</code> files are in JSON format and draw inspiration from the OCI spec (Open Container Initiative Specification) in cloud-native and container domains. The <code>digest</code> field in <code>manifests</code> corresponds to <code>blobs</code>.</p>
<p><a name="ollama-conversation-processing-flow"></a></p>
<h2 id="Ollama-Conversation-Processing-Flow"><a href="#Ollama-Conversation-Processing-Flow" class="headerlink" title="Ollama Conversation Processing Flow"></a>Ollama Conversation Processing Flow</h2><p><img src="/images/AI-LLM-Tool-Ollama-Architecture-and-Conversation-Processing-Flow-Analysis/Image-4.png" alt="Ollama Conversation Processing Flow"></p>
<p>The general flow of a user conversation with <code>Ollama</code> is as follows:</p>
<ol>
<li><p><strong>User Initiates Conversation</strong>: The user executes the command <code>ollama run llama3.2</code> via the CLI to start a conversation (<code>llama3.2</code> is an open-source large language model; you can also use other LLMs).</p>
</li>
<li><p><strong>Preparation Phase</strong>:</p>
<ul>
<li>The CLI client sends an HTTP request to <code>ollama-http-server</code> to fetch model information. The server attempts to read the local <code>manifests</code> metadata files. If not found, it responds with a 404 not found.</li>
<li>When the model does not exist, the CLI client requests <code>ollama-http-server</code> to pull the model from the remote repository to the local storage.</li>
<li>The CLI client then requests the model information again.</li>
</ul>
</li>
<li><p><strong>Interactive Conversation Phase</strong>:</p>
<ul>
<li>The CLI sends an empty message <code>/api/generate</code> request to <code>ollama-http-server</code>, which internally handles some channel processing (using Go’s channels).</li>
<li>If the model information contains <code>messages</code>, they are printed. Users can save the current model and session conversation history as a new model, and the conversation history is saved as <code>messages</code>.</li>
<li>The conversation officially begins: The CLI calls the <code>/api/chat</code> interface to request <code>ollama-http-server</code>, which relies on the <code>llama.cpp</code> engine to load the model and perform inference (<code>llama.cpp</code> also serves as an HTTP server). <code>ollama-http-server</code> first sends a <code>/health</code> request to <code>llama.cpp</code> to confirm its health status, then sends a <code>/completion</code> request to obtain the conversation response, and finally returns it to the CLI for display.</li>
</ul>
</li>
</ol>
<p>Through the above steps, <code>Ollama</code> completes the interaction between the user and the large language model.</p>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><code>Ollama</code> integrates the <code>llama.cpp</code> inference engine and further encapsulates it, making complex LLM technology accessible. It provides developers and technical personnel with an efficient and flexible tool, effectively supporting large language model inference and interaction in various application scenarios.</p>
<p><a name="references"></a></p>
<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ul>
<li>• <a target="_blank" rel="noopener" href="https://github.com/ollama/ollama">https://github.com/ollama/ollama</a></li>
<li>• <a target="_blank" rel="noopener" href="https://github.com/ggerganov/llama.cpp">https://github.com/ggerganov/llama.cpp</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/11/02/Troubleshooting-Pod-to-Pod-Communication-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/02/Troubleshooting-Pod-to-Pod-Communication-in-Kubernetes/" class="post-title-link" itemprop="url">Troubleshooting Pod-to-Pod Communication in Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-11-02 12:49:45 / Modified: 12:50:30" itemprop="dateCreated datePublished" datetime="2024-11-02T12:49:45-04:00">2024-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/Troubleshooting/" itemprop="url" rel="index"><span itemprop="name">Troubleshooting</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#problem-description">Problem Description</a></li>
<li><a href="#troubleshooting-steps">Troubleshooting Steps</a><ul>
<li><a href="#step-1-capture-network-traffic">Step 1: Capture Network Traffic</a></li>
<li><a href="#step-2-verify-service-ip">Step 2: Verify Service IP</a></li>
<li><a href="#step-3-check-dns-resolution">Step 3: Check DNS Resolution</a></li>
<li><a href="#step-4-investigate-service-ip">Step 4: Investigate Service IP</a></li>
<li><a href="#step-5-verify-outgoing-traffic-from-pod">Step 5: Verify Outgoing Traffic from Pod</a></li>
<li><a href="#step-6-simulate-traffic-from-pod">Step 6: Simulate Traffic from Pod</a></li>
<li><a href="#step-7-restart-pod">Step 7: Restart Pod</a></li>
<li><a href="#step-8-identify-java-dns-caching">Step 8: Identify Java DNS Caching</a></li>
</ul>
</li>
<li><a href="#solution">Solution</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In a K8S cluster, PodA is experiencing issues when using a service name to access PodB. PodA is on <code>node1</code>, and PodB is on <code>node2</code>. This article will walk through the troubleshooting steps to identify and resolve the issue.</p>
<p><a name="problem-description"></a></p>
<h2 id="Problem-Description"><a href="#Problem-Description" class="headerlink" title="Problem Description"></a>Problem Description</h2><p>PodA is unable to access PodB using the service name, and the request is failing. PodA is on <code>node1</code>, and PodB is on <code>node2</code>.</p>
<p><a name="troubleshooting-steps"></a></p>
<h2 id="Troubleshooting-Steps"><a href="#Troubleshooting-Steps" class="headerlink" title="Troubleshooting Steps"></a>Troubleshooting Steps</h2><p><a name="step-1-capture-network-traffic"></a></p>
<h3 id="Step-1-Capture-Network-Traffic"><a href="#Step-1-Capture-Network-Traffic" class="headerlink" title="Step 1: Capture Network Traffic"></a>Step 1: Capture Network Traffic</h3><p>First, use <code>tcpdump</code> to capture network traffic and observe if there are any anomalies:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# tcpdump -n -i ens192 port 50300  </span><br><span class="line">...  </span><br><span class="line">13:48:17.630335 IP 177.177.176.150.distinct -&gt; 10.96.22.136.50300: UDP, length 214  </span><br><span class="line">13:48:17.630407 IP 192.168.7.21.distinct -&gt; 10.96.22.136.50300: UDP, length 214  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>From the captured packets, the source address and port are <code>177.177.176.150:50901</code>, and the destination address and port are <code>10.96.22.136:50300</code>. The destination IP <code>10.96.22.136</code> is the IP address obtained by PodA when using the <code>server-svc</code> service name.</p>
<p><a name="step-2-verify-service-ip"></a></p>
<h3 id="Step-2-Verify-Service-IP"><a href="#Step-2-Verify-Service-IP" class="headerlink" title="Step 2: Verify Service IP"></a>Step 2: Verify Service IP</h3><p>Check if the IP address <code>10.96.22.136</code> is correct:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubectl get pod -A -owide|grep server  </span><br><span class="line">ss  server-xxx-xxx  1/1  Running 0 20h  177.177.176.150  node1  </span><br><span class="line">ss  server-xxx-xxx  1/1  Running 0 20h  177.177.254.245  node2  </span><br><span class="line">ss  server-xxx-xxx  1/1  Running 0 20h  177.177.18.152   node3  </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubectl get svc -A -owide|grep server  </span><br><span class="line">ss  server-svc  ClusterIP  10.96.182.195 &lt;none&gt;  50300/UDP  </span><br></pre></td></tr></table></figure>

<p>The source IP is correct, but the destination IP does not match the expected <code>server-svc</code> IP <code>10.96.182.195</code>.</p>
<p><a name="step-3-check-dns-resolution"></a></p>
<h3 id="Step-3-Check-DNS-Resolution"><a href="#Step-3-Check-DNS-Resolution" class="headerlink" title="Step 3: Check DNS Resolution"></a>Step 3: Check DNS Resolution</h3><p>Since K8S uses <code>CoreDNS</code> for service discovery starting from v1.13, verify if the DNS resolution is correct inside PodA:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubectl <span class="built_in">exec</span> -it -n ss server-xxx-xxx -- <span class="built_in">cat</span> /etc/resolve.conf  </span><br><span class="line">nameserver 10.96.0.10  </span><br><span class="line">search ss.svc.cluster.local svc.cluster.local cluster.local  </span><br><span class="line">options ndots:5  </span><br><span class="line">  </span><br><span class="line">[root@node1 ~]# kubectl <span class="built_in">exec</span> -it -n ss server-xxx-xxx -- nslookup server-svc  </span><br><span class="line">Server: 10.96.0.10  </span><br><span class="line">  </span><br><span class="line">Name: ss  </span><br><span class="line">Address: 10.96.182.195</span><br></pre></td></tr></table></figure>

<p>The DNS resolution is correct, and PodA can resolve <code>server-svc</code> to <code>10.96.182.195</code>.</p>
<p><a name="step-4-investigate-service-ip"></a></p>
<h3 id="Step-4-Investigate-Service-IP"><a href="#Step-4-Investigate-Service-IP" class="headerlink" title="Step 4: Investigate Service IP"></a>Step 4: Investigate Service IP</h3><p>Check if <code>10.96.22.136</code> is associated with any other service, iptables rules, or routes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubectl get svc -A -owide|grep 10.96.22.136  </span><br><span class="line">  </span><br><span class="line">[root@node1 ~]# iptables-save|grep 10.96.22.136  </span><br><span class="line">  </span><br><span class="line">[root@node1 ~]# ip route|grep 10.96.22.136  </span><br></pre></td></tr></table></figure>

<p>The IP <code>10.96.22.136</code> does not exist in the cluster.</p>
<p><a name="step-5-verify-outgoing-traffic-from-pod"></a></p>
<h3 id="Step-5-Verify-Outgoing-Traffic-from-Pod"><a href="#Step-5-Verify-Outgoing-Traffic-from-Pod" class="headerlink" title="Step 5: Verify Outgoing Traffic from Pod"></a>Step 5: Verify Outgoing Traffic from Pod</h3><p>Check the destination IP when the traffic leaves PodA:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# ip route|grep 177.177.176.150  </span><br><span class="line">177.177.176.150 dev cali9afa4438787 scope <span class="built_in">link</span>  </span><br><span class="line">  </span><br><span class="line">[root@node1 ~]# tcpdump -n -i cali9afa4438787 port 50300  </span><br><span class="line">...  </span><br><span class="line">14:16:40.821511 IP 177.177.176.150.50902 -&gt;  10.96.22.136.50300:  UDP, length 214  </span><br><span class="line">...  </span><br></pre></td></tr></table></figure>

<p>The destination IP is incorrect when leaving PodA.</p>
<p><a name="step-6-simulate-traffic-from-pod"></a></p>
<h3 id="Step-6-Simulate-Traffic-from-Pod"><a href="#Step-6-Simulate-Traffic-from-Pod" class="headerlink" title="Step 6: Simulate Traffic from Pod"></a>Step 6: Simulate Traffic from Pod</h3><p>Simulate a UDP packet from PodA using <code>nc</code> to verify if the destination IP is correct:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubectl <span class="built_in">exec</span> -it -n ss server-xxx-xxx -- <span class="built_in">echo</span> “<span class="built_in">test</span>” | nc -u server-svc 50300 -p 9999  </span><br><span class="line">  </span><br><span class="line">[root@node1 ~]# tcpdump -n -i cali9afa4438787 port 50300  </span><br><span class="line">...  </span><br><span class="line">15:46:45.871580 IP 177.177.176.150.50902 -&gt;  10.96.182.195.50300:  UDP, length 54  </span><br><span class="line">...  </span><br></pre></td></tr></table></figure>

<p>The simulated traffic has the correct destination IP.</p>
<p><a name="step-7-restart-pod"></a></p>
<h3 id="Step-7-Restart-Pod"><a href="#Step-7-Restart-Pod" class="headerlink" title="Step 7: Restart Pod"></a>Step 7: Restart Pod</h3><p>Restart PodA to see if the issue is resolved:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker ps |grep server-xxx-xxx | grep -v POD |awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> |xargs docker restart  </span><br><span class="line">  </span><br><span class="line">[root@node1 ~]# tcpdump -n -i ens192 port 50300  </span><br><span class="line">...  </span><br><span class="line">15:58:17.150535 IP 177.177.176.150.distinct -&gt; 10.96.182.195.50300:  UDP, length 214  </span><br><span class="line">15:58:17.150607 IP 192.168.7.21.distinct  -&gt;  10.96.182.195.50300:   UDP, length 214  </span><br><span class="line">...  </span><br></pre></td></tr></table></figure>

<p>The issue is resolved after restarting PodA.</p>
<p><a name="step-8-identify-java-dns-caching"></a></p>
<h3 id="Step-8-Identify-Java-DNS-Caching"><a href="#Step-8-Identify-Java-DNS-Caching" class="headerlink" title="Step 8: Identify Java DNS Caching"></a>Step 8: Identify Java DNS Caching</h3><p>Investigate if Java DNS caching is causing the issue:</p>
<blockquote>
<p>In Java, DNS caching is used to improve performance by storing DNS lookup results. When <code>InetAddress</code> is used to resolve a domain name, the result is cached by the JVM. This cache can cause stale DNS entries to be used.</p>
</blockquote>
<p>To resolve this, adjust the DNS caching settings:</p>
<ol>
<li>Set the <code>networkaddress.cache.ttl</code> property in the Java security settings.</li>
<li>Modify the <code>java.security</code> file to set the <code>networkaddress.cache.negative.ttl</code> property.</li>
</ol>
<p><a name="solution"></a></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Adjust the DNS caching settings in the business application based on the business scenario.</p>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This article detailed the troubleshooting steps to identify and resolve an issue where PodA was unable to access PodB using a service name in a K8S cluster. The root cause was identified as Java DNS caching, and the issue was resolved by adjusting the DNS caching settings.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/31/Deep-Dive-into-Kubernetes-Ingress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/31/Deep-Dive-into-Kubernetes-Ingress/" class="post-title-link" itemprop="url">Deep Dive into Kubernetes Ingress</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-31 13:20:57 / Modified: 13:22:00" itemprop="dateCreated datePublished" datetime="2024-10-31T13:20:57-04:00">2024-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#what-is-kubernetes-ingress">What is Kubernetes Ingress?</a><ul>
<li><a href="#ingress-types">Ingress Types</a></li>
</ul>
</li>
<li><a href="#ingress-controllers">Ingress Controllers</a></li>
<li><a href="#ingress-rules-and-annotations">Ingress Rules and Annotations</a><ul>
<li><a href="#example-of-an-ingress-rule">Example of an Ingress Rule</a></li>
</ul>
</li>
<li><a href="#ingress-architecture-diagram">Ingress Architecture Diagram</a><ul>
<li><a href="#ingress-with-path-based-routing">Ingress with Path-Based Routing</a></li>
</ul>
</li>
</ul>
<hr>
<p>In Kubernetes, <strong>Ingress</strong> is a crucial component that manages external access to services within a cluster, typically via HTTP or HTTPS. It provides a centralized entry point for external traffic, applying routing rules to direct requests to appropriate services. This article explores the architecture and responsibilities of Kubernetes Ingress, how it interacts with other components, and provides visual architecture diagrams.</p>
<hr>
<p><a name="kubernetes-ingress"></a></p>
<h2 id="What-is-Kubernetes-Ingress"><a href="#What-is-Kubernetes-Ingress" class="headerlink" title="What is Kubernetes Ingress?"></a>What is Kubernetes Ingress?</h2><p><strong>Ingress</strong> in Kubernetes is an API object that manages external access to services, usually HTTP. Instead of exposing each service individually through a <strong>Service</strong> object of type <code>LoadBalancer</code> or <code>NodePort</code>, Ingress offers a central route, managing traffic with a single IP address or DNS name for the entire cluster. Key benefits include:</p>
<ul>
<li><strong>Centralized Traffic Management</strong>: Ingress consolidates traffic through a single point of entry, allowing easy route management.</li>
<li><strong>Path-Based Routing</strong>: Requests can be directed to specific services based on request paths or hostnames.</li>
<li><strong>SSL Termination</strong>: Ingress can terminate SSL&#x2F;TLS connections, ensuring secure HTTPS access.</li>
</ul>
<h3 id="Ingress-Types"><a href="#Ingress-Types" class="headerlink" title="Ingress Types"></a>Ingress Types</h3><p>Kubernetes supports two main Ingress types:</p>
<ul>
<li><strong>Simple Ingress</strong>: For straightforward routing to backend services based on path or hostname.</li>
<li><strong>Advanced Ingress</strong>: With more complex routing rules, integrating SSL termination, URL rewrites, and custom filtering.</li>
</ul>
<hr>
<p><a name="ingress-controllers"></a></p>
<h2 id="Ingress-Controllers"><a href="#Ingress-Controllers" class="headerlink" title="Ingress Controllers"></a>Ingress Controllers</h2><p>An <strong>Ingress Controller</strong> is the implementation that enforces Ingress rules, usually deployed as a Pod within the cluster. Popular Ingress controllers include <strong>NGINX</strong>, <strong>HAProxy</strong>, <strong>Traefik</strong>, and <strong>Istio</strong>. The Ingress Controller is responsible for:</p>
<ol>
<li><strong>Monitoring Ingress Resources</strong>: Watching for any changes in Ingress resources and updating routing rules accordingly.</li>
<li><strong>Load Balancing and SSL Termination</strong>: Providing efficient load balancing for HTTP&#x2F;HTTPS requests.</li>
<li><strong>Proxying and Forwarding</strong>: Accepting requests on behalf of the Ingress and forwarding them to the correct Service and Pod.</li>
</ol>
<p>The Ingress Controller must be installed in the cluster to interpret and apply Ingress resources, as Kubernetes does not ship with a default controller.</p>
<hr>
<p><a name="ingress-rules"></a></p>
<h2 id="Ingress-Rules-and-Annotations"><a href="#Ingress-Rules-and-Annotations" class="headerlink" title="Ingress Rules and Annotations"></a>Ingress Rules and Annotations</h2><p>Ingress rules define the routing policy for external traffic. These rules can direct traffic based on URL paths or hostnames, and each rule specifies the <code>Service</code> and <code>Port</code> the request should route to. Annotations add configurations like timeouts, request limits, and additional routing options.</p>
<h3 id="Example-of-an-Ingress-Rule"><a href="#Example-of-an-Ingress-Rule" class="headerlink" title="Example of an Ingress Rule"></a>Example of an Ingress Rule</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/app</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>In this example, requests to <code>example.com/app</code> are routed to the <code>app-service</code> on port <code>80</code>.</p>
<hr>
<p><a name="architecture-diagram"></a></p>
<h2 id="Ingress-Architecture-Diagram"><a href="#Ingress-Architecture-Diagram" class="headerlink" title="Ingress Architecture Diagram"></a>Ingress Architecture Diagram</h2><h3 id="Ingress-with-Path-Based-Routing"><a href="#Ingress-with-Path-Based-Routing" class="headerlink" title="Ingress with Path-Based Routing"></a>Ingress with Path-Based Routing</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------+</span><br><span class="line">|        External User        |</span><br><span class="line">+-----------------------------+</span><br><span class="line">              |</span><br><span class="line">              v</span><br><span class="line">+-----------------------------+</span><br><span class="line">|      Ingress Controller     |        &lt;-- Manages Ingress Rules</span><br><span class="line">+-----------------------------+</span><br><span class="line">              |</span><br><span class="line">      +-------+------+--------+</span><br><span class="line">      |              |        |</span><br><span class="line">      v              v        v</span><br><span class="line">+-----------+    +-----------+   +-----------+</span><br><span class="line">| Service A |    | Service B |   | Service C |</span><br><span class="line">+-----------+    +-----------+   +-----------+</span><br><span class="line">      |              |                |</span><br><span class="line">      v              v                v</span><br><span class="line">+-----------+    +-----------+   +-----------+</span><br><span class="line">| Pod A1    |    | Pod B1    |   | Pod C1    |</span><br><span class="line">+-----------+    +-----------+   +-----------+</span><br></pre></td></tr></table></figure>

<p>In this diagram:</p>
<ul>
<li><strong>Ingress Controller</strong> routes based on rules that direct traffic to Services.</li>
<li><strong>Services</strong> are abstractions that select Pods through labels.</li>
<li><strong>Pods</strong> run the actual applications and receive traffic forwarded by the Ingress Controller.</li>
</ul>
<p>This setup allows centralized and managed external access to cluster resources.</p>
<hr>
<p>By centralizing access with Ingress, Kubernetes can handle complex routing configurations, ensuring that traffic flows efficiently and securely across the cluster.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/31/Deep-Dive-into-Kubernetes-Pod-and-Service-Interactions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/31/Deep-Dive-into-Kubernetes-Pod-and-Service-Interactions/" class="post-title-link" itemprop="url">Deep Dive into Kubernetes Pod and Service Interactions</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-31 12:42:35 / Modified: 12:43:21" itemprop="dateCreated datePublished" datetime="2024-10-31T12:42:35-04:00">2024-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#understanding-kubernetes-pods">Understanding Kubernetes Pods</a></li>
<li><a href="#understanding-kubernetes-services">Understanding Kubernetes Services</a></li>
<li><a href="#pod-service-communication">Pod-Service Communication</a></li>
<li><a href="#architecture-diagrams">Architecture Diagrams</a><ul>
<li><a href="#pod-structure">Pod Structure</a></li>
<li><a href="#service-structure-and-flow">Service Structure and Flow</a></li>
</ul>
</li>
</ul>
<hr>
<p>In Kubernetes, <strong>Pods</strong> and <strong>Services</strong> work together to ensure reliable deployment, scaling, and network communication for containerized applications. This article provides a deep dive into their responsibilities, roles, and interaction processes within the Kubernetes architecture.</p>
<p><a name="kubernetes-pods"></a></p>
<h2 id="Understanding-Kubernetes-Pods"><a href="#Understanding-Kubernetes-Pods" class="headerlink" title="Understanding Kubernetes Pods"></a>Understanding Kubernetes Pods</h2><p>A <strong>Pod</strong> is the smallest deployable unit in Kubernetes. Each Pod represents one or more containers and is typically designed to hold a single application instance. Key responsibilities and characteristics of Pods include:</p>
<ul>
<li><strong>Containerized Workloads</strong>: A Pod holds one or more containers that share storage, network, and specifications.</li>
<li><strong>Networking</strong>: Each Pod gets its own IP address, allowing containers within it to communicate over <code>localhost</code>.</li>
<li><strong>Ephemeral Nature</strong>: Pods are disposable. When they fail or are deleted, a new Pod with a different IP is often created to replace them.</li>
<li><strong>Scalability</strong>: Kubernetes replicates Pods based on defined scaling requirements to handle application load.</li>
</ul>
<p><strong>Pod Lifecycle</strong>:</p>
<ol>
<li><strong>Scheduled</strong>: The Scheduler places the Pod on an appropriate Node.</li>
<li><strong>Running</strong>: Containers within the Pod are executing.</li>
<li><strong>Terminated</strong>: When the Pod is completed or deleted.</li>
</ol>
<hr>
<p><a name="kubernetes-services"></a></p>
<h2 id="Understanding-Kubernetes-Services"><a href="#Understanding-Kubernetes-Services" class="headerlink" title="Understanding Kubernetes Services"></a>Understanding Kubernetes Services</h2><p>A <strong>Service</strong> in Kubernetes is a stable networking endpoint that exposes a set of Pods as a network-accessible service, typically grouped by labels. Services abstract the dynamic nature of Pods and allow continuous network access. The main responsibilities of Services include:</p>
<ul>
<li><strong>Stable Networking</strong>: Services maintain a consistent IP address and DNS name despite the ephemeral nature of Pods.</li>
<li><strong>Load Balancing</strong>: Services automatically distribute incoming traffic across available Pods, balancing load.</li>
<li><strong>Discovery</strong>: Pods can be dynamically assigned to a Service based on matching labels, enabling flexible scaling and updates.</li>
</ul>
<p><strong>Types of Services</strong>:</p>
<ol>
<li><strong>ClusterIP</strong> (default): Exposes a service within the cluster.</li>
<li><strong>NodePort</strong>: Exposes a service on each Node’s IP at a static port.</li>
<li><strong>LoadBalancer</strong>: Creates an external load balancer to expose the service externally.</li>
<li><strong>ExternalName</strong>: Maps the Service to a DNS name outside of the cluster.</li>
</ol>
<hr>
<p><a name="pod-service-communication"></a></p>
<h2 id="Pod-Service-Communication"><a href="#Pod-Service-Communication" class="headerlink" title="Pod-Service Communication"></a>Pod-Service Communication</h2><p>Kubernetes leverages <strong>label selectors</strong> and <strong>IP allocation</strong> to connect Pods with Services. Here’s how communication works:</p>
<ol>
<li><strong>Label Selection</strong>: Services use labels to select Pods for traffic routing.</li>
<li><strong>Endpoints Object</strong>: Kubernetes creates an Endpoint resource to track the IP addresses of Pods associated with the Service.</li>
<li><strong>Service Proxying</strong>: <code>kube-proxy</code> intercepts traffic to a Service IP and forwards it to one of the Pod IPs listed in the Endpoints.</li>
<li><strong>Service IP and DNS</strong>: Each Service has a unique IP and is discoverable via a DNS name, facilitating easy communication.</li>
</ol>
<hr>
<p><a name="architecture-diagrams"></a></p>
<h2 id="Architecture-Diagrams"><a href="#Architecture-Diagrams" class="headerlink" title="Architecture Diagrams"></a>Architecture Diagrams</h2><h3 id="Pod-Structure"><a href="#Pod-Structure" class="headerlink" title="Pod Structure"></a>Pod Structure</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------+</span><br><span class="line">|              Pod                 |</span><br><span class="line">| +-----------+      +-----------+ |</span><br><span class="line">| | Container |      | Container | |</span><br><span class="line">| |   App     |      |   Sidecar | |</span><br><span class="line">| +-----------+      +-----------+ |</span><br><span class="line">|      Network (localhost)         |</span><br><span class="line">|      Shared Storage              |</span><br><span class="line">+----------------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="Service-Structure-and-Flow"><a href="#Service-Structure-and-Flow" class="headerlink" title="Service Structure and Flow"></a>Service Structure and Flow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+               +------------------+</span><br><span class="line">|   Service IP    | &lt;------------&gt;|    kube-proxy    |</span><br><span class="line">+-----------------+               +------------------+</span><br><span class="line">        |                               |</span><br><span class="line">        v                               v</span><br><span class="line">+-----------------+          +------------------+    +------------------+</span><br><span class="line">|      Pod 1      |  &lt;-----&gt; |      Pod 2      | &lt;- |       Pod 3      |</span><br><span class="line">+-----------------+          +------------------+    +------------------+</span><br></pre></td></tr></table></figure>

<p>In summary, Kubernetes Pods run containerized workloads, while Services provide stable network access to those workloads, regardless of individual Pod lifetimes. Together, they enable dynamic scaling, fault tolerance, and efficient networking within Kubernetes clusters.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/31/Deep-Dive-into-Core-Kubernetes-Components/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/31/Deep-Dive-into-Core-Kubernetes-Components/" class="post-title-link" itemprop="url">Deep Dive into Core Kubernetes Components</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-31 12:29:28 / Modified: 12:30:28" itemprop="dateCreated datePublished" datetime="2024-10-31T12:29:28-04:00">2024-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#api-server">API Server</a></li>
<li><a href="#etcd">etcd</a></li>
<li><a href="#controller-manager">Controller Manager</a></li>
<li><a href="#scheduler">Scheduler</a></li>
<li><a href="#kubelet">Kubelet</a></li>
<li><a href="#kube-proxy">Kube Proxy</a></li>
<li><a href="#communication-flow">Communication Flow</a></li>
</ul>
<hr>
<p>This article dives deep into the core components of Kubernetes, explaining their roles, functions, and interconnections. Textual diagrams illustrate the architecture to offer a clearer understanding of each component’s interactions.</p>
<hr>
<p><a name="api-server"></a></p>
<h2 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h2><p>The <strong>API Server</strong> is the core entry point for all Kubernetes interactions. It exposes the Kubernetes API, validates requests, and interacts with other components. Key functionalities include:</p>
<ul>
<li><strong>Authentication</strong>: Verifies the identity of incoming requests.</li>
<li><strong>Authorization</strong>: Manages RBAC (Role-Based Access Control) policies.</li>
<li><strong>Admission Control</strong>: Applies constraints and transformations to objects at request time.</li>
<li><strong>API Requests</strong>: Handles CRUD (Create, Read, Update, Delete) requests on Kubernetes objects.</li>
</ul>
<p><strong>Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+----------------+</span><br><span class="line">|                |</span><br><span class="line">|    API Server  |</span><br><span class="line">|                |</span><br><span class="line">+----------------+</span><br><span class="line">       |</span><br><span class="line">       v</span><br><span class="line">+----------------+</span><br><span class="line">|                |</span><br><span class="line">|      etcd      |</span><br><span class="line">|                |</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="etcd"></a></p>
<h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><p><strong>etcd</strong> is a highly available key-value store used by Kubernetes to persist the cluster state. It maintains the configurations and states of each component and is essential for recovering cluster state in case of a restart. Each component retrieves cluster state through the API Server, which interfaces with etcd.</p>
<p><strong>Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------------+           +----------------+</span><br><span class="line">|                |           |                |</span><br><span class="line">|    API Server  | &lt;-------&gt; |      etcd      |</span><br><span class="line">|                |           |                |</span><br><span class="line">+----------------+           +----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="controller-manager"></a></p>
<h2 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h2><p>The <strong>Controller Manager</strong> includes various controllers (e.g., Node, Replication, Endpoint) that regulate the state of cluster resources. Each controller reconciles the cluster’s actual state with the desired state. When discrepancies arise, controllers initiate adjustments (e.g., scaling replicas).</p>
<p><strong>Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+----------------+</span><br><span class="line">|                |</span><br><span class="line">| Controller     |</span><br><span class="line">| Manager        |</span><br><span class="line">|                |</span><br><span class="line">+----------------+</span><br><span class="line">       |</span><br><span class="line">       v</span><br><span class="line">+----------------+</span><br><span class="line">|                |</span><br><span class="line">|    API Server  |</span><br><span class="line">|                |</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="scheduler"></a></p>
<h2 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h2><p>The <strong>Scheduler</strong> assigns Pods to Nodes based on resource needs and constraints. The Scheduler evaluates factors like CPU, memory, and affinity rules before assigning Pods, ensuring optimal workload distribution.</p>
<p><strong>Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+----------------+</span><br><span class="line">|                |</span><br><span class="line">|   Scheduler    |</span><br><span class="line">|                |</span><br><span class="line">+----------------+</span><br><span class="line">       |</span><br><span class="line">       v</span><br><span class="line">+----------------+</span><br><span class="line">|                |</span><br><span class="line">|    API Server  |</span><br><span class="line">|                |</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="kubelet"></a></p>
<h2 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h2><p>The <strong>Kubelet</strong> runs on each Node and is responsible for managing container instances. It communicates with the API Server to receive Pod specifications, ensuring they’re running as defined. It monitors containers, collects resource usage, and sends reports back to the API Server.</p>
<p><strong>Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------------+     +----------------+</span><br><span class="line">|                |     |                |</span><br><span class="line">|     Kubelet    | &lt;-&gt; |  API Server    |</span><br><span class="line">|                |     |                |</span><br><span class="line">+----------------+     +----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="kube-proxy"></a></p>
<h2 id="Kube-Proxy"><a href="#Kube-Proxy" class="headerlink" title="Kube Proxy"></a>Kube Proxy</h2><p><strong>Kube Proxy</strong> manages network communication across Nodes in the cluster, implementing Kubernetes networking policies. It facilitates communication within Pods by maintaining network rules and forwarding requests as needed. </p>
<p><strong>Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------------+     +----------------+</span><br><span class="line">|                |     |                |</span><br><span class="line">|   Kube Proxy   | &lt;-&gt; |   Kubelet      |</span><br><span class="line">|                |     |                |</span><br><span class="line">+----------------+     +----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="communication-flow"></a></p>
<h2 id="Communication-Flow"><a href="#Communication-Flow" class="headerlink" title="Communication Flow"></a>Communication Flow</h2><p>In Kubernetes, components communicate through a centralized and secure API Server, with <code>etcd</code> acting as the persistent store. The workflow for scheduling, updating, and scaling applications includes:</p>
<ol>
<li><strong>User Command</strong>: Users issue requests to the API Server.</li>
<li><strong>Scheduler</strong>: Schedules new Pods.</li>
<li><strong>Controller Manager</strong>: Enforces and monitors the cluster state.</li>
<li><strong>Kubelet and Proxy</strong>: Enforce changes and maintain container and network policies.</li>
</ol>
<p><strong>Overall Diagram:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+----------------+            +----------------+</span><br><span class="line">|                |            |                |</span><br><span class="line">|    API Server  | &lt;--------&gt; |      etcd      |</span><br><span class="line">|                |            |                |</span><br><span class="line">+----------------+            +----------------+</span><br><span class="line">       |                            |</span><br><span class="line">       |                            |</span><br><span class="line">       v                            v</span><br><span class="line">+----------------+         +----------------+</span><br><span class="line">|                |         |                |</span><br><span class="line">| Controller     |         |   Scheduler    |</span><br><span class="line">| Manager        |         |                |</span><br><span class="line">+----------------+         +----------------+</span><br><span class="line">       |                            |</span><br><span class="line">       v                            v</span><br><span class="line">+----------------+         +----------------+</span><br><span class="line">|                |         |                |</span><br><span class="line">|    Kubelet     |         |   Kube Proxy   |</span><br><span class="line">|                |         |                |</span><br><span class="line">+----------------+         +----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p>Each Kubernetes component plays a specific role in cluster operations, and their communication ensures the cluster maintains its desired state and remains responsive to changing demands.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/30/Best-Practices-of-Deploying-PostgreSQL-in-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/30/Best-Practices-of-Deploying-PostgreSQL-in-Kubernetes/" class="post-title-link" itemprop="url">Best Practices of Deploying PostgreSQL in Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-30 23:32:42" itemprop="dateCreated datePublished" datetime="2024-10-30T23:32:42-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-11-03 13:45:16" itemprop="dateModified" datetime="2024-11-03T13:45:16-05:00">2024-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Kubernetes/PostgreSQL/" itemprop="url" rel="index"><span itemprop="name">PostgreSQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>This guide walks through deploying PostgreSQL in a Kubernetes Pod with a sidecar container that collects PostgreSQL logs and forwards them to Elasticsearch. We’ll use Helm to manage deployments, including setting up necessary ConfigMaps and Secrets for configuration.</p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgresql-logging/</span><br><span class="line">├── charts/</span><br><span class="line">│   └── postgresql-log-sidecar/</span><br><span class="line">│       ├── Chart.yaml</span><br><span class="line">│       ├── templates/</span><br><span class="line">│       │   ├── configmap.yaml</span><br><span class="line">│       │   ├── deployment.yaml</span><br><span class="line">│       │   ├── secret.yaml</span><br><span class="line">│       │   ├── service.yaml</span><br><span class="line">│       ├── values.yaml</span><br><span class="line">├── README.md</span><br></pre></td></tr></table></figure>

<h2 id="1-Architecture-Overview"><a href="#1-Architecture-Overview" class="headerlink" title="1. Architecture Overview"></a>1. Architecture Overview</h2><p>The following diagram shows how the PostgreSQL Pod and the sidecar interact for log collection:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------+</span><br><span class="line">|        PostgreSQL Pod             |</span><br><span class="line">|                                   |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">|  |  PostgreSQL Container       |  |</span><br><span class="line">|  |  - Exposes Port 5432        |  |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">|                                   |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">|  |  Log Collector              |  |</span><br><span class="line">|  |  - Collects Logs            |  |</span><br><span class="line">|  |  - Pushes to Elasticsearch  |  |</span><br><span class="line">|  +-----------------------------+  |</span><br><span class="line">+-----------------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="2-Helm-Chart-Configuration"><a href="#2-Helm-Chart-Configuration" class="headerlink" title="2. Helm Chart Configuration"></a>2. Helm Chart Configuration</h2><h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a><code>Chart.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">postgresql-log-sidecar</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">PostgreSQL</span> <span class="string">with</span> <span class="string">log</span> <span class="string">sidecar</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">&quot;13&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a><code>values.yaml</code></h3><p>Define values for PostgreSQL configuration and the sidecar container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresql:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">password123</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">appdb</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;elasticsearch:9200&quot;</span></span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;postgresql-logs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sidecar:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">fluent/fluent-bit</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&quot;1.8&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-ConfigMap-and-Secret"><a href="#3-ConfigMap-and-Secret" class="headerlink" title="3. ConfigMap and Secret"></a>3. ConfigMap and Secret</h2><h3 id="configmap-yaml"><a href="#configmap-yaml" class="headerlink" title="configmap.yaml"></a><code>configmap.yaml</code></h3><p>This ConfigMap includes log configuration for the sidecar container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [SERVICE]</span></span><br><span class="line"><span class="string">        Flush 1</span></span><br><span class="line"><span class="string">        Log_Level info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span><br><span class="line">        <span class="string">Path</span> <span class="string">/var/log/postgresql/postgresql.log</span></span><br><span class="line">        <span class="string">Tag</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span>  <span class="string">es</span></span><br><span class="line">        <span class="string">Match</span> <span class="string">*</span></span><br><span class="line">        <span class="string">Host</span>  &#123;&#123; <span class="string">.Values.elasticsearch.host</span> &#125;&#125;</span><br><span class="line">        <span class="string">Port</span>  <span class="number">9200</span></span><br><span class="line">        <span class="string">Index</span> &#123;&#123; <span class="string">.Values.elasticsearch.index</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="secret-yaml"><a href="#secret-yaml" class="headerlink" title="secret.yaml"></a><code>secret.yaml</code></h3><p>Create a Secret for PostgreSQL credentials.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">postgresql-username:</span> &#123;&#123; <span class="string">.Values.postgresql.username</span> <span class="string">|</span> <span class="string">b64enc</span> &#125;&#125;</span><br><span class="line">  <span class="attr">postgresql-password:</span> &#123;&#123; <span class="string">.Values.postgresql.password</span> <span class="string">|</span> <span class="string">b64enc</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Deployment-Configuration"><a href="#4-Deployment-Configuration" class="headerlink" title="4. Deployment Configuration"></a>4. Deployment Configuration</h2><h3 id="deployment-yaml"><a href="#deployment-yaml" class="headerlink" title="deployment.yaml"></a><code>deployment.yaml</code></h3><p>The main deployment file sets up PostgreSQL and the Fluent Bit sidecar container.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgresql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> &#123;&#123; <span class="string">.Values.postgresql.database</span> &#125;&#125;</span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">postgresql-secret</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">postgresql-username</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">postgresql-secret</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">postgresql-password</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-logs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/postgresql</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-collector</span></span><br><span class="line">          <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.sidecar.image</span> &#125;&#125;<span class="string">:&#123;&#123;</span> <span class="string">.Values.sidecar.tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/fluent-bit/etc/fluent-bit.conf&quot;</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-logs</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/postgresql</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/fluent-bit/etc</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">fluent-bit.conf</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> &#123;&#123; <span class="string">.Values.sidecar.resources.limits.memory</span> &#125;&#125;</span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> &#123;&#123; <span class="string">.Values.sidecar.resources.requests.memory</span> &#125;&#125;</span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-logs</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br></pre></td></tr></table></figure>

<h3 id="service-yaml"><a href="#service-yaml" class="headerlink" title="service.yaml"></a><code>service.yaml</code></h3><p>Create a Service to expose PostgreSQL internally within the cluster.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgresql</span></span><br></pre></td></tr></table></figure>

<h2 id="5-Deploying-the-Helm-Chart"><a href="#5-Deploying-the-Helm-Chart" class="headerlink" title="5. Deploying the Helm Chart"></a>5. Deploying the Helm Chart</h2><p>Install the chart with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install postgresql-log-sidecar ./charts/postgresql-log-sidecar</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/30/Understanding-Kubernetes-Pods-and-Services/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/30/Understanding-Kubernetes-Pods-and-Services/" class="post-title-link" itemprop="url">Understanding Kubernetes Pods and Services</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-30 23:24:27 / Modified: 23:43:49" itemprop="dateCreated datePublished" datetime="2024-10-30T23:24:27-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>In Kubernetes, <strong>Pods</strong> and <strong>Services</strong> are fundamental components, each with distinct responsibilities that work together to provide scalable, resilient applications. Here’s an in-depth look into how these units interact, their roles, and how they communicate.</p>
<h2 id="1-Kubernetes-Pod-The-Basic-Unit-of-Deployment"><a href="#1-Kubernetes-Pod-The-Basic-Unit-of-Deployment" class="headerlink" title="1. Kubernetes Pod: The Basic Unit of Deployment"></a>1. Kubernetes Pod: The Basic Unit of Deployment</h2><p>A <strong>Pod</strong> is the smallest deployable unit in Kubernetes, representing one or more containers. Containers within the same Pod:</p>
<ul>
<li><strong>Share resources</strong>: Same IP address, storage volumes, and network namespace.</li>
<li><strong>Enable inter-container communication</strong>: Containers in a Pod can access each other on <code>localhost</code>.</li>
<li><strong>Are ephemeral</strong>: When a Pod fails, it is replaced by a new Pod instance, often with a new IP address.</li>
</ul>
<h3 id="Pod-Architecture"><a href="#Pod-Architecture" class="headerlink" title="Pod Architecture"></a>Pod Architecture</h3><p>Each Pod contains one or more containers with shared resources. Below is a textual representation of a typical Pod structure:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+</span><br><span class="line">|        Pod            |</span><br><span class="line">|  IP: 10.244.1.5       |</span><br><span class="line">|                       |</span><br><span class="line">| +------------------+  |</span><br><span class="line">| | Container A      |  |</span><br><span class="line">| | - Application    |  |</span><br><span class="line">| +------------------+  |</span><br><span class="line">|                       |</span><br><span class="line">| +------------------+  |</span><br><span class="line">| | Container B      |  |</span><br><span class="line">| | - Sidecar Proxy  |  |</span><br><span class="line">| +------------------+  |</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>

<p>In this structure, <code>Container A</code> might run the main application, while <code>Container B</code> is a helper (e.g., proxy or logging container). These containers share an IP address and can communicate directly.</p>
<h2 id="2-Real-Scenario-Explaination"><a href="#2-Real-Scenario-Explaination" class="headerlink" title="2. Real Scenario Explaination"></a>2. Real Scenario Explaination</h2><p>In this setup, the sidecar container collects logs from the PostgreSQL container by sharing a directory between them. Here’s a breakdown of how it works:</p>
<ol>
<li><p><strong>Shared Volume</strong>: A shared <code>emptyDir</code> volume, <code>postgres-logs</code>, is mounted in both the PostgreSQL and sidecar containers. PostgreSQL is configured to output logs to <code>/var/log/postgresql</code> within its filesystem, which maps to the shared volume.</p>
</li>
<li><p><strong>Log Collector Configuration</strong>: The sidecar container, running Fluent Bit, is configured to read from <code>/var/log/postgresql</code> (also mapped to the shared volume). Fluent Bit’s configuration specifies the <code>tail</code> input plugin to read new entries as they are appended.</p>
</li>
<li><p><strong>Log Processing and Output</strong>: Fluent Bit processes the logs, then sends them to Elasticsearch through its output configuration, allowing centralized log analysis and monitoring.</p>
</li>
</ol>
<p>This method ensures that logs are constantly accessible to the sidecar without modifying the PostgreSQL container directly.</p>
<h3 id="Example-Fluent-Bit-Configuration-in-configmap-yaml"><a href="#Example-Fluent-Bit-Configuration-in-configmap-yaml" class="headerlink" title="Example Fluent Bit Configuration in configmap.yaml"></a>Example Fluent Bit Configuration in <code>configmap.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [SERVICE]</span></span><br><span class="line"><span class="string">        Flush 1</span></span><br><span class="line"><span class="string">        Log_Level info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span><br><span class="line">        <span class="string">Path</span> <span class="string">/var/log/postgresql/postgresql.log</span></span><br><span class="line">        <span class="string">Tag</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">es</span></span><br><span class="line">        <span class="string">Match</span> <span class="string">*</span></span><br><span class="line">        <span class="string">Host</span> &#123;&#123; <span class="string">.Values.elasticsearch.host</span> &#125;&#125;</span><br><span class="line">        <span class="string">Port</span> <span class="number">9200</span></span><br><span class="line">        <span class="string">Index</span> &#123;&#123; <span class="string">.Values.elasticsearch.index</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>This setup allows the sidecar to monitor log updates efficiently, pushing each entry to Elasticsearch as it appears in the log file.</p>
<h2 id="2-Kubernetes-Service-Stable-Networking-for-Dynamic-Pods"><a href="#2-Kubernetes-Service-Stable-Networking-for-Dynamic-Pods" class="headerlink" title="2. Kubernetes Service: Stable Networking for Dynamic Pods"></a>2. Kubernetes Service: Stable Networking for Dynamic Pods</h2><p>A <strong>Service</strong> is an abstraction that provides a stable, permanent network interface for a set of Pods. Since Pod IP addresses are temporary, a Service routes requests to Pods and handles the load balancing across them.</p>
<h3 id="Key-Service-Types"><a href="#Key-Service-Types" class="headerlink" title="Key Service Types"></a>Key Service Types</h3><ul>
<li><strong>ClusterIP</strong>: Exposes the Service only within the cluster.</li>
<li><strong>NodePort</strong>: Exposes the Service on each node’s IP at a specific port.</li>
<li><strong>LoadBalancer</strong>: Exposes the Service externally, often through a cloud provider’s load balancer.</li>
<li><strong>Headless Service</strong>: Exposes each Pod individually, without load balancing, often used for direct client-to-Pod connections.</li>
</ul>
<h3 id="Example-Service-Architecture"><a href="#Example-Service-Architecture" class="headerlink" title="Example Service Architecture"></a>Example Service Architecture</h3><p>The Service selects Pods with specific labels and routes traffic to them dynamically. Here’s a simplified text diagram for a Service:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+             +------------------+</span><br><span class="line">|  Client Request   |------------&gt;|  Service         |</span><br><span class="line">+-------------------+             |  (ClusterIP)     |</span><br><span class="line">                                  +--------+---------+</span><br><span class="line">                                           |</span><br><span class="line">                                           |</span><br><span class="line">                              +------------+-----------+</span><br><span class="line">                              |                        |</span><br><span class="line">                              |                        |</span><br><span class="line">                      +-------v------+       +---------v------+</span><br><span class="line">                      |    Pod       |       |    Pod         |</span><br><span class="line">                      |  IP: Dynamic |       |  IP: Dynamic   |</span><br><span class="line">                      +--------------+       +----------------+</span><br></pre></td></tr></table></figure>

<p>The Service maintains a list of Pods based on matching labels and routes incoming requests to any healthy Pod in the group, providing an abstraction layer for easy access.</p>
<h2 id="3-Communication-Between-Pods-and-Services"><a href="#3-Communication-Between-Pods-and-Services" class="headerlink" title="3. Communication Between Pods and Services"></a>3. Communication Between Pods and Services</h2><p>Kubernetes manages Pod-to-Service and Service-to-Pod communication using:</p>
<ol>
<li><strong>Labels and Selectors</strong>: Services target Pods by their labels.</li>
<li><strong>Cluster DNS</strong>: Each Service receives a unique hostname, which can be used within the cluster to resolve the Service IP.</li>
<li><strong>Load Balancing</strong>: Services distribute requests across Pods, using internal load balancing mechanisms (IP tables, kube-proxy).</li>
</ol>
<p>When a client inside the cluster calls a Service, Kubernetes DNS resolves the Service name to a virtual IP, and the Service routes the request to one of the associated Pods.</p>
<h3 id="Dynamic-Pod-Communication-Example"><a href="#Dynamic-Pod-Communication-Example" class="headerlink" title="Dynamic Pod Communication Example"></a>Dynamic Pod Communication Example</h3><p>The following diagram illustrates how a Service enables stable access to multiple Pods, even if the Pods are added or removed over time:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+                  +-----------------+</span><br><span class="line">|    Client         |-----------------&gt;| Service: my-app |</span><br><span class="line">+-------------------+                  |  IP: 10.96.0.1  |</span><br><span class="line">                                       +-------+---------+</span><br><span class="line">                                               |</span><br><span class="line">                           +-------------------+-------------------+</span><br><span class="line">                           |                                       |</span><br><span class="line">                  +--------v-----------+                  +--------v------------+</span><br><span class="line">                  |      Pod           |                  |       Pod           |</span><br><span class="line">                  |  Label: app=my-app |                  |   Label: app=my-app |</span><br><span class="line">                  +--------------------+                  +---------------------+</span><br></pre></td></tr></table></figure>

<p>Here, the client accesses <code>my-app</code>, and the Service dynamically routes the request to an available Pod with the matching label.</p>
<h2 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h2><ul>
<li><strong>Pods</strong>: Contain containers, share IP addresses, ephemeral in nature.</li>
<li><strong>Services</strong>: Provide stable, permanent access to a group of Pods with specific labels, enable load balancing, and ensure that applications can consistently reach the backend Pods, even with dynamic scaling.</li>
</ul>
<p>By decoupling Pod IP addresses from the client-facing endpoint, Services ensure reliable, scalable, and high-availability communication within Kubernetes applications.</p>
<h3 id="Example-Fluent-Bit-Configuration-in-configmap-yaml-1"><a href="#Example-Fluent-Bit-Configuration-in-configmap-yaml-1" class="headerlink" title="Example Fluent Bit Configuration in configmap.yaml"></a>Example Fluent Bit Configuration in <code>configmap.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgresql-log-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [SERVICE]</span></span><br><span class="line"><span class="string">        Flush 1</span></span><br><span class="line"><span class="string">        Log_Level info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">tail</span></span><br><span class="line">        <span class="string">Path</span> <span class="string">/var/log/postgresql/postgresql.log</span></span><br><span class="line">        <span class="string">Tag</span> <span class="string">postgresql</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">es</span></span><br><span class="line">        <span class="string">Match</span> <span class="string">*</span></span><br><span class="line">        <span class="string">Host</span> &#123;&#123; <span class="string">.Values.elasticsearch.host</span> &#125;&#125;</span><br><span class="line">        <span class="string">Port</span> <span class="number">9200</span></span><br><span class="line">        <span class="string">Index</span> &#123;&#123; <span class="string">.Values.elasticsearch.index</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>This setup allows the sidecar to monitor log updates efficiently, pushing each entry to Elasticsearch as it appears in the log file.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/30/Microservice-Spring-Cloud-Gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/30/Microservice-Spring-Cloud-Gateway/" class="post-title-link" itemprop="url">Microservice - Spring Cloud Gateway</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-30 11:51:38 / Modified: 18:55:48" itemprop="dateCreated datePublished" datetime="2024-10-30T11:51:38-04:00">2024-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/" itemprop="url" rel="index"><span itemprop="name">Microservice</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Microservice/Spring-Cloud/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#why-we-need-api-gateway">Why We Need API Gateway</a></li>
<li><a href="#build-api-gateway">Build API Gateway</a></li>
<li><a href="#setting-up-api-gateway">Setting Up API Gateway</a></li>
<li><a href="#route-configuration">Route Configuration</a></li>
<li><a href="#security-and-jwt-authentication">Security and JWT Authentication</a></li>
<li><a href="#dockerfile-configuration">Dockerfile Configuration</a></li>
<li><a href="#helm-chart-configuration">Helm Chart Configuration</a></li>
<li><a href="#project-structure">Project Structure</a></li>
<li><a href="#api-gateway-architecture">API Gateway Architecture</a></li>
<li><a href="#sequence-diagrams">Sequence Diagrams</a></li>
<li><a href="#https-configuration-for-api-gateway">HTTPS Configuration for API Gateway</a></li>
<li><a href="#difference-between-lb-and-http-protocols">Difference Between <code>lb://</code> and <code>http://</code> Protocols</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ol>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In a microservices architecture, an API Gateway acts as a single entry point for client requests, routing them to the appropriate microservices within the Kubernetes cluster. This article will delve into the setup and configuration of a Spring Cloud API Gateway, focusing on JWT authentication validation, route management, and deployment using Docker and Helm.</p>
<hr>
<p><a name="why-we-need-api-gateway"></a></p>
<h2 id="Why-We-Need-API-Gateway"><a href="#Why-We-Need-API-Gateway" class="headerlink" title="Why We Need API Gateway"></a>Why We Need API Gateway</h2><h3 id="Single-Entry-Point"><a href="#Single-Entry-Point" class="headerlink" title="Single Entry Point"></a>Single Entry Point</h3><p>An API Gateway provides a single entry point for all client requests, simplifying client-side code and reducing the number of endpoints clients need to interact with.</p>
<h3 id="Routing-and-Load-Balancing"><a href="#Routing-and-Load-Balancing" class="headerlink" title="Routing and Load Balancing"></a>Routing and Load Balancing</h3><p>The gateway routes requests to the appropriate microservices and handles load balancing across multiple instances of each service.</p>
<h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><p>It centralizes security concerns such as authentication and authorization, reducing the need for each microservice to implement these features independently.</p>
<h3 id="Protocol-Translation"><a href="#Protocol-Translation" class="headerlink" title="Protocol Translation"></a>Protocol Translation</h3><p>The gateway can handle protocol translation, allowing clients to use a single protocol (e.g., HTTP&#x2F;2) while communicating with microservices using different protocols.</p>
<hr>
<p><a name="build-api-gateway"></a></p>
<h2 id="Build-API-Gateway"><a href="#Build-API-Gateway" class="headerlink" title="Build API Gateway"></a>Build API Gateway</h2><p><strong>Is there an official API Gateway image?</strong></p>
<ul>
<li><p>Currently, <strong>Spring Cloud Gateway</strong> does not offer an official pre-built Docker image, developers build a Spring Boot application with <code>spring-cloud-starter-gateway</code> and custom configurations (routes, JWT filter, etc.). </p>
</li>
<li><p>As gateway services are often customized for specific routing, load balancing, security and potentially other cross-cutting concerns and needs. It acts as the main entry point for all external requests to your microservices. The gateway can either pull routing configurations from a service discovery mechanism(like Spring Cloud Kubernetes Discovery) or have the configurations set explicitly.</p>
</li>
</ul>
<p><strong>Steps to Build a Production-Ready API Gateway</strong></p>
<ol>
<li><strong>Route Configuration</strong>: Define routing rules either in <code>application.yml</code> or using Java annotations.</li>
<li><strong>Security Setup</strong>: Add JWT validation (e.g., <code>JwtAuthenticationFilter</code>) and configure security policies in the gateway.</li>
<li><strong>Service Discovery</strong>: Use Spring Cloud Kubernetes for service discovery, allowing the gateway to dynamically discover services.</li>
<li><strong>Containerization and Deployment</strong>: Build a Docker image and deploy it to Kubernetes with a Helm chart for scalability and configuration management.</li>
</ol>
<p><a name="setting-up-api-gateway"></a></p>
<h2 id="Setting-Up-API-Gateway"><a href="#Setting-Up-API-Gateway" class="headerlink" title="Setting Up API Gateway"></a>Setting Up API Gateway</h2><h3 id="Step-1-Add-Dependencies"><a href="#Step-1-Add-Dependencies" class="headerlink" title="Step 1: Add Dependencies"></a>Step 1: Add Dependencies</h3><p>Add the necessary dependencies to your <code>pom.xml</code> file.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Cloud Gateway --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Security --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- JWT --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Create-the-Main-Application-Class"><a href="#Step-2-Create-the-Main-Application-Class" class="headerlink" title="Step 2: Create the Main Application Class"></a>Step 2: Create the Main Application Class</h3><p>Create the main application class for the Spring Cloud Gateway.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiGatewayApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ApiGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><a name="service-discovery-and-routing-configuration"></a></p>
<h2 id="Service-Discovery-and-Routing-Configuration"><a href="#Service-Discovery-and-Routing-Configuration" class="headerlink" title="Service Discovery and Routing Configuration"></a>Service Discovery and Routing Configuration</h2><h3 id="YAML-based-Configuration"><a href="#YAML-based-Configuration" class="headerlink" title="YAML-based Configuration"></a>YAML-based Configuration</h3><p>Configure routes in the <code>application.yml</code> file.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span>  <span class="comment"># Ensures lowercase naming for services</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://profile-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://order-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">shipment_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://shipment-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/shipment/**</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">kubernetes:</span></span><br><span class="line">        <span class="attr">discovery:</span></span><br><span class="line">          <span class="attr">all-namespaces:</span> <span class="literal">true</span>  <span class="comment"># Discover services across all namespaces</span></span><br><span class="line">          <span class="attr">service-labels:</span>       <span class="comment"># Optional: filter based on labels</span></span><br><span class="line">            <span class="attr">environment:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>lb:&#x2F;&#x2F;</strong> *&#x2F; scheme: Enables load balancing across multiple instances of each microservice.</li>
<li><strong>Service Discovery</strong>: The gateway will detect microservices like <code>inventory-service</code> or <code>shipment-service</code> using Kubernetes service discovery, eliminating the need for hardcoding service addresses.</li>
</ul>
<h3 id="Annotation-based-Configuration"><a href="#Annotation-based-Configuration" class="headerlink" title="Annotation-based Configuration"></a>Annotation-based Configuration</h3><p>Alternatively, configure routes programmatically using annotations.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayRoutesConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">gatewayRoutes</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(<span class="string">&quot;profile_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/profile/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://profile-svc&quot;</span>))</span><br><span class="line">            .route(<span class="string">&quot;inventory_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/inventory/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://inventory-svc&quot;</span>))</span><br><span class="line">            .route(<span class="string">&quot;order_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/order/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://order-svc&quot;</span>))</span><br><span class="line">            .route(<span class="string">&quot;shipment_service_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/shipment/**&quot;</span>)</span><br><span class="line">                .uri(<span class="string">&quot;lb://shipment-svc&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Enable Service Discovery</strong><br>To enable service discovery, you can use the <code>@EnableDiscoveryClient</code> annotation. This annotation is typically placed in a configuration class.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscoveryConfig</span> &#123;</span><br><span class="line">    <span class="comment">// Additional configuration for service discovery can be added here if needed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="application-yml-Configuration-for-Service-Discovery"><a href="#application-yml-Configuration-for-Service-Discovery" class="headerlink" title="application.yml Configuration for Service Discovery"></a><code>application.yml</code> Configuration for Service Discovery</h3><p>Ensure that the following configuration is present in your <code>application.yml</code> or <code>application.properties</code> file to enable service discovery and other settings:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kubernetes:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">all-namespaces:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-labels:</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li><strong>Annotation-based Configuration</strong>: The <code>GatewayRoutesConfig</code> class defines the routes using the <code>RouteLocatorBuilder</code>.</li>
<li><strong>Service Discovery</strong>: The <code>DiscoveryConfig</code> class enables service discovery using the <code>@EnableDiscoveryClient</code> annotation.</li>
<li><strong>YAML Configuration</strong>: The <code>application.yml</code> file contains the necessary settings for service discovery and gateway configuration.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: The discovery settings, such as enabling discovery locator and configuring Kubernetes discovery, cannot be directly configured using annotations in the configuration class. These settings are typically configured in the <code>application.yml</code> or <code>application.properties</code> file.</p>
</blockquote>
<hr>
<p><a name="security-and-jwt-authentication"></a></p>
<h2 id="Security-and-JWT-Authentication"><a href="#Security-and-JWT-Authentication" class="headerlink" title="Security and JWT Authentication"></a>Security and JWT Authentication</h2><blockquote>
<p><strong>Add Dependencies</strong> Include <code>spring-boot-starter-oauth2-resource-server</code> and <code>spring-cloud-starter-gateway</code> in your <code>pom.xml</code>:</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Gateway Application Properties Configuration</strong>: Configure <code>application.yml</code> for JWT validation. This includes specifying the JWT issuer URI and enabling authorization.</p>
</blockquote>
   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">TokenRelay</span>  <span class="comment"># Forward the token to the downstream services</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">issuer-uri:</span> <span class="string">https://&lt;your-auth-provider&gt;/realms/your-realm</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>TokenRelay Filter</strong>: Passes the JWT token along with requests to the backend services.</li>
<li><strong>Issuer URI</strong>: This points to your authentication provider, e.g., an OpenID Connect provider like Keycloak or Auth0.</li>
</ul>
<blockquote>
<p><strong>Enable JWT Authentication</strong>: Set up <code>SecurityConfig</code> to enable JWT authentication and configure routes for authorized access.</p>
</blockquote>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">securityWebFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeExchange()</span><br><span class="line">            .pathMatchers(<span class="string">&quot;/inventory/**&quot;</span>, <span class="string">&quot;/shipment/**&quot;</span>).authenticated()  <span class="comment">// Require auth for specified paths</span></span><br><span class="line">            .anyExchange().permitAll()</span><br><span class="line">            .and()</span><br><span class="line">            .oauth2ResourceServer()</span><br><span class="line">            .jwt();  <span class="comment">// Enable JWT authentication</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>This configuration restricts access to <code>/inventory/**</code> and <code>/shipment/**</code> endpoints to authenticated users, while allowing others as specified.</li>
</ul>
<blockquote>
<p><strong>Annotation-based Configuration for Routes and Filters</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.web.server.ServerHttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.SecurityWebFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayRoutesConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">gatewayRoutes</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(<span class="string">&quot;inventory-service&quot;</span>, r -&gt; r.path(<span class="string">&quot;/inventory/**&quot;</span>)</span><br><span class="line">                .filters(f -&gt; f.filter(<span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(<span class="string">&quot;ROLE_USER,ROLE_ADMIN&quot;</span>)))</span><br><span class="line">                .uri(<span class="string">&quot;lb://inventory-service&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeExchange()</span><br><span class="line">            .anyExchange().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .oauth2ResourceServer()</span><br><span class="line">            .jwt()</span><br><span class="line">            .jwkSetUri(<span class="string">&quot;https://example-issuer.com/.well-known/jwks.json&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().disable();</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;**Note**: **Annotation-based Configuration**: The `GatewayRoutesConfig` <span class="keyword">class</span> <span class="title class_">defines</span> the routes and filters using the `RouteLocatorBuilder`. It also configures security settings using Spring Security annotations.</span><br></pre></td></tr></table></figure>

<h3 id="JWT-Authentication-Filter"><a href="#JWT-Authentication-Filter" class="headerlink" title="JWT Authentication Filter"></a>JWT Authentication Filter</h3><p>Create a JWT authentication filter to verify incoming requests.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.server.authentication.AuthenticationWebFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.JwtDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.ReactiveJwtDecoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtDecoder jwtDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">        <span class="type">AuthenticationWebFilter</span> <span class="variable">jwtAuthFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationWebFilter</span>(authenticationManager());</span><br><span class="line">        http</span><br><span class="line">            .authorizeExchange()</span><br><span class="line">            .pathMatchers(<span class="string">&quot;/oauth2/**&quot;</span>).permitAll()</span><br><span class="line">            .pathMatchers(<span class="string">&quot;/inventory/**&quot;</span>, <span class="string">&quot;/shipment/**&quot;</span>).authenticated().permitAll()</span><br><span class="line">            .anyExchange().authenticated()</span><br><span class="line">            .and().addFilterAt(jwtAuthFilter, SecurityWebFiltersOrder.AUTHENTICATION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationManager</span>(jwtDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JWT-Decoder-Configuration"><a href="#JWT-Decoder-Configuration" class="headerlink" title="JWT Decoder Configuration"></a>JWT Decoder Configuration</h3><p>Configure the JWT decoder to validate tokens.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.JwtDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.jwt.NimbusJwtDecoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtDecoder <span class="title function_">jwtDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NimbusJwtDecoder.withPublicKey(publicKey).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="service-to-service-communication-via-gateway"></a></p>
<h2 id="Service-to-Service-Communication-via-Gateway"><a href="#Service-to-Service-Communication-via-Gateway" class="headerlink" title="Service-to-Service Communication via Gateway"></a>Service-to-Service Communication via Gateway</h2><p>To communicate between services, such as <strong>shipment-service</strong> needing to communicate with <strong>inventory-service</strong>, microservices can send requests through the <strong>API Gateway</strong>. </p>
<p>This method simplifies routing, as services only need to know the <strong>gateway address</strong> and the <strong>service paths</strong> (e.g., <code>/inventory/**</code>). This approach enhances security and centralizes cross-cutting concerns like authentication, logging, and rate limiting.</p>
<h4 id="Benefits-of-Gateway-based-Communication"><a href="#Benefits-of-Gateway-based-Communication" class="headerlink" title="Benefits of Gateway-based Communication"></a>Benefits of Gateway-based Communication</h4><ol>
<li><strong>Centralized Security</strong>: JWT and other auth mechanisms can be handled at the gateway.</li>
<li><strong>Simplified Routing</strong>: Each service interacts with others via a single entry point.</li>
<li><strong>Enhanced Scalability</strong>: Kubernetes manages load balancing for each service, and the gateway balances requests across pods.</li>
</ol>
<hr>
<h3 id="Service-Discovery-and-Routing-Workflow"><a href="#Service-Discovery-and-Routing-Workflow" class="headerlink" title="Service Discovery and Routing Workflow"></a>Service Discovery and Routing Workflow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[External Client] --&gt; [API Gateway]</span><br><span class="line">                          |</span><br><span class="line">                          | (Discovers routes from Kubernetes Discovery)</span><br><span class="line">                          |</span><br><span class="line">                   [inventory-service] &lt;--+-- &quot;lb://inventory-service&quot;</span><br><span class="line">                   [shipment-service]   &lt;--+-- &quot;lb://shipment-service&quot;</span><br><span class="line">                   [other-service]      &lt;--+-- Discovered automatically</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Sequence Diagram: Inventory and Shipment Communication via Gateway</p>
</blockquote>
<ol>
<li><strong>Shipment Service</strong> sends a request to <strong>API Gateway</strong> at <code>/inventory/items</code>.</li>
<li><strong>API Gateway</strong> validates the JWT token, looks up <strong>inventory-service</strong> route, and forwards the request.</li>
<li><strong>Inventory Service</strong> responds with the requested data.</li>
<li><strong>API Gateway</strong> relays the response to <strong>Shipment Service</strong>.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Shipment Service --&gt; API Gateway: Request /inventory/items with JWT</span><br><span class="line">API Gateway --&gt; inventory-service: Validate JWT and route to inventory</span><br><span class="line">inventory-service --&gt; API Gateway: Return data</span><br><span class="line">API Gateway --&gt; Shipment Service: Relay data response</span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<p><strong>Example</strong>: Sending an Authenticated Request to Another Microservice via the Gateway</p>
</blockquote>
<p>In <strong>shipment-service</strong>, use Spring’s <strong>WebClient</strong> to call the <strong>inventory-service</strong> through the API Gateway.</p>
<ol>
<li><p><strong>Define WebClient Bean</strong> for Consistency Across Calls</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebClient.Builder <span class="title function_">webClientBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> WebClient.builder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Send Authenticated Request through Gateway</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WebClient.Builder webClientBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> InventoryResponse <span class="title function_">fetchInventoryItems</span><span class="params">(String token)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> webClientBuilder</span><br><span class="line">        .build()</span><br><span class="line">        .get()</span><br><span class="line">        .uri(<span class="string">&quot;http://api-gateway/inventory/items&quot;</span>)</span><br><span class="line">        .header(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + token)</span><br><span class="line">        .retrieve()</span><br><span class="line">        .bodyToMono(InventoryResponse.class)</span><br><span class="line">        .block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Token Forwarding</strong>: The token is forwarded with the request, allowing the gateway to validate it before routing to the target service.</li>
<li><strong>Gateway URI</strong>: Requests go through <code>http://api-gateway/inventory/items</code>, routing based on service discovery.</li>
</ul>
</li>
</ol>
<blockquote>
<p>In this example:</p>
</blockquote>
<ul>
<li>The <strong>gateway is deployed separately</strong> in Kubernetes and handles dynamic service discovery and routing via <code>lb://</code> URIs.</li>
<li>Service-to-service calls leverage the <strong>API Gateway</strong> for ease of scaling, simplified routing, and centralized security. Each service only needs to know the <strong>API Gateway’s address and service paths</strong>.</li>
</ul>
<hr>
<h3 id="Comparison-Gateway-vs-Direct-Service-to-Service-Calls"><a href="#Comparison-Gateway-vs-Direct-Service-to-Service-Calls" class="headerlink" title="Comparison: Gateway vs. Direct Service-to-Service Calls"></a>Comparison: Gateway vs. Direct Service-to-Service Calls</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>API Gateway Routing</th>
<th>Direct Service-to-Service Calls</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Routing</strong></td>
<td>Centralized, via API Gateway</td>
<td>Direct, each service must know other services</td>
</tr>
<tr>
<td><strong>JWT Validation</strong></td>
<td>Centralized in Gateway</td>
<td>Each service needs to validate tokens</td>
</tr>
<tr>
<td><strong>Scaling</strong></td>
<td>Gateway handles scaling and balancing</td>
<td>Each service scales independently</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>JWT validated once at the gateway</td>
<td>JWT validation needed in each service</td>
</tr>
<tr>
<td><strong>Use Case</strong></td>
<td>Best for external and internal calls</td>
<td>Ideal for internal-only, tightly integrated</td>
</tr>
</tbody></table>
<hr>
<p><a name="dockerfile-configuration"></a></p>
<h2 id="Dockerfile-Configuration"><a href="#Dockerfile-Configuration" class="headerlink" title="Dockerfile Configuration"></a>Dockerfile Configuration</h2><p>Create a <code>Dockerfile</code> for building the API Gateway image.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start with the base image for Java</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set working directory</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy the API Gateway JAR to the image</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/api-gateway.jar api-gateway.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expose port 8443 for the API Gateway</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the API Gateway application</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;api-gateway.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Build-and-Push-the-Docker-Image"><a href="#Build-and-Push-the-Docker-Image" class="headerlink" title="Build and Push the Docker Image"></a>Build and Push the Docker Image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myregistry/api-gateway:latest .</span><br><span class="line">docker push myregistry/api-gateway:latest</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="helm-chart-configuration"></a></p>
<h2 id="Helm-Chart-Configuration"><a href="#Helm-Chart-Configuration" class="headerlink" title="Helm Chart Configuration"></a>Helm Chart Configuration</h2><h3 id="Helm-Chart-Structure"><a href="#Helm-Chart-Structure" class="headerlink" title="Helm Chart Structure"></a>Helm Chart Structure</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">api-gateway/</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── values.yaml</span><br><span class="line">└── templates/</span><br><span class="line">    ├── deployment.yaml</span><br><span class="line">    ├── service.yaml</span><br><span class="line">    └── ingress.yaml</span><br></pre></td></tr></table></figure>

<h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">API</span> <span class="string">Gateway</span> <span class="string">for</span> <span class="string">Microservices</span></span><br></pre></td></tr></table></figure>

<h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">myregistry/api-gateway</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replicaCount:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">api-gateway-tls</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">api.example.com</span></span><br></pre></td></tr></table></figure>

<h3 id="templates-deployment-yaml"><a href="#templates-deployment-yaml" class="headerlink" title="templates&#x2F;deployment.yaml"></a>templates&#x2F;deployment.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.replicaCount</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Values.image.repository &#125;&#125;</span>:<span class="template-variable">&#123;&#123; .Values.image.tag &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure>

<h3 id="templates-service-yaml"><a href="#templates-service-yaml" class="headerlink" title="templates&#x2F;service.yaml"></a>templates&#x2F;service.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> &#123;&#123; <span class="string">.Values.service.type</span> &#125;&#125;</span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> &#123;&#123; <span class="string">.Values.service.port</span> &#125;&#125;</span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">api-gateway</span></span><br></pre></td></tr></table></figure>

<h3 id="templates-ingress-yaml"><a href="#templates-ingress-yaml" class="headerlink" title="templates&#x2F;ingress.yaml"></a>templates&#x2F;ingress.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">api-gateway-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="project-structure"></a></p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">api-gateway/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── main/</span><br><span class="line">│   │   ├── java/</span><br><span class="line">│   │   │   └── com/</span><br><span class="line">│   │   │       └── example/</span><br><span class="line">│   │   │           └── apigateway/</span><br><span class="line">│   │   │               ├── ApiGatewayApplication.java</span><br><span class="line">│   │   │               ├── config/</span><br><span class="line">│   │   │               │   ├── GatewayRoutesConfig.java</span><br><span class="line">│   │   │               │   ├── SecurityConfig.java</span><br><span class="line">│   │   │               │   └── JwtConfig.java</span><br><span class="line">│   │   └── resources/</span><br><span class="line">│   │       └── application.yml</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── pom.xml</span><br><span class="line">└── helm/</span><br><span class="line">    └── api-gateway/</span><br><span class="line">        ├── Chart.yaml</span><br><span class="line">        ├── values.yaml</span><br><span class="line">        └── templates/</span><br><span class="line">            ├── deployment.yaml</span><br><span class="line">            ├── service.yaml</span><br><span class="line">            └── ingress.yaml</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="api-gateway-architecture"></a></p>
<h2 id="API-Gateway-Architecture"><a href="#API-Gateway-Architecture" class="headerlink" title="API Gateway Architecture"></a>API Gateway Architecture</h2><pre><code class="highlight mermaid">graph TD
    A[Client] --&gt;|HTTPS| B[API Gateway]
    B --&gt;|lb://| C[Profile Service]
    B --&gt;|lb://| D[Inventory Service]
    B --&gt;|lb://| E[Order Service]
    B --&gt;|lb://| F[Shipment Service]
    B --&gt;|lb://| G[OAuth2 Service]</code></pre>

<h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h3><ol>
<li><strong>Client</strong>: Sends requests to the API Gateway over HTTPS.</li>
<li><strong>API Gateway</strong>: Routes requests to the appropriate microservice using <code>lb://</code> protocol.</li>
<li><strong>Microservices</strong>: Each service handles requests and returns responses to the API Gateway.</li>
</ol>
<hr>
<p><a name="sequence-diagrams"></a></p>
<h2 id="Sequence-Diagrams"><a href="#Sequence-Diagrams" class="headerlink" title="Sequence Diagrams"></a>Sequence Diagrams</h2><h3 id="Sequence-Diagram-for-Client-Request"><a href="#Sequence-Diagram-for-Client-Request" class="headerlink" title="Sequence Diagram for Client Request"></a>Sequence Diagram for Client Request</h3><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant Profile Service
    participant Inventory Service
    participant Order Service
    participant Shipment Service

    Client-&gt;&gt;API Gateway: HTTPS Request
    API Gateway-&gt;&gt;Profile Service: lb://profile-svc
    API Gateway-&gt;&gt;Inventory Service: lb://inventory-svc
    API Gateway-&gt;&gt;Order Service: lb://order-svc
    API Gateway-&gt;&gt;Shipment Service: lb://shipment-svc
    Profile Service--&gt;&gt;API Gateway: Response
    Inventory Service--&gt;&gt;API Gateway: Response
    Order Service--&gt;&gt;API Gateway: Response
    Shipment Service--&gt;&gt;API Gateway: Response
    API Gateway--&gt;&gt;Client: HTTPS Response</code></pre>

<h3 id="Sequence-Diagram-for-JWT-Authentication"><a href="#Sequence-Diagram-for-JWT-Authentication" class="headerlink" title="Sequence Diagram for JWT Authentication"></a>Sequence Diagram for JWT Authentication</h3><pre><code class="highlight mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant OAuth2 Service

    Client-&gt;&gt;API Gateway: HTTPS Request with JWT
    API Gateway-&gt;&gt;OAuth2 Service: Validate JWT
    OAuth2 Service--&gt;&gt;API Gateway: JWT Valid
    API Gateway--&gt;&gt;Client: HTTPS Response</code></pre>

<hr>
<p><a name="https-configuration-for-api-gateway"></a></p>
<h2 id="HTTPS-Configuration-for-API-Gateway"><a href="#HTTPS-Configuration-for-API-Gateway" class="headerlink" title="HTTPS Configuration for API Gateway"></a>HTTPS Configuration for API Gateway</h2><h3 id="Step-1-Generate-SSL-Certificate"><a href="#Step-1-Generate-SSL-Certificate" class="headerlink" title="Step 1: Generate SSL Certificate"></a>Step 1: Generate SSL Certificate</h3><p>Generate a self-signed SSL certificate or obtain one from a Certificate Authority (CA).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generate a self-signed certificate (for testing purposes)</span></span><br><span class="line">keytool -genkeypair -<span class="built_in">alias</span> api-gateway -keyalg RSA -keysize 2048 -storetype PKCS12 -keystore api-gateway-keystore.p12 -validity 365</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Configure-HTTPS-in-application-yml"><a href="#Step-2-Configure-HTTPS-in-application-yml" class="headerlink" title="Step 2: Configure HTTPS in application.yml"></a>Step 2: Configure HTTPS in <code>application.yml</code></h3><p>Add the keystore settings to <code>application.yml</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">ssl:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">key-store:</span> <span class="string">classpath:api-gateway-keystore.p12</span></span><br><span class="line">    <span class="attr">key-store-password:</span> <span class="string">your_password_here</span></span><br><span class="line">    <span class="attr">key-store-type:</span> <span class="string">PKCS12</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-3-Update-Routes-to-Use-lb"><a href="#Step-3-Update-Routes-to-Use-lb" class="headerlink" title="Step 3: Update Routes to Use lb://"></a>Step 3: Update Routes to Use <code>lb://</code></h3><p>Ensure that the routes use <code>lb://</code> to leverage service discovery and load balancing.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://profile-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://order-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">shipment_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://shipment-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/shipment/**</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-4-Update-Kubernetes-Ingress-for-HTTPS"><a href="#Step-4-Update-Kubernetes-Ingress-for-HTTPS" class="headerlink" title="Step 4: Update Kubernetes Ingress for HTTPS"></a>Step 4: Update Kubernetes Ingress for HTTPS</h3><p>Configure the Kubernetes Ingress to redirect traffic to the API Gateway’s HTTPS endpoint.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">api-gateway-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="difference-between-lb-and-http-protocols"></a></p>
<h2 id="Difference-Between-lb-and-http-Protocols"><a href="#Difference-Between-lb-and-http-Protocols" class="headerlink" title="Difference Between lb:// and http:// Protocols"></a>Difference Between <code>lb://</code> and <code>http://</code> Protocols</h2><h3 id="lb-Protocol"><a href="#lb-Protocol" class="headerlink" title="lb:// Protocol"></a><code>lb://</code> Protocol</h3><ul>
<li><strong>Service Discovery</strong>: Uses Kubernetes service discovery to find the appropriate service instance.</li>
<li><strong>Load Balancing</strong>: Automatically load balances requests across multiple instances of the service.</li>
<li><strong>Dynamic Routing</strong>: Routes can be dynamically updated based on service availability.</li>
</ul>
<p>Example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://profile-svc</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br></pre></td></tr></table></figure>

<h3 id="http-Protocol"><a href="#http-Protocol" class="headerlink" title="http:// Protocol"></a><code>http://</code> Protocol</h3><ul>
<li><strong>Direct Routing</strong>: Routes requests directly to a specific URL.</li>
<li><strong>No Load Balancing</strong>: Does not provide load balancing or service discovery.</li>
<li><strong>Static Routing</strong>: Routes are static and do not change based on service availability.</li>
</ul>
<p>Example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">profile_service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://profile-svc:8080</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/profile/**</span></span><br></pre></td></tr></table></figure>

<h3 id="When-to-Use-Each-Protocol"><a href="#When-to-Use-Each-Protocol" class="headerlink" title="When to Use Each Protocol"></a>When to Use Each Protocol</h3><ul>
<li><strong>Use <code>lb://</code></strong> for routes within Kubernetes service discovery, allowing the gateway to leverage load balancing.</li>
<li><strong>Use <code>http://</code></strong> for direct routes to a specific URL or when no service discovery is available.</li>
</ul>
<p><a name="the-other-option"></a></p>
<h1 id="The-other-option"><a href="#The-other-option" class="headerlink" title="The other option"></a>The other option</h1><p>Here’s a step-by-step setup for building the API Gateway with JWT authentication and routing configurations:</p>
<h3 id="Step-1-Configure-API-Gateway-with-JWT-Authentication-and-Routing"><a href="#Step-1-Configure-API-Gateway-with-JWT-Authentication-and-Routing" class="headerlink" title="Step 1: Configure API Gateway with JWT Authentication and Routing"></a>Step 1: Configure API Gateway with JWT Authentication and Routing</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">inventory-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://inventory-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/inventory/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JwtAuthenticationFilter</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">roles:</span> <span class="string">&quot;ROLE_USER,ROLE_ADMIN&quot;</span>  <span class="comment"># Add roles if role-based access is needed</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># Enables dynamic route lookup from discovery service</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">StripPrefix=1</span>  <span class="comment"># Adjusts the path for downstream services</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">issuer-uri:</span> <span class="string">https://example-issuer.com</span>  <span class="comment"># Point to the JWT issuer</span></span><br><span class="line">          <span class="attr">jwk-set-uri:</span> <span class="string">https://example-issuer.com/.well-known/jwks.json</span>  <span class="comment"># Set up for validation</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Implement-JWT-Authentication-Filter-for-Gateway"><a href="#Step-2-Implement-JWT-Authentication-Filter-for-Gateway" class="headerlink" title="Step 2: Implement JWT Authentication Filter for Gateway"></a>Step 2: Implement JWT Authentication Filter for Gateway</h3><p>The custom JWT filter ensures each request includes a valid JWT token.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JwtAuthenticationFilter.java</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">GatewayFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtDecoder jwtDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(JwtDecoder jwtDecoder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jwtDecoder = jwtDecoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authHeader</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span> (authHeader != <span class="literal">null</span> &amp;&amp; authHeader.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> authHeader.substring(<span class="number">7</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> jwtDecoder.decode(token);  <span class="comment">// Validates the JWT</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);       <span class="comment">// If valid, proceed with the request</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">                exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">                <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Add the filter in <code>application.yml</code> for it to be applied to specific routes (like <code>inventory-service</code> in this case).</p>
<h3 id="Step-3-Building-and-Deploying-the-API-Gateway-as-a-Docker-Image"><a href="#Step-3-Building-and-Deploying-the-API-Gateway-as-a-Docker-Image" class="headerlink" title="Step 3: Building and Deploying the API Gateway as a Docker Image"></a>Step 3: Building and Deploying the API Gateway as a Docker Image</h3><ol>
<li><p><strong>Dockerfile</strong> for the API Gateway:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile for api-gateway</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE=target/api-gateway.jar</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;JAR_FILE&#125;</span> api-gateway.jar</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/api-gateway.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Build the Docker Image</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myregistry/api-gateway:latest .</span><br><span class="line">docker push myregistry/api-gateway:latest  <span class="comment"># Push to your registry</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes Deployment Configuration</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api-gateway-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">api-gateway</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">myregistry/api-gateway:latest</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Step-4-Service-to-Service-Communication-via-Gateway"><a href="#Step-4-Service-to-Service-Communication-via-Gateway" class="headerlink" title="Step 4: Service-to-Service Communication via Gateway"></a>Step 4: Service-to-Service Communication via Gateway</h3><p>Now, other services can call the gateway (using <code>api-gateway</code> service DNS) and append the target service’s route (<code>/inventory/*</code>) to the request path.</p>
<h4 id="Sample-Code-for-a-Downstream-Service-Request-Using-WebClient-with-JWT"><a href="#Sample-Code-for-a-Downstream-Service-Request-Using-WebClient-with-JWT" class="headerlink" title="Sample Code for a Downstream Service Request Using WebClient with JWT"></a>Sample Code for a Downstream Service Request Using WebClient with JWT</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ShipmentService.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShipmentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ShipmentService</span><span class="params">(WebClient.Builder webClientBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClientBuilder</span><br><span class="line">                .baseUrl(<span class="string">&quot;http://api-gateway&quot;</span>)  <span class="comment">// Gateway URL in Kubernetes DNS</span></span><br><span class="line">                .defaultHeader(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + jwtToken)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Inventory <span class="title function_">getInventory</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.get()</span><br><span class="line">                .uri(<span class="string">&quot;/inventory/&quot;</span> + id)</span><br><span class="line">                .retrieve()</span><br><span class="line">                .bodyToMono(Inventory.class)</span><br><span class="line">                .block();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Comparison-Gateway-vs-Interceptor-Based-JWT-Validation"><a href="#Comparison-Gateway-vs-Interceptor-Based-JWT-Validation" class="headerlink" title="Comparison: Gateway vs. Interceptor-Based JWT Validation"></a>Comparison: Gateway vs. Interceptor-Based JWT Validation</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>Gateway with JWT Filter</th>
<th>Service-Level JWT Interceptors</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Centralized Control</strong></td>
<td>All JWT validation centralized at gateway</td>
<td>Each service has independent JWT validation</td>
</tr>
<tr>
<td><strong>Configuration Complexity</strong></td>
<td>Easier for microservices, managed in gateway</td>
<td>More complex across multiple services</td>
</tr>
<tr>
<td><strong>Performance Overhead</strong></td>
<td>Can cause bottleneck at gateway if overloaded</td>
<td>Distributed load, but duplicate processing</td>
</tr>
<tr>
<td><strong>Resilience</strong></td>
<td>Single point of failure without redundancy</td>
<td>More resilient, distributed across services</td>
</tr>
<tr>
<td><strong>Authorization Flexibility</strong></td>
<td>Offers consistent authentication policy</td>
<td>Each service can implement role-based restrictions</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
