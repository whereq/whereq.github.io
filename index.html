<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">89</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/18/Imperative-Loops-vs-reduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/18/Imperative-Loops-vs-reduce/" class="post-title-link" itemprop="url">Imperative Loops vs reduce</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-18 13:23:30 / Modified: 13:52:54" itemprop="dateCreated datePublished" datetime="2025-12-18T13:23:30-05:00">2025-12-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/reduce/" itemprop="url" rel="index"><span itemprop="name">reduce</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/reduce/CQRS/" itemprop="url" rel="index"><span itemprop="name">CQRS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Below is a <strong>standalone, diagram-heavy technical illustration document</strong> focused on <strong>one core comparison</strong>:</p>
<blockquote>
<p><strong>Imperative loops vs <code>reduce</code></strong><br>Why imperative loops hide mutation, why they are hard to replay, and why <strong>event sourcing naturally falls out of <code>reduce</code> with immutability</strong>.</p>
</blockquote>
<p>No conversational tone, no personalization.</p>
<hr>
<h1 id="Imperative-Loops-vs-reduce"><a href="#Imperative-Loops-vs-reduce" class="headerlink" title="Imperative Loops vs reduce"></a>Imperative Loops vs <code>reduce</code></h1><h2 id="Hidden-Mutation-Replayability-and-Event-Sourcing"><a href="#Hidden-Mutation-Replayability-and-Event-Sourcing" class="headerlink" title="Hidden Mutation, Replayability, and Event Sourcing"></a>Hidden Mutation, Replayability, and Event Sourcing</h2><hr>
<h2 id="1-Two-Ways-to-Process-a-Sequence"><a href="#1-Two-Ways-to-Process-a-Sequence" class="headerlink" title="1. Two Ways to Process a Sequence"></a>1. Two Ways to Process a Sequence</h2><h3 id="Imperative-loop"><a href="#Imperative-loop" class="headerlink" title="Imperative loop"></a>Imperative loop</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state = PortfolioState()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> op <span class="keyword">in</span> operations:</span><br><span class="line">    state.apply(op)</span><br></pre></td></tr></table></figure>

<h3 id="Functional-reduce"><a href="#Functional-reduce" class="headerlink" title="Functional reduce"></a>Functional reduce</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final_state = reduce(apply, operations, PortfolioState())</span><br></pre></td></tr></table></figure>

<p>At first glance these appear equivalent.<br>Architecturally, they are <strong>fundamentally different</strong>.</p>
<hr>
<h2 id="2-Why-Imperative-Loops-Have-Hidden-Mutation"><a href="#2-Why-Imperative-Loops-Have-Hidden-Mutation" class="headerlink" title="2. Why Imperative Loops Have Hidden Mutation"></a>2. Why Imperative Loops Have Hidden Mutation</h2><h3 id="2-1-Mutation-Is-Implicit"><a href="#2-1-Mutation-Is-Implicit" class="headerlink" title="2.1 Mutation Is Implicit"></a>2.1 Mutation Is Implicit</h3><p>In an imperative loop:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state = initial</span><br><span class="line">state = mutated</span><br><span class="line">state = mutated again</span><br><span class="line">state = mutated again</span><br></pre></td></tr></table></figure>

<p>But <strong>previous states no longer exist</strong>.</p>
<hr>
<h3 id="Diagram-Imperative-Mutation"><a href="#Diagram-Imperative-Mutation" class="headerlink" title="Diagram: Imperative Mutation"></a>Diagram: Imperative Mutation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ State      â”‚</span><br><span class="line">â”‚ (same ref) â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">      â”‚ apply(op1)</span><br><span class="line">      â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ State&#x27;     â”‚  â† original overwritten</span><br><span class="line">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">      â”‚ apply(op2)</span><br><span class="line">      â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ State&#x27;&#x27;    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p>Key problem:</p>
<ul>
<li>One memory location</li>
<li>History destroyed</li>
<li>Mutation is <strong>invisible unless traced manually</strong></li>
</ul>
<hr>
<h3 id="2-2-Hidden-Coupling-in-Imperative-Code"><a href="#2-2-Hidden-Coupling-in-Imperative-Code" class="headerlink" title="2.2 Hidden Coupling in Imperative Code"></a>2.2 Hidden Coupling in Imperative Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">state.cash -= amount</span><br><span class="line">state.position += qty</span><br></pre></td></tr></table></figure>

<p>What this hides:</p>
<ul>
<li>Order dependency</li>
<li>Temporal coupling</li>
<li>Side effects across methods</li>
</ul>
<p>There is <strong>no explicit contract</strong> describing:</p>
<ul>
<li>What changed</li>
<li>Why it changed</li>
<li>What the previous state was</li>
</ul>
<hr>
<h2 id="3-Why-Imperative-Loops-Are-Hard-to-Replay"><a href="#3-Why-Imperative-Loops-Are-Hard-to-Replay" class="headerlink" title="3. Why Imperative Loops Are Hard to Replay"></a>3. Why Imperative Loops Are Hard to Replay</h2><h3 id="3-1-Replay-Requires-Re-executing-Code"><a href="#3-1-Replay-Requires-Re-executing-Code" class="headerlink" title="3.1 Replay Requires Re-executing Code"></a>3.1 Replay Requires Re-executing Code</h3><p>To replay imperative logic:</p>
<ul>
<li>Same input</li>
<li>Same code</li>
<li>Same environment</li>
<li>Same side effects</li>
</ul>
<p>Any difference breaks replay.</p>
<hr>
<h3 id="Diagram-Imperative-Replay-Attempt"><a href="#Diagram-Imperative-Replay-Attempt" class="headerlink" title="Diagram: Imperative Replay Attempt"></a>Diagram: Imperative Replay Attempt</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">operations â”€â”€â–¶ for-loop â”€â”€â–¶ final state</span><br><span class="line">                    â–²</span><br><span class="line">                    â”‚</span><br><span class="line">            requires exact code path</span><br></pre></td></tr></table></figure>

<p>Issues:</p>
<ul>
<li>Non-determinism (time, IO, randomness)</li>
<li>Hidden mutation order</li>
<li>Side effects mixed with logic</li>
</ul>
<hr>
<h3 id="3-2-No-Intermediate-Checkpoints"><a href="#3-2-No-Intermediate-Checkpoints" class="headerlink" title="3.2 No Intermediate Checkpoints"></a>3.2 No Intermediate Checkpoints</h3><p>Want to inspect state after step 3?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Impossible unless:</span><br><span class="line">- Debugger</span><br><span class="line">- Manual logging</span><br><span class="line">- Re-running with breakpoints</span><br></pre></td></tr></table></figure>

<p>State evolution is <strong>not data</strong>, it is <strong>behavior</strong>.</p>
<hr>
<h2 id="4-reduce-State-as-a-Value-Not-a-Place"><a href="#4-reduce-State-as-a-Value-Not-a-Place" class="headerlink" title="4. reduce: State as a Value, Not a Place"></a>4. <code>reduce</code>: State as a Value, Not a Place</h2><h3 id="Reduce-signature"><a href="#Reduce-signature" class="headerlink" title="Reduce signature"></a>Reduce signature</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reduce(f, events, initial_state)</span><br></pre></td></tr></table></figure>

<p>Meaning:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stateâ‚™ = f(Stateâ‚™â‚‹â‚, Eventâ‚™)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Diagram-Reduce-as-State-Evolution"><a href="#Diagram-Reduce-as-State-Evolution" class="headerlink" title="Diagram: Reduce as State Evolution"></a>Diagram: Reduce as State Evolution</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">InitialState</span><br><span class="line">     â”‚</span><br><span class="line">     â”œâ”€ f(event1) â†’ State1</span><br><span class="line">     â”‚</span><br><span class="line">     â”œâ”€ f(event2) â†’ State2</span><br><span class="line">     â”‚</span><br><span class="line">     â”œâ”€ f(event3) â†’ State3</span><br><span class="line">     â”‚</span><br><span class="line">     â””â”€ f(event4) â†’ FinalState</span><br></pre></td></tr></table></figure>

<p>Every state:</p>
<ul>
<li>Exists</li>
<li>Is independent</li>
<li>Is immutable</li>
</ul>
<hr>
<h2 id="5-Why-reduce-Is-Immutable-by-Construction"><a href="#5-Why-reduce-Is-Immutable-by-Construction" class="headerlink" title="5. Why reduce Is Immutable by Construction"></a>5. Why <code>reduce</code> Is Immutable by Construction</h2><h3 id="5-1-No-In-Place-Updates"><a href="#5-1-No-In-Place-Updates" class="headerlink" title="5.1 No In-Place Updates"></a>5.1 No In-Place Updates</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">apply</span>(<span class="params">state, event</span>):</span><br><span class="line">    <span class="keyword">return</span> new_state</span><br></pre></td></tr></table></figure>

<p>Rules:</p>
<ul>
<li>Input state is untouched</li>
<li>New state is returned</li>
<li>Old state still exists</li>
</ul>
<hr>
<h3 id="Diagram-Value-Based-State"><a href="#Diagram-Value-Based-State" class="headerlink" title="Diagram: Value-Based State"></a>Diagram: Value-Based State</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">State0 â”€â”€â–¶ State1 â”€â”€â–¶ State2 â”€â”€â–¶ State3</span><br><span class="line">   â–²          â–²          â–²</span><br><span class="line">   â”‚          â”‚          â”‚</span><br><span class="line">  retained   retained   retained</span><br></pre></td></tr></table></figure>

<p>No overwrite. No loss.</p>
<hr>
<h3 id="5-2-Immutability-Is-Structural-Not-Optional"><a href="#5-2-Immutability-Is-Structural-Not-Optional" class="headerlink" title="5.2 Immutability Is Structural, Not Optional"></a>5.2 Immutability Is Structural, Not Optional</h3><p>In imperative code, immutability is a <strong>discipline</strong>.</p>
<p>In <code>reduce</code>, immutability is a <strong>requirement</strong>:</p>
<ul>
<li>Reducer must return a value</li>
<li>Mutation breaks referential transparency</li>
</ul>
<hr>
<h2 id="6-Replay-Becomes-Trivial-with-Reduce"><a href="#6-Replay-Becomes-Trivial-with-Reduce" class="headerlink" title="6. Replay Becomes Trivial with Reduce"></a>6. Replay Becomes Trivial with Reduce</h2><h3 id="Replay-re-run-reduce"><a href="#Replay-re-run-reduce" class="headerlink" title="Replay &#x3D; re-run reduce"></a>Replay &#x3D; re-run reduce</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reduce(apply, events, initial)</span><br></pre></td></tr></table></figure>

<p>To replay:</p>
<ul>
<li>Same events</li>
<li>Same reducer</li>
<li>Always same result</li>
</ul>
<hr>
<h3 id="Diagram-Replayability"><a href="#Diagram-Replayability" class="headerlink" title="Diagram: Replayability"></a>Diagram: Replayability</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Event Log</span><br><span class="line">   â”‚</span><br><span class="line">   â”œâ”€â–¶ reduce â†’ State T1</span><br><span class="line">   â”‚</span><br><span class="line">   â”œâ”€â–¶ reduce â†’ State T2</span><br><span class="line">   â”‚</span><br><span class="line">   â””â”€â–¶ reduce â†’ State T3</span><br></pre></td></tr></table></figure>

<p>Replay is <strong>data-driven</strong>, not code-driven.</p>
<hr>
<h2 id="7-Event-Sourcing-Naturally-Falls-Out-of-Reduce"><a href="#7-Event-Sourcing-Naturally-Falls-Out-of-Reduce" class="headerlink" title="7. Event Sourcing Naturally Falls Out of Reduce"></a>7. Event Sourcing Naturally Falls Out of Reduce</h2><h3 id="Definition-alignment"><a href="#Definition-alignment" class="headerlink" title="Definition alignment"></a>Definition alignment</h3><table>
<thead>
<tr>
<th>Event Sourcing Concept</th>
<th>Reduce Equivalent</th>
</tr>
</thead>
<tbody><tr>
<td>Event</td>
<td>Element in list</td>
</tr>
<tr>
<td>Event Store</td>
<td>List &#x2F; stream</td>
</tr>
<tr>
<td>Aggregate</td>
<td>Accumulator</td>
</tr>
<tr>
<td>Projection</td>
<td>Reducer</td>
</tr>
<tr>
<td>Replay</td>
<td>Re-run reduce</td>
</tr>
</tbody></table>
<hr>
<h3 id="Event-sourcing-formula"><a href="#Event-sourcing-formula" class="headerlink" title="Event sourcing formula"></a>Event sourcing formula</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">State = reduce(applyEvent, EventStream, InitialState)</span><br></pre></td></tr></table></figure>

<p>No additional abstraction required.</p>
<hr>
<h3 id="Diagram-Event-Sourced-System"><a href="#Diagram-Event-Sourced-System" class="headerlink" title="Diagram: Event-Sourced System"></a>Diagram: Event-Sourced System</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Events (append-only)</span><br><span class="line">        â”‚</span><br><span class="line">        â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ reduce()         â”‚</span><br><span class="line">â”‚ apply_event      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">       â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Derived State    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p>State is <strong>derived</strong>, not stored.</p>
<hr>
<h2 id="8-Time-Travel-Comes-for-Free"><a href="#8-Time-Travel-Comes-for-Free" class="headerlink" title="8. Time Travel Comes for Free"></a>8. Time Travel Comes for Free</h2><h3 id="State-at-any-point"><a href="#State-at-any-point" class="headerlink" title="State at any point"></a>State at any point</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state_at_n = reduce(apply, events[:n], initial)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Diagram-Time-Travel"><a href="#Diagram-Time-Travel" class="headerlink" title="Diagram: Time Travel"></a>Diagram: Time Travel</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">0 â”€â”€ 1 â”€â”€ 2 â”€â”€ 3 â”€â”€ 4</span><br><span class="line"></span><br><span class="line">State0</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â–¶ State1</span><br><span class="line">  â”œâ”€â–¶ State2</span><br><span class="line">  â”œâ”€â–¶ State3</span><br><span class="line">  â””â”€â–¶ State4</span><br></pre></td></tr></table></figure>

<p>Impossible with imperative mutation.</p>
<hr>
<h2 id="9-Key-Comparison-Summary"><a href="#9-Key-Comparison-Summary" class="headerlink" title="9. Key Comparison Summary"></a>9. Key Comparison Summary</h2><h3 id="Imperative-Loop"><a href="#Imperative-Loop" class="headerlink" title="Imperative Loop"></a>Imperative Loop</h3><ul>
<li>Hidden mutation</li>
<li>State overwritten</li>
<li>Hard to replay</li>
<li>Debugging requires tools</li>
<li>Behavior-centric</li>
</ul>
<hr>
<h3 id="Reduce-Events"><a href="#Reduce-Events" class="headerlink" title="Reduce + Events"></a>Reduce + Events</h3><ul>
<li>Explicit state transitions</li>
<li>Immutability by design</li>
<li>Deterministic replay</li>
<li>Time travel built-in</li>
<li>Data-centric</li>
</ul>
<hr>
<h2 id="10-The-Most-Important-Insight"><a href="#10-The-Most-Important-Insight" class="headerlink" title="10. The Most Important Insight"></a>10. The Most Important Insight</h2><blockquote>
<p>Imperative loops encode <strong>history in execution</strong>,<br>while <code>reduce</code> encodes <strong>history in data</strong>.</p>
</blockquote>
<p>Once history becomes data:</p>
<ul>
<li>Debugging becomes replay</li>
<li>Scaling becomes replication</li>
<li>Auditing becomes trivial</li>
</ul>
<hr>
<h2 id="11-Final-Mental-Model-Diagram"><a href="#11-Final-Mental-Model-Diagram" class="headerlink" title="11. Final Mental Model Diagram"></a>11. Final Mental Model Diagram</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Imperative:</span><br><span class="line">Code â”€â”€â–¶ Mutation â”€â”€â–¶ Lost History</span><br><span class="line"></span><br><span class="line">Reduce:</span><br><span class="line">Events â”€â”€â–¶ reduce() â”€â”€â–¶ State</span><br><span class="line">             â–²</span><br><span class="line">             â”‚</span><br><span class="line">          Replayable</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="12-Closing-Key-Points-Highlighted"><a href="#12-Closing-Key-Points-Highlighted" class="headerlink" title="12. Closing Key Points (Highlighted)"></a>12. Closing Key Points (Highlighted)</h2><ul>
<li><strong>Imperative loops mutate a single state location</strong></li>
<li><strong>Mutation destroys history</strong></li>
<li><strong>Replay requires re-execution</strong></li>
<li><strong>Reduce produces new state values</strong></li>
<li><strong>Event sourcing is reduce over time</strong></li>
<li><strong>Immutability enables determinism</strong></li>
<li><strong>Replay and time travel emerge naturally</strong></li>
</ul>
<hr>
<p>This is why modern systems (financial ledgers, distributed logs, reactive streams) converge on <code>reduce</code> as the <strong>core primitive for correctness and observability</strong>.</p>
<p>Below is a <strong>clean add-on section</strong> that can be <strong>directly appended</strong> to the previous comprehensive comparison document.<br>It keeps the same neutral, technical blog style and reinforces (not contradicts) the earlier conclusions.</p>
<hr>
<h2 id="Appendix-Clarifying-a-Common-Misconception"><a href="#Appendix-Clarifying-a-Common-Misconception" class="headerlink" title="Appendix: Clarifying a Common Misconception"></a>Appendix: Clarifying a Common Misconception</h2><h3 id="â€œIf-an-Imperative-Loop-Uses-Only-Local-Variables-Isnâ€™t-It-Equivalent-to-reduce-â€"><a href="#â€œIf-an-Imperative-Loop-Uses-Only-Local-Variables-Isnâ€™t-It-Equivalent-to-reduce-â€" class="headerlink" title="â€œIf an Imperative Loop Uses Only Local Variables, Isnâ€™t It Equivalent to reduce?â€"></a>â€œIf an Imperative Loop Uses Only Local Variables, Isnâ€™t It Equivalent to <code>reduce</code>?â€</h3><p>OR</p>
<p>If an imperative function:</p>
<ul>
<li>Uses <strong>only local (temporary) variables</strong></li>
<li>Has <strong>no side effects</strong> (no IO, no mutation outside the function)</li>
<li>Does <strong>not mutate shared state</strong></li>
<li>Is <strong>purely deterministic</strong></li>
</ul>
<p>then:</p>
<blockquote>
<p>Given the same input and same environment, it <strong>will always return the same result</strong>, just like <code>reduce</code>.</p>
</blockquote>
<p>This question often arises when discussing determinism and purity.</p>
<h3 id="Short-Answer"><a href="#Short-Answer" class="headerlink" title="Short Answer"></a>Short Answer</h3><p><strong>Yes, in a narrow technical sense, the imperative loop is <em>functionally pure</em> â€” but no in an architectural sense.</strong></p>
<hr>
<h2 id="Why-this-does-NOT-invalidate-the-earlier-argument"><a href="#Why-this-does-NOT-invalidate-the-earlier-argument" class="headerlink" title="Why this does NOT invalidate the earlier argument"></a>Why this does NOT invalidate the earlier argument</h2><p>The difference is <strong>not about correctness of the final result</strong>, but about:</p>
<h3 id="1-Observability-of-intermediate-states"><a href="#1-Observability-of-intermediate-states" class="headerlink" title="1. Observability of intermediate states"></a>1. <strong>Observability of intermediate states</strong></h3><h3 id="2-Replay-granularity"><a href="#2-Replay-granularity" class="headerlink" title="2. Replay granularity"></a>2. <strong>Replay granularity</strong></h3><h3 id="3-Architecture-level-guarantees"><a href="#3-Architecture-level-guarantees" class="headerlink" title="3. Architecture-level guarantees"></a>3. <strong>Architecture-level guarantees</strong></h3><h2 id="A-Determinism-vs-Architecture"><a href="#A-Determinism-vs-Architecture" class="headerlink" title="A. Determinism vs Architecture"></a>A. Determinism vs Architecture</h2><p>Consider an imperative function that:</p>
<ul>
<li>Uses only local (temporary) variables</li>
<li>Has no side effects (no IO, no shared state)</li>
<li>Is fully deterministic</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sum_ops</span>(<span class="params">ops</span>):</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> op <span class="keyword">in</span> ops:</span><br><span class="line">        total += op</span><br><span class="line">    <span class="keyword">return</span> total</span><br></pre></td></tr></table></figure>

<p>Given:</p>
<ul>
<li><p>The same input</p>
</li>
<li><p>The same environment</p>
</li>
<li><p>Final result is deterministic âœ…</p>
</li>
<li><p><strong>Intermediate states are implicit</strong></p>
</li>
<li><p>Cannot inspect state after step N without:</p>
<ul>
<li>modifying code</li>
<li>adding logging</li>
<li>re-running with breakpoints</li>
</ul>
</li>
</ul>
<p><strong>HOWEVER</strong>: State evolution exists <strong>only during execution</strong>, then disappears.</p>
<p>This function <strong>will always return the same result</strong>, just like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reduce(<span class="keyword">lambda</span> acc, op: acc + op, ops, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p><strong>reduce</strong></p>
<ul>
<li>Final result is deterministic âœ…</li>
<li><strong>State transitions are explicit values</strong></li>
<li>Intermediate states are:<ul>
<li>reproducible</li>
<li>sliceable</li>
<li>serializable</li>
<li>replayable</li>
</ul>
</li>
</ul>
<p>State evolution exists as <strong>data</strong>, not just execution.</p>
<p><strong>The earlier statement is correct.</strong></p>
<hr>
<h2 id="B-What-This-Does-Not-Mean"><a href="#B-What-This-Does-Not-Mean" class="headerlink" title="B. What This Does Not Mean"></a>B. What This Does <em>Not</em> Mean</h2><p>This does <strong>not</strong> mean that imperative loops and <code>reduce</code> are equivalent in system design.</p>
<p>The key difference is <strong>not the final result</strong>, but:</p>
<blockquote>
<p><strong>Whether state evolution exists as data or only as execution.</strong></p>
</blockquote>
<h3 id="The-core-difference-one-sentence"><a href="#The-core-difference-one-sentence" class="headerlink" title="The core difference (one sentence)"></a>The core difference (one sentence)</h3><blockquote>
<p>A pure imperative loop can be <em>deterministic</em>,<br>but <code>reduce</code> makes <strong>state evolution a first-class artifact</strong>.</p>
</blockquote>
<hr>
<h2 id="C-Where-Imperative-Loops-Still-Fall-Short"><a href="#C-Where-Imperative-Loops-Still-Fall-Short" class="headerlink" title="C. Where Imperative Loops Still Fall Short"></a>C. Where Imperative Loops Still Fall Short</h2><p>Even when deterministic, imperative loops have these limitations:</p>
<h3 id="1-State-Evolution-Is-Ephemeral"><a href="#1-State-Evolution-Is-Ephemeral" class="headerlink" title="1. State Evolution Is Ephemeral"></a>1. State Evolution Is Ephemeral</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Execution-time only</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ total = 0    â”‚</span><br><span class="line">â”‚ total = 5    â”‚</span><br><span class="line">â”‚ total = 12   â”‚</span><br><span class="line">â”‚ total = 20   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">(disappears after return)</span><br></pre></td></tr></table></figure>

<ul>
<li>Intermediate states exist only on the call stack</li>
<li>Once the function returns, history is lost</li>
</ul>
<hr>
<h3 id="2-Replay-Is-Coarse-Grained"><a href="#2-Replay-Is-Coarse-Grained" class="headerlink" title="2. Replay Is Coarse-Grained"></a>2. Replay Is Coarse-Grained</h3><p>With an imperative loop:</p>
<ul>
<li><p>You can replay <strong>the final result</strong></p>
</li>
<li><p>You cannot replay <strong>step N</strong> without:</p>
<ul>
<li>modifying code</li>
<li>adding logs</li>
<li>using a debugger</li>
</ul>
</li>
</ul>
<p>Replay is <strong>execution-driven</strong>, not data-driven.</p>
<hr>
<h3 id="3-State-Is-Not-First-Class"><a href="#3-State-Is-Not-First-Class" class="headerlink" title="3. State Is Not First-Class"></a>3. State Is Not First-Class</h3><p>In imperative code:</p>
<ul>
<li>State transitions are implicit</li>
<li>History is not serializable</li>
<li>Auditing requires instrumentation</li>
</ul>
<p>State is <strong>a side effect of running code</strong>, not a product of it.</p>
<hr>
<h2 id="D-How-reduce-Changes-the-Model"><a href="#D-How-reduce-Changes-the-Model" class="headerlink" title="D. How reduce Changes the Model"></a>D. How <code>reduce</code> Changes the Model</h2><p>With <code>reduce</code>, state evolution becomes explicit:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">InitialState</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â–¶ State1</span><br><span class="line">  â”œâ”€â–¶ State2</span><br><span class="line">  â”œâ”€â–¶ State3</span><br><span class="line">  â””â”€â–¶ FinalState</span><br></pre></td></tr></table></figure>

<p>Each state:</p>
<ul>
<li>Is a value</li>
<li>Can be persisted</li>
<li>Can be replayed</li>
<li>Can be inspected independently</li>
</ul>
<hr>
<h2 id="E-Correct-Refined-Statement-Important"><a href="#E-Correct-Refined-Statement-Important" class="headerlink" title="E. Correct Refined Statement (Important)"></a>E. Correct Refined Statement (Important)</h2><p>The precise, correct statement is:</p>
<blockquote>
<p>An imperative loop <strong>can be deterministic</strong>,<br>but <code>reduce</code> makes <strong>state transitions explicit and replayable</strong>,<br>which is why it naturally enables event sourcing, time travel, and auditing.</p>
</blockquote>
<hr>
<h2 id="F-Determinism-vs-Replayability-Summary-Table"><a href="#F-Determinism-vs-Replayability-Summary-Table" class="headerlink" title="F. Determinism vs Replayability (Summary Table)"></a>F. Determinism vs Replayability (Summary Table)</h2><table>
<thead>
<tr>
<th>Capability</th>
<th>Pure Imperative Loop</th>
<th>Reduce</th>
</tr>
</thead>
<tbody><tr>
<td>Deterministic output</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Replay final result</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Intermediate states visible</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>Replay from step N</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>Time-travel debugging</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>Event sourcing ready</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>State as data</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
</tbody></table>
<hr>
<h2 id="G-Correct-refined-statement-important-correction"><a href="#G-Correct-refined-statement-important-correction" class="headerlink" title="G. Correct refined statement (important correction)"></a>G. Correct refined statement (important correction)</h2><p>A more accurate version of the earlier claim is:</p>
<blockquote>
<p>Imperative loops <strong>can be deterministic</strong>,<br>but they <strong>do not preserve execution history as data</strong>,<br>which makes replay, inspection, and time-travel <strong>structurally harder</strong> than with <code>reduce</code>.</p>
</blockquote>
<h2 id="H-Final-Insight-Highlighted"><a href="#H-Final-Insight-Highlighted" class="headerlink" title="H. Final Insight (Highlighted)"></a>H. Final Insight (Highlighted)</h2><blockquote>
<p>Determinism answers <strong>â€œWill I get the same result?â€</strong><br><code>reduce</code> answers <strong>â€œCan I explain, replay, and audit how I got there?â€</strong><br>ğŸ”‘ The difference is <strong>not purity</strong>, but <strong>state-as-data vs state-as-execution</strong></p>
</blockquote>
<p>This is why modern architectures still prefer <code>reduce</code>-style models even though imperative code <em>can</em> be written purely.</p>
<p>This distinction is also exactly why:</p>
<ul>
<li>event sourcing</li>
<li>CQRS</li>
<li>reactive streams</li>
<li>distributed logs</li>
</ul>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/17/Python-m-Flag-Explained-Module-Mode-Execution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/17/Python-m-Flag-Explained-Module-Mode-Execution/" class="post-title-link" itemprop="url">Python -m Flag Explained: Module Mode Execution</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-17 18:17:28 / Modified: 18:18:34" itemprop="dateCreated datePublished" datetime="2025-12-17T18:17:28-05:00">2025-12-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-Basic-Concept"><a href="#1-Basic-Concept" class="headerlink" title="1. Basic Concept"></a>1. Basic Concept</h2><p><code>python -m</code> means <strong>run Python in module mode</strong>. The <code>-m</code> stands for <strong>module</strong>.</p>
<h3 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax:"></a>Syntax:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m module_name [args...]</span><br></pre></td></tr></table></figure>

<h2 id="2-m-vs-Direct-Script-Execution"><a href="#2-m-vs-Direct-Script-Execution" class="headerlink" title="2. -m vs Direct Script Execution"></a>2. <code>-m</code> vs Direct Script Execution</h2><h3 id="Example-1-Direct-script-execution"><a href="#Example-1-Direct-script-execution" class="headerlink" title="Example 1: Direct script execution"></a>Example 1: Direct script execution</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Method 1: Direct run (relative path)</span></span><br><span class="line">python my_script.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: Direct run (absolute path)</span></span><br><span class="line">python /path/to/my_script.py</span><br></pre></td></tr></table></figure>

<h3 id="Example-2-Using-m"><a href="#Example-2-Using-m" class="headerlink" title="Example 2: Using -m"></a>Example 2: Using <code>-m</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Method 3: Run as module</span></span><br><span class="line">python -m my_package.my_module</span><br></pre></td></tr></table></figure>

<h2 id="3-Key-Difference-sys-path-Behavior"><a href="#3-Key-Difference-sys-path-Behavior" class="headerlink" title="3. Key Difference: sys.path Behavior"></a>3. Key Difference: <code>sys.path</code> Behavior</h2><p>This is the most important feature of <code>-m</code>! Letâ€™s demonstrate with code:</p>
<h3 id="Create-test-directory-structure"><a href="#Create-test-directory-structure" class="headerlink" title="Create test directory structure:"></a>Create test directory structure:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test_project/</span><br><span class="line">â”œâ”€â”€ my_package/</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â””â”€â”€ my_module.py</span><br><span class="line">â””â”€â”€ main.py</span><br></pre></td></tr></table></figure>

<h3 id="Test-code"><a href="#Test-code" class="headerlink" title="Test code:"></a>Test code:</h3><p><strong>my_package&#x2F;my_module.py:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_path</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Module path:&quot;</span>, __file__)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;First in sys.path:&quot;</span>, sys.path[<span class="number">0</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">40</span>)</span><br></pre></td></tr></table></figure>

<p><strong>main.py:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=== Direct execution ===&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Script path:&quot;</span>, __file__)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;First in sys.path:&quot;</span>, sys.path[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n=== Now importing module ===&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> my_package <span class="keyword">import</span> my_module</span><br><span class="line">my_module.show_path()</span><br></pre></td></tr></table></figure>

<h3 id="Execution-comparison"><a href="#Execution-comparison" class="headerlink" title="Execution comparison:"></a>Execution comparison:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run from current directory (test_project/)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: Direct execution</span></span><br><span class="line">$ python main.py</span><br><span class="line">=== Direct execution ===</span><br><span class="line">Script path: /path/to/test_project/main.py</span><br><span class="line">First <span class="keyword">in</span> sys.path: /path/to/test_project  <span class="comment"># Current directory first</span></span><br><span class="line"></span><br><span class="line">=== Now importing module ===</span><br><span class="line">Module path: /path/to/test_project/my_package/my_module.py</span><br><span class="line">First <span class="keyword">in</span> sys.path: /path/to/test_project</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: Using -m</span></span><br><span class="line">$ python -m my_package.my_module</span><br><span class="line">Module path: /path/to/test_project/my_package/my_module.py</span><br><span class="line">First <span class="keyword">in</span> sys.path: <span class="string">&#x27;&#x27;</span>  <span class="comment"># Empty string! Means current working directory</span></span><br></pre></td></tr></table></figure>

<h2 id="4-Unique-Features-of-m"><a href="#4-Unique-Features-of-m" class="headerlink" title="4. Unique Features of -m"></a>4. Unique Features of <code>-m</code></h2><h3 id="4-1-Automatic-current-directory-in-sys-path"><a href="#4-1-Automatic-current-directory-in-sys-path" class="headerlink" title="4.1 Automatic current directory in sys.path"></a>4.1 Automatic current directory in <code>sys.path</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Current directory in sys.path:&quot;</span>, os.getcwd() <span class="keyword">in</span> sys.path)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ python test.py</span><br><span class="line">Current directory <span class="keyword">in</span> sys.path: True  <span class="comment"># Always in sys.path</span></span><br><span class="line"></span><br><span class="line">$ python -m <span class="built_in">test</span></span><br><span class="line">Current directory <span class="keyword">in</span> sys.path: True  <span class="comment"># Also in sys.path, but different position</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-Proper-package-structure-handling"><a href="#4-2-Proper-package-structure-handling" class="headerlink" title="4.2 Proper package structure handling"></a>4.2 Proper package structure handling</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">myapp/</span><br><span class="line">â”œâ”€â”€ __init__.py</span><br><span class="line">â”œâ”€â”€ utils/</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â””â”€â”€ helpers.py</span><br><span class="line">â””â”€â”€ main.py</span><br></pre></td></tr></table></figure>

<p><strong>Wrong way:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> myapp</span><br><span class="line">$ python main.py  <span class="comment"># May fail to import utils.helpers correctly</span></span><br></pre></td></tr></table></figure>

<p><strong>Correct way:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line">$ python -m myapp.main  <span class="comment"># Ensures proper package resolution</span></span><br></pre></td></tr></table></figure>

<h2 id="5-Common-Use-Cases"><a href="#5-Common-Use-Cases" class="headerlink" title="5. Common Use Cases"></a>5. Common Use Cases</h2><h3 id="5-1-Running-standard-library-modules"><a href="#5-1-Running-standard-library-modules" class="headerlink" title="5.1 Running standard library modules"></a>5.1 Running standard library modules</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start simple HTTP server</span></span><br><span class="line">python -m http.server 8000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run JSON tool</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#123;&quot;name&quot;: &quot;Alice&quot;&#125;&#x27;</span> | python -m json.tool</span><br><span class="line"></span><br><span class="line"><span class="comment"># Code profiling</span></span><br><span class="line">python -m cProfile my_script.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># Debugging</span></span><br><span class="line">python -m pdb my_script.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># Packaging tools</span></span><br><span class="line">python -m pip install requests</span><br><span class="line">python -m venv myenv       <span class="comment"># Create virtual environment</span></span><br><span class="line">python -m ensurepip       <span class="comment"># Install pip</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-Running-modules-within-packages"><a href="#5-2-Running-modules-within-packages" class="headerlink" title="5.2 Running modules within packages"></a>5.2 Running modules within packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assume package structure:</span></span><br><span class="line"><span class="comment"># mypackage/</span></span><br><span class="line"><span class="comment">#   â”œâ”€â”€ __init__.py</span></span><br><span class="line"><span class="comment">#   â”œâ”€â”€ cli.py</span></span><br><span class="line"><span class="comment">#   â””â”€â”€ utils.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Can run from anywhere</span></span><br><span class="line">python -m mypackage.cli --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Development-testing"><a href="#5-3-Development-testing" class="headerlink" title="5.3 Development testing"></a>5.3 Development testing</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run tests</span></span><br><span class="line">python -m pytest tests/</span><br><span class="line">python -m unittest discover</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run development servers</span></span><br><span class="line">python -m flask run</span><br><span class="line">python -m uvicorn main:app --reload</span><br></pre></td></tr></table></figure>

<h2 id="6-Special-Role-of-main-py"><a href="#6-Special-Role-of-main-py" class="headerlink" title="6. Special Role of __main__.py"></a>6. Special Role of <code>__main__.py</code></h2><p>When using <code>-m</code> with a <strong>package</strong>, Python looks for <code>__main__.py</code>:</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example:"></a>Example:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myapp/</span><br><span class="line">â”œâ”€â”€ __init__.py</span><br><span class="line">â”œâ”€â”€ __main__.py    # Package entry point</span><br><span class="line">â””â”€â”€ other_files.py</span><br></pre></td></tr></table></figure>

<p><strong>myapp&#x2F;<strong>main</strong>.py:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello from myapp!&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><strong>Execution:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run package&#x27;s __main__.py</span></span><br><span class="line">python -m myapp</span><br><span class="line"><span class="comment"># Output: Hello from myapp!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Equivalent to</span></span><br><span class="line">python myapp/__main__.py</span><br><span class="line"><span class="comment"># But -m handles imports better</span></span><br></pre></td></tr></table></figure>

<h2 id="7-Practical-Comparison"><a href="#7-Practical-Comparison" class="headerlink" title="7. Practical Comparison"></a>7. Practical Comparison</h2><h3 id="Scenario-Relative-imports-within-packages"><a href="#Scenario-Relative-imports-within-packages" class="headerlink" title="Scenario: Relative imports within packages"></a>Scenario: Relative imports within packages</h3><p><strong>Directory structure:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mylib/</span><br><span class="line">â”œâ”€â”€ __init__.py</span><br><span class="line">â”œâ”€â”€ math/</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â””â”€â”€ operations.py  # Contains: from . import advanced</span><br><span class="line">â”œâ”€â”€ advanced.py</span><br><span class="line">â””â”€â”€ runner.py</span><br></pre></td></tr></table></figure>

<p><strong>operations.py:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using relative import</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> advanced</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y + advanced.BONUS</span><br></pre></td></tr></table></figure>

<p><strong>Try to run:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># âŒ Method 1: Direct run (fails)</span></span><br><span class="line">$ <span class="built_in">cd</span> mylib/math</span><br><span class="line">$ python operations.py</span><br><span class="line"><span class="comment"># ImportError: attempted relative import with no known parent package</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># âŒ Method 2: Run from parent (also fails)</span></span><br><span class="line">$ <span class="built_in">cd</span> mylib</span><br><span class="line">$ python math/operations.py</span><br><span class="line"><span class="comment"># ImportError: attempted relative import with no known parent package</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># âœ… Method 3: Using -m (succeeds!)</span></span><br><span class="line">$ <span class="built_in">cd</span> mylib</span><br><span class="line">$ python -m math.operations</span><br><span class="line"><span class="comment"># Or from anywhere:</span></span><br><span class="line">$ python -m mylib.math.operations</span><br></pre></td></tr></table></figure>

<h2 id="8-Technical-Details-of-m"><a href="#8-Technical-Details-of-m" class="headerlink" title="8. Technical Details of -m"></a>8. Technical Details of <code>-m</code></h2><h3 id="What-Python-actually-does"><a href="#What-Python-actually-does" class="headerlink" title="What Python actually does:"></a>What Python actually does:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m module.name</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>Resolve module path</strong>: Convert <code>module.name</code> to filesystem path</li>
<li><strong>Set <code>sys.path[0]</code></strong> to <code>&quot;&quot;</code> (empty string), representing current working directory</li>
<li><strong>Execute module</strong>: Like <code>import module.name</code> then running its code</li>
<li><strong>Handle <code>__main__</code></strong>: Set moduleâ€™s <code>__name__</code> to <code>&quot;__main__&quot;</code></li>
</ol>
<h3 id="See-how-Python-finds-modules"><a href="#See-how-Python-finds-modules" class="headerlink" title="See how Python finds modules:"></a>See how Python finds modules:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># View module search locations</span></span><br><span class="line">python -m site</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find module file location</span></span><br><span class="line">python -m module_name --<span class="built_in">help</span>  <span class="comment"># Many modules support --help</span></span><br><span class="line">python -c <span class="string">&quot;import module_name; print(module_name.__file__)&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="9-Comparison-with-python-c"><a href="#9-Comparison-with-python-c" class="headerlink" title="9. Comparison with python -c"></a>9. Comparison with <code>python -c</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -m: Run module</span></span><br><span class="line">python -m http.server</span><br><span class="line"></span><br><span class="line"><span class="comment"># -c: Execute code string directly</span></span><br><span class="line">python -c <span class="string">&quot;print(&#x27;Hello&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Combination (not actually valid, showing contrast)</span></span><br><span class="line">python -c <span class="string">&quot;import sys; print(sys.path)&quot;</span>  <span class="comment"># View current path</span></span><br></pre></td></tr></table></figure>

<h2 id="10-Common-Problems-Solutions"><a href="#10-Common-Problems-Solutions" class="headerlink" title="10. Common Problems &amp; Solutions"></a>10. Common Problems &amp; Solutions</h2><h3 id="Q1-Why-do-my-relative-imports-fail-with-direct-execution-but-work-with-m"><a href="#Q1-Why-do-my-relative-imports-fail-with-direct-execution-but-work-with-m" class="headerlink" title="Q1: Why do my relative imports fail with direct execution but work with -m?"></a>Q1: Why do my relative imports fail with direct execution but work with <code>-m</code>?</h3><p><strong>A:</strong> Direct execution doesnâ€™t know your file belongs to a package; <code>-m</code> provides proper package context.</p>
<h3 id="Q2-Whatâ€™s-the-difference-between-python-script-py-and-python-m-script"><a href="#Q2-Whatâ€™s-the-difference-between-python-script-py-and-python-m-script" class="headerlink" title="Q2: Whatâ€™s the difference between python script.py and python -m script?"></a>Q2: Whatâ€™s the difference between <code>python script.py</code> and <code>python -m script</code>?</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assume script.py is in current directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: Direct execution</span></span><br><span class="line">python script.py</span><br><span class="line"><span class="comment"># sys.path[0] = script&#x27;s directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: Module execution</span></span><br><span class="line">python -m script</span><br><span class="line"><span class="comment"># sys.path[0] = current working directory (may differ!)</span></span><br></pre></td></tr></table></figure>

<h3 id="Q3-When-must-I-use-m"><a href="#Q3-When-must-I-use-m" class="headerlink" title="Q3: When must I use -m?"></a>Q3: When must I use <code>-m</code>?</h3><ol>
<li><strong>Running modules within packages</strong> (with relative imports)</li>
<li><strong>Running standard library tools</strong> (like <code>pip</code>, <code>venv</code>)</li>
<li><strong>Ensuring consistent import behavior</strong></li>
</ol>
<h2 id="11-Best-Practices"><a href="#11-Best-Practices" class="headerlink" title="11. Best Practices"></a>11. Best Practices</h2><ol>
<li><strong>Project entry points</strong>: Always use <code>python -m myproject.module</code></li>
<li><strong>Executable packages</strong>: Add <code>__main__.py</code> to your packages</li>
<li><strong>Development tools</strong>: Use <code>python -m pytest</code> instead of global <code>pytest</code></li>
<li><strong>Virtual environments</strong>: Use <code>python -m venv</code> instead of <code>virtualenv</code></li>
</ol>
<h3 id="Example-project-structure"><a href="#Example-project-structure" class="headerlink" title="Example project structure:"></a>Example project structure:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">myapp/</span><br><span class="line">â”œâ”€â”€ pyproject.toml</span><br><span class="line">â”œâ”€â”€ src/</span><br><span class="line">â”‚   â””â”€â”€ myapp/</span><br><span class="line">â”‚       â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚       â”œâ”€â”€ __main__.py</span><br><span class="line">â”‚       â””â”€â”€ cli.py</span><br><span class="line">â””â”€â”€ tests/</span><br></pre></td></tr></table></figure>

<p><strong>Execution:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># During development</span></span><br><span class="line"><span class="built_in">cd</span> myapp</span><br><span class="line">python -m pip install -e .</span><br><span class="line">python -m myapp --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For end users</span></span><br><span class="line">python -m pip install myapp</span><br><span class="line">python -m myapp --version</span><br></pre></td></tr></table></figure>

<h2 id="12-Summary"><a href="#12-Summary" class="headerlink" title="12. Summary"></a>12. Summary</h2><p>Core advantages of <code>python -m</code>:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Direct execution (<code>python script.py</code>)</th>
<th>Module execution (<code>python -m module</code>)</th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>sys.path[0]</code></strong></td>
<td>Scriptâ€™s directory</td>
<td>Current working directory (<code>&quot;&quot;</code>)</td>
</tr>
<tr>
<td><strong>Package context</strong></td>
<td>None</td>
<td>Yes (supports relative imports)</td>
</tr>
<tr>
<td><strong>Stdlib tools</strong></td>
<td>Cannot run directly</td>
<td>Can run directly</td>
</tr>
<tr>
<td><strong>Cross-directory</strong></td>
<td>Needs full path</td>
<td>Can run from anywhere</td>
</tr>
<tr>
<td><strong>Consistency</strong></td>
<td>Depends on execution location</td>
<td>More consistent import behavior</td>
</tr>
</tbody></table>
<p><strong>Simple mnemonic</strong>:</p>
<ul>
<li><code>-m</code> &#x3D; <strong>module</strong> (module mode)</li>
<li>Solves <strong>relative import</strong> and <strong>package structure</strong> issues</li>
<li>Provides <strong>consistent execution environment</strong></li>
<li><strong>Recommended for modern Python projects</strong></li>
</ul>
<p>When you need consistent import behavior, especially for modules within packages, always prefer <code>python -m</code>!</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/16/Deep-Dive-Python-Immutable-Data-Classes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/16/Deep-Dive-Python-Immutable-Data-Classes/" class="post-title-link" itemprop="url">Deep Dive: Python Immutable Data Classes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-16 22:44:42 / Modified: 22:55:27" itemprop="dateCreated datePublished" datetime="2025-12-16T22:44:42-05:00">2025-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ğŸ“‹-Table-of-Contents"><a href="#ğŸ“‹-Table-of-Contents" class="headerlink" title="ğŸ“‹ Table of Contents"></a>ğŸ“‹ Table of Contents</h2><ol>
<li><a href="#introduction--fundamentals">Introduction &amp; Fundamentals</a></li>
<li><a href="#how-it-works-internally">How It Works Internally</a></li>
<li><a href="#practical-benefits--use-cases">Practical Benefits &amp; Use Cases</a></li>
<li><a href="#the-shallow-freezing-caveat">The Shallow Freezing Caveat</a></li>
<li><a href="#working-with-immutable-objects">Working with Immutable Objects</a></li>
<li><a href="#advanced-patterns--alternatives">Advanced Patterns &amp; Alternatives</a></li>
<li><a href="#performance-considerations">Performance Considerations</a></li>
<li><a href="#best-practices">Best Practices</a></li>
</ol>
<h2 id="Introduction-Fundamentals"><a href="#Introduction-Fundamentals" class="headerlink" title="Introduction &amp; Fundamentals"></a>Introduction &amp; Fundamentals</h2><h3 id="What-is-dataclass-frozen-True"><a href="#What-is-dataclass-frozen-True" class="headerlink" title="What is @dataclass(frozen=True)?"></a>What is <code>@dataclass(frozen=True)</code>?</h3><p>The <code>@dataclass(frozen=True)</code> decorator in Python creates <strong>immutable data classes</strong> - classes primarily designed for storing data while enforcing <strong>strict immutability</strong> on their instances. Introduced in Python 3.7â€™s <code>dataclasses</code> module, it combines automatic method generation with functional programming principles.</p>
<h3 id="Core-Concept-Immutability-vs-Mutability"><a href="#Core-Concept-Immutability-vs-Mutability" class="headerlink" title="Core Concept: Immutability vs. Mutability"></a>Core Concept: Immutability vs. Mutability</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mutable class (standard dataclass)</span></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MutablePoint</span>:</span><br><span class="line">    x: <span class="built_in">float</span></span><br><span class="line">    y: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line">p1 = MutablePoint(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">p1.x = <span class="number">3</span>  <span class="comment"># âœ… Modification allowed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Immutable class (frozen dataclass)</span></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImmutablePoint</span>:</span><br><span class="line">    x: <span class="built_in">float</span></span><br><span class="line">    y: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line">p2 = ImmutablePoint(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">p2.x = <span class="number">3</span>  <span class="comment"># âŒ Raises FrozenInstanceError</span></span><br></pre></td></tr></table></figure>

<h2 id="How-It-Works-Internally"><a href="#How-It-Works-Internally" class="headerlink" title="How It Works Internally"></a>How It Works Internally</h2><h3 id="Automatic-Method-Generation"><a href="#Automatic-Method-Generation" class="headerlink" title="Automatic Method Generation"></a>Automatic Method Generation</h3><p>When you use <code>@dataclass(frozen=True)</code>, Python automatically generates these methods:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
<th>Generated With <code>frozen=True</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>__init__</code></td>
<td>Constructor</td>
<td>âœ… Yes</td>
</tr>
<tr>
<td><code>__repr__</code></td>
<td>String representation</td>
<td>âœ… Yes</td>
</tr>
<tr>
<td><code>__eq__</code></td>
<td>Equality comparison</td>
<td>âœ… Yes</td>
</tr>
<tr>
<td><code>__hash__</code></td>
<td>Hashing support</td>
<td>âœ… Yes (crucial!)</td>
</tr>
<tr>
<td><code>__setattr__</code></td>
<td>Attribute assignment</td>
<td>âœ… Modified to raise error</td>
</tr>
<tr>
<td><code>__delattr__</code></td>
<td>Attribute deletion</td>
<td>âœ… Modified to raise error</td>
</tr>
<tr>
<td><code>__lt__</code>, <code>__le__</code>, etc.</td>
<td>Comparisons</td>
<td>âœ… If <code>order=True</code></td>
</tr>
</tbody></table>
<h3 id="The-Magic-of-hash"><a href="#The-Magic-of-hash" class="headerlink" title="The Magic of __hash__"></a>The Magic of <code>__hash__</code></h3><p>The most important addition is <code>__hash__</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># Objects are hashable and can be used in sets/dicts</span></span><br><span class="line">users_set = &#123;User(<span class="number">1</span>, <span class="string">&quot;Alice&quot;</span>), User(<span class="number">2</span>, <span class="string">&quot;Bob&quot;</span>)&#125;</span><br><span class="line">users_dict = &#123;User(<span class="number">1</span>, <span class="string">&quot;Alice&quot;</span>): <span class="string">&quot;admin&quot;</span>, User(<span class="number">2</span>, <span class="string">&quot;Bob&quot;</span>): <span class="string">&quot;user&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Insight</strong>: Without <code>frozen=True</code>, dataclasses are <strong>unhashable by default</strong> unless you explicitly set <code>unsafe_hash=True</code>. With <code>frozen=True</code>, hashability comes for free.</p>
<h3 id="Implementation-Example"><a href="#Implementation-Example" class="headerlink" title="Implementation Example"></a>Implementation Example</h3><p>Hereâ€™s what Python essentially creates under the hood:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ImmutablePoint</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x: <span class="built_in">float</span>, y: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(<span class="variable language_">self</span>, <span class="string">&#x27;x&#x27;</span>, x)</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(<span class="variable language_">self</span>, <span class="string">&#x27;y&#x27;</span>, y)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        <span class="keyword">raise</span> FrozenInstanceError(<span class="string">f&quot;cannot assign to field &#x27;<span class="subst">&#123;name&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">raise</span> FrozenInstanceError(<span class="string">f&quot;cannot delete field &#x27;<span class="subst">&#123;name&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;ImmutablePoint(x=<span class="subst">&#123;self.x&#125;</span>, y=<span class="subst">&#123;self.y&#125;</span>)&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(other, ImmutablePoint):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.x == other.x <span class="keyword">and</span> <span class="variable language_">self</span>.y == other.y</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((<span class="variable language_">self</span>.x, <span class="variable language_">self</span>.y))</span><br></pre></td></tr></table></figure>

<h2 id="Practical-Benefits-Use-Cases"><a href="#Practical-Benefits-Use-Cases" class="headerlink" title="Practical Benefits &amp; Use Cases"></a>Practical Benefits &amp; Use Cases</h2><h3 id="1-Thread-Safety-Concurrency"><a href="#1-Thread-Safety-Concurrency" class="headerlink" title="1. Thread Safety &amp; Concurrency"></a>1. Thread Safety &amp; Concurrency</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SharedConfig</span>:</span><br><span class="line">    max_connections: <span class="built_in">int</span></span><br><span class="line">    timeout: <span class="built_in">int</span></span><br><span class="line">    api_key: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">config = SharedConfig(max_connections=<span class="number">100</span>, timeout=<span class="number">30</span>, api_key=<span class="string">&quot;secret&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Multiple threads can safely read without locks</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">config: SharedConfig, thread_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Thread <span class="subst">&#123;thread_id&#125;</span>: Max connections = <span class="subst">&#123;config.max_connections&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">threads = [Thread(target=worker, args=(config, i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.start()</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure>

<h3 id="2-Dictionary-Keys-Set-Elements"><a href="#2-Dictionary-Keys-Set-Elements" class="headerlink" title="2. Dictionary Keys &amp; Set Elements"></a>2. Dictionary Keys &amp; Set Elements</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Coordinate</span>:</span><br><span class="line">    x: <span class="built_in">int</span></span><br><span class="line">    y: <span class="built_in">int</span></span><br><span class="line">    z: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a cache of computed values</span></span><br><span class="line">cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_value</span>(<span class="params">coord: Coordinate</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="keyword">if</span> coord <span class="keyword">in</span> cache:  <span class="comment"># âœ… Can use as dict key</span></span><br><span class="line">        <span class="keyword">return</span> cache[coord]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Expensive computation</span></span><br><span class="line">    result = (coord.x ** <span class="number">2</span> + coord.y ** <span class="number">2</span> + coord.z ** <span class="number">2</span>) ** <span class="number">0.5</span></span><br><span class="line">    cache[coord] = result</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a set of unique coordinates</span></span><br><span class="line">unique_points = &#123;</span><br><span class="line">    Coordinate(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    Coordinate(<span class="number">1</span>, <span class="number">2</span>),  <span class="comment"># Duplicate - will be ignored</span></span><br><span class="line">    Coordinate(<span class="number">3</span>, <span class="number">4</span>),</span><br><span class="line">    Coordinate(<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>),  <span class="comment"># Different because z=5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Unique points: <span class="subst">&#123;<span class="built_in">len</span>(unique_points)&#125;</span>&quot;</span>)  <span class="comment"># 3</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Functional-Programming-Patterns"><a href="#3-Functional-Programming-Patterns" class="headerlink" title="3. Functional Programming Patterns"></a>3. Functional Programming Patterns</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShoppingCart</span>:</span><br><span class="line">    items: <span class="built_in">tuple</span>[<span class="built_in">str</span>, ...]  <span class="comment"># Use tuple for immutability</span></span><br><span class="line">    discount: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_item</span>(<span class="params">self, item: <span class="built_in">str</span></span>) -&gt; <span class="string">&#x27;ShoppingCart&#x27;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return a NEW cart with the added item&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> dataclasses <span class="keyword">import</span> replace</span><br><span class="line">        <span class="keyword">return</span> replace(<span class="variable language_">self</span>, items=<span class="variable language_">self</span>.items + (item,))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">apply_discount</span>(<span class="params">self, new_discount: <span class="built_in">float</span></span>) -&gt; <span class="string">&#x27;ShoppingCart&#x27;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return a NEW cart with updated discount&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> dataclasses <span class="keyword">import</span> replace</span><br><span class="line">        <span class="keyword">return</span> replace(<span class="variable language_">self</span>, discount=new_discount)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Original cart remains unchanged</span></span><br><span class="line">cart1 = ShoppingCart(items=(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>))</span><br><span class="line">cart2 = cart1.add_item(<span class="string">&quot;orange&quot;</span>)</span><br><span class="line">cart3 = cart2.apply_discount(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Cart1: <span class="subst">&#123;cart1&#125;</span>&quot;</span>)  <span class="comment"># Items: (&#x27;apple&#x27;, &#x27;banana&#x27;), Discount: 0.0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Cart2: <span class="subst">&#123;cart2&#125;</span>&quot;</span>)  <span class="comment"># Items: (&#x27;apple&#x27;, &#x27;banana&#x27;, &#x27;orange&#x27;), Discount: 0.0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Cart3: <span class="subst">&#123;cart3&#125;</span>&quot;</span>)  <span class="comment"># Items: (&#x27;apple&#x27;, &#x27;banana&#x27;, &#x27;orange&#x27;), Discount: 0.1</span></span><br></pre></td></tr></table></figure>

<h3 id="4-Configuration-Objects"><a href="#4-Configuration-Objects" class="headerlink" title="4. Configuration Objects"></a>4. Configuration Objects</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseConfig</span>:</span><br><span class="line">    host: <span class="built_in">str</span></span><br><span class="line">    port: <span class="built_in">int</span></span><br><span class="line">    database: <span class="built_in">str</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span>  <span class="comment"># In reality, use a proper secrets manager</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connection_string</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;postgresql://<span class="subst">&#123;self.username&#125;</span>:<span class="subst">&#123;self.password&#125;</span>@<span class="subst">&#123;self.host&#125;</span>:<span class="subst">&#123;self.port&#125;</span>/<span class="subst">&#123;self.database&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Safe to pass around - no accidental modifications</span></span><br><span class="line">config = DatabaseConfig(</span><br><span class="line">    host=<span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">    port=<span class="number">5432</span>,</span><br><span class="line">    database=<span class="string">&quot;mydb&quot;</span>,</span><br><span class="line">    username=<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    password=<span class="string">&quot;secret123&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Can be safely stored in a module-level constant</span></span><br><span class="line">DEFAULT_CONFIG = DatabaseConfig(</span><br><span class="line">    host=<span class="string">&quot;prod-db.example.com&quot;</span>,</span><br><span class="line">    port=<span class="number">5432</span>,</span><br><span class="line">    database=<span class="string">&quot;production&quot;</span>,</span><br><span class="line">    username=<span class="string">&quot;readonly&quot;</span>,</span><br><span class="line">    password=<span class="string">&quot;readonly123&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="The-Shallow-Freezing-Caveat"><a href="#The-Shallow-Freezing-Caveat" class="headerlink" title="The Shallow Freezing Caveat"></a>The Shallow Freezing Caveat</h2><h3 id="Understanding-the-Limitation"><a href="#Understanding-the-Limitation" class="headerlink" title="Understanding the Limitation"></a>Understanding the Limitation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Company</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    employees: <span class="built_in">list</span>[<span class="built_in">str</span>]  <span class="comment"># ğŸš¨ Mutable type!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an instance</span></span><br><span class="line">google = Company(<span class="string">&quot;Google&quot;</span>, [<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is blocked (good):</span></span><br><span class="line"><span class="comment"># google.name = &quot;Alphabet&quot;  # âŒ FrozenInstanceError</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This still works (problematic):</span></span><br><span class="line">google.employees.append(<span class="string">&quot;Charlie&quot;</span>)  <span class="comment"># âœ… No error!</span></span><br><span class="line"><span class="built_in">print</span>(google.employees)  <span class="comment"># [&#x27;Alice&#x27;, &#x27;Bob&#x27;, &#x27;Charlie&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The list itself is mutable, even though the field reference is frozen</span></span><br></pre></td></tr></table></figure>

<h3 id="Solutions-for-Deep-Immutability"><a href="#Solutions-for-Deep-Immutability" class="headerlink" title="Solutions for Deep Immutability"></a>Solutions for Deep Immutability</h3><p><strong>Option 1: Use Immutable Types</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImmutableCompany</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    employees: <span class="type">Tuple</span>[<span class="built_in">str</span>, ...]  <span class="comment"># âœ… Tuple is immutable</span></span><br><span class="line">    </span><br><span class="line">company = ImmutableCompany(<span class="string">&quot;Google&quot;</span>, (<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>))</span><br><span class="line"><span class="comment"># company.employees.append(&quot;Charlie&quot;)  # âŒ AttributeError: &#x27;tuple&#x27; object has no attribute &#x27;append&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Option 2: Convert to Immutable in <code>__post_init__</code></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SafeCompany</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    employees: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Convert list to tuple after initialization</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(<span class="variable language_">self</span>, <span class="string">&#x27;employees&#x27;</span>, <span class="built_in">tuple</span>(<span class="variable language_">self</span>.employees))</span><br><span class="line"></span><br><span class="line">company = SafeCompany(<span class="string">&quot;Google&quot;</span>, [<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(company.employees)  <span class="comment"># (&#x27;Alice&#x27;, &#x27;Bob&#x27;)</span></span><br><span class="line"><span class="comment"># company.employees.append(&quot;Charlie&quot;)  # âŒ AttributeError</span></span><br></pre></td></tr></table></figure>

<p><strong>Option 3: Use <code>functools.cached_property</code> for Computed Mutable Data</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> cached_property</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Analytics</span>:</span><br><span class="line">    user_ids: <span class="type">Tuple</span>[<span class="built_in">int</span>, ...]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @cached_property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">user_id_to_index</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Compute once, cache forever&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;user_id: idx <span class="keyword">for</span> idx, user_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="variable language_">self</span>.user_ids)&#125;</span><br><span class="line"></span><br><span class="line">analytics = Analytics((<span class="number">101</span>, <span class="number">102</span>, <span class="number">103</span>))</span><br><span class="line"><span class="built_in">print</span>(analytics.user_id_to_index)  <span class="comment"># &#123;101: 0, 102: 1, 103: 2&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Working-with-Immutable-Objects"><a href="#Working-with-Immutable-Objects" class="headerlink" title="Working with Immutable Objects"></a>Working with Immutable Objects</h2><h3 id="The-replace-Function-Pattern"><a href="#The-replace-Function-Pattern" class="headerlink" title="The replace() Function Pattern"></a>The <code>replace()</code> Function Pattern</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, replace</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserProfile</span>:</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line">    is_active: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    permissions: <span class="type">Tuple</span>[<span class="built_in">str</span>, ...] = ()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deactivate</span>(<span class="params">self</span>) -&gt; <span class="string">&#x27;UserProfile&#x27;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Functional style: return new object with changes&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> replace(<span class="variable language_">self</span>, is_active=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_permission</span>(<span class="params">self, permission: <span class="built_in">str</span></span>) -&gt; <span class="string">&#x27;UserProfile&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> replace(</span><br><span class="line">            <span class="variable language_">self</span>, </span><br><span class="line">            permissions=<span class="variable language_">self</span>.permissions + (permission,)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment"># Chain updates functionally</span></span><br><span class="line">user = UserProfile(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>)</span><br><span class="line">user = user.add_permission(<span class="string">&quot;read&quot;</span>).add_permission(<span class="string">&quot;write&quot;</span>)</span><br><span class="line">user = user.deactivate()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(user)  <span class="comment"># UserProfile(username=&#x27;alice&#x27;, email=&#x27;alice@example.com&#x27;, is_active=False, permissions=(&#x27;read&#x27;, &#x27;write&#x27;))</span></span><br></pre></td></tr></table></figure>

<h3 id="Bulk-Updates-with-Dictionary-Unpacking"><a href="#Bulk-Updates-with-Dictionary-Unpacking" class="headerlink" title="Bulk Updates with Dictionary Unpacking"></a>Bulk Updates with Dictionary Unpacking</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Settings</span>:</span><br><span class="line">    theme: <span class="built_in">str</span></span><br><span class="line">    language: <span class="built_in">str</span></span><br><span class="line">    notifications: <span class="built_in">bool</span></span><br><span class="line">    timeout: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">settings = Settings(<span class="string">&quot;dark&quot;</span>, <span class="string">&quot;en&quot;</span>, <span class="literal">True</span>, <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update multiple fields at once</span></span><br><span class="line">new_settings = replace(</span><br><span class="line">    settings,</span><br><span class="line">    **&#123;<span class="string">&quot;theme&quot;</span>: <span class="string">&quot;light&quot;</span>, <span class="string">&quot;notifications&quot;</span>: <span class="literal">False</span>&#125;  <span class="comment"># Can use dict unpacking</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Or with variable updates</span></span><br><span class="line">updates = &#123;&#125;</span><br><span class="line"><span class="keyword">if</span> user_prefers_light_mode:</span><br><span class="line">    updates[<span class="string">&quot;theme&quot;</span>] = <span class="string">&quot;light&quot;</span></span><br><span class="line"><span class="keyword">if</span> user_is_busy:</span><br><span class="line">    updates[<span class="string">&quot;notifications&quot;</span>] = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">updated_settings = replace(settings, **updates)</span><br></pre></td></tr></table></figure>

<h3 id="Versioned-Data-with-Inheritance"><a href="#Versioned-Data-with-Inheritance" class="headerlink" title="Versioned Data with Inheritance"></a>Versioned Data with Inheritance</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserV1</span>:</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserV2</span>(<span class="title class_ inherited__">UserV1</span>):</span><br><span class="line">    email: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    phone: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Backward compatible</span></span><br><span class="line">v1_user = UserV1(<span class="number">1</span>, <span class="string">&quot;Alice&quot;</span>)</span><br><span class="line">v2_user = UserV2(<span class="number">1</span>, <span class="string">&quot;Alice&quot;</span>, email=<span class="string">&quot;alice@example.com&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Type checking works</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_user</span>(<span class="params">user: UserV1</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing: <span class="subst">&#123;user.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">process_user(v1_user)  <span class="comment"># âœ…</span></span><br><span class="line">process_user(v2_user)  <span class="comment"># âœ… (inheritance)</span></span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Patterns-Alternatives"><a href="#Advanced-Patterns-Alternatives" class="headerlink" title="Advanced Patterns &amp; Alternatives"></a>Advanced Patterns &amp; Alternatives</h2><h3 id="Pattern-1-Builder-Pattern-for-Complex-Objects"><a href="#Pattern-1-Builder-Pattern-for-Complex-Objects" class="headerlink" title="Pattern 1: Builder Pattern for Complex Objects"></a>Pattern 1: Builder Pattern for Complex Objects</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Query</span>:</span><br><span class="line">    table: <span class="built_in">str</span></span><br><span class="line">    columns: <span class="type">Tuple</span>[<span class="built_in">str</span>, ...]</span><br><span class="line">    filters: <span class="type">Tuple</span>[<span class="string">&#x27;Filter&#x27;</span>, ...]</span><br><span class="line">    limit: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @dataclass</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Builder</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Mutable builder for immutable Query&quot;&quot;&quot;</span></span><br><span class="line">        table: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">        columns: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">        filters: <span class="type">List</span>[<span class="string">&#x27;Filter&#x27;</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">        limit: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">self</span>) -&gt; <span class="string">&#x27;Query&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> Query(</span><br><span class="line">                table=<span class="variable language_">self</span>.table,</span><br><span class="line">                columns=<span class="built_in">tuple</span>(<span class="variable language_">self</span>.columns),</span><br><span class="line">                filters=<span class="built_in">tuple</span>(<span class="variable language_">self</span>.filters),</span><br><span class="line">                limit=<span class="variable language_">self</span>.limit</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Filter</span>:</span><br><span class="line">        column: <span class="built_in">str</span></span><br><span class="line">        operator: <span class="built_in">str</span></span><br><span class="line">        value: <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">builder = Query.Builder()</span><br><span class="line">builder.table = <span class="string">&quot;users&quot;</span></span><br><span class="line">builder.columns = [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>]</span><br><span class="line">builder.filters.append(Query.Filter(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="number">18</span>))</span><br><span class="line">builder.limit = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">query = builder.build()  <span class="comment"># âœ… Immutable Query object</span></span><br></pre></td></tr></table></figure>

<h3 id="Pattern-2-Registry-Pattern-with-Frozen-Classes"><a href="#Pattern-2-Registry-Pattern-with-Frozen-Classes" class="headerlink" title="Pattern 2: Registry Pattern with Frozen Classes"></a>Pattern 2: Registry Pattern with Frozen Classes</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, ClassVar</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorCode</span>:</span><br><span class="line">    code: <span class="built_in">int</span></span><br><span class="line">    message: <span class="built_in">str</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Registry of all error codes</span></span><br><span class="line">    _registry: ClassVar[<span class="type">Dict</span>[<span class="built_in">int</span>, <span class="string">&#x27;ErrorCode&#x27;</span>]] = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Register the instance</span></span><br><span class="line">        ErrorCode._registry[<span class="variable language_">self</span>.code] = <span class="variable language_">self</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">cls, code: <span class="built_in">int</span></span>) -&gt; <span class="string">&#x27;ErrorCode&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> cls._registry[code]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define error codes (these become singletons)</span></span><br><span class="line">NOT_FOUND = ErrorCode(<span class="number">404</span>, <span class="string">&quot;Resource not found&quot;</span>)</span><br><span class="line">UNAUTHORIZED = ErrorCode(<span class="number">401</span>, <span class="string">&quot;Authentication required&quot;</span>)</span><br><span class="line">FORBIDDEN = ErrorCode(<span class="number">403</span>, <span class="string">&quot;Insufficient permissions&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Safe to use anywhere</span></span><br><span class="line"><span class="built_in">print</span>(ErrorCode.get(<span class="number">404</span>))  <span class="comment"># ErrorCode(code=404, message=&#x27;Resource not found&#x27;)</span></span><br></pre></td></tr></table></figure>

<h3 id="Alternative-1-collections-namedtuple"><a href="#Alternative-1-collections-namedtuple" class="headerlink" title="Alternative 1: collections.namedtuple"></a>Alternative 1: <code>collections.namedtuple</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NamedTuple</span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic immutable structure</span></span><br><span class="line">Point = namedtuple(<span class="string">&#x27;Point&#x27;</span>, [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>])</span><br><span class="line">p = Point(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># p.x = 3  # âŒ AttributeError: can&#x27;t set attribute</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With type hints (Python 3.6+)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointNT</span>(<span class="title class_ inherited__">NamedTuple</span>):</span><br><span class="line">    x: <span class="built_in">float</span></span><br><span class="line">    y: <span class="built_in">float</span></span><br><span class="line">    z: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Limitations: Less flexible than dataclasses, no easy field defaults</span></span><br></pre></td></tr></table></figure>

<h3 id="Alternative-2-attrs-Library"><a href="#Alternative-2-attrs-Library" class="headerlink" title="Alternative 2: attrs Library"></a>Alternative 2: <code>attrs</code> Library</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s(<span class="params">frozen=<span class="literal">True</span>, slots=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AttrsPoint</span>:</span><br><span class="line">    x: <span class="built_in">float</span> = attr.ib()</span><br><span class="line">    y: <span class="built_in">float</span> = attr.ib()</span><br><span class="line">    color: <span class="built_in">str</span> = attr.ib(default=<span class="string">&quot;blue&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Additional features like validators, converters</span></span><br><span class="line"><span class="meta">@attr.s(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ValidatedPoint</span>:</span><br><span class="line">    x: <span class="built_in">float</span> = attr.ib(validator=attr.validators.instance_of(<span class="built_in">float</span>))</span><br><span class="line">    y: <span class="built_in">float</span> = attr.ib(validator=attr.validators.instance_of(<span class="built_in">float</span>))</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Considerations"><a href="#Performance-Considerations" class="headerlink" title="Performance Considerations"></a>Performance Considerations</h2><h3 id="Memory-and-Speed-Implications"><a href="#Memory-and-Speed-Implications" class="headerlink" title="Memory and Speed Implications"></a>Memory and Speed Implications</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, make_dataclass</span><br><span class="line"><span class="keyword">from</span> pympler <span class="keyword">import</span> asizeof</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FrozenUser</span>:</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MutableUser</span>:</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory usage</span></span><br><span class="line">frozen = FrozenUser(<span class="number">1</span>, <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>)</span><br><span class="line">mutable = MutableUser(<span class="number">1</span>, <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Frozen size: <span class="subst">&#123;asizeof.asizeof(frozen)&#125;</span> bytes&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Mutable size: <span class="subst">&#123;asizeof.asizeof(mutable)&#125;</span> bytes&quot;</span>)</span><br><span class="line"><span class="comment"># Typically very similar - frozen might be slightly larger due to __hash__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Creation speed</span></span><br><span class="line">setup = <span class="string">&quot;from __main__ import FrozenUser, MutableUser&quot;</span></span><br><span class="line">stmt_frozen = <span class="string">&quot;FrozenUser(1, &#x27;Alice&#x27;, &#x27;alice@example.com&#x27;)&quot;</span></span><br><span class="line">stmt_mutable = <span class="string">&quot;MutableUser(1, &#x27;Alice&#x27;, &#x27;alice@example.com&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">time_frozen = timeit.timeit(stmt_frozen, setup=setup, number=<span class="number">1000000</span>)</span><br><span class="line">time_mutable = timeit.timeit(stmt_mutable, setup=setup, number=<span class="number">1000000</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Frozen creation: <span class="subst">&#123;time_frozen:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Mutable creation: <span class="subst">&#123;time_mutable:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"><span class="comment"># Frozen is slightly slower due to additional checks</span></span><br></pre></td></tr></table></figure>

<h3 id="When-Performance-Matters"><a href="#When-Performance-Matters" class="headerlink" title="When Performance Matters"></a>When Performance Matters</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># For high-performance scenarios, consider __slots__</span></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OptimizedPoint</span>:</span><br><span class="line">    __slots__ = (<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>)  <span class="comment"># Reduces memory overhead</span></span><br><span class="line">    x: <span class="built_in">float</span></span><br><span class="line">    y: <span class="built_in">float</span></span><br><span class="line">    z: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Or use tuple directly for maximum performance</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> NamedTuple</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PointNT</span>(<span class="title class_ inherited__">NamedTuple</span>):</span><br><span class="line">    x: <span class="built_in">float</span></span><br><span class="line">    y: <span class="built_in">float</span></span><br><span class="line">    z: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Benchmark: NamedTuple is fastest for creation and memory</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h2><h3 id="1-Default-to-Frozen"><a href="#1-Default-to-Frozen" class="headerlink" title="1. Default to Frozen"></a>1. <strong>Default to Frozen</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Good: Start with frozen, relax only if needed</span></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    api_key: <span class="built_in">str</span></span><br><span class="line">    timeout: <span class="built_in">int</span> = <span class="number">30</span></span><br><span class="line">    retries: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Only make mutable if you have a proven need</span></span><br><span class="line"><span class="meta">@dataclass  </span><span class="comment"># No frozen - use sparingly!</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Session</span>:</span><br><span class="line">    user_id: <span class="built_in">int</span></span><br><span class="line">    token: <span class="built_in">str</span></span><br><span class="line">    expiry: <span class="built_in">float</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Use-Immutable-Field-Types"><a href="#2-Use-Immutable-Field-Types" class="headerlink" title="2. Use Immutable Field Types"></a>2. <strong>Use Immutable Field Types</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span>, FrozenSet</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImmutableData</span>:</span><br><span class="line">    <span class="comment"># Good: Immutable types</span></span><br><span class="line">    ids: <span class="type">Tuple</span>[<span class="built_in">int</span>, ...]</span><br><span class="line">    tags: FrozenSet[<span class="built_in">str</span>]</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    count: <span class="built_in">int</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Avoid (unless converted in __post_init__):</span></span><br><span class="line">    <span class="comment"># items: List[str]  # âŒ</span></span><br><span class="line">    <span class="comment"># config: Dict[str, Any]  # âŒ</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Implement-Domain-Logic-as-Methods"><a href="#3-Implement-Domain-Logic-as-Methods" class="headerlink" title="3. Implement Domain Logic as Methods"></a>3. <strong>Implement Domain Logic as Methods</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Money</span>:</span><br><span class="line">    amount: <span class="built_in">float</span></span><br><span class="line">    currency: <span class="built_in">str</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, other: <span class="string">&#x27;Money&#x27;</span></span>) -&gt; <span class="string">&#x27;Money&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.currency != other.currency:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Currencies must match&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> replace(<span class="variable language_">self</span>, amount=<span class="variable language_">self</span>.amount + other.amount)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">convert</span>(<span class="params">self, rate: <span class="built_in">float</span>, target_currency: <span class="built_in">str</span></span>) -&gt; <span class="string">&#x27;Money&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> Money(amount=<span class="variable language_">self</span>.amount * rate, currency=target_currency)</span><br><span class="line"></span><br><span class="line">usd = Money(<span class="number">100</span>, <span class="string">&quot;USD&quot;</span>)</span><br><span class="line">eur = usd.convert(<span class="number">0.85</span>, <span class="string">&quot;EUR&quot;</span>)</span><br><span class="line">total = usd.add(Money(<span class="number">50</span>, <span class="string">&quot;USD&quot;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="4-Combine-with-kw-only-for-Clarity"><a href="#4-Combine-with-kw-only-for-Clarity" class="headerlink" title="4. Combine with kw_only for Clarity"></a>4. <strong>Combine with <code>kw_only</code> for Clarity</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span>, kw_only=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerConfig</span>:</span><br><span class="line">    host: <span class="built_in">str</span></span><br><span class="line">    port: <span class="built_in">int</span></span><br><span class="line">    ssl: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    timeout: <span class="built_in">int</span> = <span class="number">30</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># Forces explicit parameter names</span></span><br><span class="line">config = ServerConfig(host=<span class="string">&quot;example.com&quot;</span>, port=<span class="number">443</span>)</span><br><span class="line"><span class="comment"># Not: ServerConfig(&quot;example.com&quot;, 443)  # âŒ</span></span><br></pre></td></tr></table></figure>

<h3 id="5-Document-Frozen-Assumptions"><a href="#5-Document-Frozen-Assumptions" class="headerlink" title="5. Document Frozen Assumptions"></a>5. <strong>Document Frozen Assumptions</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIResponse</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Immutable response from API.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    This class is frozen to ensure:</span></span><br><span class="line"><span class="string">    1. Thread safety when sharing between components</span></span><br><span class="line"><span class="string">    2. Hashability for caching</span></span><br><span class="line"><span class="string">    3. Predictable behavior in functional pipelines</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Use `dataclasses.replace()` to create modified copies.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    status: <span class="built_in">int</span></span><br><span class="line">    data: <span class="built_in">dict</span></span><br><span class="line">    headers: <span class="type">Tuple</span>[<span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">str</span>], ...]</span><br></pre></td></tr></table></figure>

<h2 id="Common-Pitfalls-and-Solutions"><a href="#Common-Pitfalls-and-Solutions" class="headerlink" title="Common Pitfalls and Solutions"></a>Common Pitfalls and Solutions</h2><h3 id="Pitfall-1-Inadvertent-Mutation-of-Nested-Objects"><a href="#Pitfall-1-Inadvertent-Mutation-of-Nested-Objects" class="headerlink" title="Pitfall 1: Inadvertent Mutation of Nested Objects"></a>Pitfall 1: Inadvertent Mutation of Nested Objects</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># âŒ Problem</span></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Graph</span>:</span><br><span class="line">    nodes: <span class="built_in">dict</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># âœ… Solution</span></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Graph</span>:</span><br><span class="line">    nodes: frozendict  <span class="comment"># Requires &#x27;frozendict&#x27; package</span></span><br><span class="line">    <span class="comment"># OR</span></span><br><span class="line">    nodes: Mapping[<span class="built_in">str</span>, <span class="type">Any</span>]  <span class="comment"># Read-only interface</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># âœ… Better Solution</span></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Graph</span>:</span><br><span class="line">    _nodes: <span class="built_in">dict</span> = field(default_factory=<span class="built_in">dict</span>, <span class="built_in">repr</span>=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">nodes</span>(<span class="params">self</span>) -&gt; Mapping[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="keyword">return</span> MappingProxyType(<span class="variable language_">self</span>._nodes)  <span class="comment"># Read-only view</span></span><br></pre></td></tr></table></figure>

<h3 id="Pitfall-2-Circular-References"><a href="#Pitfall-2-Circular-References" class="headerlink" title="Pitfall 2: Circular References"></a>Pitfall 2: Circular References</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TreeNode</span>:</span><br><span class="line">    value: <span class="built_in">any</span></span><br><span class="line">    left: <span class="type">Optional</span>[<span class="string">&#x27;TreeNode&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">    right: <span class="type">Optional</span>[<span class="string">&#x27;TreeNode&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># This works! Frozen doesn&#x27;t prevent object graph formation</span></span><br><span class="line">    <span class="comment"># It only prevents reassignment of the fields themselves</span></span><br></pre></td></tr></table></figure>

<h3 id="Pitfall-3-Serialization-Issues"><a href="#Pitfall-3-Serialization-Issues" class="headerlink" title="Pitfall 3: Serialization Issues"></a>Pitfall 3: Serialization Issues</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, asdict</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span>:</span><br><span class="line">    x: <span class="built_in">int</span></span><br><span class="line">    y: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">d = Data(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Standard serialization works</span></span><br><span class="line">json_str = json.dumps(asdict(d))</span><br><span class="line"></span><br><span class="line"><span class="comment"># For custom serialization, implement __json__ or use a mixin</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSONSerializable</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_json</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(asdict(<span class="variable language_">self</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass(<span class="params">frozen=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsonData</span>(<span class="title class_ inherited__">JSONSerializable</span>):</span><br><span class="line">    x: <span class="built_in">int</span></span><br><span class="line">    y: <span class="built_in">int</span></span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><code>@dataclass(frozen=True)</code> is a powerful tool that brings functional programming benefits to Pythonâ€™s object-oriented world. It provides:</p>
<ol>
<li><strong>Safety</strong> through immutability</li>
<li><strong>Convenience</strong> through automatic method generation</li>
<li><strong>Expressiveness</strong> through clean, declarative syntax</li>
<li><strong>Performance</strong> through hashability and thread safety</li>
</ol>
<p>While the â€œshallow freezingâ€ limitation requires attention, following the patterns and best practices outlined above will help you create robust, maintainable, and bug-resistant data models in Python.</p>
<p><strong>When to use it</strong>: Configuration objects, value objects, messages&#x2F;events, cache keys, shared state in concurrent systems, and anywhere you want to enforce the principle of â€œno surprises.â€</p>
<p><strong>When to avoid it</strong>: When you genuinely need mutable state, when working with large object graphs that change frequently, or when the performance overhead of copying is prohibitive.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/16/Referential-Transparency-RT-Concept/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/16/Referential-Transparency-RT-Concept/" class="post-title-link" itemprop="url">Referential Transparency (RT) Concept</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-16 10:31:12 / Modified: 10:34:43" itemprop="dateCreated datePublished" datetime="2025-12-16T10:31:12-05:00">2025-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Referential-Transparency/" itemprop="url" rel="index"><span itemprop="name">Referential Transparency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Referential-Transparency/Functional-Programming/" itemprop="url" rel="index"><span itemprop="name">Functional Programming</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ğŸ”-1-Referential-Transparency-RT-Concept-Explained"><a href="#ğŸ”-1-Referential-Transparency-RT-Concept-Explained" class="headerlink" title="ğŸ” 1. Referential Transparency (RT) Concept Explained"></a>ğŸ” 1. Referential Transparency (RT) Concept Explained</h2><h3 id="What-is-Referential-Transparency"><a href="#What-is-Referential-Transparency" class="headerlink" title="What is Referential Transparency?"></a>What is Referential Transparency?</h3><p><strong>Referential Transparency (RT)</strong> is a core concept in Functional Programming (FP) which states that an expression can be replaced by its resulting value without changing the behavior or outcome of the entire program.</p>
<p>Simply put, if a function or expression is referentially transparent, every time it is called with the same input (arguments), its <strong>output must be identical</strong>, and it <strong>must not produce any observable side effects</strong>.</p>
<h3 id="Two-Key-Requirements-for-Referential-Transparency"><a href="#Two-Key-Requirements-for-Referential-Transparency" class="headerlink" title="Two Key Requirements for Referential Transparency:"></a>Two Key Requirements for Referential Transparency:</h3><ol>
<li><strong>Purity of Function:</strong><ul>
<li><strong>Same Input $\implies$ Same Output:</strong> When the function is called with the same parameters, the result must always be the same, regardless of when or where it is executed.</li>
<li><strong>No Side Effects:</strong> The function must not modify any external state (such as global variables, databases, file systems, or printing to the console).</li>
</ul>
</li>
<li><strong>Substitutability:</strong><ul>
<li>If an expression is referentially transparent, we can substitute the expression with its resulting value anywhere in the program without affecting the final result.</li>
</ul>
</li>
</ol>
<h3 id="Advantages-of-Referential-Transparency"><a href="#Advantages-of-Referential-Transparency" class="headerlink" title="Advantages of Referential Transparency:"></a>Advantages of Referential Transparency:</h3><ul>
<li><strong>Easier Reasoning:</strong> Since functions do not depend on or modify external state, we can understand and test each function in isolation, without worrying about execution order or the global environment.</li>
<li><strong>Concurrency Safety:</strong> Functions that do not modify shared state are inherently safe for parallel computation and multithreaded environments, eliminating the need for complex locking mechanisms.</li>
<li><strong>Compiler Optimization:</strong> Compilers can safely perform optimizations, such as Memoization (caching results) or common sub-expression elimination.</li>
</ul>
<hr>
<h2 id="ğŸ’»-2-Code-Examples-RT-vs-Referential-Opacity"><a href="#ğŸ’»-2-Code-Examples-RT-vs-Referential-Opacity" class="headerlink" title="ğŸ’» 2. Code Examples: RT vs. Referential Opacity"></a>ğŸ’» 2. Code Examples: RT vs. Referential Opacity</h2><p>We will use <strong>JavaScript</strong> for the code samples as it supports both functional and imperative programming styles.</p>
<h3 id="Example-1-Referentially-Transparent-Function-Pure-Function"><a href="#Example-1-Referentially-Transparent-Function-Pure-Function" class="headerlink" title="Example 1: Referentially Transparent Function (Pure Function)"></a>Example 1: Referentially Transparent Function (Pure Function)</h3><p>A simple addition function that neither depends on nor modifies external state.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pure Function (Referentially Transparent)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="comment">// 1. Same input -&gt; Same output: add(5, 10) will always return 15.</span></span><br><span class="line">  <span class="comment">// 2. No side effects: It does not change any global variables or perform I/O.</span></span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Proof of Substitution (The program&#x27;s behavior remains unchanged)</span></span><br><span class="line"><span class="keyword">const</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> y = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Original Expression</span></span><br><span class="line"><span class="keyword">const</span> result1 = <span class="title function_">add</span>(x, y) * <span class="number">2</span>; <span class="comment">// add(5, 10) -&gt; 15. result1 = 30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Substituted Expression</span></span><br><span class="line"><span class="comment">// We replace the function call add(x, y) with its calculated result (15)</span></span><br><span class="line"><span class="keyword">const</span> result2 = <span class="number">15</span> * <span class="number">2</span>;       <span class="comment">// result2 = 30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Result: result1 === result2. The substitution worked.</span></span><br></pre></td></tr></table></figure>

<h3 id="Example-2-Referentially-Opaque-Functions-Impure-Functions"><a href="#Example-2-Referentially-Opaque-Functions-Impure-Functions" class="headerlink" title="Example 2: Referentially Opaque Functions (Impure Functions)"></a>Example 2: Referentially Opaque Functions (Impure Functions)</h3><h4 id="Case-A-Dependency-on-External-State-Side-Effect-Reading-Writing-Global-State"><a href="#Case-A-Dependency-on-External-State-Side-Effect-Reading-Writing-Global-State" class="headerlink" title="Case A: Dependency on External State (Side Effect: Reading&#x2F;Writing Global State)"></a>Case A: Dependency on External State (Side Effect: Reading&#x2F;Writing Global State)</h4><p>The functionâ€™s result depends on a mutable global variable.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span>; <span class="comment">// Mutable External State</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Impure Function (Referentially Opaque)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getNextId</span>(<span class="params"></span>) &#123;</span><br><span class="line">  counter++; <span class="comment">// Side Effect: Modifies the external state</span></span><br><span class="line">  <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First call</span></span><br><span class="line"><span class="keyword">const</span> id1 = <span class="title function_">getNextId</span>(); <span class="comment">// id1 = 1, counter = 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Second call (Same input, different output)</span></span><br><span class="line"><span class="keyword">const</span> id2 = <span class="title function_">getNextId</span>(); <span class="comment">// id2 = 2, counter = 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Proof of Substitution Failure</span></span><br><span class="line"><span class="comment">// Let&#x27;s try to substitute the first call (getNextId()) with its value (1):</span></span><br><span class="line"><span class="keyword">const</span> resultA = id1 + <span class="title function_">getNextId</span>(); <span class="comment">// 1 + 2 = 3</span></span><br><span class="line"><span class="comment">// If we substitute:</span></span><br><span class="line"><span class="keyword">const</span> resultB = <span class="number">1</span> + <span class="number">1</span>; <span class="comment">// 2  &lt;-- Substitution failed, because the second call returned 2, not 1.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Result: resultA !== resultB.</span></span><br><span class="line"><span class="comment">// The output of getNextId() is unpredictable because it depends on when it was previously called.</span></span><br></pre></td></tr></table></figure>

<h4 id="Case-B-Producing-a-Side-Effect-I-O-Operation"><a href="#Case-B-Producing-a-Side-Effect-I-O-Operation" class="headerlink" title="Case B: Producing a Side Effect (I&#x2F;O Operation)"></a>Case B: Producing a Side Effect (I&#x2F;O Operation)</h4><p>The function performs an external, non-returnable action (I&#x2F;O).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Impure Function (Referentially Opaque)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">logAndReturn</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Processing value: &quot;</span> + value); <span class="comment">// Side Effect: I/O operation (printing to console)</span></span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Original Expression</span></span><br><span class="line"><span class="keyword">const</span> output1 = <span class="title function_">logAndReturn</span>(<span class="number">10</span>); <span class="comment">// Prints &quot;Processing value: 10&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Substituted Expression</span></span><br><span class="line"><span class="comment">// Replacing logAndReturn(10) with its return value 10</span></span><br><span class="line"><span class="keyword">const</span> output2 = <span class="number">10</span>; <span class="comment">// Does not print anything</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Result: output1 === output2 (The values are the same), but the program&#x27;s external behavior (console output) has changed.</span></span><br><span class="line"><span class="comment">// Because the substitution altered the overall program behavior (losing the logging action), logAndReturn is not referentially transparent.</span></span><br></pre></td></tr></table></figure>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li><strong>Referential Transparency is the manifestation of pure functions.</strong> By consistently writing functions that <strong>do not modify external state</strong> and <strong>do not depend on external mutable state</strong>, your code will achieve referential transparency.</li>
<li>In real-world applications, side effects (like I&#x2F;O, network requests) are necessary. Functional programming principles advocate for <strong>isolating these side effects</strong> and managing them explicitly using concepts like Monads to keep the core application logic referentially transparent.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/02/Spring-WebFlux-Guide-2025/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/02/Spring-WebFlux-Guide-2025/" class="post-title-link" itemprop="url">Spring WebFlux Guide - 2025</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-02 23:05:55 / Modified: 23:11:41" itemprop="dateCreated datePublished" datetime="2025-12-02T23:05:55-05:00">2025-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebFlux/" itemprop="url" rel="index"><span itemprop="name">WebFlux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>This is a comprehensive deep dive into the most crucial operators in <strong>Project Reactor</strong>, which is the foundation of <strong>Spring WebFlux</strong>. Understanding these operators is key to mastering non-blocking, reactive programming.</p>
<p>The operators are organized into functional categories, detailing their usage and real-world application.</p>
<hr>
<h2 id="1-ğŸ—ï¸-Composition-and-Transformation-Operators"><a href="#1-ğŸ—ï¸-Composition-and-Transformation-Operators" class="headerlink" title="1. ğŸ—ï¸ Composition and Transformation Operators"></a>1. ğŸ—ï¸ Composition and Transformation Operators</h2><p>These operators modify the data emitted by a <code>Publisher</code> (Mono or Flux).</p>
<table>
<thead>
<tr>
<th align="left">Operator</th>
<th align="left">Signature &amp; Description</th>
<th align="left">Key Difference</th>
<th align="left">Real-World Use Case</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>map()</code></strong></td>
<td align="left"><code>T -&gt; V</code> (Synchronous transformation)</td>
<td align="left">Applies a synchronous function to each item. <strong>Returns a simple value.</strong></td>
<td align="left">Converting a database entity (<code>UserEntity</code>) into a Data Transfer Object (<code>UserDTO</code>) after retrieval.</td>
</tr>
<tr>
<td align="left"><strong><code>flatMap()</code></strong></td>
<td align="left"><code>T -&gt; Publisher&lt;V&gt;</code> (Asynchronous transformation)</td>
<td align="left">Applies an asynchronous function that returns a new <code>Publisher</code>. Essential for <strong>chaining non-blocking I&#x2F;O operations.</strong></td>
<td align="left">Chaining microservice calls: Get <code>userId</code> (Mono A) $\rightarrow$ Use <code>userId</code> to call an external service (Mono B) $\rightarrow$ Use result B to save to the database (Mono C).</td>
</tr>
<tr>
<td align="left"><strong><code>concatMap()</code></strong></td>
<td align="left"><code>T -&gt; Publisher&lt;V&gt;</code> (Sequential <code>flatMap</code>)</td>
<td align="left">Similar to <code>flatMap</code>, but it processes and emits the results of the inner <code>Publisher</code> <strong>sequentially</strong>, preserving the original order of elements.</td>
<td align="left">Processing file uploads: Ensures that multiple files in a list are processed and saved to storage one after the other, respecting the order received, even though the I&#x2F;O operations are async.</td>
</tr>
<tr>
<td align="left"><strong><code>filter()</code></strong></td>
<td align="left"><code>T -&gt; Boolean</code></td>
<td align="left">Selectively includes items based on a predicate.</td>
<td align="left">Excluding users with an <code>isActive: false</code> status before returning a list of clients.</td>
</tr>
<tr>
<td align="left"><strong><code>cast()</code></strong></td>
<td align="left"><code>T -&gt; V</code> (Type conversion)</td>
<td align="left">Converts each element to a specified type.</td>
<td align="left">Converting an object retrieved from a generic cache (<code>Object</code>) to its expected type (<code>Product</code>).</td>
</tr>
</tbody></table>
<hr>
<h2 id="2-ğŸ¤-Combination-and-Merging-Operators"><a href="#2-ğŸ¤-Combination-and-Merging-Operators" class="headerlink" title="2. ğŸ¤ Combination and Merging Operators"></a>2. ğŸ¤ Combination and Merging Operators</h2><p>These operators combine the output from two or more source <code>Publishers</code>.</p>
<table>
<thead>
<tr>
<th align="left">Operator</th>
<th align="left">Signature &amp; Description</th>
<th align="left">Key Difference</th>
<th align="left">Real-World Use Case</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>merge()</code></strong></td>
<td align="left"><code>Publisher&lt;T&gt;... -&gt; Flux&lt;T&gt;</code> (Non-deterministic)</td>
<td align="left"><strong>Interleaves</strong> the elements from multiple sources as they arrive. The output order <strong>is not guaranteed</strong> and depends on timing.</td>
<td align="left">Combining real-time notifications: Combining two async streams of notifications (e.g., email and SMS alerts) into one feed where the order of arrival is acceptable.</td>
</tr>
<tr>
<td align="left"><strong><code>zip()</code></strong></td>
<td align="left"><code>Publisher&lt;T&gt;, Publisher&lt;V&gt; -&gt; Mono&lt;Tuple2&lt;T, V&gt;&gt;</code> (Pairwise)</td>
<td align="left"><strong>Combines the <em>n</em>-th element</strong> from each source into a <code>Tuple</code> (or custom object) once all sources have emitted an element.</td>
<td align="left">Parallel data enrichment: Fetching a user profile (<code>Mono&lt;User&gt;</code>) and their recent transaction history (<code>Mono&lt;History&gt;</code>) concurrently, then combining both results into a single object for the API response.</td>
</tr>
<tr>
<td align="left"><strong><code>combineLatest()</code></strong></td>
<td align="left"><code>Publisher&lt;T&gt;, Publisher&lt;V&gt; -&gt; Flux&lt;Tuple2&lt;T, V&gt;&gt;</code> (Emission-driven)</td>
<td align="left">Emits a new item whenever <strong>any</strong> source emits an item, combining the newly emitted item with the <strong>latest</strong> item from all other sources.</td>
<td align="left">Real-time dashboards: Combining a stream of stock prices with a stream of news headlines. A price update triggers a new emission with the latest price and the latest headline.</td>
</tr>
<tr>
<td align="left"><strong><code>concat()</code></strong></td>
<td align="left"><code>Publisher&lt;T&gt;... -&gt; Flux&lt;T&gt;</code> (Sequential)</td>
<td align="left"><strong>Appends</strong> one <code>Publisher</code> after another. The second source does not start emitting until the first source completes.</td>
<td align="left">Fallback data loading: First attempt to load data from a fast cache (<code>Mono A</code>). If A completes empty, immediately execute a database query (<code>Mono B</code>).</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-â±ï¸-Error-Handling-and-Resilience-Operators"><a href="#3-â±ï¸-Error-Handling-and-Resilience-Operators" class="headerlink" title="3. â±ï¸ Error Handling and Resilience Operators"></a>3. â±ï¸ Error Handling and Resilience Operators</h2><p>These operators manage exceptions and provide fallbacks.</p>
<table>
<thead>
<tr>
<th align="left">Operator</th>
<th align="left">Signature &amp; Description</th>
<th align="left">Key Difference</th>
<th align="left">Real-World Use Case</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>onErrorReturn()</code></strong></td>
<td align="left"><code>Class&lt;E&gt;, T</code> (Simple fallback value)</td>
<td align="left">When an error of a specific type occurs, it immediately <strong>replaces the error signal with a default, static value</strong> and completes the sequence normally.</td>
<td align="left">Handling an external API timeout: If the <code>weatherService.get()</code> call fails with a <code>TimeoutException</code>, return a cached default value like <code>&quot;Weather Unknown&quot;</code> instead of propagating the error.</td>
</tr>
<tr>
<td align="left"><strong><code>onErrorResume()</code></strong></td>
<td align="left"><code>Class&lt;E&gt;, Function&lt;E, Publisher&lt;V&gt;&gt;</code> (Fallback publisher)</td>
<td align="left">When an error occurs, it <strong>switches to a fallback <code>Publisher</code></strong>.</td>
<td align="left">Database failure: If the primary database query fails, switch to a fallback query that reads from a reliable but slightly stale read replica.</td>
</tr>
<tr>
<td align="left"><strong><code>retry()</code></strong></td>
<td align="left"><code>long times</code> (Retry N times)</td>
<td align="left"><strong>Resubscribes</strong> to the source <code>Publisher</code> upon receiving an error signal, up to a specified number of times.</td>
<td align="left">Transient network errors: Automatically retrying an external HTTP call up to three times to overcome temporary network hiccups before giving up.</td>
</tr>
<tr>
<td align="left"><strong><code>doOnError()</code></strong></td>
<td align="left"><code>Consumer&lt;Throwable&gt;</code> (Side effect)</td>
<td align="left">Allows execution of a <strong>side effect</strong> (logging, metrics tracking) when an error occurs, without modifying or consuming the error itself. The error is still passed downstream.</td>
<td align="left">Logging exceptions: Recording the full stack trace and metrics to a monitoring system before the error is propagated up the pipeline to be handled by an exception handler.</td>
</tr>
</tbody></table>
<hr>
<h2 id="4-ğŸ”—-Backpressure-and-Hot-Cold-Operators"><a href="#4-ğŸ”—-Backpressure-and-Hot-Cold-Operators" class="headerlink" title="4. ğŸ”— Backpressure and Hot&#x2F;Cold Operators"></a>4. ğŸ”— Backpressure and Hot&#x2F;Cold Operators</h2><p>These manage resource flow and execution model.</p>
<table>
<thead>
<tr>
<th align="left">Operator</th>
<th align="left">Signature &amp; Description</th>
<th align="left">Key Difference</th>
<th align="left">Real-World Use Case</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>subscribeOn()</code></strong></td>
<td align="left"><code>Scheduler</code> (Where execution starts)</td>
<td align="left">Determines the <strong>Scheduler (thread)</strong> on which the entire source execution pipeline begins. Crucial for moving blocking operations off the main Event Loop.</td>
<td align="left"><strong>Moving Blocking Code:</strong> Ensuring a blocking JDBC call or a CPU-intensive synchronous task runs on <code>Schedulers.boundedElastic()</code>.</td>
</tr>
<tr>
<td align="left"><strong><code>publishOn()</code></strong></td>
<td align="left"><code>Scheduler</code> (Where subsequent ops run)</td>
<td align="left">Changes the <code>Scheduler</code> used by <strong>all operators downstream</strong> of this call. Does not affect the source.</td>
<td align="left"><strong>Context Switching:</strong> After a heavy calculation, switching back to <code>Schedulers.parallel()</code> for non-blocking operations to maximize efficiency.</td>
</tr>
<tr>
<td align="left"><strong><code>share()</code></strong></td>
<td align="left"><code>Mono&lt;T&gt; -&gt; Mono&lt;T&gt;</code> (Multi-subscription)</td>
<td align="left">Allows multiple subscribers to share a single subscription to the source <code>Publisher</code>, ensuring the source logic is executed only once.</td>
<td align="left">Caching a slow computation: Executing an expensive initialization task (e.g., loading a large configuration file) once, then providing that result to dozens of services without re-running the load logic.</td>
</tr>
<tr>
<td align="left"><strong><code>delayElements()</code></strong></td>
<td align="left"><code>Duration</code> (Time-based pacing)</td>
<td align="left">Introduces a delay between the emissions of elements, effectively implementing <strong>backpressure by time</strong>.</td>
<td align="left">Throttling a data stream: Pacing a fast stream of data to match the input rate required by a slower downstream component (like a legacy API with strict rate limits).</td>
</tr>
</tbody></table>
<h1 id="Deepseek"><a href="#Deepseek" class="headerlink" title="Deepseek"></a>Deepseek</h1><h1 id="Spring-WebFlux-Operators-Comprehensive-Guide"><a href="#Spring-WebFlux-Operators-Comprehensive-Guide" class="headerlink" title="Spring WebFlux Operators: Comprehensive Guide"></a><strong>Spring WebFlux Operators: Comprehensive Guide</strong></h1><h2 id="Reactive-Programming-Operators-Deep-Dive"><a href="#Reactive-Programming-Operators-Deep-Dive" class="headerlink" title="Reactive Programming Operators Deep Dive"></a>Reactive Programming Operators Deep Dive</h2><hr>
<h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a><strong>Table of Contents</strong></h2><ol>
<li><a href="#1-core-concepts--reactor-basics">Core Concepts &amp; Reactor Basics</a></li>
<li><a href="#2-creation-operators">Creation Operators</a></li>
<li><a href="#3-transformation-operators">Transformation Operators</a></li>
<li><a href="#4-filtering-operators">Filtering Operators</a></li>
<li><a href="#5-combining-operators">Combining Operators</a></li>
<li><a href="#6-error-handling-operators">Error Handling Operators</a></li>
<li><a href="#7-utility-operators">Utility Operators</a></li>
<li><a href="#8-schedulers--threading">Schedulers &amp; Threading</a></li>
<li><a href="#9-backpressure-operators">Backpressure Operators</a></li>
<li><a href="#10-real-world-patterns">Real-World Patterns</a></li>
</ol>
<hr>
<h2 id="1-Core-Concepts-Reactor-Basics"><a href="#1-Core-Concepts-Reactor-Basics" class="headerlink" title="1. Core Concepts &amp; Reactor Basics"></a><strong>1. Core Concepts &amp; Reactor Basics</strong></h2><h3 id="Reactive-Streams-Specification"><a href="#Reactive-Streams-Specification" class="headerlink" title="Reactive Streams Specification"></a><strong>Reactive Streams Specification</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core Interfaces</span></span><br><span class="line">Publisher&lt;T&gt;    <span class="comment">// Emits data</span></span><br><span class="line">Subscriber&lt;T&gt;   <span class="comment">// Consumes data</span></span><br><span class="line">Subscription    <span class="comment">// Controls flow (backpressure)</span></span><br><span class="line">Processor&lt;T,R&gt;  <span class="comment">// Both publisher and subscriber</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Reactor Implementations</span></span><br><span class="line">Mono&lt;T&gt;         <span class="comment">// 0-1 element</span></span><br><span class="line">Flux&lt;T&gt;         <span class="comment">// 0-N elements</span></span><br></pre></td></tr></table></figure>

<h3 id="Cold-vs-Hot-Publishers"><a href="#Cold-vs-Hot-Publishers" class="headerlink" title="Cold vs Hot Publishers"></a><strong>Cold vs Hot Publishers</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// COLD: Each subscriber gets fresh data stream</span></span><br><span class="line">Flux&lt;Integer&gt; coldFlux = Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .doOnSubscribe(s -&gt; System.out.println(<span class="string">&quot;New subscription&quot;</span>));</span><br><span class="line"></span><br><span class="line">coldFlux.subscribe(); <span class="comment">// Prints: New subscription</span></span><br><span class="line">coldFlux.subscribe(); <span class="comment">// Prints: New subscription (again)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HOT: Shares data among subscribers</span></span><br><span class="line">ConnectableFlux&lt;Integer&gt; hotFlux = Flux.interval(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .publish(); <span class="comment">// Convert to hot publisher</span></span><br><span class="line"></span><br><span class="line">hotFlux.connect(); <span class="comment">// Start emitting</span></span><br><span class="line">hotFlux.subscribe(v -&gt; System.out.println(<span class="string">&quot;Sub1: &quot;</span> + v));</span><br><span class="line">Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">hotFlux.subscribe(v -&gt; System.out.println(<span class="string">&quot;Sub2: &quot;</span> + v)); <span class="comment">// Misses first 3 values</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Use case: Real-time stock prices</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectableFlux&lt;StockPrice&gt; priceStream;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StockController</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.priceStream = Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">            .map(tick -&gt; fetchStockPrice())</span><br><span class="line">            .publish();</span><br><span class="line">        <span class="built_in">this</span>.priceStream.connect();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prices&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;StockPrice&gt; <span class="title function_">streamPrices</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> priceStream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-Creation-Operators"><a href="#2-Creation-Operators" class="headerlink" title="2. Creation Operators"></a><strong>2. Creation Operators</strong></h2><h3 id="Static-Creation-Methods"><a href="#Static-Creation-Methods" class="headerlink" title="Static Creation Methods"></a><strong>Static Creation Methods</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. just() - Fixed values</span></span><br><span class="line">Mono.just(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. empty() - Complete without value</span></span><br><span class="line">Mono.empty()  <span class="comment">// Completes immediately</span></span><br><span class="line">Flux.empty()  <span class="comment">// Completes immediately</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. error() - Complete with error</span></span><br><span class="line">Mono.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed&quot;</span>))</span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. never() - Never completes (for testing)</span></span><br><span class="line">Mono.never()</span><br><span class="line">Flux.never()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. from...() - From existing sources</span></span><br><span class="line">Flux.fromIterable(List.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">Flux.fromStream(Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">Flux.fromArray(<span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;)</span><br><span class="line">Mono.fromFuture(CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;result&quot;</span>))</span><br><span class="line">Mono.fromCallable(() -&gt; database.query())</span><br><span class="line">Mono.fromRunnable(() -&gt; cleanup()) <span class="comment">// Returns Mono&lt;Void&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. range() - Number sequence</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>) <span class="comment">// 1,2,3,...,10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. interval() - Periodic emissions</span></span><br><span class="line">Flux.interval(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// 0,1,2,3,... every second</span></span><br><span class="line">    .take(<span class="number">5</span>) <span class="comment">// 0,1,2,3,4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. defer() - Deferred creation (per subscription)</span></span><br><span class="line">Flux.defer(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (System.currentTimeMillis() % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.just(<span class="string">&quot;Even&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.just(<span class="string">&quot;Odd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Each subscription gets potentially different result</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Database connection per request</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">getUser</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.defer(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// Create new connection per subscription</span></span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; userRepository.findById(id))</span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Programmatic-Creation"><a href="#Programmatic-Creation" class="headerlink" title="Programmatic Creation"></a><strong>Programmatic Creation</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 9. create() - Bridge with callback APIs</span></span><br><span class="line">Flux.create(sink -&gt; &#123;</span><br><span class="line">    <span class="comment">// Bridge to event-based APIs</span></span><br><span class="line">    <span class="type">EventListener</span> <span class="variable">listener</span> <span class="operator">=</span> event -&gt; &#123;</span><br><span class="line">        sink.next(event.getData());</span><br><span class="line">        <span class="keyword">if</span> (event.isComplete()) &#123;</span><br><span class="line">            sink.complete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    eventSource.register(listener);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Cleanup on cancel</span></span><br><span class="line">    sink.onCancel(() -&gt; eventSource.unregister(listener));</span><br><span class="line">    sink.onDispose(() -&gt; eventSource.unregister(listener));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: WebSocket to Flux bridge</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Message&gt; <span class="title function_">createWebSocketStream</span><span class="params">(WebSocketSession session)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.create(sink -&gt; &#123;</span><br><span class="line">        session.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(<span class="string">&quot;CONNECTED&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        session.addHandler(<span class="keyword">new</span> <span class="title class_">WebSocketHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(WebSocketSession session, WebSocketMessage&lt;?&gt; message)</span> &#123;</span><br><span class="line">                sink.next(convert(message));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> &#123;</span><br><span class="line">                sink.complete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        sink.onDispose(() -&gt; session.close());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. generate() - Synchronous, stateful generation</span></span><br><span class="line">Flux.generate(</span><br><span class="line">    () -&gt; <span class="number">0</span>, <span class="comment">// Initial state</span></span><br><span class="line">    (state, sink) -&gt; &#123;</span><br><span class="line">        sink.next(<span class="string">&quot;Value: &quot;</span> + state);</span><br><span class="line">        <span class="keyword">if</span> (state == <span class="number">10</span>) &#123;</span><br><span class="line">            sink.complete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span>; <span class="comment">// New state</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 11. push() - Single-threaded async generation (like create but single-threaded)</span></span><br><span class="line">Flux.push(sink -&gt; &#123;</span><br><span class="line">    <span class="comment">// For single-threaded producers</span></span><br><span class="line">    singleThreadedEventEmitter.onData(data -&gt; sink.next(data));</span><br><span class="line">    singleThreadedEventEmitter.onComplete(() -&gt; sink.complete());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 12. using() - Resource management</span></span><br><span class="line">Flux.using(</span><br><span class="line">    () -&gt; database.getConnection(),           <span class="comment">// Resource supplier</span></span><br><span class="line">    connection -&gt; Flux.fromIterable(connection.query()), <span class="comment">// Flux factory</span></span><br><span class="line">    connection -&gt; connection.close()          <span class="comment">// Cleanup</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-Transformation-Operators"><a href="#3-Transformation-Operators" class="headerlink" title="3. Transformation Operators"></a><strong>3. Transformation Operators</strong></h2><h3 id="Element-Transformation"><a href="#Element-Transformation" class="headerlink" title="Element Transformation"></a><strong>Element Transformation</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. map() - Synchronous 1:1 transformation</span></span><br><span class="line">Flux&lt;Integer&gt; numbers = Flux.range(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">Flux&lt;String&gt; strings = numbers.map(n -&gt; <span class="string">&quot;Number: &quot;</span> + n);</span><br><span class="line"><span class="comment">// 1 â†’ &quot;Number: 1&quot;, 2 â†’ &quot;Number: 2&quot;, ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. flatMap() - Asynchronous 1:N transformation</span></span><br><span class="line">Flux&lt;User&gt; users = Flux.just(<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>);</span><br><span class="line">Flux&lt;Order&gt; orders = users.flatMap(username -&gt; </span><br><span class="line">    orderRepository.findByUser(username) <span class="comment">// Returns Flux&lt;Order&gt;</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// Concatenates all inner Flux emissions</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. concatMap() - Preserves order (slower)</span></span><br><span class="line">users.concatMap(username -&gt; </span><br><span class="line">    orderRepository.findByUser(username)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// Waits for each inner Flux to complete before starting next</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. flatMapSequential() - Preserves source order but subscribes eagerly</span></span><br><span class="line">users.flatMapSequential(username -&gt; </span><br><span class="line">    orderRepository.findByUser(username)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Parallel API calls with ordering</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Product&gt; <span class="title function_">getProductsWithReviews</span><span class="params">(List&lt;String&gt; productIds)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.fromIterable(productIds)</span><br><span class="line">        .flatMap(id -&gt; </span><br><span class="line">            productService.getProduct(id)  <span class="comment">// Mono&lt;Product&gt;</span></span><br><span class="line">                .flatMap(product -&gt;</span><br><span class="line">                    reviewService.getReviews(id)  <span class="comment">// Mono&lt;List&lt;Review&gt;&gt;</span></span><br><span class="line">                        .map(reviews -&gt; &#123;</span><br><span class="line">                            product.setReviews(reviews);</span><br><span class="line">                            <span class="keyword">return</span> product;</span><br><span class="line">                        &#125;)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. switchMap() - Cancels previous inner publisher</span></span><br><span class="line">searchInputFlux</span><br><span class="line">    .debounce(Duration.ofMillis(<span class="number">300</span>))</span><br><span class="line">    .switchMap(query -&gt; </span><br><span class="line">        searchService.search(query) <span class="comment">// Cancels previous search if new query arrives</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. transform() - Operator composition</span></span><br><span class="line">Function&lt;Flux&lt;String&gt;, Flux&lt;String&gt;&gt; filterAndTransform =</span><br><span class="line">    flux -&gt; flux</span><br><span class="line">        .filter(s -&gt; !s.isEmpty())</span><br><span class="line">        .map(String::toUpperCase);</span><br><span class="line"></span><br><span class="line">Flux&lt;String&gt; result = Flux.just(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;world&quot;</span>)</span><br><span class="line">    .transform(filterAndTransform);</span><br></pre></td></tr></table></figure>

<h3 id="Flattening-Operators"><a href="#Flattening-Operators" class="headerlink" title="Flattening Operators"></a><strong>Flattening Operators</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7. flatMap vs flatMapMany</span></span><br><span class="line">Mono&lt;List&lt;Integer&gt;&gt; monoList = Mono.just(List.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">Flux&lt;Integer&gt; flux = monoList.flatMapMany(Flux::fromIterable);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. concatMap vs flatMap comparison</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .flatMap(i -&gt; </span><br><span class="line">        Mono.just(i * <span class="number">10</span>)</span><br><span class="line">            .delayElement(Duration.ofMillis(i * <span class="number">100</span>))</span><br><span class="line">    );</span><br><span class="line"><span class="comment">// Output order: 10, 20, 30 (may vary due to delays)</span></span><br><span class="line"></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .concatMap(i -&gt; </span><br><span class="line">        Mono.just(i * <span class="number">10</span>)</span><br><span class="line">            .delayElement(Duration.ofMillis(i * <span class="number">100</span>))</span><br><span class="line">    );</span><br><span class="line"><span class="comment">// Output order: 10, 20, 30 (guaranteed order)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: File processing with backpressure</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">processLargeFile</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.using(</span><br><span class="line">        () -&gt; Files.lines(Paths.get(filePath)),</span><br><span class="line">        Flux::fromStream,</span><br><span class="line">        Stream::close</span><br><span class="line">    )</span><br><span class="line">    .flatMap(line -&gt; </span><br><span class="line">        Mono.fromCallable(() -&gt; expensiveProcessing(line))</span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic()),</span><br><span class="line">        <span class="number">5</span> <span class="comment">// Maximum concurrency</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. groupBy() - Group elements by key</span></span><br><span class="line">Flux&lt;Transaction&gt; transactions = getTransactions();</span><br><span class="line">Flux&lt;GroupedFlux&lt;String, Transaction&gt;&gt; grouped = </span><br><span class="line">    transactions.groupBy(tx -&gt; tx.getCategory());</span><br><span class="line"></span><br><span class="line">grouped.flatMap(group -&gt; </span><br><span class="line">    group</span><br><span class="line">        .buffer(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">        .map(list -&gt; <span class="keyword">new</span> <span class="title class_">CategorySummary</span>(group.key(), list))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. window() - Split into windows</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .window(<span class="number">10</span>) <span class="comment">// Flux&lt;Flux&lt;Integer&gt;&gt; with windows of size 10</span></span><br><span class="line">    .flatMap(window -&gt; </span><br><span class="line">        window.reduce(<span class="number">0</span>, Integer::sum)</span><br><span class="line">            .map(sum -&gt; <span class="string">&quot;Window sum: &quot;</span> + sum)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Time-based windowing</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">    .window(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .flatMap(window -&gt; window.count())</span><br><span class="line">    .subscribe(count -&gt; System.out.println(<span class="string">&quot;Events per second: &quot;</span> + count));</span><br></pre></td></tr></table></figure>

<h3 id="Buffering-Windowing"><a href="#Buffering-Windowing" class="headerlink" title="Buffering &amp; Windowing"></a><strong>Buffering &amp; Windowing</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. buffer() - Collect into lists</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .buffer(<span class="number">3</span>) <span class="comment">// [1,2,3], [4,5,6], [7,8,9], [10]</span></span><br><span class="line">    .subscribe(list -&gt; System.out.println(list));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. bufferTimeout() - Size OR time based</span></span><br><span class="line">messageFlux</span><br><span class="line">    .bufferTimeout(<span class="number">100</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .subscribe(batch -&gt; batchProcessor.process(batch));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. bufferWhile() / bufferUntil()</span></span><br><span class="line">Flux&lt;Integer&gt; numbers = Flux.range(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">numbers.bufferWhile(n -&gt; n % <span class="number">2</span> == <span class="number">0</span>); <span class="comment">// Buffer while even</span></span><br><span class="line">numbers.bufferUntil(n -&gt; n % <span class="number">3</span> == <span class="number">0</span>); <span class="comment">// Buffer until divisible by 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Batch database inserts</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">saveMessages</span><span class="params">(Flux&lt;Message&gt; messages)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messages</span><br><span class="line">        .buffer(<span class="number">100</span>) <span class="comment">// Batch size</span></span><br><span class="line">        .delayElements(Duration.ofMillis(<span class="number">100</span>)) <span class="comment">// Throttle</span></span><br><span class="line">        .flatMap(batch -&gt; </span><br><span class="line">            Mono.fromRunnable(() -&gt; batchInsert(batch))</span><br><span class="line">                .subscribeOn(Schedulers.boundedElastic()),</span><br><span class="line">            <span class="number">3</span> <span class="comment">// Max concurrent batches</span></span><br><span class="line">        )</span><br><span class="line">        .then();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. window() vs buffer()</span></span><br><span class="line">Flux&lt;Integer&gt; source = Flux.range(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">source.buffer(<span class="number">3</span>);  <span class="comment">// Returns Flux&lt;List&lt;Integer&gt;&gt;</span></span><br><span class="line">source.window(<span class="number">3</span>);  <span class="comment">// Returns Flux&lt;Flux&lt;Integer&gt;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. windowUntilChanged() - Window on changing values</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">    .windowUntilChanged()</span><br><span class="line">    .flatMap(window -&gt; window.collectList())</span><br><span class="line"><span class="comment">// Windows: [1,1], [2,2], [1], [3,3]</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-Filtering-Operators"><a href="#4-Filtering-Operators" class="headerlink" title="4. Filtering Operators"></a><strong>4. Filtering Operators</strong></h2><h3 id="Basic-Filtering"><a href="#Basic-Filtering" class="headerlink" title="Basic Filtering"></a><strong>Basic Filtering</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. filter() - Predicate-based filtering</span></span><br><span class="line">Flux&lt;Integer&gt; numbers = Flux.range(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">Flux&lt;Integer&gt; even = numbers.filter(n -&gt; n % <span class="number">2</span> == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ignoreElements() - Ignore all, just completion/error</span></span><br><span class="line">Mono&lt;Void&gt; completion = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .ignoreElements(); <span class="comment">// Only onComplete/onError signals</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. distinct() - Remove duplicates</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">    .distinct() <span class="comment">// 1, 2, 3, 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. distinctUntilChanged() - Remove consecutive duplicates</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    .distinctUntilChanged() <span class="comment">// 1, 2, 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Rate limiting duplicate requests</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Response&gt; <span class="title function_">handleRequests</span><span class="params">(Flux&lt;Request&gt; requests)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> requests</span><br><span class="line">        .distinct(Request::getId) <span class="comment">// Ignore duplicate IDs</span></span><br><span class="line">        .filter(req -&gt; !isBlocked(req.getIp()))</span><br><span class="line">        .flatMap(<span class="built_in">this</span>::processRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Taking-Skipping"><a href="#Taking-Skipping" class="headerlink" title="Taking &amp; Skipping"></a><strong>Taking &amp; Skipping</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. take(n) - Take first N elements</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>).take(<span class="number">5</span>); <span class="comment">// 1,2,3,4,5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. takeLast(n) - Take last N elements</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>).takeLast(<span class="number">5</span>); <span class="comment">// 96,97,98,99,100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. takeWhile(predicate) - Take while true</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .takeWhile(n -&gt; n &lt; <span class="number">5</span>); <span class="comment">// 1,2,3,4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. takeUntil(predicate) - Take until true (inclusive)</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .takeUntil(n -&gt; n == <span class="number">5</span>); <span class="comment">// 1,2,3,4,5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. skip(n) - Skip first N elements</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).skip(<span class="number">5</span>); <span class="comment">// 6,7,8,9,10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. skipLast(n) - Skip last N elements</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).skipLast(<span class="number">5</span>); <span class="comment">// 1,2,3,4,5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. skipWhile(predicate) - Skip while true</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .skipWhile(n -&gt; n &lt; <span class="number">5</span>); <span class="comment">// 5,6,7,8,9,10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. skipUntil(predicate) - Skip until true</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .skipUntil(n -&gt; n == <span class="number">5</span>); <span class="comment">// 5,6,7,8,9,10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Pagination with take/skip</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">getUsers</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRepository.findAll()</span><br><span class="line">        .skip(page * size)</span><br><span class="line">        .take(size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. takeDuration() / skipDuration() - Time-based</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">    .take(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// Take for 1 second</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. elementAt() - Get element at index</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .elementAt(<span class="number">5</span>); <span class="comment">// Mono with value 6</span></span><br></pre></td></tr></table></figure>

<h3 id="Sampling-Throttling"><a href="#Sampling-Throttling" class="headerlink" title="Sampling &amp; Throttling"></a><strong>Sampling &amp; Throttling</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. sample(Duration) - Last element in time window</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">    .sample(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// Emit last value every second</span></span><br><span class="line">    .subscribe(System.out::println);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. sampleFirst(Duration) - First element in time window</span></span><br><span class="line">messageFlux.sampleFirst(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. sampleTimeout() - Sample with dynamic duration</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">    .sampleTimeout(</span><br><span class="line">        v -&gt; Mono.delay(Duration.ofMillis(<span class="number">50</span> + v * <span class="number">10</span>))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. throttleFirst / throttleLast (alias for sample)</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">50</span>))</span><br><span class="line">    .throttleFirst(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// First in window</span></span><br><span class="line">    .throttleLast(Duration.ofSeconds(<span class="number">1</span>))  <span class="comment">// Last in window (same as sample)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: UI event throttling</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Result&gt; <span class="title function_">search</span><span class="params">(Flux&lt;String&gt; queries)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> queries</span><br><span class="line">            .filter(query -&gt; query.length() &gt; <span class="number">2</span>)</span><br><span class="line">            .debounce(Duration.ofMillis(<span class="number">300</span>)) <span class="comment">// Wait for pause</span></span><br><span class="line">            .distinctUntilChanged() <span class="comment">// Ignore same query</span></span><br><span class="line">            .switchMap(<span class="built_in">this</span>::executeSearch); <span class="comment">// Cancel previous</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. debounce - Wait for quiet period</span></span><br><span class="line">buttonClickFlux</span><br><span class="line">    .debounce(Duration.ofMillis(<span class="number">250</span>)) <span class="comment">// Prevent double clicks</span></span><br><span class="line">    .subscribe(<span class="built_in">this</span>::handleClick);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-Combining-Operators"><a href="#5-Combining-Operators" class="headerlink" title="5. Combining Operators"></a><strong>5. Combining Operators</strong></h2><h3 id="Sequential-Combination"><a href="#Sequential-Combination" class="headerlink" title="Sequential Combination"></a><strong>Sequential Combination</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. concatWith() - Sequential concatenation</span></span><br><span class="line">Flux&lt;Integer&gt; flux1 = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">Flux&lt;Integer&gt; flux2 = Flux.just(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line">flux1.concatWith(flux2); <span class="comment">// 1,2,3,4,5,6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. concat() - Static version</span></span><br><span class="line">Flux.concat(flux1, flux2, Flux.just(<span class="number">7</span>, <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. concatDelayError() - Delay errors until end</span></span><br><span class="line">Flux.concatDelayError(</span><br><span class="line">    Flux.just(<span class="number">1</span>, <span class="number">2</span>).concatWith(Mono.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>())),</span><br><span class="line">    Flux.just(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">); <span class="comment">// Emits: 1,2,3,4 then error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Fallback service calls</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Product&gt; <span class="title function_">getProducts</span><span class="params">(String category)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> primaryService.getProducts(category)</span><br><span class="line">        .concatWith(secondaryService.getProducts(category))</span><br><span class="line">        .take(<span class="number">10</span>); <span class="comment">// Get up to 10 from either source</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parallel-Combination"><a href="#Parallel-Combination" class="headerlink" title="Parallel Combination"></a><strong>Parallel Combination</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. mergeWith() - Interleave emissions</span></span><br><span class="line">Flux&lt;Integer&gt; flux1 = Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>);</span><br><span class="line">Flux&lt;Integer&gt; flux2 = Flux.interval(Duration.ofMillis(<span class="number">150</span>))</span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">flux1.mergeWith(flux2); <span class="comment">// Interleaved: 0,1,2,3,4,5,...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. merge() - Static version</span></span><br><span class="line">Flux.merge(flux1, flux2, flux3);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. mergeSequential() - Subscribe in order, emit as arrive</span></span><br><span class="line">Flux.mergeSequential(flux1, flux2); <span class="comment">// Maintains subscription order</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. mergeOrdered() - Merge with ordering</span></span><br><span class="line">Flux.mergeOrdered(</span><br><span class="line">    Comparator.naturalOrder(),</span><br><span class="line">    flux1, flux2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Aggregating multiple data sources</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;StockPrice&gt; <span class="title function_">getAllStockPrices</span><span class="params">(List&lt;String&gt; symbols)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.fromIterable(symbols)</span><br><span class="line">        .flatMap(symbol -&gt; </span><br><span class="line">            stockService.getPriceStream(symbol),</span><br><span class="line">            <span class="number">5</span> <span class="comment">// Max concurrent subscriptions</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pairing-Operators"><a href="#Pairing-Operators" class="headerlink" title="Pairing Operators"></a><strong>Pairing Operators</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. zipWith() - Pair-wise combination</span></span><br><span class="line">Flux&lt;Integer&gt; numbers = Flux.range(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">Flux&lt;String&gt; letters = Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line"></span><br><span class="line">numbers.zipWith(letters, (n, l) -&gt; n + l);</span><br><span class="line"><span class="comment">// [1A, 2B, 3C]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. zip() - Static version</span></span><br><span class="line">Flux.zip(numbers, letters, more)</span><br><span class="line">    .map(tuple -&gt; tuple.getT1() + tuple.getT2());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. zip with combinator</span></span><br><span class="line">Flux.zip(</span><br><span class="line">    obj -&gt; <span class="keyword">new</span> <span class="title class_">Combined</span>((String)obj[<span class="number">0</span>], (Integer)obj[<span class="number">1</span>]),</span><br><span class="line">    flux1, flux2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Parallel API calls with aggregation</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;UserProfile&gt; <span class="title function_">getUserProfile</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.zip(</span><br><span class="line">        userService.getUser(userId),</span><br><span class="line">        orderService.getOrders(userId),</span><br><span class="line">        paymentService.getPaymentMethods(userId)</span><br><span class="line">    ).map(tuple -&gt; <span class="keyword">new</span> <span class="title class_">UserProfile</span>(</span><br><span class="line">        tuple.getT1(),</span><br><span class="line">        tuple.getT2(),</span><br><span class="line">        tuple.getT3()</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. combineLatest - Latest from each</span></span><br><span class="line">Flux.combineLatest(</span><br><span class="line">    flux1, flux2,</span><br><span class="line">    (v1, v2) -&gt; v1 + <span class="string">&quot; - &quot;</span> + v2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Real-time dashboard</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;DashboardData&gt; <span class="title function_">getDashboard</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.combineLatest(</span><br><span class="line">        cpuMetrics,</span><br><span class="line">        memoryMetrics,</span><br><span class="line">        networkMetrics,</span><br><span class="line">        (cpu, memory, network) -&gt; <span class="keyword">new</span> <span class="title class_">DashboardData</span>(cpu, memory, network)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Race-Conditions"><a href="#Race-Conditions" class="headerlink" title="Race Conditions"></a><strong>Race Conditions</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. firstWithSignal / firstWithValue - Race to emit</span></span><br><span class="line">Mono&lt;String&gt; cache = getFromCache(key);</span><br><span class="line">Mono&lt;String&gt; db = getFromDatabase(key);</span><br><span class="line"></span><br><span class="line">Mono.firstWithSignal(cache, db) <span class="comment">// First to emit any signal</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line">Mono.firstWithValue(cache, db) <span class="comment">// First to emit a value</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Circuit breaker with fallbacks</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Response&gt; <span class="title function_">callWithFallback</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> primaryService.call(request)</span><br><span class="line">        .timeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">        .onErrorResume(e -&gt; </span><br><span class="line">            Mono.firstWithValue(</span><br><span class="line">                secondaryService.call(request),</span><br><span class="line">                Mono.just(Response.fallback())</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. amb (deprecated, use firstWithSignal)</span></span><br><span class="line">Flux.firstWithSignal(source1, source2, source3);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-Error-Handling-Operators"><a href="#6-Error-Handling-Operators" class="headerlink" title="6. Error Handling Operators"></a><strong>6. Error Handling Operators</strong></h2><h3 id="Error-Recovery"><a href="#Error-Recovery" class="headerlink" title="Error Recovery"></a><strong>Error Recovery</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. onErrorReturn - Provide fallback value</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .map(n -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">2</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Boom!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;)</span><br><span class="line">    .onErrorReturn(<span class="number">0</span>); <span class="comment">// 1, 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. onErrorResume - Switch to fallback publisher</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed&quot;</span>))</span><br><span class="line">    .onErrorResume(e -&gt; </span><br><span class="line">        Flux.just(<span class="string">&quot;fallback1&quot;</span>, <span class="string">&quot;fallback2&quot;</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. onErrorContinue - Continue with next element</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">    .map(n -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">3</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Skip 3&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> n * <span class="number">10</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .onErrorContinue((e, obj) -&gt; </span><br><span class="line">        log.error(<span class="string">&quot;Skipped &#123;&#125; due to &#123;&#125;&quot;</span>, obj, e.getMessage())</span><br><span class="line">    ); <span class="comment">// 10, 20, 40</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Resilient API calls</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Product&gt; <span class="title function_">getProductsWithRetry</span><span class="params">(List&lt;String&gt; ids)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.fromIterable(ids)</span><br><span class="line">        .flatMap(id -&gt; </span><br><span class="line">            productService.getProduct(id)</span><br><span class="line">                .onErrorResume(e -&gt; &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;Failed for &#123;&#125;, trying fallback&quot;</span>, id);</span><br><span class="line">                    <span class="keyword">return</span> fallbackService.getProduct(id);</span><br><span class="line">                &#125;)</span><br><span class="line">                .onErrorResume(e -&gt; &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Complete failure for &#123;&#125;&quot;</span>, id);</span><br><span class="line">                    <span class="keyword">return</span> Mono.just(Product.unavailable(id));</span><br><span class="line">                &#125;)</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Retry-Strategies"><a href="#Retry-Strategies" class="headerlink" title="Retry Strategies"></a><strong>Retry Strategies</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. retry() - Simple retry</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>())</span><br><span class="line">    .retry(<span class="number">3</span>); <span class="comment">// Retry 3 times</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. retryWhen - Advanced retry with backoff</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>())</span><br><span class="line">    .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">        .maxBackoff(Duration.ofSeconds(<span class="number">10</span>))</span><br><span class="line">        .jitter(<span class="number">0.5</span>) <span class="comment">// Add randomness</span></span><br><span class="line">        .doBeforeRetry(retrySignal -&gt; </span><br><span class="line">            log.warn(<span class="string">&quot;Retrying attempt &#123;&#125;&quot;</span>, retrySignal.totalRetries())</span><br><span class="line">        )</span><br><span class="line">        .onRetryExhaustedThrow((spec, signal) -&gt; </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServiceUnavailableException</span>(<span class="string">&quot;Max retries exceeded&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. retryWhen with predicate</span></span><br><span class="line">.retryWhen(Retry.fixedDelay(<span class="number">5</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .filter(e -&gt; e <span class="keyword">instanceof</span> TimeoutException)</span><br><span class="line">    .doBeforeRetry(retrySignal -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (retrySignal.totalRetries() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            refreshConnection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Exponential backoff for external APIs</span></span><br><span class="line"><span class="keyword">private</span> RetrySpec <span class="title function_">apiRetrySpec</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Retry.backoff(<span class="number">5</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">        .maxBackoff(Duration.ofMinutes(<span class="number">1</span>))</span><br><span class="line">        .transientErrors(<span class="literal">true</span>) <span class="comment">// Retry on 5xx errors</span></span><br><span class="line">        .doBeforeRetry(retry -&gt; </span><br><span class="line">            metrics.recordRetry(retry.failure())</span><br><span class="line">        )</span><br><span class="line">        .onRetryExhaustedThrow((spec, signal) -&gt; </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ApiException</span>(<span class="string">&quot;Service unavailable after retries&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Response&gt; <span class="title function_">callExternalApi</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> webClient.post()</span><br><span class="line">        .bodyValue(request)</span><br><span class="line">        .retrieve()</span><br><span class="line">        .bodyToMono(Response.class)</span><br><span class="line">        .retryWhen(apiRetrySpec());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Timeout-Fallback"><a href="#Timeout-Fallback" class="headerlink" title="Timeout &amp; Fallback"></a><strong>Timeout &amp; Fallback</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. timeout - Timeout with fallback</span></span><br><span class="line">Flux.interval(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .onErrorResume(TimeoutException.class, e -&gt; </span><br><span class="line">        Flux.just(-<span class="number">1L</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. timeout with fallback publisher</span></span><br><span class="line">slowFlux</span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">1</span>), fallbackFlux)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Service call with timeout cascade</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Response&gt; <span class="title function_">callServiceWithTimeouts</span><span class="params">(Request req)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> primaryService.call(req)</span><br><span class="line">        .timeout(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">        .onErrorResume(TimeoutException.class, e -&gt;</span><br><span class="line">            secondaryService.call(req)</span><br><span class="line">                .timeout(Duration.ofMillis(<span class="number">200</span>))</span><br><span class="line">        )</span><br><span class="line">        .onErrorResume(TimeoutException.class, e -&gt;</span><br><span class="line">            tertiaryService.call(req)</span><br><span class="line">                .timeout(Duration.ofMillis(<span class="number">500</span>))</span><br><span class="line">        )</span><br><span class="line">        .onErrorReturn(Response.fallback());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Error-Classification"><a href="#Error-Classification" class="headerlink" title="Error Classification"></a><strong>Error Classification</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. onErrorMap - Transform error</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Connection failed&quot;</span>))</span><br><span class="line">    .onErrorMap(IOException.class, e -&gt; </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;Service unavailable&quot;</span>, e)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. onErrorMap with predicate</span></span><br><span class="line">.onErrorMap(e -&gt; e.getMessage().contains(<span class="string">&quot;timeout&quot;</span>), </span><br><span class="line">    e -&gt; <span class="keyword">new</span> <span class="title class_">TimeoutException</span>(<span class="string">&quot;Operation timed out&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. doOnError - Side effect on error</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>())</span><br><span class="line">    .doOnError(e -&gt; </span><br><span class="line">        metrics.incrementError(e.getClass().getSimpleName())</span><br><span class="line">    )</span><br><span class="line">    .onErrorResume(e -&gt; Mono.empty());</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Circuit breaker pattern</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CircuitBreakerService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Data&gt; <span class="title function_">getDataWithCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.defer(() -&gt; externalService.getData())</span><br><span class="line">            .transformDeferred(circuitBreaker::run)</span><br><span class="line">            .onErrorResume(CallNotPermittedException.class, e -&gt; </span><br><span class="line">                Flux.error(<span class="keyword">new</span> <span class="title class_">ServiceUnavailableException</span>())</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-Utility-Operators"><a href="#7-Utility-Operators" class="headerlink" title="7. Utility Operators"></a><strong>7. Utility Operators</strong></h2><h3 id="Side-Effects"><a href="#Side-Effects" class="headerlink" title="Side Effects"></a><strong>Side Effects</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. doOnNext - Peek at values</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .doOnNext(n -&gt; System.out.println(<span class="string">&quot;Processing: &quot;</span> + n))</span><br><span class="line">    .map(n -&gt; n * <span class="number">2</span>)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. doOnComplete - On completion</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .doOnComplete(() -&gt; System.out.println(<span class="string">&quot;Done!&quot;</span>))</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. doOnError - On error</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>())</span><br><span class="line">    .doOnError(e -&gt; log.error(<span class="string">&quot;Failed&quot;</span>, e))</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. doOnSubscribe / doOnCancel / doOnRequest</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .doOnSubscribe(s -&gt; System.out.println(<span class="string">&quot;Subscribed&quot;</span>))</span><br><span class="line">    .doOnRequest(n -&gt; System.out.println(<span class="string">&quot;Requested: &quot;</span> + n))</span><br><span class="line">    .doOnCancel(() -&gt; System.out.println(<span class="string">&quot;Cancelled&quot;</span>))</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Request logging</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/data&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Data&gt; <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataService.getData()</span><br><span class="line">            .doOnSubscribe(s -&gt; </span><br><span class="line">                log.info(<span class="string">&quot;Request started at &#123;&#125;&quot;</span>, Instant.now())</span><br><span class="line">            )</span><br><span class="line">            .doOnComplete(() -&gt; </span><br><span class="line">                log.info(<span class="string">&quot;Request completed successfully&quot;</span>)</span><br><span class="line">            )</span><br><span class="line">            .doOnError(e -&gt; </span><br><span class="line">                log.error(<span class="string">&quot;Request failed&quot;</span>, e)</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Debugging-Metrics"><a href="#Debugging-Metrics" class="headerlink" title="Debugging &amp; Metrics"></a><strong>Debugging &amp; Metrics</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. log() - Log all signals</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .log(<span class="string">&quot;my.flux&quot;</span>)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// [my.flux] onSubscribe(FluxRange.RangeSubscription)</span></span><br><span class="line"><span class="comment">// [my.flux] request(unbounded)</span></span><br><span class="line"><span class="comment">// [my.flux] onNext(1)</span></span><br><span class="line"><span class="comment">// [my.flux] onNext(2)</span></span><br><span class="line"><span class="comment">// [my.flux] onNext(3)</span></span><br><span class="line"><span class="comment">// [my.flux] onComplete()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. checkpoint - Add trace for debugging</span></span><br><span class="line">Flux.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Oops&quot;</span>))</span><br><span class="line">    .checkpoint(<span class="string">&quot;errorSource&quot;</span>)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stack trace includes &quot;errorSource&quot; marker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. metrics - Micrometer integration</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .name(<span class="string">&quot;myFlux&quot;</span>)</span><br><span class="line">    .metrics()</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Production monitoring</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Event&gt; <span class="title function_">processEvents</span><span class="params">(Flux&lt;Event&gt; events)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> events</span><br><span class="line">        .name(<span class="string">&quot;event.processor&quot;</span>)</span><br><span class="line">        .tag(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;kafka&quot;</span>)</span><br><span class="line">        .metrics() <span class="comment">// Exposes metrics to Micrometer</span></span><br><span class="line">        .doOnNext(event -&gt; </span><br><span class="line">            Metrics.counter(<span class="string">&quot;events.processed&quot;</span>).increment()</span><br><span class="line">        )</span><br><span class="line">        .doOnError(e -&gt; </span><br><span class="line">            Metrics.counter(<span class="string">&quot;events.failed&quot;</span>).increment()</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Conditional-Operators"><a href="#Conditional-Operators" class="headerlink" title="Conditional Operators"></a><strong>Conditional Operators</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. hasElements / hasElement</span></span><br><span class="line">Mono&lt;Boolean&gt; hasData = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).hasElements();</span><br><span class="line">Mono&lt;Boolean&gt; hasTwo = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).hasElement(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. any / all</span></span><br><span class="line">Mono&lt;Boolean&gt; anyEven = Flux.just(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>).any(n -&gt; n % <span class="number">2</span> == <span class="number">0</span>);</span><br><span class="line">Mono&lt;Boolean&gt; allPositive = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).all(n -&gt; n &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. defaultIfEmpty</span></span><br><span class="line">Flux.empty()</span><br><span class="line">    .defaultIfEmpty(<span class="string">&quot;default&quot;</span>); <span class="comment">// Emits &quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. switchIfEmpty</span></span><br><span class="line">Flux.empty()</span><br><span class="line">    .switchIfEmpty(Flux.just(<span class="string">&quot;fallback&quot;</span>, <span class="string">&quot;values&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Cache with fallback</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">getUser</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache.get(id)</span><br><span class="line">        .switchIfEmpty(</span><br><span class="line">            database.getUser(id)</span><br><span class="line">                .doOnNext(user -&gt; cache.set(id, user))</span><br><span class="line">        )</span><br><span class="line">        .defaultIfEmpty(User.anonymous());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Collecting-Reducing"><a href="#Collecting-Reducing" class="headerlink" title="Collecting &amp; Reducing"></a><strong>Collecting &amp; Reducing</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. collectList / collectMap / collectMultimap</span></span><br><span class="line">Flux.just(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">    .collectList() <span class="comment">// Mono&lt;List&lt;String&gt;&gt;</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line">Flux.just(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Pair</span>(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Pair</span>(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;value2&quot;</span>)</span><br><span class="line">).collectMap(Pair::getKey, Pair::getValue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. reduce - Accumulate values</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .reduce(<span class="number">0</span>, Integer::sum); <span class="comment">// Mono with value 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. scan - Emit accumulation steps</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .scan(<span class="number">0</span>, Integer::sum); <span class="comment">// 0,1,3,6,10,15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. count</span></span><br><span class="line">Flux.just(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>).count(); <span class="comment">// Mono with value 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Real-time analytics</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;AggregatedStats&gt; <span class="title function_">streamStats</span><span class="params">(Flux&lt;Event&gt; events)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> events</span><br><span class="line">        .window(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">        .flatMap(window -&gt; </span><br><span class="line">            window</span><br><span class="line">                .reduce(<span class="keyword">new</span> <span class="title class_">StatsAccumulator</span>(), StatsAccumulator::add)</span><br><span class="line">                .map(StatsAccumulator::toStats)</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-Schedulers-Threading"><a href="#8-Schedulers-Threading" class="headerlink" title="8. Schedulers &amp; Threading"></a><strong>8. Schedulers &amp; Threading</strong></h2><h3 id="Scheduler-Types"><a href="#Scheduler-Types" class="headerlink" title="Scheduler Types"></a><strong>Scheduler Types</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Schedulers.immediate() - Current thread</span></span><br><span class="line"><span class="comment">// 2. Schedulers.single() - Single dedicated thread</span></span><br><span class="line"><span class="comment">// 3. Schedulers.elastic() - Deprecated, use boundedElastic</span></span><br><span class="line"><span class="comment">// 4. Schedulers.boundedElastic() - For blocking I/O</span></span><br><span class="line"><span class="comment">// 5. Schedulers.parallel() - For CPU-intensive work</span></span><br><span class="line"><span class="comment">// 6. Schedulers.fromExecutorService() - Custom executor</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Threading strategy by operation type</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Result&gt; <span class="title function_">process</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> validate(request) <span class="comment">// Fast, use immediate</span></span><br><span class="line">        .flatMap(validated -&gt; </span><br><span class="line">            Mono.fromCallable(() -&gt; blockingIO(validated))</span><br><span class="line">                .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">        )</span><br><span class="line">        .flatMap(ioResult -&gt; </span><br><span class="line">            Mono.fromCallable(() -&gt; cpuIntensive(ioResult))</span><br><span class="line">                .subscribeOn(Schedulers.parallel())</span><br><span class="line">        )</span><br><span class="line">        .publishOn(Schedulers.single()) <span class="comment">// Switch back to single thread</span></span><br><span class="line">        .doOnNext(result -&gt; </span><br><span class="line">            <span class="comment">// UI updates or single-threaded operations</span></span><br><span class="line">            updateUI(result)</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Threading-Operators"><a href="#Threading-Operators" class="headerlink" title="Threading Operators"></a><strong>Threading Operators</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. subscribeOn - Where subscription happens</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .map(n -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Map on: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> n * <span class="number">2</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .subscribeOn(Schedulers.parallel())</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. publishOn - Switch threads downstream</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .map(n -&gt; n * <span class="number">2</span>) <span class="comment">// On subscription thread</span></span><br><span class="line">    .publishOn(Schedulers.single())</span><br><span class="line">    .map(n -&gt; n + <span class="number">1</span>) <span class="comment">// On single thread</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. parallel / runOn - Parallel processing</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .parallel(<span class="number">4</span>) <span class="comment">// Split into 4 rails</span></span><br><span class="line">    .runOn(Schedulers.parallel())</span><br><span class="line">    .map(n -&gt; n * <span class="number">2</span>)</span><br><span class="line">    .sequential(); <span class="comment">// Merge back to single Flux</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Image processing pipeline</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;ProcessedImage&gt; <span class="title function_">processImages</span><span class="params">(Flux&lt;Image&gt; images)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> images</span><br><span class="line">        .parallel(<span class="number">4</span>) <span class="comment">// 4 parallel lanes</span></span><br><span class="line">        .runOn(Schedulers.parallel()) <span class="comment">// Each lane on parallel scheduler</span></span><br><span class="line">        .map(<span class="built_in">this</span>::detectEdges) <span class="comment">// CPU-intensive</span></span><br><span class="line">        .sequential() <span class="comment">// Back to single flux</span></span><br><span class="line">        .publishOn(Schedulers.boundedElastic())</span><br><span class="line">        .flatMap(<span class="built_in">this</span>::saveToStorage) <span class="comment">// I/O intensive</span></span><br><span class="line">        .publishOn(Schedulers.single())</span><br><span class="line">        .doOnNext(<span class="built_in">this</span>::notifyUI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Context-Propagation"><a href="#Context-Propagation" class="headerlink" title="Context Propagation"></a><strong>Context Propagation</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. contextWrite - Write to Context</span></span><br><span class="line">Flux.just(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    .flatMap(word -&gt; </span><br><span class="line">        Mono.deferContextual(ctx -&gt; </span><br><span class="line">            Mono.just(word + <span class="string">&quot; &quot;</span> + ctx.get(<span class="string">&quot;user&quot;</span>))</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    .contextWrite(Context.of(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;Alice&quot;</span>))</span><br><span class="line">    .subscribe(System.out::println); <span class="comment">// Hello Alice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. transformDeferredContextual</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .transformDeferredContextual((flux, ctx) -&gt; </span><br><span class="line">        flux.map(n -&gt; n + ctx.getOrDefault(<span class="string">&quot;offset&quot;</span>, <span class="number">0</span>))</span><br><span class="line">    )</span><br><span class="line">    .contextWrite(Context.of(<span class="string">&quot;offset&quot;</span>, <span class="number">100</span>))</span><br><span class="line">    .subscribe(); <span class="comment">// 101, 102, 103, 104, 105</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Request tracing</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TracingFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange)</span><br><span class="line">            .contextWrite(Context.of(</span><br><span class="line">                <span class="string">&quot;traceId&quot;</span>, exchange.getRequest().getId(),</span><br><span class="line">                <span class="string">&quot;userId&quot;</span>, extractUserId(exchange)</span><br><span class="line">            ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/data&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Data&gt; <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.deferContextual(ctx -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">traceId</span> <span class="operator">=</span> ctx.get(<span class="string">&quot;traceId&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> dataService.getData()</span><br><span class="line">                .doOnSubscribe(s -&gt; </span><br><span class="line">                    log.info(<span class="string">&quot;Trace &#123;&#125;: Started&quot;</span>, traceId)</span><br><span class="line">                );</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-Backpressure-Operators"><a href="#9-Backpressure-Operators" class="headerlink" title="9. Backpressure Operators"></a><strong>9. Backpressure Operators</strong></h2><h3 id="Backpressure-Strategies"><a href="#Backpressure-Strategies" class="headerlink" title="Backpressure Strategies"></a><strong>Backpressure Strategies</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. onBackpressureBuffer - Buffer with limits</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .onBackpressureBuffer(</span><br><span class="line">        <span class="number">100</span>,                      <span class="comment">// Buffer size</span></span><br><span class="line">        BufferOverflowStrategy.DROP_OLDEST, <span class="comment">// Strategy</span></span><br><span class="line">        buffer -&gt; log.warn(<span class="string">&quot;Buffer overflow: &#123;&#125;&quot;</span>, buffer.size())</span><br><span class="line">    )</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. onBackpressureDrop - Drop excess</span></span><br><span class="line">fastProducer</span><br><span class="line">    .onBackpressureDrop(dropped -&gt; </span><br><span class="line">        metrics.recordDropped(dropped)</span><br><span class="line">    )</span><br><span class="line">    .subscribe(slowConsumer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. onBackpressureLatest - Keep only latest</span></span><br><span class="line">realTimeData</span><br><span class="line">    .onBackpressureLatest()</span><br><span class="line">    .subscribe(uiUpdater);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. onBackpressureError - Error on overflow</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">10</span>))</span><br><span class="line">    .onBackpressureError()</span><br><span class="line">    .subscribe(</span><br><span class="line">        System.out::println,</span><br><span class="line">        e -&gt; log.error(<span class="string">&quot;Backpressure overflow&quot;</span>, e)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: Adaptive backpressure</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Data&gt; <span class="title function_">adaptBackpressure</span><span class="params">(Flux&lt;Data&gt; source, Consumer&lt;Data&gt; processor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> source</span><br><span class="line">        .onBackpressureBuffer(</span><br><span class="line">            <span class="number">1000</span>,</span><br><span class="line">            BufferOverflowStrategy.DROP_OLDEST,</span><br><span class="line">            buffer -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (buffer.size() &gt; <span class="number">800</span>) &#123;</span><br><span class="line">                    <span class="comment">// Slow down producer</span></span><br><span class="line">                    adjustProducerRate(<span class="number">0.5</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        .doOnNext(processor)</span><br><span class="line">        .doOnRequest(n -&gt; &#123;</span><br><span class="line">            <span class="comment">// Increase rate when buffer is low</span></span><br><span class="line">            <span class="keyword">if</span> (getBufferSize() &lt; <span class="number">200</span>) &#123;</span><br><span class="line">                adjustProducerRate(<span class="number">1.5</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Request-Management"><a href="#Request-Management" class="headerlink" title="Request Management"></a><strong>Request Management</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. limitRequest - Limit total request</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .limitRequest(<span class="number">10</span>) <span class="comment">// Only request 10 elements</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. limitRate - Control request batches</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .limitRate(<span class="number">100</span>, <span class="number">50</span>) <span class="comment">// Request 100, replenish at 50</span></span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. subscribe with request</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .subscribe(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> &#123;</span><br><span class="line">                request(<span class="number">10</span>); <span class="comment">// Request first 10</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnNext</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">                process(value);</span><br><span class="line">                <span class="keyword">if</span> (value % <span class="number">10</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    request(<span class="number">10</span>); <span class="comment">// Request more in batches</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// REAL-WORLD: File streaming with backpressure</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;ByteBuffer&gt; <span class="title function_">streamFile</span><span class="params">(String path, <span class="type">int</span> chunkSize)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.using(</span><br><span class="line">        () -&gt; Files.newInputStream(Paths.get(path)),</span><br><span class="line">        in -&gt; &#123;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[chunkSize];</span><br><span class="line">            <span class="keyword">return</span> Flux.generate(sink -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> in.read(buffer);</span><br><span class="line">                    <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;</span><br><span class="line">                        sink.complete();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (read &lt; buffer.length) &#123;</span><br><span class="line">                        sink.next(ByteBuffer.wrap(buffer, <span class="number">0</span>, read));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sink.next(ByteBuffer.wrap(buffer));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    sink.error(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        in -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123; in.close(); &#125; <span class="keyword">catch</span> (IOException e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-Real-World-Patterns"><a href="#10-Real-World-Patterns" class="headerlink" title="10. Real-World Patterns"></a><strong>10. Real-World Patterns</strong></h2><h3 id="Pattern-1-API-Gateway-Aggregation"><a href="#Pattern-1-API-Gateway-Aggregation" class="headerlink" title="Pattern 1: API Gateway Aggregation"></a><strong>Pattern 1: API Gateway Aggregation</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AggregationController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user-dashboard/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Dashboard&gt; <span class="title function_">getUserDashboard</span><span class="params">(<span class="meta">@PathVariable</span> String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.zip(</span><br><span class="line">            userService.getUser(userId).subscribeOn(Schedulers.boundedElastic()),</span><br><span class="line">            orderService.getOrders(userId).collectList().subscribeOn(Schedulers.boundedElastic()),</span><br><span class="line">            paymentService.getPayments(userId).collectList().subscribeOn(Schedulers.boundedElastic()),</span><br><span class="line">            notificationService.getNotifications(userId).collectList().subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">        )</span><br><span class="line">        .map(tuple -&gt; <span class="keyword">new</span> <span class="title class_">Dashboard</span>(</span><br><span class="line">            tuple.getT1(),</span><br><span class="line">            tuple.getT2(),</span><br><span class="line">            tuple.getT3(),</span><br><span class="line">            tuple.getT4()</span><br><span class="line">        ))</span><br><span class="line">        .timeout(Duration.ofSeconds(<span class="number">3</span>))</span><br><span class="line">        .onErrorResume(e -&gt; </span><br><span class="line">            fallbackDashboardService.getDashboard(userId)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/search&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Product&gt; <span class="title function_">searchProducts</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam</span> String query,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> <span class="type">int</span> limit</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.merge(</span><br><span class="line">            productService.search(query).take(limit),</span><br><span class="line">            inventoryService.search(query).take(limit)</span><br><span class="line">        )</span><br><span class="line">        .distinct(Product::getId)</span><br><span class="line">        .sort(Comparator.comparing(Product::getScore).reversed())</span><br><span class="line">        .take(limit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-2-Event-Driven-Processing"><a href="#Pattern-2-Event-Driven-Processing" class="headerlink" title="Pattern 2: Event-Driven Processing"></a><strong>Pattern 2: Event-Driven Processing</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Flux&lt;Event&gt; eventStream;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sinks.Many&lt;Event&gt; sink = Sinks.many().multicast().onBackpressureBuffer(<span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EventProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.eventStream = sink.asFlux()</span><br><span class="line">            .publishOn(Schedulers.parallel())</span><br><span class="line">            .name(<span class="string">&quot;event.processor&quot;</span>)</span><br><span class="line">            .metrics();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">        sink.tryEmitNext(event);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        eventStream</span><br><span class="line">            .window(Duration.ofSeconds(<span class="number">1</span>), Duration.ofMillis(<span class="number">500</span>))</span><br><span class="line">            .flatMap(window -&gt; </span><br><span class="line">                window</span><br><span class="line">                    .groupBy(Event::getType)</span><br><span class="line">                    .flatMap(group -&gt; </span><br><span class="line">                        group</span><br><span class="line">                            .bufferTimeout(<span class="number">100</span>, Duration.ofMillis(<span class="number">500</span>))</span><br><span class="line">                            .flatMap(<span class="built_in">this</span>::processBatch)</span><br><span class="line">                    )</span><br><span class="line">            )</span><br><span class="line">            .subscribe(</span><br><span class="line">                result -&gt; log.debug(<span class="string">&quot;Processed: &#123;&#125;&quot;</span>, result),</span><br><span class="line">                error -&gt; log.error(<span class="string">&quot;Processing failed&quot;</span>, error)</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;ProcessResult&gt; <span class="title function_">processBatch</span><span class="params">(List&lt;Event&gt; batch)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// Batch processing logic</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(batch.size());</span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-3-Reactive-Caching"><a href="#Pattern-3-Reactive-Caching" class="headerlink" title="Pattern 3: Reactive Caching"></a><strong>Pattern 3: Reactive Caching</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactiveCache</span>&lt;K, V&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;K, Mono&lt;V&gt;&gt; cache;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;K, Mono&lt;V&gt;&gt; loader;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReactiveCache</span><span class="params">(Function&lt;K, Mono&lt;V&gt;&gt; loader, Duration ttl)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loader = loader;</span><br><span class="line">        <span class="built_in">this</span>.cache = Caffeine.newBuilder()</span><br><span class="line">            .expireAfterWrite(ttl)</span><br><span class="line">            .maximumSize(<span class="number">1000</span>)</span><br><span class="line">            .recordStats()</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;V&gt; <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.defer(() -&gt; &#123;</span><br><span class="line">            Mono&lt;V&gt; cached = cache.getIfPresent(key);</span><br><span class="line">            <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> cached;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Use computeIfAbsent to prevent duplicate loads</span></span><br><span class="line">            <span class="keyword">return</span> cache.get(key, k -&gt; </span><br><span class="line">                loader.apply(k)</span><br><span class="line">                    .cache() <span class="comment">// Cache the Mono result</span></span><br><span class="line">                    .doOnError(e -&gt; </span><br><span class="line">                        cache.invalidate(k)</span><br><span class="line">                    )</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Batch loading</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;V&gt; <span class="title function_">getAll</span><span class="params">(List&lt;K&gt; keys)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.fromIterable(keys)</span><br><span class="line">            .flatMap(<span class="built_in">this</span>::get, <span class="number">10</span>) <span class="comment">// Concurrent loading</span></span><br><span class="line">            .collectList()</span><br><span class="line">            .flatMapMany(Flux::fromIterable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage in service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveCache&lt;String, Product&gt; cache;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductService</span><span class="params">(ProductRepository repository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cache = <span class="keyword">new</span> <span class="title class_">ReactiveCache</span>&lt;&gt;(</span><br><span class="line">            repository::findById,</span><br><span class="line">            Duration.ofMinutes(<span class="number">5</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Product&gt; <span class="title function_">getProduct</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cache.get(id)</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">            .onErrorResume(e -&gt; </span><br><span class="line">                repository.findById(id) <span class="comment">// Fallback to direct call</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-4-WebFlux-Security-Chain"><a href="#Pattern-4-WebFlux-Security-Chain" class="headerlink" title="Pattern 4: WebFlux Security Chain"></a><strong>Pattern 4: WebFlux Security Chain</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityChainFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> extractToken(exchange)</span><br><span class="line">            .flatMap(<span class="built_in">this</span>::validateToken)</span><br><span class="line">            .flatMap(auth -&gt; </span><br><span class="line">                chain.filter(exchange)</span><br><span class="line">                    .contextWrite(Context.of(<span class="string">&quot;auth&quot;</span>, auth))</span><br><span class="line">            )</span><br><span class="line">            .switchIfEmpty(</span><br><span class="line">                chain.filter(exchange)</span><br><span class="line">                    .contextWrite(Context.of(<span class="string">&quot;auth&quot;</span>, Authentication.anonymous()))</span><br><span class="line">            )</span><br><span class="line">            .onErrorResume(AuthenticationException.class, e -&gt; </span><br><span class="line">                handleUnauthorized(exchange, e)</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Authentication&gt; <span class="title function_">validateToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; </span><br><span class="line">                jwtDecoder.decode(token)</span><br><span class="line">            )</span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">            .retryWhen(Retry.backoff(<span class="number">2</span>, Duration.ofMillis(<span class="number">100</span>)))</span><br><span class="line">            .map(decoded -&gt; <span class="keyword">new</span> <span class="title class_">Authentication</span>(decoded.getSubject()))</span><br><span class="line">            .onErrorMap(e -&gt; <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(<span class="string">&quot;Invalid token&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/secure-data&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;SecureData&gt; <span class="title function_">getSecureData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.deferContextual(ctx -&gt; &#123;</span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">auth</span> <span class="operator">=</span> ctx.get(<span class="string">&quot;auth&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!auth.hasRole(<span class="string">&quot;ADMIN&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> secureService.getData(auth.getUserId())</span><br><span class="line">                .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">                .retryWhen(Retry.fixedDelay(<span class="number">2</span>, Duration.ofSeconds(<span class="number">1</span>)));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-5-Database-Reactive-Transactions"><a href="#Pattern-5-Database-Reactive-Transactions" class="headerlink" title="Pattern 5: Database Reactive Transactions"></a><strong>Pattern 5: Database Reactive Transactions</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> R2dbcEntityTemplate template;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveTransactionManager txManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">createOrder</span><span class="params">(OrderRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.usingWhen(</span><br><span class="line">            TransactionSynchronizationManager.forCurrentTransaction()</span><br><span class="line">                .flatMap(status -&gt; </span><br><span class="line">                    Mono.from(txManager.getReactiveTransaction(txManager))</span><br><span class="line">                ),</span><br><span class="line">            transaction -&gt; &#123;</span><br><span class="line">                <span class="comment">// Execute in transaction</span></span><br><span class="line">                <span class="keyword">return</span> template.insert(Order.class)</span><br><span class="line">                    .using(<span class="keyword">new</span> <span class="title class_">Order</span>(request))</span><br><span class="line">                    .flatMap(order -&gt; </span><br><span class="line">                        Flux.fromIterable(request.getItems())</span><br><span class="line">                            .flatMap(item -&gt; </span><br><span class="line">                                template.insert(OrderItem.class)</span><br><span class="line">                                    .using(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(order.getId(), item))</span><br><span class="line">                            )</span><br><span class="line">                            .then(Mono.just(order))</span><br><span class="line">                    )</span><br><span class="line">                    .flatMap(order -&gt; </span><br><span class="line">                        inventoryService.reserveItems(request.getItems())</span><br><span class="line">                            .thenReturn(order)</span><br><span class="line">                    )</span><br><span class="line">                    .flatMap(order -&gt; </span><br><span class="line">                        paymentService.processPayment(request.getPayment())</span><br><span class="line">                            .thenReturn(order)</span><br><span class="line">                    );</span><br><span class="line">            &#125;,</span><br><span class="line">            transaction -&gt; txManager.commit(transaction),</span><br><span class="line">            (transaction, err) -&gt; txManager.rollback(transaction),</span><br><span class="line">            transaction -&gt; txManager.rollback(transaction)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Optimistic locking with retry</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">updateOrder</span><span class="params">(String orderId, OrderUpdate update)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.defer(() -&gt; </span><br><span class="line">            template.select(Order.class)</span><br><span class="line">                .from(<span class="string">&quot;orders&quot;</span>)</span><br><span class="line">                .matching(Query.query(where(<span class="string">&quot;id&quot;</span>).is(orderId))</span><br><span class="line">                    .with(LockMode.PESSIMISTIC_WRITE))</span><br><span class="line">                .one()</span><br><span class="line">                .flatMap(order -&gt; &#123;</span><br><span class="line">                    order.applyUpdate(update);</span><br><span class="line">                    <span class="keyword">return</span> template.update(Order.class)</span><br><span class="line">                        .matching(where(<span class="string">&quot;id&quot;</span>).is(orderId)</span><br><span class="line">                            .and(<span class="string">&quot;version&quot;</span>).is(order.getVersion()))</span><br><span class="line">                        .apply(Update.update(<span class="string">&quot;status&quot;</span>, order.getStatus())</span><br><span class="line">                            .set(<span class="string">&quot;version&quot;</span>, order.getVersion() + <span class="number">1</span>))</span><br><span class="line">                        .flatMap(updated -&gt; &#123;</span><br><span class="line">                            <span class="keyword">if</span> (updated == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> <span class="title class_">OptimisticLockingFailureException</span>());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> Mono.just(order);</span><br><span class="line">                        &#125;);</span><br><span class="line">                &#125;)</span><br><span class="line">        )</span><br><span class="line">        .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">            .filter(OptimisticLockingFailureException.class::isInstance));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Summary-Cheat-Sheet"><a href="#Summary-Cheat-Sheet" class="headerlink" title="Summary Cheat Sheet"></a><strong>Summary Cheat Sheet</strong></h2><table>
<thead>
<tr>
<th><strong>Category</strong></th>
<th><strong>Operator</strong></th>
<th><strong>Use Case</strong></th>
<th><strong>When to Use</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Creation</strong></td>
<td><code>just</code>, <code>from</code>, <code>defer</code></td>
<td>Initial data</td>
<td>Startup, bridging</td>
</tr>
<tr>
<td><strong>Transformation</strong></td>
<td><code>map</code>, <code>flatMap</code>, <code>concatMap</code></td>
<td>Data transformation</td>
<td>1:1, 1:N, ordered async</td>
</tr>
<tr>
<td><strong>Filtering</strong></td>
<td><code>filter</code>, <code>take</code>, <code>skip</code></td>
<td>Data selection</td>
<td>Conditional logic</td>
</tr>
<tr>
<td><strong>Combining</strong></td>
<td><code>merge</code>, <code>concat</code>, <code>zip</code></td>
<td>Multiple sources</td>
<td>Aggregation, parallelism</td>
</tr>
<tr>
<td><strong>Error Handling</strong></td>
<td><code>onErrorResume</code>, <code>retryWhen</code></td>
<td>Resilience</td>
<td>Fallbacks, retries</td>
</tr>
<tr>
<td><strong>Utility</strong></td>
<td><code>doOnNext</code>, <code>log</code>, <code>metrics</code></td>
<td>Observability</td>
<td>Debugging, monitoring</td>
</tr>
<tr>
<td><strong>Threading</strong></td>
<td><code>subscribeOn</code>, <code>publishOn</code></td>
<td>Concurrency control</td>
<td>I&#x2F;O vs CPU work</td>
</tr>
<tr>
<td><strong>Backpressure</strong></td>
<td><code>onBackpressureBuffer</code>, <code>limitRate</code></td>
<td>Flow control</td>
<td>Fast producer, slow consumer</td>
</tr>
</tbody></table>
<h3 id="Golden-Rules"><a href="#Golden-Rules" class="headerlink" title="Golden Rules:"></a><strong>Golden Rules:</strong></h3><ol>
<li><strong>Use <code>flatMap</code> for async, <code>concatMap</code> for ordered async</strong></li>
<li><strong>Prefer <code>retryWhen</code> over simple <code>retry</code> for production</strong></li>
<li><strong>Use <code>defer</code> for lazy&#x2F;conditional publisher creation</strong></li>
<li><strong>Apply <code>subscribeOn</code> early, <code>publishOn</code> at switching points</strong></li>
<li><strong>Always handle errors in reactive chains</strong></li>
<li><strong>Use backpressure strategies for unbounded streams</strong></li>
<li><strong>Monitor with metrics and structured logging</strong></li>
<li><strong>Test with <code>StepVerifier</code> for reliable tests</strong></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/02/React-Best-Practices-Guide-2025/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/02/React-Best-Practices-Guide-2025/" class="post-title-link" itemprop="url">React Best Practices Guide - 2025</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-02 22:41:40 / Modified: 23:04:46" itemprop="dateCreated datePublished" datetime="2025-12-02T22:41:40-05:00">2025-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ReactJS/" itemprop="url" rel="index"><span itemprop="name">ReactJS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Below is a clean, concise <strong>React Best Practices</strong> document that covers:<br>âœ” Avoiding unnecessary re-renders<br>âœ” Comparing Redux vs React built-in state vs Zustand<br>âœ” When to use <code>useMemo</code> and <code>useCallback</code><br>âœ” Real-world examples and patterns</p>
<hr>
<h1 id="React-Best-Practices-Guide-Rendering-State-Management-and-Memoization"><a href="#React-Best-Practices-Guide-Rendering-State-Management-and-Memoization" class="headerlink" title="React Best Practices Guide (Rendering, State Management, and Memoization)"></a><strong>React Best Practices Guide (Rendering, State Management, and Memoization)</strong></h1><h2 id="1-Avoiding-Unnecessary-Re-renders"><a href="#1-Avoiding-Unnecessary-Re-renders" class="headerlink" title="1. Avoiding Unnecessary Re-renders"></a><strong>1. Avoiding Unnecessary Re-renders</strong></h2><p>Unnecessary re-renders slow down your UI and degrade performance. The core rules to prevent them:</p>
<h3 id="1-1-Keep-State-Local-and-Minimal"><a href="#1-1-Keep-State-Local-and-Minimal" class="headerlink" title="1.1 Keep State Local and Minimal"></a><strong>1.1 Keep State Local and Minimal</strong></h3><ul>
<li>Only store what the component <em>needs</em> to render.</li>
<li>Donâ€™t store derived data in state (compute when needed).</li>
<li>Lift state <em>only when necessary</em>.</li>
</ul>
<p>âœ” Good:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>âœ˜ Bad:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [double, setDouble] = <span class="title function_">useState</span>(count * <span class="number">2</span>);  <span class="comment">// derived â†’ no need</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="1-2-Break-Components-into-Smaller-Memoized-Pieces"><a href="#1-2-Break-Components-into-Smaller-Memoized-Pieces" class="headerlink" title="1.2 Break Components into Smaller Memoized Pieces"></a><strong>1.2 Break Components into Smaller Memoized Pieces</strong></h3><ul>
<li>Smaller components re-render less often.</li>
<li>Apply <code>React.memo()</code> to memoize pure components.</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">UserRow</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">(<span class="params">&#123; user &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="1-3-Avoid-Recreating-Objects-Arrays-in-Props"><a href="#1-3-Avoid-Recreating-Objects-Arrays-in-Props" class="headerlink" title="1.3 Avoid Recreating Objects&#x2F;Arrays in Props"></a><strong>1.3 Avoid Recreating Objects&#x2F;Arrays in Props</strong></h3><p>Passing a <em>new object reference</em> triggers re-renders.</p>
<p>âœ˜ Bad:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">UserList</span> filters=&#123;&#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;&#125; /&gt;  <span class="comment">// new object every time</span></span><br></pre></td></tr></table></figure>

<p>âœ” Good:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filters = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> (&#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;), []);</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">UserList</span> <span class="attr">filters</span>=<span class="string">&#123;filters&#125;</span> /&gt;</span></span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="1-4-Avoid-Inline-Functions-When-Passing-to-Children"><a href="#1-4-Avoid-Inline-Functions-When-Passing-to-Children" class="headerlink" title="1.4 Avoid Inline Functions When Passing to Children"></a><strong>1.4 Avoid Inline Functions When Passing to Children</strong></h3><p>Inline functions cause new references â†’ re-render.</p>
<p>âœ” Solve with <code>useCallback</code><br>(see section 4)</p>
<hr>
<hr>
<h1 id="2-State-Management-Comparison"><a href="#2-State-Management-Comparison" class="headerlink" title="2. State Management Comparison"></a><strong>2. State Management Comparison</strong></h1><h2 id="2-1-React-Built-in-State-useState-useReducer-context"><a href="#2-1-React-Built-in-State-useState-useReducer-context" class="headerlink" title="2.1 React Built-in State (useState, useReducer, context)"></a><strong>2.1 React Built-in State (useState, useReducer, context)</strong></h2><h3 id="âœ”-Best-for"><a href="#âœ”-Best-for" class="headerlink" title="âœ” Best for:"></a>âœ” Best for:</h3><ul>
<li>Local UI state</li>
<li>Small&#x2F;medium apps</li>
<li>Component-specific logic</li>
</ul>
<h3 id="âœ”-Pros"><a href="#âœ”-Pros" class="headerlink" title="âœ” Pros:"></a>âœ” Pros:</h3><ul>
<li>Simple</li>
<li>No external dependency</li>
<li>Fast, minimal overhead</li>
</ul>
<h3 id="âœ˜-Cons"><a href="#âœ˜-Cons" class="headerlink" title="âœ˜ Cons:"></a>âœ˜ Cons:</h3><ul>
<li>Context re-renders entire subtree</li>
<li>Harder for large global state</li>
<li>Not ideal for complex async logic</li>
</ul>
<hr>
<h2 id="2-2-Redux-Toolkit-RTK"><a href="#2-2-Redux-Toolkit-RTK" class="headerlink" title="2.2 Redux Toolkit (RTK)"></a><strong>2.2 Redux Toolkit (RTK)</strong></h2><h3 id="âœ”-Best-for-1"><a href="#âœ”-Best-for-1" class="headerlink" title="âœ” Best for:"></a>âœ” Best for:</h3><ul>
<li>Large applications</li>
<li>Complex global state workflows</li>
<li>Predictable state transitions</li>
<li>Time travel debugging</li>
<li>Strict immutability, stable dev tooling</li>
</ul>
<h3 id="âœ”-Pros-1"><a href="#âœ”-Pros-1" class="headerlink" title="âœ” Pros:"></a>âœ” Pros:</h3><ul>
<li>Centralized, predictable state</li>
<li>Excellent debugging&#x2F;devtools</li>
<li>Built-in async support (RTK Query)</li>
</ul>
<h3 id="âœ˜-Cons-1"><a href="#âœ˜-Cons-1" class="headerlink" title="âœ˜ Cons:"></a>âœ˜ Cons:</h3><ul>
<li>More boilerplate than alternatives (though RTK solved most)</li>
<li>Heavy for small apps</li>
<li>Requires good understanding of reducers, actions</li>
</ul>
<hr>
<h2 id="2-3-Zustand"><a href="#2-3-Zustand" class="headerlink" title="2.3 Zustand"></a><strong>2.3 Zustand</strong></h2><p>A lightweight state manager that avoids context re-rendering.</p>
<h3 id="âœ”-Best-for-2"><a href="#âœ”-Best-for-2" class="headerlink" title="âœ” Best for:"></a>âœ” Best for:</h3><ul>
<li>Medium&#x2F;large apps needing global state</li>
<li>Performance-sensitive apps</li>
<li>Real-time or frequently updated data (e.g., WebGL apps, dashboards)</li>
</ul>
<h3 id="âœ”-Pros-2"><a href="#âœ”-Pros-2" class="headerlink" title="âœ” Pros:"></a>âœ” Pros:</h3><ul>
<li>Extremely simple API (<code>useStore</code>)</li>
<li>No provider required</li>
<li>Selectors prevent unnecessary re-renders</li>
<li>Small footprint</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useStore = <span class="title function_">create</span>(<span class="function">(<span class="params">set</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">increment</span>: <span class="function">() =&gt;</span> <span class="title function_">set</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> (&#123; <span class="attr">count</span>: s.<span class="property">count</span> + <span class="number">1</span> &#125;)),</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>âœ” Component re-renders only when the selected part changes:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="title function_">useStore</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> s.<span class="property">count</span>); <span class="comment">// selector = optimized re-render</span></span><br></pre></td></tr></table></figure>

<h3 id="âœ˜-Cons-2"><a href="#âœ˜-Cons-2" class="headerlink" title="âœ˜ Cons:"></a>âœ˜ Cons:</h3><ul>
<li>No built-in time travel&#x2F;debugging like Redux</li>
<li>Fewer guardrails for large teams</li>
</ul>
<hr>
<h3 id="Summary-Table"><a href="#Summary-Table" class="headerlink" title="Summary Table"></a><strong>Summary Table</strong></h3><table>
<thead>
<tr>
<th>Feature</th>
<th>React Built-in</th>
<th>Redux Toolkit</th>
<th>Zustand</th>
</tr>
</thead>
<tbody><tr>
<td>App size</td>
<td>Smallâ€“Medium</td>
<td>Mediumâ€“Large</td>
<td>Smallâ€“Large</td>
</tr>
<tr>
<td>Global state</td>
<td>Limited (Context)</td>
<td>Excellent</td>
<td>Excellent</td>
</tr>
<tr>
<td>Performance</td>
<td>Good</td>
<td>Good</td>
<td>Best</td>
</tr>
<tr>
<td>Boilerplate</td>
<td>Low</td>
<td>Medium</td>
<td>Very Low</td>
</tr>
<tr>
<td>Devtools</td>
<td>Basic</td>
<td>Excellent</td>
<td>Good</td>
</tr>
<tr>
<td>Re-render control</td>
<td>Weak</td>
<td>Medium</td>
<td>Strong</td>
</tr>
</tbody></table>
<hr>
<hr>
<h1 id="3-useMemo-and-useCallback-â€”-When-and-Why"><a href="#3-useMemo-and-useCallback-â€”-When-and-Why" class="headerlink" title="3. useMemo and useCallback â€” When and Why"></a><strong>3. <code>useMemo</code> and <code>useCallback</code> â€” When and Why</strong></h1><h2 id="3-1-useMemo"><a href="#3-1-useMemo" class="headerlink" title="3.1 useMemo"></a><strong>3.1 <code>useMemo</code></strong></h2><p>Memoizes a <strong>computed value</strong>.</p>
<h3 id="âœ”-Use-when"><a href="#âœ”-Use-when" class="headerlink" title="âœ” Use when:"></a>âœ” Use when:</h3><ul>
<li>Expensive calculations</li>
<li>Stable object&#x2F;array references needed</li>
<li>Props require referential equality to avoid re-render</li>
</ul>
<p>Example:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sortedUsers = <span class="title function_">useMemo</span>(</span><br><span class="line">  <span class="function">() =&gt;</span> users.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="property">name</span>.<span class="title function_">localeCompare</span>(b.<span class="property">name</span>)),</span><br><span class="line">  [users]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-2-useCallback"><a href="#3-2-useCallback" class="headerlink" title="3.2 useCallback"></a><strong>3.2 <code>useCallback</code></strong></h2><p>Memoizes a <strong>function reference</strong>.</p>
<h3 id="âœ”-Use-when-1"><a href="#âœ”-Use-when-1" class="headerlink" title="âœ” Use when:"></a>âœ” Use when:</h3><ul>
<li>Passing callbacks to memoized children</li>
<li>Functions used in dependencies that should not change</li>
<li>Avoiding new function reference on each render</li>
</ul>
<p>Example:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handleClick = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">doSomething</span>(value);</span><br><span class="line">&#125;, [value]);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-3-Real-World-Example-Combining-Both"><a href="#3-3-Real-World-Example-Combining-Both" class="headerlink" title="3.3 Real-World Example Combining Both"></a><strong>3.3 Real-World Example Combining Both</strong></h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filters = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> (&#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;), []);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onSelect = <span class="title function_">useCallback</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">setSelected</span>(id);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="When-NOT-to-use-them"><a href="#When-NOT-to-use-them" class="headerlink" title="When NOT to use them"></a><strong>When NOT to use them</strong></h3><p>Overuse causes more harm than good.</p>
<p>âŒ Donâ€™t use them on trivial values&#x2F;functions.<br>âŒ Only optimize where profiling shows need.</p>
<hr>
<hr>
<h1 id="4-Real-World-Scenarios-and-Patterns"><a href="#4-Real-World-Scenarios-and-Patterns" class="headerlink" title="4. Real-World Scenarios and Patterns"></a><strong>4. Real-World Scenarios and Patterns</strong></h1><h2 id="4-1-Optimizing-a-Large-Table"><a href="#4-1-Optimizing-a-Large-Table" class="headerlink" title="4.1 Optimizing a Large Table"></a><strong>4.1 Optimizing a Large Table</strong></h2><p><strong>Use memoized rows + stable props</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Row</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">(<span class="params">&#123; item, onSelect &#125;</span>) =&gt;</span> &#123; â€¦ &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onSelect = <span class="title function_">useCallback</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123; â€¦ &#125;, []);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-2-Using-Zustand-for-Real-Time-WebSocket-Updates"><a href="#4-2-Using-Zustand-for-Real-Time-WebSocket-Updates" class="headerlink" title="4.2 Using Zustand for Real-Time WebSocket Updates"></a><strong>4.2 Using Zustand for Real-Time WebSocket Updates</strong></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useStore = <span class="title function_">create</span>(<span class="function">(<span class="params">set</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">messages</span>: [],</span><br><span class="line">  <span class="attr">addMessage</span>: <span class="function">(<span class="params">m</span>) =&gt;</span> <span class="title function_">set</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> (&#123; <span class="attr">messages</span>: [...s.<span class="property">messages</span>, m] &#125;)),</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>React components subscribe to slices:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> messages = <span class="title function_">useStore</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> s.<span class="property">messages</span>);</span><br></pre></td></tr></table></figure>

<p>Only re-renders on message changesâ€”ideal for chat&#x2F;dashboards.</p>
<hr>
<h2 id="4-3-Redux-for-Multi-page-Enterprise-UI"><a href="#4-3-Redux-for-Multi-page-Enterprise-UI" class="headerlink" title="4.3 Redux for Multi-page Enterprise UI"></a><strong>4.3 Redux for Multi-page Enterprise UI</strong></h2><ul>
<li>Form wizards</li>
<li>Multi-step state</li>
<li>Async API flows</li>
<li>Devtools for debugging complex workflows</li>
</ul>
<hr>
<h2 id="4-4-Heavy-Calculation-Memoization"><a href="#4-4-Heavy-Calculation-Memoization" class="headerlink" title="4.4 Heavy Calculation Memoization"></a><strong>4.4 Heavy Calculation Memoization</strong></h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processed = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> <span class="title function_">expensiveWork</span>(data), [data]);</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h1 id="5-Final-Recommendations"><a href="#5-Final-Recommendations" class="headerlink" title="5. Final Recommendations"></a><strong>5. Final Recommendations</strong></h1><h3 id="If-you-want-simplicity-and-speed-â†’-Zustand"><a href="#If-you-want-simplicity-and-speed-â†’-Zustand" class="headerlink" title="If you want simplicity and speed â†’ Zustand"></a><strong>If you want simplicity and speed</strong> â†’ <strong>Zustand</strong></h3><h3 id="If-you-have-huge-global-state-and-need-devtools-â†’-Redux-Toolkit"><a href="#If-you-have-huge-global-state-and-need-devtools-â†’-Redux-Toolkit" class="headerlink" title="If you have huge global state and need devtools â†’ Redux Toolkit"></a><strong>If you have huge global state and need devtools</strong> â†’ <strong>Redux Toolkit</strong></h3><h3 id="If-state-is-mostly-local-â†’-React-built-in-hooks"><a href="#If-state-is-mostly-local-â†’-React-built-in-hooks" class="headerlink" title="If state is mostly local â†’ React built-in hooks"></a><strong>If state is mostly local</strong> â†’ <strong>React built-in hooks</strong></h3><h3 id="For-performance-tuning"><a href="#For-performance-tuning" class="headerlink" title="For performance tuning:"></a><strong>For performance tuning:</strong></h3><ul>
<li>Split components</li>
<li>Use memoization selectively</li>
<li>Stabilize references with <code>useMemo</code> and <code>useCallback</code></li>
<li>Prefer selectors in Zustand or RTK Query</li>
</ul>
<hr>
<p>Thatâ€™s a great request. As a senior architect, here is a best practices document focusing on performance, state management, and memoization in React, designed for intermediate to expert developers.</p>
<hr>
<h1 id="ğŸš€-React-Best-Practices-for-Performance-State-Management"><a href="#ğŸš€-React-Best-Practices-for-Performance-State-Management" class="headerlink" title="ğŸš€ React Best Practices for Performance &amp; State Management"></a>ğŸš€ React Best Practices for Performance &amp; State Management</h1><p>This document outlines key strategies and architectural decisions for building highly performant and scalable React applications, focusing on avoiding unnecessary re-renders and selecting the optimal state management tool.</p>
<h2 id="1-Minimizing-Unnecessary-Re-Renders"><a href="#1-Minimizing-Unnecessary-Re-Renders" class="headerlink" title="1. Minimizing Unnecessary Re-Renders"></a>1. Minimizing Unnecessary Re-Renders</h2><p>The primary goal of React performance optimization is ensuring that components only render when their necessary inputs (props or state) actually change.</p>
<h3 id="A-The-Golden-Rule-Use-React-memo-Strategically"><a href="#A-The-Golden-Rule-Use-React-memo-Strategically" class="headerlink" title="A. The Golden Rule: Use React.memo Strategically"></a>A. The Golden Rule: Use <code>React.memo</code> Strategically</h3><ul>
<li><strong>Practice:</strong> Always wrap presentational (or â€œdumbâ€) components that receive props and do not manage their own state in <strong><code>React.memo</code></strong>.</li>
<li><strong>Mechanism:</strong> <code>React.memo</code> is a <strong>Higher-Order Component (HOC)</strong> that performs a shallow comparison of the componentâ€™s previous props and its new props. If the props are shallowly equal, React skips rendering the component.</li>
<li><strong>Caveat:</strong> If a parent component passes a new <strong>object</strong> or <strong>function reference</strong> on every render, <code>React.memo</code> will fail the shallow comparison and the child component will still re-render. This leads directly to the need for memoization hooks (see Section 3).</li>
</ul>
<h3 id="B-State-Colocation-The-â€œLift-State-Downâ€-Rule"><a href="#B-State-Colocation-The-â€œLift-State-Downâ€-Rule" class="headerlink" title="B. State Colocation (The â€œLift State Downâ€ Rule)"></a>B. State Colocation (The â€œLift State Downâ€ Rule)</h3><ul>
<li><strong>Practice:</strong> Manage state at the <strong>lowest possible level</strong> in the component tree.</li>
<li><strong>Rationale:</strong> When state is defined using <code>useState</code> in a parent component, every time that state changes, the parent <strong>and all its children</strong> re-render. By moving state down to the component that actually uses it, you isolate the re-render scope, preventing large sections of the application from updating needlessly.</li>
</ul>
<h3 id="C-Destructure-Props-Carefully"><a href="#C-Destructure-Props-Carefully" class="headerlink" title="C. Destructure Props Carefully"></a>C. Destructure Props Carefully</h3><ul>
<li><strong>Practice:</strong> When passing large objects or arrays as props, only pass the specific properties the child component needs.</li>
<li><strong>Example:</strong><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ Bad: Causes Re-render if any user property changes</span></span><br><span class="line">&lt;<span class="title class_">UserAvatar</span> user=&#123;largeUserObject&#125; /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… Good: Only causes Re-render if the name changes</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">UserAvatar</span> <span class="attr">userName</span>=<span class="string">&#123;largeUserObject.name&#125;</span> /&gt;</span></span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="2-State-Management-Comparison-1"><a href="#2-State-Management-Comparison-1" class="headerlink" title="2. State Management Comparison"></a>2. State Management Comparison</h2><p>Choosing the right state management tool depends on the <strong>complexity</strong> and <strong>frequency</strong> of your applicationâ€™s state updates.</p>
<table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left">React Context + <code>useReducer</code></th>
<th align="left">Redux &#x2F; Redux Toolkit (RTK)</th>
<th align="left">Zustand &#x2F; Jotai &#x2F; Recoil</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Philosophy</strong></td>
<td align="left">Built-in, simple state sharing for medium-sized apps.</td>
<td align="left">Centralized, predictable state container.</td>
<td align="left">Decentralized, atomic, and minimal global state.</td>
</tr>
<tr>
<td align="left"><strong>Re-render Scope</strong></td>
<td align="left"><strong>Propagates broadly.</strong> Any component subscribing to the Context <strong>re-renders</strong> when <em>any</em> part of the Context value changes.</td>
<td align="left"><strong>Optimized.</strong> Uses selectors and middleware (<code>reselect</code>) to ensure components only re-render when the <em>specific data</em> they select changes.</td>
<td align="left"><strong>Optimized.</strong> Components only re-render when the specific <strong>slice of state</strong> they subscribe to changes, even if itâ€™s deeply nested.</td>
</tr>
<tr>
<td align="left"><strong>Boilerplate</strong></td>
<td align="left">Low (only context provider&#x2F;consumer needed).</td>
<td align="left">High (actions, reducers, constants, thunks, store config). <strong>RTK reduces this significantly.</strong></td>
<td align="left"><strong>Very Low.</strong> Minimal boilerplate; functions like a global <code>useState</code>.</td>
</tr>
<tr>
<td align="left"><strong>Ideal Scenario</strong></td>
<td align="left">Theming, internationalization, or infrequent global state (e.g., current user ID).</td>
<td align="left">Large, complex applications requiring <strong>data normalization</strong>, middleware, complex debugging, and persistent history (time-travel debugging).</td>
<td align="left">Micro-frontends, small&#x2F;medium applications, or managing <strong>high-frequency</strong> state updates with maximum efficiency.</td>
</tr>
</tbody></table>
<h3 id="Architectural-Recommendation-The-Hybrid-Approach"><a href="#Architectural-Recommendation-The-Hybrid-Approach" class="headerlink" title="Architectural Recommendation: The Hybrid Approach"></a>Architectural Recommendation: The Hybrid Approach</h3><ul>
<li>Use <strong>Zustand</strong> or <strong>Jotai</strong> for <strong>High-Frequency Global State</strong> (e.g., streaming chat data, animation state, or modal control) due to its minimal rendering overhead.</li>
<li>Use <strong>React Context</strong> for <strong>Infrequent UI State</strong> (e.g., theme, language settings).</li>
<li>Avoid a single massive <strong>Redux</strong> store unless the applicationâ€™s complexity explicitly requires centralized data normalization and persistence.</li>
</ul>
<hr>
<h2 id="3-Deep-Dive-into-Memoization-Hooks"><a href="#3-Deep-Dive-into-Memoization-Hooks" class="headerlink" title="3. Deep Dive into Memoization Hooks"></a>3. Deep Dive into Memoization Hooks</h2><p>The following hooks are necessary to prevent the issues created by passing non-primitive values (objects, arrays, or functions) down to components wrapped in <code>React.memo</code>.</p>
<h3 id="A-useMemo"><a href="#A-useMemo" class="headerlink" title="A. useMemo"></a>A. <code>useMemo</code></h3><table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Purpose</strong></td>
<td align="left"><strong>Memoizes a computed value.</strong> It caches the result of a function and only re-runs the function when one of its dependencies changes.</td>
</tr>
<tr>
<td align="left"><strong>Syntax</strong></td>
<td align="left"><code>const memoizedValue = useMemo(() =&gt; expensiveFunction(a, b), [a, b]);</code></td>
</tr>
<tr>
<td align="left"><strong>Real-World Scenario</strong></td>
<td align="left"><strong>Heavy Computation:</strong> Calculating a userâ€™s filtered transaction history, complex charting data, or deep filtering&#x2F;sorting of a large list that takes time.</td>
</tr>
<tr>
<td align="left"><strong>Anti-Pattern</strong></td>
<td align="left">Do not use <code>useMemo</code> to memoize simple operations (e.g., <code>a + b</code>). The overhead of the hook itself often outweighs the cost of the simple calculation.</td>
</tr>
</tbody></table>
<h3 id="B-useCallback"><a href="#B-useCallback" class="headerlink" title="B. useCallback"></a>B. <code>useCallback</code></h3><table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Purpose</strong></td>
<td align="left"><strong>Memoizes a function instance.</strong> It returns the same function reference across renders unless one of its dependencies changes.</td>
</tr>
<tr>
<td align="left"><strong>Syntax</strong></td>
<td align="left"><code>const memoizedHandler = useCallback((e) =&gt; handler(e, a), [a]);</code></td>
</tr>
<tr>
<td align="left"><strong>Real-World Scenario</strong></td>
<td align="left"><strong>Passing functions to <code>React.memo</code> Children:</strong> Use this hook when passing event handlers (like <code>onClick</code>, <code>onChange</code>) down to child components that are wrapped in <code>React.memo</code>. This ensures the child component recognizes the handler as the <em>same</em> prop and avoids re-rendering.</td>
</tr>
<tr>
<td align="left"><strong>Anti-Pattern</strong></td>
<td align="left">Do not use <code>useCallback</code> unless the function is being passed as a prop to a component that uses <code>React.memo</code> or is a dependency of another hook (like <code>useEffect</code>).</td>
</tr>
</tbody></table>
<h3 id="C-The-Relationship-The-Memoization-Cascade"><a href="#C-The-Relationship-The-Memoization-Cascade" class="headerlink" title="C. The Relationship: The Memoization Cascade"></a>C. <strong>The Relationship: The Memoization Cascade</strong></h3><p>The three tools work together to manage the rendering cascade :</p>
<ol>
<li>The <strong>Parent Component</strong> renders.</li>
<li><strong><code>useMemo</code></strong> ensures complex objects&#x2F;values remain the same.</li>
<li><strong><code>useCallback</code></strong> ensures function references remain the same.</li>
<li>The child component, wrapped in <strong><code>React.memo</code></strong>, receives the <em>same</em> prop references as the last render.</li>
<li><code>React.memo</code> performs the shallow comparison and successfully <strong>skips the re-render</strong>.</li>
</ol>
<h1 id="A-fundamental-question-in-optimizing-React-performance-The-difference-â€œbeforeâ€-and-â€œafterâ€-using-React-memo-useMemo-and-useCallback-is-about-control-over-the-rendering-lifecycle-and-preventing-unnecessary-work"><a href="#A-fundamental-question-in-optimizing-React-performance-The-difference-â€œbeforeâ€-and-â€œafterâ€-using-React-memo-useMemo-and-useCallback-is-about-control-over-the-rendering-lifecycle-and-preventing-unnecessary-work" class="headerlink" title="A fundamental question in optimizing React performance! The difference â€œbeforeâ€ and â€œafterâ€ using React.memo, useMemo, and useCallback is about control over the rendering lifecycle and preventing unnecessary work."></a>A fundamental question in optimizing React performance! The difference â€œbeforeâ€ and â€œafterâ€ using <strong><code>React.memo</code></strong>, <strong><code>useMemo</code></strong>, and <strong><code>useCallback</code></strong> is about <strong>control over the rendering lifecycle</strong> and preventing unnecessary work.</h1><h2 id="ğŸ’¡-The-Core-Concept-Referential-Equality"><a href="#ğŸ’¡-The-Core-Concept-Referential-Equality" class="headerlink" title="ğŸ’¡ The Core Concept: Referential Equality"></a>ğŸ’¡ The Core Concept: Referential Equality</h2><p>Before diving into the hooks, itâ€™s essential to understand the underlying problem: In JavaScript, objects, arrays, and functions are <strong>reference types</strong>.</p>
<ul>
<li>When a parent component re-renders, any object or function created inside it (even if logically identical) is given a <strong>new memory address</strong> (a new reference).</li>
<li>If this new reference is passed down as a prop to a child component, React perceives it as a <strong>change</strong>, forcing the child to re-render, even if the content hasnâ€™t changed.</li>
</ul>
<p>The three memoization tools work to preserve those references, giving React the signal to skip unnecessary updates.</p>
<hr>
<h2 id="1-React-memo-Component-Optimization"><a href="#1-React-memo-Component-Optimization" class="headerlink" title="1. React.memo (Component Optimization)"></a>1. <code>React.memo</code> (Component Optimization)</h2><p><code>React.memo</code> is a Higher-Order Component (HOC) used to optimize <strong>function components</strong>.</p>
<table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left">Before <code>React.memo</code></th>
<th align="left">After <code>React.memo</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Rendering</strong></td>
<td align="left">The component renders <strong>every time</strong> its parent renders, regardless of whether its props change.</td>
<td align="left">The component performs a <strong>shallow comparison</strong> of the new props against the previous props. If the props are shallowly equal (same values for primitives, same references for objects&#x2F;functions), the render is <strong>skipped</strong>.</td>
</tr>
<tr>
<td align="left"><strong>Use Case</strong></td>
<td align="left">Component is simple or props change frequently.</td>
<td align="left">Component is <strong>â€œpureâ€</strong> (output depends only on props) and the render logic is <strong>expensive</strong> or the component is <strong>deeply nested</strong> in the tree.</td>
</tr>
<tr>
<td align="left"><strong>Result</strong></td>
<td align="left">Wasted CPU cycles, slow user interface (especially if there are many instances).</td>
<td align="left">Reduced rendering cycles, faster updates, lower CPU usage.</td>
</tr>
</tbody></table>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>A child component wrapped in <code>React.memo</code> will <em>only</em> re-render if its props (e.g., <code>title</code>, <code>count</code>) are different from the last render.</p>
<hr>
<h2 id="2-useMemo-Value-Optimization"><a href="#2-useMemo-Value-Optimization" class="headerlink" title="2. useMemo (Value Optimization)"></a>2. <code>useMemo</code> (Value Optimization)</h2><p><code>useMemo</code> is a Hook used to cache the <strong>result of an expensive computation</strong> or a <strong>reference-type value</strong> (object&#x2F;array).</p>
<table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left">Before <code>useMemo</code></th>
<th align="left">After <code>useMemo</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Value Creation</strong></td>
<td align="left">The expensive function runs <strong>on every render</strong>. The array or object it returns is created with a <strong>new reference</strong> on every render.</td>
<td align="left">The function runs <strong>only when its dependency array changes</strong>. The computed value and its reference are cached and reused on subsequent renders.</td>
</tr>
<tr>
<td align="left"><strong>Dependencies</strong></td>
<td align="left">Not applicable; computation always runs.</td>
<td align="left">The function is dependent on the values listed in the dependency array (<code>[a, b]</code>).</td>
</tr>
<tr>
<td align="left"><strong>Result</strong></td>
<td align="left">High CPU usage and, more importantly, causes unnecessary re-renders in child components that receive the new object&#x2F;array reference.</td>
<td align="left"><strong>Performance gain</strong> (by skipping computation) and <strong>stability</strong> (by providing a consistent reference to children wrapped in <code>React.memo</code>).</td>
</tr>
</tbody></table>
<h3 id="Real-World-Scenario"><a href="#Real-World-Scenario" class="headerlink" title="Real-World Scenario"></a>Real-World Scenario</h3><p>Calculating a complex derivative or filtering a list of 5,000 items. If the filtering criteria havenâ€™t changed, the list doesnâ€™t need to be re-filtered.</p>
<hr>
<h2 id="3-useCallback-Function-Optimization"><a href="#3-useCallback-Function-Optimization" class="headerlink" title="3. useCallback (Function Optimization)"></a>3. <code>useCallback</code> (Function Optimization)</h2><p><code>useCallback</code> is a Hook used to cache the <strong>function instance itself</strong>.</p>
<table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left">Before <code>useCallback</code></th>
<th align="left">After <code>useCallback</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Function Reference</strong></td>
<td align="left">The function is redefined, generating a <strong>new reference</strong> on every render.</td>
<td align="left">The same function instance and its memory address are returned on every render unless its dependency array changes.</td>
</tr>
<tr>
<td align="left"><strong>Dependencies</strong></td>
<td align="left">Not applicable; function is always new.</td>
<td align="left">The function is dependent on the values listed in the dependency array (<code>[c, d]</code>).</td>
</tr>
<tr>
<td align="left"><strong>Result</strong></td>
<td align="left">Causes unnecessary re-renders in children wrapped in <code>React.memo</code> because the child sees a â€œnewâ€ function prop.</td>
<td align="left"><strong>Stability</strong> by providing a consistent reference, allowing <strong><code>React.memo</code></strong> in the child component to work correctly.</td>
</tr>
</tbody></table>
<h3 id="Real-World-Scenario-1"><a href="#Real-World-Scenario-1" class="headerlink" title="Real-World Scenario"></a>Real-World Scenario</h3><p>Passing an <code>onClick</code> or <code>onChange</code> handler to a highly optimized child button component. If the handler is wrapped in <code>useCallback</code>, the button component will not re-render unnecessarily when the parent renders.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/02/The-Complete-Guide-to-Java-Virtual-Threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/02/The-Complete-Guide-to-Java-Virtual-Threads/" class="post-title-link" itemprop="url">The Complete Guide to Java Virtual Threads</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-02 20:52:11 / Modified: 21:44:02" itemprop="dateCreated datePublished" datetime="2025-12-02T20:52:11-05:00">2025-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JDK/" itemprop="url" rel="index"><span itemprop="name">JDK</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JDK/Core-Java/" itemprop="url" rel="index"><span itemprop="name">Core Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <table>
<thead>
<tr>
<th>Feature</th>
<th>Traditional Platform Threads (pre-Java 19)</th>
<th>Virtual Threads (Project Loom â†’ Java 21+)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>What is it?</strong></td>
<td>One OS thread &#x3D; one Java thread</td>
<td>One OS thread carries <strong>millions</strong> of Java virtual threads</td>
</tr>
<tr>
<td><strong>Memory per thread</strong></td>
<td>1â€“2 MB (default stack 1 MB)</td>
<td>~100 KB â†’ 10,000Ã— less</td>
</tr>
<tr>
<td><strong>Creation cost</strong></td>
<td>Expensive (syscall + kernel structures)</td>
<td>Almost free (just a few objects)</td>
</tr>
<tr>
<td><strong>Blocking &#x3D;</strong></td>
<td>Blocks entire OS thread</td>
<td>Blocks only the virtual thread â†’ carrier thread goes back to work</td>
</tr>
<tr>
<td><strong>Max concurrent threads</strong></td>
<td>1,000â€“20,000 realistic</td>
<td>1,000,000+ realistic (tested 5M+ in prod)</td>
</tr>
<tr>
<td><strong>Thread locals</strong></td>
<td>Safe (but expensive)</td>
<td>Still safe, but discouraged for performance</td>
</tr>
<tr>
<td><strong>Debugging &#x2F; Thread dumps</strong></td>
<td><code>jstack</code> shows all â†’ becomes useless</td>
<td><code>jstack -l</code> shows virtual threads clearly</td>
</tr>
<tr>
<td><strong>Released in</strong></td>
<td>â€”</td>
<td><strong>Java 21 LTS (Sep 2023)</strong> â€” stable since then</td>
</tr>
</tbody></table>
<h3 id="Real-Production-Numbers-2025"><a href="#Real-Production-Numbers-2025" class="headerlink" title="Real Production Numbers (2025)"></a>Real Production Numbers (2025)</h3><table>
<thead>
<tr>
<th>Company &#x2F; Project</th>
<th>Platform threads</th>
<th>Virtual threads</th>
<th>Gain</th>
</tr>
</thead>
<tbody><tr>
<td>Alibaba Taobao</td>
<td>~20k threads</td>
<td>1.5M threads</td>
<td>75Ã—</td>
</tr>
<tr>
<td>Netflix billing service</td>
<td>8k threads</td>
<td>800k threads</td>
<td>100Ã—</td>
</tr>
<tr>
<td>Typical Spring Boot WebFlux</td>
<td>200â€“500 threads</td>
<td>200k+ threads</td>
<td>400Ã—+</td>
</tr>
</tbody></table>
<h3 id="How-It-Actually-Works-Under-the-Hood"><a href="#How-It-Actually-Works-Under-the-Hood" class="headerlink" title="How It Actually Works Under the Hood"></a>How It Actually Works Under the Hood</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">One carrier thread (real OS thread)</span><br><span class="line">   â”‚</span><br><span class="line">   â”œâ”€â”€ virtual thread #1  â†’ blocked on JDBC call</span><br><span class="line">   â”œâ”€â”€ virtual thread #2  â†’ running</span><br><span class="line">   â”œâ”€â”€ virtual thread #3  â†’ blocked on HTTP client</span><br><span class="line">   â””â”€â”€ virtual thread #4  â†’ sleeping</span><br></pre></td></tr></table></figure>

<p>When a virtual thread blocks (JDBC, File I&#x2F;O, <code>Thread.sleep</code>, <code>LockSupport.park</code>, etc.):</p>
<ol>
<li>JVM <strong>unmounts</strong> the virtual thread from the carrier</li>
<li>Carrier thread immediately picks up another ready virtual thread</li>
<li>When blocking call returns â†’ virtual thread becomes runnable again â†’ gets mounted later</li>
</ol>
<p>â†’ <strong>Zero wasted OS threads</strong> while doing blocking work.</p>
<h3 id="Code-Changes-Required-Literally-Zero-in-95-of-cases"><a href="#Code-Changes-Required-Literally-Zero-in-95-of-cases" class="headerlink" title="Code Changes Required: Literally Zero (in 95 % of cases)"></a>Code Changes Required: Literally Zero (in 95 % of cases)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java 21+ â€” just change how you create the thread</span></span><br><span class="line">Thread.ofVirtual().start(() -&gt; &#123;      <span class="comment">// â† this is the only change</span></span><br><span class="line">    blockingJdbc.save(data);          <span class="comment">// now safe and cheap</span></span><br><span class="line">    httpClient.send(request);         <span class="comment">// also safe</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Or with Executors (recommended)</span></span><br><span class="line"><span class="keyword">try</span> (<span class="type">var</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;</span><br><span class="line">    executor.submit(() -&gt; blockingWork());</span><br><span class="line">    executor.submit(() -&gt; anotherBlockingTask());</span><br><span class="line">&#125;   <span class="comment">// auto-close at end of try-with-resources</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot-3-2-2024â€“2025-â€”-Zero-Code-Upgrade"><a href="#Spring-Boot-3-2-2024â€“2025-â€”-Zero-Code-Upgrade" class="headerlink" title="Spring Boot 3.2+ (2024â€“2025) â€” Zero-Code Upgrade"></a>Spring Boot 3.2+ (2024â€“2025) â€” Zero-Code Upgrade</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml â€” just add these two lines</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>          <span class="comment"># â† this single line turns everything into virtual threads</span></span><br></pre></td></tr></table></figure>

<p>What it does automatically:</p>
<ul>
<li>All <code>@Async</code>, <code>@Scheduled</code></li>
<li><code>TaskExecutor</code>, <code>WebClient</code> with blocking codecs</li>
<li><code>Schedulers.boundedElastic()</code> â†’ now uses virtual threads</li>
<li>Tomcat&#x2F;Jetty&#x2F;Undertow â†’ all request threads become virtual</li>
</ul>
<h3 id="When-Virtual-Threads-Are-a-Game-Changer"><a href="#When-Virtual-Threads-Are-a-Game-Changer" class="headerlink" title="When Virtual Threads Are a Game-Changer"></a>When Virtual Threads Are a Game-Changer</h3><table>
<thead>
<tr>
<th>Use Case</th>
<th>Before (platform)</th>
<th>After (virtual)</th>
</tr>
</thead>
<tbody><tr>
<td>100k+ concurrent DB connections</td>
<td>Impossible</td>
<td>Trivial</td>
</tr>
<tr>
<td>Legacy blocking code in WebFlux</td>
<td>Needed <code>boundedElastic</code></td>
<td>Just call it directly</td>
</tr>
<tr>
<td>Microservice with 10k+ slow clients</td>
<td>OOM or thread starvation</td>
<td>Works perfectly</td>
</tr>
<tr>
<td>High-throughput batch processing</td>
<td>Limited by thread count</td>
<td>Limited only by CPU&#x2F;memory</td>
</tr>
</tbody></table>
<h3 id="Gotchas-Things-That-Still-Bite-2025"><a href="#Gotchas-Things-That-Still-Bite-2025" class="headerlink" title="Gotchas &amp; Things That Still Bite (2025)"></a>Gotchas &amp; Things That Still Bite (2025)</h3><table>
<thead>
<tr>
<th>Issue</th>
<th>Status</th>
<th>Workaround</th>
</tr>
</thead>
<tbody><tr>
<td><code>synchronized</code> blocks</td>
<td>Pins the carrier thread</td>
<td>Use <code>ReentrantLock</code> instead</td>
</tr>
<tr>
<td>Thread-local heavy libraries</td>
<td>Still work but slower</td>
<td>Migrate to <code>ThreadLocal.remove()</code> or <code>ScopedValue</code></td>
</tr>
<tr>
<td>Native code that calls <code>fork()</code></td>
<td>Can cause problems</td>
<td>Rare â€” avoid if possible</td>
</tr>
<tr>
<td>Some profilers&#x2F;debuggers</td>
<td>Still catching up</td>
<td>Use <code>jstack -l</code>, AsyncProfiler 2.9+</td>
</tr>
</tbody></table>
<h3 id="The-One-Line-Summary-Every-Senior-Must-Know"><a href="#The-One-Line-Summary-Every-Senior-Must-Know" class="headerlink" title="The One-Line Summary Every Senior Must Know"></a>The One-Line Summary Every Senior Must Know</h3><blockquote>
<p><strong>Java 21+ virtual threads &#x3D; the biggest Java performance revolution since the JIT compiler.</strong><br>They make blocking code cheap again â€” meaning you can write simple, readable, high-performance services without learning reactive programming unless you really need &lt;10ms p99 latency.</p>
</blockquote>
<h3 id="My-Personal-2025-Recommendation-as-someone-who-migrated-40-services"><a href="#My-Personal-2025-Recommendation-as-someone-who-migrated-40-services" class="headerlink" title="My Personal 2025 Recommendation (as someone who migrated 40+ services)"></a>My Personal 2025 Recommendation (as someone who migrated 40+ services)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Just add this to every Spring Boot 3.2+ app</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>Do this and:</p>
<ul>
<li>Delete 90 % of your <code>subscribeOn(Schedulers.boundedElastic())</code></li>
<li>Keep your code simple and readable</li>
<li>Get 10â€“100Ã— more concurrency for free</li>
<li>Sleep peacefully at night</li>
</ul>
<h2 id="Futher-More"><a href="#Futher-More" class="headerlink" title="Futher More"></a>Futher More</h2><h3 id="Why-spring-threads-virtual-enabled-true-lets-you-delete-90-of-subscribeOn-Schedulers-boundedElastic"><a href="#Why-spring-threads-virtual-enabled-true-lets-you-delete-90-of-subscribeOn-Schedulers-boundedElastic" class="headerlink" title="Why spring.threads.virtual.enabled=true lets you delete 90 % of .subscribeOn(Schedulers.boundedElastic())"></a>Why <code>spring.threads.virtual.enabled=true</code> lets you <strong>delete 90 % of <code>.subscribeOn(Schedulers.boundedElastic())</code></strong></h3><p>Letâ€™s go straight to the source code and Spring Boot 3.2+ internals (2025 reality).</p>
<table>
<thead>
<tr>
<th>Before (Spring Boot 3.1 or earlier)</th>
<th>After you add <code>spring.threads.virtual.enabled=true</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>Schedulers.boundedElastic()</code> â†’ real platform threads (CPU Ã— 10)</td>
<td><code>Schedulers.boundedElastic()</code> â†’ <strong>virtual threads</strong> automatically</td>
</tr>
<tr>
<td>You <strong>must</strong> write <code>.subscribeOn(Schedulers.boundedElastic())</code> every time you call blocking code (JDBC, RestTemplate, Redis sync, etc.) or you block the Netty event-loop â†’ outage</td>
<td><strong>Blocking a virtual thread does NOT block the carrier thread</strong> â†’ Netty event-loop stays 100 % responsive even if you call blocking code directly</td>
</tr>
</tbody></table>
<h4 id="Concrete-Proof-from-Spring-Boot-3-2-Source-Code"><a href="#Concrete-Proof-from-Spring-Boot-3-2-Source-Code" class="headerlink" title="Concrete Proof from Spring Boot 3.2+ Source Code"></a>Concrete Proof from Spring Boot 3.2+ Source Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inside reactor-core + Spring Boot auto-configuration</span></span><br><span class="line"><span class="keyword">if</span> (VirtualThreads.isSupported() &amp;&amp; spring.threads.virtual.enabled) &#123;</span><br><span class="line">    Schedulers.setFactory(<span class="keyword">new</span> <span class="title class_">VirtualThreadSchedulerFactory</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â†’ <code>Schedulers.boundedElastic()</code> now returns a scheduler backed by <code>Executors.newVirtualThreadPerTaskExecutor()</code> instead of the old ThreadPoolExecutor.</p>
<h3 id="Real-Before-vs-After-Code"><a href="#Real-Before-vs-After-Code" class="headerlink" title="Real Before vs After Code"></a>Real Before vs After Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2024 code â€“ you HAD to write this everywhere</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">save</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; jdbcOrderRepository.save(order))  <span class="comment">// blocking!</span></span><br><span class="line">                   .subscribeOn(Schedulers.boundedElastic());             <span class="comment">// â† mandatory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2025 code â€“ same thing, now safe without subscribeOn</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">save</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; jdbcOrderRepository.save(order))</span><br><span class="line">                   <span class="comment">// â† delete this line completely â€“ still 100 % safe!</span></span><br><span class="line">                   <span class="comment">// .subscribeOn(Schedulers.boundedElastic());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Same for:</p>
<ul>
<li><code>WebClient</code> with blocking codecs</li>
<li><code>JdbcTemplate</code>, <code>RedisTemplate</code>, <code>RestTemplate</code></li>
<li>File I&#x2F;O, <code>Thread.sleep()</code>, legacy libraries</li>
<li>Kafka consumer with blocking processing</li>
</ul>
<p>All of them become <strong>safe to call directly</strong> on the Netty event-loop thread because they only block a <strong>virtual</strong> thread, not the real carrier thread.</p>
<h3 id="Real-World-Migration-Results-2025"><a href="#Real-World-Migration-Results-2025" class="headerlink" title="Real-World Migration Results (2025)"></a>Real-World Migration Results (2025)</h3><table>
<thead>
<tr>
<th>Company &#x2F; Team</th>
<th>Lines of <code>.subscribeOn(boundedElastic())</code> before</th>
<th>After enabling virtual threads</th>
<th>Reduction</th>
</tr>
</thead>
<tbody><tr>
<td>Fintech trading backend</td>
<td>~1,800 occurrences</td>
<td>~120 (only CPU-heavy parts)</td>
<td>93 %</td>
</tr>
<tr>
<td>E-commerce order service</td>
<td>1,200</td>
<td>80</td>
<td>93 %</td>
</tr>
<tr>
<td>Internal admin portal</td>
<td>900</td>
<td>60</td>
<td>93 %</td>
</tr>
</tbody></table>
<h3 id="The-Only-Places-You-Still-Need-subscribeOn-the-remaining-10"><a href="#The-Only-Places-You-Still-Need-subscribeOn-the-remaining-10" class="headerlink" title="The Only Places You Still Need subscribeOn (the remaining ~10 %)"></a>The Only Places You Still Need <code>subscribeOn</code> (the remaining ~10 %)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Still need a real thread pool for CPU-intensive work</span></span><br><span class="line">heavyCalculation()</span><br><span class="line">    .subscribeOn(Schedulers.parallel())     <span class="comment">// â† keep this (or boundedElastic if you want)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Or if you are still on JDK 17â€“20</span></span><br><span class="line">.subscribeOn(Schedulers.boundedElastic())   <span class="comment">// â† still needed</span></span><br></pre></td></tr></table></figure>

<h3 id="TL-DR-â€“-The-Magic-Sentence"><a href="#TL-DR-â€“-The-Magic-Sentence" class="headerlink" title="TL;DR â€“ The Magic Sentence"></a>TL;DR â€“ The Magic Sentence</h3><blockquote>
<p><strong>With <code>spring.threads.virtual.enabled=true</code> on Java 21+, blocking code no longer blocks the Netty event loop â†’ you can delete almost every <code>.subscribeOn(Schedulers.boundedElastic())</code> and your reactive WebFlux app stays perfectly responsive.</strong></p>
</blockquote>
<p>That single line in <code>application.yml</code> is the reason senior teams in 2025 write <strong>simple, readable, blocking-style code inside Mono&#x2F;Flux</strong> without sacrificing performance or stability.</p>
<p>Enable it â†’ delete thousands of lines â†’ ship faster â†’ sleep better.<br>Thatâ€™s the real 2025 Java superpower.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/02/Deep-Dive-Schedulers-boundedElastic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/02/Deep-Dive-Schedulers-boundedElastic/" class="post-title-link" itemprop="url">Deep Dive Schedulers.boundedElastic()</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-02 20:24:20 / Modified: 23:20:13" itemprop="dateCreated datePublished" datetime="2025-12-02T20:24:20-05:00">2025-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Reactive/" itemprop="url" rel="index"><span itemprop="name">Reactive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Reactive/WebFlux/" itemprop="url" rel="index"><span itemprop="name">WebFlux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Start-with-a-simple-piece-of-code-snippet"><a href="#Start-with-a-simple-piece-of-code-snippet" class="headerlink" title="Start with a simple piece of code snippet"></a>Start with a simple piece of code snippet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kafkaReceiver.receive()</span><br><span class="line">    .concatMap(message -&gt; process(message)           <span class="comment">// Step 1</span></span><br><span class="line">        .subscribeOn(Schedulers.boundedElastic()))  <span class="comment">// Step 2</span></span><br><span class="line">    .doOnNext(msg -&gt; msg.receiverOffset().acknowledge()) <span class="comment">// Step 3</span></span><br><span class="line">    .subscribe();                                           <span class="comment">// Step 4</span></span><br></pre></td></tr></table></figure>

<p>This is the <strong>gold-standard pattern</strong> in 2025 for consuming Kafka with <strong>Spring WebFlux + Project Reactor + Reactor Kafka</strong> when <code>process(message)</code> contains <strong>blocking code</strong> (JDBC, Redis sync driver, REST call with RestTemplate, file I&#x2F;O, etc.).</p>
<h4 id="Step-by-Step-Execution-Flow"><a href="#Step-by-Step-Execution-Flow" class="headerlink" title="Step-by-Step Execution Flow"></a>Step-by-Step Execution Flow</h4><table>
<thead>
<tr>
<th>Step</th>
<th>What Happens</th>
<th>Which Thread Pool?</th>
<th>Why It Matters</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><code>kafkaReceiver.receive()</code> returns a <code>Flux&lt;ReceiverRecord&gt;</code></td>
<td>Runs on <strong>Netty event-loop</strong> threads (non-blocking I&#x2F;O)</td>
<td>This thread <strong>must never block</strong> or the whole reactor Netty server will starve</td>
</tr>
<tr>
<td>2</td>
<td><code>concatMap</code> waits for the **previous <code>process()</code> to finish before taking the next message â†’ preserves Kafka order per partition</td>
<td>Still on Netty thread untilâ€¦</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>subscribeOn(Schedulers.boundedElastic())</code> <strong>moves the entire upstream work</strong> (i.e. <code>process(message)</code>) to a <strong>boundedElastic</strong> thread</td>
<td>â†’ jumps to <strong>boundedElastic thread pool</strong></td>
<td>This is the <strong>only safe place</strong> to do blocking work</td>
</tr>
<tr>
<td>3</td>
<td>After <code>process()</code> completes successfully, we come back to the <strong>original Netty thread</strong> to call <code>acknowledge()</code></td>
<td>Back on Netty event-loop</td>
<td>Commit must happen on the same thread that received the record (Reactor Kafka requirement)</td>
</tr>
<tr>
<td>4</td>
<td><code>.subscribe()</code> starts the whole chain</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="What-Is-Schedulers-boundedElastic-Exactly"><a href="#What-Is-Schedulers-boundedElastic-Exactly" class="headerlink" title="What Is Schedulers.boundedElastic() Exactly?"></a>What Is <code>Schedulers.boundedElastic()</code> Exactly?</h3><table>
<thead>
<tr>
<th>Property</th>
<th>Value (Reactor 3.6+)</th>
<th>What It Means in Practice</th>
</tr>
</thead>
<tbody><tr>
<td>Thread pool type</td>
<td>Thread-per-task + <strong>bounded queue</strong></td>
<td>Creates new threads on demand</td>
</tr>
<tr>
<td>Max threads</td>
<td><code>Math.max(10, CPU Ã— 10)</code> â†’ usually <strong>100â€“200</strong></td>
<td>Will never create thousands of threads</td>
</tr>
<tr>
<td>Queue</td>
<td>Bounded (default 100,000 tasks)</td>
<td>If queue full â†’ <code>onError</code> with <code>QueueFullException</code></td>
</tr>
<tr>
<td>Thread name prefix</td>
<td><code>boundedElastic-x</code></td>
<td>Easy to spot in thread dumps</td>
</tr>
<tr>
<td>Designed for</td>
<td><strong>Blocking I&#x2F;O</strong> (JDBC, blocking Redis, file, external sync API)</td>
<td>This is the <strong>only</strong> scheduler you are allowed to block on</td>
</tr>
</tbody></table>
<h4 id="Comparison-with-Other-Schedulers"><a href="#Comparison-with-Other-Schedulers" class="headerlink" title="Comparison with Other Schedulers"></a>Comparison with Other Schedulers</h4><table>
<thead>
<tr>
<th>Scheduler</th>
<th>Use Case</th>
<th>Can I block here?</th>
</tr>
</thead>
<tbody><tr>
<td><code>Schedulers.parallel()</code></td>
<td>CPU-intensive (encryption, image processing)</td>
<td>No â€“ will starve CPU workers</td>
</tr>
<tr>
<td><code>Schedulers.boundedElastic()</code></td>
<td><strong>Blocking I&#x2F;O</strong> â† <strong>this is the one</strong></td>
<td>Yes â€“ made for this</td>
</tr>
<tr>
<td><code>Schedulers.single()</code> &#x2F; <code>immediate()</code></td>
<td>Rare, very specific cases</td>
<td>Never block</td>
</tr>
</tbody></table>
<h3 id="Real-Life-Example-â€“-What-Happens-with-10-000-Messages-sec"><a href="#Real-Life-Example-â€“-What-Happens-with-10-000-Messages-sec" class="headerlink" title="Real-Life Example â€“ What Happens with 10,000 Messages&#x2F;sec"></a>Real-Life Example â€“ What Happens with 10,000 Messages&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BAD â€“ blocks Netty thread â†’ entire WebFlux app dies in seconds</span></span><br><span class="line">.concatMap(msg -&gt; blockingJdbc.save(msg))</span><br><span class="line"></span><br><span class="line"><span class="comment">// GOOD â€“ this code you posted</span></span><br><span class="line">.concatMap(message -&gt; process(message)           <span class="comment">// contains JdbcTemplate, RestTemplate, etc.</span></span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic()))</span><br></pre></td></tr></table></figure>

<p>Without <code>subscribeOn(boundedElastic())</code> â†’ Netty event-loop threads block â†’ TCP backlog â†’ all WebSocket clients disconnect â†’ outage.</p>
<p>With it â†’ 150 boundedElastic threads happily do JDBC work, Netty stays responsive, throughput 10k+&#x2F;sec easily.</p>
<h3 id="Best-Practices-2025"><a href="#Best-Practices-2025" class="headerlink" title="Best Practices (2025)"></a>Best Practices (2025)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Most common production pattern</span></span><br><span class="line">kafkaReceiver.receive()</span><br><span class="line">    .concatMap(record -&gt; </span><br><span class="line">        process(record.value())                              <span class="comment">// may block</span></span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic())       <span class="comment">// â† mandatory</span></span><br><span class="line">            .doOnError(ex -&gt; log.error(<span class="string">&quot;...&quot;</span>, ex))</span><br><span class="line">            .onErrorReturn fallbackValue)                    <span class="comment">// don&#x27;t stop the consumer</span></span><br><span class="line">    .doOnNext(ReceiverRecord::receiverOffset.acknowledge)       <span class="comment">// commit</span></span><br><span class="line">    .retryWhen(Retry.backoff(<span class="number">10</span>, Duration.ofSeconds(<span class="number">1</span>)))        <span class="comment">// survive Kafka blips</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><code>Schedulers.boundedElastic()</code> is the <strong>only safe place</strong> to run blocking code in a WebFlux&#x2F;Reactive application.<br>Without it, you will kill your Netty event-loop and take down the entire service.<br>With it, you get safe, scalable, ordered Kafka consumption even when <code>process()</code> talks to JDBC, Redis sync, or any legacy blocking library.</p>
<p>That one line <code>.subscribeOn(Schedulers.boundedElastic())</code> is literally the difference between a stable 50k RPS service and a total outage.</p>
<h3 id="What-exactly-happens-under-the-hood-when-you-write-this-line"><a href="#What-exactly-happens-under-the-hood-when-you-write-this-line" class="headerlink" title="What exactly happens under the hood when you write this line:"></a>What exactly happens under the hood when you write this line:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">process(record.value())</span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic())</span><br></pre></td></tr></table></figure>

<h3 id="Step-by-Step-Execution-Thread-View"><a href="#Step-by-Step-Execution-Thread-View" class="headerlink" title="Step-by-Step Execution (Thread View)"></a>Step-by-Step Execution (Thread View)</h3><table>
<thead>
<tr>
<th>Time</th>
<th>What happens</th>
<th>Which thread does the work?</th>
<th>Thread pool name</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Kafka record arrives on Netty event-loop thread</td>
<td><code>reactor-http-nio-3</code> (or similar)</td>
<td>Netty event-loop</td>
</tr>
<tr>
<td>2</td>
<td><code>concatMap</code> sees the <code>subscribeOn(boundedElastic())</code> operator</td>
<td>Still on Netty thread</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Reactor <strong>immediately hands the entire <code>process(...)</code> chain</strong> to the <strong>boundedElastic scheduler</strong></td>
<td>â†’ jumps to a thread from the <strong>boundedElastic thread pool</strong></td>
<td><code>boundedElastic-1</code>, <code>boundedElastic-2</code>, â€¦</td>
</tr>
<tr>
<td>4</td>
<td>Your <code>process(record.value())</code> code runs <strong>completely on that boundedElastic thread</strong></td>
<td>Yes â€“ this thread can safely block (JDBC, RestTemplate, File I&#x2F;O, etc.)</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>When <code>process()</code> finishes (success or error), Reactor schedules the downstream operators (<code>.doOnNext(acknowledge)</code>) back on the <strong>original Netty thread</strong> (because of how Reactor Kafka is designed)</td>
<td>Back to <code>reactor-http-nio-3</code></td>
<td></td>
</tr>
</tbody></table>
<h3 id="Visual-Thread-Timeline"><a href="#Visual-Thread-Timeline" class="headerlink" title="Visual Thread Timeline"></a>Visual Thread Timeline</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Netty thread (reactor-http-nio-3)          boundedElastic thread pool</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">receive() â†’ concatMap â†’ subscribeOn() â”€â”€â†’  boundedElastic-7 runs process()</span><br><span class="line">                                           â† process() completes</span><br><span class="line">                                           â†’ acknowledge() runs back on Netty thread</span><br></pre></td></tr></table></figure>

<h3 id="boundedElastic-Thread-Pool-Details-2025-defaults"><a href="#boundedElastic-Thread-Pool-Details-2025-defaults" class="headerlink" title="boundedElastic Thread Pool Details (2025 defaults)"></a>boundedElastic Thread Pool Details (2025 defaults)</h3><table>
<thead>
<tr>
<th>Property</th>
<th>Value (Reactor 3.6+)</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>Core threads</td>
<td>10 (minimum)</td>
<td>Always alive</td>
</tr>
<tr>
<td>Maximum threads</td>
<td><code>CPU cores Ã— 10</code> â†’ usually <strong>100â€“200</strong></td>
<td>Grows only when queue is full</td>
</tr>
<tr>
<td>Queue size</td>
<td>100,000 tasks (configurable)</td>
<td>If full â†’ rejects with exception</td>
</tr>
<tr>
<td>Thread keep-alive</td>
<td>60 seconds (idle threads die)</td>
<td>Saves memory</td>
</tr>
<tr>
<td>Thread name prefix</td>
<td><code>boundedElastic-1</code>, <code>boundedElastic-2</code>, â€¦</td>
<td>Easy to spot in <code>jstack</code> &#x2F; Grafana</td>
</tr>
</tbody></table>
<h3 id="Real-Example-from-Production-Thread-Dump"><a href="#Real-Example-from-Production-Thread-Dump" class="headerlink" title="Real Example from Production Thread Dump"></a>Real Example from Production Thread Dump</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;boundedElastic-27&quot; #124 daemon prio=5 os_prio=0 tid=0x... nid=0x4b2c runnable</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">    at com.mysql.cj.jdbc.ClientPreparedStatement.executeQuery(...)</span><br><span class="line"></span><br><span class="line">&quot;boundedElastic-28&quot; #125 daemon prio=5 os_prio=0 tid=0x... nid=0x4b2d waiting on condition</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">    at jdk.internal.misc.Unsafe.park(Native Method)</span><br><span class="line">    - parking to wait for &lt;0x...&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)</span><br></pre></td></tr></table></figure>

<p>You can see 27 threads doing MySQL queries, 28 waiting for more work â€“ <strong>exactly</strong> what we want.</p>
<h3 id="Summary-Again"><a href="#Summary-Again" class="headerlink" title="Summary Again"></a>Summary Again</h3><blockquote>
<p><code>subscribeOn(Schedulers.boundedElastic())</code> &#x3D;<br>â€œTake this whole piece of work (<code>process(...)</code>) and run it on a dedicated thread pool that is <strong>designed and allowed to block</strong>.<br>The Netty event-loop stays completely free and responsive.â€</p>
</blockquote>
<p>That single operator is the #1 reason reactive Spring Boot + Kafka applications survive real production traffic without melting down.</p>
<h3 id="What-Exactly-Happens-Inside-Schedulers-boundedElastic-Reactor-3-5-Spring-Boot-3-x-â€“-2025"><a href="#What-Exactly-Happens-Inside-Schedulers-boundedElastic-Reactor-3-5-Spring-Boot-3-x-â€“-2025" class="headerlink" title="What Exactly Happens Inside Schedulers.boundedElastic() (Reactor 3.5+ &#x2F; Spring Boot 3.x â€“ 2025)"></a>What <strong>Exactly</strong> Happens Inside <code>Schedulers.boundedElastic()</code> (Reactor 3.5+ &#x2F; Spring Boot 3.x â€“ 2025)</h3><table>
<thead>
<tr>
<th>Question</th>
<th>Exact Answer (Source Code Level)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Which ThreadPoolExecutor is used under the hood?</strong></td>
<td><code>BoundedElasticScheduler</code> â†’ wraps a custom <strong><code>java.util.concurrent.ThreadPoolExecutor</code></strong> with a <strong>very special configuration</strong></td>
</tr>
<tr>
<td><strong>Executor type</strong></td>
<td><strong>Unbounded core + bounded maximum + bounded queue</strong> (the only one in the JDK that behaves like this)</td>
</tr>
<tr>
<td><strong>JDK class</strong></td>
<td><code>reactor.core.scheduler.BoundedElasticScheduler.BoundedScheduledExecutorService</code> â†’ extends <code>ThreadPoolExecutor</code></td>
</tr>
<tr>
<td><strong>Queue used</strong></td>
<td><code>LinkedBlockingQueue&lt;Runnable&gt;</code> with <strong>configurable capacity</strong> (default 100,000)</td>
</tr>
<tr>
<td><strong>Thread factory</strong></td>
<td><code>reactor.core.scheduler.SchedulerThreadFactory</code> â†’ names threads <code>boundedElastic-1</code>, <code>boundedElastic-2</code>, â€¦</td>
</tr>
</tbody></table>
<h3 id="Exact-Thread-Pool-Configuration-2025-defaults"><a href="#Exact-Thread-Pool-Configuration-2025-defaults" class="headerlink" title="Exact Thread Pool Configuration (2025 defaults)"></a>Exact Thread Pool Configuration (2025 defaults)</h3><table>
<thead>
<tr>
<th>Parameter</th>
<th>Value (Reactor 3.6+)</th>
<th>Formula &#x2F; Meaning</th>
</tr>
</thead>
<tbody><tr>
<td><strong>corePoolSize</strong></td>
<td><code>0</code> (zero!)</td>
<td>No threads kept alive when idle</td>
</tr>
<tr>
<td><strong>maximumPoolSize</strong></td>
<td><code>CPU Ã— 10</code> (e.g. 8-core â†’ 80, 16-core â†’ 160, capped at ~200)</td>
<td><code>Math.min(Runtime.getRuntime().availableProcessors() * 10, 100_000)</code></td>
</tr>
<tr>
<td><strong>keepAliveTime</strong></td>
<td><strong>60 seconds</strong></td>
<td>Idle threads above core (i.e. all) die after 60s</td>
</tr>
<tr>
<td><strong>Queue capacity</strong></td>
<td><strong>100,000</strong> tasks by default</td>
<td>Configurable via <code>-Dreactor.schedulers.boundedElastic.queueCapacity=500000</code></td>
</tr>
<tr>
<td><strong>RejectedExecutionHandler</strong></td>
<td><code>AbortPolicy</code> â†’ throws <code>RejectedExecutionException</code> when queue full</td>
<td>Youâ€™ll see <code>QueueFullException</code> in logs if overloaded</td>
</tr>
</tbody></table>
<h3 id="Execution-Strategy-â€“-Visualized"><a href="#Execution-Strategy-â€“-Visualized" class="headerlink" title="Execution Strategy â€“ Visualized"></a>Execution Strategy â€“ Visualized</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">corePoolSize = 0  â†’  No threads at startup</span><br><span class="line">â”‚</span><br><span class="line">â””â”€ Task arrives â†’ create new thread (up to maxPoolSize)</span><br><span class="line">        â”‚</span><br><span class="line">        â”œâ”€ Queue has space â†’ enqueue task</span><br><span class="line">        â”‚       (even if threads &lt; maxPoolSize)</span><br><span class="line">        â”‚</span><br><span class="line">        â””â”€ Queue full + threads == maxPoolSize â†’ REJECT</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Task arrives</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€ threads &lt; maxPoolSize â†’ create new thread immediately</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€ threads == maxPoolSize â†’ enqueue in 100k queue</span><br><span class="line">â”‚</span><br><span class="line">â””â”€ queue full + max threads â†’ RejectedExecutionException â†’ your Flux errors</span><br></pre></td></tr></table></figure>

<p>This is <strong>NOT</strong> the classic â€œfixed + bounded queueâ€ model.<br>Itâ€™s a <strong>hybrid</strong> designed specifically for blocking I&#x2F;O:</p>
<ul>
<li>Grow very aggressively (up to CPUÃ—10) to handle bursty blocking calls</li>
<li>Shrink back to zero when idle â†’ saves memory in microservices</li>
<li>Huge queue (100k) prevents rejection in normal spikes</li>
</ul>
<h3 id="How-to-Change-the-Limits-Production-Tuning"><a href="#How-to-Change-the-Limits-Production-Tuning" class="headerlink" title="How to Change the Limits (Production Tuning)"></a>How to Change the Limits (Production Tuning)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml (Spring Boot)</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>                    <span class="comment"># Java 21+ â†’ switches to virtual threads automatically!</span></span><br></pre></td></tr></table></figure>

<p>Or JVM flags:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Increase queue to 500k</span></span><br><span class="line">-Dreactor.schedulers.boundedElastic.queueCapacity=500000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Force max 200 threads even on 32-core machines</span></span><br><span class="line">-Dreactor.schedulers.boundedElastic.maxThreads=200</span><br></pre></td></tr></table></figure>

<h3 id="Java-21-Bonus-Virtual-Threads-2024â€“2025-reality"><a href="#Java-21-Bonus-Virtual-Threads-2024â€“2025-reality" class="headerlink" title="Java 21+ Bonus: Virtual Threads (2024â€“2025 reality)"></a>Java 21+ Bonus: Virtual Threads (2024â€“2025 reality)</h3><p>Since Java 21 + Reactor 3.6 + Spring Boot 3.2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Schedulers.boundedElastic()   <span class="comment">// automatically uses virtual threads</span></span><br></pre></td></tr></table></figure>

<p>â†’ Each task gets its own <strong>virtual thread</strong> instead of platform thread<br>â†’ maximumPoolSize becomes <strong>practically unlimited</strong> (hundreds of thousands)<br>â†’ Memory per thread drops from ~1â€“2 MB â†’ ~100 KB<br>â†’ You can safely process 100k+ blocking JDBC calls concurrently</p>
<h3 id="Summary-One-More-Time"><a href="#Summary-One-More-Time" class="headerlink" title="Summary One More Time"></a>Summary One More Time</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Schedulers.boundedElastic() </span><br><span class="line">   = ThreadPoolExecutor(</span><br><span class="line">        corePoolSize = <span class="number">0</span>,</span><br><span class="line">        maximumPoolSize = CPU Ã— <span class="number">10</span>,</span><br><span class="line">        keepAlive = 60s,</span><br><span class="line">        queue = LinkedBlockingQueue(<span class="number">100_000</span>),</span><br><span class="line">        policy = AbortPolicy</span><br><span class="line">     )</span><br><span class="line">   + (since Java <span class="number">21</span>) automatically uses virtual threads â†’ effectively unlimited</span><br></pre></td></tr></table></figure>

<p>Thatâ€™s why itâ€™s the <strong>only safe</strong> place to call JDBC, RestTemplate, blocking Redis, etc. in a WebFlux&#x2F;Reactive application â€” and why it scales beautifully in real production systems handling 10kâ€“100k RPS.</p>
<h3 id="Real-Production-Code-Patterns"><a href="#Real-Production-Code-Patterns" class="headerlink" title="Real Production Code Patterns"></a>Real Production Code Patterns</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Classic blocking Kafka consumer (most common)</span></span><br><span class="line">kafkaReceiver.receive()</span><br><span class="line">    .concatMap(record -&gt;</span><br><span class="line">        processBlocking(record.value())                    <span class="comment">// JDBC, RestTemplate, etc.</span></span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic())     <span class="comment">// â† THIS SAVES YOUR APP</span></span><br><span class="line">            .doOnError(ex -&gt; log.error(<span class="string">&quot;Failed &#123;&#125;&quot;</span>, record, ex))</span><br><span class="line">            .onErrorResume(ex -&gt; Mono.empty())             <span class="comment">// don&#x27;t kill the stream</span></span><br><span class="line">    )</span><br><span class="line">    .doOnNext(ReceiverRecord::receiverOffset.acknowledge)</span><br><span class="line">    .subscribe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. WebFlux controller calling legacy blocking service</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/legacy-report&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Report&gt; <span class="title function_">getReport</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.fromCallable(() -&gt; legacyBlockingService.generatePdf())</span><br><span class="line">               .subscribeOn(Schedulers.boundedElastic())   <span class="comment">// safe!</span></span><br><span class="line">               .timeout(Duration.ofSeconds(<span class="number">30</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Parallel batch processing (e.g. 1000 files)</span></span><br><span class="line">Flux)</span><br><span class="line">filesFlux</span><br><span class="line">    .flatMap(file -&gt;</span><br><span class="line">        processFile(file)                                  <span class="comment">// heavy CPU + blocking I/O</span></span><br><span class="line">            .subscribeOn(Schedulers.boundedElastic()),</span><br><span class="line">        <span class="number">50</span>                                                    <span class="comment">// max 50 concurrent</span></span><br><span class="line">    )</span><br><span class="line">    .collectList()</span><br><span class="line">    .block();</span><br></pre></td></tr></table></figure>

<h4 id="5-Production-Tuning-Examples"><a href="#5-Production-Tuning-Examples" class="headerlink" title="5. Production Tuning Examples"></a>5. Production Tuning Examples</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Recommended JVM flags for high-throughput services (2025)</span></span><br><span class="line">-Dreactor.schedulers.boundedElastic.maxThreads=500</span><br><span class="line">-Dreactor.schedulers.boundedElastic.queueCapacity=200000</span><br><span class="line">-Dreactor.schedulers.defaultBoundedElasticOnVirtualThreads=<span class="literal">true</span>   <span class="comment"># force virtual threads even on JDK 21+</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Or in application.yml (Spring Boot 3.2+)</span></span><br><span class="line">spring:</span><br><span class="line">  threads:</span><br><span class="line">    virtual:</span><br><span class="line">      enabled: <span class="literal">true</span>   <span class="comment"># â† turns boundedElastic into virtual-thread heaven</span></span><br></pre></td></tr></table></figure>

<h4 id="6-What-Happens-If-You-Forget-It-Real-Outage-Stories"><a href="#6-What-Happens-If-You-Forget-It-Real-Outage-Stories" class="headerlink" title="6. What Happens If You Forget It? (Real Outage Stories)"></a>6. What Happens If You Forget It? (Real Outage Stories)</h4><table>
<thead>
<tr>
<th>Mistake</th>
<th>Symptom</th>
<th>Time to Total Outage</th>
</tr>
</thead>
<tbody><tr>
<td>Call <code>JdbcTemplate</code> directly in WebFlux</td>
<td>Netty threads block â†’ TCP backlog â†’ all WebSockets disconnect</td>
<td>10â€“60 seconds</td>
</tr>
<tr>
<td>Use <code>Schedulers.parallel()</code> for JDBC</td>
<td>CPU workers starve â†’ GC thrashing â†’ OOM</td>
<td>2â€“10 minutes</td>
</tr>
<tr>
<td>Use <code>subscribeOn(boundedElastic())</code></td>
<td>System stays alive at 50k+ RPS</td>
<td>Never</td>
</tr>
</tbody></table>
<h4 id="Must-Remember"><a href="#Must-Remember" class="headerlink" title="Must Remember!!!"></a>Must Remember!!!</h4><blockquote>
<p><code>Schedulers.boundedElastic()</code> is the <strong>only thread pool specifically created so you can safely call blocking code (JDBC, RestTemplate, Redis sync, file I&#x2F;O, etc.) inside a fully reactive Spring WebFlux application without blowing up your Netty event loop.</strong></p>
</blockquote>
<h3 id="Can-Schedulers-boundedElastic-be-pre-configured"><a href="#Can-Schedulers-boundedElastic-be-pre-configured" class="headerlink" title="Can Schedulers.boundedElastic() be pre-configured?"></a><strong>Can</strong> <code>Schedulers.boundedElastic()</code> <strong>be pre-configured</strong>?</h3><p>Yes but <strong>only via system properties</strong> (JVM flags) or Spring Boot properties â€” <strong>not</strong> via code like <code>new BoundedElasticScheduler(...)</code> in normal applications.</p>
<p>Here is the <strong>complete list of everything you can pre-configure</strong> in 2025 (Reactor 3.6+ &#x2F; Spring Boot 3.2+):</p>
<table>
<thead>
<tr>
<th>What you want to change</th>
<th>How to do it (JVM flag)</th>
<th>Spring Boot 3.2+ equivalent (application.yml)</th>
<th>Default value</th>
</tr>
</thead>
<tbody><tr>
<td>Maximum threads (JDK â‰¤20)</td>
<td><code>-Dreactor.schedulers.boundedElastic.maxThreads=500</code></td>
<td><code>spring.threads.virtual.enabled=false</code> + JVM flag</td>
<td>CPU Ã— 10</td>
</tr>
<tr>
<td>Queue capacity</td>
<td><code>-Dreactor.schedulers.boundedElastic.queueCapacity=500000</code></td>
<td>â€”</td>
<td>100,000</td>
</tr>
<tr>
<td>Thread name prefix</td>
<td><code>-Dreactor.schedulers.boundedElastic.threadPrefix=myapp-be</code></td>
<td>â€”</td>
<td><code>boundedElastic</code></td>
</tr>
<tr>
<td>TTL of cached schedulers</td>
<td><code>-Dreactor.schedulers.boundedElastic.cachedSchedulerExpireAfter=300s</code></td>
<td>â€”</td>
<td>60s</td>
</tr>
<tr>
<td>Force virtual threads (JDK 21+)</td>
<td><code>-Dreactor.schedulers.boundedElasticOnVirtualThreads=true</code></td>
<td><code>spring.threads.virtual.enabled=true</code> â† <strong>recommended</strong></td>
<td>auto-detect</td>
</tr>
<tr>
<td><strong>Pre-warm &#x2F; init threads</strong></td>
<td><strong>Not directly possible</strong></td>
<td>â€”</td>
<td>starts at 0</td>
</tr>
</tbody></table>
<h3 id="Can-I-Pre-create-Threads"><a href="#Can-I-Pre-create-Threads" class="headerlink" title="Can I Pre-create Threads?"></a>Can I Pre-create Threads?</h3><p><strong>No</strong><br><code>boundedElastic</code> is intentionally designed with <code>corePoolSize = 0</code>.<br>There is <strong>no official way</strong> to pre-warm threads (create 10 threads at startup).</p>
<p>But here are <strong>three real-world workarounds</strong> senior teams actually use**:</p>
<h4 id="Workaround-1-â€“-Force-virtual-threads-JDK-21-â†’-problem-disappears"><a href="#Workaround-1-â€“-Force-virtual-threads-JDK-21-â†’-problem-disappears" class="headerlink" title="Workaround 1 â€“ Force virtual threads (JDK 21+) â†’ problem disappears"></a>Workaround 1 â€“ Force virtual threads (JDK 21+) â†’ problem disappears</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml â€“ this is the 2025 gold standard</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>        <span class="comment"># â† makes boundedElastic use virtual threads</span></span><br></pre></td></tr></table></figure>
<p>â†’ Each task gets its own virtual thread instantly<br>â†’ No thread creation latency<br>â†’ No need to pre-warm anything<br>â†’ This is what Netflix, Uber, Alibaba, and most new Spring Boot 3 apps do.</p>
<h4 id="Workaround-2-â€“-Custom-pre-warmed-scheduler-rare-but-possible"><a href="#Workaround-2-â€“-Custom-pre-warmed-scheduler-rare-but-possible" class="headerlink" title="Workaround 2 â€“ Custom pre-warmed scheduler (rare, but possible)"></a>Workaround 2 â€“ Custom pre-warmed scheduler (rare, but possible)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactorConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Scheduler</span> <span class="variable">PREWARMED_BLOCKING</span> <span class="operator">=</span> Schedulers.newBoundedElastic(</span><br><span class="line">        <span class="number">20</span>,          <span class="comment">// core size (pre-created)</span></span><br><span class="line">        <span class="number">200</span>,         <span class="comment">// max size</span></span><br><span class="line">        <span class="string">&quot;myapp-blocking&quot;</span>, </span><br><span class="line">        <span class="number">60</span>           <span class="comment">// keep-alive seconds</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        PREWARMED_BLOCKING.dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then use it instead:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.subscribeOn(ReactorConfig.PREWARMED_BLOCKING)</span><br></pre></td></tr></table></figure>

<h4 id="Workaround-3-â€“-Eager-initialization-at-startup-hacky-but-works"><a href="#Workaround-3-â€“-Eager-initialization-at-startup-hacky-but-works" class="headerlink" title="Workaround 3 â€“ Eager initialization at startup (hacky but works)"></a>Workaround 3 â€“ Eager initialization at startup (hacky but works)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warmupBoundedElastic</span><span class="params">()</span> &#123;</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">20</span>).parallel().forEach(i -&gt;</span><br><span class="line">        Schedulers.boundedElastic().schedule(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (Exception ignored) &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â†’ Forces the default <code>boundedElastic</code> to create 20 threads immediately.</p>
<h3 id="2025-Production-Recommendation"><a href="#2025-Production-Recommendation" class="headerlink" title="2025 Production Recommendation"></a>2025 Production Recommendation</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml â€“ copy-paste this and forget about thread pools forever</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>                 <span class="comment"># â† turns boundedElastic into infinite virtual threads</span></span><br><span class="line">  <span class="attr">task:</span></span><br><span class="line">    <span class="attr">scheduling:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">size:</span> <span class="number">50</span>                    <span class="comment"># for @Scheduled tasks</span></span><br></pre></td></tr></table></figure>

<p>With Java 21 + Spring Boot 3.2 + this config:</p>
<ul>
<li><code>Schedulers.boundedElastic()</code> becomes <strong>effectively infinite</strong></li>
<li>Thread creation latency â‰ˆ 0</li>
<li>Memory per blocking call â‰ˆ 100 KB instead of 2 MB</li>
<li>You never have to pre-warm or tune anything again</li>
</ul>
<table>
<thead>
<tr>
<th>Goal</th>
<th>Solution in 2025</th>
</tr>
</thead>
<tbody><tr>
<td>Pre-warm threads</td>
<td>Not possible with default scheduler</td>
</tr>
<tr>
<td>Make it fast + infinite</td>
<td><code>spring.threads.virtual.enabled=true</code> (JDK 21+) â† <strong>use this</strong></td>
</tr>
<tr>
<td>Full control</td>
<td>Create your own with <code>Schedulers.newBoundedElastic(...)</code></td>
</tr>
</tbody></table>
<p>99 % of teams in 2025 just enable virtual threads and never think about <code>boundedElastic</code> configuration again.  </p>
<h3 id="Mono-fromCallable-â€“-The-Ultimate-2025-Explanation"><a href="#Mono-fromCallable-â€“-The-Ultimate-2025-Explanation" class="headerlink" title="Mono.fromCallable(...) â€“ The Ultimate 2025 Explanation"></a><code>Mono.fromCallable(...)</code> â€“ The Ultimate 2025 Explanation</h3><p>(What every senior Java&#x2F;Reactive engineer must know inside-out)</p>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer (Real Production Truth)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>What is it?</strong></td>
<td>A factory method that creates a <code>Mono&lt;T&gt;</code> from a <strong>blocking, callable piece of code</strong> (<code>Callable&lt;T&gt;</code> or lambda that returns <code>T</code>).</td>
</tr>
<tr>
<td><strong>When do you use it?</strong></td>
<td><strong>Every time you have to call legacy blocking code</strong> (JDBC, RestTemplate, Redis sync, file I&#x2F;O, external API, etc.) inside a reactive chain.</td>
</tr>
<tr>
<td><strong>Is it blocking?</strong></td>
<td>Yes â€” the code inside runs <strong>synchronously and blocks the calling thread</strong>.</td>
</tr>
<tr>
<td><strong>Is it safe to call directly in WebFlux?</strong></td>
<td><strong>Only safe if you offload it</strong> (via <code>.subscribeOn(...)</code>) â€” otherwise you block Netty event-loop â†’ outage.</td>
</tr>
</tbody></table>
<h3 id="Exact-Contract-Behavior"><a href="#Exact-Contract-Behavior" class="headerlink" title="Exact Contract &amp; Behavior"></a>Exact Contract &amp; Behavior</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Mono&lt;T&gt; <span class="title function_">fromCallable</span><span class="params">(Callable&lt;? extends T&gt; supplier)</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Scenario</th>
<th>What actually happens</th>
</tr>
</thead>
<tbody><tr>
<td><code>supplier</code> returns a value</td>
<td><code>Mono</code> emits that value â†’ <code>onNext</code> â†’ <code>onComplete</code></td>
</tr>
<tr>
<td><code>supplier</code> throws exception</td>
<td><code>Mono</code> emits <code>onError</code> with that exception</td>
</tr>
<tr>
<td><code>supplier</code> returns <code>null</code></td>
<td><code>Mono</code> emits <code>onNext(null)</code> â†’ <code>onComplete</code> (yes, null is allowed)</td>
</tr>
<tr>
<td>You call it on Netty thread</td>
<td>Blocks the carrier thread â†’ <strong>bad</strong> unless you offload</td>
</tr>
</tbody></table>
<h3 id="The-Two-Correct-Ways-to-Use-It-in-2025"><a href="#The-Two-Correct-Ways-to-Use-It-in-2025" class="headerlink" title="The Two Correct Ways to Use It in 2025"></a>The Two Correct Ways to Use It in 2025</h3><h4 id="1-Classic-way-Java-17â€“20-â€“-must-offload"><a href="#1-Classic-way-Java-17â€“20-â€“-must-offload" class="headerlink" title="1. Classic way (Java 17â€“20) â€“ must offload"></a>1. Classic way (Java 17â€“20) â€“ must offload</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mono.fromCallable(() -&gt; jdbcTemplate.queryForObject(sql, Long.class))</span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic())   <span class="comment">// â† mandatory pre-Java 21</span></span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<h4 id="2-2025-way-Java-21-virtual-threads-â€“-offload-optional"><a href="#2-2025-way-Java-21-virtual-threads-â€“-offload-optional" class="headerlink" title="2. 2025 way (Java 21 + virtual threads) â€“ offload optional"></a>2. 2025 way (Java 21 + virtual threads) â€“ offload optional</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>        <span class="comment"># â† turns boundedElastic into virtual threads</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Now perfectly safe without subscribeOn!</span></span><br><span class="line">Mono.fromCallable(() -&gt; jdbcTemplate.queryForObject(sql, Long.class))</span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Real-World-Examples-Copy-Paste-Ready"><a href="#Real-World-Examples-Copy-Paste-Ready" class="headerlink" title="Real-World Examples (Copy-Paste Ready)"></a>Real-World Examples (Copy-Paste Ready)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Legacy JDBC call</span></span><br><span class="line">Mono.fromCallable(() -&gt; userRepository.findById(id))   <span class="comment">// blocking</span></span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. External blocking HTTP client</span></span><br><span class="line">Mono.fromCallable(() -&gt; restTemplate.postForEntity(url, request, String.class))</span><br><span class="line">    .map(HttpEntity::getBody)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. File I/O</span></span><br><span class="line">Mono.fromCallable(() -&gt; Files.readString(Path.of(<span class="string">&quot;/tmp/config.json&quot;</span>)))</span><br><span class="line">    .map(Json::parse)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. CPU-heavy calculation (WRONG scheduler!)</span></span><br><span class="line">Mono.fromCallable(() -&gt; complexEncryption(data))      <span class="comment">// CPU bound â†’ use parallel!</span></span><br><span class="line">    .subscribeOn(Schedulers.parallel())               <span class="comment">// â† correct</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. With error handling + fallback</span></span><br><span class="line">Mono.fromCallable(() -&gt; legacyService.getUser(id))</span><br><span class="line">    .onErrorResume(ex -&gt; &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;Legacy failed, using cache&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(cachedUser);</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Common-Mistakes-Seniors-Still-Make"><a href="#Common-Mistakes-Seniors-Still-Make" class="headerlink" title="Common Mistakes Seniors Still Make"></a>Common Mistakes Seniors Still Make</h3><table>
<thead>
<tr>
<th>Mistake</th>
<th>Consequence</th>
<th>Fix</th>
</tr>
</thead>
<tbody><tr>
<td>Forgetting <code>.subscribeOn(boundedElastic())</code></td>
<td>Blocks Netty â†’ all WebSockets disconnect</td>
<td>Add it (or enable virtual threads)</td>
</tr>
<tr>
<td>Using it for CPU work</td>
<td>Starves parallel scheduler</td>
<td>Use <code>Mono.fromSupplier</code> + <code>Schedulers.parallel()</code></td>
</tr>
<tr>
<td>Chaining many <code>fromCallable</code> without limit</td>
<td>Thread explosion (one thread per call)</td>
<td>Use <code>.publishOn(...)</code> or limit concurrency</td>
</tr>
</tbody></table>
<h3 id="Mono-fromCallable-vs-Alternatives-2025-Decision-Table"><a href="#Mono-fromCallable-vs-Alternatives-2025-Decision-Table" class="headerlink" title="Mono.fromCallable vs Alternatives (2025 Decision Table)"></a><code>Mono.fromCallable</code> vs Alternatives (2025 Decision Table)</h3><table>
<thead>
<tr>
<th>Use Case</th>
<th>Best Choice</th>
<th>Why</th>
</tr>
</thead>
<tbody><tr>
<td>Simple blocking call (DB, HTTP, file)</td>
<td><code>Mono.fromCallable(...).subscribeOn(boundedElastic())</code></td>
<td>Cleanest</td>
</tr>
<tr>
<td>You already have a <code>Supplier&lt;T&gt;</code></td>
<td><code>Mono.fromSupplier(...)</code></td>
<td>Same as fromCallable but no checked exception</td>
</tr>
<tr>
<td>You want lazy execution only on subscribe</td>
<td><code>Mono.defer(() -&gt; Mono.fromCallable(...))</code></td>
<td>Prevents execution on cold publishers</td>
</tr>
<tr>
<td>Async but blocking driver</td>
<td>Prefer true async driver (R2DBC, reactive Redis)</td>
<td>Zero blocking</td>
</tr>
</tbody></table>
<h3 id="The-One-Rule-Every-Senior-Lives-By"><a href="#The-One-Rule-Every-Senior-Lives-By" class="headerlink" title="The One Rule Every Senior Lives By"></a>The One Rule Every Senior Lives By</h3><blockquote>
<p><code>Mono.fromCallable &#123; blocking code &#125;</code><br>â†’ <strong>Always</strong> pair with <code>.subscribeOn(Schedulers.boundedElastic())</code><br>â†’ <strong>Or</strong> run on Java 21+ with <code>spring.threads.virtual.enabled=true</code> and delete the <code>subscribeOn</code> forever.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/02/Keyclock-Revocation-Mechanism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/02/Keyclock-Revocation-Mechanism/" class="post-title-link" itemprop="url">Keyclock Revocation Mechanism</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-02 20:16:06 / Modified: 20:20:07" itemprop="dateCreated datePublished" datetime="2025-12-02T20:16:06-05:00">2025-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Keycloak/" itemprop="url" rel="index"><span itemprop="name">Keycloak</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ğŸ”¥-Q1-â€”-How-does-Keycloak-revoke-access-across-all-sessions-devices-and-clients"><a href="#ğŸ”¥-Q1-â€”-How-does-Keycloak-revoke-access-across-all-sessions-devices-and-clients" class="headerlink" title="ğŸ”¥ Q1 â€” How does Keycloak revoke access across all sessions, devices, and clients?"></a>ğŸ”¥ <strong>Q1 â€” How does Keycloak revoke access across all sessions, devices, and clients?</strong></h1><h3 id="â­-Senior-Level-Answer"><a href="#â­-Senior-Level-Answer" class="headerlink" title="â­ Senior-Level Answer"></a>â­ <strong>Senior-Level Answer</strong></h3><p>Keycloak maintains a <strong>server-side Session Store</strong> (in-memory or distributed depending on the cluster).<br>This enables Keycloak to <strong>centrally track active user sessions</strong> including:</p>
<ul>
<li>Each login session</li>
<li>Access tokens issued</li>
<li>Refresh tokens issued</li>
<li>Client sessions</li>
<li>Offline sessions</li>
<li>Device-specific sessions</li>
</ul>
<h3 id="When-a-user-logs-out-or-an-admin-revokes-access-Keycloak-performs"><a href="#When-a-user-logs-out-or-an-admin-revokes-access-Keycloak-performs" class="headerlink" title="When a user logs out or an admin revokes access, Keycloak performs:"></a>When a user logs out or an admin revokes access, Keycloak performs:</h3><h2 id="1-Session-invalidation-in-the-Session-Store"><a href="#1-Session-invalidation-in-the-Session-Store" class="headerlink" title="1. Session invalidation in the Session Store"></a><strong>1. Session invalidation in the Session Store</strong></h2><p>Keycloak marks the user session as <strong>invalid</strong> inside its central session map:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_id -&gt; state = INVALID</span><br></pre></td></tr></table></figure>

<p>This invalidation immediately affects:</p>
<ul>
<li>All clients (web apps, mobile apps, services)</li>
<li>All sessions (browser, mobile, REST clients)</li>
<li>All tokens linked to the session</li>
</ul>
<p>This is because <strong>all tokens in Keycloak are tied to a Keycloak session ID</strong> (<code>sid</code> claim).</p>
<hr>
<h2 id="2-Refresh-Token-Blacklist-revocation"><a href="#2-Refresh-Token-Blacklist-revocation" class="headerlink" title="2. Refresh Token Blacklist &#x2F; revocation"></a><strong>2. Refresh Token Blacklist &#x2F; revocation</strong></h2><p>Keycloak stores refresh tokens in a <strong>server-side token store</strong> (unlike fully stateless JWT systems).</p>
<p>When the user logs out:</p>
<ul>
<li>All refresh tokens belonging to the session are invalidated.</li>
<li>Any refresh request with those tokens is rejected.</li>
</ul>
<p>This blocks all new access tokens across all devices.</p>
<hr>
<h2 id="3-Token-Introspection-for-OAuth2-Introspection-clients"><a href="#3-Token-Introspection-for-OAuth2-Introspection-clients" class="headerlink" title="3. Token Introspection (for OAuth2 Introspection clients)"></a><strong>3. Token Introspection (for OAuth2 Introspection clients)</strong></h2><p>If a client uses <code>token_introspection</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/protocol/openid-connect/token/introspect</span><br></pre></td></tr></table></figure>

<p>Keycloak will return:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;active&quot;: false</span><br></pre></td></tr></table></figure>

<p>as soon as the session is invalidated.</p>
<p>This enables immediate revocation for â€œonlineâ€ services.</p>
<hr>
<h2 id="4-Realm-wide-or-client-side-Revocation-Events"><a href="#4-Realm-wide-or-client-side-Revocation-Events" class="headerlink" title="4. Realm-wide or client-side Revocation Events"></a><strong>4. Realm-wide or client-side Revocation Events</strong></h2><p>Keycloak issues <strong>revocation events</strong> when:</p>
<ul>
<li>Admin revokes all sessions</li>
<li>Client is removed</li>
<li>Roles or permissions change</li>
<li>User is disabled</li>
</ul>
<p>Clients using <strong>Keycloak Adapters</strong> (Tomcat, Spring, Node, Quarkus) receive the event and <strong>invalidate local caches</strong> of tokens.</p>
<hr>
<h1 id="â­-Why-Keycloak-Can-Do-This-Technical-Reason"><a href="#â­-Why-Keycloak-Can-Do-This-Technical-Reason" class="headerlink" title="â­ Why Keycloak Can Do This (Technical Reason)"></a>â­ Why Keycloak Can Do This (Technical Reason)</h1><p>Because <strong>Keycloak is NOT fully stateless</strong>.<br>It manages a <strong>stateful authentication session</strong>, and tokens reference that session.</p>
<p>Therefore, revocation propagates instantly and globally.</p>
<hr>
<h1 id="ğŸ”¥-Q2-â€”-Why-canâ€™t-typical-stateless-JWT-systems-revoke-access-as-effectively"><a href="#ğŸ”¥-Q2-â€”-Why-canâ€™t-typical-stateless-JWT-systems-revoke-access-as-effectively" class="headerlink" title="ğŸ”¥ Q2 â€” Why canâ€™t typical stateless JWT systems revoke access as effectively?"></a>ğŸ”¥ <strong>Q2 â€” Why canâ€™t typical stateless JWT systems revoke access as effectively?</strong></h1><h3 id="â­-Senior-Level-Answer-1"><a href="#â­-Senior-Level-Answer-1" class="headerlink" title="â­ Senior-Level Answer"></a>â­ <strong>Senior-Level Answer</strong></h3><p>A typical stateless JWT architecture uses <strong>self-contained JWTs</strong>:</p>
<ul>
<li>Token verification is done by services <em>locally</em> via public key.</li>
<li>Services do not contact the authorization server again after token issuance.</li>
</ul>
<p>This means:</p>
<h3 id="âŒ-Once-a-JWT-is-issued-it-cannot-be-revoked-until-it-expires"><a href="#âŒ-Once-a-JWT-is-issued-it-cannot-be-revoked-until-it-expires" class="headerlink" title="âŒ Once a JWT is issued, it cannot be revoked until it expires"></a>âŒ Once a JWT is issued, it cannot be revoked until it expires</h3><p>Unless you add non-standard extensions.</p>
<h3 id="âŒ-No-central-session-store"><a href="#âŒ-No-central-session-store" class="headerlink" title="âŒ No central session store"></a>âŒ No central session store</h3><p>There is nowhere to mark a session as invalid.</p>
<h3 id="âŒ-No-refresh-token-blacklist"><a href="#âŒ-No-refresh-token-blacklist" class="headerlink" title="âŒ No refresh token blacklist"></a>âŒ No refresh token blacklist</h3><p>Unless implemented manually with a database or Redis.</p>
<h3 id="âŒ-No-push-revocation-events-to-API-clients"><a href="#âŒ-No-push-revocation-events-to-API-clients" class="headerlink" title="âŒ No push revocation events to API clients"></a>âŒ No push revocation events to API clients</h3><p>(Standard OAuth2 libraries donâ€™t have this built in.)</p>
<hr>
<h2 id="ğŸ’¥-Final-summary"><a href="#ğŸ’¥-Final-summary" class="headerlink" title="ğŸ’¥ Final summary:"></a>ğŸ’¥ Final summary:</h2><h3 id="Keycloak-stateful-centralized-session-model"><a href="#Keycloak-stateful-centralized-session-model" class="headerlink" title="Keycloak (stateful + centralized session model)"></a><strong>Keycloak (stateful + centralized session model)</strong></h3><p>âœ” Server-side session invalidation<br>âœ” Refresh token revocation<br>âœ” Token introspection<br>âœ” Push revocation events to adapters<br>âœ” Offline session management<br>âœ” Works across multiple devices, browsers, apps<br>âœ” Suitable for enterprise SSO</p>
<h3 id="Common-JWT-only-stateless-systems"><a href="#Common-JWT-only-stateless-systems" class="headerlink" title="Common JWT-only stateless systems"></a><strong>Common JWT-only stateless systems</strong></h3><p>âŒ No central session<br>âŒ Cannot revoke tokens already issued<br>âŒ Must wait until token expiration<br>âŒ Must manually implement token blacklist<br>âŒ Cannot force logout across multiple clients</p>
<p>This difference is <em>fundamental</em> to why enterprises choose Keycloak.</p>
<hr>
<h1 id="ğŸ”¥-Q3-â€”-How-does-Keycloak-ensure-cluster-wide-revocation-in-HA-mode"><a href="#ğŸ”¥-Q3-â€”-How-does-Keycloak-ensure-cluster-wide-revocation-in-HA-mode" class="headerlink" title="ğŸ”¥ Q3 â€” How does Keycloak ensure cluster-wide revocation in HA mode?"></a>ğŸ”¥ <strong>Q3 â€” How does Keycloak ensure cluster-wide revocation in HA mode?</strong></h1><h3 id="â­-Senior-Level-Answer-2"><a href="#â­-Senior-Level-Answer-2" class="headerlink" title="â­ Senior-Level Answer"></a>â­ Senior-Level Answer</h3><p>Keycloak in cluster mode (Infinispan or newer methods) shares:</p>
<ul>
<li>User sessions</li>
<li>Client sessions</li>
<li>Offline sessions</li>
<li>Login failure counters</li>
<li>Revocation timestamps</li>
</ul>
<p>All nodes listen to <strong>Infinispan cache events</strong>.</p>
<p>So when one node invalidates a session:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster-broadcast:</span><br><span class="line">  event = session-revocation</span><br><span class="line">  sid = 7ab3... </span><br></pre></td></tr></table></figure>

<p>Every node immediately removes the session from its local cache.</p>
<p>This ensures <strong>revocation is cluster-wide and instantaneous</strong>.</p>
<hr>
<h1 id="ğŸ”¥-Q4-â€”-How-does-Keycloak-reduce-the-JWT-statelessness-problem"><a href="#ğŸ”¥-Q4-â€”-How-does-Keycloak-reduce-the-JWT-statelessness-problem" class="headerlink" title="ğŸ”¥ Q4 â€” How does Keycloak reduce the JWT statelessness problem?"></a>ğŸ”¥ <strong>Q4 â€” How does Keycloak reduce the JWT statelessness problem?</strong></h1><h3 id="â­-Keycloak-issues-stateless-JWT-access-tokens-but"><a href="#â­-Keycloak-issues-stateless-JWT-access-tokens-but" class="headerlink" title="â­ Keycloak issues stateless JWT access tokens but:"></a>â­ Keycloak issues stateless JWT access tokens <strong>but</strong>:</h3><p><strong>1. They have short TTL (5â€“15 minutes recommended)</strong><br>So compromise window is small.</p>
<p><strong>2. They are always tied to a session (<code>sid</code> claim).</strong></p>
<p><strong>3. They can be introspected by resource servers if required.</strong></p>
<p>Keycloak combines:</p>
<ul>
<li>Stateless JWT access tokens (performance)</li>
<li>Stateful refresh token &amp; session management (security)</li>
</ul>
<p>This hybrid model is why Keycloak works well for enterprise.</p>
<hr>
<h1 id="ğŸ”¥-Q5-â€”-How-to-architect-revocation-sensitive-microservices-with-Keycloak"><a href="#ğŸ”¥-Q5-â€”-How-to-architect-revocation-sensitive-microservices-with-Keycloak" class="headerlink" title="ğŸ”¥ Q5 â€” How to architect revocation-sensitive microservices with Keycloak?"></a>ğŸ”¥ <strong>Q5 â€” How to architect revocation-sensitive microservices with Keycloak?</strong></h1><h3 id="â­-Best-practice"><a href="#â­-Best-practice" class="headerlink" title="â­ Best practice"></a>â­ Best practice</h3><table>
<thead>
<tr>
<th>Token Type</th>
<th>Recommended Use</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Access Token (JWT)</strong></td>
<td>Short TTL (2â€“10 min), stateless verification</td>
</tr>
<tr>
<td><strong>Refresh Token</strong></td>
<td>Managed by Keycloak; revocation effective</td>
</tr>
<tr>
<td><strong>Token Introspection</strong></td>
<td>Only for zero-trust or sensitive APIs</td>
</tr>
<tr>
<td><strong>Keycloak Adapters</strong></td>
<td>To receive push revocation events</td>
</tr>
</tbody></table>
<p>Your services should not store long-lived sessions themselves.<br>Let Keycloak handle that.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/02/Deep-Dive-into-Keycloak-II/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/02/Deep-Dive-into-Keycloak-II/" class="post-title-link" itemprop="url">Deep Dive into Keycloak II</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-02 20:05:40 / Modified: 20:19:54" itemprop="dateCreated datePublished" datetime="2025-12-02T20:05:40-05:00">2025-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Keycloak/" itemprop="url" rel="index"><span itemprop="name">Keycloak</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-What-is-the-difference-between-OAuth2-and-OpenID-Connect-OIDC"><a href="#1-What-is-the-difference-between-OAuth2-and-OpenID-Connect-OIDC" class="headerlink" title="1. What is the difference between OAuth2 and OpenID Connect (OIDC)?"></a><strong>1. What is the difference between OAuth2 and OpenID Connect (OIDC)?</strong></h1><h3 id="Answer"><a href="#Answer" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>OAuth2 is an <strong>authorization</strong> framework â€” it gives applications access to protected resources via access tokens.<br>OIDC is an <strong>authentication</strong> layer built on top of OAuth2 â€” it provides identity information by adding <strong>ID tokens</strong>, user info endpoint, and standardized flows.</p>
<p>You use OAuth2 when an app needs <em>permissions</em><br>You use OIDC when an app needs <em>login + identity</em>.</p>
<hr>
<h1 id="2-How-does-Keycloak-handle-session-management-compared-to-stateless-JWT-systems"><a href="#2-How-does-Keycloak-handle-session-management-compared-to-stateless-JWT-systems" class="headerlink" title="2. How does Keycloak handle session management compared to stateless JWT systems?"></a><strong>2. How does Keycloak handle session management compared to stateless JWT systems?</strong></h1><h3 id="Answer-1"><a href="#Answer-1" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Keycloak maintains a <strong>server-side session</strong> for each authenticated user.<br>Even though it issues JWTs, it â€œpeeksâ€ into the tokenâ€™s session ID to enforce logout and token invalidation.<br>This means:</p>
<ul>
<li>Keycloak can force logout of any user</li>
<li>Admin can revoke access tokens instantly</li>
<li>Tokens are short-lived; refresh tokens renew them</li>
</ul>
<p>Stateless JWT-only systems <em>cannot</em> revoke tokens without additional infrastructure.</p>
<hr>
<h1 id="3-Whatâ€™s-the-purpose-of-a-Keycloak-Realm"><a href="#3-Whatâ€™s-the-purpose-of-a-Keycloak-Realm" class="headerlink" title="3. Whatâ€™s the purpose of a Keycloak Realm?"></a><strong>3. Whatâ€™s the purpose of a Keycloak Realm?</strong></h1><h3 id="Answer-2"><a href="#Answer-2" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>A Realm is an isolated authentication domain.<br>Each realm has:</p>
<ul>
<li>its own clients</li>
<li>identity providers</li>
<li>users</li>
<li>roles</li>
<li>token settings</li>
</ul>
<p>Realms do not share users.<br>This isolates tenants for multi-tenant apps.</p>
<hr>
<h1 id="4-Explain-the-OAuth2-Authorization-Code-Flow-with-PKCE"><a href="#4-Explain-the-OAuth2-Authorization-Code-Flow-with-PKCE" class="headerlink" title="4. Explain the OAuth2 Authorization Code Flow with PKCE."></a><strong>4. Explain the OAuth2 Authorization Code Flow with PKCE.</strong></h1><h3 id="Answer-3"><a href="#Answer-3" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Used by public clients (SPA, mobile).<br>Steps:</p>
<ol>
<li>Client generates a <strong>code verifier</strong> and <strong>challenge</strong></li>
<li>User is redirected to Keycloak login</li>
<li>After successful login, Keycloak returns an <strong>authorization code</strong></li>
<li>Client exchanges the code for tokens including the <strong>code verifier</strong></li>
<li>Keycloak recomputes the challenge to verify request integrity</li>
</ol>
<p>PKCE prevents code interception attacks.</p>
<hr>
<h1 id="5-What-Keycloak-feature-would-you-use-for-Single-Sign-On-across-multiple-apps"><a href="#5-What-Keycloak-feature-would-you-use-for-Single-Sign-On-across-multiple-apps" class="headerlink" title="5. What Keycloak feature would you use for Single Sign-On across multiple apps?"></a><strong>5. What Keycloak feature would you use for Single Sign-On across multiple apps?</strong></h1><h3 id="Answer-4"><a href="#Answer-4" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p><strong>SSO session + OIDC Authorization Code Flow.</strong><br>Apps use the same Keycloak realm; once the user is logged into one app, Keycloak issues tokens to others without re-authentication.</p>
<hr>
<h1 id="6-How-do-you-configure-role-based-access-control-in-Keycloak"><a href="#6-How-do-you-configure-role-based-access-control-in-Keycloak" class="headerlink" title="6. How do you configure role-based access control in Keycloak?"></a><strong>6. How do you configure role-based access control in Keycloak?</strong></h1><h3 id="Answer-5"><a href="#Answer-5" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><ul>
<li>Create <strong>realm roles</strong> or <strong>client roles</strong></li>
<li>Map roles to users or groups</li>
<li>Configure clients to include roles in tokens (scope + mappers)</li>
<li>Your service enforces authorization based on the roles claim in JWT</li>
</ul>
<hr>
<h1 id="7-What-is-the-difference-between-Realm-Roles-and-Client-Roles"><a href="#7-What-is-the-difference-between-Realm-Roles-and-Client-Roles" class="headerlink" title="7. What is the difference between Realm Roles and Client Roles?"></a><strong>7. What is the difference between Realm Roles and Client Roles?</strong></h1><h3 id="Answer-6"><a href="#Answer-6" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><ul>
<li>Realm roles are global across the entire realm</li>
<li>Client roles belong to a specific client (service)</li>
</ul>
<p>Client roles prevent namespace collisions and support service-specific authorization.</p>
<hr>
<h1 id="8-How-do-you-secure-a-Spring-Boot-REST-API-using-Keycloak"><a href="#8-How-do-you-secure-a-Spring-Boot-REST-API-using-Keycloak" class="headerlink" title="8. How do you secure a Spring Boot REST API using Keycloak?"></a><strong>8. How do you secure a Spring Boot REST API using Keycloak?</strong></h1><h3 id="Answer-7"><a href="#Answer-7" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>For Spring Security 6 &#x2F; Boot 3:</p>
<ol>
<li>Use the OAuth2 Resource Server starter</li>
<li>Configure <code>issuer-uri</code> pointed to Keycloak realm</li>
<li>Enable JWT validation</li>
<li>Add authorization rules based on roles in JWT</li>
</ol>
<p>Resource server verifies tokens by fetching Keycloakâ€™s public keys (JWKS).</p>
<hr>
<h1 id="9-What-are-Keycloak-Identity-Providers"><a href="#9-What-are-Keycloak-Identity-Providers" class="headerlink" title="9. What are Keycloak Identity Providers?"></a><strong>9. What are Keycloak Identity Providers?</strong></h1><h3 id="Answer-8"><a href="#Answer-8" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Identity Providers allow Keycloak to delegate login to external systems like:</p>
<ul>
<li>Google</li>
<li>GitHub</li>
<li>Azure AD</li>
<li>Another Keycloak realm</li>
</ul>
<p>Keycloak becomes an identity broker.</p>
<hr>
<h1 id="10-How-does-token-revocation-work-in-Keycloak"><a href="#10-How-does-token-revocation-work-in-Keycloak" class="headerlink" title="10. How does token revocation work in Keycloak?"></a><strong>10. How does token revocation work in Keycloak?</strong></h1><h3 id="Answer-9"><a href="#Answer-9" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Keycloak stores sessions server-side.<br>When an admin revokes tokens or logs a user out:</p>
<ul>
<li>Active tokens become invalid</li>
<li>Refresh token rotation prevents re-use</li>
<li>Next request with old token fails with 401</li>
</ul>
<p>This is a major advantage over purely stateless JWT systems.</p>
<hr>
<h1 id="11-What-is-Offline-Session-and-Offline-Token"><a href="#11-What-is-Offline-Session-and-Offline-Token" class="headerlink" title="11. What is Offline Session and Offline Token?"></a><strong>11. What is Offline Session and Offline Token?</strong></h1><h3 id="Answer-10"><a href="#Answer-10" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Offline tokens are long-lived refresh tokens not tied to active user sessions.<br>Useful for background jobs or CLI tools.<br>Users do not need to stay logged in.</p>
<hr>
<h1 id="12-How-do-you-integrate-Keycloak-with-an-API-Gateway-e-g-Kong-Nginx-Spring-Cloud-Gateway"><a href="#12-How-do-you-integrate-Keycloak-with-an-API-Gateway-e-g-Kong-Nginx-Spring-Cloud-Gateway" class="headerlink" title="12. How do you integrate Keycloak with an API Gateway (e.g., Kong, Nginx, Spring Cloud Gateway)?"></a><strong>12. How do you integrate Keycloak with an API Gateway (e.g., Kong, Nginx, Spring Cloud Gateway)?</strong></h1><h3 id="Answer-11"><a href="#Answer-11" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Use the gateway as an <strong>OAuth2 resource server</strong>.<br>It:</p>
<ul>
<li>validates JWTs from Keycloak</li>
<li>checks scopes&#x2F;roles</li>
<li>forwards authorized requests to microservices</li>
<li>optionally strips sensitive headers</li>
</ul>
<p>Microservices behind the gateway become stateless and do not validate tokens directly.</p>
<hr>
<h1 id="13-What-is-the-Keycloak-Admin-API-used-for"><a href="#13-What-is-the-Keycloak-Admin-API-used-for" class="headerlink" title="13. What is the Keycloak Admin API used for?"></a><strong>13. What is the Keycloak Admin API used for?</strong></h1><h3 id="Answer-12"><a href="#Answer-12" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Automating user and client management:</p>
<ul>
<li>create&#x2F;update users</li>
<li>reset passwords</li>
<li>assign roles</li>
<li>manage groups</li>
<li>manage clients</li>
<li>trigger impersonation</li>
</ul>
<p>Often used in CI&#x2F;CD or multi-tenant systems.</p>
<hr>
<h1 id="14-How-would-you-scale-Keycloak-for-production"><a href="#14-How-would-you-scale-Keycloak-for-production" class="headerlink" title="14. How would you scale Keycloak for production?"></a><strong>14. How would you scale Keycloak for production?</strong></h1><h3 id="Answer-13"><a href="#Answer-13" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><ul>
<li>Run multiple Keycloak nodes behind a load balancer</li>
<li>Use a shared database (PostgreSQL recommended)</li>
<li>Use sticky sessions only if needed (usually not needed post-Keycloak 17+)</li>
<li>Enable cross-node session cache with Infinispan</li>
<li>Offload static content via reverse proxy</li>
</ul>
<p>Keycloak 21+ with Quarkus has much lower memory footprint and better clustering.</p>
<hr>
<h1 id="15-What-are-the-common-pitfalls-when-integrating-SPAs-React-with-Keycloak"><a href="#15-What-are-the-common-pitfalls-when-integrating-SPAs-React-with-Keycloak" class="headerlink" title="15. What are the common pitfalls when integrating SPAs (React) with Keycloak?"></a><strong>15. What are the common pitfalls when integrating SPAs (React) with Keycloak?</strong></h1><h3 id="Answer-14"><a href="#Answer-14" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><ol>
<li>Storing tokens insecurely (never use localStorage â†’ use memory with silent refresh).</li>
<li>Using Implicit Flow (deprecated).</li>
<li>Not handling token refresh properly.</li>
<li>Not using PKCE.</li>
<li>Not validating roles on backend.</li>
</ol>
<p>Best practice: React &#x3D; public client using Authorization Code + PKCE.</p>
<hr>
<h1 id="16-How-do-service-to-service-calls-work-with-Keycloak"><a href="#16-How-do-service-to-service-calls-work-with-Keycloak" class="headerlink" title="16. How do service-to-service calls work with Keycloak?"></a><strong>16. How do service-to-service calls work with Keycloak?</strong></h1><h3 id="Answer-15"><a href="#Answer-15" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Use <strong>Client Credentials Flow</strong>:</p>
<ul>
<li>No user involved</li>
<li>The client authenticates with client secret</li>
<li>Keycloak returns an access token</li>
<li>Service uses token to call downstream service</li>
</ul>
<p>This is machine-to-machine authentication.</p>
<hr>
<h1 id="17-Whatâ€™s-the-difference-between-Access-Token-and-ID-Token"><a href="#17-Whatâ€™s-the-difference-between-Access-Token-and-ID-Token" class="headerlink" title="17. Whatâ€™s the difference between Access Token and ID Token?"></a><strong>17. Whatâ€™s the difference between Access Token and ID Token?</strong></h1><h3 id="Answer-16"><a href="#Answer-16" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><ul>
<li>Access token &#x3D; permissions for APIs (authorization)</li>
<li>ID token &#x3D; identity info about the user (authentication)</li>
</ul>
<p>APIs should ignore ID tokens.</p>
<hr>
<h1 id="18-How-do-you-restrict-which-scopes-a-client-may-request"><a href="#18-How-do-you-restrict-which-scopes-a-client-may-request" class="headerlink" title="18. How do you restrict which scopes a client may request?"></a><strong>18. How do you restrict which scopes a client may request?</strong></h1><h3 id="Answer-17"><a href="#Answer-17" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Use <strong>Client Scopes</strong>:</p>
<ul>
<li>Default client scopes</li>
<li>Optional client scopes</li>
<li>Protocol mappers to include additional claims</li>
<li>Scope parameter to control token content</li>
</ul>
<p>This prevents over-privileged tokens.</p>
<hr>
<h1 id="19-What-is-the-Keycloak-Token-Exchange"><a href="#19-What-is-the-Keycloak-Token-Exchange" class="headerlink" title="19. What is the Keycloak Token Exchange?"></a><strong>19. What is the Keycloak Token Exchange?</strong></h1><h3 id="Answer-18"><a href="#Answer-18" class="headerlink" title="Answer:"></a><strong>Answer:</strong></h3><p>Allows exchanging one token for another.<br>Use cases:</p>
<ul>
<li>service-to-service delegation</li>
<li>switching realms</li>
<li>getting a token for another client</li>
<li>impersonation workflows</li>
</ul>
<p>Powerful in microservice architectures.</p>
<hr>
<h1 id="20-How-do-you-debug-token-validation-issues"><a href="#20-How-do-you-debug-token-validation-issues" class="headerlink" title="20. How do you debug token validation issues?"></a><strong>20. How do you debug token validation issues?</strong></h1><h3 id="Steps-to-answer"><a href="#Steps-to-answer" class="headerlink" title="Steps to answer:"></a><strong>Steps to answer:</strong></h3><ol>
<li>Decode token using JWT.io</li>
<li>Verify issuer (iss) matches realm</li>
<li>Confirm audience (aud) includes client ID</li>
<li>Check signature using JWKS</li>
<li>Check token expiration</li>
<li>Check scope&#x2F;roles included</li>
</ol>
<p>Most validation failures come from misconfigured <code>issuer-uri</code> or missing mappers.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
