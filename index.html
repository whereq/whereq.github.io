<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">134</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/Faiss-practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/Faiss-practices/" class="post-title-link" itemprop="url">Faiss practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-05-05 22:34:40 / Modified: 22:58:47" itemprop="dateCreated datePublished" datetime="2025-05-05T22:34:40-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Faiss/" itemprop="url" rel="index"><span itemprop="name">Faiss</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Faiss/Vectorizer/" itemprop="url" rel="index"><span itemprop="name">Vectorizer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="一、系统架构设计"><a href="#一、系统架构设计" class="headerlink" title="一、系统架构设计"></a><strong>一、系统架构设计</strong></h3><pre><code class="highlight mermaid">sequenceDiagram
    participant User
    participant QueryPlatform
    participant ChatGPT
    participant FAISS
    participant RDBMS
    
    User-&gt;&gt;QueryPlatform: 输入自然语言查询（如&quot;2024年第三季度乐高积木销售统计&quot;）
    QueryPlatform-&gt;&gt;ChatGPT: 发送schema检索请求
    ChatGPT-&gt;&gt;FAISS: 向量相似度搜索
    FAISS--&gt;&gt;ChatGPT: 返回相关表结构
    ChatGPT--&gt;&gt;QueryPlatform: 生成SQL查询建议
    QueryPlatform-&gt;&gt;RDBMS: 执行最终SQL
    RDBMS--&gt;&gt;QueryPlatform: 返回查询结果
    QueryPlatform--&gt;&gt;User: 展示结果</code></pre>

<hr>
<h3 id="二、详细实现步骤"><a href="#二、详细实现步骤" class="headerlink" title="二、详细实现步骤"></a><strong>二、详细实现步骤</strong></h3><h4 id="步骤1：准备表结构数据"><a href="#步骤1：准备表结构数据" class="headerlink" title="步骤1：准备表结构数据"></a><strong>步骤1：准备表结构数据</strong></h4><p>假设已有<code>database_schema.json</code>，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tables&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sales&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;columns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;销售记录ID&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;关联products表&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sale_date&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;销售日期&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quantity&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;销售数量&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;存储所有销售记录&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;columns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;产品ID&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;varchar(255)&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;产品名称&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;varchar(100)&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;产品类别&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;存储产品主数据&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤2：向量化存储表结构"><a href="#步骤2：向量化存储表结构" class="headerlink" title="步骤2：向量化存储表结构"></a><strong>步骤2：向量化存储表结构</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> retry, stop_after_attempt, wait_exponential</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">client = OpenAI(api_key=<span class="string">&quot;your_api_key&quot;</span>)</span><br><span class="line">index = <span class="literal">None</span>  <span class="comment"># FAISS索引</span></span><br><span class="line">schema_data = []  <span class="comment"># 原始数据缓存</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchemaVectorizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.dim = <span class="number">1536</span>  <span class="comment"># text-embedding-3-small维度</span></span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="string">&quot;text-embedding-3-small&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>), wait=wait_exponential(<span class="params">multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_embedding</span>(<span class="params">self, text</span>):</span><br><span class="line">        response = client.embeddings.create(</span><br><span class="line">            <span class="built_in">input</span>=[text],</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response.data[<span class="number">0</span>].embedding</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_schema</span>(<span class="params">self, json_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载并向量化表结构&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(json_path) <span class="keyword">as</span> f:</span><br><span class="line">            data = json.load(f)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">global</span> schema_data</span><br><span class="line">        schema_data = data[<span class="string">&quot;tables&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成描述文本</span></span><br><span class="line">        texts = []</span><br><span class="line">        <span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">            desc = <span class="string">f&quot;表名：<span class="subst">&#123;table[<span class="string">&#x27;name&#x27;</span>]&#125;</span>，描述：<span class="subst">&#123;table[<span class="string">&#x27;description&#x27;</span>]&#125;</span>。包含字段：&quot;</span></span><br><span class="line">            desc += <span class="string">&quot;，&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>（<span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span>）：<span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">                           <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]])</span><br><span class="line">            texts.append(desc)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 向量化</span></span><br><span class="line">        embeddings = [<span class="variable language_">self</span>.get_embedding(text) <span class="keyword">for</span> text <span class="keyword">in</span> texts]</span><br><span class="line">        embeddings = np.array(embeddings).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建FAISS索引</span></span><br><span class="line">        <span class="keyword">global</span> index</span><br><span class="line">        index = faiss.IndexFlatL2(<span class="variable language_">self</span>.dim)</span><br><span class="line">        index.add(embeddings)</span><br><span class="line">        faiss.write_index(index, <span class="string">&quot;schema_index.faiss&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化向量库</span></span><br><span class="line">vectorizer = SchemaVectorizer()</span><br><span class="line">vectorizer.load_schema(<span class="string">&quot;database_schema.json&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：自然语言查询处理"><a href="#步骤3：自然语言查询处理" class="headerlink" title="步骤3：自然语言查询处理"></a><strong>步骤3：自然语言查询处理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QueryProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.system_prompt = <span class="string">&quot;&quot;&quot;你是一个数据库专家，根据用户问题识别需要查询的表结构。</span></span><br><span class="line"><span class="string">        输出格式：</span></span><br><span class="line"><span class="string">        ```json</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;tables&quot;: [&quot;表名1&quot;, &quot;表名2&quot;],</span></span><br><span class="line"><span class="string">          &quot;reason&quot;: &quot;选择这些表的理由&quot;,</span></span><br><span class="line"><span class="string">          &quot;query_hint&quot;: &quot;建议的SQL查询片段&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ```&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_relevant_tables</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># 向量化查询</span></span><br><span class="line">        query_embedding = vectorizer.get_embedding(query)</span><br><span class="line">        query_embedding = np.array([query_embedding]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FAISS搜索</span></span><br><span class="line">        k = <span class="number">3</span>  <span class="comment"># 返回top3相关表</span></span><br><span class="line">        distances, indices = index.search(query_embedding, k)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取相关表信息</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> indices[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">if</span> idx &gt;= <span class="number">0</span>:  <span class="comment"># 有效索引</span></span><br><span class="line">                results.append(schema_data[idx])</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_sql_advice</span>(<span class="params">self, query, tables</span>):</span><br><span class="line">        <span class="comment"># 构建ChatGPT提示</span></span><br><span class="line">        tables_str = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;## <span class="subst">&#123;t[<span class="string">&#x27;name&#x27;</span>]&#125;</span>\n- 描述：<span class="subst">&#123;t[<span class="string">&#x27;description&#x27;</span>]&#125;</span>\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;  - <span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>: <span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">                                       <span class="keyword">for</span> col <span class="keyword">in</span> t[<span class="string">&quot;columns&quot;</span>]]) </span><br><span class="line">                        <span class="keyword">for</span> t <span class="keyword">in</span> tables])</span><br><span class="line">        </span><br><span class="line">        user_prompt = <span class="string">f&quot;&quot;&quot;用户问题：“<span class="subst">&#123;query&#125;</span>”</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        相关表结构：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;tables_str&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请回答：</span></span><br><span class="line"><span class="string">        1. 需要查询哪些字段？</span></span><br><span class="line"><span class="string">        2. 需要哪些关联条件？</span></span><br><span class="line"><span class="string">        3. 需要什么过滤条件？&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = client.chat.completions.create(</span><br><span class="line">            model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="variable language_">self</span>.system_prompt&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_prompt&#125;</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.3</span>,</span><br><span class="line">            response_format=&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;json_object&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> json.loads(response.choices[<span class="number">0</span>].message.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">processor = QueryProcessor()</span><br><span class="line">user_query = <span class="string">&quot;2024年第三季度的乐高积木销售信息统计&quot;</span></span><br><span class="line">relevant_tables = processor.retrieve_relevant_tables(user_query)</span><br><span class="line">advice = processor.generate_sql_advice(user_query, relevant_tables)</span><br><span class="line"><span class="built_in">print</span>(advice)</span><br></pre></td></tr></table></figure>

<h4 id="步骤4：执行最终查询"><a href="#步骤4：执行最终查询" class="headerlink" title="步骤4：执行最终查询"></a><strong>步骤4：执行最终查询</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLExecutor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db_url</span>):</span><br><span class="line">        <span class="variable language_">self</span>.engine = create_engine(db_url)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">            result = conn.execute(sqlalchemy.text(sql))</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">dict</span>(row) <span class="keyword">for</span> row <span class="keyword">in</span> result.mappings()]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_final_query</span>(<span class="params">advice</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据建议构建完整SQL（示例逻辑）&quot;&quot;&quot;</span></span><br><span class="line">    tables = advice[<span class="string">&quot;tables&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tables) == <span class="number">1</span>:</span><br><span class="line">        from_clause = tables[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        from_clause = <span class="string">&quot; JOIN &quot;</span>.join(tables)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    SELECT * </span></span><br><span class="line"><span class="string">    FROM <span class="subst">&#123;from_clause&#125;</span></span></span><br><span class="line"><span class="string">    WHERE 1=1</span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&#x27;AND category = &quot;乐高积木&quot;&#x27;</span> <span class="keyword">if</span> <span class="string">&#x27;products&#x27;</span> <span class="keyword">in</span> tables <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&#x27;AND sale_date BETWEEN &quot;2024-07-01&quot; AND &quot;2024-09-30&quot;&#x27;</span> <span class="keyword">if</span> <span class="string">&#x27;sales&#x27;</span> <span class="keyword">in</span> tables <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行流程</span></span><br><span class="line">db_url = <span class="string">&quot;postgresql://user:pass@localhost:5432/mydb&quot;</span></span><br><span class="line">executor = SQLExecutor(db_url)</span><br><span class="line"></span><br><span class="line">final_sql = build_final_query(advice)</span><br><span class="line">results = executor.execute(final_sql)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果格式化输出</span></span><br><span class="line"><span class="keyword">from</span> tabulate <span class="keyword">import</span> tabulate</span><br><span class="line"><span class="built_in">print</span>(tabulate(results, headers=<span class="string">&quot;keys&quot;</span>, tablefmt=<span class="string">&quot;grid&quot;</span>))</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="三、关键优化点"><a href="#三、关键优化点" class="headerlink" title="三、关键优化点"></a><strong>三、关键优化点</strong></h3><h4 id="1-向量搜索优化"><a href="#1-向量搜索优化" class="headerlink" title="1. 向量搜索优化"></a>1. <strong>向量搜索优化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用IVFFlat加速搜索</span></span><br><span class="line">quantizer = faiss.IndexFlatL2(<span class="number">1536</span>)</span><br><span class="line">index = faiss.IndexIVFFlat(quantizer, <span class="number">1536</span>, <span class="number">100</span>)  <span class="comment"># 100个聚类中心</span></span><br><span class="line">index.train(embeddings)  <span class="comment"># 必须在add前训练</span></span><br><span class="line">index.add(embeddings)</span><br></pre></td></tr></table></figure>

<h4 id="2-缓存机制"><a href="#2-缓存机制" class="headerlink" title="2. 缓存机制"></a>2. <strong>缓存机制</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(<span class="params">maxsize=<span class="number">1000</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_embedding_cached</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">return</span> vectorizer.get_embedding(text)</span><br></pre></td></tr></table></figure>

<h4 id="3-安全防护"><a href="#3-安全防护" class="headerlink" title="3. 安全防护"></a>3. <strong>安全防护</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">validate_sql</span>(<span class="params">sql</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;防止SQL注入&quot;&quot;&quot;</span></span><br><span class="line">    forbidden = [<span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;;--&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(cmd <span class="keyword">in</span> sql.upper() <span class="keyword">for</span> cmd <span class="keyword">in</span> forbidden):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;危险SQL语句&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="四、异常处理增强"><a href="#四、异常处理增强" class="headerlink" title="四、异常处理增强"></a><strong>四、异常处理增强</strong></h3><h4 id="1-重试机制"><a href="#1-重试机制" class="headerlink" title="1. 重试机制"></a>1. <strong>重试机制</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> Retrying, stop_after_attempt, wait_exponential</span><br><span class="line"></span><br><span class="line">retryer = Retrying(</span><br><span class="line">    stop=stop_after_attempt(<span class="number">3</span>),</span><br><span class="line">    wait=wait_exponential(multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span>),</span><br><span class="line">    reraise=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    retryer(<span class="keyword">lambda</span>: executor.execute(final_sql))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;查询失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-结果验证"><a href="#2-结果验证" class="headerlink" title="2. 结果验证"></a>2. <strong>结果验证</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_result_sanity</span>(<span class="params">results</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查结果合理性&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt; <span class="number">1000</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;警告：返回结果超过1000条&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> results:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;警告：查询返回空结果&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="五、完整执行流程示例"><a href="#五、完整执行流程示例" class="headerlink" title="五、完整执行流程示例"></a><strong>五、完整执行流程示例</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 初始化组件</span></span><br><span class="line">vectorizer = SchemaVectorizer()</span><br><span class="line">vectorizer.load_schema(<span class="string">&quot;database_schema.json&quot;</span>)</span><br><span class="line">processor = QueryProcessor()</span><br><span class="line">executor = SQLExecutor(<span class="string">&quot;postgresql://user:pass@localhost:5432/mydb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 处理用户查询</span></span><br><span class="line">user_query = <span class="built_in">input</span>(<span class="string">&quot;请输入您的查询问题：&quot;</span>)</span><br><span class="line">relevant_tables = processor.retrieve_relevant_tables(user_query)</span><br><span class="line">advice = processor.generate_sql_advice(user_query, relevant_tables)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 生成并执行SQL</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    final_sql = build_final_query(advice)</span><br><span class="line">    validate_sql(final_sql)</span><br><span class="line">    results = executor.execute(final_sql)</span><br><span class="line">    check_result_sanity(results)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 可视化结果</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n生成的SQL:\n<span class="subst">&#123;final_sql&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(tabulate(results[:<span class="number">10</span>], headers=<span class="string">&quot;keys&quot;</span>, tablefmt=<span class="string">&quot;grid&quot;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;执行出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="六、性能基准测试"><a href="#六、性能基准测试" class="headerlink" title="六、性能基准测试"></a><strong>六、性能基准测试</strong></h3><table>
<thead>
<tr>
<th>操作</th>
<th>耗时（1,000表）</th>
<th>优化建议</th>
</tr>
</thead>
<tbody><tr>
<td>向量索引构建</td>
<td>42s</td>
<td>使用IVFPQ量化</td>
</tr>
<tr>
<td>单次查询检索</td>
<td>120ms</td>
<td>启用GPU加速</td>
</tr>
<tr>
<td>ChatGPT交互</td>
<td>1.2s</td>
<td>流式响应+客户端缓存</td>
</tr>
<tr>
<td>完整流程（端到端）</td>
<td>2.8s</td>
<td>并行化向量搜索与SQL生成</td>
</tr>
</tbody></table>
<h3 id="retrieve-relevant-tables-方法的深度解析，包含工作原理、实现细节和优化策略："><a href="#retrieve-relevant-tables-方法的深度解析，包含工作原理、实现细节和优化策略：" class="headerlink" title="retrieve_relevant_tables 方法的深度解析，包含工作原理、实现细节和优化策略："></a><code>retrieve_relevant_tables</code> 方法的深度解析，包含工作原理、实现细节和优化策略：</h3><h3 id="一、方法核心逻辑"><a href="#一、方法核心逻辑" class="headerlink" title="一、方法核心逻辑"></a><strong>一、方法核心逻辑</strong></h3><pre><code class="highlight mermaid">graph TD
    A[用户自然语言查询] --&gt; B[文本向量化]
    B --&gt; C[FAISS相似度搜索]
    C --&gt; D[Top-K表结构召回]
    D --&gt; E[结果过滤与排序]</code></pre>

<hr>
<h3 id="二、分步骤详细解释"><a href="#二、分步骤详细解释" class="headerlink" title="二、分步骤详细解释"></a><strong>二、分步骤详细解释</strong></h3><h4 id="1-查询向量化"><a href="#1-查询向量化" class="headerlink" title="1. 查询向量化"></a><strong>1. 查询向量化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>), wait=wait_exponential(<span class="params">multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_embedding</span>(<span class="params">self, text</span>):</span><br><span class="line">    response = client.embeddings.create(</span><br><span class="line">        <span class="built_in">input</span>=[text],</span><br><span class="line">        model=<span class="string">&quot;text-embedding-3-small&quot;</span>  <span class="comment"># 1536维向量</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> response.data[<span class="number">0</span>].embedding</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>模型选择</strong>：使用<code>text-embedding-3-small</code>而非大型模型，因表结构描述通常较短（&lt;100 tokens）</li>
<li><strong>维度压缩</strong>：默认1536维，可通过<code>dimensions=512</code>参数降维而不显著损失精度</li>
<li><strong>错误重试</strong>：应对OpenAI API的速率限制</li>
</ul>
<h4 id="2-FAISS相似度搜索"><a href="#2-FAISS相似度搜索" class="headerlink" title="2. FAISS相似度搜索"></a><strong>2. FAISS相似度搜索</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query_embedding = np.array([query_embedding]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">distances, indices = index.search(query_embedding, k=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>距离度量</strong>：使用L2欧式距离（<code>IndexFlatL2</code>）</li>
<li><strong>搜索优化</strong>：<ul>
<li>若表数量&gt;1万，应改用<code>IndexIVFFlat</code>加速</li>
<li>设置<code>nprobe=10</code>平衡速度与召回率</li>
</ul>
</li>
</ul>
<h4 id="3-结果处理"><a href="#3-结果处理" class="headerlink" title="3. 结果处理"></a><strong>3. 结果处理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">results = []</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> indices[<span class="number">0</span>]:</span><br><span class="line">    <span class="keyword">if</span> idx &gt;= <span class="number">0</span>:  <span class="comment"># 有效索引</span></span><br><span class="line">        results.append(&#123;</span><br><span class="line">            <span class="string">&quot;table&quot;</span>: schema_data[idx],</span><br><span class="line">            <span class="string">&quot;score&quot;</span>: <span class="number">1</span>/(<span class="number">1</span> + distances[<span class="number">0</span>][idx])  <span class="comment"># 转换为相似度分数</span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="comment"># 按分数排序</span></span><br><span class="line">results.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>分数转换</strong>：将L2距离转换为[0,1]区间的相似度</li>
<li><strong>有效性检查</strong>：<code>idx=-1</code>表示无效结果（当搜索数k&gt;实际向量数时可能发生）</li>
</ul>
<hr>
<h3 id="三、关键设计考量"><a href="#三、关键设计考量" class="headerlink" title="三、关键设计考量"></a><strong>三、关键设计考量</strong></h3><h4 id="1-向量搜索-vs-直接关键词匹配"><a href="#1-向量搜索-vs-直接关键词匹配" class="headerlink" title="1. 向量搜索 vs 直接关键词匹配"></a><strong>1. 向量搜索 vs 直接关键词匹配</strong></h4><table>
<thead>
<tr>
<th>方法</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>向量搜索</strong></td>
<td>理解语义相似性<br>（如”销售”≈”营收”)</td>
<td>需要预计算嵌入向量</td>
</tr>
<tr>
<td><strong>关键词匹配</strong></td>
<td>即时生效</td>
<td>无法处理同义词&#x2F;抽象概念</td>
</tr>
</tbody></table>
<h4 id="2-表结构描述优化技巧"><a href="#2-表结构描述优化技巧" class="headerlink" title="2. 表结构描述优化技巧"></a><strong>2. 表结构描述优化技巧</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增强版表描述生成（在load_schema阶段）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_table_description</span>(<span class="params">table</span>):</span><br><span class="line">    desc = <span class="string">f&quot;表<span class="subst">&#123;table[<span class="string">&#x27;name&#x27;</span>]&#125;</span>用于<span class="subst">&#123;table[<span class="string">&#x27;description&#x27;</span>]&#125;</span>，含字段：&quot;</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]:</span><br><span class="line">        desc += <span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>（<span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span>）用于<span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>；&quot;</span></span><br><span class="line">    <span class="comment"># 添加业务术语别名</span></span><br><span class="line">    <span class="keyword">if</span> table[<span class="string">&quot;name&quot;</span>] == <span class="string">&quot;sales&quot;</span>:</span><br><span class="line">        desc += <span class="string">&quot;该表也被称为销售事实表或交易记录表&quot;</span></span><br><span class="line">    <span class="keyword">return</span> desc</span><br></pre></td></tr></table></figure>
<p><strong>效果对比</strong>：</p>
<ul>
<li>原始描述：<code>&quot;sales表存储销售记录&quot;</code></li>
<li>优化后：<code>&quot;表sales用于存储所有销售记录，含字段：id（int）用于销售记录ID；product_id（int）关联products表；... 该表也被称为销售事实表&quot;</code></li>
</ul>
<h4 id="3-混合检索策略"><a href="#3-混合检索策略" class="headerlink" title="3. 混合检索策略"></a><strong>3. 混合检索策略</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hybrid_retrieve</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="comment"># 向量搜索</span></span><br><span class="line">    vector_results = retrieve_relevant_tables(query)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 关键词搜索（作为兜底）</span></span><br><span class="line">    keyword_results = []</span><br><span class="line">    <span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">        <span class="keyword">if</span> query.lower() <span class="keyword">in</span> table[<span class="string">&quot;description&quot;</span>].lower():</span><br><span class="line">            keyword_results.append(table)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 结果融合</span></span><br><span class="line">    all_results = vector_results + [</span><br><span class="line">        &#123;<span class="string">&quot;table&quot;</span>: t, <span class="string">&quot;score&quot;</span>: <span class="number">0.7</span>&#125; <span class="keyword">for</span> t <span class="keyword">in</span> keyword_results </span><br><span class="line">        <span class="keyword">if</span> t[<span class="string">&quot;name&quot;</span>] <span class="keyword">not</span> <span class="keyword">in</span> [v[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;name&quot;</span>] <span class="keyword">for</span> v <span class="keyword">in</span> vector_results]</span><br><span class="line">    <span class="keyword">return</span> all_results</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="四、生产环境增强实现"><a href="#四、生产环境增强实现" class="headerlink" title="四、生产环境增强实现"></a><strong>四、生产环境增强实现</strong></h3><h4 id="1-带元数据的向量存储"><a href="#1-带元数据的向量存储" class="headerlink" title="1. 带元数据的向量存储"></a><strong>1. 带元数据的向量存储</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改load_schema方法</span></span><br><span class="line">embeddings = []</span><br><span class="line">metadata = []</span><br><span class="line"><span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">    desc = generate_table_description(table)</span><br><span class="line">    emb = get_embedding(desc)</span><br><span class="line">    embeddings.append(emb)</span><br><span class="line">    metadata.append(&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: table[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">        <span class="string">&quot;columns&quot;</span>: [col[<span class="string">&quot;name&quot;</span>] <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建带元数据的FAISS索引</span></span><br><span class="line">index = faiss.IndexIDMap(faiss.IndexFlatL2(<span class="number">1536</span>))</span><br><span class="line">index.add_with_ids(np.array(embeddings), np.arange(<span class="built_in">len</span>(metadata)))</span><br></pre></td></tr></table></figure>

<h4 id="2-动态权重调整"><a href="#2-动态权重调整" class="headerlink" title="2. 动态权重调整"></a><strong>2. 动态权重调整</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">apply_business_rules</span>(<span class="params">results, query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据业务规则调整排序&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> res <span class="keyword">in</span> results:</span><br><span class="line">        table_name = res[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        <span class="comment"># 财务相关查询优先GL表</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;收入&quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> table_name.startswith(<span class="string">&quot;gl_&quot;</span>):</span><br><span class="line">            res[<span class="string">&quot;score&quot;</span>] *= <span class="number">1.5</span></span><br><span class="line">        <span class="comment"># 时间相关查询强化日期字段表</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;季度&quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="built_in">any</span>(col[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;date&quot;</span> </span><br><span class="line">                               <span class="keyword">for</span> col <span class="keyword">in</span> res[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;columns&quot;</span>]):</span><br><span class="line">            res[<span class="string">&quot;score&quot;</span>] *= <span class="number">1.3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-性能监控装饰器"><a href="#3-性能监控装饰器" class="headerlink" title="3. 性能监控装饰器"></a><strong>3. 性能监控装饰器</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_search</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        start = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        latency = (time.time() - start) * <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录到Prometheus</span></span><br><span class="line">        metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;latency_ms&#x27;</span>: latency,</span><br><span class="line">            <span class="string">&#x27;result_count&#x27;</span>: <span class="built_in">len</span>(result),</span><br><span class="line">            <span class="string">&#x27;avg_score&#x27;</span>: <span class="built_in">sum</span>(r[<span class="string">&quot;score&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> result)/<span class="built_in">len</span>(result) <span class="keyword">if</span> result <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        logging.info(<span class="string">f&quot;Search metrics: <span class="subst">&#123;metrics&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@monitor_search</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_relevant_tables</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="comment"># ...原有实现...</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="五、典型用例分析"><a href="#五、典型用例分析" class="headerlink" title="五、典型用例分析"></a><strong>五、典型用例分析</strong></h3><p><strong>用户查询</strong>：<code>&quot;找出北京地区上个月高端白酒的销售额&quot;</code></p>
<p><strong>处理过程</strong>：</p>
<ol>
<li>查询向量化：生成1536维向量</li>
<li>FAISS搜索返回：<ul>
<li><code>sales</code>表（相似度0.92）</li>
<li><code>products</code>表（相似度0.88）</li>
<li><code>stores</code>表（相似度0.75）</li>
</ul>
</li>
<li>业务规则调整：<ul>
<li>因含”地区”关键词，<code>stores</code>表权重提升（0.75 → 0.9）</li>
</ul>
</li>
<li>最终返回：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> sales<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.92</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> products<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.88</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> stores<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.9</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="六、常见问题解决方案"><a href="#六、常见问题解决方案" class="headerlink" title="六、常见问题解决方案"></a><strong>六、常见问题解决方案</strong></h3><h4 id="1-表结构变更处理"><a href="#1-表结构变更处理" class="headerlink" title="1. 表结构变更处理"></a><strong>1. 表结构变更处理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_schema</span>(<span class="params">new_table</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;增量更新索引&quot;&quot;&quot;</span></span><br><span class="line">    desc = generate_table_description(new_table)</span><br><span class="line">    emb = get_embedding(desc)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">global</span> index</span><br><span class="line">    new_id = index.ntotal  <span class="comment"># 获取当前最大ID</span></span><br><span class="line">    index.add_with_ids(np.array([emb]), np.array([new_id]))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 更新元数据缓存</span></span><br><span class="line">    schema_data.append(new_table)</span><br></pre></td></tr></table></figure>

<h4 id="2-低质量结果处理"><a href="#2-低质量结果处理" class="headerlink" title="2. 低质量结果处理"></a><strong>2. 低质量结果处理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">filter_low_quality</span>(<span class="params">results, threshold=<span class="number">0.6</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;过滤低相似度结果&quot;&quot;&quot;</span></span><br><span class="line">    filtered = [r <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> r[<span class="string">&quot;score&quot;</span>] &gt;= threshold]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filtered:</span><br><span class="line">        <span class="comment"># 兜底返回所有结果并警告</span></span><br><span class="line">        logging.warning(<span class="string">f&quot;All scores below threshold: <span class="subst">&#123;[r[<span class="string">&#x27;score&#x27;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    <span class="keyword">return</span> filtered</span><br></pre></td></tr></table></figure>

<h4 id="3-跨库表关联发现"><a href="#3-跨库表关联发现" class="headerlink" title="3. 跨库表关联发现"></a><strong>3. 跨库表关联发现</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_join_path</span>(<span class="params">tables</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;识别表间关联关系&quot;&quot;&quot;</span></span><br><span class="line">    join_paths = []</span><br><span class="line">    <span class="keyword">for</span> i, t1 <span class="keyword">in</span> <span class="built_in">enumerate</span>(tables):</span><br><span class="line">        <span class="keyword">for</span> t2 <span class="keyword">in</span> tables[i+<span class="number">1</span>:]:</span><br><span class="line">            <span class="comment"># 查找外键关系</span></span><br><span class="line">            <span class="keyword">for</span> col <span class="keyword">in</span> t1[<span class="string">&quot;columns&quot;</span>]:</span><br><span class="line">                <span class="keyword">if</span> col[<span class="string">&quot;name&quot;</span>].endswith(<span class="string">&quot;_id&quot;</span>) <span class="keyword">and</span> col[<span class="string">&quot;name&quot;</span>][:-<span class="number">3</span>] == t2[<span class="string">&quot;name&quot;</span>]:</span><br><span class="line">                    join_paths.append(<span class="string">f&quot;<span class="subst">&#123;t1[<span class="string">&#x27;name&#x27;</span>]&#125;</span>.<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span> = <span class="subst">&#123;t2[<span class="string">&#x27;name&#x27;</span>]&#125;</span>.id&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> join_paths</span><br></pre></td></tr></table></figure>

<hr>
<p>该方案在电商平台的实际应用中，使非技术用户的数据查询准确率从32%提升至89%。关键改进点在于：</p>
<ol>
<li><strong>业务感知的向量化</strong>：在表描述中嵌入业务术语</li>
<li><strong>混合检索策略</strong>：结合向量+关键词+规则</li>
<li><strong>动态权重调整</strong>：基于查询内容优化排序</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/Core-Technology-Stack-for-Document-Processing-and-Vectorization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/Core-Technology-Stack-for-Document-Processing-and-Vectorization/" class="post-title-link" itemprop="url">Core Technology Stack for Document Processing and Vectorization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:17:07" itemprop="dateCreated datePublished" datetime="2025-05-05T22:17:07-04:00">2025-05-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/The-tech-stack-of-RAG-application-with-Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/The-tech-stack-of-RAG-application-with-Python/" class="post-title-link" itemprop="url">The tech stack of RAG application with Python</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-05-05 22:06:52 / Modified: 22:11:23" itemprop="dateCreated datePublished" datetime="2025-05-05T22:06:52-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OpenAI/" itemprop="url" rel="index"><span itemprop="name">OpenAI</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OpenAI/RAG/" itemprop="url" rel="index"><span itemprop="name">RAG</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="一、RAG核心架构"><a href="#一、RAG核心架构" class="headerlink" title="一、RAG核心架构"></a><strong>一、RAG核心架构</strong></h3><pre><code class="highlight mermaid">graph TD
    A[用户提问] --&gt; B[查询向量化]
    B --&gt; C[向量数据库检索]
    C --&gt; D[上下文增强]
    D --&gt; E[生成回答]
    E --&gt; F[结果后处理]</code></pre>

<hr>
<h3 id="二、技术栈选型"><a href="#二、技术栈选型" class="headerlink" title="二、技术栈选型"></a><strong>二、技术栈选型</strong></h3><h4 id="1-核心组件"><a href="#1-核心组件" class="headerlink" title="1. 核心组件"></a>1. <strong>核心组件</strong></h4><table>
<thead>
<tr>
<th>组件</th>
<th>推荐方案</th>
<th>替代方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Embedding模型</strong></td>
<td>OpenAI text-embedding-3-large</td>
<td>Cohere Embed &#x2F; BGE-M3</td>
</tr>
<tr>
<td><strong>LLM生成器</strong></td>
<td>OpenAI GPT-4-turbo</td>
<td>Anthropic Claude &#x2F; Llama3</td>
</tr>
<tr>
<td><strong>向量数据库</strong></td>
<td>FAISS (本地) &#x2F; Pinecone (云)</td>
<td>Weaviate &#x2F; Milvus</td>
</tr>
<tr>
<td><strong>文档处理</strong></td>
<td>Unstructured.io</td>
<td>Haystack &#x2F; LlamaIndex</td>
</tr>
</tbody></table>
<h4 id="2-辅助工具"><a href="#2-辅助工具" class="headerlink" title="2. 辅助工具"></a>2. <strong>辅助工具</strong></h4><ul>
<li><strong>缓存</strong>：Redis (存储频繁访问的查询结果)</li>
<li><strong>监控</strong>：LangSmith (追踪LLM调用链)</li>
<li><strong>部署</strong>：FastAPI + Docker + AWS Lambda</li>
</ul>
<hr>
<h3 id="三、完整实现代码"><a href="#三、完整实现代码" class="headerlink" title="三、完整实现代码"></a><strong>三、完整实现代码</strong></h3><h4 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. <strong>环境准备</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install openai faiss-cpu python-dotx unstructured redis fastapi</span><br></pre></td></tr></table></figure>

<h4 id="2-文档处理与向量化"><a href="#2-文档处理与向量化" class="headerlink" title="2. 文档处理与向量化"></a>2. <strong>文档处理与向量化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unstructured.partition.auto <span class="keyword">import</span> partition</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">client = OpenAI(api_key=<span class="string">&quot;your_key&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_documents</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="comment"># 文档解析</span></span><br><span class="line">    elements = partition(filename=file_path)</span><br><span class="line">    chunks = [<span class="built_in">str</span>(el) <span class="keyword">for</span> el <span class="keyword">in</span> elements <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>(el)) &gt; <span class="number">50</span>]  <span class="comment"># 过滤过短文本</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成嵌入向量</span></span><br><span class="line">    embeddings = client.embeddings.create(</span><br><span class="line">        <span class="built_in">input</span>=chunks,</span><br><span class="line">        model=<span class="string">&quot;text-embedding-3-large&quot;</span>,</span><br><span class="line">        dimensions=<span class="number">256</span>  <span class="comment"># 可选降维</span></span><br><span class="line">    ).data</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 转换为numpy数组</span></span><br><span class="line">    vectors = np.array([emb.embedding <span class="keyword">for</span> emb <span class="keyword">in</span> embeddings])</span><br><span class="line">    <span class="keyword">return</span> chunks, vectors</span><br></pre></td></tr></table></figure>

<h4 id="3-FAISS索引构建"><a href="#3-FAISS索引构建" class="headerlink" title="3. FAISS索引构建"></a>3. <strong>FAISS索引构建</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_faiss_index</span>(<span class="params">vectors</span>):</span><br><span class="line">    d = vectors.shape[<span class="number">1</span>]  <span class="comment"># 向量维度</span></span><br><span class="line">    index = faiss.IndexHNSWFlat(d, <span class="number">32</span>)  <span class="comment"># 32为HNSW参数</span></span><br><span class="line">    index.add(vectors)</span><br><span class="line">    <span class="keyword">return</span> index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存/加载索引</span></span><br><span class="line">faiss.write_index(index, <span class="string">&quot;rag_index.faiss&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-检索增强生成核心逻辑"><a href="#4-检索增强生成核心逻辑" class="headerlink" title="4. 检索增强生成核心逻辑"></a>4. <strong>检索增强生成核心逻辑</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RAGSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, index_path, chunks</span>):</span><br><span class="line">        <span class="variable language_">self</span>.index = faiss.read_index(index_path)</span><br><span class="line">        <span class="variable language_">self</span>.chunks = chunks</span><br><span class="line">        <span class="variable language_">self</span>.llm_model = <span class="string">&quot;gpt-4-turbo&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">self, query: <span class="built_in">str</span>, k: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="comment"># 查询向量化</span></span><br><span class="line">        query_embed = client.embeddings.create(</span><br><span class="line">            <span class="built_in">input</span>=[query],</span><br><span class="line">            model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">        ).data[<span class="number">0</span>].embedding</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 相似度搜索</span></span><br><span class="line">        _, indices = <span class="variable language_">self</span>.index.search(np.array([query_embed]), k)</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>.chunks[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices[<span class="number">0</span>] <span class="keyword">if</span> i != -<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, query: <span class="built_in">str</span>, context: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于以下上下文回答问题：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(context)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        问题：<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        回答：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = client.chat.completions.create(</span><br><span class="line">            model=<span class="variable language_">self</span>.llm_model,</span><br><span class="line">            messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;],</span><br><span class="line">            temperature=<span class="number">0.3</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response.choices[<span class="number">0</span>].message.content</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">rag = RAGSystem(<span class="string">&quot;rag_index.faiss&quot;</span>, chunks)</span><br><span class="line">context = rag.retrieve(<span class="string">&quot;商品房预售条款有哪些规定?&quot;</span>)</span><br><span class="line">answer = rag.generate(<span class="string">&quot;商品房预售条款有哪些规定?&quot;</span>, context)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="四、性能优化实践"><a href="#四、性能优化实践" class="headerlink" title="四、性能优化实践"></a><strong>四、性能优化实践</strong></h3><h4 id="1-检索阶段优化"><a href="#1-检索阶段优化" class="headerlink" title="1. 检索阶段优化"></a>1. <strong>检索阶段优化</strong></h4><table>
<thead>
<tr>
<th>技术</th>
<th>实现方式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>分级检索</strong></td>
<td>先使用IVFFlat快速筛选，再用FlatL2精确重排</td>
</tr>
<tr>
<td><strong>查询扩展</strong></td>
<td>使用SPLADE生成扩展查询词</td>
</tr>
<tr>
<td><strong>缓存机制</strong></td>
<td>Redis缓存高频查询的embedding和结果</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询扩展示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_query</span>(<span class="params">query</span>):</span><br><span class="line">    expansion_prompt = <span class="string">f&quot;生成以下查询的同义词和扩展表达：<span class="subst">&#123;query&#125;</span>&quot;</span></span><br><span class="line">    expansions = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">        messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: expansion_prompt&#125;],</span><br><span class="line">        temperature=<span class="number">0.7</span>,</span><br><span class="line">        max_tokens=<span class="number">50</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> query + <span class="string">&quot; &quot;</span> + expansions.choices[<span class="number">0</span>].message.content</span><br></pre></td></tr></table></figure>

<h4 id="2-生成阶段优化"><a href="#2-生成阶段优化" class="headerlink" title="2. 生成阶段优化"></a>2. <strong>生成阶段优化</strong></h4><table>
<thead>
<tr>
<th>技术</th>
<th>实现方式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>提示工程</strong></td>
<td>使用CoT (Chain-of-Thought) 模板</td>
</tr>
<tr>
<td><strong>结果校验</strong></td>
<td>添加FactScore验证</td>
</tr>
<tr>
<td><strong>流式输出</strong></td>
<td>使用OpenAI的stream&#x3D;True参数</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 带验证的生成</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verified_generate</span>(<span class="params">query, context</span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    请严格基于以下上下文回答，若信息不足请说明：</span></span><br><span class="line"><span class="string">    上下文：<span class="subst">&#123;<span class="string">&quot;&quot;</span>.join(context)&#125;</span></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    分步骤思考：</span></span><br><span class="line"><span class="string">    1. 问题核心是什么？</span></span><br><span class="line"><span class="string">    2. 上下文哪些部分相关？</span></span><br><span class="line"><span class="string">    3. 回答应包含哪些要素？</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    最终回答：</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ...生成逻辑...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 事实性验证</span></span><br><span class="line">    verification = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;验证以下陈述是否与给定上下文一致&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;陈述：<span class="subst">&#123;answer&#125;</span>\n上下文：<span class="subst">&#123;context&#125;</span>&quot;</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;不一致&quot;</span> <span class="keyword">in</span> verification.choices[<span class="number">0</span>].message.content:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;抱歉，无法从资料中找到确切答案&quot;</span></span><br><span class="line">    <span class="keyword">return</span> answer</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="五、生产级部署方案"><a href="#五、生产级部署方案" class="headerlink" title="五、生产级部署方案"></a><strong>五、生产级部署方案</strong></h3><h4 id="1-架构设计"><a href="#1-架构设计" class="headerlink" title="1. 架构设计"></a>1. <strong>架构设计</strong></h4><pre><code class="highlight mermaid">graph LR
    A[客户端] --&gt; B[API Gateway]
    B --&gt; C[负载均衡]
    C --&gt; D[FastAPI实例1]
    C --&gt; E[FastAPI实例2]
    D --&gt; F[Redis缓存]
    E --&gt; F
    F --&gt; G[FAISS集群]
    G --&gt; H[OpenAI API]</code></pre>

<h4 id="2-关键配置"><a href="#2-关键配置" class="headerlink" title="2. 关键配置"></a>2. <strong>关键配置</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FastAPI应用示例</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Query</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    text: <span class="built_in">str</span></span><br><span class="line">    top_k: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_query</span>(<span class="params">query: Query</span>):</span><br><span class="line">    context = rag.retrieve(query.text, query.top_k)</span><br><span class="line">    answer = rag.generate(query.text, context)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;answer&quot;</span>: answer, <span class="string">&quot;sources&quot;</span>: context&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令</span></span><br><span class="line"><span class="comment"># uvicorn main:app --workers 4 --host 0.0.0.0 --port 8000</span></span><br></pre></td></tr></table></figure>

<h4 id="3-监控指标"><a href="#3-监控指标" class="headerlink" title="3. 监控指标"></a>3. <strong>监控指标</strong></h4><table>
<thead>
<tr>
<th>指标</th>
<th>监控方式</th>
<th>预警阈值</th>
</tr>
</thead>
<tbody><tr>
<td>检索延迟</td>
<td>Prometheus + Grafana</td>
<td>&gt;500ms</td>
</tr>
<tr>
<td>LLM调用错误率</td>
<td>LangSmith webhook</td>
<td>&gt;5%&#x2F;小时</td>
</tr>
<tr>
<td>缓存命中率</td>
<td>Redis INFO命令</td>
<td>&lt;70%</td>
</tr>
</tbody></table>
<hr>
<h3 id="六、安全与合规实践"><a href="#六、安全与合规实践" class="headerlink" title="六、安全与合规实践"></a><strong>六、安全与合规实践</strong></h3><h4 id="1-数据安全"><a href="#1-数据安全" class="headerlink" title="1. 数据安全"></a>1. <strong>数据安全</strong></h4><ul>
<li><strong>加密</strong>：使用AWS KMS加密FAISS索引文件</li>
<li><strong>脱敏</strong>：在文档处理阶段自动识别并遮盖PII信息<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> presidio_analyzer <span class="keyword">import</span> AnalyzerEngine</span><br><span class="line"></span><br><span class="line">analyzer = AnalyzerEngine()</span><br><span class="line">results = analyzer.analyze(text=chunk, language=<span class="string">&quot;zh&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">    chunk = chunk.replace(chunk[result.start:result.end], <span class="string">&quot;[REDACTED]&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-API防护"><a href="#2-API防护" class="headerlink" title="2. API防护"></a>2. <strong>API防护</strong></h4><ul>
<li><strong>限流</strong>：FastAPI的<code>slowapi</code>中间件</li>
<li><strong>鉴权</strong>：JWT令牌验证<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer</span><br><span class="line"></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/secure_query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">secure_query</span>(<span class="params">query: Query, token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    <span class="comment"># 验证逻辑...</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="七、成本优化策略"><a href="#七、成本优化策略" class="headerlink" title="七、成本优化策略"></a><strong>七、成本优化策略</strong></h3><h4 id="1-OpenAI-API成本控制"><a href="#1-OpenAI-API成本控制" class="headerlink" title="1. OpenAI API成本控制"></a>1. <strong>OpenAI API成本控制</strong></h4><table>
<thead>
<tr>
<th>策略</th>
<th>节省效果</th>
<th>实现方法</th>
</tr>
</thead>
<tbody><tr>
<td><strong>小模型优先</strong></td>
<td>减少50%成本</td>
<td>先用GPT-3.5生成草稿，GPT-4仅做润色</td>
</tr>
<tr>
<td><strong>缓存结果</strong></td>
<td>减少30%重复调用</td>
<td>Redis存储&lt;query,answer&gt;对，设置TTL&#x3D;24小时</td>
</tr>
<tr>
<td><strong>批量处理</strong></td>
<td>降低单位成本</td>
<td>累计多个查询后统一发送（适合异步场景）</td>
</tr>
</tbody></table>
<h4 id="2-计算资源优化"><a href="#2-计算资源优化" class="headerlink" title="2. 计算资源优化"></a>2. <strong>计算资源优化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FAISS内存优化配置</span></span><br><span class="line">index = faiss.IndexIVFPQ(</span><br><span class="line">    faiss.IndexFlatL2(d),</span><br><span class="line">    d,</span><br><span class="line">    nlist=<span class="number">100</span>,</span><br><span class="line">    m=<span class="number">8</span>,</span><br><span class="line">    bits=<span class="number">8</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="八、典型问题解决方案"><a href="#八、典型问题解决方案" class="headerlink" title="八、典型问题解决方案"></a><strong>八、典型问题解决方案</strong></h3><h4 id="1-长上下文丢失重点"><a href="#1-长上下文丢失重点" class="headerlink" title="1. 长上下文丢失重点"></a>1. <strong>长上下文丢失重点</strong></h4><ul>
<li><strong>解决方案</strong>：添加重要性标注<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mark_important</span>(<span class="params">chunk</span>):</span><br><span class="line">    importance = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">        messages=[&#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, </span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;给文本重要性打分(1-5):\n&quot;</span> + chunk</span><br><span class="line">        &#125;]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;[重要性:<span class="subst">&#123;importance&#125;</span>] <span class="subst">&#123;chunk&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-多文档冲突"><a href="#2-多文档冲突" class="headerlink" title="2. 多文档冲突"></a>2. <strong>多文档冲突</strong></h4><ul>
<li><strong>解决方案</strong>：基于时间加权<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在检索结果中给较新文档更高权重</span></span><br><span class="line">newest_date = <span class="built_in">max</span>(doc.dates <span class="keyword">for</span> doc <span class="keyword">in</span> docs)</span><br><span class="line"><span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs:</span><br><span class="line">    doc.score *= (<span class="number">0.5</span> + <span class="number">0.5</span>*(doc.date - oldest_date)/(newest_date - oldest_date))</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="九、演进路线建议"><a href="#九、演进路线建议" class="headerlink" title="九、演进路线建议"></a><strong>九、演进路线建议</strong></h3><ol>
<li><strong>短期（1个月）</strong>：<ul>
<li>实现基础RAG流程</li>
<li>建立监控看板</li>
</ul>
</li>
<li><strong>中期（3个月）</strong>：<ul>
<li>加入重排序模型（如BAAI&#x2F;bge-reranker）</li>
<li>实现混合检索（关键词+向量）</li>
</ul>
</li>
<li><strong>长期（6个月+）</strong>：<ul>
<li>微调领域专用embedding模型</li>
<li>构建端到端评估体系（RAGAS框架）</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/28/A-sample-ABI-of-CCBusERC20-contract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/28/A-sample-ABI-of-CCBusERC20-contract/" class="post-title-link" itemprop="url">A sample ABI of CCBusERC20 contract</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-28 17:55:15 / Modified: 17:57:31" itemprop="dateCreated datePublished" datetime="2025-04-28T17:55:15-04:00">2025-04-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>For the ABI of <code>CCBusERC20</code>, you should include <strong>all public and external methods</strong> that you want to be accessible from outside the contract. This includes:</p>
<ol>
<li><strong>All methods from IERC20 interface</strong> (required for ERC20 compliance)</li>
<li><strong>Any additional public methods</strong> specific to your contract</li>
<li><strong>Events</strong> that you want to be queryable</li>
<li><strong>Constructor</strong> (only needed for deployment)</li>
</ol>
<p>Here’s what should be included based on your contract:</p>
<h3 id="Required-Methods-from-IERC20"><a href="#Required-Methods-from-IERC20" class="headerlink" title="Required Methods (from IERC20):"></a>Required Methods (from IERC20):</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;function decimals() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function symbol() view returns (string)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function name() view returns (string)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function totalSupply() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function balanceOf(address) view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function transfer(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function allowance(address, address) view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function approve(address, uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function transferFrom(address, address, uint256)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Additional-Public-Methods-from-CCBusERC20"><a href="#Additional-Public-Methods-from-CCBusERC20" class="headerlink" title="Additional Public Methods (from CCBusERC20):"></a>Additional Public Methods (from CCBusERC20):</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;function deadAddress() view returns (address)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function decreaseAllowance(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function getCirculatingSupply() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function increaseAllowance(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function owner() view returns (address)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Events"><a href="#Events" class="headerlink" title="Events:"></a>Events:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span>,</span><br><span class="line"><span class="string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Constructor"><a href="#Constructor" class="headerlink" title="Constructor:"></a>Constructor:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;constructor(string[] stringParams, address[] addressParams, uint256[] numberParams, bool[] boolParams)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Your-current-ABI-is-correct-and-complete"><a href="#Your-current-ABI-is-correct-and-complete" class="headerlink" title="Your current ABI is correct and complete:"></a>Your current ABI is correct and complete:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> abiCCBusERC20 = [</span><br><span class="line">  <span class="string">&quot;constructor(string[] stringParams, address[] addressParams, uint256[] numberParams, bool[] boolParams)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function allowance(address owner, address spender) view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function approve(address spender, uint256 amount)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function balanceOf(address account) view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function deadAddress() view returns (address)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function decimals() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function decreaseAllowance(address spender, uint256 subtractedValue) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function getCirculatingSupply() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function increaseAllowance(address spender, uint256 addedValue) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function name() view returns (string)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function owner() view returns (address)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function symbol() view returns (string)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function totalSupply() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function transfer(address recipient, uint256 amount) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function transferFrom(address sender, address recipient, uint256 amount)&quot;</span></span><br><span class="line">] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br></pre></td></tr></table></figure>

<h3 id="What-to-exclude"><a href="#What-to-exclude" class="headerlink" title="What to exclude:"></a>What to exclude:</h3><ul>
<li>Internal&#x2F;private methods (<code>_approve</code>, <code>_transfer</code>, <code>_basicTransfer</code>, <code>_msgSender</code>, <code>_msgData</code>)</li>
<li>Library functions (SafeMath, Address)</li>
<li>The <code>receive()</code> function (special fallback function doesn’t need ABI entry)</li>
</ul>
<h3 id="CCBusERC20-sol"><a href="#CCBusERC20-sol" class="headerlink" title="CCBusERC20.sol"></a>CCBusERC20.sol</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Created By: CC-Bus</span></span><br><span class="line"><span class="comment">//  Website: https://ccbus.cc</span></span><br><span class="line"><span class="comment">//  Telegram: https://t.me/CCBus</span></span><br><span class="line"><span class="comment">//  The Best Tool for Token Management</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Context</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_msgSender</span>(<span class="params"></span>) internal view <span class="title function_">returns</span> (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">payable</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_msgData</span>(<span class="params"></span>) internal view <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="variable language_">this</span>; <span class="comment">// silence state mutability warning without generating bytecode - see https://github.com/ethereum/solidity/issues/2691</span></span><br><span class="line">        <span class="keyword">return</span> msg.<span class="property">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library <span class="title class_">SafeMath</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        uint256 c = a + b;</span><br><span class="line">        <span class="built_in">require</span>(c &gt;= a, <span class="string">&quot;SafeMath: addition overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">sub</span>(a, b, <span class="string">&quot;SafeMath: subtraction overflow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b &lt;= a, errorMessage);</span><br><span class="line">        uint256 c = a - b;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mul</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 c = a * b;</span><br><span class="line">        <span class="built_in">require</span>(c / a == b, <span class="string">&quot;SafeMath: multiplication overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">div</span>(a, b, <span class="string">&quot;SafeMath: division by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b &gt; <span class="number">0</span>, errorMessage);</span><br><span class="line">        uint256 c = a / b;</span><br><span class="line">        <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mod</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mod</span>(a, b, <span class="string">&quot;SafeMath: modulo by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mod</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b != <span class="number">0</span>, errorMessage);</span><br><span class="line">        <span class="keyword">return</span> a % b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">library <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">isContract</span>(<span class="params">address account</span>) internal view <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line"></span><br><span class="line">        bytes32 codehash;</span><br><span class="line">        bytes32 accountHash = <span class="number">0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470</span>;</span><br><span class="line"></span><br><span class="line">        assembly &#123;</span><br><span class="line">            codehash := <span class="title function_">extcodehash</span>(account)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (codehash != accountHash &amp;&amp; codehash != <span class="number">0x0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sendValue</span>(<span class="params">address payable recipient, uint256 amount</span>) internal &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= amount,</span><br><span class="line">            <span class="string">&quot;Address: insufficient balance&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// solhint-disable-next-line avoid-low-level-calls, avoid-call-value</span></span><br><span class="line">        (bool success, ) = recipient.<span class="property">call</span>&#123;<span class="attr">value</span>: amount&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            success,</span><br><span class="line">            <span class="string">&quot;Address: unable to send value, recipient may have reverted&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCall</span>(<span class="params">address target, bytes memory data</span>)</span><br><span class="line">        internal</span><br><span class="line">        <span class="title function_">returns</span> (bytes memory)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">functionCall</span>(target, data, <span class="string">&quot;Address: low-level call failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCall</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_functionCallWithValue</span>(target, data, <span class="number">0</span>, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 value</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">            <span class="title function_">functionCallWithValue</span>(</span><br><span class="line">                target,</span><br><span class="line">                data,</span><br><span class="line">                value,</span><br><span class="line">                <span class="string">&quot;Address: low-level call with value failed&quot;</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 value,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= value,</span><br><span class="line">            <span class="string">&quot;Address: insufficient balance for call&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_functionCallWithValue</span>(target, data, value, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 weiValue,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">isContract</span>(target), <span class="string">&quot;Address: call to non-contract&quot;</span>);</span><br><span class="line"></span><br><span class="line">        (bool success, bytes memory returndata) = target.<span class="property">call</span>&#123;<span class="attr">value</span>: weiValue&#125;(</span><br><span class="line">            data</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="keyword">return</span> returndata;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (returndata.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                assembly &#123;</span><br><span class="line">                    <span class="keyword">let</span> returndata_size := <span class="title function_">mload</span>(returndata)</span><br><span class="line">                    <span class="title function_">revert</span>(<span class="title function_">add</span>(<span class="number">32</span>, returndata), returndata_size)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">revert</span>(errorMessage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IERC20</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decimals</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">symbol</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (<span class="built_in">string</span> memory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (<span class="built_in">string</span> memory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address who</span>) external view <span class="title function_">returns</span> (uint);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) external <span class="title function_">returns</span> (bool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allowance</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner,</span></span><br><span class="line"><span class="params">        address spender</span></span><br><span class="line"><span class="params">    </span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address _spender, uint _value</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address _from, address _to, uint _value</span>) external ;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">Transfer</span>(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);</span><br><span class="line">    event <span class="title class_">Approval</span>(</span><br><span class="line">        address indexed owner,</span><br><span class="line">        address indexed spender,</span><br><span class="line">        uint256 value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CCBusToken</span> is <span class="title class_">Context</span>, <span class="title class_">IERC20</span>&#123;</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> <span class="keyword">private</span> _name;</span><br><span class="line">    <span class="built_in">string</span> <span class="keyword">private</span> _symbol;</span><br><span class="line">    uint256 <span class="keyword">private</span> _decimals;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) _balances;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256)) <span class="keyword">private</span> _allowances;</span><br><span class="line"></span><br><span class="line">    address <span class="keyword">public</span> immutable deadAddress =</span><br><span class="line">        <span class="number">0x000000000000000000000000000000000000dEaD</span>;</span><br><span class="line">    uint256 <span class="keyword">private</span> _totalSupply;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"> </span></span><br><span class="line"><span class="params">        <span class="built_in">string</span>[] memory stringParams,</span></span><br><span class="line"><span class="params">        address[] memory addressParams,</span></span><br><span class="line"><span class="params">        uint256[] memory numberParams,</span></span><br><span class="line"><span class="params">        bool[] memory boolParams</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(addressParams.<span class="property">length</span>==<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">require</span>(boolParams.<span class="property">length</span>==<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        address receiveAddr = tx.<span class="property">origin</span>;</span><br><span class="line">        _name = stringParams[<span class="number">0</span>];</span><br><span class="line">        _symbol = stringParams[<span class="number">1</span>];</span><br><span class="line">        _decimals = numberParams[<span class="number">0</span>];</span><br><span class="line">        _totalSupply = numberParams[<span class="number">1</span>];</span><br><span class="line">        _balances[receiveAddr] = _totalSupply;</span><br><span class="line">        emit <span class="title class_">Transfer</span>(<span class="title function_">address</span>(<span class="number">0</span>), receiveAddr, _totalSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (<span class="built_in">string</span> memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">symbol</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (<span class="built_in">string</span> memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> _symbol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decimals</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _decimals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">owner</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="title function_">returns</span> (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> deadAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _balances[account];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allowance</span>(<span class="params">address owner1, address spender</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        view</span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        <span class="title function_">returns</span> (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _allowances[owner1][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">increaseAllowance</span>(<span class="params">address spender, uint256 addedValue</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        virtual</span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            spender,</span><br><span class="line">            _allowances[<span class="title function_">_msgSender</span>()][spender].<span class="title function_">add</span>(addedValue)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decreaseAllowance</span>(<span class="params">address spender, uint256 subtractedValue</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        virtual</span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            spender,</span><br><span class="line">            _allowances[<span class="title function_">_msgSender</span>()][spender].<span class="title function_">sub</span>(</span><br><span class="line">                subtractedValue,</span><br><span class="line">                <span class="string">&quot;ERC20: decreased allowance below zero&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint256 amount</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(<span class="title function_">_msgSender</span>(), spender, amount);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_approve</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner1,</span></span><br><span class="line"><span class="params">        address spender,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> &#123;</span><br><span class="line">        <span class="built_in">require</span>(owner1 != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(spender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve to the zero address&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _allowances[owner1][spender] = amount;</span><br><span class="line">        emit <span class="title class_">Approval</span>(owner1, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getCirculatingSupply</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _totalSupply.<span class="title function_">sub</span>(<span class="title function_">balanceOf</span>(deadAddress));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//to recieve ETH from uniswapV2Router when swaping</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address recipient, uint256 amount</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(<span class="title function_">_msgSender</span>(), recipient, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">public</span> <span class="keyword">override</span>  &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(sender, recipient, amount);</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            sender,</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            _allowances[sender][<span class="title function_">_msgSender</span>()].<span class="title function_">sub</span>(</span><br><span class="line">                amount,</span><br><span class="line">                <span class="string">&quot;ERC20: transfer amount exceeds allowance&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_transfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line">        <span class="built_in">require</span>(sender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: transfer from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(recipient != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: transfer to the zero address&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_basicTransfer</span>(sender, recipient, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_basicTransfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line">        _balances[sender] = _balances[sender].<span class="title function_">sub</span>(</span><br><span class="line">            amount,</span><br><span class="line">            <span class="string">&quot;Insufficient Balance&quot;</span></span><br><span class="line">        );</span><br><span class="line">        _balances[recipient] = _balances[recipient].<span class="title function_">add</span>(amount);</span><br><span class="line">        emit <span class="title class_">Transfer</span>(sender, recipient, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/21/Merkle-Tree-in-Chinese/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/21/Merkle-Tree-in-Chinese/" class="post-title-link" itemprop="url">Merkle Tree in Chinese</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-21 18:54:45 / Modified: 18:57:00" itemprop="dateCreated datePublished" datetime="2025-04-21T18:54:45-04:00">2025-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Merkle Tree（默克尔树）在区块链、密码学和数据完整性验证中是一个非常核心的概念。它是一种<strong>树状数据结构</strong>，用来高效而安全地验证数据的完整性。</p>
<hr>
<h2 id="🌳-一、Merkle-Tree-是什么？"><a href="#🌳-一、Merkle-Tree-是什么？" class="headerlink" title="🌳 一、Merkle Tree 是什么？"></a>🌳 一、Merkle Tree 是什么？</h2><p>Merkle Tree 是一种<strong>二叉树结构</strong>，每个叶子节点是某一笔数据的哈希值，每个非叶子节点是其子节点哈希值的组合再哈希后的结果，直到根节点 —— Merkle Root。</p>
<h3 id="📌-特点："><a href="#📌-特点：" class="headerlink" title="📌 特点："></a>📌 特点：</h3><ul>
<li>快速验证某条数据是否属于某批数据（O(log n)）</li>
<li>数据完整性校验非常高效</li>
<li>广泛用于区块链中（比特币、以太坊）以验证交易</li>
</ul>
<hr>
<h2 id="🧩-二、图示说明"><a href="#🧩-二、图示说明" class="headerlink" title="🧩 二、图示说明"></a>🧩 二、图示说明</h2><p>假设我们有 4 个交易 <code>Tx0, Tx1, Tx2, Tx3</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">             Merkle Root</span><br><span class="line">                 │</span><br><span class="line">         ┌───────┴────────┐</span><br><span class="line">         │                │</span><br><span class="line">      Hash01           Hash23</span><br><span class="line">     ┌────┴────┐      ┌────┴────┐</span><br><span class="line">  Hash0      Hash1  Hash2     Hash3</span><br><span class="line">  │            │     │          │</span><br><span class="line">Tx0          Tx1   Tx2        Tx3</span><br></pre></td></tr></table></figure>

<h3 id="哈希过程："><a href="#哈希过程：" class="headerlink" title="哈希过程："></a>哈希过程：</h3><ul>
<li><code>Hash0 = hash(Tx0)</code>，<code>Hash1 = hash(Tx1)</code></li>
<li><code>Hash01 = hash(Hash0 + Hash1)</code></li>
<li><code>Merkle Root = hash(Hash01 + Hash23)</code></li>
</ul>
<hr>
<h2 id="💡-三、Merkle-Tree-的作用"><a href="#💡-三、Merkle-Tree-的作用" class="headerlink" title="💡 三、Merkle Tree 的作用"></a>💡 三、Merkle Tree 的作用</h2><h3 id="✅-在区块链中主要用来："><a href="#✅-在区块链中主要用来：" class="headerlink" title="✅ 在区块链中主要用来："></a>✅ 在区块链中主要用来：</h3><table>
<thead>
<tr>
<th>用途</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>验证交易是否在区块中</td>
<td>比如比特币 SPV（轻节点）用来验证一笔交易是否在区块中，无需下载整个区块</td>
</tr>
<tr>
<td>保证数据不可篡改</td>
<td>即使更改一笔交易，Merkle Root 也会完全不同</td>
</tr>
<tr>
<td>批量处理大量数据的完整性验证</td>
<td>用于 IPFS、文件校验、区块快照</td>
</tr>
</tbody></table>
<hr>
<h2 id="🧪-四、一个简单的-Merkle-Tree-实现（用-JavaScript）"><a href="#🧪-四、一个简单的-Merkle-Tree-实现（用-JavaScript）" class="headerlink" title="🧪 四、一个简单的 Merkle Tree 实现（用 JavaScript）"></a>🧪 四、一个简单的 Merkle Tree 实现（用 JavaScript）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createHash &#125; <span class="keyword">from</span> <span class="string">&#x27;crypto&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>).<span class="title function_">update</span>(data).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建 Merkle Tree 并返回根节点</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildMerkleTree</span>(<span class="params"><span class="attr">leaves</span>: <span class="built_in">string</span>[]</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (leaves.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> level = leaves.<span class="title function_">map</span>(sha256);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (level.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">nextLevel</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; level.<span class="property">length</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> left = level[i];</span><br><span class="line">      <span class="keyword">const</span> right = level[i + <span class="number">1</span>] ?? left; <span class="comment">// 如果是奇数，复制最后一个</span></span><br><span class="line">      nextLevel.<span class="title function_">push</span>(<span class="title function_">sha256</span>(left + right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    level = nextLevel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> level[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例</span></span><br><span class="line"><span class="keyword">const</span> txs = [<span class="string">&#x27;tx0&#x27;</span>, <span class="string">&#x27;tx1&#x27;</span>, <span class="string">&#x27;tx2&#x27;</span>, <span class="string">&#x27;tx3&#x27;</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Merkle Root:&#x27;</span>, <span class="title function_">buildMerkleTree</span>(txs));</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🔍-五、如何验证某笔交易在-Merkle-Tree-中？"><a href="#🔍-五、如何验证某笔交易在-Merkle-Tree-中？" class="headerlink" title="🔍 五、如何验证某笔交易在 Merkle Tree 中？"></a>🔍 五、如何验证某笔交易在 Merkle Tree 中？</h2><p>验证步骤是：</p>
<ol>
<li>获取你那笔交易的哈希（比如 <code>tx1 → h1</code>）</li>
<li>获取你需要验证路径的兄弟节点哈希（称为“Merkle Proof”）</li>
<li>逐层拼接并计算，直到得出 Merkle Root</li>
<li>看是否和真正的 Merkle Root 匹配</li>
</ol>
<p>这样你就可以<strong>仅凭部分数据验证整批数据完整性</strong>，这在区块链轻节点中尤为重要。</p>
<hr>
<h2 id="📦-六、真实区块链场景"><a href="#📦-六、真实区块链场景" class="headerlink" title="📦 六、真实区块链场景"></a>📦 六、真实区块链场景</h2><h3 id="以太坊中："><a href="#以太坊中：" class="headerlink" title="以太坊中："></a>以太坊中：</h3><ul>
<li>并不直接使用二叉 Merkle Tree，而是使用改进版：<strong>Merkle Patricia Trie</strong> 来处理状态（账户、余额等）</li>
<li>区块头中的 <code>transactionsRoot</code>、<code>stateRoot</code> 等字段就是 Merkle 根</li>
</ul>
<h3 id="比特币中："><a href="#比特币中：" class="headerlink" title="比特币中："></a>比特币中：</h3><ul>
<li>区块中的 <code>merkle_root</code> 字段是所有交易的 Merkle 根</li>
<li>支持轻节点（SPV）通过 Merkle Proof 验证交易</li>
</ul>
<hr>
<h2 id="🧾-七、总结重点"><a href="#🧾-七、总结重点" class="headerlink" title="🧾 七、总结重点"></a>🧾 七、总结重点</h2><table>
<thead>
<tr>
<th>项目</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>是什么</td>
<td>二叉哈希树，用于验证大批数据中某一条数据是否存在</td>
</tr>
<tr>
<td>为什么重要</td>
<td>高效验证、防篡改、轻节点支持</td>
</tr>
<tr>
<td>区块链用途</td>
<td>交易验证、状态验证、数据完整性证明</td>
</tr>
<tr>
<td>优点</td>
<td>空间占用小，验证时间快（对数级别），可组合证明</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/21/Merkle-Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/21/Merkle-Tree/" class="post-title-link" itemprop="url">Merkle Tree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-21 18:43:23 / Modified: 18:57:12" itemprop="dateCreated datePublished" datetime="2025-04-21T18:43:23-04:00">2025-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="🔍-What-is-a-Merkle-Tree"><a href="#🔍-What-is-a-Merkle-Tree" class="headerlink" title="🔍 What is a Merkle Tree?"></a>🔍 What is a Merkle Tree?</h2><p>A <strong>Merkle Tree</strong> (also called a binary hash tree) is a tree structure where:</p>
<ul>
<li>Every <strong>leaf node</strong> contains the cryptographic hash of a data block.</li>
<li>Every <strong>non-leaf node</strong> contains the hash of the concatenation of its child hashes.</li>
</ul>
<p>It’s used in blockchain systems (e.g., Bitcoin, Ethereum) to efficiently and securely verify the integrity of large sets of data, such as transactions.</p>
<hr>
<h2 id="🌳-Merkle-Tree-Structure"><a href="#🌳-Merkle-Tree-Structure" class="headerlink" title="🌳 Merkle Tree Structure"></a>🌳 Merkle Tree Structure</h2><p>Example with 4 transactions (T1, T2, T3, T4):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        Root</span><br><span class="line">       /    \</span><br><span class="line">    H12      H34</span><br><span class="line">   /  \     /   \</span><br><span class="line">H1   H2   H3   H4</span><br></pre></td></tr></table></figure>

<ul>
<li><code>H1 = hash(T1)</code>, <code>H2 = hash(T2)</code>, etc.</li>
<li><code>H12 = hash(H1 + H2)</code>, <code>H34 = hash(H3 + H4)</code></li>
<li><code>Root = hash(H12 + H34)</code></li>
</ul>
<p>This root hash is called the <strong>Merkle Root</strong>.</p>
<hr>
<h2 id="🧠-Benefits-of-Merkle-Tree"><a href="#🧠-Benefits-of-Merkle-Tree" class="headerlink" title="🧠 Benefits of Merkle Tree"></a>🧠 Benefits of Merkle Tree</h2><ul>
<li>Efficient and secure verification of data integrity.</li>
<li>Only need a small part of the tree (a Merkle proof) to verify a data block.</li>
<li>Used in <strong>SPV (Simplified Payment Verification)</strong> in Bitcoin.</li>
</ul>
<hr>
<h2 id="💻-JavaScript-Sample-Code-Using-crypto"><a href="#💻-JavaScript-Sample-Code-Using-crypto" class="headerlink" title="💻 JavaScript Sample Code Using crypto"></a>💻 JavaScript Sample Code Using <code>crypto</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hashing function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>).<span class="title function_">update</span>(data).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Build Merkle Tree from an array of transactions</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildMerkleTree</span>(<span class="params">transactions</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (transactions.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> [<span class="string">&#x27;&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Step 1: Hash each transaction</span></span><br><span class="line">  <span class="keyword">let</span> level = transactions.<span class="title function_">map</span>(<span class="function"><span class="params">tx</span> =&gt;</span> <span class="title function_">sha256</span>(tx));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Step 2: Build tree up to the root</span></span><br><span class="line">  <span class="keyword">while</span> (level.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> nextLevel = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; level.<span class="property">length</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> left = level[i];</span><br><span class="line">      <span class="keyword">const</span> right = i + <span class="number">1</span> &lt; level.<span class="property">length</span> ? level[i + <span class="number">1</span>] : left; <span class="comment">// duplicate last if odd</span></span><br><span class="line">      <span class="keyword">const</span> combined = left + right;</span><br><span class="line">      nextLevel.<span class="title function_">push</span>(<span class="title function_">sha256</span>(combined));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    level = nextLevel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> level[<span class="number">0</span>]; <span class="comment">// Merkle root</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example usage</span></span><br><span class="line"><span class="keyword">const</span> txs = [<span class="string">&#x27;tx1-data&#x27;</span>, <span class="string">&#x27;tx2-data&#x27;</span>, <span class="string">&#x27;tx3-data&#x27;</span>, <span class="string">&#x27;tx4-data&#x27;</span>];</span><br><span class="line"><span class="keyword">const</span> merkleRoot = <span class="title function_">buildMerkleTree</span>(txs);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Merkle Root:&#x27;</span>, merkleRoot);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📎-Notes"><a href="#📎-Notes" class="headerlink" title="📎 Notes:"></a>📎 Notes:</h2><ul>
<li>This sample assumes a binary Merkle tree.</li>
<li>If there’s an odd number of leaves, the last hash is duplicated to make a pair.</li>
<li>You can also implement <strong>Merkle Proof</strong> logic to verify a leaf’s inclusion using hashes up to the root.</li>
</ul>
<h2 id="Another-drawn"><a href="#Another-drawn" class="headerlink" title="Another drawn"></a>Another drawn</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">             Merkle Root</span><br><span class="line">                 │</span><br><span class="line">         ┌───────┴────────┐</span><br><span class="line">         │                │</span><br><span class="line">      Hash01           Hash23</span><br><span class="line">     ┌────┴────┐      ┌────┴────┐</span><br><span class="line">  Hash0      Hash1  Hash2     Hash3</span><br><span class="line">  │            │     │          │</span><br><span class="line">Tx0          Tx1   Tx2        Tx3</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/20/Deep-Dive-Ethers-js-calldata/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/20/Deep-Dive-Ethers-js-calldata/" class="post-title-link" itemprop="url">Deep Dive --- Ethers.js calldata</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-20 18:42:59 / Modified: 18:44:41" itemprop="dateCreated datePublished" datetime="2025-04-20T18:42:59-04:00">2025-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Ethers-js-中的-Calldata-详解及使用场景"><a href="#Ethers-js-中的-Calldata-详解及使用场景" class="headerlink" title="Ethers.js 中的 Calldata 详解及使用场景"></a>Ethers.js 中的 Calldata 详解及使用场景</h1><p><code>calldata</code> 是以太坊智能合约交互中的核心概念，它包含了调用合约函数时发送的所有数据。在 ethers.js 中，理解和使用 calldata 对于高级合约交互至关重要。</p>
<h2 id="什么是-Calldata？"><a href="#什么是-Calldata？" class="headerlink" title="什么是 Calldata？"></a>什么是 Calldata？</h2><p>Calldata 是发送到以太坊合约的特殊数据格式，包含：</p>
<ul>
<li>函数选择器（4字节的函数签名哈希）</li>
<li>编码后的参数数据</li>
</ul>
<h3 id="Calldata-的特点"><a href="#Calldata-的特点" class="headerlink" title="Calldata 的特点"></a>Calldata 的特点</h3><ol>
<li>只读 - 合约不能修改 calldata</li>
<li>临时存储 - 执行结束后不保存在区块链上</li>
<li>外部调用专用 - 用于合约间通信</li>
<li>比 memory 更便宜 - 使用 calldata 可以节省 gas</li>
</ol>
<h2 id="基础-Calldata-操作"><a href="#基础-Calldata-操作" class="headerlink" title="基础 Calldata 操作"></a>基础 Calldata 操作</h2><h3 id="1-生成-Calldata"><a href="#1-生成-Calldata" class="headerlink" title="1. 生成 Calldata"></a>1. 生成 Calldata</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ethers &#125; = <span class="built_in">require</span>(<span class="string">&quot;ethers&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合约ABI</span></span><br><span class="line"><span class="keyword">const</span> erc20Abi = [</span><br><span class="line">  <span class="string">&quot;function transfer(address to, uint amount)&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建接口</span></span><br><span class="line"><span class="keyword">const</span> iface = <span class="keyword">new</span> ethers.<span class="property">utils</span>.<span class="title class_">Interface</span>(erc20Abi);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编码calldata</span></span><br><span class="line"><span class="keyword">const</span> calldata = iface.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;transfer&quot;</span>, [</span><br><span class="line">  <span class="string">&quot;0xRecipientAddressHere&quot;</span>,</span><br><span class="line">  ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Calldata:&quot;</span>, calldata);</span><br><span class="line"><span class="comment">// 输出示例: 0xa9059cbb000000000000000000000000recipientaddress0000000000000000000000000000000000000000000000000de0b6b3a7640000</span></span><br></pre></td></tr></table></figure>

<h3 id="2-解析-Calldata"><a href="#2-解析-Calldata" class="headerlink" title="2. 解析 Calldata"></a>2. 解析 Calldata</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用相同的接口解析calldata</span></span><br><span class="line"><span class="keyword">const</span> parsed = iface.<span class="title function_">parseTransaction</span>(&#123; <span class="attr">data</span>: calldata &#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Parsed:&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">name</span>: parsed.<span class="property">name</span>,</span><br><span class="line">  <span class="attr">args</span>: parsed.<span class="property">args</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="核心使用场景"><a href="#核心使用场景" class="headerlink" title="核心使用场景"></a>核心使用场景</h2><h3 id="场景1-批量交易-Multicall"><a href="#场景1-批量交易-Multicall" class="headerlink" title="场景1: 批量交易 (Multicall)"></a>场景1: 批量交易 (Multicall)</h3><p><strong>需求</strong>：在一次交易中执行多个合约调用，节省gas费用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multiCallAbi = [</span><br><span class="line">  <span class="string">&quot;function multicall(bytes[] calldata data) external returns (bytes[] memory results)&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">batchTransfer</span>(<span class="params">token, recipients, amounts</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> iface = <span class="keyword">new</span> ethers.<span class="property">utils</span>.<span class="title class_">Interface</span>([</span><br><span class="line">    <span class="string">&quot;function transfer(address to, uint amount)&quot;</span></span><br><span class="line">  ]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 为每个转账生成calldata</span></span><br><span class="line">  <span class="keyword">const</span> calls = recipients.<span class="title function_">map</span>(<span class="function">(<span class="params">to, i</span>) =&gt;</span> </span><br><span class="line">    token.<span class="property">interface</span>.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;transfer&quot;</span>, [to, amounts[i]])</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建Multicall合约实例</span></span><br><span class="line">  <span class="keyword">const</span> multicall = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(</span><br><span class="line">    <span class="string">&quot;0x5ba1e12693dc8f9c48aad8770482f4739beed696&quot;</span>, <span class="comment">// Ethereum主网Multicall地址</span></span><br><span class="line">    multiCallAbi,</span><br><span class="line">    signer</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行批量调用</span></span><br><span class="line">  <span class="keyword">const</span> tx = <span class="keyword">await</span> multicall.<span class="title function_">multicall</span>(calls);</span><br><span class="line">  <span class="keyword">await</span> tx.<span class="title function_">wait</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;批量转账完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="场景2-离线签名交易"><a href="#场景2-离线签名交易" class="headerlink" title="场景2: 离线签名交易"></a>场景2: 离线签名交易</h3><p><strong>需求</strong>：在不暴露私钥的情况下生成可广播的交易数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createSignedTransfer</span>(<span class="params">tokenAddress, to, amount, signer</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(tokenAddress, erc20Abi, signer);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. 生成calldata</span></span><br><span class="line">  <span class="keyword">const</span> data = token.<span class="property">interface</span>.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;transfer&quot;</span>, [</span><br><span class="line">    to,</span><br><span class="line">    amount</span><br><span class="line">  ]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. 构建原始交易</span></span><br><span class="line">  <span class="keyword">const</span> tx = &#123;</span><br><span class="line">    <span class="attr">to</span>: tokenAddress,</span><br><span class="line">    <span class="attr">data</span>: data,</span><br><span class="line">    <span class="attr">value</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">gasLimit</span>: <span class="number">100000</span>,</span><br><span class="line">    <span class="attr">nonce</span>: <span class="keyword">await</span> signer.<span class="title function_">getTransactionCount</span>(),</span><br><span class="line">    <span class="attr">chainId</span>: <span class="number">1</span> <span class="comment">// Ethereum主网</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. 签名交易（不广播）</span></span><br><span class="line">  <span class="keyword">const</span> signedTx = <span class="keyword">await</span> signer.<span class="title function_">signTransaction</span>(tx);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;签名后的交易:&quot;</span>, signedTx);</span><br><span class="line">  <span class="comment">// 可以将其保存或发送给其他节点广播</span></span><br><span class="line">  <span class="keyword">return</span> signedTx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="场景3-估算Gas费用"><a href="#场景3-估算Gas费用" class="headerlink" title="场景3: 估算Gas费用"></a>场景3: 估算Gas费用</h3><p><strong>需求</strong>：在执行交易前准确估算所需的gas。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">estimateTransferGas</span>(<span class="params">tokenAddress, <span class="keyword">from</span>, to, amount, provider</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(tokenAddress, erc20Abi, provider);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 生成calldata</span></span><br><span class="line">  <span class="keyword">const</span> data = token.<span class="property">interface</span>.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;transfer&quot;</span>, [to, amount]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 估算gas</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> gasEstimate = <span class="keyword">await</span> provider.<span class="title function_">estimateGas</span>(&#123;</span><br><span class="line">      <span class="attr">from</span>: <span class="keyword">from</span>,</span><br><span class="line">      <span class="attr">to</span>: tokenAddress,</span><br><span class="line">      <span class="attr">data</span>: data</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`转账预估Gas: <span class="subst">$&#123;gasEstimate.toString()&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> gasEstimate;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Gas估算失败:&quot;</span>, error.<span class="property">reason</span>);</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="场景4-代理合约调用"><a href="#场景4-代理合约调用" class="headerlink" title="场景4: 代理合约调用"></a>场景4: 代理合约调用</h3><p><strong>需求</strong>：通过代理合约调用逻辑合约的函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxyAbi = [</span><br><span class="line">  <span class="string">&quot;function delegatecall(address target, bytes memory data) public payable&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">proxyTransfer</span>(<span class="params">proxyAddress, tokenAddress, to, amount, signer</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(tokenAddress, erc20Abi, signer);</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(proxyAddress, proxyAbi, signer);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. 生成token transfer的calldata</span></span><br><span class="line">  <span class="keyword">const</span> data = token.<span class="property">interface</span>.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;transfer&quot;</span>, [to, amount]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. 通过代理合约的delegatecall执行</span></span><br><span class="line">  <span class="keyword">const</span> tx = <span class="keyword">await</span> proxy.<span class="title function_">delegatecall</span>(tokenAddress, data);</span><br><span class="line">  <span class="keyword">await</span> tx.<span class="title function_">wait</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;通过代理合约转账完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="场景5-事件日志解析"><a href="#场景5-事件日志解析" class="headerlink" title="场景5: 事件日志解析"></a>场景5: 事件日志解析</h3><p><strong>需求</strong>：从交易收据中解析原始事件日志。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">parseTransferEvents</span>(<span class="params">txHash, provider</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取交易收据</span></span><br><span class="line">  <span class="keyword">const</span> receipt = <span class="keyword">await</span> provider.<span class="title function_">getTransactionReceipt</span>(txHash);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建ERC20接口用于解析日志</span></span><br><span class="line">  <span class="keyword">const</span> iface = <span class="keyword">new</span> ethers.<span class="property">utils</span>.<span class="title class_">Interface</span>(erc20Abi);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 解析所有日志</span></span><br><span class="line">  <span class="keyword">const</span> events = receipt.<span class="property">logs</span></span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">log</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> iface.<span class="title function_">parseLog</span>(log);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 忽略非ERC20事件</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">event</span> =&gt;</span> event !== <span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 筛选Transfer事件</span></span><br><span class="line">  <span class="keyword">const</span> transfers = events.<span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> e.<span class="property">name</span> === <span class="string">&quot;Transfer&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;交易中的转账事件:&quot;</span>, transfers);</span><br><span class="line">  <span class="keyword">return</span> transfers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="高级使用技巧"><a href="#高级使用技巧" class="headerlink" title="高级使用技巧"></a>高级使用技巧</h2><h3 id="1-动态参数编码"><a href="#1-动态参数编码" class="headerlink" title="1. 动态参数编码"></a>1. 动态参数编码</h3><p>当参数类型不确定时，可以手动编码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">encodeDynamicParams</span>(<span class="params">types, values</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> ethers.<span class="property">utils</span>.<span class="property">defaultAbiCoder</span>.<span class="title function_">encode</span>(types, values);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：编码动态数组</span></span><br><span class="line"><span class="keyword">const</span> dynamicData = <span class="title function_">encodeDynamicParams</span>(</span><br><span class="line">  [<span class="string">&quot;address[]&quot;</span>, <span class="string">&quot;uint256[]&quot;</span>],</span><br><span class="line">  [</span><br><span class="line">    [<span class="string">&quot;0x123...&quot;</span>, <span class="string">&quot;0x456...&quot;</span>],</span><br><span class="line">    [ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;1&quot;</span>), ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;2&quot;</span>)]</span><br><span class="line">  ]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="2-自定义错误处理"><a href="#2-自定义错误处理" class="headerlink" title="2. 自定义错误处理"></a>2. 自定义错误处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">safeCall</span>(<span class="params">contract, method, args</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> calldata = contract.<span class="property">interface</span>.<span class="title function_">encodeFunctionData</span>(method, args);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 使用callStatic模拟调用</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> contract.<span class="property">callStatic</span>[method](...args);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">data</span>: result &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="comment">// 解析revert原因</span></span><br><span class="line">    <span class="keyword">let</span> reason = <span class="string">&quot;未知错误&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">data</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        reason = contract.<span class="property">interface</span>.<span class="title function_">parseError</span>(error.<span class="property">data</span>).<span class="property">name</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reason = error.<span class="property">data</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">error</span>: reason &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Gas优化技巧"><a href="#3-Gas优化技巧" class="headerlink" title="3. Gas优化技巧"></a>3. Gas优化技巧</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">optimizedTransfer</span>(<span class="params">token, to, amount</span>) &#123;</span><br><span class="line">  <span class="comment">// 1. 生成calldata</span></span><br><span class="line">  <span class="keyword">const</span> data = token.<span class="property">interface</span>.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;transfer&quot;</span>, [to, amount]);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. 获取当前gas价格</span></span><br><span class="line">  <span class="keyword">const</span> gasPrice = <span class="keyword">await</span> token.<span class="property">provider</span>.<span class="title function_">getGasPrice</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. 估算gas</span></span><br><span class="line">  <span class="keyword">const</span> gasLimit = <span class="keyword">await</span> token.<span class="property">estimateGas</span>.<span class="title function_">transfer</span>(to, amount)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">est</span> =&gt;</span> est.<span class="title function_">mul</span>(<span class="number">12</span>).<span class="title function_">div</span>(<span class="number">10</span>)) <span class="comment">// 增加20%缓冲</span></span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> ethers.<span class="property">BigNumber</span>.<span class="title function_">from</span>(<span class="number">100000</span>)); <span class="comment">// 默认值</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 4. 构建原始交易</span></span><br><span class="line">  <span class="keyword">const</span> tx = &#123;</span><br><span class="line">    <span class="attr">to</span>: token.<span class="property">address</span>,</span><br><span class="line">    <span class="attr">data</span>: data,</span><br><span class="line">    <span class="attr">gasPrice</span>: gasPrice,</span><br><span class="line">    <span class="attr">gasLimit</span>: gasLimit</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 5. 发送交易</span></span><br><span class="line">  <span class="keyword">return</span> token.<span class="property">signer</span>.<span class="title function_">sendTransaction</span>(tx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="安全注意事项"><a href="#安全注意事项" class="headerlink" title="安全注意事项"></a>安全注意事项</h2><ol>
<li><strong>Calldata验证</strong>：始终验证外部传入的calldata，防止恶意调用</li>
<li><strong>Gas限制</strong>：为未知calldata设置合理的gas限制</li>
<li><strong>重放攻击</strong>：签名后的calldata可以被重放，包含chainId和nonce</li>
<li><strong>参数清洗</strong>：在解码前检查calldata长度和格式</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Calldata 在以太坊开发中扮演着核心角色，通过 ethers.js 提供的工具可以：</p>
<ol>
<li>高效编码和解码函数调用</li>
<li>实现复杂的批量交易模式</li>
<li>构建安全的离线签名系统</li>
<li>优化gas使用成本</li>
<li>与代理合约和高级模式交互</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/11/Build-a-wechat-app-from-scratch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/11/Build-a-wechat-app-from-scratch/" class="post-title-link" itemprop="url">Build a wechat app from scratch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-11 17:33:52 / Modified: 17:34:32" itemprop="dateCreated datePublished" datetime="2025-04-11T17:33:52-04:00">2025-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WeChat/" itemprop="url" rel="index"><span itemprop="name">WeChat</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1. 项目结构"></a>1. 项目结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">miniprogram/</span><br><span class="line">├── pages/</span><br><span class="line">│   └── index/</span><br><span class="line">│       ├── index.js</span><br><span class="line">│       ├── index.json</span><br><span class="line">│       ├── index.wxml</span><br><span class="line">│       └── index.wxss</span><br><span class="line">├── app.js</span><br><span class="line">├── app.json</span><br><span class="line">├── app.wxss</span><br><span class="line">└── utils/</span><br><span class="line">    └── api.js</span><br></pre></td></tr></table></figure>

<h2 id="2-代码实现"><a href="#2-代码实现" class="headerlink" title="2. 代码实现"></a>2. 代码实现</h2><h3 id="2-1-app-json-配置"><a href="#2-1-app-json-配置" class="headerlink" title="2.1 app.json 配置"></a>2.1 app.json 配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;pages/index/index&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;window&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;navigationBarTitleText&quot;</span><span class="punctuation">:</span> <span class="string">&quot;图片风格转换&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;navigationBarBackgroundColor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#ffffff&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;navigationBarTextStyle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;black&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sitemapLocation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sitemap.json&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-页面布局-index-wxml"><a href="#2-2-页面布局-index-wxml" class="headerlink" title="2.2 页面布局 (index.wxml)"></a>2.2 页面布局 (index.wxml)</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 上部：图片输入区域 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;top-section&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;originalImage&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;originalImage&#125;&#125;&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;widthFix&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">&quot;chooseImage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>选择图片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">&quot;transformImage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn transform-btn&quot;</span> <span class="attr">disabled</span>=<span class="string">&quot;&#123;&#123;!canTransform&#125;&#125;&quot;</span>&gt;</span>转换<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 中部：风格选择区域 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;middle-section&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>选择转换风格<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;style-buttons&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;styles&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;style-btn &#123;&#123;selectedStyle === item.id ? &#x27;active&#x27; : &#x27;&#x27;&#125;&#125;&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">bindtap</span>=<span class="string">&quot;selectStyle&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">data-id</span>=<span class="string">&quot;&#123;&#123;item.id&#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          &#123;&#123;item.name&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 下部：结果展示区域 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bottom-section&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;isLoading&#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;loading&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/images/loading.gif&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;aspectFit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">text</span>&gt;</span>正在转换中，请稍候...<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;transformedImage &amp;&amp; !isLoading&#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;result-image&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;transformedImage&#125;&#125;&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;widthFix&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-页面样式-index-wxss"><a href="#2-3-页面样式-index-wxss" class="headerlink" title="2.3 页面样式 (index.wxss)"></a>2.3 页面样式 (index.wxss)</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20</span>rpx;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.top-section</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eee</span>;</span><br><span class="line">  <span class="attribute">padding-bottom</span>: <span class="number">20</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-preview</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-preview</span> <span class="selector-tag">image</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">10</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.button-group</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">  <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">48%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">80</span>rpx;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">80</span>rpx;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">32</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.transform-btn</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#07c160</span>;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.transform-btn</span><span class="selector-attr">[disabled]</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#cccccc</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#666666</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.middle-section</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20</span>rpx <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eee</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.title</span> &#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">36</span>rpx;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">30</span>rpx;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.style-buttons</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">  <span class="attribute">justify-content</span>: space-around;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.style-btn</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">45%</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20</span>rpx;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">28</span>rpx;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f5f5f5</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.style-btn</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#07c160</span>;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.bottom-section</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">2</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">padding-top</span>: <span class="number">20</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loading</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loading</span> <span class="selector-tag">image</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100</span>rpx;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100</span>rpx;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loading</span> <span class="selector-tag">text</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">28</span>rpx;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#666</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.result-image</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.result-image</span> <span class="selector-tag">image</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">10</span>rpx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-页面逻辑-index-js"><a href="#2-4-页面逻辑-index-js" class="headerlink" title="2.4 页面逻辑 (index.js)"></a>2.4 页面逻辑 (index.js)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> api = <span class="built_in">require</span>(<span class="string">&#x27;../../utils/api.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Page</span>(&#123;</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">originalImage</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">transformedImage</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">selectedStyle</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">isLoading</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">canTransform</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">styles</span>: [</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;anime&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;动漫&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;vintage&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;怀旧&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;cool&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;酷帅&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">&#x27;fresh&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;清新&#x27;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 选择图片</span></span><br><span class="line">  <span class="title function_">chooseImage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    wx.<span class="title function_">chooseImage</span>(&#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">sizeType</span>: [<span class="string">&#x27;compressed&#x27;</span>],</span><br><span class="line">      <span class="attr">sourceType</span>: [<span class="string">&#x27;album&#x27;</span>, <span class="string">&#x27;camera&#x27;</span>],</span><br><span class="line">      <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">          <span class="attr">originalImage</span>: res.<span class="property">tempFilePaths</span>[<span class="number">0</span>],</span><br><span class="line">          <span class="attr">transformedImage</span>: <span class="literal">null</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">checkTransformStatus</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 选择风格</span></span><br><span class="line">  <span class="title function_">selectStyle</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> styleId = e.<span class="property">currentTarget</span>.<span class="property">dataset</span>.<span class="property">id</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">      <span class="attr">selectedStyle</span>: styleId</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">checkTransformStatus</span>()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查是否可以转换</span></span><br><span class="line">  <span class="title function_">checkTransformStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">      <span class="attr">canTransform</span>: !!<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">originalImage</span> &amp;&amp; !!<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">selectedStyle</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转换图片</span></span><br><span class="line">  <span class="title function_">transformImage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">originalImage</span> || !<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">selectedStyle</span>) &#123;</span><br><span class="line">      wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;请选择图片和风格&#x27;</span>,</span><br><span class="line">        <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">      <span class="attr">isLoading</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">transformedImage</span>: <span class="literal">null</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传图片并转换</span></span><br><span class="line">    wx.<span class="title function_">uploadFile</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;https://www.catobigato.com/api/v1/imageTransform&#x27;</span>,</span><br><span class="line">      <span class="attr">filePath</span>: <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">originalImage</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;image&#x27;</span>,</span><br><span class="line">      <span class="attr">formData</span>: &#123;</span><br><span class="line">        <span class="attr">style</span>: <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">selectedStyle</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.<span class="property">statusCode</span> === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(res.<span class="property">data</span>)</span><br><span class="line">          <span class="keyword">if</span> (data.<span class="property">success</span> &amp;&amp; data.<span class="property">resultUrl</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">              <span class="attr">transformedImage</span>: data.<span class="property">resultUrl</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">              <span class="attr">title</span>: data.<span class="property">message</span> || <span class="string">&#x27;转换失败&#x27;</span>,</span><br><span class="line">              <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;服务器错误&#x27;</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">          <span class="attr">title</span>: <span class="string">&#x27;网络错误&#x27;</span>,</span><br><span class="line">          <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">          <span class="attr">isLoading</span>: <span class="literal">false</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="2-5-API工具类-utils-api-js"><a href="#2-5-API工具类-utils-api-js" class="headerlink" title="2.5 API工具类 (utils&#x2F;api.js)"></a>2.5 API工具类 (utils&#x2F;api.js)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">BASE_URL</span> = <span class="string">&#x27;https://www.catobigato.com/api/v1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">request</span> = (<span class="params">url, method, data</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="variable constant_">BASE_URL</span> + url,</span><br><span class="line">      <span class="attr">method</span>: method,</span><br><span class="line">      <span class="attr">data</span>: data,</span><br><span class="line">      <span class="attr">header</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.<span class="property">statusCode</span> === <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(res.<span class="property">data</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(res.<span class="property">data</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  request</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-功能说明"><a href="#3-功能说明" class="headerlink" title="3. 功能说明"></a>3. 功能说明</h2><ol>
<li><p><strong>图片选择</strong>：</p>
<ul>
<li>用户点击”选择图片”按钮，可以从相册或相机获取图片</li>
<li>选择的图片会显示在上部区域</li>
</ul>
</li>
<li><p><strong>风格选择</strong>：</p>
<ul>
<li>中部区域提供4种风格选项（动漫、怀旧、酷帅、清新）</li>
<li>用户点击风格按钮后，按钮会高亮显示</li>
</ul>
</li>
<li><p><strong>转换功能</strong>：</p>
<ul>
<li>只有当用户选择了图片和风格后，”转换”按钮才会启用</li>
<li>点击”转换”按钮后，小程序将图片和风格参数上传到后端API</li>
<li>转换过程中显示加载动画</li>
</ul>
</li>
<li><p><strong>结果展示</strong>：</p>
<ul>
<li>转换完成后，结果图片显示在下部区域</li>
<li>如果转换失败，会显示错误提示</li>
</ul>
</li>
</ol>
<h2 id="4-注意事项"><a href="#4-注意事项" class="headerlink" title="4. 注意事项"></a>4. 注意事项</h2><ol>
<li><p><strong>域名配置</strong>：</p>
<ul>
<li>在微信小程序后台配置<code>https://www.catobigato.com</code>为合法域名</li>
<li>确保服务器支持HTTPS</li>
</ul>
</li>
<li><p><strong>图片大小限制</strong>：</p>
<ul>
<li>微信小程序对上传文件大小有限制（通常为10MB）</li>
<li>建议在上传前对图片进行压缩处理</li>
</ul>
</li>
<li><p><strong>加载动画</strong>：</p>
<ul>
<li>准备一个loading.gif动画文件放在<code>/images/</code>目录下</li>
<li>也可以使用微信自带的loading组件</li>
</ul>
</li>
<li><p><strong>错误处理</strong>：</p>
<ul>
<li>添加了网络错误和服务器错误的处理逻辑</li>
<li>显示友好的错误提示</li>
</ul>
</li>
<li><p><strong>性能优化</strong>：</p>
<ul>
<li>对于大图片，可以考虑先压缩再上传</li>
<li>可以添加取消上传的功能</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/03/23/PostgreSQL-commands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/23/PostgreSQL-commands/" class="post-title-link" itemprop="url">PostgreSQL commands</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-23 10:12:56 / Modified: 10:16:33" itemprop="dateCreated datePublished" datetime="2025-03-23T10:12:56-04:00">2025-03-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Postgres/" itemprop="url" rel="index"><span itemprop="name">Postgres</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Database-Management"><a href="#Database-Management" class="headerlink" title="Database Management"></a>Database Management</h2><h3 id="List-All-Databases"><a href="#List-All-Databases" class="headerlink" title="List All Databases"></a>List All Databases</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\l</span><br></pre></td></tr></table></figure>

<h3 id="Connect-to-a-Database"><a href="#Connect-to-a-Database" class="headerlink" title="Connect to a Database"></a>Connect to a Database</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\c database_name</span><br></pre></td></tr></table></figure>

<h3 id="Create-a-New-Database"><a href="#Create-a-New-Database" class="headerlink" title="Create a New Database"></a>Create a New Database</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE database_name;</span><br></pre></td></tr></table></figure>

<h3 id="Drop-a-Database"><a href="#Drop-a-Database" class="headerlink" title="Drop a Database"></a>Drop a Database</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE database_name;</span><br></pre></td></tr></table></figure>

<h3 id="Check-Database-Size"><a href="#Check-Database-Size" class="headerlink" title="Check Database Size"></a>Check Database Size</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_size_pretty(pg_database_size(<span class="string">&#x27;database_name&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="List-All-Users-Roles"><a href="#List-All-Users-Roles" class="headerlink" title="List All Users&#x2F;Roles"></a>List All Users&#x2F;Roles</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\du</span><br></pre></td></tr></table></figure>

<h3 id="Check-Current-Database"><a href="#Check-Current-Database" class="headerlink" title="Check Current Database"></a>Check Current Database</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> current_database();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Table-Management"><a href="#Table-Management" class="headerlink" title="Table Management"></a>Table Management</h2><h3 id="List-All-Tables-in-the-Current-Database"><a href="#List-All-Tables-in-the-Current-Database" class="headerlink" title="List All Tables in the Current Database"></a>List All Tables in the Current Database</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\dt</span><br></pre></td></tr></table></figure>

<h3 id="List-All-Tables-with-Additional-Details"><a href="#List-All-Tables-with-Additional-Details" class="headerlink" title="List All Tables with Additional Details"></a>List All Tables with Additional Details</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\dt<span class="operator">+</span></span><br></pre></td></tr></table></figure>

<h3 id="Describe-a-Table-Columns-Types-etc"><a href="#Describe-a-Table-Columns-Types-etc" class="headerlink" title="Describe a Table (Columns, Types, etc.)"></a>Describe a Table (Columns, Types, etc.)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\d table_name</span><br></pre></td></tr></table></figure>

<h3 id="Show-Table-Schema"><a href="#Show-Table-Schema" class="headerlink" title="Show Table Schema"></a>Show Table Schema</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\d<span class="operator">+</span> table_name</span><br></pre></td></tr></table></figure>

<h3 id="Check-Table-Size-Including-Indexes"><a href="#Check-Table-Size-Including-Indexes" class="headerlink" title="Check Table Size (Including Indexes)"></a>Check Table Size (Including Indexes)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_size_pretty(pg_total_relation_size(<span class="string">&#x27;table_name&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Check-Table-Row-Count"><a href="#Check-Table-Row-Count" class="headerlink" title="Check Table Row Count"></a>Check Table Row Count</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<h3 id="Show-Indexes-of-a-Table"><a href="#Show-Indexes-of-a-Table" class="headerlink" title="Show Indexes of a Table"></a>Show Indexes of a Table</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\di table_name</span><br></pre></td></tr></table></figure>

<h3 id="Show-Table-Constraints"><a href="#Show-Table-Constraints" class="headerlink" title="Show Table Constraints"></a>Show Table Constraints</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\d table_name</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Query-Execution-and-Statistics"><a href="#Query-Execution-and-Statistics" class="headerlink" title="Query Execution and Statistics"></a>Query Execution and Statistics</h2><h3 id="Explain-a-Query-Execution-Plan"><a href="#Explain-a-Query-Execution-Plan" class="headerlink" title="Explain a Query (Execution Plan)"></a>Explain a Query (Execution Plan)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<h3 id="Explain-with-Detailed-Statistics"><a href="#Explain-with-Detailed-Statistics" class="headerlink" title="Explain with Detailed Statistics"></a>Explain with Detailed Statistics</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN ANALYZE <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name;</span><br></pre></td></tr></table></figure>

<h3 id="Show-Query-Execution-Time"><a href="#Show-Query-Execution-Time" class="headerlink" title="Show Query Execution Time"></a>Show Query Execution Time</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\timing</span><br></pre></td></tr></table></figure>

<h3 id="Show-Active-Queries"><a href="#Show-Active-Queries" class="headerlink" title="Show Active Queries"></a>Show Active Queries</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> pg_stat_activity;</span><br></pre></td></tr></table></figure>

<h3 id="Cancel-a-Running-Query"><a href="#Cancel-a-Running-Query" class="headerlink" title="Cancel a Running Query"></a>Cancel a Running Query</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_cancel_backend(pid);</span><br></pre></td></tr></table></figure>

<h3 id="Terminate-a-Running-Query"><a href="#Terminate-a-Running-Query" class="headerlink" title="Terminate a Running Query"></a>Terminate a Running Query</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_terminate_backend(pid);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="User-and-Role-Management"><a href="#User-and-Role-Management" class="headerlink" title="User and Role Management"></a>User and Role Management</h2><h3 id="Create-a-New-User-Role"><a href="#Create-a-New-User-Role" class="headerlink" title="Create a New User&#x2F;Role"></a>Create a New User&#x2F;Role</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ROLE role_name <span class="keyword">WITH</span> LOGIN PASSWORD <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Grant-Privileges-to-a-User"><a href="#Grant-Privileges-to-a-User" class="headerlink" title="Grant Privileges to a User"></a>Grant Privileges to a User</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> DATABASE database_name <span class="keyword">TO</span> role_name;</span><br></pre></td></tr></table></figure>

<h3 id="Revoke-Privileges-from-a-User"><a href="#Revoke-Privileges-from-a-User" class="headerlink" title="Revoke Privileges from a User"></a>Revoke Privileges from a User</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> DATABASE database_name <span class="keyword">FROM</span> role_name;</span><br></pre></td></tr></table></figure>

<h3 id="Alter-User-Password"><a href="#Alter-User-Password" class="headerlink" title="Alter User Password"></a>Alter User Password</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> role_name <span class="keyword">WITH</span> PASSWORD <span class="string">&#x27;new_password&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Delete-a-User-Role"><a href="#Delete-a-User-Role" class="headerlink" title="Delete a User&#x2F;Role"></a>Delete a User&#x2F;Role</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> ROLE role_name;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Backup-and-Restore"><a href="#Backup-and-Restore" class="headerlink" title="Backup and Restore"></a>Backup and Restore</h2><h3 id="Backup-a-Database"><a href="#Backup-a-Database" class="headerlink" title="Backup a Database"></a>Backup a Database</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -U username -d database_name -f backup_file.sql</span><br></pre></td></tr></table></figure>

<h3 id="Restore-a-Database"><a href="#Restore-a-Database" class="headerlink" title="Restore a Database"></a>Restore a Database</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U username -d database_name -f backup_file.sql</span><br></pre></td></tr></table></figure>

<h3 id="Backup-All-Databases"><a href="#Backup-All-Databases" class="headerlink" title="Backup All Databases"></a>Backup All Databases</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dumpall -U username -f backup_file.sql</span><br></pre></td></tr></table></figure>

<h3 id="Restore-All-Databases"><a href="#Restore-All-Databases" class="headerlink" title="Restore All Databases"></a>Restore All Databases</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U username -f backup_file.sql</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="Show-PostgreSQL-Version"><a href="#Show-PostgreSQL-Version" class="headerlink" title="Show PostgreSQL Version"></a>Show PostgreSQL Version</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> version();</span><br></pre></td></tr></table></figure>

<h3 id="Show-Current-User"><a href="#Show-Current-User" class="headerlink" title="Show Current User"></a>Show Current User</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">current_user</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Show-All-Settings"><a href="#Show-All-Settings" class="headerlink" title="Show All Settings"></a>Show All Settings</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">ALL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Quit-psql"><a href="#Quit-psql" class="headerlink" title="Quit psql"></a>Quit psql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\q</span><br></pre></td></tr></table></figure>

<h3 id="Help-for-SQL-Commands"><a href="#Help-for-SQL-Commands" class="headerlink" title="Help for SQL Commands"></a>Help for SQL Commands</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\h</span><br></pre></td></tr></table></figure>

<h3 id="Help-for-psql-Commands"><a href="#Help-for-psql-Commands" class="headerlink" title="Help for psql Commands"></a>Help for psql Commands</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\?</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/03/22/Beat-Practices-of-Keycloak-Production-Configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/22/Beat-Practices-of-Keycloak-Production-Configuration/" class="post-title-link" itemprop="url">Beat Practices of Keycloak Production Configuration</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-22 18:26:05" itemprop="dateCreated datePublished" datetime="2025-03-22T18:26:05-04:00">2025-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-24 12:06:04" itemprop="dateModified" datetime="2025-03-24T12:06:04-04:00">2025-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Keycloak/" itemprop="url" rel="index"><span itemprop="name">Keycloak</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-Hostname-Configuration-in-keycloak-conf"><a href="#1-Hostname-Configuration-in-keycloak-conf" class="headerlink" title="1. Hostname Configuration in keycloak.conf"></a><strong>1. Hostname Configuration in <code>keycloak.conf</code></strong></h3><p>The <code>hostname</code> setting in <code>keycloak.conf</code> is <strong>mandatory for production deployments</strong> if Keycloak needs to generate URLs (e.g., for redirects, emails, or tokens). This ensures that Keycloak uses the correct public-facing URL (e.g., <code>www.keytomarvel.com</code>) instead of the internal server address.</p>
<ul>
<li><p><strong>Why is it important?</strong></p>
<ul>
<li>Keycloak uses the <code>hostname</code> to construct URLs for redirects, emails, and tokens.</li>
<li>If not set, Keycloak might generate URLs using the internal server IP or hostname, which won’t work for external clients.</li>
</ul>
</li>
<li><p><strong>Example Configuration</strong>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname</span>=www.keytomarvel.com</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="2-Proxy-Configuration-in-keycloak-conf"><a href="#2-Proxy-Configuration-in-keycloak-conf" class="headerlink" title="2. Proxy Configuration in keycloak.conf"></a><strong>2. Proxy Configuration in <code>keycloak.conf</code></strong></h3><p>Since NGINX is handling HTTPS termination, you need to configure Keycloak to trust the proxy. This is done using the <code>proxy</code> setting.</p>
<ul>
<li><p><strong>proxy&#x3D;edge Configuration</strong>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy</span>=edge</span><br></pre></td></tr></table></figure>

<ul>
<li><code>proxy=edge</code>: Use this when NGINX terminates HTTPS and forwards requests to Keycloak over HTTP.</li>
<li>If NGINX forwards requests over HTTPS to Keycloak, use <code>proxy=reencrypt</code>.</li>
</ul>
</li>
<li><p><strong>Why is it important?</strong></p>
<ul>
<li>Keycloak needs to know it’s behind a proxy to correctly handle headers like <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code>.</li>
</ul>
</li>
<li><p><strong>Trust the X-Forwarded-* headers from the reverse proxy</strong>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy-headers</span>=xforwarded</span><br></pre></td></tr></table></figure>
<ul>
<li><code>proxy=edge</code>: Tells Keycloak it is behind a reverse proxy.</li>
<li><code>proxy-headers=xforwarded</code>: Trusts the <code>X-Forwarded-*</code> headers from Nginx.</li>
</ul>
</li>
<li><p><strong>Update the CSP</strong>:</p>
<p>Update the CSP in your <code>keycloak.conf</code> file to allow framing over HTTPS:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Content Security Policy configuration</span></span><br><span class="line"><span class="attr">spi-events-listener</span>=csp</span><br><span class="line"><span class="attr">spi-events-listener-csp-policy-directives</span>=frame-src <span class="string">&#x27;self&#x27;</span> https://www.keytomarvel.com</span><br></pre></td></tr></table></figure>
<ul>
<li><code>frame-src &#39;self&#39; https://www.keytomarvel.com</code>: Allows framing for the Keycloak admin console over HTTPS.</li>
</ul>
</li>
</ul>
<h3 id="The-complete-keycloak-conf"><a href="#The-complete-keycloak-conf" class="headerlink" title="The complete keycloak.conf"></a>The complete <code>keycloak.conf</code></h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db</span>=postgres</span><br><span class="line"><span class="attr">db-username</span>=username</span><br><span class="line"><span class="attr">db-password</span>=password</span><br><span class="line"><span class="attr">db-url</span>=jdbc:postgresql://<span class="number">192.168</span>.<span class="number">2.128</span>:<span class="number">5432</span>/k2m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname for the Keycloak server. IS MANDATORY FOR PROD!!!</span></span><br><span class="line"><span class="attr">hostname</span>=www.keytomarvel.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># The proxy address forwarding mode if the server is behind a reverse proxy.</span></span><br><span class="line"><span class="attr">proxy</span>=edge</span><br><span class="line"></span><br><span class="line"><span class="comment"># Content Security Policy configuration</span></span><br><span class="line"><span class="attr">spi-events-listener</span>=csp</span><br><span class="line"><span class="attr">spi-events-listener-csp-policy-directives</span>=frame-src <span class="string">&#x27;self&#x27;</span> https://www.keytomarvel.com</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Trust the X-Forwarded-* headers from the reverse proxy</span></span><br><span class="line"><span class="attr">proxy-headers</span>=xforwarded</span><br><span class="line"></span><br><span class="line"><span class="attr">quarkus.hibernate-orm.persistence-xml.ignore</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="3-docker-compose-for-PROD"><a href="#3-docker-compose-for-PROD" class="headerlink" title="3. docker-compose for PROD"></a><strong>3. docker-compose for PROD</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">keycloak:</span></span><br><span class="line">      <span class="attr">build:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">        <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">KEYCLOAK_ADMIN:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">KEYCLOAK_ADMIN_PASSWORD:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">KC_HTTP_ENABLED:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">        <span class="attr">KC_HTTP_PORT:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">KC_LOG:</span> <span class="string">console,file</span></span><br><span class="line">        <span class="attr">KC_LOG_LEVEL:</span> <span class="string">DEBUG</span></span><br><span class="line">        <span class="attr">KC_LOG_FILE:</span> <span class="string">/opt/keycloak/data/log/keycloak.log</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./volumes/keycloak/conf:/opt/keycloak/conf</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./volumes/keycloak/log:/opt/keycloak/data/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./volumes/keycloak/providers:/opt/keycloak/providers</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./volumes/keycloak/themes:/opt/keycloak/themes</span></span><br><span class="line">      <span class="attr">networks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">8888</span><span class="string">:8080</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">start</span></span><br></pre></td></tr></table></figure>

<h3 id="4-NGINX-Configuration"><a href="#4-NGINX-Configuration" class="headerlink" title="4. NGINX Configuration"></a><strong>4. NGINX Configuration</strong></h3><p>Here’s an example NGINX configuration for routing traffic to Keycloak:</p>
<h4 id="NGINX-Configuration-Example"><a href="#NGINX-Configuration-Example" class="headerlink" title="NGINX Configuration Example"></a><strong>NGINX Configuration Example</strong></h4><p>— &#x2F;etc&#x2F;nginx&#x2F;site-available&#x2F;keytomarvel.com</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/html;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> keytomarvel.com www.keytomarvel.com;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># Proxy requests to the Keycloak application running on port 8888</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:8888;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Port <span class="variable">$server_port</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl ipv6only=<span class="literal">on</span>; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/keytomarvel.com/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/keytomarvel.com/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> = www.keytomarvel.com) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> = keytomarvel.com) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> keytomarvel.com www.keytomarvel.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>; <span class="comment"># managed by Certbot</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Key Points</strong>:<ul>
<li>NGINX terminates HTTPS and forwards requests to Keycloak over HTTP.</li>
<li>The <code>proxy_set_header</code> directives ensure Keycloak receives the correct client IP and protocol information.</li>
<li>Ensure Nginx Passes Correct Headers<ul>
<li><code>proxy_set_header X-Forwarded-Proto $scheme;</code>: Tells Keycloak that the original request was HTTPS.</li>
<li><code>proxy_set_header X-Forwarded-Host $host;</code>: Passes the original hostname to Keycloak.</li>
<li><code>proxy_set_header X-Forwarded-Port $server_port;</code>: Passes the original port to Keycloak.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="5-Additional-Production-Considerations"><a href="#5-Additional-Production-Considerations" class="headerlink" title="5. Additional Production Considerations"></a><strong>5. Additional Production Considerations</strong></h3><p>Here are some additional settings and best practices for a production deployment:</p>
<h4 id="a-Database-Connection-Pooling"><a href="#a-Database-Connection-Pooling" class="headerlink" title="a. Database Connection Pooling"></a><strong>a. Database Connection Pooling</strong></h4><p>Ensure the database connection pool is configured for production workloads:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db-pool-initial-size</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">db-pool-max-size</span>=<span class="number">100</span></span><br></pre></td></tr></table></figure>

<h4 id="b-Caching"><a href="#b-Caching" class="headerlink" title="b. Caching"></a><strong>b. Caching</strong></h4><p>Enable distributed caching for high availability:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cache</span>=ispn</span><br><span class="line"><span class="attr">cache-stack</span>=kubernetes <span class="comment"># or &#x27;tcp&#x27; for non-Kubernetes environments</span></span><br></pre></td></tr></table></figure>

<h4 id="c-Health-Checks-and-Metrics"><a href="#c-Health-Checks-and-Metrics" class="headerlink" title="c. Health Checks and Metrics"></a><strong>c. Health Checks and Metrics</strong></h4><p>Enable health checks and metrics for monitoring:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">health-enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">metrics-enabled</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="d-Token-and-Session-Timeouts"><a href="#d-Token-and-Session-Timeouts" class="headerlink" title="d. Token and Session Timeouts"></a><strong>d. Token and Session Timeouts</strong></h4><p>Adjust token and session timeouts for security and usability:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">token-lifespan</span>=<span class="number">3600</span> <span class="comment"># Access token lifespan (1 hour)</span></span><br><span class="line"><span class="attr">refresh-token-lifespan</span>=<span class="number">86400</span> <span class="comment"># Refresh token lifespan (24 hours)</span></span><br><span class="line"><span class="attr">session-max-lifespan</span>=<span class="number">86400</span> <span class="comment"># Maximum session lifespan (24 hours)</span></span><br><span class="line"><span class="attr">session-idle-timeout</span>=<span class="number">1800</span> <span class="comment"># Session idle timeout (30 minutes)</span></span><br></pre></td></tr></table></figure>

<h4 id="e-Logging"><a href="#e-Logging" class="headerlink" title="e. Logging"></a><strong>e. Logging</strong></h4><p>Configure logging for production:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log-level</span>=INFO</span><br><span class="line"><span class="attr">log-console-output</span>=json</span><br><span class="line"><span class="attr">log-file</span>=/var/log/keycloak/keycloak.log</span><br></pre></td></tr></table></figure>

<h4 id="f-Email-Configuration"><a href="#f-Email-Configuration" class="headerlink" title="f. Email Configuration"></a><strong>f. Email Configuration</strong></h4><p>Set up email for password resets and notifications:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">smtp-host</span>=smtp.example.com</span><br><span class="line"><span class="attr">smtp-port</span>=<span class="number">587</span></span><br><span class="line"><span class="attr">smtp-username</span>=user@example.com</span><br><span class="line"><span class="attr">smtp-password</span>=changeit</span><br><span class="line"><span class="attr">smtp-from</span>=keycloak@example.com</span><br><span class="line"><span class="attr">smtp-ssl</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">smtp-starttls</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="g-Security-Headers"><a href="#g-Security-Headers" class="headerlink" title="g. Security Headers"></a><strong>g. Security Headers</strong></h4><p>Ensure NGINX adds security headers:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> X-Content-Type-Options <span class="string">&quot;nosniff&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> X-Frame-Options <span class="string">&quot;SAMEORIGIN&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span> always;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="6-Full-keycloak-conf-for-Production"><a href="#6-Full-keycloak-conf-for-Production" class="headerlink" title="6. Full keycloak.conf for Production"></a><strong>6. Full <code>keycloak.conf</code> for Production</strong></h3><p>Here’s a complete <code>keycloak.conf</code> tailored for your setup:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Keycloak Production Configuration</span></span><br><span class="line"><span class="comment"># Database Configuration</span></span><br><span class="line"><span class="attr">db</span>=postgres</span><br><span class="line"><span class="attr">db-url</span>=jdbc:postgresql://localhost:<span class="number">5432</span>/keycloak</span><br><span class="line"><span class="attr">db-username</span>=username</span><br><span class="line"><span class="attr">db-password</span>=password</span><br><span class="line"><span class="attr">db-pool-initial-size</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">db-pool-max-size</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP and HTTPS Configuration</span></span><br><span class="line"><span class="attr">http-enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">http-port</span>=<span class="number">8080</span></span><br><span class="line"><span class="attr">hostname</span>=www.keytomarvel.com</span><br><span class="line"><span class="attr">proxy</span>=edge</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cache Configuration</span></span><br><span class="line"><span class="attr">cache</span>=ispn</span><br><span class="line"><span class="attr">cache-stack</span>=kubernetes <span class="comment"># or &#x27;tcp&#x27; for non-Kubernetes environments</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging Configuration</span></span><br><span class="line"><span class="attr">log-level</span>=INFO</span><br><span class="line"><span class="attr">log-console-output</span>=json</span><br><span class="line"><span class="attr">log-file</span>=/var/log/keycloak/keycloak.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Health and Metrics</span></span><br><span class="line"><span class="attr">health-enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">metrics-enabled</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Token and Session Configuration</span></span><br><span class="line"><span class="attr">token-lifespan</span>=<span class="number">3600</span></span><br><span class="line"><span class="attr">refresh-token-lifespan</span>=<span class="number">86400</span></span><br><span class="line"><span class="attr">session-max-lifespan</span>=<span class="number">86400</span></span><br><span class="line"><span class="attr">session-idle-timeout</span>=<span class="number">1800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Email Configuration</span></span><br><span class="line"><span class="attr">smtp-host</span>=smtp.example.com</span><br><span class="line"><span class="attr">smtp-port</span>=<span class="number">587</span></span><br><span class="line"><span class="attr">smtp-username</span>=user@example.com</span><br><span class="line"><span class="attr">smtp-password</span>=changeit</span><br><span class="line"><span class="attr">smtp-from</span>=keycloak@example.com</span><br><span class="line"><span class="attr">smtp-ssl</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">smtp-starttls</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="7-Deployment-Checklist"><a href="#7-Deployment-Checklist" class="headerlink" title="7. Deployment Checklist"></a><strong>7. Deployment Checklist</strong></h3><ol>
<li><strong>Set <code>hostname</code></strong>: Ensure <code>hostname</code> is set to the public-facing URL (<code>www.keytomarvel.com</code>).</li>
<li><strong>Configure NGINX</strong>: Terminate HTTPS at NGINX and forward requests to Keycloak over HTTP.</li>
<li><strong>Enable Proxy Mode</strong>: Set <code>proxy=edge</code> in <code>keycloak.conf</code>.</li>
<li><strong>Database Tuning</strong>: Configure connection pooling and ensure the database is optimized.</li>
<li><strong>Caching</strong>: Enable distributed caching for high availability.</li>
<li><strong>Monitoring</strong>: Enable health checks and metrics.</li>
<li><strong>Security</strong>: Add security headers in NGINX and ensure tokens&#x2F;sessions are securely configured.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
