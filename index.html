<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">126</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/12/01/Full-Fine-Tuning-vs-LoRA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/12/01/Full-Fine-Tuning-vs-LoRA/" class="post-title-link" itemprop="url">Full Fine-Tuning vs LoRA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-12-01 14:37:04 / Modified: 15:03:26" itemprop="dateCreated datePublished" datetime="2025-12-01T14:37:04-05:00">2025-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LoRA/" itemprop="url" rel="index"><span itemprop="name">LoRA</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LoRA/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LoRA/AI/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h2><ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#what-is-fine-tuning">What is Fine-Tuning?</a></li>
<li><a href="#full-fine-tuning-explained">Full Fine-Tuning Explained</a></li>
<li><a href="#lora-low-rank-adaptation-explained">LoRA (Low-Rank Adaptation) Explained</a></li>
<li><a href="#technical-comparison">Technical Comparison</a></li>
<li><a href="#real-world-use-cases">Real-World Use Cases</a></li>
<li><a href="#when-to-use-which-method">When to Use Which Method</a></li>
<li><a href="#hands-on-practice-guide">Hands-On Practice Guide</a></li>
<li><a href="#advanced-topics">Advanced Topics</a></li>
<li><a href="#decision-framework">Decision Framework</a></li>
</ol>
<hr>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In the era of Large Language Models (LLMs), <strong>fine-tuning</strong> has become the key to adapting pre-trained models to specific tasks. Two main approaches dominate the landscape:</p>
<ul>
<li><strong>Full Fine-Tuning</strong>: Training all model parameters</li>
<li><strong>LoRA (Low-Rank Adaptation)</strong>: Training only a small subset of parameters</li>
</ul>
<hr>
<h2 id="What-is-Fine-Tuning"><a href="#What-is-Fine-Tuning" class="headerlink" title="What is Fine-Tuning?"></a>What is Fine-Tuning?</h2><h3 id="Simple-Analogy"><a href="#Simple-Analogy" class="headerlink" title="Simple Analogy"></a>Simple Analogy</h3><p>Think of a pre-trained model as a <strong>medical doctor with general knowledge</strong>. Fine-tuning is like:</p>
<ul>
<li><strong>Full Fine-Tuning</strong>: Sending the doctor back to medical school to relearn everything with a focus on a specialty</li>
<li><strong>LoRA</strong>: Giving the doctor a specialized handbook they can reference without forgetting their general knowledge</li>
</ul>
<h3 id="Technical-Definition"><a href="#Technical-Definition" class="headerlink" title="Technical Definition"></a>Technical Definition</h3><p>Fine-tuning takes a pre-trained model (trained on massive general data) and continues training it on domain-specific data to improve performance on particular tasks.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pre-trained Model (General Knowledge)</span><br><span class="line">         â†“</span><br><span class="line">    Fine-Tuning (Specialized Training)</span><br><span class="line">         â†“</span><br><span class="line">Task-Specific Model (Expert Knowledge)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Full-Fine-Tuning-Explained"><a href="#Full-Fine-Tuning-Explained" class="headerlink" title="Full Fine-Tuning Explained"></a>Full Fine-Tuning Explained</h2><h3 id="What-is-Full-Fine-Tuning"><a href="#What-is-Full-Fine-Tuning" class="headerlink" title="What is Full Fine-Tuning?"></a>What is Full Fine-Tuning?</h3><p>Full fine-tuning means <strong>updating ALL parameters</strong> in the model during training.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Model Architecture (Example: 7B parameters)</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  Layer 1: [All parameters trainable] â”‚ â† Updated</span><br><span class="line">â”‚  Layer 2: [All parameters trainable] â”‚ â† Updated</span><br><span class="line">â”‚  Layer 3: [All parameters trainable] â”‚ â† Updated</span><br><span class="line">â”‚  ...                                 â”‚ â† Updated</span><br><span class="line">â”‚  Layer N: [All parameters trainable] â”‚ â† Updated</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">Total Trainable: 7,000,000,000 params</span><br></pre></td></tr></table></figure>

<h3 id="How-It-Works"><a href="#How-It-Works" class="headerlink" title="How It Works"></a>How It Works</h3><ol>
<li><strong>Load pre-trained model</strong> (e.g., GPT-3, LLaMA, ChatGLM)</li>
<li><strong>Prepare task-specific dataset</strong> (e.g., medical Q&amp;A, legal documents)</li>
<li><strong>Train ALL parameters</strong> using your dataset</li>
<li><strong>Save the entire model</strong> (full 7B+ parameters)</li>
</ol>
<h3 id="Advantages-âœ…"><a href="#Advantages-âœ…" class="headerlink" title="Advantages âœ…"></a>Advantages âœ…</h3><ol>
<li><strong>Maximum Performance</strong>: Can achieve the best possible results</li>
<li><strong>Deep Customization</strong>: All parameters adapt to your specific task</li>
<li><strong>Flexible</strong>: Works for any task, especially those very different from pre-training</li>
</ol>
<h3 id="Disadvantages-âŒ"><a href="#Disadvantages-âŒ" class="headerlink" title="Disadvantages âŒ"></a>Disadvantages âŒ</h3><ol>
<li><p><strong>Extremely High Cost</strong>:</p>
<ul>
<li>GPT-3 175B full fine-tuning requires <strong>&gt;2TB GPU memory</strong></li>
<li>Needs high-end GPU clusters (multiple A100s)</li>
<li>Training can cost <strong>$20,000+</strong> per run</li>
</ul>
</li>
<li><p><strong>Long Training Time</strong>: Days or weeks to complete</p>
</li>
<li><p><strong>Storage Overhead</strong>: </p>
<ul>
<li>Each task needs a complete model copy</li>
<li>7B model &#x3D; ~14GB storage per task</li>
<li>10 tasks &#x3D; 140GB storage needed</li>
</ul>
</li>
<li><p><strong>Catastrophic Forgetting</strong>:</p>
<ul>
<li>Model may lose general knowledge</li>
<li>Reduced generalization ability</li>
</ul>
</li>
</ol>
<h3 id="Real-World-Example"><a href="#Real-World-Example" class="headerlink" title="Real-World Example"></a>Real-World Example</h3><p><strong>Googleâ€™s Multilingual Search Optimization</strong></p>
<ul>
<li>Used full fine-tuning on BERT-Large for multilingual search</li>
<li>Result: 25% improvement in low-resource language recall</li>
<li>Cost: Requires massive GPU infrastructure</li>
<li>Benefit: State-of-the-art performance across 100+ languages</li>
</ul>
<hr>
<h2 id="LoRA-Low-Rank-Adaptation-Explained"><a href="#LoRA-Low-Rank-Adaptation-Explained" class="headerlink" title="LoRA (Low-Rank Adaptation) Explained"></a>LoRA (Low-Rank Adaptation) Explained</h2><h3 id="What-is-LoRA"><a href="#What-is-LoRA" class="headerlink" title="What is LoRA?"></a>What is LoRA?</h3><p>LoRA is a <strong>parameter-efficient fine-tuning</strong> method proposed by Microsoft in 2021. Instead of updating all parameters, LoRA:</p>
<ul>
<li><strong>Freezes</strong> the original model weights</li>
<li><strong>Adds small â€œadapterâ€ matrices</strong> to specific layers</li>
<li><strong>Trains only</strong> these tiny adapters (typically 0.1%-1% of total parameters)</li>
</ul>
<h3 id="Visual-Explanation"><a href="#Visual-Explanation" class="headerlink" title="Visual Explanation"></a>Visual Explanation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Original Transformer Layer</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  Pre-trained Weight Matrix W           â”‚</span><br><span class="line">â”‚  [Frozen - Not Updated]                â”‚</span><br><span class="line">â”‚          +                             â”‚</span><br><span class="line">â”‚  Low-Rank Adapter: A Ã— B               â”‚</span><br><span class="line">â”‚  [Trainable - Only These Updated]      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">Output = WÂ·x + AÂ·BÂ·x</span><br><span class="line">         â†‘      â†‘</span><br><span class="line">      Frozen  Trained (tiny!)</span><br></pre></td></tr></table></figure>

<h3 id="Mathematical-Foundation"><a href="#Mathematical-Foundation" class="headerlink" title="Mathematical Foundation"></a>Mathematical Foundation</h3><p>For a pre-trained weight matrix <strong>W</strong> (dimension d Ã— k):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Full Fine-Tuning:</span><br><span class="line">  Updates: Î”W (d Ã— k parameters)</span><br><span class="line">  Total trainable: d Ã— k</span><br><span class="line"></span><br><span class="line">LoRA:</span><br><span class="line">  Decomposes: Î”W â‰ˆ A Ã— B</span><br><span class="line">  Where: A is (d Ã— r), B is (r Ã— k)</span><br><span class="line">  Total trainable: dÃ—r + rÃ—k</span><br><span class="line">  </span><br><span class="line">Example (d=4096, k=4096, r=8):</span><br><span class="line">  Full: 4096 Ã— 4096 = 16,777,216 params</span><br><span class="line">  LoRA: 4096Ã—8 + 8Ã—4096 = 65,536 params</span><br><span class="line">  Reduction: 99.6%! ğŸ‰</span><br></pre></td></tr></table></figure>

<h3 id="How-LoRA-Works-Step-by-Step"><a href="#How-LoRA-Works-Step-by-Step" class="headerlink" title="How LoRA Works (Step-by-Step)"></a>How LoRA Works (Step-by-Step)</h3><ol>
<li><p><strong>Freeze Original Model</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for param in pretrained_model.parameters():</span><br><span class="line">    param.requires_grad = False  # Don&#x27;t update these</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Inject Low-Rank Matrices</strong></p>
<ul>
<li>Insert matrices A and B into attention layers</li>
<li>Initialize: A with random values, B with zeros</li>
<li>Typically apply to Query, Value projection matrices</li>
</ul>
</li>
<li><p><strong>Train Only Adapters</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for param in lora_adapters.parameters():</span><br><span class="line">    param.requires_grad = True  # Only update these</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Inference</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output = original_weight @ x + (A @ B) @ x</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Advantages-âœ…-1"><a href="#Advantages-âœ…-1" class="headerlink" title="Advantages âœ…"></a>Advantages âœ…</h3><ol>
<li><p><strong>Extreme Parameter Efficiency</strong>:</p>
<ul>
<li>Reduces trainable parameters by <strong>90-99%</strong></li>
<li>7B model: Train only 7-70M parameters instead of 7B</li>
</ul>
</li>
<li><p><strong>Low Cost, Fast Deployment</strong>:</p>
<ul>
<li>Consumer GPU (RTX 4090, RTX 3090) can fine-tune large models</li>
<li>Training time: Hours instead of days</li>
<li>Cost: <strong>$50-200</strong> instead of $20,000+</li>
</ul>
</li>
<li><p><strong>Multi-Task Flexibility</strong>:</p>
<ul>
<li>Save only adapter weights (~10-100MB per task)</li>
<li>Dynamically load different adapters for different tasks</li>
<li>One base model + multiple adapters &#x3D; multiple specialized models</li>
</ul>
</li>
<li><p><strong>Less Catastrophic Forgetting</strong>:</p>
<ul>
<li>Original weights unchanged</li>
<li>Retains general knowledge better</li>
</ul>
</li>
</ol>
<h3 id="Disadvantages-âŒ-1"><a href="#Disadvantages-âŒ-1" class="headerlink" title="Disadvantages âŒ"></a>Disadvantages âŒ</h3><ol>
<li><p><strong>Rank Parameter Tuning Required</strong>:</p>
<ul>
<li>Too small <code>r</code> (rank) â†’ underfitting</li>
<li>Too large <code>r</code> â†’ loses efficiency</li>
<li>Needs experimentation</li>
</ul>
</li>
<li><p><strong>â€œIntruder Dimensionsâ€ Problem</strong> (Recent Discovery):</p>
<ul>
<li>LoRA introduces high-ranking singular vectors</li>
<li>Reduces out-of-distribution (OOD) generalization by 5-8%</li>
<li>Less robust in continual learning scenarios</li>
</ul>
</li>
<li><p><strong>Slightly Lower Peak Performance</strong>:</p>
<ul>
<li>May not reach absolute best performance</li>
<li>Gap is usually small (&lt;1-3%) for most tasks</li>
</ul>
</li>
</ol>
<h3 id="Real-World-Examples"><a href="#Real-World-Examples" class="headerlink" title="Real-World Examples"></a>Real-World Examples</h3><p><strong>1. Medical Document Summarization</strong></p>
<ul>
<li>Hospital used LoRA to fine-tune GPT-3 for medical report generation</li>
<li>Result: High-quality summaries, doctor efficiency increased 40%</li>
<li>Cost: Single RTX A6000 GPU, trained in 6 hours</li>
<li>Storage: Base model (14GB) + Adapter (50MB)</li>
</ul>
<p><strong>2. E-commerce Customer Service</strong></p>
<ul>
<li>Online retailer fine-tuned ChatGLM for customer support</li>
<li>Result: Response speed improved 3x, satisfaction up 25%</li>
<li>Deployment: 5 different product category adapters</li>
<li>Total storage: One model + 5 adapters &#x3D; 14.3GB (vs 70GB for 5 full models)</li>
</ul>
<p><strong>3. Financial News Generation</strong></p>
<ul>
<li>News agency fine-tuned GPT-3 for real-time financial reporting</li>
<li>Result: News generation latency reduced to seconds, 40% cost reduction</li>
<li>Adaptation time: 4 hours on 2Ã— RTX 4090</li>
</ul>
<hr>
<h2 id="Technical-Comparison"><a href="#Technical-Comparison" class="headerlink" title="Technical Comparison"></a>Technical Comparison</h2><h3 id="Architecture-Comparison"><a href="#Architecture-Comparison" class="headerlink" title="Architecture Comparison"></a>Architecture Comparison</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FULL FINE-TUNING</span><br><span class="line">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span><br><span class="line">Input â†’ [Layer 1 âœï¸] â†’ [Layer 2 âœï¸] â†’ [Layer 3 âœï¸] â†’ Output</span><br><span class="line">        All Updated   All Updated    All Updated</span><br><span class="line"></span><br><span class="line">LoRA</span><br><span class="line">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span><br><span class="line">Input â†’ [Layer 1 ğŸ”’] â†’ [Layer 2 ğŸ”’] â†’ [Layer 3 ğŸ”’] â†’ Output</span><br><span class="line">        + Adapterâœï¸   + Adapterâœï¸    + Adapterâœï¸</span><br><span class="line">        </span><br><span class="line">ğŸ”’ = Frozen (unchanged)</span><br><span class="line">âœï¸ = Trainable (updated during training)</span><br></pre></td></tr></table></figure>

<h3 id="Detailed-Comparison-Table"><a href="#Detailed-Comparison-Table" class="headerlink" title="Detailed Comparison Table"></a>Detailed Comparison Table</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>Full Fine-Tuning</th>
<th>LoRA</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Trainable Parameters</strong></td>
<td>100% (e.g., 7B params)</td>
<td>0.1-1% (e.g., 7-70M params)</td>
</tr>
<tr>
<td><strong>GPU Memory</strong></td>
<td>Very High (&gt;80GB for 7B)</td>
<td>Low (24-48GB for 7B)</td>
</tr>
<tr>
<td><strong>Training Time</strong></td>
<td>Days to weeks</td>
<td>Hours to 1-2 days</td>
</tr>
<tr>
<td><strong>Cost per Training</strong></td>
<td>$10,000 - $100,000+</td>
<td>$50 - $500</td>
</tr>
<tr>
<td><strong>Storage per Task</strong></td>
<td>Full model (~14GB for 7B)</td>
<td>Adapter only (~10-100MB)</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Highest (100% baseline)</td>
<td>Very High (95-99% of full)</td>
</tr>
<tr>
<td><strong>Multi-Task Deployment</strong></td>
<td>Difficult (one model per task)</td>
<td>Easy (one model + N adapters)</td>
</tr>
<tr>
<td><strong>Catastrophic Forgetting</strong></td>
<td>High risk</td>
<td>Low risk</td>
</tr>
<tr>
<td><strong>Hardware Requirements</strong></td>
<td>High-end GPU cluster (A100Ã—8)</td>
<td>Consumer GPU (RTX 3090&#x2F;4090)</td>
</tr>
<tr>
<td><strong>Generalization (OOD)</strong></td>
<td>Best</td>
<td>Good (5-8% lower)</td>
</tr>
<tr>
<td><strong>Best For</strong></td>
<td>Maximum performance, unlimited budget</td>
<td>Fast iteration, limited resources</td>
</tr>
</tbody></table>
<h3 id="Memory-Comparison-7B-Model-Example"><a href="#Memory-Comparison-7B-Model-Example" class="headerlink" title="Memory Comparison (7B Model Example)"></a>Memory Comparison (7B Model Example)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Full Fine-Tuning (7B parameters):</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Model: 14GB                     â”‚</span><br><span class="line">â”‚ Optimizer States: 42GB          â”‚</span><br><span class="line">â”‚ Gradients: 14GB                 â”‚</span><br><span class="line">â”‚ Activations: 20GB               â”‚</span><br><span class="line">â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚</span><br><span class="line">â”‚ Total: ~90GB                    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">Required: 4Ã— A100 (40GB each)</span><br><span class="line"></span><br><span class="line">LoRA (7B base + 10M adapter):</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Base Model: 14GB (frozen)       â”‚</span><br><span class="line">â”‚ Adapter: 20MB                   â”‚</span><br><span class="line">â”‚ Optimizer States: 60MB          â”‚</span><br><span class="line">â”‚ Gradients: 20MB                 â”‚</span><br><span class="line">â”‚ Activations: 12GB               â”‚</span><br><span class="line">â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚</span><br><span class="line">â”‚ Total: ~27GB                    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">Required: 1Ã— RTX 3090/4090 (24GB)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Real-World-Use-Cases"><a href="#Real-World-Use-Cases" class="headerlink" title="Real-World Use Cases"></a>Real-World Use Cases</h2><h3 id="Use-Case-1-Healthcare-Clinical-Note-Generation"><a href="#Use-Case-1-Healthcare-Clinical-Note-Generation" class="headerlink" title="Use Case 1: Healthcare - Clinical Note Generation"></a>Use Case 1: Healthcare - Clinical Note Generation</h3><p><strong>Scenario</strong>: Hospital needs AI to generate structured clinical notes from doctor-patient conversations.</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Medical terminology requires domain adaptation</li>
<li>HIPAA compliance &#x3D; canâ€™t use cloud APIs</li>
<li>Limited budget and GPU resources</li>
</ul>
<p><strong>Solution: LoRA Fine-Tuning</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Approach</span></span><br><span class="line">Base Model: LLaMA-<span class="number">2</span>-7B</span><br><span class="line">Dataset: <span class="number">10</span>,<span class="number">000</span> anonymized clinical conversations</span><br><span class="line">Training: LoRA (r=<span class="number">16</span>, Î±=<span class="number">32</span>)</span><br><span class="line">Hardware: <span class="number">1</span>Ã— RTX A6000 (48GB)</span><br><span class="line">Time: <span class="number">8</span> hours</span><br><span class="line">Cost: ~$<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Results</span></span><br><span class="line">- Accuracy: <span class="number">94</span>% (vs <span class="number">96</span>% <span class="keyword">with</span> full fine-tuning)</span><br><span class="line">- Deployment: One base model + adapter (<span class="number">14.05</span>GB total)</span><br><span class="line">- Multi-specialty: <span class="number">5</span> adapters <span class="keyword">for</span> different departments (<span class="number">14.3</span>GB total)</span><br></pre></td></tr></table></figure>

<p><strong>Why LoRA Won</strong>:</p>
<ul>
<li>âœ… Budget-friendly</li>
<li>âœ… Fast iteration for different specialties</li>
<li>âœ… Meets accuracy requirements</li>
<li>âœ… Easy deployment on-premise</li>
</ul>
<hr>
<h3 id="Use-Case-2-Legal-Contract-Analysis"><a href="#Use-Case-2-Legal-Contract-Analysis" class="headerlink" title="Use Case 2: Legal - Contract Analysis"></a>Use Case 2: Legal - Contract Analysis</h3><p><strong>Scenario</strong>: Law firm needs to analyze merger &amp; acquisition contracts for risk factors.</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>Complex legal language</li>
<li>High accuracy requirement (mistakes &#x3D; legal liability)</li>
<li>Contracts vary significantly by jurisdiction</li>
</ul>
<p><strong>Solution: Full Fine-Tuning</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Approach</span></span><br><span class="line">Base Model: GPT-<span class="number">3.5</span>-turbo-instruct</span><br><span class="line">Dataset: <span class="number">50</span>,<span class="number">000</span> labeled M&amp;A contracts</span><br><span class="line">Training: Full fine-tuning <span class="built_in">all</span> parameters</span><br><span class="line">Hardware: <span class="number">8</span>Ã— A100 GPUs (cloud)</span><br><span class="line">Time: <span class="number">4</span> days</span><br><span class="line">Cost: ~$<span class="number">25</span>,<span class="number">000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Results</span></span><br><span class="line">- Accuracy: <span class="number">98.5</span>% (vs <span class="number">95</span>% <span class="keyword">with</span> LoRA r=<span class="number">64</span>)</span><br><span class="line">- Risk detection: <span class="number">99.2</span>% recall (critical <span class="keyword">for</span> legal)</span><br><span class="line">- <span class="literal">False</span> positive rate: <span class="number">1.8</span>% (vs <span class="number">4.2</span>% <span class="keyword">with</span> LoRA)</span><br></pre></td></tr></table></figure>

<p><strong>Why Full Fine-Tuning Won</strong>:</p>
<ul>
<li>âœ… Maximum accuracy needed (legal liability)</li>
<li>âœ… Budget available (law firm can afford)</li>
<li>âœ… Single specialized task</li>
<li>âœ… 3% accuracy improvement &#x3D; millions in risk mitigation</li>
</ul>
<hr>
<h3 id="Use-Case-3-E-Commerce-Multi-Category-Product-Descriptions"><a href="#Use-Case-3-E-Commerce-Multi-Category-Product-Descriptions" class="headerlink" title="Use Case 3: E-Commerce - Multi-Category Product Descriptions"></a>Use Case 3: E-Commerce - Multi-Category Product Descriptions</h3><p><strong>Scenario</strong>: Online marketplace needs to generate product descriptions for 10 different categories (electronics, fashion, home, etc.).</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>10 different writing styles needed</li>
<li>Rapid product launches (new categories added quarterly)</li>
<li>Budget-conscious startup</li>
</ul>
<p><strong>Solution: LoRA with Multi-Adapter Architecture</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Approach</span></span><br><span class="line">Base Model: Qwen-7B</span><br><span class="line">Training: <span class="number">10</span> separate LoRA adapters (r=<span class="number">8</span>)</span><br><span class="line">  - Electronics adapter</span><br><span class="line">  - Fashion adapter</span><br><span class="line">  - Home &amp; Garden adapter</span><br><span class="line">  - Sports adapter</span><br><span class="line">  - ... (<span class="number">6</span> more)</span><br><span class="line">Hardware: <span class="number">1</span>Ã— RTX <span class="number">4090</span></span><br><span class="line">Time per adapter: <span class="number">3</span> hours</span><br><span class="line">Total cost: ~$<span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line">Storage:</span><br><span class="line">  Base model: 14GB</span><br><span class="line">  <span class="number">10</span> adapters: <span class="number">10</span> Ã— 40MB = 400MB</span><br><span class="line">  Total: <span class="number">14.4</span>GB (vs 140GB <span class="keyword">for</span> <span class="number">10</span> full models)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Runtime</span></span><br><span class="line">Load base model once, swap adapters dynamically:</span><br><span class="line">electronics_model = base + electronics_adapter</span><br><span class="line">fashion_model = base + fashion_adapter</span><br></pre></td></tr></table></figure>

<p><strong>Why LoRA Won</strong>:</p>
<ul>
<li>âœ… 10Ã— storage savings</li>
<li>âœ… Can train new category adapter in hours</li>
<li>âœ… Single GPU deployment</li>
<li>âœ… Easy A&#x2F;B testing different adapters</li>
</ul>
<hr>
<h3 id="Use-Case-4-Multilingual-Customer-Support"><a href="#Use-Case-4-Multilingual-Customer-Support" class="headerlink" title="Use Case 4: Multilingual Customer Support"></a>Use Case 4: Multilingual Customer Support</h3><p><strong>Scenario</strong>: Global SaaS company needs chatbots for 20 languages.</p>
<p><strong>Challenge</strong>:</p>
<ul>
<li>20 language-specific models needed</li>
<li>Need to update all models when features change</li>
<li>Some languages low-resource (limited training data)</li>
</ul>
<p><strong>LoRA Approach</strong> (Recommended):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Base Model: Multilingual LLaMA-2-13B</span><br><span class="line">Training: 20 language adapters (r=16)</span><br><span class="line"></span><br><span class="line">Storage: 26GB base + (20 Ã— 80MB) = 27.6GB</span><br><span class="line">vs Full Fine-Tuning: 20 Ã— 26GB = 520GB</span><br><span class="line"></span><br><span class="line">Benefit: Update base model â†’ all languages benefit</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="When-to-Use-Which-Method"><a href="#When-to-Use-Which-Method" class="headerlink" title="When to Use Which Method"></a>When to Use Which Method</h2><h3 id="Choose-Full-Fine-Tuning-When"><a href="#Choose-Full-Fine-Tuning-When" class="headerlink" title="Choose Full Fine-Tuning When:"></a>Choose Full Fine-Tuning When:</h3><ol>
<li><p><strong>Maximum Performance is Critical</strong> âœ…</p>
<ul>
<li>Legal, medical, financial applications where errors are costly</li>
<li>Need that extra 2-5% accuracy</li>
</ul>
</li>
<li><p><strong>Large Dataset Available</strong> âœ…</p>
<ul>
<li>Have &gt;100,000 high-quality labeled examples</li>
<li>Data justifies training all parameters</li>
</ul>
</li>
<li><p><strong>Unlimited Budget &amp; Resources</strong> âœ…</p>
<ul>
<li>Access to GPU clusters (8+ A100s)</li>
<li>Can afford $10,000-100,000 training costs</li>
</ul>
</li>
<li><p><strong>Single Specialized Task</strong> âœ…</p>
<ul>
<li>Only need one model for one task</li>
<li>No plan for multi-task deployment</li>
</ul>
</li>
<li><p><strong>Task Very Different from Pre-training</strong> âœ…</p>
<ul>
<li>Specialized domains (medical, legal, scientific)</li>
<li>Low-resource languages</li>
</ul>
</li>
</ol>
<p><strong>Example Decision</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Use Full Fine-Tuning if:</span><br><span class="line">  (Accuracy_requirement &gt; 97%) AND</span><br><span class="line">  (Budget &gt; $10,000) AND</span><br><span class="line">  (Single_task OR Task_very_different)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Choose-LoRA-When"><a href="#Choose-LoRA-When" class="headerlink" title="Choose LoRA When:"></a>Choose LoRA When:</h3><ol>
<li><p><strong>Limited Resources</strong> âœ…</p>
<ul>
<li>Budget &lt; $5,000</li>
<li>Only have consumer GPUs (RTX 3090, 4090)</li>
</ul>
</li>
<li><p><strong>Need Fast Iteration</strong> âœ…</p>
<ul>
<li>Startup environment</li>
<li>Frequent model updates</li>
<li>Rapid experimentation</li>
</ul>
</li>
<li><p><strong>Multi-Task Deployment</strong> âœ…</p>
<ul>
<li>Need models for 5+ different tasks&#x2F;domains</li>
<li>Want to switch between tasks dynamically</li>
</ul>
</li>
<li><p><strong>Storage Constraints</strong> âœ…</p>
<ul>
<li>Limited disk space</li>
<li>Edge device deployment</li>
</ul>
</li>
<li><p><strong>Continuous Learning</strong> âœ…</p>
<ul>
<li>Need to add new capabilities over time</li>
<li>Canâ€™t afford catastrophic forgetting</li>
</ul>
</li>
</ol>
<p><strong>Example Decision</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Use LoRA if:</span><br><span class="line">  (Budget &lt; $5,000) OR</span><br><span class="line">  (GPU_memory &lt; 80GB) OR</span><br><span class="line">  (Num_tasks &gt; 3) OR</span><br><span class="line">  (Need_fast_iteration)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Hands-On-Practice-Guide"><a href="#Hands-On-Practice-Guide" class="headerlink" title="Hands-On Practice Guide"></a>Hands-On Practice Guide</h2><h3 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install required libraries</span></span><br><span class="line">pip install torch transformers peft datasets accelerate bitsandbytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check GPU</span></span><br><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure>

<h3 id="Practice-1-Full-Fine-Tuning-Small-Model"><a href="#Practice-1-Full-Fine-Tuning-Small-Model" class="headerlink" title="Practice 1: Full Fine-Tuning (Small Model)"></a>Practice 1: Full Fine-Tuning (Small Model)</h3><p><strong>Task</strong>: Fine-tune GPT-2 (small) for custom text generation</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> GPT2LMHeadModel, GPT2Tokenizer, Trainer, TrainingArguments</span><br><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Load pre-trained model</span></span><br><span class="line">model = GPT2LMHeadModel.from_pretrained(<span class="string">&quot;gpt2&quot;</span>)</span><br><span class="line">tokenizer = GPT2Tokenizer.from_pretrained(<span class="string">&quot;gpt2&quot;</span>)</span><br><span class="line">tokenizer.pad_token = tokenizer.eos_token</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Prepare dataset</span></span><br><span class="line">dataset = load_dataset(<span class="string">&quot;wikitext&quot;</span>, <span class="string">&quot;wikitext-2-raw-v1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tokenize_function</span>(<span class="params">examples</span>):</span><br><span class="line">    <span class="keyword">return</span> tokenizer(examples[<span class="string">&quot;text&quot;</span>], truncation=<span class="literal">True</span>, </span><br><span class="line">                     max_length=<span class="number">512</span>, padding=<span class="string">&quot;max_length&quot;</span>)</span><br><span class="line"></span><br><span class="line">tokenized_datasets = dataset.<span class="built_in">map</span>(tokenize_function, batched=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Training configuration (FULL FINE-TUNING)</span></span><br><span class="line">training_args = TrainingArguments(</span><br><span class="line">    output_dir=<span class="string">&quot;./gpt2-finetuned-full&quot;</span>,</span><br><span class="line">    num_train_epochs=<span class="number">3</span>,</span><br><span class="line">    per_device_train_batch_size=<span class="number">4</span>,</span><br><span class="line">    save_steps=<span class="number">500</span>,</span><br><span class="line">    save_total_limit=<span class="number">2</span>,</span><br><span class="line">    learning_rate=<span class="number">2e-5</span>,</span><br><span class="line">    <span class="comment"># All parameters trainable (default)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Train</span></span><br><span class="line">trainer = Trainer(</span><br><span class="line">    model=model,</span><br><span class="line">    args=training_args,</span><br><span class="line">    train_dataset=tokenized_datasets[<span class="string">&quot;train&quot;</span>],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">trainer.train()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. Save model</span></span><br><span class="line">model.save_pretrained(<span class="string">&quot;./gpt2-finetuned-full&quot;</span>)</span><br><span class="line">tokenizer.save_pretrained(<span class="string">&quot;./gpt2-finetuned-full&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Model size: <span class="subst">&#123;<span class="built_in">sum</span>(p.numel() <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters())&#125;</span> parameters&quot;</span>)</span><br><span class="line"><span class="comment"># Output: ~124M parameters all trained</span></span><br></pre></td></tr></table></figure>

<p><strong>Resource Requirements</strong>:</p>
<ul>
<li>GPU: GTX 1080 Ti or better (11GB+)</li>
<li>Time: ~2 hours</li>
<li>Storage: ~500MB</li>
</ul>
<hr>
<h3 id="Practice-2-LoRA-Fine-Tuning-Large-Model"><a href="#Practice-2-LoRA-Fine-Tuning-Large-Model" class="headerlink" title="Practice 2: LoRA Fine-Tuning (Large Model)"></a>Practice 2: LoRA Fine-Tuning (Large Model)</h3><p><strong>Task</strong>: Fine-tune LLaMA-2-7B for instruction following using LoRA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForCausalLM, AutoTokenizer, TrainingArguments</span><br><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> LoraConfig, get_peft_model, prepare_model_for_kbit_training</span><br><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line"><span class="keyword">from</span> trl <span class="keyword">import</span> SFTTrainer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Load base model (with 4-bit quantization for efficiency)</span></span><br><span class="line">model_name = <span class="string">&quot;meta-llama/Llama-2-7b-hf&quot;</span></span><br><span class="line">model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">    model_name,</span><br><span class="line">    load_in_4bit=<span class="literal">True</span>,  <span class="comment"># Quantization to reduce memory</span></span><br><span class="line">    device_map=<span class="string">&quot;auto&quot;</span></span><br><span class="line">)</span><br><span class="line">tokenizer = AutoTokenizer.from_pretrained(model_name)</span><br><span class="line">tokenizer.pad_token = tokenizer.eos_token</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Configure LoRA</span></span><br><span class="line">lora_config = LoraConfig(</span><br><span class="line">    r=<span class="number">16</span>,                       <span class="comment"># Rank (try 8, 16, 32, 64)</span></span><br><span class="line">    lora_alpha=<span class="number">32</span>,              <span class="comment"># Scaling factor</span></span><br><span class="line">    target_modules=[<span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>],  <span class="comment"># Apply to attention</span></span><br><span class="line">    lora_dropout=<span class="number">0.05</span>,</span><br><span class="line">    bias=<span class="string">&quot;none&quot;</span>,</span><br><span class="line">    task_type=<span class="string">&quot;CAUSAL_LM&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Prepare model for LoRA training</span></span><br><span class="line">model = prepare_model_for_kbit_training(model)</span><br><span class="line">model = get_peft_model(model, lora_config)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print trainable parameters</span></span><br><span class="line">model.print_trainable_parameters()</span><br><span class="line"><span class="comment"># Output: trainable params: 4,194,304 || all params: 6,738,415,616 || trainable%: 0.06%</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Load instruction dataset</span></span><br><span class="line">dataset = load_dataset(<span class="string">&quot;timdettmers/openassistant-guanaco&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. Training configuration</span></span><br><span class="line">training_args = TrainingArguments(</span><br><span class="line">    output_dir=<span class="string">&quot;./llama2-lora&quot;</span>,</span><br><span class="line">    num_train_epochs=<span class="number">3</span>,</span><br><span class="line">    per_device_train_batch_size=<span class="number">4</span>,</span><br><span class="line">    gradient_accumulation_steps=<span class="number">4</span>,</span><br><span class="line">    learning_rate=<span class="number">2e-4</span>,</span><br><span class="line">    logging_steps=<span class="number">10</span>,</span><br><span class="line">    save_strategy=<span class="string">&quot;epoch&quot;</span>,</span><br><span class="line">    fp16=<span class="literal">True</span>,  <span class="comment"># Mixed precision</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. Train with SFTTrainer (Supervised Fine-Tuning)</span></span><br><span class="line">trainer = SFTTrainer(</span><br><span class="line">    model=model,</span><br><span class="line">    train_dataset=dataset[<span class="string">&quot;train&quot;</span>],</span><br><span class="line">    args=training_args,</span><br><span class="line">    peft_config=lora_config,</span><br><span class="line">    dataset_text_field=<span class="string">&quot;text&quot;</span>,</span><br><span class="line">    max_seq_length=<span class="number">512</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">trainer.train()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. Save only LoRA adapter (tiny!)</span></span><br><span class="line">model.save_pretrained(<span class="string">&quot;./llama2-lora-adapter&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. Load and use later</span></span><br><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> PeftModel</span><br><span class="line"></span><br><span class="line">base_model = AutoModelForCausalLM.from_pretrained(model_name)</span><br><span class="line">lora_model = PeftModel.from_pretrained(base_model, <span class="string">&quot;./llama2-lora-adapter&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate</span></span><br><span class="line">inputs = tokenizer(<span class="string">&quot;Explain quantum computing:&quot;</span>, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">outputs = lora_model.generate(**inputs, max_length=<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(tokenizer.decode(outputs[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<p><strong>Resource Requirements</strong>:</p>
<ul>
<li>GPU: RTX 3090 (24GB) or better</li>
<li>Time: 4-8 hours</li>
<li>Storage: Base model (14GB) + Adapter (50MB)</li>
</ul>
<p><strong>Key Observations</strong>:</p>
<ul>
<li>Only 0.06% of parameters trained! (4M out of 6.7B)</li>
<li>Memory usage: ~18GB (vs ~90GB for full fine-tuning)</li>
<li>Can train multiple adapters and switch between them</li>
</ul>
<hr>
<h3 id="Practice-3-Comparing-LoRA-Ranks"><a href="#Practice-3-Comparing-LoRA-Ranks" class="headerlink" title="Practice 3: Comparing LoRA Ranks"></a>Practice 3: Comparing LoRA Ranks</h3><p><strong>Experiment</strong>: Train same model with different ranks and compare</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Train adapters with different ranks</span></span><br><span class="line">ranks = [<span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>]</span><br><span class="line">results = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> ranks:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;<span class="string">&#x27;=&#x27;</span>*<span class="number">50</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Training with rank r=<span class="subst">&#123;r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;=&#x27;</span>*<span class="number">50</span>&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    lora_config = LoraConfig(</span><br><span class="line">        r=r,</span><br><span class="line">        lora_alpha=r*<span class="number">2</span>,  <span class="comment"># Common practice: alpha = 2*r</span></span><br><span class="line">        target_modules=[<span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>],</span><br><span class="line">        lora_dropout=<span class="number">0.05</span>,</span><br><span class="line">        bias=<span class="string">&quot;none&quot;</span>,</span><br><span class="line">        task_type=<span class="string">&quot;CAUSAL_LM&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    model = prepare_model_for_kbit_training(base_model)</span><br><span class="line">    model = get_peft_model(model, lora_config)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Train and evaluate</span></span><br><span class="line">    trainer = SFTTrainer(...)</span><br><span class="line">    trainer.train()</span><br><span class="line">    metrics = trainer.evaluate()</span><br><span class="line">    </span><br><span class="line">    results[r] = &#123;</span><br><span class="line">        <span class="string">&#x27;trainable_params&#x27;</span>: <span class="built_in">sum</span>(p.numel() <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters() <span class="keyword">if</span> p.requires_grad),</span><br><span class="line">        <span class="string">&#x27;loss&#x27;</span>: metrics[<span class="string">&#x27;eval_loss&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;adapter_size_mb&#x27;</span>: get_adapter_size(model)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compare results</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.DataFrame(results).T</span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Expected output:</span></span><br><span class="line"><span class="comment">#     trainable_params  loss  adapter_size_mb</span></span><br><span class="line"><span class="comment"># 4      2,097,152    2.45       8</span></span><br><span class="line"><span class="comment"># 8      4,194,304    2.31      16</span></span><br><span class="line"><span class="comment"># 16     8,388,608    2.24      32</span></span><br><span class="line"><span class="comment"># 32    16,777,216    2.21      64</span></span><br><span class="line"><span class="comment"># 64    33,554,432    2.19     128</span></span><br></pre></td></tr></table></figure>

<p><strong>Insights</strong>:</p>
<ul>
<li>Rank 4-8: Fast, tiny, good for simple tasks</li>
<li>Rank 16-32: Sweet spot for most tasks</li>
<li>Rank 64+: Approaching full fine-tuning performance</li>
</ul>
<hr>
<h2 id="Advanced-Topics"><a href="#Advanced-Topics" class="headerlink" title="Advanced Topics"></a>Advanced Topics</h2><h3 id="1-QLoRA-Quantized-LoRA"><a href="#1-QLoRA-Quantized-LoRA" class="headerlink" title="1. QLoRA (Quantized LoRA)"></a>1. QLoRA (Quantized LoRA)</h3><p><strong>What</strong>: Combines LoRA with 4-bit quantization for even lower memory usage.</p>
<p><strong>Breakthrough</strong>: Train 65B parameter models on a single 48GB GPU!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> BitsAndBytesConfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># QLoRA configuration</span></span><br><span class="line">bnb_config = BitsAndBytesConfig(</span><br><span class="line">    load_in_4bit=<span class="literal">True</span>,</span><br><span class="line">    bnb_4bit_use_double_quant=<span class="literal">True</span>,</span><br><span class="line">    bnb_4bit_quant_type=<span class="string">&quot;nf4&quot;</span>,</span><br><span class="line">    bnb_4bit_compute_dtype=torch.bfloat16</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">    <span class="string">&quot;meta-llama/Llama-2-70b-hf&quot;</span>,</span><br><span class="line">    quantization_config=bnb_config,</span><br><span class="line">    device_map=<span class="string">&quot;auto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now train with LoRA as before</span></span><br><span class="line"><span class="comment"># Memory usage: ~40GB for 70B model! ğŸ‰</span></span><br></pre></td></tr></table></figure>

<p><strong>Use Case</strong>: Fine-tune massive models (65B, 70B+) on consumer hardware.</p>
<hr>
<h3 id="2-AdaLoRA-Adaptive-LoRA"><a href="#2-AdaLoRA-Adaptive-LoRA" class="headerlink" title="2. AdaLoRA (Adaptive LoRA)"></a>2. AdaLoRA (Adaptive LoRA)</h3><p><strong>What</strong>: Dynamically adjusts rank during training based on importance.</p>
<p><strong>Benefit</strong>: Automatically finds optimal rank per layer.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> AdaLoraConfig, get_peft_model</span><br><span class="line"></span><br><span class="line">adalora_config = AdaLoraConfig(</span><br><span class="line">    init_r=<span class="number">12</span>,              <span class="comment"># Initial rank</span></span><br><span class="line">    target_r=<span class="number">8</span>,             <span class="comment"># Target rank</span></span><br><span class="line">    tinit=<span class="number">200</span>,              <span class="comment"># Warmup steps</span></span><br><span class="line">    tfinal=<span class="number">1000</span>,            <span class="comment"># Total steps</span></span><br><span class="line">    delta_t=<span class="number">10</span>,             <span class="comment"># Rank adjustment frequency</span></span><br><span class="line">    beta1=<span class="number">0.85</span>,</span><br><span class="line">    beta2=<span class="number">0.85</span>,</span><br><span class="line">    orth_reg_weight=<span class="number">0.5</span>,</span><br><span class="line">    lora_alpha=<span class="number">32</span>,</span><br><span class="line">    lora_dropout=<span class="number">0.1</span>,</span><br><span class="line">    target_modules=[<span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>],</span><br><span class="line">    task_type=<span class="string">&quot;CAUSAL_LM&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model = get_peft_model(model, adalora_config)</span><br></pre></td></tr></table></figure>

<p><strong>Result</strong>: Better performance than fixed-rank LoRA with similar parameter count.</p>
<hr>
<h3 id="3-The-â€œIntruder-Dimensionsâ€-Problem"><a href="#3-The-â€œIntruder-Dimensionsâ€-Problem" class="headerlink" title="3. The â€œIntruder Dimensionsâ€ Problem"></a>3. The â€œIntruder Dimensionsâ€ Problem</h3><p><strong>Recent Discovery (MIT Research, 2024)</strong>:</p>
<p>LoRA introduces high-ranking singular vectors not present in full fine-tuning. These â€œintruder dimensionsâ€:</p>
<ul>
<li>Reduce out-of-distribution generalization by 5-8%</li>
<li>Cause more forgetting in continual learning</li>
<li>Appear more with lower ranks (r â‰¤ 16)</li>
</ul>
<p><strong>Visualization</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Full Fine-Tuning Weight Matrix SVD:</span><br><span class="line">Singular Values: [100, 95, 90, 85, 80, ...]  â† Smooth decay</span><br><span class="line">Singular Vectors: All similar to pre-trained</span><br><span class="line"></span><br><span class="line">LoRA Weight Matrix SVD:</span><br><span class="line">Singular Values: [100, 95, 90, 85, 80, ..., 15, 14, 13]  â† Similar</span><br><span class="line">                                               â†“</span><br><span class="line">                                    [50, 45, 40]  â† INTRUDER!</span><br><span class="line">Singular Vectors: Some very different from pre-trained</span><br></pre></td></tr></table></figure>

<p><strong>Solutions</strong>:</p>
<ol>
<li>Use higher rank (r&#x3D;64+) with rank stabilization</li>
<li>Use â€œrank-stabilized LoRAâ€ techniques</li>
<li>For critical applications, prefer full fine-tuning</li>
</ol>
<hr>
<h3 id="4-Multi-Adapter-Architecture"><a href="#4-Multi-Adapter-Architecture" class="headerlink" title="4. Multi-Adapter Architecture"></a>4. Multi-Adapter Architecture</h3><p><strong>Pattern</strong>: One base model + dynamic adapter loading</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Training phase: Train multiple adapters</span></span><br><span class="line">adapters = &#123;</span><br><span class="line">    <span class="string">&#x27;medical&#x27;</span>: train_lora(base_model, medical_data, r=<span class="number">16</span>),</span><br><span class="line">    <span class="string">&#x27;legal&#x27;</span>: train_lora(base_model, legal_data, r=<span class="number">16</span>),</span><br><span class="line">    <span class="string">&#x27;finance&#x27;</span>: train_lora(base_model, finance_data, r=<span class="number">16</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save adapters</span></span><br><span class="line"><span class="keyword">for</span> name, adapter <span class="keyword">in</span> adapters.items():</span><br><span class="line">    adapter.save_pretrained(<span class="string">f&quot;./adapters/<span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Inference phase: Dynamically load adapters</span></span><br><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> PeftModel</span><br><span class="line"></span><br><span class="line">base_model = AutoModelForCausalLM.from_pretrained(<span class="string">&quot;llama-2-7b&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># For medical query</span></span><br><span class="line">medical_model = PeftModel.from_pretrained(base_model, <span class="string">&quot;./adapters/medical&quot;</span>)</span><br><span class="line">response = medical_model.generate(...)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Switch to legal</span></span><br><span class="line">legal_model = PeftModel.from_pretrained(base_model, <span class="string">&quot;./adapters/legal&quot;</span>)</span><br><span class="line">response = legal_model.generate(...)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Or merge multiple adapters!</span></span><br><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> PeftModel</span><br><span class="line">multi_model = PeftModel.from_pretrained(base_model, <span class="string">&quot;./adapters/medical&quot;</span>)</span><br><span class="line">multi_model.load_adapter(<span class="string">&quot;./adapters/legal&quot;</span>, adapter_name=<span class="string">&quot;legal&quot;</span>)</span><br><span class="line">multi_model.set_adapter([<span class="string">&quot;medical&quot;</span>, <span class="string">&quot;legal&quot;</span>])  <span class="comment"># Use both!</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Decision-Framework"><a href="#Decision-Framework" class="headerlink" title="Decision Framework"></a>Decision Framework</h2><h3 id="The-Complete-Decision-Tree"><a href="#The-Complete-Decision-Tree" class="headerlink" title="The Complete Decision Tree"></a>The Complete Decision Tree</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">START: Do you need to fine-tune a large language model?</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â†’ Q1: What&#x27;s your budget?</span><br><span class="line">â”‚   â”œâ”€â†’ &lt; $1,000: â†’ LoRA (or QLoRA)</span><br><span class="line">â”‚   â”œâ”€â†’ $1,000 - $10,000: â†’ LoRA (consider full if single critical task)</span><br><span class="line">â”‚   â””â”€â†’ &gt; $10,000: â†’ Consider full fine-tuning</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â†’ Q2: What GPU do you have?</span><br><span class="line">â”‚   â”œâ”€â†’ Consumer (RTX 3090/4090): â†’ LoRA or QLoRA</span><br><span class="line">â”‚   â”œâ”€â†’ Single A100 (40-80GB): â†’ LoRA or Full (for &lt;7B models)</span><br><span class="line">â”‚   â””â”€â†’ GPU Cluster (8+ A100s): â†’ Full fine-tuning possible</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â†’ Q3: How many tasks?</span><br><span class="line">â”‚   â”œâ”€â†’ 1 task: â†’ Either (depends on other factors)</span><br><span class="line">â”‚   â”œâ”€â†’ 2-5 tasks: â†’ LoRA (multi-adapter)</span><br><span class="line">â”‚   â””â”€â†’ 5+ tasks: â†’ Definitely LoRA</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â†’ Q4: Accuracy requirements?</span><br><span class="line">â”‚   â”œâ”€â†’ &gt;98% required: â†’ Full fine-tuning</span><br><span class="line">â”‚   â”œâ”€â†’ 95-98%: â†’ LoRA (high rank, r=64+)</span><br><span class="line">â”‚   â””â”€â†’ &lt;95%: â†’ LoRA (standard rank, r=8-16)</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â†’ Q5: Deployment constraints?</span><br><span class="line">â”‚   â”œâ”€â†’ Edge devices: â†’ LoRA (smaller)</span><br><span class="line">â”‚   â”œâ”€â†’ Cloud: â†’ Either</span><br><span class="line">â”‚   â””â”€â†’ Need rapid updates: â†’ LoRA</span><br><span class="line">â”‚</span><br><span class="line">â””â”€â†’ Q6: Continual learning needed?</span><br><span class="line">    â”œâ”€â†’ Yes, multiple sequential tasks: â†’ High-rank LoRA or Full</span><br><span class="line">    â”œâ”€â†’ No: â†’ Standard LoRA</span><br><span class="line">    â””â”€â†’ Critical to avoid forgetting: â†’ Full fine-tuning</span><br></pre></td></tr></table></figure>

<h3 id="Quick-Selection-Matrix"><a href="#Quick-Selection-Matrix" class="headerlink" title="Quick Selection Matrix"></a>Quick Selection Matrix</h3><table>
<thead>
<tr>
<th>Your Situation</th>
<th>Recommended Method</th>
<th>Rank&#x2F;Config</th>
</tr>
</thead>
<tbody><tr>
<td>Startup, limited GPU, 3+ tasks</td>
<td>LoRA</td>
<td>r&#x3D;8-16</td>
</tr>
<tr>
<td>Enterprise, single critical task</td>
<td>Full Fine-Tuning</td>
<td>All parameters</td>
</tr>
<tr>
<td>Research, multiple experiments</td>
<td>LoRA</td>
<td>r&#x3D;16-32</td>
</tr>
<tr>
<td>&gt;100B model, limited hardware</td>
<td>QLoRA</td>
<td>r&#x3D;8-16, 4-bit</td>
</tr>
<tr>
<td>Medical&#x2F;Legal high-stakes</td>
<td>Full Fine-Tuning</td>
<td>All parameters</td>
</tr>
<tr>
<td>Multi-lingual deployment</td>
<td>LoRA multi-adapter</td>
<td>r&#x3D;16 per language</td>
</tr>
<tr>
<td>Rapid A&#x2F;B testing</td>
<td>LoRA</td>
<td>r&#x3D;8 (fast training)</td>
</tr>
<tr>
<td>Edge device deployment</td>
<td>QLoRA</td>
<td>r&#x3D;4-8, quantized</td>
</tr>
</tbody></table>
<hr>
<h2 id="Best-Practices-Tips"><a href="#Best-Practices-Tips" class="headerlink" title="Best Practices &amp; Tips"></a>Best Practices &amp; Tips</h2><h3 id="For-LoRA-Fine-Tuning"><a href="#For-LoRA-Fine-Tuning" class="headerlink" title="For LoRA Fine-Tuning"></a>For LoRA Fine-Tuning</h3><ol>
<li><p><strong>Start Small, Scale Up</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Experiment progression</span></span><br><span class="line"><span class="number">1.</span> Try r=<span class="number">8</span> first (fast, good baseline)</span><br><span class="line"><span class="number">2.</span> If underfitting, increase to r=<span class="number">16</span></span><br><span class="line"><span class="number">3.</span> For <span class="built_in">complex</span> tasks, <span class="keyword">try</span> r=<span class="number">32</span> <span class="keyword">or</span> r=<span class="number">64</span></span><br><span class="line"><span class="number">4.</span> Monitor validation loss to find sweet spot</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Target the Right Modules</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># For most language models</span></span><br><span class="line">target_modules = [<span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>]  <span class="comment"># Minimum (queries &amp; values)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For better performance</span></span><br><span class="line">target_modules = [<span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;k_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>, <span class="string">&quot;o_proj&quot;</span>]  <span class="comment"># All attention</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For maximum adaptation (more params)</span></span><br><span class="line">target_modules = [<span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;k_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>, <span class="string">&quot;o_proj&quot;</span>, </span><br><span class="line">                  <span class="string">&quot;gate_proj&quot;</span>, <span class="string">&quot;up_proj&quot;</span>, <span class="string">&quot;down_proj&quot;</span>]  <span class="comment"># Attention + FFN</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Learning Rate Selection</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LoRA typically needs higher LR than full fine-tuning</span></span><br><span class="line">Full Fine-Tuning: lr = <span class="number">1e-5</span> to <span class="number">5e-5</span></span><br><span class="line">LoRA: lr = <span class="number">1e-4</span> to <span class="number">3e-4</span>  (10x higher!)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rule of thumb</span></span><br><span class="line">lora_lr = full_finetuning_lr * <span class="number">10</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Rank Selection Guide</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Task Complexity        â†’ Recommended Rank</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">Simple (sentiment)     â†’ r=4-8</span><br><span class="line">Medium (summarization) â†’ r=8-16</span><br><span class="line">Complex (reasoning)    â†’ r=16-32</span><br><span class="line">Very complex (coding)  â†’ r=32-64</span><br><span class="line">Approaching full FT    â†’ r=128-256</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Prevent Intruder Dimensions</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use rank stabilization</span></span><br><span class="line">lora_config = LoraConfig(</span><br><span class="line">    r=<span class="number">32</span>,</span><br><span class="line">    lora_alpha=<span class="number">64</span>,</span><br><span class="line">    use_rslora=<span class="literal">True</span>,  <span class="comment"># Rank-stabilized LoRA</span></span><br><span class="line">    <span class="comment"># ... other params</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="For-Full-Fine-Tuning"><a href="#For-Full-Fine-Tuning" class="headerlink" title="For Full Fine-Tuning"></a>For Full Fine-Tuning</h3><ol>
<li><p><strong>Gradient Checkpointing</strong> (Save Memory)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">model.gradient_checkpointing_enable()</span><br><span class="line"><span class="comment"># Trades computation for memory</span></span><br><span class="line"><span class="comment"># Enables training larger models on same GPU</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Mixed Precision Training</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">training_args = TrainingArguments(</span><br><span class="line">    fp16=<span class="literal">True</span>,  <span class="comment"># For older GPUs</span></span><br><span class="line">    bf16=<span class="literal">True</span>,  <span class="comment"># For A100s (better for large models)</span></span><br><span class="line">    <span class="comment"># Reduces memory usage by 2x</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Distributed Training</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use DeepSpeed for multi-GPU</span></span><br><span class="line">training_args = TrainingArguments(</span><br><span class="line">    deepspeed=<span class="string">&quot;ds_config.json&quot;</span>,</span><br><span class="line">    per_device_train_batch_size=<span class="number">1</span>,</span><br><span class="line">    gradient_accumulation_steps=<span class="number">16</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ds_config.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;train_batch_size&quot;</span>: <span class="string">&quot;auto&quot;</span>,</span><br><span class="line">    <span class="string">&quot;zero_optimization&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;stage&quot;</span>: <span class="number">3</span>,  <span class="comment"># ZeRO-3: Shard everything</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Prevent Catastrophic Forgetting</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use lower learning rate</span></span><br><span class="line">learning_rate = <span class="number">1e-5</span>  <span class="comment"># vs 2e-4 for pre-training</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Freeze some layers (partial fine-tuning)</span></span><br><span class="line"><span class="keyword">for</span> i, layer <span class="keyword">in</span> <span class="built_in">enumerate</span>(model.layers):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">20</span>:  <span class="comment"># Freeze first 20 layers</span></span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> layer.parameters():</span><br><span class="line">            param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use elastic weight consolidation (EWC)</span></span><br><span class="line"><span class="comment"># Add regularization term penalizing large weight changes</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="Common-Mistakes-How-to-Avoid-Them"><a href="#Common-Mistakes-How-to-Avoid-Them" class="headerlink" title="Common Mistakes &amp; How to Avoid Them"></a>Common Mistakes &amp; How to Avoid Them</h2><h3 id="Mistake-1-Using-LoRA-rank-thatâ€™s-too-low"><a href="#Mistake-1-Using-LoRA-rank-thatâ€™s-too-low" class="headerlink" title="Mistake 1: Using LoRA rank thatâ€™s too low"></a>Mistake 1: Using LoRA rank thatâ€™s too low</h3><p>âŒ <strong>Problem</strong>: r&#x3D;4 for complex instruction following</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lora_config = LoraConfig(r=<span class="number">4</span>, ...)  <span class="comment"># Too small!</span></span><br><span class="line"><span class="comment"># Result: Model can&#x27;t learn complex patterns, poor performance</span></span><br></pre></td></tr></table></figure>

<p>âœ… <strong>Solution</strong>: Start with r&#x3D;16, increase if needed</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lora_config = LoraConfig(r=<span class="number">16</span>, lora_alpha=<span class="number">32</span>, ...)</span><br><span class="line"><span class="comment"># Monitor validation loss, increase to r=32 if plateauing</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Mistake-2-Wrong-learning-rate"><a href="#Mistake-2-Wrong-learning-rate" class="headerlink" title="Mistake 2: Wrong learning rate"></a>Mistake 2: Wrong learning rate</h3><p>âŒ <strong>Problem</strong>: Using same LR for LoRA as full fine-tuning</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Full fine-tuning LR used for LoRA</span></span><br><span class="line">training_args = TrainingArguments(learning_rate=<span class="number">2e-5</span>, ...)</span><br><span class="line"><span class="comment"># Result: Slow convergence, underfitting</span></span><br></pre></td></tr></table></figure>

<p>âœ… <strong>Solution</strong>: Use 10x higher LR for LoRA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">training_args = TrainingArguments(learning_rate=<span class="number">2e-4</span>, ...)</span><br><span class="line"><span class="comment"># LoRA adapters need stronger signals to learn</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Mistake-3-Not-quantizing-when-memory-is-tight"><a href="#Mistake-3-Not-quantizing-when-memory-is-tight" class="headerlink" title="Mistake 3: Not quantizing when memory is tight"></a>Mistake 3: Not quantizing when memory is tight</h3><p>âŒ <strong>Problem</strong>: Trying to load 7B model in FP16 on 16GB GPU</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model = AutoModelForCausalLM.from_pretrained(<span class="string">&quot;llama-2-7b&quot;</span>)</span><br><span class="line"><span class="comment"># Result: CUDA Out of Memory error</span></span><br></pre></td></tr></table></figure>

<p>âœ… <strong>Solution</strong>: Use 4-bit&#x2F;8-bit quantization</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">    <span class="string">&quot;llama-2-7b&quot;</span>,</span><br><span class="line">    load_in_4bit=<span class="literal">True</span>,</span><br><span class="line">    device_map=<span class="string">&quot;auto&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># Result: Fits in 8GB GPU!</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Mistake-4-Training-on-too-few-examples"><a href="#Mistake-4-Training-on-too-few-examples" class="headerlink" title="Mistake 4: Training on too few examples"></a>Mistake 4: Training on too few examples</h3><p>âŒ <strong>Problem</strong>: Fine-tuning on 100 examples</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dataset = load_dataset(...)[:<span class="number">100</span>]  <span class="comment"># Only 100 examples</span></span><br><span class="line"><span class="comment"># Result: Overfitting, poor generalization</span></span><br></pre></td></tr></table></figure>

<p>âœ… <strong>Solution</strong>: Minimum dataset sizes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Full Fine-Tuning: 10,000+ examples (ideally 100k+)</span><br><span class="line">LoRA: 1,000+ examples (can work with 500 for simple tasks)</span><br><span class="line">QLoRA: 500+ examples (most efficient)</span><br><span class="line"></span><br><span class="line">If you have &lt;500 examples:</span><br><span class="line">  â†’ Use prompt engineering or few-shot learning instead</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Mistake-5-Not-saving-checkpoints"><a href="#Mistake-5-Not-saving-checkpoints" class="headerlink" title="Mistake 5: Not saving checkpoints"></a>Mistake 5: Not saving checkpoints</h3><p>âŒ <strong>Problem</strong>: Training crashes after 20 hours, no checkpoints</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">training_args = TrainingArguments(</span><br><span class="line">    save_strategy=<span class="string">&quot;no&quot;</span>,  <span class="comment"># Dangerous!</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>âœ… <strong>Solution</strong>: Regular checkpointing</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">training_args = TrainingArguments(</span><br><span class="line">    save_strategy=<span class="string">&quot;steps&quot;</span>,</span><br><span class="line">    save_steps=<span class="number">500</span>,</span><br><span class="line">    save_total_limit=<span class="number">3</span>,  <span class="comment"># Keep last 3 checkpoints</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Real-Cost-Comparison"><a href="#Real-Cost-Comparison" class="headerlink" title="Real Cost Comparison"></a>Real Cost Comparison</h2><h3 id="Example-Fine-tuning-LLaMA-2-7B-for-3-epochs-on-10-000-examples"><a href="#Example-Fine-tuning-LLaMA-2-7B-for-3-epochs-on-10-000-examples" class="headerlink" title="Example: Fine-tuning LLaMA-2-7B for 3 epochs on 10,000 examples"></a>Example: Fine-tuning LLaMA-2-7B for 3 epochs on 10,000 examples</h3><p><strong>Full Fine-Tuning</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Hardware: 4Ã— A100 (80GB) via AWS</span><br><span class="line">Cost: $32.77/hour per GPU</span><br><span class="line">Duration: 48 hours</span><br><span class="line">Total: $32.77 Ã— 4 Ã— 48 = $6,293</span><br><span class="line"></span><br><span class="line">Storage: 14GB per model</span><br><span class="line">If 5 tasks: 70GB total</span><br><span class="line"></span><br><span class="line">Total Investment: ~$6,300 + ongoing storage</span><br></pre></td></tr></table></figure>

<p><strong>LoRA (r&#x3D;16)</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hardware: 1Ã— RTX 4090 (24GB) - owned or $2/hour cloud</span><br><span class="line">Cost: $2/hour</span><br><span class="line">Duration: 12 hours</span><br><span class="line">Total: $2 Ã— 12 = $24</span><br><span class="line"></span><br><span class="line">Storage: 14GB base + (5 Ã— 50MB adapters) = 14.25GB</span><br><span class="line"></span><br><span class="line">Total Investment: ~$24 + one-time GPU purchase (~$1,600)</span><br></pre></td></tr></table></figure>

<p><strong>Savings: 99.6%</strong> ğŸ‰</p>
<hr>
<h2 id="Latest-Research-Trends-2024-2025"><a href="#Latest-Research-Trends-2024-2025" class="headerlink" title="Latest Research &amp; Trends (2024-2025)"></a>Latest Research &amp; Trends (2024-2025)</h2><h3 id="1-LoRA-and-LoRA-FA"><a href="#1-LoRA-and-LoRA-FA" class="headerlink" title="1. LoRA+ and LoRA-FA"></a>1. LoRA+ and LoRA-FA</h3><ul>
<li><strong>LoRA+</strong>: Different learning rates for A and B matrices</li>
<li><strong>LoRA-FA</strong>: Frozen-A variant (only train B matrix)</li>
<li>Result: Faster convergence, better performance</li>
</ul>
<h3 id="2-DoRA-Weight-Decomposed-LoRA"><a href="#2-DoRA-Weight-Decomposed-LoRA" class="headerlink" title="2. DoRA (Weight-Decomposed LoRA)"></a>2. DoRA (Weight-Decomposed LoRA)</h3><ul>
<li>Decomposes weights into magnitude and direction</li>
<li>Bridges gap between LoRA and full fine-tuning</li>
<li>20% better performance on reasoning tasks</li>
</ul>
<h3 id="3-MultiLoRA-LoRA-Composition"><a href="#3-MultiLoRA-LoRA-Composition" class="headerlink" title="3. MultiLoRA &amp; LoRA Composition"></a>3. MultiLoRA &amp; LoRA Composition</h3><ul>
<li>Train multiple LoRA adapters</li>
<li>Compose them at inference time</li>
<li>Example: (medical_adapter Ã— 0.7) + (general_adapter Ã— 0.3)</li>
</ul>
<h3 id="4-LoRA-for-Vision-Multimodal-Models"><a href="#4-LoRA-for-Vision-Multimodal-Models" class="headerlink" title="4. LoRA for Vision &amp; Multimodal Models"></a>4. LoRA for Vision &amp; Multimodal Models</h3><ul>
<li>VoRA: LoRA for vision transformers</li>
<li>Successful for CLIP, Stable Diffusion fine-tuning</li>
<li>90% memory reduction for image model fine-tuning</li>
</ul>
<hr>
<h2 id="Summary-Recommendations"><a href="#Summary-Recommendations" class="headerlink" title="Summary &amp; Recommendations"></a>Summary &amp; Recommendations</h2><h3 id="The-Bottom-Line"><a href="#The-Bottom-Line" class="headerlink" title="The Bottom Line"></a>The Bottom Line</h3><p><strong>LoRA is the default choice for most practitioners in 2024-2025.</strong></p>
<p>Reasons:</p>
<ul>
<li>âœ… 99% cost reduction</li>
<li>âœ… Accessible on consumer hardware</li>
<li>âœ… Fast iteration (hours vs days)</li>
<li>âœ… Easy multi-task deployment</li>
<li>âœ… Good enough performance for most applications (95-99% of full)</li>
</ul>
<p><strong>Full Fine-Tuning is for special cases:</strong></p>
<ul>
<li>High-stakes applications (medical, legal, financial)</li>
<li>Unlimited budget and resources</li>
<li>Need absolute best performance</li>
<li>Research settings exploring model limits</li>
</ul>
<h3 id="Your-Action-Plan"><a href="#Your-Action-Plan" class="headerlink" title="Your Action Plan"></a>Your Action Plan</h3><p><strong>Week 1: Start with LoRA</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Choose base model (LLaMA-<span class="number">2</span>-7B, Mistral-7B, Qwen)</span><br><span class="line"><span class="number">2.</span> Prepare <span class="number">1</span>,<span class="number">000</span>+ examples</span><br><span class="line"><span class="number">3.</span> Train LoRA (r=<span class="number">16</span>) on <span class="number">1</span>Ã— GPU</span><br><span class="line"><span class="number">4.</span> Evaluate on validation <span class="built_in">set</span></span><br><span class="line"><span class="number">5.</span> Iterate on rank <span class="keyword">and</span> hyperparameters</span><br></pre></td></tr></table></figure>

<p><strong>Week 2: Optimize</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Experiment <span class="keyword">with</span> ranks: <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span></span><br><span class="line"><span class="number">2.</span> Try different target modules</span><br><span class="line"><span class="number">3.</span> Test QLoRA <span class="keyword">if</span> memory constrained</span><br><span class="line"><span class="number">4.</span> A/B test different adapters</span><br></pre></td></tr></table></figure>

<p><strong>Month 2+: Scale if Needed</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> performance &lt; requirements:</span><br><span class="line">    <span class="keyword">if</span> budget_available:</span><br><span class="line">        <span class="keyword">try</span> full fine-tuning</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">try</span> higher rank LoRA (r=<span class="number">64</span>-<span class="number">128</span>)</span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">try</span> DoRA/LoRA+ variants</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Additional-Resources"><a href="#Additional-Resources" class="headerlink" title="Additional Resources"></a>Additional Resources</h2><h3 id="Code-Repositories"><a href="#Code-Repositories" class="headerlink" title="Code Repositories"></a>Code Repositories</h3><ul>
<li><strong>Hugging Face PEFT</strong>: <a target="_blank" rel="noopener" href="https://github.com/huggingface/peft">https://github.com/huggingface/peft</a></li>
<li><strong>LoRA Paper</strong>: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2106.09685">https://arxiv.org/abs/2106.09685</a></li>
<li><strong>QLoRA Paper</strong>: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2305.14314">https://arxiv.org/abs/2305.14314</a></li>
</ul>
<h3 id="Tutorials"><a href="#Tutorials" class="headerlink" title="Tutorials"></a>Tutorials</h3><ul>
<li>Hugging Face LoRA Tutorial: <a target="_blank" rel="noopener" href="https://huggingface.co/docs/peft">https://huggingface.co/docs/peft</a></li>
<li>Fast.ai Practical Deep Learning: <a target="_blank" rel="noopener" href="https://course.fast.ai/">https://course.fast.ai</a></li>
</ul>
<h3 id="Communities"><a href="#Communities" class="headerlink" title="Communities"></a>Communities</h3><ul>
<li>Hugging Face Forums: <a target="_blank" rel="noopener" href="https://discuss.huggingface.co/">https://discuss.huggingface.co</a></li>
<li>r&#x2F;LocalLLaMA (Reddit): For LoRA discussions</li>
<li>EleutherAI Discord: For research discussions</li>
</ul>
<hr>
<p><strong>Remember</strong>:</p>
<ul>
<li>Start with LoRA (r&#x3D;16)</li>
<li>Scale to full fine-tuning only if truly needed</li>
<li>Focus on data quality over method choice</li>
<li>Iterate quickly and measure results</li>
</ul>
<p><strong>The best method is the one that:</strong></p>
<ol>
<li>Fits your budget</li>
<li>Meets your accuracy requirements</li>
<li>Enables fast iteration</li>
<li>Scales with your needs</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/11/21/WebFlux-Deep-Dive-Operators-Types-and-Real-World-Use-Cases/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/11/21/WebFlux-Deep-Dive-Operators-Types-and-Real-World-Use-Cases/" class="post-title-link" itemprop="url">WebFlux Deep Dive: Operators, Types, and Real-World Use Cases</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-11-21 16:30:04 / Modified: 16:31:17" itemprop="dateCreated datePublished" datetime="2025-11-21T16:30:04-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/WebFlux/" itemprop="url" rel="index"><span itemprop="name">WebFlux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><a href="#core-reactive-types">Core Reactive Types</a></li>
<li><a href="#creation-operators">Creation Operators</a></li>
<li><a href="#transformation-operators">Transformation Operators</a></li>
<li><a href="#combination-operators">Combination Operators</a></li>
<li><a href="#error-handling-operators">Error Handling Operators</a></li>
<li><a href="#scheduling--threading">Scheduling &amp; Threading</a></li>
<li><a href="#advanced-patterns">Advanced Patterns</a></li>
</ol>
<h2 id="Core-Reactive-Types"><a href="#Core-Reactive-Types" class="headerlink" title="Core Reactive Types"></a>Core Reactive Types</h2><h3 id="Mono-Single-Result-Container"><a href="#Mono-Single-Result-Container" class="headerlink" title="Mono - Single Result Container"></a>Mono - Single Result Container</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mono represents a stream that emits 0 or 1 element</span></span><br><span class="line"><span class="comment"> * Perfect for: HTTP responses, database saves, single calculations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonoDeepDive</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Creation examples</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monoCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Empty Mono</span></span><br><span class="line">        Mono&lt;String&gt; empty = Mono.empty();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From value</span></span><br><span class="line">        Mono&lt;String&gt; staticValue = Mono.just(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From nullable</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">possiblyNull</span> <span class="operator">=</span> getFromCache();</span><br><span class="line">        Mono&lt;String&gt; nullable = Mono.justOrEmpty(possiblyNull);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From supplier (lazy)</span></span><br><span class="line">        Mono&lt;String&gt; lazy = Mono.fromSupplier(() -&gt; expensiveOperation());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From callable</span></span><br><span class="line">        Mono&lt;String&gt; fromCallable = Mono.fromCallable(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> database.getUser(userId); <span class="comment">// Potentially blocking</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From future</span></span><br><span class="line">        CompletableFuture&lt;String&gt; future = asyncHttpCall();</span><br><span class="line">        Mono&lt;String&gt; fromFuture = Mono.fromFuture(future);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Real-world use case: User profile lookup</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;UserProfile&gt; <span class="title function_">getUserProfile</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromCallable(() -&gt; userRepository.findById(userId))</span><br><span class="line">                  .filter(Optional::isPresent)</span><br><span class="line">                  .map(Optional::get)</span><br><span class="line">                  .switchIfEmpty(Mono.error(<span class="keyword">new</span> <span class="title class_">UserNotFoundException</span>(userId)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Flux-Multiple-Results-Stream"><a href="#Flux-Multiple-Results-Stream" class="headerlink" title="Flux - Multiple Results Stream"></a>Flux - Multiple Results Stream</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flux represents a stream that emits 0 to N elements</span></span><br><span class="line"><span class="comment"> * Perfect for: Collections, real-time streams, paginated results</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FluxDeepDive</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Creation examples</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fluxCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// From values</span></span><br><span class="line">        Flux&lt;String&gt; fromValues = Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From array</span></span><br><span class="line">        Flux&lt;String&gt; fromArray = Flux.fromArray(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>&#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// From iterable</span></span><br><span class="line">        Flux&lt;String&gt; fromList = Flux.fromIterable(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Range</span></span><br><span class="line">        Flux&lt;Integer&gt; numbers = Flux.range(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Interval (real-time stream)</span></span><br><span class="line">        Flux&lt;Long&gt; ticker = Flux.interval(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate (stateful stream)</span></span><br><span class="line">        Flux&lt;Integer&gt; fibonacci = Flux.generate(</span><br><span class="line">            () -&gt; <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, <span class="comment">// initial state</span></span><br><span class="line">            (state, sink) -&gt; &#123;</span><br><span class="line">                sink.next(state[<span class="number">0</span>]);</span><br><span class="line">                <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> state[<span class="number">0</span>] + state[<span class="number">1</span>];</span><br><span class="line">                state[<span class="number">0</span>] = state[<span class="number">1</span>];</span><br><span class="line">                state[<span class="number">1</span>] = next;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Real-world use case: Real-time stock prices</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;StockPrice&gt; <span class="title function_">getStockPrices</span><span class="params">(String symbol)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.interval(Duration.ofMillis(<span class="number">100</span>))</span><br><span class="line">                  .flatMap(tick -&gt; </span><br><span class="line">                      Mono.fromCallable(() -&gt; stockService.getCurrentPrice(symbol))</span><br><span class="line">                          .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">                  )</span><br><span class="line">                  .take(<span class="number">100</span>); <span class="comment">// Only take 100 price updates</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transformation-Operators"><a href="#Transformation-Operators" class="headerlink" title="Transformation Operators"></a>Transformation Operators</h2><h3 id="map-vs-flatMap-The-Critical-Difference"><a href="#map-vs-flatMap-The-Critical-Difference" class="headerlink" title="map vs flatMap - The Critical Difference"></a>map vs flatMap - The Critical Difference</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformationOperators</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * map: Synchronous 1:1 transformation</span></span><br><span class="line"><span class="comment">     * Use when: Transformation is fast, non-blocking, CPU-bound</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mapOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; names = Flux.just(<span class="string">&quot;john&quot;</span>, <span class="string">&quot;jane&quot;</span>, <span class="string">&quot;bob&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Synchronous transformation - stays in same thread</span></span><br><span class="line">        Flux&lt;String&gt; capitalized = names.map(name -&gt; name.toUpperCase());</span><br><span class="line">        <span class="comment">// Output: JOHN, JANE, BOB</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Data enrichment (fast)</span></span><br><span class="line">        Flux&lt;User&gt; users = getUserIds()</span><br><span class="line">            .map(id -&gt; <span class="keyword">new</span> <span class="title class_">User</span>(id, <span class="string">&quot;user-&quot;</span> + id));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flatMap: Asynchronous 1:N transformation</span></span><br><span class="line"><span class="comment">     * Use when: Need to call async APIs, database, external services</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMapOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; userIds = Flux.just(<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Asynchronous transformation - can change threads</span></span><br><span class="line">        Flux&lt;User&gt; users = userIds.flatMap(id -&gt; </span><br><span class="line">            userRepository.findByIdAsync(id) <span class="comment">// Returns Mono&lt;User&gt;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Fetch user details from multiple services</span></span><br><span class="line">        Flux&lt;Order&gt; orders = getOrderIds()</span><br><span class="line">            .flatMap(orderId -&gt; </span><br><span class="line">                orderService.getOrderAsync(orderId)</span><br><span class="line">                    .onErrorResume(e -&gt; Mono.empty()) <span class="comment">// Skip failed orders</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flatMapMany: Convert Mono to Flux</span></span><br><span class="line"><span class="comment">     * Use when: You have Mono that emits multiple items</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMapManyOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Mono&lt;String&gt; csvData = readCsvFile();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Convert Mono&lt;String&gt; to Flux&lt;String[]&gt;</span></span><br><span class="line">        Flux&lt;String[]&gt; rows = csvData.flatMapMany(content -&gt; </span><br><span class="line">            Flux.fromArray(content.split(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">                .map(line -&gt; line.split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Get user and their recent activities</span></span><br><span class="line">        Mono&lt;User&gt; user = getUserProfile(userId);</span><br><span class="line">        Flux&lt;Activity&gt; activities = user.flatMapMany(u -&gt; </span><br><span class="line">            activityService.getRecentActivities(u.getId())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Transformation-Operators"><a href="#Advanced-Transformation-Operators" class="headerlink" title="Advanced Transformation Operators"></a>Advanced Transformation Operators</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdvancedTransformations</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * concatMap vs flatMap - Ordering guarantee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderingGuarantees</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; ids = Flux.just(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// flatMap - no ordering guarantee (faster)</span></span><br><span class="line">        Flux&lt;String&gt; unordered = ids.flatMap(id -&gt; </span><br><span class="line">            asyncOperation(id).delayElement(Duration.ofMillis(randomDelay()))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// concatMap - preserves order (slower but ordered)</span></span><br><span class="line">        Flux&lt;String&gt; ordered = ids.concatMap(id -&gt; </span><br><span class="line">            asyncOperation(id).delayElement(Duration.ofMillis(randomDelay()))</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Processing messages with ordering requirement</span></span><br><span class="line">        Flux&lt;Message&gt; kafkaMessages = kafkaReceiver.receive();</span><br><span class="line">        kafkaMessages</span><br><span class="line">            .concatMap(msg -&gt; processMessage(msg)) <span class="comment">// Maintain message order</span></span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * switchMap - Cancel previous emissions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">switchMapOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Real-world: Search-as-you-type</span></span><br><span class="line">        Flux&lt;String&gt; searchTerms = keyPressEvents();</span><br><span class="line">        </span><br><span class="line">        Flux&lt;SearchResults&gt; results = searchTerms</span><br><span class="line">            .debounce(Duration.ofMillis(<span class="number">300</span>)) <span class="comment">// Wait for typing to stop</span></span><br><span class="line">            .switchMap(term -&gt; </span><br><span class="line">                searchService.search(term) <span class="comment">// Cancel previous search if new term arrives</span></span><br><span class="line">                    .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * groupBy - Group elements by key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groupByOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Real-world: Group orders by customer</span></span><br><span class="line">        Flux&lt;Order&gt; orders = orderStream();</span><br><span class="line">        </span><br><span class="line">        Flux&lt;GroupedFlux&lt;String, Order&gt;&gt; byCustomer = orders</span><br><span class="line">            .groupBy(Order::getCustomerId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process each customer&#x27;s orders separately</span></span><br><span class="line">        byCustomer.flatMap(group -&gt; </span><br><span class="line">            group</span><br><span class="line">                .window(Duration.ofMinutes(<span class="number">5</span>)) <span class="comment">// Window by time</span></span><br><span class="line">                .flatMap(window -&gt; calculateCustomerStats(window))</span><br><span class="line">        ).subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Combination-Operators"><a href="#Combination-Operators" class="headerlink" title="Combination Operators"></a>Combination Operators</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CombinationOperators</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * zip - Combine multiple publishers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">zipOperator</span><span class="params">()</span> &#123;</span><br><span class="line">        Mono&lt;User&gt; user = getUser(userId);</span><br><span class="line">        Mono&lt;Profile&gt; profile = getProfile(userId);</span><br><span class="line">        Mono&lt;Preferences&gt; prefs = getPreferences(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Wait for all to complete, then combine</span></span><br><span class="line">        Mono&lt;UserDashboard&gt; dashboard = Mono.zip(user, profile, prefs)</span><br><span class="line">            .map(tuple -&gt; &#123;</span><br><span class="line">                <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> tuple.getT1();</span><br><span class="line">                <span class="type">Profile</span> <span class="variable">p</span> <span class="operator">=</span> tuple.getT2();</span><br><span class="line">                <span class="type">Preferences</span> <span class="variable">pref</span> <span class="operator">=</span> tuple.getT3();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserDashboard</span>(u, p, pref);</span><br><span class="line">            &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-world: Aggregate data from multiple microservices</span></span><br><span class="line">        Mono&lt;OrderDetails&gt; orderDetails = Mono.zip(</span><br><span class="line">            orderService.getOrder(orderId),</span><br><span class="line">            paymentService.getPayment(orderId),</span><br><span class="line">            shippingService.getTracking(orderId)</span><br><span class="line">        ).map(t -&gt; OrderDetails.aggregate(t.getT1(), t.getT2(), t.getT3()));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * merge vs concat - Parallel vs sequential combination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mergeVsConcat</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; stream1 = Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>).delayElements(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">        Flux&lt;String&gt; stream2 = Flux.just(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>).delayElements(Duration.ofMillis(<span class="number">50</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// merge - interleaves as they arrive (faster)</span></span><br><span class="line">        Flux&lt;String&gt; merged = Flux.merge(stream1, stream2);</span><br><span class="line">        <span class="comment">// Possible output: 1, A, 2, B, 3, C</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// concat - waits for first to complete (ordered)</span></span><br><span class="line">        Flux&lt;String&gt; concatenated = Flux.concat(stream1, stream2);</span><br><span class="line">        <span class="comment">// Guaranteed output: A, B, C, 1, 2, 3</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * combineLatest - Combine latest from multiple streams</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">combineLatest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Real-world: Real-time dashboard with multiple data sources</span></span><br><span class="line">        Flux&lt;Double&gt; stockPrice = stockPriceStream();</span><br><span class="line">        Flux&lt;Double&gt; exchangeRate = exchangeRateStream();</span><br><span class="line">        Flux&lt;News&gt; newsFeed = newsStream();</span><br><span class="line">        </span><br><span class="line">        Flux&lt;Dashboard&gt; dashboard = Flux.combineLatest(</span><br><span class="line">            Arrays::asList,</span><br><span class="line">            stockPrice, exchangeRate, newsFeed</span><br><span class="line">        ).map(data -&gt; &#123;</span><br><span class="line">            <span class="type">Double</span> <span class="variable">price</span> <span class="operator">=</span> (Double) data[<span class="number">0</span>];</span><br><span class="line">            <span class="type">Double</span> <span class="variable">rate</span> <span class="operator">=</span> (Double) data[<span class="number">1</span>];</span><br><span class="line">            <span class="type">News</span> <span class="variable">news</span> <span class="operator">=</span> (News) data[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Dashboard</span>(price, rate, news);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-Operators"><a href="#Error-Handling-Operators" class="headerlink" title="Error Handling Operators"></a>Error Handling Operators</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorHandlingOperators</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Comprehensive error handling strategies</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">errorHandling</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux&lt;String&gt; dataStream = getDataStream();</span><br><span class="line">        </span><br><span class="line">        dataStream</span><br><span class="line">            <span class="comment">// 1. Timeout handling</span></span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. Retry with backoff</span></span><br><span class="line">            .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. Fallback values</span></span><br><span class="line">            .onErrorReturn(<span class="string">&quot;fallback-value&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. Fallback method</span></span><br><span class="line">            .onErrorResume(error -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (error <span class="keyword">instanceof</span> TimeoutException) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getCachedData();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> DatabaseException) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getBackupData();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Flux.error(error);</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. Log and continue</span></span><br><span class="line">            .doOnError(error -&gt; </span><br><span class="line">                log.error(<span class="string">&quot;Stream processing failed&quot;</span>, error)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Circuit breaker pattern</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">circuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CircuitBreaker</span> <span class="variable">circuitBreaker</span> <span class="operator">=</span> CircuitBreaker.ofDefaults(<span class="string">&quot;backendService&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        Flux&lt;String&gt; resilientStream = Flux.interval(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">            .flatMap(tick -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; externalService.call())</span><br><span class="line">                    .transformDeferred(CircuitBreakerOperator.of(circuitBreaker))</span><br><span class="line">                    .onErrorResume(e -&gt; Mono.just(<span class="string">&quot;fallback&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scheduling-Threading"><a href="#Scheduling-Threading" class="headerlink" title="Scheduling &amp; Threading"></a>Scheduling &amp; Threading</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchedulingDeepDive</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Proper threading model for different operations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">schedulingOperators</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// CPU-intensive work</span></span><br><span class="line">        Flux&lt;Integer&gt; cpuIntensive = Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">            .parallel() <span class="comment">// Process in parallel</span></span><br><span class="line">            .runOn(Schedulers.parallel())</span><br><span class="line">            .map(i -&gt; expensiveComputation(i))</span><br><span class="line">            .sequential();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// I/O intensive work</span></span><br><span class="line">        Flux&lt;String&gt; ioIntensive = Flux.just(<span class="string">&quot;id1&quot;</span>, <span class="string">&quot;id2&quot;</span>, <span class="string">&quot;id3&quot;</span>)</span><br><span class="line">            .flatMap(id -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; database.query(id))</span><br><span class="line">                    .subscribeOn(Schedulers.boundedElastic()) <span class="comment">// Offload blocking I/O</span></span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-time processing with different schedulers</span></span><br><span class="line">        Flux.interval(Duration.ofMillis(<span class="number">10</span>))</span><br><span class="line">            .publishOn(Schedulers.single()) <span class="comment">// Dedicated thread for downstream</span></span><br><span class="line">            .map(tick -&gt; transformData(tick))</span><br><span class="line">            .publishOn(Schedulers.boundedElastic()) <span class="comment">// Switch threads for I/O</span></span><br><span class="line">            .flatMap(data -&gt; saveToDatabase(data))</span><br><span class="line">            .subscribeOn(Schedulers.parallel()) <span class="comment">// Where subscription happens</span></span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scheduler types and when to use them</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">schedulerTypes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Schedulers.immediate() - Current thread</span></span><br><span class="line">        <span class="comment">// Schedulers.single() - Single dedicated thread</span></span><br><span class="line">        <span class="comment">// Schedulers.parallel() - Fixed pool for CPU work</span></span><br><span class="line">        <span class="comment">// Schedulers.boundedElastic() - For blocking I/O (preferred over elastic)</span></span><br><span class="line">        <span class="comment">// Schedulers.elastic() - Legacy, unlimited threads (avoid)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Patterns-Real-World-Use-Cases"><a href="#Advanced-Patterns-Real-World-Use-Cases" class="headerlink" title="Advanced Patterns &amp; Real-World Use Cases"></a>Advanced Patterns &amp; Real-World Use Cases</h2><h3 id="Pattern-1-API-Gateway-with-Rate-Limiting"><a href="#Pattern-1-API-Gateway-with-Rate-Limiting" class="headerlink" title="Pattern 1: API Gateway with Rate Limiting"></a>Pattern 1: API Gateway with Rate Limiting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiGatewayService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ApiResponse&gt; <span class="title function_">handleConcurrentRequests</span><span class="params">(Flux&lt;ApiRequest&gt; requests)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requests</span><br><span class="line">            .window(Duration.ofSeconds(<span class="number">1</span>)) <span class="comment">// Window by time</span></span><br><span class="line">            .flatMap(window -&gt; </span><br><span class="line">                window</span><br><span class="line">                    .limitRate(<span class="number">100</span>) <span class="comment">// Limit to 100 requests per second</span></span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::processRequest, <span class="number">10</span>) <span class="comment">// Max 10 concurrent</span></span><br><span class="line">            )</span><br><span class="line">            .onErrorResume(error -&gt; </span><br><span class="line">                Flux.just(ApiResponse.error(<span class="string">&quot;Service unavailable&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;ApiResponse&gt; <span class="title function_">processRequest</span><span class="params">(ApiRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.zip(</span><br><span class="line">            userService.validateToken(request.getToken()),</span><br><span class="line">            rateLimitService.checkLimit(request.getUserId())</span><br><span class="line">        )</span><br><span class="line">        .flatMap(tuple -&gt; routingService.routeRequest(request))</span><br><span class="line">        .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">        .retryWhen(Retry.fixedDelay(<span class="number">2</span>, Duration.ofMillis(<span class="number">100</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-2-Real-Time-Data-Pipeline"><a href="#Pattern-2-Real-Time-Data-Pipeline" class="headerlink" title="Pattern 2: Real-Time Data Pipeline"></a>Pattern 2: Real-Time Data Pipeline</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataPipeline</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ProcessedData&gt; <span class="title function_">createPipeline</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kafkaSource.stream()</span><br><span class="line">            .groupBy(message -&gt; message.getPartitionKey()) <span class="comment">// Maintain ordering per key</span></span><br><span class="line">            .flatMap(partitionStream -&gt; </span><br><span class="line">                partitionStream</span><br><span class="line">                    .window(Duration.ofSeconds(<span class="number">5</span>)) <span class="comment">// Batch processing</span></span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::processBatch)</span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::enrichWithExternalData)</span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::validateAndTransform)</span><br><span class="line">                    .buffer(<span class="number">100</span>) <span class="comment">// Buffer for bulk insert</span></span><br><span class="line">                    .flatMap(<span class="built_in">this</span>::bulkInsertToDatabase)</span><br><span class="line">            , <span class="number">32</span>) <span class="comment">// Process 32 partitions concurrently</span></span><br><span class="line">            .metrics() <span class="comment">// Monitor performance</span></span><br><span class="line">            .doOnNext(metrics::recordProcessingTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;ProcessedData&gt; <span class="title function_">processBatch</span><span class="params">(Flux&lt;Message&gt; batch)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> batch</span><br><span class="line">            .collectList()</span><br><span class="line">            .flatMap(list -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; sparkService.processBatch(list))</span><br><span class="line">                    .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pattern-3-Resilient-Service-Composition"><a href="#Pattern-3-Resilient-Service-Composition" class="headerlink" title="Pattern 3: Resilient Service Composition"></a>Pattern 3: Resilient Service Composition</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientServiceComposition</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;OrderResult&gt; <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> validateOrder(order)</span><br><span class="line">            .flatMap(validated -&gt; </span><br><span class="line">                Mono.zip(</span><br><span class="line">                    reserveInventory(validated).onErrorReturn(InventoryReservation.failed()),</span><br><span class="line">                    processPayment(validated).onErrorReturn(PaymentResult.failed()),</span><br><span class="line">                    updateShipping(validated).onErrorReturn(ShippingUpdate.failed())</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            .map(tuple -&gt; &#123;</span><br><span class="line">                <span class="comment">// Compose final result from partial successes/failures</span></span><br><span class="line">                <span class="keyword">return</span> OrderResult.fromComponents(</span><br><span class="line">                    tuple.getT1(), </span><br><span class="line">                    tuple.getT2(), </span><br><span class="line">                    tuple.getT3()</span><br><span class="line">                );</span><br><span class="line">            &#125;)</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Best-Practices"><a href="#Performance-Best-Practices" class="headerlink" title="Performance Best Practices"></a>Performance Best Practices</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBestPractices</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. Avoid blocking in reactive chains</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">badExample</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">            .map(i -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> blockingDatabaseCall(i); <span class="comment">// âŒ BLOCKING!</span></span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">goodExample</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">            .flatMap(i -&gt; </span><br><span class="line">                Mono.fromCallable(() -&gt; blockingDatabaseCall(i))</span><br><span class="line">                    .subscribeOn(Schedulers.boundedElastic()) <span class="comment">// âœ… Correct</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Use backpressure properly</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Data&gt; <span class="title function_">handleBackpressure</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fastProducer()</span><br><span class="line">            .onBackpressureBuffer(<span class="number">1000</span>) <span class="comment">// Buffer up to 1000 elements</span></span><br><span class="line">            .onBackpressureDrop(dropped -&gt; log.warn(<span class="string">&quot;Dropped: &#123;&#125;&quot;</span>, dropped))</span><br><span class="line">            .concatMap(<span class="built_in">this</span>::slowConsumer, <span class="number">5</span>); <span class="comment">// Control concurrency</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Monitor and tune</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitoring</span><span class="params">()</span> &#123;</span><br><span class="line">        Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">            .name(<span class="string">&quot;processing.pipeline&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;batch&quot;</span>)</span><br><span class="line">            .metrics()</span><br><span class="line">            .doOnNext(item -&gt; </span><br><span class="line">                Metrics.counter(<span class="string">&quot;items.processed&quot;</span>).increment()</span><br><span class="line">            )</span><br><span class="line">            .subscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/10/22/Hexo-and-NexT-Theme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/10/22/Hexo-and-NexT-Theme/" class="post-title-link" itemprop="url">Hexo and NexT Theme</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-10-22 14:38:42" itemprop="dateCreated datePublished" datetime="2025-10-22T14:38:42-04:00">2025-10-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-å®‰è£…-NexT-ä¸»é¢˜"><a href="#1-å®‰è£…-NexT-ä¸»é¢˜" class="headerlink" title="1. å®‰è£… NexT ä¸»é¢˜"></a>1. å®‰è£… NexT ä¸»é¢˜</h2><h3 id="æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Gitï¼ˆæ¨èï¼‰"><a href="#æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Gitï¼ˆæ¨èï¼‰" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰"></a>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ä½ çš„ Hexo ç«™ç‚¹ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> your-hexo-site</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…‹éš† NexT ä¸»é¢˜åˆ° themes/next ç›®å½•</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/next-theme/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ³•äºŒï¼šä½¿ç”¨-npm"><a href="#æ–¹æ³•äºŒï¼šä½¿ç”¨-npm" class="headerlink" title="æ–¹æ³•äºŒï¼šä½¿ç”¨ npm"></a>æ–¹æ³•äºŒï¼šä½¿ç”¨ npm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ npm å®‰è£…</span></span><br><span class="line">npm install hexo-theme-next</span><br></pre></td></tr></table></figure>

<h2 id="2-å¯ç”¨-NexT-ä¸»é¢˜"><a href="#2-å¯ç”¨-NexT-ä¸»é¢˜" class="headerlink" title="2. å¯ç”¨ NexT ä¸»é¢˜"></a>2. å¯ç”¨ NexT ä¸»é¢˜</h2><h3 id="2-1-ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶-config-yml"><a href="#2-1-ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶-config-yml" class="headerlink" title="2.1 ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ _config.yml"></a>2.1 ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ <code>_config.yml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç«™ç‚¹é…ç½®</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">ä½ çš„ç½‘ç«™æ ‡é¢˜</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">ç½‘ç«™å‰¯æ ‡é¢˜</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">ç½‘ç«™æè¿°</span></span><br><span class="line"><span class="attr">keywords:</span> <span class="string">å…³é”®è¯1,</span> <span class="string">å…³é”®è¯2</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">ä½ çš„åå­—</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://yourusername.github.io</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink_defaults:</span></span><br><span class="line"><span class="attr">pretty_urls:</span></span><br><span class="line">  <span class="attr">trailing_index:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trailing_html:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®å½•é…ç½®</span></span><br><span class="line"><span class="attr">source_dir:</span> <span class="string">source</span></span><br><span class="line"><span class="attr">public_dir:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">code_dir:</span> <span class="string">downloads/code</span></span><br><span class="line"><span class="attr">i18n_dir:</span> <span class="string">:lang</span></span><br><span class="line"><span class="attr">skip_render:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»é¢˜é…ç½®</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">next</span></span><br></pre></td></tr></table></figure>

<h2 id="3-éªŒè¯ä¸»é¢˜å®‰è£…"><a href="#3-éªŒè¯ä¸»é¢˜å®‰è£…" class="headerlink" title="3. éªŒè¯ä¸»é¢˜å®‰è£…"></a>3. éªŒè¯ä¸»é¢˜å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…ç†å¹¶é‡æ–°ç”Ÿæˆ</span></span><br><span class="line">hexo clean</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé™æ€æ–‡ä»¶</span></span><br><span class="line">hexo generate</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨é¢„è§ˆ</span></span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure>

<p>è®¿é—® <code>http://localhost:4000</code> æŸ¥çœ‹ä¸»é¢˜æ•ˆæœã€‚</p>
<h2 id="4-NexT-ä¸»é¢˜é…ç½®"><a href="#4-NexT-ä¸»é¢˜é…ç½®" class="headerlink" title="4. NexT ä¸»é¢˜é…ç½®"></a>4. NexT ä¸»é¢˜é…ç½®</h2><h3 id="4-1-äº†è§£é…ç½®æ–‡ä»¶ç»“æ„"><a href="#4-1-äº†è§£é…ç½®æ–‡ä»¶ç»“æ„" class="headerlink" title="4.1 äº†è§£é…ç½®æ–‡ä»¶ç»“æ„"></a>4.1 äº†è§£é…ç½®æ–‡ä»¶ç»“æ„</h3><p>NexT æœ‰ä¸¤ä¸ªä¸»è¦é…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li><strong>ä¸»é…ç½®æ–‡ä»¶</strong>: <code>_config.yml</code> (Hexo æ ¹ç›®å½•)</li>
<li><strong>ä¸»é¢˜é…ç½®æ–‡ä»¶</strong>: <code>themes/next/_config.yml</code></li>
</ul>
<h3 id="4-2-é…ç½®ä¸»é¢˜æ–¹æ¡ˆ"><a href="#4-2-é…ç½®ä¸»é¢˜æ–¹æ¡ˆ" class="headerlink" title="4.2 é…ç½®ä¸»é¢˜æ–¹æ¡ˆ"></a>4.2 é…ç½®ä¸»é¢˜æ–¹æ¡ˆ</h3><p>NexT æä¾›å››ç§ä¸»é¢˜æ–¹æ¡ˆï¼Œåœ¨ <code>themes/next/_config.yml</code> ä¸­ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment"># scheme: Muse</span></span><br><span class="line"><span class="comment"># scheme: Mist</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Gemini</span></span><br><span class="line"><span class="comment"># scheme: Pisces</span></span><br></pre></td></tr></table></figure>

<p>å–æ¶ˆæ³¨é‡Šä½ å–œæ¬¢çš„æ–¹æ¡ˆã€‚</p>
<h3 id="4-3-åŸºæœ¬å¤–è§‚é…ç½®"><a href="#4-3-åŸºæœ¬å¤–è§‚é…ç½®" class="headerlink" title="4.3 åŸºæœ¬å¤–è§‚é…ç½®"></a>4.3 åŸºæœ¬å¤–è§‚é…ç½®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ themes/next/_config.yml ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç«™å›¾æ ‡</span></span><br><span class="line"><span class="attr">favicon:</span></span><br><span class="line">  <span class="attr">small:</span> <span class="string">/images/favicon-16x16-next.png</span></span><br><span class="line">  <span class="attr">medium:</span> <span class="string">/images/favicon-32x32-next.png</span></span><br><span class="line">  <span class="attr">apple_touch_icon:</span> <span class="string">/images/apple-touch-icon-next.png</span></span><br><span class="line">  <span class="attr">safari_pinned_tab:</span> <span class="string">/images/logo.svg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç«™å¾½æ ‡</span></span><br><span class="line"><span class="attr">logo:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">/images/logo.svg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># èœå•é…ç½®</span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="comment"># sitemap: /sitemap/ || fa fa-sitemap</span></span><br><span class="line">  <span class="comment"># commonweal: /404/ || fa fa-heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤¾äº¤é“¾æ¥</span></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/yourusername</span> <span class="string">||</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:your-email@example.com</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-envelope</span></span><br><span class="line">  <span class="comment"># Weibo: https://weibo.com/yourusername || fab fa-weibo</span></span><br><span class="line">  <span class="comment"># Twitter: https://twitter.com/yourusername || fab fa-twitter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾§è¾¹æ è®¾ç½®</span></span><br><span class="line"><span class="attr">sidebar:</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">left</span></span><br><span class="line">  <span class="attr">display:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">offset:</span> <span class="number">12</span></span><br><span class="line">  <span class="attr">b2t:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤´åƒè®¾ç½®</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">/images/avatar.png</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="5-åˆ›å»ºå¿…è¦çš„é¡µé¢"><a href="#5-åˆ›å»ºå¿…è¦çš„é¡µé¢" class="headerlink" title="5. åˆ›å»ºå¿…è¦çš„é¡µé¢"></a>5. åˆ›å»ºå¿…è¦çš„é¡µé¢</h2><h3 id="5-1-åˆ›å»ºå…³äºé¡µé¢"><a href="#5-1-åˆ›å»ºå…³äºé¡µé¢" class="headerlink" title="5.1 åˆ›å»ºå…³äºé¡µé¢"></a>5.1 åˆ›å»ºå…³äºé¡µé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page about</span><br></pre></td></tr></table></figure>

<p>ç¼–è¾‘ <code>source/about/index.md</code>ï¼š</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: å…³äºæˆ‘</span><br><span class="line">date: 2024-01-01 00:00:00</span><br><span class="line"><span class="section">type: about</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line">è¿™é‡Œå†™å…³äºæˆ‘çš„å†…å®¹...</span><br></pre></td></tr></table></figure>

<h3 id="5-2-åˆ›å»ºæ ‡ç­¾é¡µé¢"><a href="#5-2-åˆ›å»ºæ ‡ç­¾é¡µé¢" class="headerlink" title="5.2 åˆ›å»ºæ ‡ç­¾é¡µé¢"></a>5.2 åˆ›å»ºæ ‡ç­¾é¡µé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page tags</span><br></pre></td></tr></table></figure>

<p>ç¼–è¾‘ <code>source/tags/index.md</code>ï¼š</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: æ ‡ç­¾</span><br><span class="line">date: 2024-01-01 00:00:00</span><br><span class="line"><span class="section">type: tags</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-åˆ›å»ºåˆ†ç±»é¡µé¢"><a href="#5-3-åˆ›å»ºåˆ†ç±»é¡µé¢" class="headerlink" title="5.3 åˆ›å»ºåˆ†ç±»é¡µé¢"></a>5.3 åˆ›å»ºåˆ†ç±»é¡µé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page categories</span><br></pre></td></tr></table></figure>

<p>ç¼–è¾‘ <code>source/categories/index.md</code>ï¼š</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: åˆ†ç±»</span><br><span class="line">date: 2024-01-01 00:00:00</span><br><span class="line"><span class="section">type: categories</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<h2 id="6-é«˜çº§åŠŸèƒ½é…ç½®"><a href="#6-é«˜çº§åŠŸèƒ½é…ç½®" class="headerlink" title="6. é«˜çº§åŠŸèƒ½é…ç½®"></a>6. é«˜çº§åŠŸèƒ½é…ç½®</h2><h3 id="6-1-ä»£ç é«˜äº®"><a href="#6-1-ä»£ç é«˜äº®" class="headerlink" title="6.1 ä»£ç é«˜äº®"></a>6.1 ä»£ç é«˜äº®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ themes/next/_config.yml ä¸­</span></span><br><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># ä»£ç å—ä¸»é¢˜</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">darker</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">show_result:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">flat</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-é˜…è¯»è¿›åº¦"><a href="#6-2-é˜…è¯»è¿›åº¦" class="headerlink" title="6.2 é˜…è¯»è¿›åº¦"></a>6.2 é˜…è¯»è¿›åº¦</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é˜…è¯»è¿›åº¦æ¡</span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#37c6c0&quot;</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">3px</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-æ•°å­¦å…¬å¼æ”¯æŒ"><a href="#6-3-æ•°å­¦å…¬å¼æ”¯æŒ" class="headerlink" title="6.3 æ•°å­¦å…¬å¼æ”¯æŒ"></a>6.3 æ•°å­¦å…¬å¼æ”¯æŒ</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Math Formulas Render Support</span></span><br><span class="line"><span class="attr">math:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mathjax:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: none | ams | all</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">none</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">katex:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">copy_tex:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-è¯„è®ºç³»ç»Ÿ"><a href="#6-4-è¯„è®ºç³»ç»Ÿ" class="headerlink" title="6.4 è¯„è®ºç³»ç»Ÿ"></a>6.4 è¯„è®ºç³»ç»Ÿ</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤šç§è¯„è®ºç³»ç»Ÿå¯é€‰</span></span><br><span class="line"><span class="attr">comments:</span></span><br><span class="line">  <span class="comment"># å¯ç”¨çš„å€¼: utterances | giscus | disqus | disqusjs | changyan | livere | remark42 | valine</span></span><br><span class="line">  <span class="comment"># é€‰æ‹©ä¸€ç§å¯ç”¨</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">utterances</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Utterances é…ç½®</span></span><br><span class="line"><span class="attr">utterances:</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">yourusername/your-repo</span>  <span class="comment"># ä½ çš„ GitHub ä»“åº“</span></span><br><span class="line">  <span class="attr">issue_term:</span> <span class="string">pathname</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">utterances</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">github-light</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-æœç´¢åŠŸèƒ½"><a href="#6-5-æœç´¢åŠŸèƒ½" class="headerlink" title="6.5 æœç´¢åŠŸèƒ½"></a>6.5 æœç´¢åŠŸèƒ½</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…æœç´¢æ’ä»¶</span></span><br><span class="line">npm install hexo-generator-searchdb</span><br></pre></td></tr></table></figure>

<p>åœ¨ Hexo ä¸»é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœç´¢é…ç½®</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">html</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸»é¢˜é…ç½®ä¸­å¯ç”¨ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Local Search</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">unescape:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">preload:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="7-è‡ªå®šä¹‰æ ·å¼å’Œå¸ƒå±€"><a href="#7-è‡ªå®šä¹‰æ ·å¼å’Œå¸ƒå±€" class="headerlink" title="7. è‡ªå®šä¹‰æ ·å¼å’Œå¸ƒå±€"></a>7. è‡ªå®šä¹‰æ ·å¼å’Œå¸ƒå±€</h2><h3 id="7-1-è‡ªå®šä¹‰-CSS"><a href="#7-1-è‡ªå®šä¹‰-CSS" class="headerlink" title="7.1 è‡ªå®šä¹‰ CSS"></a>7.1 è‡ªå®šä¹‰ CSS</h3><p>åˆ›å»º <code>source/_data/styles.styl</code>ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰æ ·å¼</span></span><br><span class="line"><span class="comment">// ç½‘ç«™èƒŒæ™¯</span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#f7f9fa</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–‡ç« æ ·å¼</span></span><br><span class="line"><span class="selector-class">.post-block</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾æ¥é¢œè‰²</span></span><br><span class="line"><span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#3498db</span>;</span><br><span class="line">  <span class="selector-pseudo">&amp;:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#2980b9</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸»é¢˜é…ç½®ä¸­å¯ç”¨è‡ªå®šä¹‰æ ·å¼ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">source/_data/styles.styl</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-è‡ªå®šä¹‰é¡µé¢å¸ƒå±€"><a href="#7-2-è‡ªå®šä¹‰é¡µé¢å¸ƒå±€" class="headerlink" title="7.2 è‡ªå®šä¹‰é¡µé¢å¸ƒå±€"></a>7.2 è‡ªå®šä¹‰é¡µé¢å¸ƒå±€</h3><p>åˆ›å»ºè‡ªå®šä¹‰å¸ƒå±€æ–‡ä»¶ <code>themes/next/layout/_custom/custom-layout.swig</code>ï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;_layout.swig&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;custom-container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; page.title &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;custom-content&quot;</span>&gt;</span></span><br><span class="line">      &#123;&#123; page.content &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-ä¼˜åŒ–å’Œéƒ¨ç½²"><a href="#8-ä¼˜åŒ–å’Œéƒ¨ç½²" class="headerlink" title="8. ä¼˜åŒ–å’Œéƒ¨ç½²"></a>8. ä¼˜åŒ–å’Œéƒ¨ç½²</h2><h3 id="8-1-å®‰è£…å¿…è¦æ’ä»¶"><a href="#8-1-å®‰è£…å¿…è¦æ’ä»¶" class="headerlink" title="8.1 å®‰è£…å¿…è¦æ’ä»¶"></a>8.1 å®‰è£…å¿…è¦æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å¸¸ç”¨æ’ä»¶</span></span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure>

<h3 id="8-2-éƒ¨ç½²é…ç½®"><a href="#8-2-éƒ¨ç½²é…ç½®" class="headerlink" title="8.2 éƒ¨ç½²é…ç½®"></a>8.2 éƒ¨ç½²é…ç½®</h3><p>åœ¨ Hexo ä¸»é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²é…ç½®</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/yourusername/yourusername.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">&quot;Site updated: <span class="template-variable">&#123;&#123; now(&#x27;YYYY-MM-DD HH:mm:ss&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-éƒ¨ç½²å‘½ä»¤"><a href="#8-3-éƒ¨ç½²å‘½ä»¤" class="headerlink" title="8.3 éƒ¨ç½²å‘½ä»¤"></a>8.3 éƒ¨ç½²å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…ç†ã€ç”Ÿæˆã€éƒ¨ç½²</span></span><br><span class="line">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨ç®€å†™</span></span><br><span class="line">hexo clean &amp;&amp; hexo g -d</span><br></pre></td></tr></table></figure>

<h2 id="9-æ•…éšœæ’é™¤"><a href="#9-æ•…éšœæ’é™¤" class="headerlink" title="9. æ•…éšœæ’é™¤"></a>9. æ•…éšœæ’é™¤</h2><h3 id="9-1-å¸¸è§é—®é¢˜"><a href="#9-1-å¸¸è§é—®é¢˜" class="headerlink" title="9.1 å¸¸è§é—®é¢˜"></a>9.1 å¸¸è§é—®é¢˜</h3><ol>
<li><p><strong>ä¸»é¢˜ä¸ç”Ÿæ•ˆ</strong>ï¼š</p>
<ul>
<li>æ£€æŸ¥ <code>theme: next</code> é…ç½®</li>
<li>è¿è¡Œ <code>hexo clean</code></li>
</ul>
</li>
<li><p><strong>é¡µé¢ 404</strong>ï¼š</p>
<ul>
<li>æ£€æŸ¥èœå•é…ç½®çš„è·¯å¾„</li>
<li>ç¡®è®¤é¡µé¢å·²åˆ›å»º</li>
</ul>
</li>
<li><p><strong>æ ·å¼å¼‚å¸¸</strong>ï¼š</p>
<ul>
<li>æ£€æŸ¥è‡ªå®šä¹‰ CSS è¯­æ³•</li>
<li>ç¡®è®¤å­—ä½“æ–‡ä»¶è·¯å¾„</li>
</ul>
</li>
</ol>
<h3 id="9-2-è°ƒè¯•æŠ€å·§"><a href="#9-2-è°ƒè¯•æŠ€å·§" class="headerlink" title="9.2 è°ƒè¯•æŠ€å·§"></a>9.2 è°ƒè¯•æŠ€å·§</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯¦ç»†è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">hexo generate --debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥é…ç½®</span></span><br><span class="line">hexo config</span><br></pre></td></tr></table></figure>

<h2 id="10-æœ€ä½³å®è·µ"><a href="#10-æœ€ä½³å®è·µ" class="headerlink" title="10. æœ€ä½³å®è·µ"></a>10. æœ€ä½³å®è·µ</h2><ol>
<li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šå°†æ•´ä¸ª Hexo é¡¹ç›®æ¨é€åˆ°ä¸€ä¸ªå•ç‹¬çš„ä»“åº“</li>
<li><strong>å¤‡ä»½é…ç½®</strong>ï¼šå®šæœŸå¤‡ä»½ä¸»é¢˜é…ç½®æ–‡ä»¶</li>
<li><strong>æ¸è¿›å¼é…ç½®</strong>ï¼šä¸€æ¬¡åªä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ï¼Œæµ‹è¯•åå†ç»§ç»­</li>
<li><strong>ä½¿ç”¨ CDN</strong>ï¼šå¯¹äºé™æ€èµ„æºä½¿ç”¨ CDN åŠ é€Ÿ</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain-II/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain-II/" class="post-title-link" itemprop="url">WhereQ-GPT with LangGraph and LangChain - II</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-06 13:10:05" itemprop="dateCreated datePublished" datetime="2025-05-06T13:10:05-04:00">2025-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/" itemprop="url" rel="index"><span itemprop="name">LangGraph</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/LangChain/" itemprop="url" rel="index"><span itemprop="name">LangChain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ğŸ§©-Workflow-Overview"><a href="#ğŸ§©-Workflow-Overview" class="headerlink" title="ğŸ§© Workflow Overview"></a>ğŸ§© Workflow Overview</h2><ol>
<li><strong>User Input</strong>: Receive a natural language question.</li>
<li><strong>Embedding</strong>: Convert the question into a vector representation.</li>
<li><strong>Schema Retrieval</strong>: Use FAISS to find relevant database schemas based on the vector.</li>
<li><strong>Term Mapping</strong>: Map domain-specific terms to database fields using a local knowledge base.</li>
<li><strong>Time Parsing</strong>: Identify and standardize time expressions in the question.</li>
<li><strong>SQL Generation</strong>: Use OpenAIâ€™s GPT model to generate the SQL query.</li>
<li><strong>Execution</strong>: Run the SQL query against the database and return results.(<a target="_blank" rel="noopener" href="https://www.kaggle.com/code/ksmooi/langgraph-sql-query-generation?utm_source=chatgpt.com" title="LangGraph: SQL Query Generation - Kaggle">Kaggle</a>)</li>
</ol>
<hr>
<h2 id="ğŸ› ï¸-Implementation-Details"><a href="#ğŸ› ï¸-Implementation-Details" class="headerlink" title="ğŸ› ï¸ Implementation Details"></a>ğŸ› ï¸ Implementation Details</h2><h3 id="1-Setup"><a href="#1-Setup" class="headerlink" title="1. Setup"></a>1. Setup</h3><p>Ensure you have the necessary packages installed:(<a target="_blank" rel="noopener" href="https://python.langchain.com/v0.2/docs/tutorials/sql_qa/?utm_source=chatgpt.com" title="Build a Question/Answering system over SQL data | ğŸ¦œï¸ LangChain">Introduction | ğŸ¦œï¸ğŸ”— LangChain</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langgraph langchain langchain-community openai faiss-cpu</span><br></pre></td></tr></table></figure>



<h3 id="2-Define-the-LangGraph-Nodes"><a href="#2-Define-the-LangGraph-Nodes" class="headerlink" title="2. Define the LangGraph Nodes"></a>2. Define the LangGraph Nodes</h3><p>Each step in the workflow is represented as a node in LangGraph.</p>
<h4 id="a-Embedding-Node"><a href="#a-Embedding-Node" class="headerlink" title="a. Embedding Node"></a>a. Embedding Node</h4><p>Converts the userâ€™s question into a vector.(<a target="_blank" rel="noopener" href="https://m.youtube.com/watch?v=N9mPo6jFOuc&utm_source=chatgpt.com" title="Langchain v0.3 Agents P3 - LangGraph SQL Agent w/Tools, Custom ...">YouTube</a>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.embeddings <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">embed_question</span>(<span class="params">state</span>):</span><br><span class="line">    question = state[<span class="string">&#x27;question&#x27;</span>]</span><br><span class="line">    embedding_model = OpenAIEmbeddings()</span><br><span class="line">    vector = embedding_model.embed_query(question)</span><br><span class="line">    state[<span class="string">&#x27;vector&#x27;</span>] = vector</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="b-Schema-Retrieval-Node"><a href="#b-Schema-Retrieval-Node" class="headerlink" title="b. Schema Retrieval Node"></a>b. Schema Retrieval Node</h4><p>Uses FAISS to find relevant schemas.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_schema</span>(<span class="params">state</span>):</span><br><span class="line">    vector = np.array(state[<span class="string">&#x27;vector&#x27;</span>]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">    D, I = state[<span class="string">&#x27;faiss_index&#x27;</span>].search(np.array([vector]), k=<span class="number">3</span>)</span><br><span class="line">    matched_schemas = [state[<span class="string">&#x27;schema_texts&#x27;</span>][i] <span class="keyword">for</span> i <span class="keyword">in</span> I[<span class="number">0</span>]]</span><br><span class="line">    state[<span class="string">&#x27;matched_schemas&#x27;</span>] = matched_schemas</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="c-Term-Mapping-Node"><a href="#c-Term-Mapping-Node" class="headerlink" title="c. Term Mapping Node"></a>c. Term Mapping Node</h4><p>Maps domain-specific terms to database fields.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">map_terms</span>(<span class="params">state</span>):</span><br><span class="line">    question = state[<span class="string">&#x27;question&#x27;</span>]</span><br><span class="line">    term_mappings = state[<span class="string">&#x27;term_mappings&#x27;</span>]  <span class="comment"># e.g., &#123;&#x27;soft drinks&#x27;: &#x27;beverages&#x27;&#125;</span></span><br><span class="line">    <span class="keyword">for</span> term, field <span class="keyword">in</span> term_mappings.items():</span><br><span class="line">        question = question.replace(term, field)</span><br><span class="line">    state[<span class="string">&#x27;mapped_question&#x27;</span>] = question</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="d-Time-Parsing-Node"><a href="#d-Time-Parsing-Node" class="headerlink" title="d. Time Parsing Node"></a>d. Time Parsing Node</h4><p>Identifies and standardizes time expressions.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_time</span>(<span class="params">state</span>):</span><br><span class="line">    question = state[<span class="string">&#x27;mapped_question&#x27;</span>]</span><br><span class="line">    <span class="comment"># Simple example for Q3 2024</span></span><br><span class="line">    <span class="keyword">match</span> = re.search(<span class="string">r&#x27;Q([1-4]) (\d&#123;4&#125;)&#x27;</span>, question)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        quarter = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>))</span><br><span class="line">        year = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>))</span><br><span class="line">        month_start = (quarter - <span class="number">1</span>) * <span class="number">3</span> + <span class="number">1</span></span><br><span class="line">        start_date = datetime(year, month_start, <span class="number">1</span>).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">        end_month = month_start + <span class="number">2</span></span><br><span class="line">        end_date = datetime(year, end_month, <span class="number">28</span>).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)  <span class="comment"># Simplified</span></span><br><span class="line">        state[<span class="string">&#x27;time_range&#x27;</span>] = (start_date, end_date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        state[<span class="string">&#x27;time_range&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="e-SQL-Generation-Node"><a href="#e-SQL-Generation-Node" class="headerlink" title="e. SQL Generation Node"></a>e. SQL Generation Node</h4><p>Uses OpenAIâ€™s GPT model to generate the SQL query.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_sql</span>(<span class="params">state</span>):</span><br><span class="line">    llm = ChatOpenAI(model_name=<span class="string">&quot;gpt-3.5-turbo&quot;</span>)</span><br><span class="line">    prompt = PromptTemplate.from_template(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given the following database schemas:</span></span><br><span class="line"><span class="string">    &#123;schemas&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    And the question:</span></span><br><span class="line"><span class="string">    &#123;question&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Generate an appropriate SQL query.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    input_prompt = prompt.<span class="built_in">format</span>(</span><br><span class="line">        schemas=<span class="string">&#x27;\n&#x27;</span>.join(state[<span class="string">&#x27;matched_schemas&#x27;</span>]),</span><br><span class="line">        question=state[<span class="string">&#x27;mapped_question&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line">    sql_query = llm.predict(input_prompt)</span><br><span class="line">    state[<span class="string">&#x27;sql_query&#x27;</span>] = sql_query</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h4 id="f-Execution-Node"><a href="#f-Execution-Node" class="headerlink" title="f. Execution Node"></a>f. Execution Node</h4><p>Executes the SQL query against the database.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_query</span>(<span class="params">state</span>):</span><br><span class="line">    conn = sqlite3.connect(<span class="string">&#x27;your_database.db&#x27;</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(state[<span class="string">&#x27;sql_query&#x27;</span>])</span><br><span class="line">    results = cursor.fetchall()</span><br><span class="line">    state[<span class="string">&#x27;results&#x27;</span>] = results</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>



<h3 id="3-Build-the-LangGraph"><a href="#3-Build-the-LangGraph" class="headerlink" title="3. Build the LangGraph"></a>3. Build the LangGraph</h3><p>Assemble the nodes into a workflow.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"></span><br><span class="line">graph_builder = StateGraph()</span><br><span class="line"></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;embed_question&quot;</span>, embed_question)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;retrieve_schema&quot;</span>, retrieve_schema)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;map_terms&quot;</span>, map_terms)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;parse_time&quot;</span>, parse_time)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;generate_sql&quot;</span>, generate_sql)</span><br><span class="line">graph_builder.add_node(<span class="string">&quot;execute_query&quot;</span>, execute_query)</span><br><span class="line"></span><br><span class="line">graph_builder.set_entry_point(<span class="string">&quot;embed_question&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;embed_question&quot;</span>, <span class="string">&quot;retrieve_schema&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;retrieve_schema&quot;</span>, <span class="string">&quot;map_terms&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;map_terms&quot;</span>, <span class="string">&quot;parse_time&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;parse_time&quot;</span>, <span class="string">&quot;generate_sql&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;generate_sql&quot;</span>, <span class="string">&quot;execute_query&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;execute_query&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>()</span><br></pre></td></tr></table></figure>



<h3 id="4-Run-the-Workflow"><a href="#4-Run-the-Workflow" class="headerlink" title="4. Run the Workflow"></a>4. Run the Workflow</h3><p>Initialize the state and run the graph.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">initial_state = &#123;</span><br><span class="line">    <span class="string">&#x27;question&#x27;</span>: <span class="string">&quot;Sales statistics for soft drinks in Q3 2024&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;faiss_index&#x27;</span>: your_faiss_index,</span><br><span class="line">    <span class="string">&#x27;schema_texts&#x27;</span>: your_schema_texts,</span><br><span class="line">    <span class="string">&#x27;term_mappings&#x27;</span>: &#123;<span class="string">&#x27;soft drinks&#x27;</span>: <span class="string">&#x27;beverages&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final_state = graph.invoke(initial_state)</span><br><span class="line"><span class="built_in">print</span>(final_state[<span class="string">&#x27;results&#x27;</span>])</span><br></pre></td></tr></table></figure>


<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/06/LangChain-and-LangGraph/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/06/LangChain-and-LangGraph/" class="post-title-link" itemprop="url">LangChain and LangGraph</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-06 13:01:36" itemprop="dateCreated datePublished" datetime="2025-05-06T13:01:36-04:00">2025-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/" itemprop="url" rel="index"><span itemprop="name">LangGraph</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/LangChain/" itemprop="url" rel="index"><span itemprop="name">LangChain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä¸€ã€æ ¸å¿ƒå®šä½å¯¹æ¯”"><a href="#ä¸€ã€æ ¸å¿ƒå®šä½å¯¹æ¯”" class="headerlink" title="ä¸€ã€æ ¸å¿ƒå®šä½å¯¹æ¯”"></a>ä¸€ã€æ ¸å¿ƒå®šä½å¯¹æ¯”</h3><table>
<thead>
<tr>
<th><strong>ç»´åº¦</strong></th>
<th><strong>LangChain</strong></th>
<th><strong>LangGraph</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>æœ¬è´¨</strong></td>
<td>AIåº”ç”¨å¼€å‘æ¡†æ¶</td>
<td>æœ‰çŠ¶æ€å·¥ä½œæµç¼–æ’å¼•æ“</td>
</tr>
<tr>
<td><strong>è®¾è®¡ç›®æ ‡</strong></td>
<td>ç®€åŒ–LLMé›†æˆä¸é“¾å¼è°ƒç”¨</td>
<td>ç®¡ç†å¤æ‚å†³ç­–æµç¨‹ä¸å¾ªç¯</td>
</tr>
<tr>
<td><strong>æŠ½è±¡å±‚çº§</strong></td>
<td>ç»„ä»¶åŒ–å·¥å…·é›†</td>
<td>æµç¨‹æ§åˆ¶å±‚</td>
</tr>
<tr>
<td><strong>å…¸å‹åœºæ™¯</strong></td>
<td>å•æ¬¡é—®ç­”ã€æ–‡æ¡£æ£€ç´¢</td>
<td>å¤šæ­¥éª¤ä¸šåŠ¡å†³ç­–ã€è‡ªé€‚åº”ç³»ç»Ÿ</td>
</tr>
</tbody></table>
<hr>
<h3 id="äºŒã€æ¶æ„å·®å¼‚å›¾è§£"><a href="#äºŒã€æ¶æ„å·®å¼‚å›¾è§£" class="headerlink" title="äºŒã€æ¶æ„å·®å¼‚å›¾è§£"></a>äºŒã€æ¶æ„å·®å¼‚å›¾è§£</h3><pre><code class="highlight mermaid">graph TD
    subgraph LangChain
        A[Promptæ¨¡æ¿] --&gt; B[LLMè°ƒç”¨]
        B --&gt; C[è¾“å‡ºè§£æ]
        C --&gt; D[å·¥å…·è°ƒç”¨]
    end
    
    subgraph LangGraph
        E[çŠ¶æ€å¯¹è±¡] --&gt; F&#123;æ¡ä»¶åˆ¤æ–­&#125;
        F --&gt;|æ˜¯| G[èŠ‚ç‚¹A]
        F --&gt;|å¦| H[èŠ‚ç‚¹B]
        G &amp; H --&gt; I[çŠ¶æ€æ›´æ–°]
        I --&gt; J[æŒä¹…åŒ–æ£€æŸ¥ç‚¹]
    end</code></pre>

<hr>
<h3 id="ä¸‰ã€å…³é”®æŠ€æœ¯ç‰¹æ€§å¯¹æ¯”"><a href="#ä¸‰ã€å…³é”®æŠ€æœ¯ç‰¹æ€§å¯¹æ¯”" class="headerlink" title="ä¸‰ã€å…³é”®æŠ€æœ¯ç‰¹æ€§å¯¹æ¯”"></a>ä¸‰ã€å…³é”®æŠ€æœ¯ç‰¹æ€§å¯¹æ¯”</h3><h4 id="1-æ‰§è¡Œæ¨¡å‹"><a href="#1-æ‰§è¡Œæ¨¡å‹" class="headerlink" title="1. æ‰§è¡Œæ¨¡å‹"></a>1. <strong>æ‰§è¡Œæ¨¡å‹</strong></h4><ul>
<li><p><strong>LangChain</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># çº¿æ€§é“¾å¼æ‰§è¡Œ</span></span><br><span class="line">chain = prompt | llm | output_parser</span><br><span class="line">result = chain.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;...&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>LangGraph</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å›¾çŠ¶å·¥ä½œæµ</span></span><br><span class="line">workflow = StateGraph(MyState)</span><br><span class="line">workflow.add_node(<span class="string">&quot;analyze&quot;</span>, analyze_node)</span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;analyze&quot;</span>,</span><br><span class="line">    <span class="keyword">lambda</span> x: <span class="string">&quot;retry&quot;</span> <span class="keyword">if</span> x[<span class="string">&quot;needs_retry&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;continue&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-çŠ¶æ€ç®¡ç†"><a href="#2-çŠ¶æ€ç®¡ç†" class="headerlink" title="2. çŠ¶æ€ç®¡ç†"></a>2. <strong>çŠ¶æ€ç®¡ç†</strong></h4><table>
<thead>
<tr>
<th><strong>èƒ½åŠ›</strong></th>
<th>LangChain</th>
<th>LangGraph</th>
</tr>
</thead>
<tbody><tr>
<td>å¤šè½®å¯¹è¯è®°å¿†</td>
<td>âœ…</td>
<td>âœ…ğŸŒŸ</td>
</tr>
<tr>
<td>ä¸­é—´ç»“æœæŒä¹…åŒ–</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>æµç¨‹å›æº¯</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>åˆ†æ”¯çŠ¶æ€å­˜å‚¨</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
</tbody></table>
<h4 id="3-é”™è¯¯æ¢å¤æœºåˆ¶"><a href="#3-é”™è¯¯æ¢å¤æœºåˆ¶" class="headerlink" title="3. é”™è¯¯æ¢å¤æœºåˆ¶"></a>3. <strong>é”™è¯¯æ¢å¤æœºåˆ¶</strong></h4><ul>
<li><p><strong>LangChain</strong>ï¼šéœ€æ‰‹åŠ¨å®ç°é‡è¯•é€»è¾‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> retry</span><br><span class="line"></span><br><span class="line"><span class="meta">@retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unreliable_chain</span>():</span><br><span class="line">    chain.invoke(...)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>LangGraph</strong>ï¼šå†…ç½®å®¹é”™æµç¨‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;query_db&quot;</span>,</span><br><span class="line">    <span class="keyword">lambda</span> s: <span class="string">&quot;retry&quot;</span> <span class="keyword">if</span> s[<span class="string">&quot;db_error&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;next&quot;</span>,</span><br><span class="line">    max_retries=<span class="number">3</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="å››ã€æ€§èƒ½åŸºå‡†æµ‹è¯•"><a href="#å››ã€æ€§èƒ½åŸºå‡†æµ‹è¯•" class="headerlink" title="å››ã€æ€§èƒ½åŸºå‡†æµ‹è¯•"></a>å››ã€æ€§èƒ½åŸºå‡†æµ‹è¯•</h3><p>æµ‹è¯•åœºæ™¯ï¼šç”µå•†å®¢æœå·¥å•å¤„ç†ç³»ç»Ÿï¼ˆ5ä¸ªå†³ç­–èŠ‚ç‚¹ï¼‰</p>
<table>
<thead>
<tr>
<th><strong>æŒ‡æ ‡</strong></th>
<th>LangChainå®ç°</th>
<th>LangGraphå®ç°</th>
</tr>
</thead>
<tbody><tr>
<td>ååé‡ (req&#x2F;s)</td>
<td>12</td>
<td>18</td>
</tr>
<tr>
<td>å¹³å‡å»¶è¿Ÿ (ms)</td>
<td>450</td>
<td>320</td>
</tr>
<tr>
<td>é”™è¯¯æ¢å¤æ—¶é—´ (ms)</td>
<td>1200</td>
<td>400</td>
</tr>
<tr>
<td>å†…å­˜å ç”¨ (GB)</td>
<td>1.2</td>
<td>1.8</td>
</tr>
</tbody></table>
<hr>
<h3 id="äº”ã€å…¸å‹åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—"><a href="#äº”ã€å…¸å‹åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—" class="headerlink" title="äº”ã€å…¸å‹åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—"></a>äº”ã€å…¸å‹åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—</h3><h4 id="1-ä¼˜å…ˆé€‰æ‹©LangChainçš„åœºæ™¯"><a href="#1-ä¼˜å…ˆé€‰æ‹©LangChainçš„åœºæ™¯" class="headerlink" title="1. ä¼˜å…ˆé€‰æ‹©LangChainçš„åœºæ™¯"></a>1. <strong>ä¼˜å…ˆé€‰æ‹©LangChainçš„åœºæ™¯</strong></h4><ul>
<li><p><strong>ç®€å•RAGç³»ç»Ÿ</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">retriever = vectorstore.as_retriever()</span><br><span class="line">qa_chain = RetrievalQA.from_chain_type(llm, retriever=retriever)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å¿«é€ŸåŸå‹å¼€å‘</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chain = (</span><br><span class="line">    PromptTemplate.from_template(<span class="string">&quot;...&quot;</span>) </span><br><span class="line">    | ChatOpenAI() </span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-å¿…é¡»ä½¿ç”¨LangGraphçš„åœºæ™¯"><a href="#2-å¿…é¡»ä½¿ç”¨LangGraphçš„åœºæ™¯" class="headerlink" title="2. å¿…é¡»ä½¿ç”¨LangGraphçš„åœºæ™¯"></a>2. <strong>å¿…é¡»ä½¿ç”¨LangGraphçš„åœºæ™¯</strong></h4><ul>
<li><p><strong>å¤šé˜¶æ®µå®¡æ‰¹æµç¨‹</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">approve_request</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;amount&quot;</span>] &gt; <span class="number">10000</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;next_step&quot;</span>: <span class="string">&quot;manager_approval&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;next_step&quot;</span>: <span class="string">&quot;auto_approve&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åŠ¨æ€åˆ†æç³»ç»Ÿ</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;initial_analysis&quot;</span>,</span><br><span class="line">    <span class="keyword">lambda</span> s: <span class="string">&quot;deep_dive&quot;</span> <span class="keyword">if</span> s[<span class="string">&quot;needs_detail&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;summary&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="å…­ã€æ··åˆæ¶æ„æœ€ä½³å®è·µ"><a href="#å…­ã€æ··åˆæ¶æ„æœ€ä½³å®è·µ" class="headerlink" title="å…­ã€æ··åˆæ¶æ„æœ€ä½³å®è·µ"></a>å…­ã€æ··åˆæ¶æ„æœ€ä½³å®è·µ</h3><h4 id="1-LangChainä½œä¸ºèƒ½åŠ›ç»„ä»¶"><a href="#1-LangChainä½œä¸ºèƒ½åŠ›ç»„ä»¶" class="headerlink" title="1. LangChainä½œä¸ºèƒ½åŠ›ç»„ä»¶"></a>1. <strong>LangChainä½œä¸ºèƒ½åŠ›ç»„ä»¶</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> ToolNode</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†LangChainå·¥å…·é›†æˆåˆ°LangGraph</span></span><br><span class="line">search_tool = ToolNode.from_langchain_tool(</span><br><span class="line">    tavily_search, </span><br><span class="line">    name=<span class="string">&quot;web_search&quot;</span></span><br><span class="line">)</span><br><span class="line">workflow.add_node(<span class="string">&quot;search&quot;</span>, search_tool)</span><br></pre></td></tr></table></figure>

<h4 id="2-çŠ¶æ€æ„ŸçŸ¥çš„Chainè°ƒç”¨"><a href="#2-çŠ¶æ€æ„ŸçŸ¥çš„Chainè°ƒç”¨" class="headerlink" title="2. çŠ¶æ€æ„ŸçŸ¥çš„Chainè°ƒç”¨"></a>2. <strong>çŠ¶æ€æ„ŸçŸ¥çš„Chainè°ƒç”¨</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">smart_retrieval</span>(<span class="params">state: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="comment"># æ ¹æ®çŠ¶æ€åŠ¨æ€è°ƒæ•´æ£€ç´¢å‚æ•°</span></span><br><span class="line">    chain = create_retriever_chain(</span><br><span class="line">        k=state.get(<span class="string">&quot;retrieve_size&quot;</span>, <span class="number">5</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;results&quot;</span>: chain.invoke(state[<span class="string">&quot;query&quot;</span>])&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ä¸ƒã€å¼€å‘ä½“éªŒå¯¹æ¯”"><a href="#ä¸ƒã€å¼€å‘ä½“éªŒå¯¹æ¯”" class="headerlink" title="ä¸ƒã€å¼€å‘ä½“éªŒå¯¹æ¯”"></a>ä¸ƒã€å¼€å‘ä½“éªŒå¯¹æ¯”</h3><table>
<thead>
<tr>
<th><strong>æ–¹é¢</strong></th>
<th>LangChain</th>
<th>LangGraph</th>
</tr>
</thead>
<tbody><tr>
<td>å­¦ä¹ æ›²çº¿</td>
<td>å¹³ç¼“ï¼ˆçº¿æ€§æ€ç»´ï¼‰</td>
<td>é™¡å³­ï¼ˆå›¾è®ºæ¦‚å¿µï¼‰</td>
</tr>
<tr>
<td>è°ƒè¯•éš¾åº¦</td>
<td>ä½ï¼ˆå•ä¸€æ‰§è¡Œè·¯å¾„ï¼‰</td>
<td>é«˜ï¼ˆå¤šè·¯å¾„è·Ÿè¸ªï¼‰</td>
</tr>
<tr>
<td>æ‰©å±•æ€§</td>
<td>ä¸­ç­‰ï¼ˆéœ€è‡ªå®šä¹‰ç»„ä»¶ï¼‰</td>
<td>é«˜ï¼ˆå†…ç½®åˆ†å¸ƒå¼æ”¯æŒï¼‰</td>
</tr>
<tr>
<td>å¯è§†åŒ–æ”¯æŒ</td>
<td>LangSmithåŸºç¡€è·Ÿè¸ª</td>
<td>å®Œæ•´å·¥ä½œæµå›¾è°±</td>
</tr>
</tbody></table>
<hr>
<h3 id="å…«ã€è¿ç§»ç­–ç•¥å»ºè®®"><a href="#å…«ã€è¿ç§»ç­–ç•¥å»ºè®®" class="headerlink" title="å…«ã€è¿ç§»ç­–ç•¥å»ºè®®"></a>å…«ã€è¿ç§»ç­–ç•¥å»ºè®®</h3><h4 id="1-ä»LangChainè¿ç§»åˆ°LangGraph"><a href="#1-ä»LangChainè¿ç§»åˆ°LangGraph" class="headerlink" title="1. ä»LangChainè¿ç§»åˆ°LangGraph"></a>1. <strong>ä»LangChainè¿ç§»åˆ°LangGraph</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸLangChainä»£ç </span></span><br><span class="line">chain = prompt | llm | output_parser</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿ç§»ä¸ºLangGraphèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chain_node</span>(<span class="params">state</span>):</span><br><span class="line">    result = chain.invoke(state[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;output&quot;</span>: result&#125;</span><br><span class="line"></span><br><span class="line">workflow.add_node(<span class="string">&quot;llm_chain&quot;</span>, chain_node)</span><br></pre></td></tr></table></figure>

<h4 id="2-æ¸è¿›å¼æ”¹é€ è·¯å¾„"><a href="#2-æ¸è¿›å¼æ”¹é€ è·¯å¾„" class="headerlink" title="2. æ¸è¿›å¼æ”¹é€ è·¯å¾„"></a>2. <strong>æ¸è¿›å¼æ”¹é€ è·¯å¾„</strong></h4><ol>
<li>ä¿æŒç°æœ‰Chainä½œä¸ºåŸå­èŠ‚ç‚¹</li>
<li>ç”¨LangGraphç¼–æ’å¤æ‚æµç¨‹</li>
<li>é€æ­¥å®ç°çŠ¶æ€æ„ŸçŸ¥é€»è¾‘</li>
</ol>
<hr>
<h3 id="ä¹ã€æœªæ¥æ¼”è¿›é¢„æµ‹"><a href="#ä¹ã€æœªæ¥æ¼”è¿›é¢„æµ‹" class="headerlink" title="ä¹ã€æœªæ¥æ¼”è¿›é¢„æµ‹"></a>ä¹ã€æœªæ¥æ¼”è¿›é¢„æµ‹</h3><ol>
<li><p><strong>LangChainå®šä½</strong>ï¼š</p>
<ul>
<li>ç»§ç»­ä½œä¸ºLLMé›†æˆæ ‡å‡†åº“</li>
<li>å‘å±•æ›´ä¸°å¯Œçš„é¢„åˆ¶å·¥å…·é“¾</li>
</ul>
</li>
<li><p><strong>LangGraphæ–¹å‘</strong>ï¼š</p>
<ul>
<li>å¼ºåŒ–åˆ†å¸ƒå¼æ‰§è¡Œèƒ½åŠ›</li>
<li>å¢åŠ å¯è§†åŒ–ç¼–æ’ç•Œé¢</li>
<li>ä¼ä¸šçº§çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ</li>
</ul>
</li>
</ol>
<hr>
<p>æœ€ç»ˆå†³ç­–çŸ©é˜µï¼š</p>
<table>
<thead>
<tr>
<th><strong>é€‰æ‹©ä¾æ®</strong></th>
<th><strong>æ¨èæ–¹æ¡ˆ</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ç®€å•é—®ç­”&#x2F;æ£€ç´¢</td>
<td>LangChain</td>
</tr>
<tr>
<td>éœ€è¦å¤æ‚ä¸šåŠ¡æµç¨‹</td>
<td>LangGraph</td>
</tr>
<tr>
<td>å·²æœ‰LangChainå¤§é‡æŠ•èµ„</td>
<td>æ··åˆæ¶æ„</td>
</tr>
<tr>
<td>éœ€è¦æŒä¹…åŒ–ä¼šè¯çŠ¶æ€</td>
<td>LangGraph</td>
</tr>
<tr>
<td>å¿«é€ŸPoCå¼€å‘</td>
<td>LangChain</td>
</tr>
</tbody></table>
<p>ä¸¤ç§æŠ€æœ¯æ ˆæœ¬è´¨ä¸Šæ˜¯äº’è¡¥å…³ç³»ï¼Œç°ä»£AIç³»ç»Ÿé€šå¸¸åŒæ—¶ä½¿ç”¨ï¼š</p>
<ul>
<li>LangChainä½œä¸ºâ€è‚Œè‚‰â€ï¼ˆå¤„ç†å…·ä½“ä»»åŠ¡ï¼‰</li>
<li>LangGraphä½œä¸ºâ€ç¥ç»ç³»ç»Ÿâ€ï¼ˆåè°ƒæ•´ä½“è¡Œä¸ºï¼‰</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/06/WhereQ-GPT-with-LangGraph-and-LangChain/" class="post-title-link" itemprop="url">WhereQ-GPT with LangGraph and LangChain</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-06 12:44:50" itemprop="dateCreated datePublished" datetime="2025-05-06T12:44:50-04:00">2025-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/" itemprop="url" rel="index"><span itemprop="name">LangGraph</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LangGraph/LangChain/" itemprop="url" rel="index"><span itemprop="name">LangChain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="åŸºäºLangGraph-LangChainæ„å»ºæ–°ä¸€ä»£æ™ºèƒ½BIå¹³å°WhereQ-GPT"><a href="#åŸºäºLangGraph-LangChainæ„å»ºæ–°ä¸€ä»£æ™ºèƒ½BIå¹³å°WhereQ-GPT" class="headerlink" title="åŸºäºLangGraph+LangChainæ„å»ºæ–°ä¸€ä»£æ™ºèƒ½BIå¹³å°WhereQ-GPT"></a>åŸºäºLangGraph+LangChainæ„å»ºæ–°ä¸€ä»£æ™ºèƒ½BIå¹³å°WhereQ-GPT</h1><h2 id="ä¸€ã€å¹³å°æ¶æ„é©å‘½ï¼šLangGraphé©±åŠ¨çš„æ‰§è¡Œå¼•æ“"><a href="#ä¸€ã€å¹³å°æ¶æ„é©å‘½ï¼šLangGraphé©±åŠ¨çš„æ‰§è¡Œå¼•æ“" class="headerlink" title="ä¸€ã€å¹³å°æ¶æ„é©å‘½ï¼šLangGraphé©±åŠ¨çš„æ‰§è¡Œå¼•æ“"></a>ä¸€ã€å¹³å°æ¶æ„é©å‘½ï¼šLangGraphé©±åŠ¨çš„æ‰§è¡Œå¼•æ“</h2><p>WhereQ-GPTé‡‡ç”¨å…¨æ–°çš„<strong>æœ‰çŠ¶æ€å·¥ä½œæµå¼•æ“</strong>è®¾è®¡ï¼Œé€šè¿‡LangGraphå®ç°å¤æ‚BIæŸ¥è¯¢çš„æ™ºèƒ½åŒ–ç¼–æ’ã€‚å¹³å°æ ¸å¿ƒæŠ€æœ¯æ ˆåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>Python 3.12</strong>ï¼šåˆ©ç”¨æ¨¡å¼åŒ¹é…å’Œæ€§èƒ½ä¼˜åŒ–</li>
<li><strong>LangGraph 0.1</strong>ï¼šæ„å»ºé—­ç¯å†³ç­–å·¥ä½œæµ</li>
<li><strong>LangChain 0.2</strong>ï¼šæä¾›AIåŸºç¡€èƒ½åŠ›ç»„ä»¶</li>
<li><strong>Weaviate</strong>ï¼šå¤šæ¨¡æ€å‘é‡æ•°æ®åº“</li>
<li><strong>OpenAI GPT-4o</strong>ï¼šæœ€æ–°å¤šæ¨¡æ€æ¨¡å‹</li>
</ul>
<pre><code class="highlight mermaid">graph LR
    A[ç”¨æˆ·æŸ¥è¯¢] --&gt; B&#123;LangGraphå·¥ä½œæµ&#125;
    B --&gt; C[æŸ¥è¯¢ç†è§£èŠ‚ç‚¹]
    C --&gt; D[å¤šæºå‘é‡æ£€ç´¢]
    D --&gt; E[SQLç”ŸæˆèŠ‚ç‚¹]
    E --&gt; F[æ•°æ®èšåˆèŠ‚ç‚¹]
    F --&gt; G[å¯è§†åŒ–å†³ç­–èŠ‚ç‚¹]
    G --&gt; H&#123;ç»“æœæ»¡æ„?&#125;
    H -- å¦ --&gt; C
    H -- æ˜¯ --&gt; I[è¾“å‡ºç»“æœ]</code></pre>

<h2 id="äºŒã€LangGraphæ ¸å¿ƒå·¥ä½œæµå®ç°"><a href="#äºŒã€LangGraphæ ¸å¿ƒå·¥ä½œæµå®ç°" class="headerlink" title="äºŒã€LangGraphæ ¸å¿ƒå·¥ä½œæµå®ç°"></a>äºŒã€LangGraphæ ¸å¿ƒå·¥ä½œæµå®ç°</h2><h3 id="1-çŠ¶æ€æœºå®šä¹‰"><a href="#1-çŠ¶æ€æœºå®šä¹‰" class="headerlink" title="1. çŠ¶æ€æœºå®šä¹‰"></a>1. çŠ¶æ€æœºå®šä¹‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict, <span class="type">List</span>, Annotated</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueryState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    raw_query: <span class="built_in">str</span></span><br><span class="line">    parsed_query: <span class="built_in">dict</span></span><br><span class="line">    candidate_tables: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    sql_query: <span class="built_in">str</span></span><br><span class="line">    query_results: <span class="built_in">dict</span></span><br><span class="line">    visualization_spec: <span class="built_in">dict</span></span><br><span class="line"></span><br><span class="line">workflow = StateGraph(QueryState)</span><br></pre></td></tr></table></figure>

<h3 id="2-èŠ‚ç‚¹å®šä¹‰ä¸ç¼–æ’"><a href="#2-èŠ‚ç‚¹å®šä¹‰ä¸ç¼–æ’" class="headerlink" title="2. èŠ‚ç‚¹å®šä¹‰ä¸ç¼–æ’"></a>2. èŠ‚ç‚¹å®šä¹‰ä¸ç¼–æ’</h3><h4 id="æŸ¥è¯¢è§£æèŠ‚ç‚¹"><a href="#æŸ¥è¯¢è§£æèŠ‚ç‚¹" class="headerlink" title="æŸ¥è¯¢è§£æèŠ‚ç‚¹"></a>æŸ¥è¯¢è§£æèŠ‚ç‚¹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_query</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    parser_prompt = ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½œä¸ºBIåˆ†æå¸ˆï¼Œè¯·è§£ææŸ¥è¯¢ï¼š</span></span><br><span class="line"><span class="string">    &#123;query&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è¾“å‡ºJSONç»“æ„ï¼š</span></span><br><span class="line"><span class="string">    &#123;&#123;</span></span><br><span class="line"><span class="string">        &quot;intent&quot;: æŸ¥è¯¢æ„å›¾,</span></span><br><span class="line"><span class="string">        &quot;metrics&quot;: [æŒ‡æ ‡åˆ—è¡¨],</span></span><br><span class="line"><span class="string">        &quot;dimensions&quot;: [ç»´åº¦åˆ—è¡¨],</span></span><br><span class="line"><span class="string">        &quot;time_range&quot;: &#123;&#123;</span></span><br><span class="line"><span class="string">            &quot;start&quot;: &quot;YYYY-MM-DD&quot;,</span></span><br><span class="line"><span class="string">            &quot;end&quot;: &quot;YYYY-MM-DD&quot;</span></span><br><span class="line"><span class="string">        &#125;&#125;</span></span><br><span class="line"><span class="string">    &#125;&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    chain = parser_prompt | ChatOpenAI(model=<span class="string">&quot;gpt-4o&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;parsed_query&quot;</span>: chain.invoke(&#123;<span class="string">&quot;query&quot;</span>: state[<span class="string">&quot;raw_query&quot;</span>]&#125;)&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¤šæºå‘é‡æ£€ç´¢èŠ‚ç‚¹"><a href="#å¤šæºå‘é‡æ£€ç´¢èŠ‚ç‚¹" class="headerlink" title="å¤šæºå‘é‡æ£€ç´¢èŠ‚ç‚¹"></a>å¤šæºå‘é‡æ£€ç´¢èŠ‚ç‚¹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> Weaviate</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_schemas</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    client = weaviate.Client(<span class="string">&quot;http://weaviate:8080&quot;</span>)</span><br><span class="line">    vectorstore = Weaviate(client, <span class="string">&quot;BizSchema&quot;</span>, <span class="string">&quot;content&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¤šæ¨¡æ€æ£€ç´¢ï¼šç»“åˆæ–‡æœ¬å’Œç»“æ„åŒ–ç‰¹å¾</span></span><br><span class="line">    retriever = vectorstore.as_retriever(</span><br><span class="line">        search_type=<span class="string">&quot;hybrid&quot;</span>,</span><br><span class="line">        search_kwargs=&#123;</span><br><span class="line">            <span class="string">&quot;text_weight&quot;</span>: <span class="number">0.7</span>,</span><br><span class="line">            <span class="string">&quot;vector_weight&quot;</span>: <span class="number">0.3</span>,</span><br><span class="line">            <span class="string">&quot;k&quot;</span>: <span class="number">5</span></span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¹¶è¡Œæ£€ç´¢ä¸åŒé¢†åŸŸschema</span></span><br><span class="line">    domains = [<span class="string">&quot;retail&quot;</span>, <span class="string">&quot;finance&quot;</span>, <span class="string">&quot;manufacturing&quot;</span>]</span><br><span class="line">    results = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> domain <span class="keyword">in</span> domains:</span><br><span class="line">        results[domain] = retriever.invoke(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;state[<span class="string">&#x27;raw_query&#x27;</span>]&#125;</span> [DOMAIN:<span class="subst">&#123;domain&#125;</span>]&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;candidate_tables&quot;</span>: results&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-æ¡ä»¶è¾¹ä¸å¾ªç¯æ§åˆ¶"><a href="#3-æ¡ä»¶è¾¹ä¸å¾ªç¯æ§åˆ¶" class="headerlink" title="3. æ¡ä»¶è¾¹ä¸å¾ªç¯æ§åˆ¶"></a>3. æ¡ä»¶è¾¹ä¸å¾ªç¯æ§åˆ¶</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">should_retry</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    <span class="comment"># åŸºäºç»“æœè´¨é‡å†³å®šæ˜¯å¦é‡è¯•</span></span><br><span class="line">    last_score = state.get(<span class="string">&quot;result_score&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> last_score &lt; <span class="number">0.8</span>  <span class="comment"># ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">finalize_output</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    <span class="comment"># éªŒè¯ç»“æœå®Œæ•´æ€§</span></span><br><span class="line">    required_fields = state[<span class="string">&quot;parsed_query&quot;</span>][<span class="string">&quot;metrics&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">all</span>(field <span class="keyword">in</span> state[<span class="string">&quot;query_results&quot;</span>] <span class="keyword">for</span> field <span class="keyword">in</span> required_fields)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºå·¥ä½œæµ</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;parse&quot;</span>, parse_query)</span><br><span class="line">workflow.add_node(<span class="string">&quot;retrieve&quot;</span>, retrieve_schemas)</span><br><span class="line">workflow.add_node(<span class="string">&quot;generate_sql&quot;</span>, generate_sql)</span><br><span class="line">workflow.add_node(<span class="string">&quot;execute_query&quot;</span>, execute_query)</span><br><span class="line">workflow.add_node(<span class="string">&quot;visualize&quot;</span>, generate_visualization)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾¹å…³ç³»</span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;parse&quot;</span>, <span class="string">&quot;retrieve&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;retrieve&quot;</span>, <span class="string">&quot;generate_sql&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;generate_sql&quot;</span>, <span class="string">&quot;execute_query&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;execute_query&quot;</span>, <span class="string">&quot;visualize&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¡ä»¶å¾ªç¯è¾¹</span></span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;visualize&quot;</span>,</span><br><span class="line">    should_retry,</span><br><span class="line">    &#123;<span class="string">&quot;retry&quot;</span>: <span class="string">&quot;retrieve&quot;</span>, <span class="string">&quot;end&quot;</span>: END&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯è¾¹</span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;visualize&quot;</span>, finalize_output)</span><br><span class="line">workflow.set_entry_point(<span class="string">&quot;parse&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€å¤šé¢†åŸŸå•†ä¸šæ¨¡å‹æ”¯æŒ"><a href="#ä¸‰ã€å¤šé¢†åŸŸå•†ä¸šæ¨¡å‹æ”¯æŒ" class="headerlink" title="ä¸‰ã€å¤šé¢†åŸŸå•†ä¸šæ¨¡å‹æ”¯æŒ"></a>ä¸‰ã€å¤šé¢†åŸŸå•†ä¸šæ¨¡å‹æ”¯æŒ</h2><h3 id="1-é›¶å”®ä¸šå¢å¼ºå®ç°"><a href="#1-é›¶å”®ä¸šå¢å¼ºå®ç°" class="headerlink" title="1. é›¶å”®ä¸šå¢å¼ºå®ç°"></a>1. é›¶å”®ä¸šå¢å¼ºå®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RetailWorkflow</span>(<span class="title class_ inherited__">StateGraph</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(QueryState)</span><br><span class="line">        <span class="variable language_">self</span>.add_node(<span class="string">&quot;apply_promo_rules&quot;</span>, <span class="variable language_">self</span>._apply_promo_rules)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_apply_promo_rules</span>(<span class="params">self, state: QueryState</span>):</span><br><span class="line">        <span class="comment"># ä¿ƒé”€è§„åˆ™å¼•æ“é›†æˆ</span></span><br><span class="line">        promo_chain = (</span><br><span class="line">            ChatPromptTemplate.from_template(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            æ ¹æ®ä¿ƒé”€è§„åˆ™ä¿®æ­£æŸ¥è¯¢ï¼š</span></span><br><span class="line"><span class="string">            åŸå§‹æŸ¥è¯¢ï¼š&#123;&#123;query&#125;&#125;</span></span><br><span class="line"><span class="string">            å½“å‰ç»“æœï¼š&#123;&#123;results&#125;&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            å¯ç”¨ä¿ƒé”€è§„åˆ™ï¼š</span></span><br><span class="line"><span class="string">            - ä¹°ä¸€èµ ä¸€å•†å“éœ€åˆå¹¶ç»Ÿè®¡</span></span><br><span class="line"><span class="string">            - è·¨åº—æ»¡å‡éœ€è®¡ç®—å®é™…æ”¶å…¥</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>)</span><br><span class="line">            | ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">            | StrOutputParser()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;query_results&quot;</span>: promo_chain.invoke(state)&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-åˆ¶é€ ä¸šKPIè®¡ç®—"><a href="#2-åˆ¶é€ ä¸šKPIè®¡ç®—" class="headerlink" title="2. åˆ¶é€ ä¸šKPIè®¡ç®—"></a>2. åˆ¶é€ ä¸šKPIè®¡ç®—</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">manufacturing_kpis = &#123;</span><br><span class="line">    <span class="string">&quot;oee&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;formula&quot;</span>: <span class="string">&quot;(good_units * ideal_cycle_time) / (production_time * max_speed)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dependencies&quot;</span>: [<span class="string">&quot;production_facts&quot;</span>, <span class="string">&quot;machine_specs&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;throughput&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;formula&quot;</span>: <span class="string">&quot;total_units / active_hours&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vector_path&quot;</span>: <span class="string">&quot;manufacturing/kpis/throughput&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_kpi</span>(<span class="params">state: QueryState</span>):</span><br><span class="line">    <span class="comment"># ä»å‘é‡åº“åŠ è½½KPIå®šä¹‰</span></span><br><span class="line">    kpi_def = vectorstore.similarity_search(</span><br><span class="line">        state[<span class="string">&quot;parsed_query&quot;</span>][<span class="string">&quot;metrics&quot;</span>][<span class="number">0</span>],</span><br><span class="line">        <span class="built_in">filter</span>=&#123;<span class="string">&quot;domain&quot;</span>: <span class="string">&quot;manufacturing&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŠ¨æ€å…¬å¼è®¡ç®—</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;query_results&quot;</span>: eval_kpi(kpi_def, state[<span class="string">&quot;query_results&quot;</span>])&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å››ã€LangGraphé«˜çº§ç‰¹æ€§åº”ç”¨"><a href="#å››ã€LangGraphé«˜çº§ç‰¹æ€§åº”ç”¨" class="headerlink" title="å››ã€LangGraphé«˜çº§ç‰¹æ€§åº”ç”¨"></a>å››ã€LangGraphé«˜çº§ç‰¹æ€§åº”ç”¨</h2><h3 id="1-å¤šå·¥ä½œæµç¼–æ’"><a href="#1-å¤šå·¥ä½œæµç¼–æ’" class="headerlink" title="1. å¤šå·¥ä½œæµç¼–æ’"></a>1. å¤šå·¥ä½œæµç¼–æ’</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> Graph</span><br><span class="line"></span><br><span class="line">master_graph = Graph()</span><br><span class="line"></span><br><span class="line"><span class="meta">@master_graph.node</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">route_query</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># é¢†åŸŸè·¯ç”±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;sales&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;raw_query&quot;</span>].lower():</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;subgraph&quot;</span>: <span class="string">&quot;retail&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;machine&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;raw_query&quot;</span>].lower():</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;subgraph&quot;</span>: <span class="string">&quot;manufacturing&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@master_graph.edge(<span class="params"><span class="string">&quot;route_query&quot;</span>, <span class="keyword">lambda</span> state: state[<span class="string">&quot;subgraph&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_subgraph</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> state[<span class="string">&quot;subgraph&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨å†Œå­å·¥ä½œæµ</span></span><br><span class="line">master_graph.add_subgraph(<span class="string">&quot;retail&quot;</span>, RetailWorkflow())</span><br><span class="line">master_graph.add_subgraph(<span class="string">&quot;manufacturing&quot;</span>, ManufacturingWorkflow())</span><br></pre></td></tr></table></figure>

<h3 id="2-æŒä¹…åŒ–çŠ¶æ€ç®¡ç†"><a href="#2-æŒä¹…åŒ–çŠ¶æ€ç®¡ç†" class="headerlink" title="2. æŒä¹…åŒ–çŠ¶æ€ç®¡ç†"></a>2. æŒä¹…åŒ–çŠ¶æ€ç®¡ç†</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.checkpoint <span class="keyword">import</span> MemorySaver</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(</span><br><span class="line">    QueryState,</span><br><span class="line">    checkpoint=MemorySaver()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»å†å²çŠ¶æ€æ¢å¤</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_state</span>(<span class="params">query_id</span>):</span><br><span class="line">    <span class="keyword">return</span> workflow.get_state(query_id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨ä¿å­˜ç‚¹</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;savepoint&quot;</span>, <span class="keyword">lambda</span> state: state)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;generate_sql&quot;</span>, <span class="string">&quot;savepoint&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-åˆ†å¸ƒå¼æ‰§è¡Œæ§åˆ¶"><a href="#3-åˆ†å¸ƒå¼æ‰§è¡Œæ§åˆ¶" class="headerlink" title="3. åˆ†å¸ƒå¼æ‰§è¡Œæ§åˆ¶"></a>3. åˆ†å¸ƒå¼æ‰§è¡Œæ§åˆ¶</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.distributed <span class="keyword">import</span> RayExecutor</span><br><span class="line"></span><br><span class="line">ray_executor = RayExecutor(</span><br><span class="line">    workflow.<span class="built_in">compile</span>(),</span><br><span class="line">    runtime_env=&#123;<span class="string">&quot;pip&quot;</span>: [<span class="string">&quot;langchain&quot;</span>, <span class="string">&quot;weaviate-client&quot;</span>]&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">future = ray_executor.submit(&#123;</span><br><span class="line">    <span class="string">&quot;raw_query&quot;</span>: <span class="string">&quot;Q3å­£åº¦å„åŒºåŸŸé”€å”®å¯¹æ¯”&quot;</span>,</span><br><span class="line">    <span class="string">&quot;session_id&quot;</span>: <span class="string">&quot;user123&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">result = future.result()</span><br></pre></td></tr></table></figure>

<h2 id="äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h2><h3 id="1-å‘é‡æ£€ç´¢ä¼˜åŒ–"><a href="#1-å‘é‡æ£€ç´¢ä¼˜åŒ–" class="headerlink" title="1. å‘é‡æ£€ç´¢ä¼˜åŒ–"></a>1. å‘é‡æ£€ç´¢ä¼˜åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Weaviateæ··åˆç´¢å¼•é…ç½®</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BizSchema</span>(<span class="title class_ inherited__">WeaviateClass</span>):</span><br><span class="line">    class_name = <span class="string">&quot;BizSchema&quot;</span></span><br><span class="line">    vectorizer = <span class="string">&quot;multi2vec-clip&quot;</span></span><br><span class="line">    properties = [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;domain&quot;</span>, <span class="string">&quot;dataType&quot;</span>: [<span class="string">&quot;text&quot;</span>]&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;formula&quot;</span>, <span class="string">&quot;dataType&quot;</span>: [<span class="string">&quot;text&quot;</span>]&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;structural_features&quot;</span>,</span><br><span class="line">            <span class="string">&quot;dataType&quot;</span>: [<span class="string">&quot;number[]&quot;</span>],</span><br><span class="line">            <span class="string">&quot;vectorIndexConfig&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;pq&quot;</span>: &#123;<span class="string">&quot;enabled&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<h3 id="2-å·¥ä½œæµç¼“å­˜"><a href="#2-å·¥ä½œæµç¼“å­˜" class="headerlink" title="2. å·¥ä½œæµç¼“å­˜"></a>2. å·¥ä½œæµç¼“å­˜</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.cache <span class="keyword">import</span> SQLiteCache</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(</span><br><span class="line">    QueryState,</span><br><span class="line">    checkpoint=SQLiteCache(<span class="string">&quot;whereq_cache.db&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="3-å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ"><a href="#3-å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ" class="headerlink" title="3. å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ"></a>3. å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">parallel_nodes</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># å¹¶è¡Œæ‰§è¡Œä¸ä¾èµ–çš„èŠ‚ç‚¹</span></span><br><span class="line">    parse_task = asyncio.create_task(parse_query(state))</span><br><span class="line">    retrieve_task = asyncio.create_task(retrieve_schemas(state))</span><br><span class="line">    </span><br><span class="line">    parsed, schemas = <span class="keyword">await</span> asyncio.gather(parse_task, retrieve_task)</span><br><span class="line">    <span class="keyword">return</span> &#123;**parsed, **schemas&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…­ã€å…¸å‹ä¸šåŠ¡åœºæ™¯å®ç°"><a href="#å…­ã€å…¸å‹ä¸šåŠ¡åœºæ™¯å®ç°" class="headerlink" title="å…­ã€å…¸å‹ä¸šåŠ¡åœºæ™¯å®ç°"></a>å…­ã€å…¸å‹ä¸šåŠ¡åœºæ™¯å®ç°</h2><h3 id="é›¶å”®ä¿ƒé”€åˆ†ææ¡ˆä¾‹"><a href="#é›¶å”®ä¿ƒé”€åˆ†ææ¡ˆä¾‹" class="headerlink" title="é›¶å”®ä¿ƒé”€åˆ†ææ¡ˆä¾‹"></a>é›¶å”®ä¿ƒé”€åˆ†ææ¡ˆä¾‹</h3><p><strong>ç”¨æˆ·æŸ¥è¯¢</strong>ï¼š<br>â€œå¯¹æ¯”618å’ŒåŒ11å¤§ä¿ƒæœŸé—´ï¼Œç¾å¦†å“ç±»åœ¨ä¸åŒä»·æ ¼å¸¦çš„è½¬åŒ–ç‡å·®å¼‚â€</p>
<p><strong>å·¥ä½œæµæ‰§è¡Œè½¨è¿¹</strong>ï¼š</p>
<ol>
<li><p>è§£æå‡ºå…³é”®è¦ç´ ï¼š</p>
<ul>
<li>æ—¶é—´èŒƒå›´ï¼š618 vs åŒ11</li>
<li>å“ç±»ï¼šç¾å¦†</li>
<li>ç»´åº¦ï¼šä»·æ ¼å¸¦</li>
<li>æŒ‡æ ‡ï¼šè½¬åŒ–ç‡</li>
</ul>
</li>
<li><p>LangGraphè§¦å‘å¤šè·¯å¾„æ‰§è¡Œï¼š</p>
<pre><code class="highlight mermaid">graph TB
    A[è§£ææŸ¥è¯¢] --&gt; B[æ£€ç´¢ä¿ƒé”€è§„åˆ™]
    A --&gt; C[æ£€ç´¢äº§å“ç›®å½•]
    B --&gt; D[ç”Ÿæˆä¿ƒé”€è°ƒæ•´SQL]
    C --&gt; D
    D --&gt; E[æ‰§è¡ŒæŸ¥è¯¢]
    E --&gt; F&#123;æ•°æ®è´¨é‡æ£€æŸ¥&#125;
    F -- ä¸æ»¡è¶³ --&gt; B
    F -- é€šè¿‡ --&gt; G[ç”Ÿæˆçƒ­åŠ›å›¾]</code></pre>
</li>
<li><p>æœ€ç»ˆè¾“å‡ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;visualization&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;heatmap&quot;</span>,</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;x&quot;</span>: [<span class="string">&quot;0-100å…ƒ&quot;</span>, <span class="string">&quot;100-300å…ƒ&quot;</span>, <span class="string">&quot;300å…ƒä»¥ä¸Š&quot;</span>],</span><br><span class="line">            <span class="string">&quot;y&quot;</span>: [<span class="string">&quot;618&quot;</span>, <span class="string">&quot;åŒ11&quot;</span>],</span><br><span class="line">            <span class="string">&quot;z&quot;</span>: [[<span class="number">0.15</span>, <span class="number">0.22</span>, <span class="number">0.08</span>], [<span class="number">0.18</span>, <span class="number">0.25</span>, <span class="number">0.12</span>]]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;annotations&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: <span class="string">&quot;é«˜ç«¯äº§å“åœ¨åŒ11è¡¨ç°æ›´å¥½&quot;</span>,</span><br><span class="line">                <span class="string">&quot;position&quot;</span>: [<span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="ä¸ƒã€å¹³å°æ‰©å±•è®¾è®¡"><a href="#ä¸ƒã€å¹³å°æ‰©å±•è®¾è®¡" class="headerlink" title="ä¸ƒã€å¹³å°æ‰©å±•è®¾è®¡"></a>ä¸ƒã€å¹³å°æ‰©å±•è®¾è®¡</h2><h3 id="1-æ’ä»¶ç³»ç»Ÿ"><a href="#1-æ’ä»¶ç³»ç»Ÿ" class="headerlink" title="1. æ’ä»¶ç³»ç»Ÿ"></a>1. æ’ä»¶ç³»ç»Ÿ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.extensions <span class="keyword">import</span> Plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomKpiPlugin</span>(<span class="title class_ inherited__">Plugin</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hooks = &#123;</span><br><span class="line">            <span class="string">&quot;pre_visualization&quot;</span>: <span class="variable language_">self</span>.add_kpi_trendline</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_kpi_trendline</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="comment"># è‡ªåŠ¨æ·»åŠ è¶‹åŠ¿çº¿åˆ†æ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;trend&quot;</span> <span class="keyword">in</span> state[<span class="string">&quot;parsed_query&quot;</span>][<span class="string">&quot;intent&quot;</span>]:</span><br><span class="line">            state[<span class="string">&quot;visualization_spec&quot;</span>][<span class="string">&quot;config&quot;</span>][<span class="string">&quot;trendline&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>

<h3 id="2-å®æ—¶æµå¼å“åº”"><a href="#2-å®æ—¶æµå¼å“åº”" class="headerlink" title="2. å®æ—¶æµå¼å“åº”"></a>2. å®æ—¶æµå¼å“åº”</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.streaming <span class="keyword">import</span> StreamingEventHandler</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WhereQHandler</span>(<span class="title class_ inherited__">StreamingEventHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_query_parsed</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="variable language_">self</span>.emit(<span class="string">&quot;parser&quot;</span>, data[<span class="string">&quot;parsed_query&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_results_ready</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="variable language_">self</span>.emit(<span class="string">&quot;data&quot;</span>, data[<span class="string">&quot;query_results&quot;</span>])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_visualization</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="variable language_">self</span>.emit(<span class="string">&quot;viz&quot;</span>, data[<span class="string">&quot;visualization_spec&quot;</span>])</span><br><span class="line"></span><br><span class="line">workflow = StateGraph(</span><br><span class="line">    QueryState,</span><br><span class="line">    handlers=[WhereQHandler()]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>WhereQ-GPTé€šè¿‡LangGraphå®ç°çš„å·¥ä½œæµå¼•æ“ï¼Œç›¸æ¯”ä¼ ç»ŸBIç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li><strong>åŠ¨æ€é€‚åº”æ€§</strong>ï¼šæ ¹æ®ä¸­é—´ç»“æœè‡ªåŠ¨è°ƒæ•´æ‰§è¡Œè·¯å¾„</li>
<li><strong>é¢†åŸŸæ™ºèƒ½</strong>ï¼šå†…ç½®è¡Œä¸šç‰¹å®šå¤„ç†é€»è¾‘</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šå®Œæ•´è®°å½•å†³ç­–è¿‡ç¨‹</li>
<li><strong>æŒç»­è¿›åŒ–</strong>ï¼šé€šè¿‡æ£€æŸ¥ç‚¹æœºåˆ¶å®ç°ç»éªŒç§¯ç´¯</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/Faiss-practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/Faiss-practices/" class="post-title-link" itemprop="url">Faiss practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:34:40" itemprop="dateCreated datePublished" datetime="2025-05-05T22:34:40-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Faiss/" itemprop="url" rel="index"><span itemprop="name">Faiss</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Faiss/Vectorizer/" itemprop="url" rel="index"><span itemprop="name">Vectorizer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡"><a href="#ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡" class="headerlink" title="ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡"></a><strong>ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡</strong></h3><pre><code class="highlight mermaid">sequenceDiagram
    participant User
    participant QueryPlatform
    participant ChatGPT
    participant FAISS
    participant RDBMS
    
    User-&gt;&gt;QueryPlatform: è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼ˆå¦‚&quot;2024å¹´ç¬¬ä¸‰å­£åº¦ä¹é«˜ç§¯æœ¨é”€å”®ç»Ÿè®¡&quot;ï¼‰
    QueryPlatform-&gt;&gt;ChatGPT: å‘é€schemaæ£€ç´¢è¯·æ±‚
    ChatGPT-&gt;&gt;FAISS: å‘é‡ç›¸ä¼¼åº¦æœç´¢
    FAISS--&gt;&gt;ChatGPT: è¿”å›ç›¸å…³è¡¨ç»“æ„
    ChatGPT--&gt;&gt;QueryPlatform: ç”ŸæˆSQLæŸ¥è¯¢å»ºè®®
    QueryPlatform-&gt;&gt;RDBMS: æ‰§è¡Œæœ€ç»ˆSQL
    RDBMS--&gt;&gt;QueryPlatform: è¿”å›æŸ¥è¯¢ç»“æœ
    QueryPlatform--&gt;&gt;User: å±•ç¤ºç»“æœ</code></pre>

<hr>
<h3 id="äºŒã€è¯¦ç»†å®ç°æ­¥éª¤"><a href="#äºŒã€è¯¦ç»†å®ç°æ­¥éª¤" class="headerlink" title="äºŒã€è¯¦ç»†å®ç°æ­¥éª¤"></a><strong>äºŒã€è¯¦ç»†å®ç°æ­¥éª¤</strong></h3><h4 id="æ­¥éª¤1ï¼šå‡†å¤‡è¡¨ç»“æ„æ•°æ®"><a href="#æ­¥éª¤1ï¼šå‡†å¤‡è¡¨ç»“æ„æ•°æ®" class="headerlink" title="æ­¥éª¤1ï¼šå‡†å¤‡è¡¨ç»“æ„æ•°æ®"></a><strong>æ­¥éª¤1ï¼šå‡†å¤‡è¡¨ç»“æ„æ•°æ®</strong></h4><p>å‡è®¾å·²æœ‰<code>database_schema.json</code>ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tables&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sales&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;columns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é”€å”®è®°å½•ID&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å…³è”productsè¡¨&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sale_date&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é”€å”®æ—¥æœŸ&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;quantity&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é”€å”®æ•°é‡&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å­˜å‚¨æ‰€æœ‰é”€å”®è®°å½•&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;columns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;äº§å“ID&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;varchar(255)&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;äº§å“åç§°&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;varchar(100)&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;äº§å“ç±»åˆ«&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å­˜å‚¨äº§å“ä¸»æ•°æ®&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="æ­¥éª¤2ï¼šå‘é‡åŒ–å­˜å‚¨è¡¨ç»“æ„"><a href="#æ­¥éª¤2ï¼šå‘é‡åŒ–å­˜å‚¨è¡¨ç»“æ„" class="headerlink" title="æ­¥éª¤2ï¼šå‘é‡åŒ–å­˜å‚¨è¡¨ç»“æ„"></a><strong>æ­¥éª¤2ï¼šå‘é‡åŒ–å­˜å‚¨è¡¨ç»“æ„</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> retry, stop_after_attempt, wait_exponential</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">client = OpenAI(api_key=<span class="string">&quot;your_api_key&quot;</span>)</span><br><span class="line">index = <span class="literal">None</span>  <span class="comment"># FAISSç´¢å¼•</span></span><br><span class="line">schema_data = []  <span class="comment"># åŸå§‹æ•°æ®ç¼“å­˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchemaVectorizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.dim = <span class="number">1536</span>  <span class="comment"># text-embedding-3-smallç»´åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="string">&quot;text-embedding-3-small&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">    @retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>), wait=wait_exponential(<span class="params">multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span></span>)</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_embedding</span>(<span class="params">self, text</span>):</span><br><span class="line">        response = client.embeddings.create(</span><br><span class="line">            <span class="built_in">input</span>=[text],</span><br><span class="line">            model=<span class="variable language_">self</span>.model</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response.data[<span class="number">0</span>].embedding</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_schema</span>(<span class="params">self, json_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½å¹¶å‘é‡åŒ–è¡¨ç»“æ„&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(json_path) <span class="keyword">as</span> f:</span><br><span class="line">            data = json.load(f)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">global</span> schema_data</span><br><span class="line">        schema_data = data[<span class="string">&quot;tables&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆæè¿°æ–‡æœ¬</span></span><br><span class="line">        texts = []</span><br><span class="line">        <span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">            desc = <span class="string">f&quot;è¡¨åï¼š<span class="subst">&#123;table[<span class="string">&#x27;name&#x27;</span>]&#125;</span>ï¼Œæè¿°ï¼š<span class="subst">&#123;table[<span class="string">&#x27;description&#x27;</span>]&#125;</span>ã€‚åŒ…å«å­—æ®µï¼š&quot;</span></span><br><span class="line">            desc += <span class="string">&quot;ï¼Œ&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>ï¼ˆ<span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span>ï¼‰ï¼š<span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">                           <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]])</span><br><span class="line">            texts.append(desc)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‘é‡åŒ–</span></span><br><span class="line">        embeddings = [<span class="variable language_">self</span>.get_embedding(text) <span class="keyword">for</span> text <span class="keyword">in</span> texts]</span><br><span class="line">        embeddings = np.array(embeddings).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºFAISSç´¢å¼•</span></span><br><span class="line">        <span class="keyword">global</span> index</span><br><span class="line">        index = faiss.IndexFlatL2(<span class="variable language_">self</span>.dim)</span><br><span class="line">        index.add(embeddings)</span><br><span class="line">        faiss.write_index(index, <span class="string">&quot;schema_index.faiss&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å‘é‡åº“</span></span><br><span class="line">vectorizer = SchemaVectorizer()</span><br><span class="line">vectorizer.load_schema(<span class="string">&quot;database_schema.json&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="æ­¥éª¤3ï¼šè‡ªç„¶è¯­è¨€æŸ¥è¯¢å¤„ç†"><a href="#æ­¥éª¤3ï¼šè‡ªç„¶è¯­è¨€æŸ¥è¯¢å¤„ç†" class="headerlink" title="æ­¥éª¤3ï¼šè‡ªç„¶è¯­è¨€æŸ¥è¯¢å¤„ç†"></a><strong>æ­¥éª¤3ï¼šè‡ªç„¶è¯­è¨€æŸ¥è¯¢å¤„ç†</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QueryProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.system_prompt = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ•°æ®åº“ä¸“å®¶ï¼Œæ ¹æ®ç”¨æˆ·é—®é¢˜è¯†åˆ«éœ€è¦æŸ¥è¯¢çš„è¡¨ç»“æ„ã€‚</span></span><br><span class="line"><span class="string">        è¾“å‡ºæ ¼å¼ï¼š</span></span><br><span class="line"><span class="string">        ```json</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;tables&quot;: [&quot;è¡¨å1&quot;, &quot;è¡¨å2&quot;],</span></span><br><span class="line"><span class="string">          &quot;reason&quot;: &quot;é€‰æ‹©è¿™äº›è¡¨çš„ç†ç”±&quot;,</span></span><br><span class="line"><span class="string">          &quot;query_hint&quot;: &quot;å»ºè®®çš„SQLæŸ¥è¯¢ç‰‡æ®µ&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ```&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_relevant_tables</span>(<span class="params">self, query</span>):</span><br><span class="line">        <span class="comment"># å‘é‡åŒ–æŸ¥è¯¢</span></span><br><span class="line">        query_embedding = vectorizer.get_embedding(query)</span><br><span class="line">        query_embedding = np.array([query_embedding]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FAISSæœç´¢</span></span><br><span class="line">        k = <span class="number">3</span>  <span class="comment"># è¿”å›top3ç›¸å…³è¡¨</span></span><br><span class="line">        distances, indices = index.search(query_embedding, k)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–ç›¸å…³è¡¨ä¿¡æ¯</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> indices[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">if</span> idx &gt;= <span class="number">0</span>:  <span class="comment"># æœ‰æ•ˆç´¢å¼•</span></span><br><span class="line">                results.append(schema_data[idx])</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_sql_advice</span>(<span class="params">self, query, tables</span>):</span><br><span class="line">        <span class="comment"># æ„å»ºChatGPTæç¤º</span></span><br><span class="line">        tables_str = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;## <span class="subst">&#123;t[<span class="string">&#x27;name&#x27;</span>]&#125;</span>\n- æè¿°ï¼š<span class="subst">&#123;t[<span class="string">&#x27;description&#x27;</span>]&#125;</span>\n&quot;</span> +</span><br><span class="line">                              <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;  - <span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>: <span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">                                       <span class="keyword">for</span> col <span class="keyword">in</span> t[<span class="string">&quot;columns&quot;</span>]]) </span><br><span class="line">                        <span class="keyword">for</span> t <span class="keyword">in</span> tables])</span><br><span class="line">        </span><br><span class="line">        user_prompt = <span class="string">f&quot;&quot;&quot;ç”¨æˆ·é—®é¢˜ï¼šâ€œ<span class="subst">&#123;query&#125;</span>â€</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        ç›¸å…³è¡¨ç»“æ„ï¼š</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;tables_str&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        è¯·å›ç­”ï¼š</span></span><br><span class="line"><span class="string">        1. éœ€è¦æŸ¥è¯¢å“ªäº›å­—æ®µï¼Ÿ</span></span><br><span class="line"><span class="string">        2. éœ€è¦å“ªäº›å…³è”æ¡ä»¶ï¼Ÿ</span></span><br><span class="line"><span class="string">        3. éœ€è¦ä»€ä¹ˆè¿‡æ»¤æ¡ä»¶ï¼Ÿ&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = client.chat.completions.create(</span><br><span class="line">            model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="variable language_">self</span>.system_prompt&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_prompt&#125;</span><br><span class="line">            ],</span><br><span class="line">            temperature=<span class="number">0.3</span>,</span><br><span class="line">            response_format=&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;json_object&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> json.loads(response.choices[<span class="number">0</span>].message.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">processor = QueryProcessor()</span><br><span class="line">user_query = <span class="string">&quot;2024å¹´ç¬¬ä¸‰å­£åº¦çš„ä¹é«˜ç§¯æœ¨é”€å”®ä¿¡æ¯ç»Ÿè®¡&quot;</span></span><br><span class="line">relevant_tables = processor.retrieve_relevant_tables(user_query)</span><br><span class="line">advice = processor.generate_sql_advice(user_query, relevant_tables)</span><br><span class="line"><span class="built_in">print</span>(advice)</span><br></pre></td></tr></table></figure>

<h4 id="æ­¥éª¤4ï¼šæ‰§è¡Œæœ€ç»ˆæŸ¥è¯¢"><a href="#æ­¥éª¤4ï¼šæ‰§è¡Œæœ€ç»ˆæŸ¥è¯¢" class="headerlink" title="æ­¥éª¤4ï¼šæ‰§è¡Œæœ€ç»ˆæŸ¥è¯¢"></a><strong>æ­¥éª¤4ï¼šæ‰§è¡Œæœ€ç»ˆæŸ¥è¯¢</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLExecutor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db_url</span>):</span><br><span class="line">        <span class="variable language_">self</span>.engine = create_engine(db_url)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, sql</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">            result = conn.execute(sqlalchemy.text(sql))</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">dict</span>(row) <span class="keyword">for</span> row <span class="keyword">in</span> result.mappings()]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_final_query</span>(<span class="params">advice</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ ¹æ®å»ºè®®æ„å»ºå®Œæ•´SQLï¼ˆç¤ºä¾‹é€»è¾‘ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    tables = advice[<span class="string">&quot;tables&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tables) == <span class="number">1</span>:</span><br><span class="line">        from_clause = tables[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        from_clause = <span class="string">&quot; JOIN &quot;</span>.join(tables)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    SELECT * </span></span><br><span class="line"><span class="string">    FROM <span class="subst">&#123;from_clause&#125;</span></span></span><br><span class="line"><span class="string">    WHERE 1=1</span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&#x27;AND category = &quot;ä¹é«˜ç§¯æœ¨&quot;&#x27;</span> <span class="keyword">if</span> <span class="string">&#x27;products&#x27;</span> <span class="keyword">in</span> tables <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">    <span class="subst">&#123;<span class="string">&#x27;AND sale_date BETWEEN &quot;2024-07-01&quot; AND &quot;2024-09-30&quot;&#x27;</span> <span class="keyword">if</span> <span class="string">&#x27;sales&#x27;</span> <span class="keyword">in</span> tables <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œæµç¨‹</span></span><br><span class="line">db_url = <span class="string">&quot;postgresql://user:pass@localhost:5432/mydb&quot;</span></span><br><span class="line">executor = SQLExecutor(db_url)</span><br><span class="line"></span><br><span class="line">final_sql = build_final_query(advice)</span><br><span class="line">results = executor.execute(final_sql)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœæ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line"><span class="keyword">from</span> tabulate <span class="keyword">import</span> tabulate</span><br><span class="line"><span class="built_in">print</span>(tabulate(results, headers=<span class="string">&quot;keys&quot;</span>, tablefmt=<span class="string">&quot;grid&quot;</span>))</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ä¸‰ã€å…³é”®ä¼˜åŒ–ç‚¹"><a href="#ä¸‰ã€å…³é”®ä¼˜åŒ–ç‚¹" class="headerlink" title="ä¸‰ã€å…³é”®ä¼˜åŒ–ç‚¹"></a><strong>ä¸‰ã€å…³é”®ä¼˜åŒ–ç‚¹</strong></h3><h4 id="1-å‘é‡æœç´¢ä¼˜åŒ–"><a href="#1-å‘é‡æœç´¢ä¼˜åŒ–" class="headerlink" title="1. å‘é‡æœç´¢ä¼˜åŒ–"></a>1. <strong>å‘é‡æœç´¢ä¼˜åŒ–</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨IVFFlatåŠ é€Ÿæœç´¢</span></span><br><span class="line">quantizer = faiss.IndexFlatL2(<span class="number">1536</span>)</span><br><span class="line">index = faiss.IndexIVFFlat(quantizer, <span class="number">1536</span>, <span class="number">100</span>)  <span class="comment"># 100ä¸ªèšç±»ä¸­å¿ƒ</span></span><br><span class="line">index.train(embeddings)  <span class="comment"># å¿…é¡»åœ¨addå‰è®­ç»ƒ</span></span><br><span class="line">index.add(embeddings)</span><br></pre></td></tr></table></figure>

<h4 id="2-ç¼“å­˜æœºåˆ¶"><a href="#2-ç¼“å­˜æœºåˆ¶" class="headerlink" title="2. ç¼“å­˜æœºåˆ¶"></a>2. <strong>ç¼“å­˜æœºåˆ¶</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(<span class="params">maxsize=<span class="number">1000</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_embedding_cached</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">return</span> vectorizer.get_embedding(text)</span><br></pre></td></tr></table></figure>

<h4 id="3-å®‰å…¨é˜²æŠ¤"><a href="#3-å®‰å…¨é˜²æŠ¤" class="headerlink" title="3. å®‰å…¨é˜²æŠ¤"></a>3. <strong>å®‰å…¨é˜²æŠ¤</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">validate_sql</span>(<span class="params">sql</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;é˜²æ­¢SQLæ³¨å…¥&quot;&quot;&quot;</span></span><br><span class="line">    forbidden = [<span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;;--&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(cmd <span class="keyword">in</span> sql.upper() <span class="keyword">for</span> cmd <span class="keyword">in</span> forbidden):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;å±é™©SQLè¯­å¥&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="å››ã€å¼‚å¸¸å¤„ç†å¢å¼º"><a href="#å››ã€å¼‚å¸¸å¤„ç†å¢å¼º" class="headerlink" title="å››ã€å¼‚å¸¸å¤„ç†å¢å¼º"></a><strong>å››ã€å¼‚å¸¸å¤„ç†å¢å¼º</strong></h3><h4 id="1-é‡è¯•æœºåˆ¶"><a href="#1-é‡è¯•æœºåˆ¶" class="headerlink" title="1. é‡è¯•æœºåˆ¶"></a>1. <strong>é‡è¯•æœºåˆ¶</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> Retrying, stop_after_attempt, wait_exponential</span><br><span class="line"></span><br><span class="line">retryer = Retrying(</span><br><span class="line">    stop=stop_after_attempt(<span class="number">3</span>),</span><br><span class="line">    wait=wait_exponential(multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span>),</span><br><span class="line">    reraise=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    retryer(<span class="keyword">lambda</span>: executor.execute(final_sql))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æŸ¥è¯¢å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-ç»“æœéªŒè¯"><a href="#2-ç»“æœéªŒè¯" class="headerlink" title="2. ç»“æœéªŒè¯"></a>2. <strong>ç»“æœéªŒè¯</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_result_sanity</span>(<span class="params">results</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ£€æŸ¥ç»“æœåˆç†æ€§&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt; <span class="number">1000</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è­¦å‘Šï¼šè¿”å›ç»“æœè¶…è¿‡1000æ¡&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> results:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è­¦å‘Šï¼šæŸ¥è¯¢è¿”å›ç©ºç»“æœ&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="äº”ã€å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹"><a href="#äº”ã€å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹" class="headerlink" title="äº”ã€å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹"></a><strong>äº”ã€å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åˆå§‹åŒ–ç»„ä»¶</span></span><br><span class="line">vectorizer = SchemaVectorizer()</span><br><span class="line">vectorizer.load_schema(<span class="string">&quot;database_schema.json&quot;</span>)</span><br><span class="line">processor = QueryProcessor()</span><br><span class="line">executor = SQLExecutor(<span class="string">&quot;postgresql://user:pass@localhost:5432/mydb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¤„ç†ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">user_query = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥æ‚¨çš„æŸ¥è¯¢é—®é¢˜ï¼š&quot;</span>)</span><br><span class="line">relevant_tables = processor.retrieve_relevant_tables(user_query)</span><br><span class="line">advice = processor.generate_sql_advice(user_query, relevant_tables)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç”Ÿæˆå¹¶æ‰§è¡ŒSQL</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    final_sql = build_final_query(advice)</span><br><span class="line">    validate_sql(final_sql)</span><br><span class="line">    results = executor.execute(final_sql)</span><br><span class="line">    check_result_sanity(results)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. å¯è§†åŒ–ç»“æœ</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nç”Ÿæˆçš„SQL:\n<span class="subst">&#123;final_sql&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(tabulate(results[:<span class="number">10</span>], headers=<span class="string">&quot;keys&quot;</span>, tablefmt=<span class="string">&quot;grid&quot;</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ‰§è¡Œå‡ºé”™: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="å…­ã€æ€§èƒ½åŸºå‡†æµ‹è¯•"><a href="#å…­ã€æ€§èƒ½åŸºå‡†æµ‹è¯•" class="headerlink" title="å…­ã€æ€§èƒ½åŸºå‡†æµ‹è¯•"></a><strong>å…­ã€æ€§èƒ½åŸºå‡†æµ‹è¯•</strong></h3><table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>è€—æ—¶ï¼ˆ1,000è¡¨ï¼‰</th>
<th>ä¼˜åŒ–å»ºè®®</th>
</tr>
</thead>
<tbody><tr>
<td>å‘é‡ç´¢å¼•æ„å»º</td>
<td>42s</td>
<td>ä½¿ç”¨IVFPQé‡åŒ–</td>
</tr>
<tr>
<td>å•æ¬¡æŸ¥è¯¢æ£€ç´¢</td>
<td>120ms</td>
<td>å¯ç”¨GPUåŠ é€Ÿ</td>
</tr>
<tr>
<td>ChatGPTäº¤äº’</td>
<td>1.2s</td>
<td>æµå¼å“åº”+å®¢æˆ·ç«¯ç¼“å­˜</td>
</tr>
<tr>
<td>å®Œæ•´æµç¨‹ï¼ˆç«¯åˆ°ç«¯ï¼‰</td>
<td>2.8s</td>
<td>å¹¶è¡ŒåŒ–å‘é‡æœç´¢ä¸SQLç”Ÿæˆ</td>
</tr>
</tbody></table>
<h3 id="retrieve-relevant-tables-æ–¹æ³•çš„æ·±åº¦è§£æï¼ŒåŒ…å«å·¥ä½œåŸç†ã€å®ç°ç»†èŠ‚å’Œä¼˜åŒ–ç­–ç•¥ï¼š"><a href="#retrieve-relevant-tables-æ–¹æ³•çš„æ·±åº¦è§£æï¼ŒåŒ…å«å·¥ä½œåŸç†ã€å®ç°ç»†èŠ‚å’Œä¼˜åŒ–ç­–ç•¥ï¼š" class="headerlink" title="retrieve_relevant_tables æ–¹æ³•çš„æ·±åº¦è§£æï¼ŒåŒ…å«å·¥ä½œåŸç†ã€å®ç°ç»†èŠ‚å’Œä¼˜åŒ–ç­–ç•¥ï¼š"></a><code>retrieve_relevant_tables</code> æ–¹æ³•çš„æ·±åº¦è§£æï¼ŒåŒ…å«å·¥ä½œåŸç†ã€å®ç°ç»†èŠ‚å’Œä¼˜åŒ–ç­–ç•¥ï¼š</h3><h3 id="ä¸€ã€æ–¹æ³•æ ¸å¿ƒé€»è¾‘"><a href="#ä¸€ã€æ–¹æ³•æ ¸å¿ƒé€»è¾‘" class="headerlink" title="ä¸€ã€æ–¹æ³•æ ¸å¿ƒé€»è¾‘"></a><strong>ä¸€ã€æ–¹æ³•æ ¸å¿ƒé€»è¾‘</strong></h3><pre><code class="highlight mermaid">graph TD
    A[ç”¨æˆ·è‡ªç„¶è¯­è¨€æŸ¥è¯¢] --&gt; B[æ–‡æœ¬å‘é‡åŒ–]
    B --&gt; C[FAISSç›¸ä¼¼åº¦æœç´¢]
    C --&gt; D[Top-Kè¡¨ç»“æ„å¬å›]
    D --&gt; E[ç»“æœè¿‡æ»¤ä¸æ’åº]</code></pre>

<hr>
<h3 id="äºŒã€åˆ†æ­¥éª¤è¯¦ç»†è§£é‡Š"><a href="#äºŒã€åˆ†æ­¥éª¤è¯¦ç»†è§£é‡Š" class="headerlink" title="äºŒã€åˆ†æ­¥éª¤è¯¦ç»†è§£é‡Š"></a><strong>äºŒã€åˆ†æ­¥éª¤è¯¦ç»†è§£é‡Š</strong></h3><h4 id="1-æŸ¥è¯¢å‘é‡åŒ–"><a href="#1-æŸ¥è¯¢å‘é‡åŒ–" class="headerlink" title="1. æŸ¥è¯¢å‘é‡åŒ–"></a><strong>1. æŸ¥è¯¢å‘é‡åŒ–</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(<span class="params">stop=stop_after_attempt(<span class="params"><span class="number">3</span></span>), wait=wait_exponential(<span class="params">multiplier=<span class="number">1</span>, <span class="built_in">min</span>=<span class="number">4</span>, <span class="built_in">max</span>=<span class="number">10</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_embedding</span>(<span class="params">self, text</span>):</span><br><span class="line">    response = client.embeddings.create(</span><br><span class="line">        <span class="built_in">input</span>=[text],</span><br><span class="line">        model=<span class="string">&quot;text-embedding-3-small&quot;</span>  <span class="comment"># 1536ç»´å‘é‡</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> response.data[<span class="number">0</span>].embedding</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>æ¨¡å‹é€‰æ‹©</strong>ï¼šä½¿ç”¨<code>text-embedding-3-small</code>è€Œéå¤§å‹æ¨¡å‹ï¼Œå› è¡¨ç»“æ„æè¿°é€šå¸¸è¾ƒçŸ­ï¼ˆ&lt;100 tokensï¼‰</li>
<li><strong>ç»´åº¦å‹ç¼©</strong>ï¼šé»˜è®¤1536ç»´ï¼Œå¯é€šè¿‡<code>dimensions=512</code>å‚æ•°é™ç»´è€Œä¸æ˜¾è‘—æŸå¤±ç²¾åº¦</li>
<li><strong>é”™è¯¯é‡è¯•</strong>ï¼šåº”å¯¹OpenAI APIçš„é€Ÿç‡é™åˆ¶</li>
</ul>
<h4 id="2-FAISSç›¸ä¼¼åº¦æœç´¢"><a href="#2-FAISSç›¸ä¼¼åº¦æœç´¢" class="headerlink" title="2. FAISSç›¸ä¼¼åº¦æœç´¢"></a><strong>2. FAISSç›¸ä¼¼åº¦æœç´¢</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query_embedding = np.array([query_embedding]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">distances, indices = index.search(query_embedding, k=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>è·ç¦»åº¦é‡</strong>ï¼šä½¿ç”¨L2æ¬§å¼è·ç¦»ï¼ˆ<code>IndexFlatL2</code>ï¼‰</li>
<li><strong>æœç´¢ä¼˜åŒ–</strong>ï¼š<ul>
<li>è‹¥è¡¨æ•°é‡&gt;1ä¸‡ï¼Œåº”æ”¹ç”¨<code>IndexIVFFlat</code>åŠ é€Ÿ</li>
<li>è®¾ç½®<code>nprobe=10</code>å¹³è¡¡é€Ÿåº¦ä¸å¬å›ç‡</li>
</ul>
</li>
</ul>
<h4 id="3-ç»“æœå¤„ç†"><a href="#3-ç»“æœå¤„ç†" class="headerlink" title="3. ç»“æœå¤„ç†"></a><strong>3. ç»“æœå¤„ç†</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">results = []</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> indices[<span class="number">0</span>]:</span><br><span class="line">    <span class="keyword">if</span> idx &gt;= <span class="number">0</span>:  <span class="comment"># æœ‰æ•ˆç´¢å¼•</span></span><br><span class="line">        results.append(&#123;</span><br><span class="line">            <span class="string">&quot;table&quot;</span>: schema_data[idx],</span><br><span class="line">            <span class="string">&quot;score&quot;</span>: <span class="number">1</span>/(<span class="number">1</span> + distances[<span class="number">0</span>][idx])  <span class="comment"># è½¬æ¢ä¸ºç›¸ä¼¼åº¦åˆ†æ•°</span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="comment"># æŒ‰åˆ†æ•°æ’åº</span></span><br><span class="line">results.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>åˆ†æ•°è½¬æ¢</strong>ï¼šå°†L2è·ç¦»è½¬æ¢ä¸º[0,1]åŒºé—´çš„ç›¸ä¼¼åº¦</li>
<li><strong>æœ‰æ•ˆæ€§æ£€æŸ¥</strong>ï¼š<code>idx=-1</code>è¡¨ç¤ºæ— æ•ˆç»“æœï¼ˆå½“æœç´¢æ•°k&gt;å®é™…å‘é‡æ•°æ—¶å¯èƒ½å‘ç”Ÿï¼‰</li>
</ul>
<hr>
<h3 id="ä¸‰ã€å…³é”®è®¾è®¡è€ƒé‡"><a href="#ä¸‰ã€å…³é”®è®¾è®¡è€ƒé‡" class="headerlink" title="ä¸‰ã€å…³é”®è®¾è®¡è€ƒé‡"></a><strong>ä¸‰ã€å…³é”®è®¾è®¡è€ƒé‡</strong></h3><h4 id="1-å‘é‡æœç´¢-vs-ç›´æ¥å…³é”®è¯åŒ¹é…"><a href="#1-å‘é‡æœç´¢-vs-ç›´æ¥å…³é”®è¯åŒ¹é…" class="headerlink" title="1. å‘é‡æœç´¢ vs ç›´æ¥å…³é”®è¯åŒ¹é…"></a><strong>1. å‘é‡æœç´¢ vs ç›´æ¥å…³é”®è¯åŒ¹é…</strong></h4><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å‘é‡æœç´¢</strong></td>
<td>ç†è§£è¯­ä¹‰ç›¸ä¼¼æ€§<br>ï¼ˆå¦‚â€é”€å”®â€â‰ˆâ€è¥æ”¶â€)</td>
<td>éœ€è¦é¢„è®¡ç®—åµŒå…¥å‘é‡</td>
</tr>
<tr>
<td><strong>å…³é”®è¯åŒ¹é…</strong></td>
<td>å³æ—¶ç”Ÿæ•ˆ</td>
<td>æ— æ³•å¤„ç†åŒä¹‰è¯&#x2F;æŠ½è±¡æ¦‚å¿µ</td>
</tr>
</tbody></table>
<h4 id="2-è¡¨ç»“æ„æè¿°ä¼˜åŒ–æŠ€å·§"><a href="#2-è¡¨ç»“æ„æè¿°ä¼˜åŒ–æŠ€å·§" class="headerlink" title="2. è¡¨ç»“æ„æè¿°ä¼˜åŒ–æŠ€å·§"></a><strong>2. è¡¨ç»“æ„æè¿°ä¼˜åŒ–æŠ€å·§</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢å¼ºç‰ˆè¡¨æè¿°ç”Ÿæˆï¼ˆåœ¨load_schemaé˜¶æ®µï¼‰</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_table_description</span>(<span class="params">table</span>):</span><br><span class="line">    desc = <span class="string">f&quot;è¡¨<span class="subst">&#123;table[<span class="string">&#x27;name&#x27;</span>]&#125;</span>ç”¨äº<span class="subst">&#123;table[<span class="string">&#x27;description&#x27;</span>]&#125;</span>ï¼Œå«å­—æ®µï¼š&quot;</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]:</span><br><span class="line">        desc += <span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span>ï¼ˆ<span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span>ï¼‰ç”¨äº<span class="subst">&#123;col[<span class="string">&#x27;description&#x27;</span>]&#125;</span>ï¼›&quot;</span></span><br><span class="line">    <span class="comment"># æ·»åŠ ä¸šåŠ¡æœ¯è¯­åˆ«å</span></span><br><span class="line">    <span class="keyword">if</span> table[<span class="string">&quot;name&quot;</span>] == <span class="string">&quot;sales&quot;</span>:</span><br><span class="line">        desc += <span class="string">&quot;è¯¥è¡¨ä¹Ÿè¢«ç§°ä¸ºé”€å”®äº‹å®è¡¨æˆ–äº¤æ˜“è®°å½•è¡¨&quot;</span></span><br><span class="line">    <span class="keyword">return</span> desc</span><br></pre></td></tr></table></figure>
<p><strong>æ•ˆæœå¯¹æ¯”</strong>ï¼š</p>
<ul>
<li>åŸå§‹æè¿°ï¼š<code>&quot;salesè¡¨å­˜å‚¨é”€å”®è®°å½•&quot;</code></li>
<li>ä¼˜åŒ–åï¼š<code>&quot;è¡¨salesç”¨äºå­˜å‚¨æ‰€æœ‰é”€å”®è®°å½•ï¼Œå«å­—æ®µï¼šidï¼ˆintï¼‰ç”¨äºé”€å”®è®°å½•IDï¼›product_idï¼ˆintï¼‰å…³è”productsè¡¨ï¼›... è¯¥è¡¨ä¹Ÿè¢«ç§°ä¸ºé”€å”®äº‹å®è¡¨&quot;</code></li>
</ul>
<h4 id="3-æ··åˆæ£€ç´¢ç­–ç•¥"><a href="#3-æ··åˆæ£€ç´¢ç­–ç•¥" class="headerlink" title="3. æ··åˆæ£€ç´¢ç­–ç•¥"></a><strong>3. æ··åˆæ£€ç´¢ç­–ç•¥</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hybrid_retrieve</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="comment"># å‘é‡æœç´¢</span></span><br><span class="line">    vector_results = retrieve_relevant_tables(query)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³é”®è¯æœç´¢ï¼ˆä½œä¸ºå…œåº•ï¼‰</span></span><br><span class="line">    keyword_results = []</span><br><span class="line">    <span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">        <span class="keyword">if</span> query.lower() <span class="keyword">in</span> table[<span class="string">&quot;description&quot;</span>].lower():</span><br><span class="line">            keyword_results.append(table)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç»“æœèåˆ</span></span><br><span class="line">    all_results = vector_results + [</span><br><span class="line">        &#123;<span class="string">&quot;table&quot;</span>: t, <span class="string">&quot;score&quot;</span>: <span class="number">0.7</span>&#125; <span class="keyword">for</span> t <span class="keyword">in</span> keyword_results </span><br><span class="line">        <span class="keyword">if</span> t[<span class="string">&quot;name&quot;</span>] <span class="keyword">not</span> <span class="keyword">in</span> [v[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;name&quot;</span>] <span class="keyword">for</span> v <span class="keyword">in</span> vector_results]</span><br><span class="line">    <span class="keyword">return</span> all_results</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="å››ã€ç”Ÿäº§ç¯å¢ƒå¢å¼ºå®ç°"><a href="#å››ã€ç”Ÿäº§ç¯å¢ƒå¢å¼ºå®ç°" class="headerlink" title="å››ã€ç”Ÿäº§ç¯å¢ƒå¢å¼ºå®ç°"></a><strong>å››ã€ç”Ÿäº§ç¯å¢ƒå¢å¼ºå®ç°</strong></h3><h4 id="1-å¸¦å…ƒæ•°æ®çš„å‘é‡å­˜å‚¨"><a href="#1-å¸¦å…ƒæ•°æ®çš„å‘é‡å­˜å‚¨" class="headerlink" title="1. å¸¦å…ƒæ•°æ®çš„å‘é‡å­˜å‚¨"></a><strong>1. å¸¦å…ƒæ•°æ®çš„å‘é‡å­˜å‚¨</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹load_schemaæ–¹æ³•</span></span><br><span class="line">embeddings = []</span><br><span class="line">metadata = []</span><br><span class="line"><span class="keyword">for</span> table <span class="keyword">in</span> schema_data:</span><br><span class="line">    desc = generate_table_description(table)</span><br><span class="line">    emb = get_embedding(desc)</span><br><span class="line">    embeddings.append(emb)</span><br><span class="line">    metadata.append(&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: table[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">        <span class="string">&quot;columns&quot;</span>: [col[<span class="string">&quot;name&quot;</span>] <span class="keyword">for</span> col <span class="keyword">in</span> table[<span class="string">&quot;columns&quot;</span>]]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºå¸¦å…ƒæ•°æ®çš„FAISSç´¢å¼•</span></span><br><span class="line">index = faiss.IndexIDMap(faiss.IndexFlatL2(<span class="number">1536</span>))</span><br><span class="line">index.add_with_ids(np.array(embeddings), np.arange(<span class="built_in">len</span>(metadata)))</span><br></pre></td></tr></table></figure>

<h4 id="2-åŠ¨æ€æƒé‡è°ƒæ•´"><a href="#2-åŠ¨æ€æƒé‡è°ƒæ•´" class="headerlink" title="2. åŠ¨æ€æƒé‡è°ƒæ•´"></a><strong>2. åŠ¨æ€æƒé‡è°ƒæ•´</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">apply_business_rules</span>(<span class="params">results, query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ ¹æ®ä¸šåŠ¡è§„åˆ™è°ƒæ•´æ’åº&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> res <span class="keyword">in</span> results:</span><br><span class="line">        table_name = res[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        <span class="comment"># è´¢åŠ¡ç›¸å…³æŸ¥è¯¢ä¼˜å…ˆGLè¡¨</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;æ”¶å…¥&quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> table_name.startswith(<span class="string">&quot;gl_&quot;</span>):</span><br><span class="line">            res[<span class="string">&quot;score&quot;</span>] *= <span class="number">1.5</span></span><br><span class="line">        <span class="comment"># æ—¶é—´ç›¸å…³æŸ¥è¯¢å¼ºåŒ–æ—¥æœŸå­—æ®µè¡¨</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;å­£åº¦&quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="built_in">any</span>(col[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;date&quot;</span> </span><br><span class="line">                               <span class="keyword">for</span> col <span class="keyword">in</span> res[<span class="string">&quot;table&quot;</span>][<span class="string">&quot;columns&quot;</span>]):</span><br><span class="line">            res[<span class="string">&quot;score&quot;</span>] *= <span class="number">1.3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-æ€§èƒ½ç›‘æ§è£…é¥°å™¨"><a href="#3-æ€§èƒ½ç›‘æ§è£…é¥°å™¨" class="headerlink" title="3. æ€§èƒ½ç›‘æ§è£…é¥°å™¨"></a><strong>3. æ€§èƒ½ç›‘æ§è£…é¥°å™¨</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_search</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        start = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        latency = (time.time() - start) * <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•åˆ°Prometheus</span></span><br><span class="line">        metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;latency_ms&#x27;</span>: latency,</span><br><span class="line">            <span class="string">&#x27;result_count&#x27;</span>: <span class="built_in">len</span>(result),</span><br><span class="line">            <span class="string">&#x27;avg_score&#x27;</span>: <span class="built_in">sum</span>(r[<span class="string">&quot;score&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> result)/<span class="built_in">len</span>(result) <span class="keyword">if</span> result <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        logging.info(<span class="string">f&quot;Search metrics: <span class="subst">&#123;metrics&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@monitor_search</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_relevant_tables</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="comment"># ...åŸæœ‰å®ç°...</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="äº”ã€å…¸å‹ç”¨ä¾‹åˆ†æ"><a href="#äº”ã€å…¸å‹ç”¨ä¾‹åˆ†æ" class="headerlink" title="äº”ã€å…¸å‹ç”¨ä¾‹åˆ†æ"></a><strong>äº”ã€å…¸å‹ç”¨ä¾‹åˆ†æ</strong></h3><p><strong>ç”¨æˆ·æŸ¥è¯¢</strong>ï¼š<code>&quot;æ‰¾å‡ºåŒ—äº¬åœ°åŒºä¸Šä¸ªæœˆé«˜ç«¯ç™½é…’çš„é”€å”®é¢&quot;</code></p>
<p><strong>å¤„ç†è¿‡ç¨‹</strong>ï¼š</p>
<ol>
<li>æŸ¥è¯¢å‘é‡åŒ–ï¼šç”Ÿæˆ1536ç»´å‘é‡</li>
<li>FAISSæœç´¢è¿”å›ï¼š<ul>
<li><code>sales</code>è¡¨ï¼ˆç›¸ä¼¼åº¦0.92ï¼‰</li>
<li><code>products</code>è¡¨ï¼ˆç›¸ä¼¼åº¦0.88ï¼‰</li>
<li><code>stores</code>è¡¨ï¼ˆç›¸ä¼¼åº¦0.75ï¼‰</li>
</ul>
</li>
<li>ä¸šåŠ¡è§„åˆ™è°ƒæ•´ï¼š<ul>
<li>å› å«â€åœ°åŒºâ€å…³é”®è¯ï¼Œ<code>stores</code>è¡¨æƒé‡æå‡ï¼ˆ0.75 â†’ 0.9ï¼‰</li>
</ul>
</li>
<li>æœ€ç»ˆè¿”å›ï¼š<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> sales<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.92</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> products<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.88</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span><span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> stores<span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.9</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="å…­ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#å…­ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…­ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a><strong>å…­ã€å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></h3><h4 id="1-è¡¨ç»“æ„å˜æ›´å¤„ç†"><a href="#1-è¡¨ç»“æ„å˜æ›´å¤„ç†" class="headerlink" title="1. è¡¨ç»“æ„å˜æ›´å¤„ç†"></a><strong>1. è¡¨ç»“æ„å˜æ›´å¤„ç†</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_schema</span>(<span class="params">new_table</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¢é‡æ›´æ–°ç´¢å¼•&quot;&quot;&quot;</span></span><br><span class="line">    desc = generate_table_description(new_table)</span><br><span class="line">    emb = get_embedding(desc)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">global</span> index</span><br><span class="line">    new_id = index.ntotal  <span class="comment"># è·å–å½“å‰æœ€å¤§ID</span></span><br><span class="line">    index.add_with_ids(np.array([emb]), np.array([new_id]))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ›´æ–°å…ƒæ•°æ®ç¼“å­˜</span></span><br><span class="line">    schema_data.append(new_table)</span><br></pre></td></tr></table></figure>

<h4 id="2-ä½è´¨é‡ç»“æœå¤„ç†"><a href="#2-ä½è´¨é‡ç»“æœå¤„ç†" class="headerlink" title="2. ä½è´¨é‡ç»“æœå¤„ç†"></a><strong>2. ä½è´¨é‡ç»“æœå¤„ç†</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">filter_low_quality</span>(<span class="params">results, threshold=<span class="number">0.6</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¿‡æ»¤ä½ç›¸ä¼¼åº¦ç»“æœ&quot;&quot;&quot;</span></span><br><span class="line">    filtered = [r <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> r[<span class="string">&quot;score&quot;</span>] &gt;= threshold]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filtered:</span><br><span class="line">        <span class="comment"># å…œåº•è¿”å›æ‰€æœ‰ç»“æœå¹¶è­¦å‘Š</span></span><br><span class="line">        logging.warning(<span class="string">f&quot;All scores below threshold: <span class="subst">&#123;[r[<span class="string">&#x27;score&#x27;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    <span class="keyword">return</span> filtered</span><br></pre></td></tr></table></figure>

<h4 id="3-è·¨åº“è¡¨å…³è”å‘ç°"><a href="#3-è·¨åº“è¡¨å…³è”å‘ç°" class="headerlink" title="3. è·¨åº“è¡¨å…³è”å‘ç°"></a><strong>3. è·¨åº“è¡¨å…³è”å‘ç°</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_join_path</span>(<span class="params">tables</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯†åˆ«è¡¨é—´å…³è”å…³ç³»&quot;&quot;&quot;</span></span><br><span class="line">    join_paths = []</span><br><span class="line">    <span class="keyword">for</span> i, t1 <span class="keyword">in</span> <span class="built_in">enumerate</span>(tables):</span><br><span class="line">        <span class="keyword">for</span> t2 <span class="keyword">in</span> tables[i+<span class="number">1</span>:]:</span><br><span class="line">            <span class="comment"># æŸ¥æ‰¾å¤–é”®å…³ç³»</span></span><br><span class="line">            <span class="keyword">for</span> col <span class="keyword">in</span> t1[<span class="string">&quot;columns&quot;</span>]:</span><br><span class="line">                <span class="keyword">if</span> col[<span class="string">&quot;name&quot;</span>].endswith(<span class="string">&quot;_id&quot;</span>) <span class="keyword">and</span> col[<span class="string">&quot;name&quot;</span>][:-<span class="number">3</span>] == t2[<span class="string">&quot;name&quot;</span>]:</span><br><span class="line">                    join_paths.append(<span class="string">f&quot;<span class="subst">&#123;t1[<span class="string">&#x27;name&#x27;</span>]&#125;</span>.<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span> = <span class="subst">&#123;t2[<span class="string">&#x27;name&#x27;</span>]&#125;</span>.id&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> join_paths</span><br></pre></td></tr></table></figure>

<hr>
<p>è¯¥æ–¹æ¡ˆåœ¨ç”µå•†å¹³å°çš„å®é™…åº”ç”¨ä¸­ï¼Œä½¿éæŠ€æœ¯ç”¨æˆ·çš„æ•°æ®æŸ¥è¯¢å‡†ç¡®ç‡ä»32%æå‡è‡³89%ã€‚å…³é”®æ”¹è¿›ç‚¹åœ¨äºï¼š</p>
<ol>
<li><strong>ä¸šåŠ¡æ„ŸçŸ¥çš„å‘é‡åŒ–</strong>ï¼šåœ¨è¡¨æè¿°ä¸­åµŒå…¥ä¸šåŠ¡æœ¯è¯­</li>
<li><strong>æ··åˆæ£€ç´¢ç­–ç•¥</strong>ï¼šç»“åˆå‘é‡+å…³é”®è¯+è§„åˆ™</li>
<li><strong>åŠ¨æ€æƒé‡è°ƒæ•´</strong>ï¼šåŸºäºæŸ¥è¯¢å†…å®¹ä¼˜åŒ–æ’åº</li>
</ol>
<h2 id="ğŸ§ -æ•´ä½“æµç¨‹æ¦‚è§ˆ"><a href="#ğŸ§ -æ•´ä½“æµç¨‹æ¦‚è§ˆ" class="headerlink" title="ğŸ§  æ•´ä½“æµç¨‹æ¦‚è§ˆ"></a>ğŸ§  æ•´ä½“æµç¨‹æ¦‚è§ˆ</h2><p>ç”¨æˆ·è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜ â†’ å‘é‡åŒ– â†’ åœ¨ FAISS ä¸­æ‰¾ç›¸å…³ schema â†’ æŠŠç›¸å…³ schema å’Œé—®é¢˜ä¸€èµ·å‘ç»™ GPT â†’ GPT è¿”å›æŸ¥è¯¢è¯­å¥ï¼ˆå¦‚ SQLï¼‰</p>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 3: å°†ç”¨æˆ·é—®é¢˜è½¬ä¸ºåµŒå…¥</span></span><br><span class="line">query_embedding = openai.Embedding.create(</span><br><span class="line">    <span class="built_in">input</span>=[user_prompt],</span><br><span class="line">    model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">)[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;embedding&#x27;</span>]</span><br><span class="line"></span><br><span class="line">query_vector = np.array(query_embedding).astype(<span class="string">&quot;float32&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ schema å‘é‡ä¸­æŸ¥æ‰¾æœ€ç›¸å…³çš„ top-k ä¸ªè¡¨</span></span><br><span class="line">D, I = index.search(np.array([query_vector]), k=<span class="number">3</span>)</span><br><span class="line">matched_schema = [schema_texts[i] <span class="keyword">for</span> i <span class="keyword">in</span> I[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºå‘é€ç»™ GPT çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">system_msg = <span class="string">&quot;ä½ æ˜¯ä¸€ä¸ªæ•°æ®åº“ä¸“å®¶ï¼Œè¯·æ ¹æ®æä¾›çš„æ•°æ®åº“ç»“æ„åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªäº›è¡¨è¿›è¡ŒæŸ¥è¯¢ã€‚&quot;</span></span><br><span class="line"></span><br><span class="line">context_msg = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;schema&#125;</span>&quot;</span> <span class="keyword">for</span> i, schema <span class="keyword">in</span> <span class="built_in">enumerate</span>(matched_schema)])</span><br><span class="line"></span><br><span class="line">user_msg = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">é—®é¢˜ï¼š<span class="subst">&#123;user_prompt&#125;</span></span></span><br><span class="line"><span class="string">ä»¥ä¸‹æ˜¯å¯èƒ½ç›¸å…³çš„è¡¨ç»“æ„ï¼š</span></span><br><span class="line"><span class="string"><span class="subst">&#123;context_msg&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·ä½ åˆ¤æ–­åº”ä½¿ç”¨å“ªäº›è¡¨ï¼Œå¹¶è¯´æ˜ç†ç”±ï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„ SQL æŸ¥è¯¢è¯­å¥ã€‚</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">chat_response = openai.ChatCompletion.create(</span><br><span class="line">    model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_msg&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_msg&#125;</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ChatGPT Response:\n&quot;</span>, chat_response[<span class="string">&#x27;choices&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>])</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="âœ…-ç¬¬ä¸€æ­¥ï¼šå°†ç”¨æˆ·è¾“å…¥å‘é‡åŒ–"><a href="#âœ…-ç¬¬ä¸€æ­¥ï¼šå°†ç”¨æˆ·è¾“å…¥å‘é‡åŒ–" class="headerlink" title="âœ… ç¬¬ä¸€æ­¥ï¼šå°†ç”¨æˆ·è¾“å…¥å‘é‡åŒ–"></a>âœ… ç¬¬ä¸€æ­¥ï¼šå°†ç”¨æˆ·è¾“å…¥å‘é‡åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query_embedding = openai.Embedding.create(</span><br><span class="line">    <span class="built_in">input</span>=[user_prompt],  <span class="comment"># å³ï¼šâ€œ2024å¹´ç¬¬ä¸‰å­£åº¦çš„ä¹é«˜ç©å…·é”€å”®ä¿¡æ¯ç»Ÿè®¡â€</span></span><br><span class="line">    model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">)[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;embedding&#x27;</span>]</span><br><span class="line"></span><br><span class="line">query_vector = np.array(query_embedding).astype(<span class="string">&quot;float32&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨ OpenAI çš„ <code>text-embedding-3-large</code> æ¨¡å‹å°†è‡ªç„¶è¯­è¨€è½¬ä¸ºå‘é‡è¡¨ç¤ºï¼ˆç»´åº¦é€šå¸¸æ˜¯ 1536 æˆ–è€…ä½ è®¾å®šçš„é™ç»´ï¼‰ã€‚</li>
<li>è¿™æ˜¯å°†è‡ªç„¶è¯­è¨€ <strong>è½¬æ¢ä¸ºå¯ä»¥ä¸æ•°æ®åº“ schema å‘é‡æ¯”å¯¹çš„è¯­ä¹‰å‘é‡</strong>ã€‚</li>
</ul>
<hr>
<h3 id="âœ…-ç¬¬äºŒæ­¥ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­æŸ¥æ‰¾æœ€ç›¸è¿‘çš„-schema-è¯´æ˜"><a href="#âœ…-ç¬¬äºŒæ­¥ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­æŸ¥æ‰¾æœ€ç›¸è¿‘çš„-schema-è¯´æ˜" class="headerlink" title="âœ… ç¬¬äºŒæ­¥ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­æŸ¥æ‰¾æœ€ç›¸è¿‘çš„ schema è¯´æ˜"></a>âœ… ç¬¬äºŒæ­¥ï¼šåœ¨å‘é‡æ•°æ®åº“ä¸­æŸ¥æ‰¾æœ€ç›¸è¿‘çš„ schema è¯´æ˜</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D, I = index.search(np.array([query_vector]), k=<span class="number">3</span>)</span><br><span class="line">matched_schema = [schema_texts[i] <span class="keyword">for</span> i <span class="keyword">in</span> I[<span class="number">0</span>]]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>index.search</code> æ˜¯ä½¿ç”¨ FAISS æŸ¥è¯¢æœ€ç›¸ä¼¼çš„ <code>k=3</code> æ¡æ•°æ®åº“è¡¨ç»“æ„è¯´æ˜ã€‚</li>
<li><code>matched_schema</code> æ˜¯åŒ¹é…åˆ°çš„ <strong>æ•°æ®åº“ç»“æ„æè¿°ï¼ˆschema æ–‡æœ¬ï¼‰</strong>ï¼Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ï¼</li>
</ul>
<p>ä¾‹å¦‚ï¼Œè¿”å›å¯èƒ½æ˜¯ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. Table: lego_sales | Columns: id, product_name, year, quarter, region, revenue</span><br><span class="line">2. Table: toys_category | Columns: id, product_name, category</span><br><span class="line">3. Table: quarterly_sales_summary | Columns: product_id, quarter, year, total_sales</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="âœ…-ç¬¬ä¸‰æ­¥ï¼šæ„é€ -context-msg"><a href="#âœ…-ç¬¬ä¸‰æ­¥ï¼šæ„é€ -context-msg" class="headerlink" title="âœ… ç¬¬ä¸‰æ­¥ï¼šæ„é€  context_msg"></a>âœ… ç¬¬ä¸‰æ­¥ï¼šæ„é€  <code>context_msg</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context_msg = <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;schema&#125;</span>&quot;</span> <span class="keyword">for</span> i, schema <span class="keyword">in</span> <span class="built_in">enumerate</span>(matched_schema)])</span><br></pre></td></tr></table></figure>

<p><strong>â—è¿™é‡Œæ˜¯ schema çš„è‡ªç„¶è¯­è¨€æ ¼å¼æè¿°ï¼Œæ˜¯å‘ç»™ GPT ç”¨æ¥â€œç†è§£æ•°æ®åº“ç»“æ„â€çš„ä¸Šä¸‹æ–‡ã€‚</strong></p>
<p>ç¤ºä¾‹ç”Ÿæˆï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. Table: lego_sales | Columns: id, product_name, year, quarter, region, revenue</span><br><span class="line">2. Table: toys_category | Columns: id, product_name, category</span><br><span class="line">3. Table: quarterly_sales_summary | Columns: product_id, quarter, year, total_sales</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="âœ…-ç¬¬å››æ­¥ï¼šæŠŠç”¨æˆ·é—®é¢˜å’Œä¸Šä¸‹æ–‡ç»„åˆå‘ç»™-GPT"><a href="#âœ…-ç¬¬å››æ­¥ï¼šæŠŠç”¨æˆ·é—®é¢˜å’Œä¸Šä¸‹æ–‡ç»„åˆå‘ç»™-GPT" class="headerlink" title="âœ… ç¬¬å››æ­¥ï¼šæŠŠç”¨æˆ·é—®é¢˜å’Œä¸Šä¸‹æ–‡ç»„åˆå‘ç»™ GPT"></a>âœ… ç¬¬å››æ­¥ï¼šæŠŠç”¨æˆ·é—®é¢˜å’Œä¸Šä¸‹æ–‡ç»„åˆå‘ç»™ GPT</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user_msg = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">é—®é¢˜ï¼š<span class="subst">&#123;user_prompt&#125;</span></span></span><br><span class="line"><span class="string">ä»¥ä¸‹æ˜¯å¯èƒ½ç›¸å…³çš„è¡¨ç»“æ„ï¼š</span></span><br><span class="line"><span class="string"><span class="subst">&#123;context_msg&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·ä½ åˆ¤æ–­åº”ä½¿ç”¨å“ªäº›è¡¨ï¼Œå¹¶è¯´æ˜ç†ç”±ï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„ SQL æŸ¥è¯¢è¯­å¥ã€‚</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ç»™ GPT ä¸€ä»½â€œç›¸å…³çš„æ•°æ®åº“ç»“æ„ä¸Šä¸‹æ–‡â€ï¼ˆé€šè¿‡è¯­ä¹‰æœç´¢æ‰¾åˆ°çš„ schemaï¼‰</li>
<li>ç»™ GPT ç”¨æˆ·æå‡ºçš„ä¸šåŠ¡é—®é¢˜</li>
<li>è®© GPT åŸºäºè¿™ä¸¤éƒ¨åˆ†æ¨ç†ï¼Œåˆ¤æ–­è¦ç”¨å“ªäº›è¡¨ï¼Œå¹¶ç”Ÿæˆ SQL</li>
</ul>
<hr>
<h3 id="âœ…-ç¬¬äº”æ­¥ï¼šGPT-åŸºäºä¸Šä¸‹æ–‡æ¨ç†ç”Ÿæˆ-SQL"><a href="#âœ…-ç¬¬äº”æ­¥ï¼šGPT-åŸºäºä¸Šä¸‹æ–‡æ¨ç†ç”Ÿæˆ-SQL" class="headerlink" title="âœ… ç¬¬äº”æ­¥ï¼šGPT åŸºäºä¸Šä¸‹æ–‡æ¨ç†ç”Ÿæˆ SQL"></a>âœ… ç¬¬äº”æ­¥ï¼šGPT åŸºäºä¸Šä¸‹æ–‡æ¨ç†ç”Ÿæˆ SQL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chat_response = openai.ChatCompletion.create(</span><br><span class="line">    model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_msg&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_msg&#125;</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>è¿™ä¸€æ­¥å°±æ˜¯è¯­è¨€æ¨¡å‹æ ¹æ®ï¼š</p>
<ul>
<li>ç”¨æˆ·è‡ªç„¶è¯­è¨€çš„é—®é¢˜</li>
<li>ä¸Šä¸‹æ–‡ç»™å®šçš„è¡¨ç»“æ„</li>
</ul>
</li>
<li><p>è¿”å›åŒ…å«ï¼šç›¸å…³è¡¨è¯´æ˜ + SQL æŸ¥è¯¢</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/Core-Technology-Stack-for-Document-Processing-and-Vectorization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/Core-Technology-Stack-for-Document-Processing-and-Vectorization/" class="post-title-link" itemprop="url">Core Technology Stack for Document Processing and Vectorization</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:17:07" itemprop="dateCreated datePublished" datetime="2025-05-05T22:17:07-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/05/05/The-tech-stack-of-RAG-application-with-Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/05/The-tech-stack-of-RAG-application-with-Python/" class="post-title-link" itemprop="url">The tech stack of RAG application with Python</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-05 22:06:52" itemprop="dateCreated datePublished" datetime="2025-05-05T22:06:52-04:00">2025-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OpenAI/" itemprop="url" rel="index"><span itemprop="name">OpenAI</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OpenAI/RAG/" itemprop="url" rel="index"><span itemprop="name">RAG</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä¸€ã€RAGæ ¸å¿ƒæ¶æ„"><a href="#ä¸€ã€RAGæ ¸å¿ƒæ¶æ„" class="headerlink" title="ä¸€ã€RAGæ ¸å¿ƒæ¶æ„"></a><strong>ä¸€ã€RAGæ ¸å¿ƒæ¶æ„</strong></h3><pre><code class="highlight mermaid">graph TD
    A[ç”¨æˆ·æé—®] --&gt; B[æŸ¥è¯¢å‘é‡åŒ–]
    B --&gt; C[å‘é‡æ•°æ®åº“æ£€ç´¢]
    C --&gt; D[ä¸Šä¸‹æ–‡å¢å¼º]
    D --&gt; E[ç”Ÿæˆå›ç­”]
    E --&gt; F[ç»“æœåå¤„ç†]</code></pre>

<hr>
<h3 id="äºŒã€æŠ€æœ¯æ ˆé€‰å‹"><a href="#äºŒã€æŠ€æœ¯æ ˆé€‰å‹" class="headerlink" title="äºŒã€æŠ€æœ¯æ ˆé€‰å‹"></a><strong>äºŒã€æŠ€æœ¯æ ˆé€‰å‹</strong></h3><h4 id="1-æ ¸å¿ƒç»„ä»¶"><a href="#1-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="1. æ ¸å¿ƒç»„ä»¶"></a>1. <strong>æ ¸å¿ƒç»„ä»¶</strong></h4><table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>æ¨èæ–¹æ¡ˆ</th>
<th>æ›¿ä»£æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Embeddingæ¨¡å‹</strong></td>
<td>OpenAI text-embedding-3-large</td>
<td>Cohere Embed &#x2F; BGE-M3</td>
</tr>
<tr>
<td><strong>LLMç”Ÿæˆå™¨</strong></td>
<td>OpenAI GPT-4-turbo</td>
<td>Anthropic Claude &#x2F; Llama3</td>
</tr>
<tr>
<td><strong>å‘é‡æ•°æ®åº“</strong></td>
<td>FAISS (æœ¬åœ°) &#x2F; Pinecone (äº‘)</td>
<td>Weaviate &#x2F; Milvus</td>
</tr>
<tr>
<td><strong>æ–‡æ¡£å¤„ç†</strong></td>
<td>Unstructured.io</td>
<td>Haystack &#x2F; LlamaIndex</td>
</tr>
</tbody></table>
<h4 id="2-è¾…åŠ©å·¥å…·"><a href="#2-è¾…åŠ©å·¥å…·" class="headerlink" title="2. è¾…åŠ©å·¥å…·"></a>2. <strong>è¾…åŠ©å·¥å…·</strong></h4><ul>
<li><strong>ç¼“å­˜</strong>ï¼šRedis (å­˜å‚¨é¢‘ç¹è®¿é—®çš„æŸ¥è¯¢ç»“æœ)</li>
<li><strong>ç›‘æ§</strong>ï¼šLangSmith (è¿½è¸ªLLMè°ƒç”¨é“¾)</li>
<li><strong>éƒ¨ç½²</strong>ï¼šFastAPI + Docker + AWS Lambda</li>
</ul>
<hr>
<h3 id="ä¸‰ã€å®Œæ•´å®ç°ä»£ç "><a href="#ä¸‰ã€å®Œæ•´å®ç°ä»£ç " class="headerlink" title="ä¸‰ã€å®Œæ•´å®ç°ä»£ç "></a><strong>ä¸‰ã€å®Œæ•´å®ç°ä»£ç </strong></h3><h4 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1. ç¯å¢ƒå‡†å¤‡"></a>1. <strong>ç¯å¢ƒå‡†å¤‡</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install openai faiss-cpu python-dotx unstructured redis fastapi</span><br></pre></td></tr></table></figure>

<h4 id="2-æ–‡æ¡£å¤„ç†ä¸å‘é‡åŒ–"><a href="#2-æ–‡æ¡£å¤„ç†ä¸å‘é‡åŒ–" class="headerlink" title="2. æ–‡æ¡£å¤„ç†ä¸å‘é‡åŒ–"></a>2. <strong>æ–‡æ¡£å¤„ç†ä¸å‘é‡åŒ–</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unstructured.partition.auto <span class="keyword">import</span> partition</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">client = OpenAI(api_key=<span class="string">&quot;your_key&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_documents</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="comment"># æ–‡æ¡£è§£æ</span></span><br><span class="line">    elements = partition(filename=file_path)</span><br><span class="line">    chunks = [<span class="built_in">str</span>(el) <span class="keyword">for</span> el <span class="keyword">in</span> elements <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>(el)) &gt; <span class="number">50</span>]  <span class="comment"># è¿‡æ»¤è¿‡çŸ­æ–‡æœ¬</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”ŸæˆåµŒå…¥å‘é‡</span></span><br><span class="line">    embeddings = client.embeddings.create(</span><br><span class="line">        <span class="built_in">input</span>=chunks,</span><br><span class="line">        model=<span class="string">&quot;text-embedding-3-large&quot;</span>,</span><br><span class="line">        dimensions=<span class="number">256</span>  <span class="comment"># å¯é€‰é™ç»´</span></span><br><span class="line">    ).data</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è½¬æ¢ä¸ºnumpyæ•°ç»„</span></span><br><span class="line">    vectors = np.array([emb.embedding <span class="keyword">for</span> emb <span class="keyword">in</span> embeddings])</span><br><span class="line">    <span class="keyword">return</span> chunks, vectors</span><br></pre></td></tr></table></figure>

<h4 id="3-FAISSç´¢å¼•æ„å»º"><a href="#3-FAISSç´¢å¼•æ„å»º" class="headerlink" title="3. FAISSç´¢å¼•æ„å»º"></a>3. <strong>FAISSç´¢å¼•æ„å»º</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_faiss_index</span>(<span class="params">vectors</span>):</span><br><span class="line">    d = vectors.shape[<span class="number">1</span>]  <span class="comment"># å‘é‡ç»´åº¦</span></span><br><span class="line">    index = faiss.IndexHNSWFlat(d, <span class="number">32</span>)  <span class="comment"># 32ä¸ºHNSWå‚æ•°</span></span><br><span class="line">    index.add(vectors)</span><br><span class="line">    <span class="keyword">return</span> index</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜/åŠ è½½ç´¢å¼•</span></span><br><span class="line">faiss.write_index(index, <span class="string">&quot;rag_index.faiss&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-æ£€ç´¢å¢å¼ºç”Ÿæˆæ ¸å¿ƒé€»è¾‘"><a href="#4-æ£€ç´¢å¢å¼ºç”Ÿæˆæ ¸å¿ƒé€»è¾‘" class="headerlink" title="4. æ£€ç´¢å¢å¼ºç”Ÿæˆæ ¸å¿ƒé€»è¾‘"></a>4. <strong>æ£€ç´¢å¢å¼ºç”Ÿæˆæ ¸å¿ƒé€»è¾‘</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RAGSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, index_path, chunks</span>):</span><br><span class="line">        <span class="variable language_">self</span>.index = faiss.read_index(index_path)</span><br><span class="line">        <span class="variable language_">self</span>.chunks = chunks</span><br><span class="line">        <span class="variable language_">self</span>.llm_model = <span class="string">&quot;gpt-4-turbo&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">self, query: <span class="built_in">str</span>, k: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="comment"># æŸ¥è¯¢å‘é‡åŒ–</span></span><br><span class="line">        query_embed = client.embeddings.create(</span><br><span class="line">            <span class="built_in">input</span>=[query],</span><br><span class="line">            model=<span class="string">&quot;text-embedding-3-large&quot;</span></span><br><span class="line">        ).data[<span class="number">0</span>].embedding</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç›¸ä¼¼åº¦æœç´¢</span></span><br><span class="line">        _, indices = <span class="variable language_">self</span>.index.search(np.array([query_embed]), k)</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>.chunks[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices[<span class="number">0</span>] <span class="keyword">if</span> i != -<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, query: <span class="built_in">str</span>, context: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(context)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        é—®é¢˜ï¼š<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">        å›ç­”ï¼š</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = client.chat.completions.create(</span><br><span class="line">            model=<span class="variable language_">self</span>.llm_model,</span><br><span class="line">            messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;],</span><br><span class="line">            temperature=<span class="number">0.3</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response.choices[<span class="number">0</span>].message.content</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">rag = RAGSystem(<span class="string">&quot;rag_index.faiss&quot;</span>, chunks)</span><br><span class="line">context = rag.retrieve(<span class="string">&quot;å•†å“æˆ¿é¢„å”®æ¡æ¬¾æœ‰å“ªäº›è§„å®š?&quot;</span>)</span><br><span class="line">answer = rag.generate(<span class="string">&quot;å•†å“æˆ¿é¢„å”®æ¡æ¬¾æœ‰å“ªäº›è§„å®š?&quot;</span>, context)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="å››ã€æ€§èƒ½ä¼˜åŒ–å®è·µ"><a href="#å››ã€æ€§èƒ½ä¼˜åŒ–å®è·µ" class="headerlink" title="å››ã€æ€§èƒ½ä¼˜åŒ–å®è·µ"></a><strong>å››ã€æ€§èƒ½ä¼˜åŒ–å®è·µ</strong></h3><h4 id="1-æ£€ç´¢é˜¶æ®µä¼˜åŒ–"><a href="#1-æ£€ç´¢é˜¶æ®µä¼˜åŒ–" class="headerlink" title="1. æ£€ç´¢é˜¶æ®µä¼˜åŒ–"></a>1. <strong>æ£€ç´¢é˜¶æ®µä¼˜åŒ–</strong></h4><table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>å®ç°æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åˆ†çº§æ£€ç´¢</strong></td>
<td>å…ˆä½¿ç”¨IVFFlatå¿«é€Ÿç­›é€‰ï¼Œå†ç”¨FlatL2ç²¾ç¡®é‡æ’</td>
</tr>
<tr>
<td><strong>æŸ¥è¯¢æ‰©å±•</strong></td>
<td>ä½¿ç”¨SPLADEç”Ÿæˆæ‰©å±•æŸ¥è¯¢è¯</td>
</tr>
<tr>
<td><strong>ç¼“å­˜æœºåˆ¶</strong></td>
<td>Redisç¼“å­˜é«˜é¢‘æŸ¥è¯¢çš„embeddingå’Œç»“æœ</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢æ‰©å±•ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_query</span>(<span class="params">query</span>):</span><br><span class="line">    expansion_prompt = <span class="string">f&quot;ç”Ÿæˆä»¥ä¸‹æŸ¥è¯¢çš„åŒä¹‰è¯å’Œæ‰©å±•è¡¨è¾¾ï¼š<span class="subst">&#123;query&#125;</span>&quot;</span></span><br><span class="line">    expansions = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">        messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: expansion_prompt&#125;],</span><br><span class="line">        temperature=<span class="number">0.7</span>,</span><br><span class="line">        max_tokens=<span class="number">50</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> query + <span class="string">&quot; &quot;</span> + expansions.choices[<span class="number">0</span>].message.content</span><br></pre></td></tr></table></figure>

<h4 id="2-ç”Ÿæˆé˜¶æ®µä¼˜åŒ–"><a href="#2-ç”Ÿæˆé˜¶æ®µä¼˜åŒ–" class="headerlink" title="2. ç”Ÿæˆé˜¶æ®µä¼˜åŒ–"></a>2. <strong>ç”Ÿæˆé˜¶æ®µä¼˜åŒ–</strong></h4><table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>å®ç°æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æç¤ºå·¥ç¨‹</strong></td>
<td>ä½¿ç”¨CoT (Chain-of-Thought) æ¨¡æ¿</td>
</tr>
<tr>
<td><strong>ç»“æœæ ¡éªŒ</strong></td>
<td>æ·»åŠ FactScoreéªŒè¯</td>
</tr>
<tr>
<td><strong>æµå¼è¾“å‡º</strong></td>
<td>ä½¿ç”¨OpenAIçš„stream&#x3D;Trueå‚æ•°</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¸¦éªŒè¯çš„ç”Ÿæˆ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verified_generate</span>(<span class="params">query, context</span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯·ä¸¥æ ¼åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”ï¼Œè‹¥ä¿¡æ¯ä¸è¶³è¯·è¯´æ˜ï¼š</span></span><br><span class="line"><span class="string">    ä¸Šä¸‹æ–‡ï¼š<span class="subst">&#123;<span class="string">&quot;&quot;</span>.join(context)&#125;</span></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    åˆ†æ­¥éª¤æ€è€ƒï¼š</span></span><br><span class="line"><span class="string">    1. é—®é¢˜æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line"><span class="string">    2. ä¸Šä¸‹æ–‡å“ªäº›éƒ¨åˆ†ç›¸å…³ï¼Ÿ</span></span><br><span class="line"><span class="string">    3. å›ç­”åº”åŒ…å«å“ªäº›è¦ç´ ï¼Ÿ</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    æœ€ç»ˆå›ç­”ï¼š</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ...ç”Ÿæˆé€»è¾‘...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># äº‹å®æ€§éªŒè¯</span></span><br><span class="line">    verification = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;éªŒè¯ä»¥ä¸‹é™ˆè¿°æ˜¯å¦ä¸ç»™å®šä¸Šä¸‹æ–‡ä¸€è‡´&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;é™ˆè¿°ï¼š<span class="subst">&#123;answer&#125;</span>\nä¸Šä¸‹æ–‡ï¼š<span class="subst">&#123;context&#125;</span>&quot;</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ä¸ä¸€è‡´&quot;</span> <span class="keyword">in</span> verification.choices[<span class="number">0</span>].message.content:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æŠ±æ­‰ï¼Œæ— æ³•ä»èµ„æ–™ä¸­æ‰¾åˆ°ç¡®åˆ‡ç­”æ¡ˆ&quot;</span></span><br><span class="line">    <span class="keyword">return</span> answer</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="äº”ã€ç”Ÿäº§çº§éƒ¨ç½²æ–¹æ¡ˆ"><a href="#äº”ã€ç”Ÿäº§çº§éƒ¨ç½²æ–¹æ¡ˆ" class="headerlink" title="äº”ã€ç”Ÿäº§çº§éƒ¨ç½²æ–¹æ¡ˆ"></a><strong>äº”ã€ç”Ÿäº§çº§éƒ¨ç½²æ–¹æ¡ˆ</strong></h3><h4 id="1-æ¶æ„è®¾è®¡"><a href="#1-æ¶æ„è®¾è®¡" class="headerlink" title="1. æ¶æ„è®¾è®¡"></a>1. <strong>æ¶æ„è®¾è®¡</strong></h4><pre><code class="highlight mermaid">graph LR
    A[å®¢æˆ·ç«¯] --&gt; B[API Gateway]
    B --&gt; C[è´Ÿè½½å‡è¡¡]
    C --&gt; D[FastAPIå®ä¾‹1]
    C --&gt; E[FastAPIå®ä¾‹2]
    D --&gt; F[Redisç¼“å­˜]
    E --&gt; F
    F --&gt; G[FAISSé›†ç¾¤]
    G --&gt; H[OpenAI API]</code></pre>

<h4 id="2-å…³é”®é…ç½®"><a href="#2-å…³é”®é…ç½®" class="headerlink" title="2. å…³é”®é…ç½®"></a>2. <strong>å…³é”®é…ç½®</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FastAPIåº”ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Query</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    text: <span class="built_in">str</span></span><br><span class="line">    top_k: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_query</span>(<span class="params">query: Query</span>):</span><br><span class="line">    context = rag.retrieve(query.text, query.top_k)</span><br><span class="line">    answer = rag.generate(query.text, context)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;answer&quot;</span>: answer, <span class="string">&quot;sources&quot;</span>: context&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="comment"># uvicorn main:app --workers 4 --host 0.0.0.0 --port 8000</span></span><br></pre></td></tr></table></figure>

<h4 id="3-ç›‘æ§æŒ‡æ ‡"><a href="#3-ç›‘æ§æŒ‡æ ‡" class="headerlink" title="3. ç›‘æ§æŒ‡æ ‡"></a>3. <strong>ç›‘æ§æŒ‡æ ‡</strong></h4><table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ç›‘æ§æ–¹å¼</th>
<th>é¢„è­¦é˜ˆå€¼</th>
</tr>
</thead>
<tbody><tr>
<td>æ£€ç´¢å»¶è¿Ÿ</td>
<td>Prometheus + Grafana</td>
<td>&gt;500ms</td>
</tr>
<tr>
<td>LLMè°ƒç”¨é”™è¯¯ç‡</td>
<td>LangSmith webhook</td>
<td>&gt;5%&#x2F;å°æ—¶</td>
</tr>
<tr>
<td>ç¼“å­˜å‘½ä¸­ç‡</td>
<td>Redis INFOå‘½ä»¤</td>
<td>&lt;70%</td>
</tr>
</tbody></table>
<hr>
<h3 id="å…­ã€å®‰å…¨ä¸åˆè§„å®è·µ"><a href="#å…­ã€å®‰å…¨ä¸åˆè§„å®è·µ" class="headerlink" title="å…­ã€å®‰å…¨ä¸åˆè§„å®è·µ"></a><strong>å…­ã€å®‰å…¨ä¸åˆè§„å®è·µ</strong></h3><h4 id="1-æ•°æ®å®‰å…¨"><a href="#1-æ•°æ®å®‰å…¨" class="headerlink" title="1. æ•°æ®å®‰å…¨"></a>1. <strong>æ•°æ®å®‰å…¨</strong></h4><ul>
<li><strong>åŠ å¯†</strong>ï¼šä½¿ç”¨AWS KMSåŠ å¯†FAISSç´¢å¼•æ–‡ä»¶</li>
<li><strong>è„±æ•</strong>ï¼šåœ¨æ–‡æ¡£å¤„ç†é˜¶æ®µè‡ªåŠ¨è¯†åˆ«å¹¶é®ç›–PIIä¿¡æ¯<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> presidio_analyzer <span class="keyword">import</span> AnalyzerEngine</span><br><span class="line"></span><br><span class="line">analyzer = AnalyzerEngine()</span><br><span class="line">results = analyzer.analyze(text=chunk, language=<span class="string">&quot;zh&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">    chunk = chunk.replace(chunk[result.start:result.end], <span class="string">&quot;[REDACTED]&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-APIé˜²æŠ¤"><a href="#2-APIé˜²æŠ¤" class="headerlink" title="2. APIé˜²æŠ¤"></a>2. <strong>APIé˜²æŠ¤</strong></h4><ul>
<li><strong>é™æµ</strong>ï¼šFastAPIçš„<code>slowapi</code>ä¸­é—´ä»¶</li>
<li><strong>é‰´æƒ</strong>ï¼šJWTä»¤ç‰ŒéªŒè¯<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer</span><br><span class="line"></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/secure_query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">secure_query</span>(<span class="params">query: Query, token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    <span class="comment"># éªŒè¯é€»è¾‘...</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="ä¸ƒã€æˆæœ¬ä¼˜åŒ–ç­–ç•¥"><a href="#ä¸ƒã€æˆæœ¬ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="ä¸ƒã€æˆæœ¬ä¼˜åŒ–ç­–ç•¥"></a><strong>ä¸ƒã€æˆæœ¬ä¼˜åŒ–ç­–ç•¥</strong></h3><h4 id="1-OpenAI-APIæˆæœ¬æ§åˆ¶"><a href="#1-OpenAI-APIæˆæœ¬æ§åˆ¶" class="headerlink" title="1. OpenAI APIæˆæœ¬æ§åˆ¶"></a>1. <strong>OpenAI APIæˆæœ¬æ§åˆ¶</strong></h4><table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>èŠ‚çœæ•ˆæœ</th>
<th>å®ç°æ–¹æ³•</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å°æ¨¡å‹ä¼˜å…ˆ</strong></td>
<td>å‡å°‘50%æˆæœ¬</td>
<td>å…ˆç”¨GPT-3.5ç”Ÿæˆè‰ç¨¿ï¼ŒGPT-4ä»…åšæ¶¦è‰²</td>
</tr>
<tr>
<td><strong>ç¼“å­˜ç»“æœ</strong></td>
<td>å‡å°‘30%é‡å¤è°ƒç”¨</td>
<td>Rediså­˜å‚¨&lt;query,answer&gt;å¯¹ï¼Œè®¾ç½®TTL&#x3D;24å°æ—¶</td>
</tr>
<tr>
<td><strong>æ‰¹é‡å¤„ç†</strong></td>
<td>é™ä½å•ä½æˆæœ¬</td>
<td>ç´¯è®¡å¤šä¸ªæŸ¥è¯¢åç»Ÿä¸€å‘é€ï¼ˆé€‚åˆå¼‚æ­¥åœºæ™¯ï¼‰</td>
</tr>
</tbody></table>
<h4 id="2-è®¡ç®—èµ„æºä¼˜åŒ–"><a href="#2-è®¡ç®—èµ„æºä¼˜åŒ–" class="headerlink" title="2. è®¡ç®—èµ„æºä¼˜åŒ–"></a>2. <strong>è®¡ç®—èµ„æºä¼˜åŒ–</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FAISSå†…å­˜ä¼˜åŒ–é…ç½®</span></span><br><span class="line">index = faiss.IndexIVFPQ(</span><br><span class="line">    faiss.IndexFlatL2(d),</span><br><span class="line">    d,</span><br><span class="line">    nlist=<span class="number">100</span>,</span><br><span class="line">    m=<span class="number">8</span>,</span><br><span class="line">    bits=<span class="number">8</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="å…«ã€å…¸å‹é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#å…«ã€å…¸å‹é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…«ã€å…¸å‹é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a><strong>å…«ã€å…¸å‹é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></h3><h4 id="1-é•¿ä¸Šä¸‹æ–‡ä¸¢å¤±é‡ç‚¹"><a href="#1-é•¿ä¸Šä¸‹æ–‡ä¸¢å¤±é‡ç‚¹" class="headerlink" title="1. é•¿ä¸Šä¸‹æ–‡ä¸¢å¤±é‡ç‚¹"></a>1. <strong>é•¿ä¸Šä¸‹æ–‡ä¸¢å¤±é‡ç‚¹</strong></h4><ul>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šæ·»åŠ é‡è¦æ€§æ ‡æ³¨<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mark_important</span>(<span class="params">chunk</span>):</span><br><span class="line">    importance = client.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">        messages=[&#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, </span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;ç»™æ–‡æœ¬é‡è¦æ€§æ‰“åˆ†(1-5):\n&quot;</span> + chunk</span><br><span class="line">        &#125;]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;[é‡è¦æ€§:<span class="subst">&#123;importance&#125;</span>] <span class="subst">&#123;chunk&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-å¤šæ–‡æ¡£å†²çª"><a href="#2-å¤šæ–‡æ¡£å†²çª" class="headerlink" title="2. å¤šæ–‡æ¡£å†²çª"></a>2. <strong>å¤šæ–‡æ¡£å†²çª</strong></h4><ul>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåŸºäºæ—¶é—´åŠ æƒ<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨æ£€ç´¢ç»“æœä¸­ç»™è¾ƒæ–°æ–‡æ¡£æ›´é«˜æƒé‡</span></span><br><span class="line">newest_date = <span class="built_in">max</span>(doc.dates <span class="keyword">for</span> doc <span class="keyword">in</span> docs)</span><br><span class="line"><span class="keyword">for</span> doc <span class="keyword">in</span> retrieved_docs:</span><br><span class="line">    doc.score *= (<span class="number">0.5</span> + <span class="number">0.5</span>*(doc.date - oldest_date)/(newest_date - oldest_date))</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="ä¹ã€æ¼”è¿›è·¯çº¿å»ºè®®"><a href="#ä¹ã€æ¼”è¿›è·¯çº¿å»ºè®®" class="headerlink" title="ä¹ã€æ¼”è¿›è·¯çº¿å»ºè®®"></a><strong>ä¹ã€æ¼”è¿›è·¯çº¿å»ºè®®</strong></h3><ol>
<li><strong>çŸ­æœŸï¼ˆ1ä¸ªæœˆï¼‰</strong>ï¼š<ul>
<li>å®ç°åŸºç¡€RAGæµç¨‹</li>
<li>å»ºç«‹ç›‘æ§çœ‹æ¿</li>
</ul>
</li>
<li><strong>ä¸­æœŸï¼ˆ3ä¸ªæœˆï¼‰</strong>ï¼š<ul>
<li>åŠ å…¥é‡æ’åºæ¨¡å‹ï¼ˆå¦‚BAAI&#x2F;bge-rerankerï¼‰</li>
<li>å®ç°æ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯+å‘é‡ï¼‰</li>
</ul>
</li>
<li><strong>é•¿æœŸï¼ˆ6ä¸ªæœˆ+ï¼‰</strong>ï¼š<ul>
<li>å¾®è°ƒé¢†åŸŸä¸“ç”¨embeddingæ¨¡å‹</li>
<li>æ„å»ºç«¯åˆ°ç«¯è¯„ä¼°ä½“ç³»ï¼ˆRAGASæ¡†æ¶ï¼‰</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2025/04/28/A-sample-ABI-of-CCBusERC20-contract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/28/A-sample-ABI-of-CCBusERC20-contract/" class="post-title-link" itemprop="url">A sample ABI of CCBusERC20 contract</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-28 17:55:15" itemprop="dateCreated datePublished" datetime="2025-04-28T17:55:15-04:00">2025-04-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-21 16:23:35" itemprop="dateModified" datetime="2025-11-21T16:23:35-05:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/" itemprop="url" rel="index"><span itemprop="name">Cypto Currency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/" itemprop="url" rel="index"><span itemprop="name">Ethereum</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Cypto-Currency/Ethereum/Data-Structure/" itemprop="url" rel="index"><span itemprop="name">Data Structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>For the ABI of <code>CCBusERC20</code>, you should include <strong>all public and external methods</strong> that you want to be accessible from outside the contract. This includes:</p>
<ol>
<li><strong>All methods from IERC20 interface</strong> (required for ERC20 compliance)</li>
<li><strong>Any additional public methods</strong> specific to your contract</li>
<li><strong>Events</strong> that you want to be queryable</li>
<li><strong>Constructor</strong> (only needed for deployment)</li>
</ol>
<p>Hereâ€™s what should be included based on your contract:</p>
<h3 id="Required-Methods-from-IERC20"><a href="#Required-Methods-from-IERC20" class="headerlink" title="Required Methods (from IERC20):"></a>Required Methods (from IERC20):</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;function decimals() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function symbol() view returns (string)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function name() view returns (string)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function totalSupply() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function balanceOf(address) view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function transfer(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function allowance(address, address) view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function approve(address, uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function transferFrom(address, address, uint256)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Additional-Public-Methods-from-CCBusERC20"><a href="#Additional-Public-Methods-from-CCBusERC20" class="headerlink" title="Additional Public Methods (from CCBusERC20):"></a>Additional Public Methods (from CCBusERC20):</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;function deadAddress() view returns (address)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function decreaseAllowance(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function getCirculatingSupply() view returns (uint256)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function increaseAllowance(address, uint256) returns (bool)&quot;</span>,</span><br><span class="line"><span class="string">&quot;function owner() view returns (address)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Events"><a href="#Events" class="headerlink" title="Events:"></a>Events:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span>,</span><br><span class="line"><span class="string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Constructor"><a href="#Constructor" class="headerlink" title="Constructor:"></a>Constructor:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;constructor(string[] stringParams, address[] addressParams, uint256[] numberParams, bool[] boolParams)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Your-current-ABI-is-correct-and-complete"><a href="#Your-current-ABI-is-correct-and-complete" class="headerlink" title="Your current ABI is correct and complete:"></a>Your current ABI is correct and complete:</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> abiCCBusERC20 = [</span><br><span class="line">  <span class="string">&quot;constructor(string[] stringParams, address[] addressParams, uint256[] numberParams, bool[] boolParams)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;event Approval(address indexed owner, address indexed spender, uint256 value)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;event Transfer(address indexed from, address indexed to, uint256 value)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function allowance(address owner, address spender) view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function approve(address spender, uint256 amount)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function balanceOf(address account) view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function deadAddress() view returns (address)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function decimals() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function decreaseAllowance(address spender, uint256 subtractedValue) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function getCirculatingSupply() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function increaseAllowance(address spender, uint256 addedValue) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function name() view returns (string)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function owner() view returns (address)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function symbol() view returns (string)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function totalSupply() view returns (uint256)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function transfer(address recipient, uint256 amount) returns (bool)&quot;</span>,</span><br><span class="line">  <span class="string">&quot;function transferFrom(address sender, address recipient, uint256 amount)&quot;</span></span><br><span class="line">] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br></pre></td></tr></table></figure>

<h3 id="What-to-exclude"><a href="#What-to-exclude" class="headerlink" title="What to exclude:"></a>What to exclude:</h3><ul>
<li>Internal&#x2F;private methods (<code>_approve</code>, <code>_transfer</code>, <code>_basicTransfer</code>, <code>_msgSender</code>, <code>_msgData</code>)</li>
<li>Library functions (SafeMath, Address)</li>
<li>The <code>receive()</code> function (special fallback function doesnâ€™t need ABI entry)</li>
</ul>
<h3 id="CCBusERC20-sol"><a href="#CCBusERC20-sol" class="headerlink" title="CCBusERC20.sol"></a>CCBusERC20.sol</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Created By: CC-Bus</span></span><br><span class="line"><span class="comment">//  Website: https://ccbus.cc</span></span><br><span class="line"><span class="comment">//  Telegram: https://t.me/CCBus</span></span><br><span class="line"><span class="comment">//  The Best Tool for Token Management</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Context</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_msgSender</span>(<span class="params"></span>) internal view <span class="title function_">returns</span> (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">payable</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_msgData</span>(<span class="params"></span>) internal view <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="variable language_">this</span>; <span class="comment">// silence state mutability warning without generating bytecode - see https://github.com/ethereum/solidity/issues/2691</span></span><br><span class="line">        <span class="keyword">return</span> msg.<span class="property">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">library <span class="title class_">SafeMath</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        uint256 c = a + b;</span><br><span class="line">        <span class="built_in">require</span>(c &gt;= a, <span class="string">&quot;SafeMath: addition overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">sub</span>(a, b, <span class="string">&quot;SafeMath: subtraction overflow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b &lt;= a, errorMessage);</span><br><span class="line">        uint256 c = a - b;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mul</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint256 c = a * b;</span><br><span class="line">        <span class="built_in">require</span>(c / a == b, <span class="string">&quot;SafeMath: multiplication overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">div</span>(a, b, <span class="string">&quot;SafeMath: division by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">div</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b &gt; <span class="number">0</span>, errorMessage);</span><br><span class="line">        uint256 c = a / b;</span><br><span class="line">        <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mod</span>(<span class="params">uint256 a, uint256 b</span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mod</span>(a, b, <span class="string">&quot;SafeMath: modulo by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mod</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uint256 a,</span></span><br><span class="line"><span class="params">        uint256 b,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal pure <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(b != <span class="number">0</span>, errorMessage);</span><br><span class="line">        <span class="keyword">return</span> a % b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">library <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">isContract</span>(<span class="params">address account</span>) internal view <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line"></span><br><span class="line">        bytes32 codehash;</span><br><span class="line">        bytes32 accountHash = <span class="number">0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470</span>;</span><br><span class="line"></span><br><span class="line">        assembly &#123;</span><br><span class="line">            codehash := <span class="title function_">extcodehash</span>(account)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (codehash != accountHash &amp;&amp; codehash != <span class="number">0x0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sendValue</span>(<span class="params">address payable recipient, uint256 amount</span>) internal &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= amount,</span><br><span class="line">            <span class="string">&quot;Address: insufficient balance&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// solhint-disable-next-line avoid-low-level-calls, avoid-call-value</span></span><br><span class="line">        (bool success, ) = recipient.<span class="property">call</span>&#123;<span class="attr">value</span>: amount&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            success,</span><br><span class="line">            <span class="string">&quot;Address: unable to send value, recipient may have reverted&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCall</span>(<span class="params">address target, bytes memory data</span>)</span><br><span class="line">        internal</span><br><span class="line">        <span class="title function_">returns</span> (bytes memory)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">functionCall</span>(target, data, <span class="string">&quot;Address: low-level call failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCall</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_functionCallWithValue</span>(target, data, <span class="number">0</span>, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 value</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">            <span class="title function_">functionCallWithValue</span>(</span><br><span class="line">                target,</span><br><span class="line">                data,</span><br><span class="line">                value,</span><br><span class="line">                <span class="string">&quot;Address: low-level call with value failed&quot;</span></span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 value,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= value,</span><br><span class="line">            <span class="string">&quot;Address: insufficient balance for call&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_functionCallWithValue</span>(target, data, value, errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_functionCallWithValue</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address target,</span></span><br><span class="line"><span class="params">        bytes memory data,</span></span><br><span class="line"><span class="params">        uint256 weiValue,</span></span><br><span class="line"><span class="params">        <span class="built_in">string</span> memory errorMessage</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> <span class="title function_">returns</span> (bytes memory) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">isContract</span>(target), <span class="string">&quot;Address: call to non-contract&quot;</span>);</span><br><span class="line"></span><br><span class="line">        (bool success, bytes memory returndata) = target.<span class="property">call</span>&#123;<span class="attr">value</span>: weiValue&#125;(</span><br><span class="line">            data</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="keyword">return</span> returndata;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (returndata.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                assembly &#123;</span><br><span class="line">                    <span class="keyword">let</span> returndata_size := <span class="title function_">mload</span>(returndata)</span><br><span class="line">                    <span class="title function_">revert</span>(<span class="title function_">add</span>(<span class="number">32</span>, returndata), returndata_size)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">revert</span>(errorMessage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IERC20</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decimals</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">symbol</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (<span class="built_in">string</span> memory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (<span class="built_in">string</span> memory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address who</span>) external view <span class="title function_">returns</span> (uint);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) external <span class="title function_">returns</span> (bool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allowance</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner,</span></span><br><span class="line"><span class="params">        address spender</span></span><br><span class="line"><span class="params">    </span>) external view <span class="title function_">returns</span> (uint256);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address _spender, uint _value</span>) external;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address _from, address _to, uint _value</span>) external ;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">Transfer</span>(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);</span><br><span class="line">    event <span class="title class_">Approval</span>(</span><br><span class="line">        address indexed owner,</span><br><span class="line">        address indexed spender,</span><br><span class="line">        uint256 value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract <span class="title class_">CCBusToken</span> is <span class="title class_">Context</span>, <span class="title class_">IERC20</span>&#123;</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> <span class="keyword">private</span> _name;</span><br><span class="line">    <span class="built_in">string</span> <span class="keyword">private</span> _symbol;</span><br><span class="line">    uint256 <span class="keyword">private</span> _decimals;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) _balances;</span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256)) <span class="keyword">private</span> _allowances;</span><br><span class="line"></span><br><span class="line">    address <span class="keyword">public</span> immutable deadAddress =</span><br><span class="line">        <span class="number">0x000000000000000000000000000000000000dEaD</span>;</span><br><span class="line">    uint256 <span class="keyword">private</span> _totalSupply;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"> </span></span><br><span class="line"><span class="params">        <span class="built_in">string</span>[] memory stringParams,</span></span><br><span class="line"><span class="params">        address[] memory addressParams,</span></span><br><span class="line"><span class="params">        uint256[] memory numberParams,</span></span><br><span class="line"><span class="params">        bool[] memory boolParams</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(addressParams.<span class="property">length</span>==<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">require</span>(boolParams.<span class="property">length</span>==<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        address receiveAddr = tx.<span class="property">origin</span>;</span><br><span class="line">        _name = stringParams[<span class="number">0</span>];</span><br><span class="line">        _symbol = stringParams[<span class="number">1</span>];</span><br><span class="line">        _decimals = numberParams[<span class="number">0</span>];</span><br><span class="line">        _totalSupply = numberParams[<span class="number">1</span>];</span><br><span class="line">        _balances[receiveAddr] = _totalSupply;</span><br><span class="line">        emit <span class="title class_">Transfer</span>(<span class="title function_">address</span>(<span class="number">0</span>), receiveAddr, _totalSupply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">name</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (<span class="built_in">string</span> memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">symbol</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (<span class="built_in">string</span> memory) &#123;</span><br><span class="line">        <span class="keyword">return</span> _symbol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decimals</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _decimals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">totalSupply</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">owner</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="title function_">returns</span> (address) &#123;</span><br><span class="line">        <span class="keyword">return</span> deadAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) <span class="keyword">public</span> view <span class="keyword">override</span> <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _balances[account];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allowance</span>(<span class="params">address owner1, address spender</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        view</span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        <span class="title function_">returns</span> (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _allowances[owner1][spender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">increaseAllowance</span>(<span class="params">address spender, uint256 addedValue</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        virtual</span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            spender,</span><br><span class="line">            _allowances[<span class="title function_">_msgSender</span>()][spender].<span class="title function_">add</span>(addedValue)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">decreaseAllowance</span>(<span class="params">address spender, uint256 subtractedValue</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        virtual</span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            spender,</span><br><span class="line">            _allowances[<span class="title function_">_msgSender</span>()][spender].<span class="title function_">sub</span>(</span><br><span class="line">                subtractedValue,</span><br><span class="line">                <span class="string">&quot;ERC20: decreased allowance below zero&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">approve</span>(<span class="params">address spender, uint256 amount</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_approve</span>(<span class="title function_">_msgSender</span>(), spender, amount);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_approve</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address owner1,</span></span><br><span class="line"><span class="params">        address spender,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> &#123;</span><br><span class="line">        <span class="built_in">require</span>(owner1 != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(spender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: approve to the zero address&quot;</span>);</span><br><span class="line"></span><br><span class="line">        _allowances[owner1][spender] = amount;</span><br><span class="line">        emit <span class="title class_">Approval</span>(owner1, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getCirculatingSupply</span>(<span class="params"></span>) <span class="keyword">public</span> view <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> _totalSupply.<span class="title function_">sub</span>(<span class="title function_">balanceOf</span>(deadAddress));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//to recieve ETH from uniswapV2Router when swaping</span></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address recipient, uint256 amount</span>)</span><br><span class="line">        <span class="keyword">public</span></span><br><span class="line">        <span class="keyword">override</span></span><br><span class="line">        <span class="title function_">returns</span> (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(<span class="title function_">_msgSender</span>(), recipient, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">public</span> <span class="keyword">override</span>  &#123;</span><br><span class="line">        <span class="title function_">_transfer</span>(sender, recipient, amount);</span><br><span class="line">        <span class="title function_">_approve</span>(</span><br><span class="line">            sender,</span><br><span class="line">            <span class="title function_">_msgSender</span>(),</span><br><span class="line">            _allowances[sender][<span class="title function_">_msgSender</span>()].<span class="title function_">sub</span>(</span><br><span class="line">                amount,</span><br><span class="line">                <span class="string">&quot;ERC20: transfer amount exceeds allowance&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_transfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) <span class="keyword">private</span> <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line">        <span class="built_in">require</span>(sender != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: transfer from the zero address&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(recipient != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;ERC20: transfer to the zero address&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_basicTransfer</span>(sender, recipient, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_basicTransfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        address recipient,</span></span><br><span class="line"><span class="params">        uint256 amount</span></span><br><span class="line"><span class="params">    </span>) internal <span class="title function_">returns</span> (bool) &#123;</span><br><span class="line">        _balances[sender] = _balances[sender].<span class="title function_">sub</span>(</span><br><span class="line">            amount,</span><br><span class="line">            <span class="string">&quot;Insufficient Balance&quot;</span></span><br><span class="line">        );</span><br><span class="line">        _balances[recipient] = _balances[recipient].<span class="title function_">add</span>(amount);</span><br><span class="line">        emit <span class="title class_">Transfer</span>(sender, recipient, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
