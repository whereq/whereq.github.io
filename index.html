<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.whereq.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="WhereQ">
<meta property="og:url" content="https://www.whereq.com/index.html">
<meta property="og:site_name" content="WhereQ">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dazhi Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.whereq.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WhereQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">WhereQ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-articles"><a href="/articles/" rel="section"><i class="fa fa-file fa-fw"></i>Articles</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dazhi Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Deep-Dive-into-Executors-and-ThreadPoolExecutor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Deep-Dive-into-Executors-and-ThreadPoolExecutor/" class="post-title-link" itemprop="url">Deep Dive into Executors and ThreadPoolExecutor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 11:08:29 / Modified: 11:17:08" itemprop="dateCreated datePublished" datetime="2024-10-29T11:08:29-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-overview-of-thread-pool-scaling-strategies">1. Overview of Thread Pool Scaling Strategies</a></li>
<li><a href="#2-fixedthreadpool---predictable-task-loads">2. FixedThreadPool - Predictable Task Loads</a></li>
<li><a href="#3-cachedthreadpool---unpredictable-short-lived-tasks">3. CachedThreadPool - Unpredictable, Short-Lived Tasks</a></li>
<li><a href="#4-dynamic-scaling-with-flexible-configuration">4. Dynamic Scaling with Flexible Configuration</a></li>
<li><a href="#5-thread-pool-strategy-decision">5. Thread Pool Strategy Decision</a></li>
<li><a href="#6-drawbacks-of-using-executors-to-create-thread-pools">6. Drawbacks of Using <code>Executors</code> to Create Thread Pools</a></li>
<li><a href="#7-best-practices-solution-using-threadpoolexecutor-directly">7. Best Practices Solution: Using <code>ThreadPoolExecutor</code> Directly</a></li>
<li><a href="#8-threadpoolexecutor-with-best-practice-configurations">8. <code>ThreadPoolExecutor</code> with Best Practice Configurations</a></li>
<li><a href="#9-summary">9. Summary</a></li>
</ul>
<hr>
<p>Scaling a <strong>thread pool</strong> efficiently is essential to balance resource usage with workload demands, ensuring performance without over-provisioning or exhausting system resources. Below are common scaling strategies, including scenarios for using each and detailed production code examples with comments.</p>
<p><a name="1-overview-thread-pool-scaling-strategies"></a></p>
<h3 id="1-Overview-of-Thread-Pool-Scaling-Strategies"><a href="#1-Overview-of-Thread-Pool-Scaling-Strategies" class="headerlink" title="1. Overview of Thread Pool Scaling Strategies"></a>1. Overview of Thread Pool Scaling Strategies</h3><p>In thread pool management, the primary goal is to allocate <strong>just enough threads</strong> to handle tasks effectively without overloading the CPU or running into resource constraints. The <strong>Executor framework</strong> in Java provides tools for <strong>dynamic scaling</strong> via multiple built-in pool types and strategies, such as <code>FixedThreadPool</code> for predictable workloads and <code>CachedThreadPool</code> for on-demand scaling.</p>
<hr>
<p><a name="2-fixedthreadpool-predictable-task-loads"></a></p>
<h3 id="2-FixedThreadPool-Predictable-Task-Loads"><a href="#2-FixedThreadPool-Predictable-Task-Loads" class="headerlink" title="2. FixedThreadPool - Predictable Task Loads"></a>2. FixedThreadPool - Predictable Task Loads</h3><p>For workloads where the number of concurrent tasks is consistent or predictable, using a <code>FixedThreadPool</code> is efficient. The pool is created with a predefined number of threads, ensuring no new threads are added or removed during runtime. This strategy is suitable for <strong>batch processing</strong> or tasks with <strong>steady arrival rates</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="comment">// Define a pool with a fixed number of threads for predictable task load</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_POOL_SIZE</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(THREAD_POOL_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Simulate task submission to the fixed thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executorService.submit(() -&gt; processTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the executor service to release resources after processing</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">processTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Processing Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulating task processing duration</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Explanation:</strong></p>
<ul>
<li>A <strong>fixed number of threads</strong> (5) handle the tasks sequentially.</li>
<li>The executor will <strong>reuse threads</strong>, limiting thread creation overhead.</li>
<li>The <strong><code>shutdown</code> method</strong> releases resources once all tasks complete.</li>
</ul>
<p><strong>Advantages:</strong> Predictable memory usage and better <strong>performance control</strong> for tasks with a steady rate.</p>
<hr>
<p><a name="cachedthreadpool-unpredictable-short-lived-tasks"></a></p>
<h3 id="3-CachedThreadPool-Unpredictable-Short-Lived-Tasks"><a href="#3-CachedThreadPool-Unpredictable-Short-Lived-Tasks" class="headerlink" title="3. CachedThreadPool - Unpredictable, Short-Lived Tasks"></a>3. CachedThreadPool - Unpredictable, Short-Lived Tasks</h3><p>A <code>CachedThreadPool</code> dynamically adjusts the pool size depending on task demand. This pool is ideal for handling <strong>bursty</strong> or <strong>sporadic loads</strong>. Threads are created as needed and, if idle, removed after a timeout period, allowing the system to scale back.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachedThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="comment">// Using CachedThreadPool for sporadic and short-lived tasks</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Simulate submitting bursty tasks</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executorService.submit(() -&gt; handleBurstTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown executor once all tasks are completed</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleBurstTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling Burst Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulating brief processing</span></span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Explanation:</strong></p>
<ul>
<li>The <code>CachedThreadPool</code> <strong>adds threads on demand</strong> up to <code>Integer.MAX_VALUE</code>, suitable for short-lived tasks.</li>
<li>Threads that are <strong>idle for 60 seconds</strong> are removed, preventing memory buildup.</li>
<li>Ideal for systems that handle <strong>irregular spikes</strong> without knowing task demand in advance.</li>
</ul>
<p><strong>Advantages:</strong> Scalability and flexibility for <strong>dynamic task arrival rates</strong>.</p>
<hr>
<p><a name="4-dynamic-scaling-with-flexible-configuration"></a></p>
<h3 id="4-Dynamic-Scaling-with-Flexible-Configuration"><a href="#4-Dynamic-Scaling-with-Flexible-Configuration" class="headerlink" title="4. Dynamic Scaling with Flexible Configuration"></a>4. Dynamic Scaling with Flexible Configuration</h3><p>In a production environment, scaling thread pools dynamically may involve using the <code>ThreadPoolExecutor</code> with customized parameters, such as adjustable core pool size and task queue types. This allows for <strong>on-the-fly adjustments</strong> based on real-time performance metrics.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicThreadPoolScaling</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Custom ThreadPoolExecutor with flexible parameters for dynamic scaling</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">2</span>, <span class="comment">// corePoolSize</span></span><br><span class="line">            <span class="number">10</span>, <span class="comment">// maximumPoolSize</span></span><br><span class="line">            <span class="number">60L</span>, <span class="comment">// keepAliveTime</span></span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">5</span>), <span class="comment">// workQueue</span></span><br><span class="line">            Executors.defaultThreadFactory(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// Rejection policy</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executor.submit(() -&gt; performDynamicTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shut down the executor after tasks completion</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">performDynamicTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Performing Dynamic Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Explanation of Parameters:</strong></p>
<ul>
<li><code>corePoolSize</code>: Defines the <strong>minimum</strong> number of threads.</li>
<li><code>maximumPoolSize</code>: Sets a <strong>scalable limit</strong> for threads.</li>
<li><code>LinkedBlockingQueue</code>: Limits task queue to prevent memory overflows.</li>
<li><code>CallerRunsPolicy</code>: Ensures tasks run in the caller’s thread if limits are reached, providing <strong>backpressure control</strong>.</li>
</ul>
<hr>
<p><a name="5-thread-pool-strategy-decision"></a></p>
<h3 id="5-Thread-Pool-Strategy-Decision"><a href="#5-Thread-Pool-Strategy-Decision" class="headerlink" title="5. Thread Pool Strategy Decision"></a>5. Thread Pool Strategy Decision</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        +-------------------------+</span><br><span class="line">        |  Task Load Predictable? |</span><br><span class="line">        +-----------+-------------+</span><br><span class="line">                    |</span><br><span class="line">                    |</span><br><span class="line">           Yes      |       No</span><br><span class="line">         +----------+------------+</span><br><span class="line">         |                       |</span><br><span class="line"> +-------v----------+     +------v------------+</span><br><span class="line"> |  FixedThreadPool |     |  CachedThreadPool |</span><br><span class="line"> +-------+----------+     +-----+-------------+</span><br><span class="line">         |                      |</span><br><span class="line">         |                      |</span><br><span class="line">Use if tasks are steady    Use if tasks are bursty or</span><br><span class="line">and concurrent             unpredictable</span><br></pre></td></tr></table></figure>

<p>Using <code>Executors</code> to create thread pools (e.g., via <code>Executors.newFixedThreadPool()</code> or <code>Executors.newCachedThreadPool()</code>) is convenient but introduces hidden risks and drawbacks in certain production scenarios. Let’s look at the specific drawbacks and explore best practices for mitigating these issues.</p>
<hr>
<p><a name="6-drawbacks-of-using-executors-to-create-thread-pools"></a></p>
<h3 id="6-Drawbacks-of-Using-Executors-to-Create-Thread-Pools"><a href="#6-Drawbacks-of-Using-Executors-to-Create-Thread-Pools" class="headerlink" title="6. Drawbacks of Using Executors to Create Thread Pools"></a>6. Drawbacks of Using <code>Executors</code> to Create Thread Pools</h3><ol>
<li><p><strong>Unbounded Queue with <code>newFixedThreadPool</code></strong>:</p>
<ul>
<li>The <code>newFixedThreadPool(int nThreads)</code> method uses a <strong><code>LinkedBlockingQueue</code></strong> without a maximum size limit for its task queue. This <strong>unbounded queue</strong> can lead to <strong>memory exhaustion</strong> if tasks are submitted faster than they can be processed.</li>
<li>When a large number of tasks are added, the queue will keep growing, which can lead to <strong>OutOfMemoryError</strong> and system instability.</li>
</ul>
</li>
<li><p><strong>Unbounded Thread Creation in <code>newCachedThreadPool</code></strong>:</p>
<ul>
<li>The <code>newCachedThreadPool()</code> uses a <strong><code>SynchronousQueue</code></strong> that directly hands off tasks to threads. If no threads are idle to handle new tasks, it <strong>creates new threads</strong> up to <code>Integer.MAX_VALUE</code>.</li>
<li>With a high load, this pool may create excessive threads, leading to <strong>CPU saturation</strong> and potential <strong>memory exhaustion</strong>, especially in long-running applications.</li>
</ul>
</li>
<li><p><strong>Lack of Control Over Rejection Policy</strong>:</p>
<ul>
<li>The methods in <code>Executors</code> do not allow explicit configuration of <strong>rejection policies</strong> for when tasks exceed pool capacity. Default policies can fail to handle high-load scenarios gracefully, often leading to performance degradation and unhandled task rejections.</li>
</ul>
</li>
<li><p><strong>Harder to Manage Idle Threads</strong>:</p>
<ul>
<li>For pools like <code>newCachedThreadPool</code>, idle threads remain for a default <strong>60 seconds</strong> before being terminated. While this may be appropriate for some workloads, it can lead to inefficiencies in scenarios where <strong>shorter idle times</strong> would conserve resources.</li>
</ul>
</li>
</ol>
<hr>
<p><a name="7-best-practices-solution-using-threadpoolexecutor-directly"></a></p>
<h3 id="7-Best-Practices-Solution-Using-ThreadPoolExecutor-Directly"><a href="#7-Best-Practices-Solution-Using-ThreadPoolExecutor-Directly" class="headerlink" title="7. Best Practices Solution: Using ThreadPoolExecutor Directly"></a>7. Best Practices Solution: Using <code>ThreadPoolExecutor</code> Directly</h3><p>To avoid these pitfalls, it’s best to directly instantiate a <code>ThreadPoolExecutor</code> where you can <strong>explicitly configure</strong> the task queue size, rejection policies, and timeout values. Here’s how to address each issue with recommended configurations:</p>
<ol>
<li><p><strong>Configure Bounded Queues to Prevent Memory Leaks</strong>:</p>
<ul>
<li>Use a bounded task queue, like <code>ArrayBlockingQueue</code> or a sized <code>LinkedBlockingQueue</code>, to <strong>control the number of waiting tasks</strong> and prevent out-of-memory errors.</li>
<li>This limits the number of tasks waiting in the queue, ensuring system stability by capping memory use.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    corePoolSize,</span><br><span class="line">    maxPoolSize,</span><br><span class="line">    keepAliveTime,</span><br><span class="line">    TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(queueSize)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Limit Thread Growth to Prevent Resource Exhaustion</strong>:</p>
<ul>
<li>Use a capped <code>maximumPoolSize</code> when tasks can surge unexpectedly. Setting a limit, e.g., based on the number of available CPU cores, helps prevent CPU saturation.</li>
<li>For highly concurrent applications, you can use dynamic sizing strategies with <strong>monitoring metrics</strong> (like CPU and memory usage) to inform adjustments to pool parameters.</li>
</ul>
</li>
<li><p><strong>Explicitly Set Rejection Policies</strong>:</p>
<ul>
<li>When tasks exceed the pool’s capacity, control the pool’s behavior with rejection policies. <code>ThreadPoolExecutor</code> provides options like <code>CallerRunsPolicy</code>, <code>DiscardPolicy</code>, and <code>DiscardOldestPolicy</code>:<ul>
<li><strong>CallerRunsPolicy</strong>: Executes tasks in the caller thread, which helps slow down task submissions under heavy load.</li>
<li><strong>DiscardOldestPolicy</strong>: Removes the oldest queued task, making room for newer, high-priority tasks.</li>
</ul>
</li>
<li>This choice depends on your application’s tolerance for unprocessed tasks.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    corePoolSize,</span><br><span class="line">    maxPoolSize,</span><br><span class="line">    keepAliveTime,</span><br><span class="line">    TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(queueSize),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Adjust Idle Timeout for Cached Threads</strong>:</p>
<ul>
<li>For pools similar to <code>CachedThreadPool</code>, customize the <strong>idle timeout</strong> to conserve resources by releasing threads sooner when they are not needed. <code>ThreadPoolExecutor</code> allows control over idle time with <code>setKeepAliveTime</code>.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">cachedPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">    <span class="number">30L</span>, TimeUnit.SECONDS, <span class="comment">// Reduced keep-alive time</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;(),</span><br><span class="line">    Executors.defaultThreadFactory()</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p><a name="8-threadpoolexecutor-with-best-practice-configurations"></a></p>
<h3 id="8-ThreadPoolExecutor-with-Best-Practice-Configurations"><a href="#8-ThreadPoolExecutor-with-Best-Practice-Configurations" class="headerlink" title="8. ThreadPoolExecutor with Best Practice Configurations"></a>8. <code>ThreadPoolExecutor</code> with Best Practice Configurations</h3><p>Below is a best practice setup using <code>ThreadPoolExecutor</code> that incorporates bounded queues, a limited thread count, a suitable rejection policy, and a controlled idle timeout:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BestPracticeThreadPool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">createThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxPoolSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">keepAliveTime</span> <span class="operator">=</span> <span class="number">30L</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">queueCapacity</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                corePoolSize,</span><br><span class="line">                maxPoolSize,</span><br><span class="line">                keepAliveTime,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(queueCapacity),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// Rejection policy to handle overloads</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> createThreadPool();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submitting example tasks</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.submit(() -&gt; processTask(taskId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Properly shutdown to free resources</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">processTask</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Processing Task ID: &quot;</span> + taskId + <span class="string">&quot; with thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>); <span class="comment">// Simulate work</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Explanation of Configurations:</strong></p>
<ul>
<li><code>ArrayBlockingQueue</code> limits queue size to 50, managing memory consumption.</li>
<li><code>CallerRunsPolicy</code> applies backpressure to slow down submissions.</li>
<li><code>corePoolSize</code> and <code>maxPoolSize</code> control CPU utilization.</li>
<li><code>keepAliveTime</code> of 30 seconds clears idle threads efficiently.</li>
</ul>
<hr>
<p><a name="9-summary"></a></p>
<h3 id="9-Summary"><a href="#9-Summary" class="headerlink" title="9. Summary"></a>9. Summary</h3><p>Using <code>ThreadPoolExecutor</code> directly provides complete control over pool configurations:</p>
<ul>
<li><strong>Bounded queues</strong> prevent memory overflows.</li>
<li><strong>Limited threads</strong> avoid CPU exhaustion.</li>
<li><strong>Rejection policies</strong> ensure controlled behavior under load.</li>
<li><strong>Idle timeouts</strong> conserve system resources.</li>
</ul>
<p>These adjustments create a resilient and scalable thread pool setup suitable for high-performance, resource-intensive applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Programming-Standards-of-Java-Concurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Programming-Standards-of-Java-Concurrency/" class="post-title-link" itemprop="url">Programming Standards of Java Concurrency</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 00:56:32 / Modified: 01:04:22" itemprop="dateCreated datePublished" datetime="2024-10-29T00:56:32-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Concurrency/" itemprop="url" rel="index"><span itemprop="name">Concurrency</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Concurrency/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-thread-safety-in-singleton-objects">1. Thread Safety in Singleton Objects</a></li>
<li><a href="#2-meaningful-thread-naming">2. Meaningful Thread Naming</a></li>
<li><a href="#3-thread-pool-usage">3. Thread Pool Usage</a></li>
<li><a href="#4-explicit-threadpoolexecutor-configuration">4. Explicit ThreadPoolExecutor Configuration</a></li>
<li><a href="#5-thread-safe-date-formatting">5. Thread-Safe Date Formatting</a></li>
<li><a href="#6-threadlocal-variable-cleanup">6. ThreadLocal Variable Cleanup</a></li>
<li><a href="#7-locking-performance-considerations">7. Locking Performance Considerations</a></li>
<li><a href="#8-consistent-locking-order">8. Consistent Locking Order</a></li>
<li><a href="#9-exception-handling-in-locking">9. Exception Handling in Locking</a></li>
<li><a href="#10-optimistic-and-pessimistic-locking">10. Optimistic and Pessimistic Locking</a></li>
<li><a href="#11-scheduledexecutorservice-for-timed-tasks">11. ScheduledExecutorService for Timed Tasks</a></li>
<li><a href="#12-countdownlatch-for-synchronization">12. CountDownLatch for Synchronization</a></li>
<li><a href="#13-random-instance-management">13. Random Instance Management</a></li>
<li><a href="#14-double-checked-locking">14. Double-Checked Locking</a></li>
<li><a href="#15-volatile-and-atomic-operations">15. Volatile and Atomic Operations</a></li>
<li><a href="#16-hashmap-resize-risks">16. HashMap Resize Risks</a></li>
<li><a href="#17-threadlocal-usage">17. ThreadLocal Usage</a></li>
</ul>
<hr>
<p>Thread safety is a critical aspect of building robust and scalable Java applications. Ensuring that your application handles concurrent operations correctly can prevent many common issues such as race conditions, deadlocks, and data inconsistencies. This article provides best practices and detailed guidelines for achieving thread safety in Java applications.</p>
<hr>
<p><a name="1-thread-safety-in-singleton-objects"></a></p>
<h1 id="1-Thread-Safety-in-Singleton-Objects"><a href="#1-Thread-Safety-in-Singleton-Objects" class="headerlink" title="1. Thread Safety in Singleton Objects"></a>1. Thread Safety in Singleton Objects</h1><ul>
<li><strong>Requirement</strong>: Ensure that singleton objects and their methods are thread-safe.</li>
<li><strong>Explanation</strong>: Resource-driven classes, utility classes, and singleton factory classes must be thread-safe to prevent race conditions.</li>
</ul>
<p><a name="2-meaningful-thread-naming"></a></p>
<h1 id="2-Meaningful-Thread-Naming"><a href="#2-Meaningful-Thread-Naming" class="headerlink" title="2. Meaningful Thread Naming"></a>2. Meaningful Thread Naming</h1><ul>
<li><strong>Requirement</strong>: Assign meaningful names to threads and thread pools for easier debugging.</li>
<li><strong>Example</strong>: Custom thread factory with grouping based on external features (e.g., datacenter ID).</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">nextId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    UserThreadFactory(String whatFeaturOfGroup) &#123;</span><br><span class="line">        namePrefix = <span class="string">&quot;From UserThreadFactory&#x27;s &quot;</span> + whatFeaturOfGroup + <span class="string">&quot;-Worker-&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> namePrefix + nextId.getAndIncrement();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="literal">null</span>, task, name, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">        System.out.println(thread.getName());</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a name="3-thread-pool-usage"></a></p>
<h1 id="3-Thread-Pool-Usage"><a href="#3-Thread-Pool-Usage" class="headerlink" title="3. Thread Pool Usage"></a>3. Thread Pool Usage</h1><ul>
<li><strong>Requirement</strong>: Use thread pools instead of creating threads manually.</li>
<li><strong>Explanation</strong>: Thread pools reduce the overhead of thread creation and destruction, preventing resource exhaustion and excessive context switching.</li>
</ul>
<hr>
<p><a name="4-explicit-threadpoolexecutor-configuration"></a></p>
<h1 id="4-Explicit-ThreadPoolExecutor-Configuration"><a href="#4-Explicit-ThreadPoolExecutor-Configuration" class="headerlink" title="4. Explicit ThreadPoolExecutor Configuration"></a>4. Explicit ThreadPoolExecutor Configuration</h1><ul>
<li><strong>Requirement</strong>: Use <code>ThreadPoolExecutor</code> instead of <code>Executors</code> for creating thread pools.</li>
<li><strong>Explanation</strong>: <code>Executors</code> can lead to resource exhaustion due to unbounded queues and thread creation.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    corePoolSize, maxPoolSize, keepAliveTime, TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(queueCapacity),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">UserThreadFactory</span>(<span class="string">&quot;Datacenter-1&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="5-thread-safe-date-formatting"></a></p>
<h1 id="5-Thread-Safe-Date-Formatting"><a href="#5-Thread-Safe-Date-Formatting" class="headerlink" title="5. Thread-Safe Date Formatting"></a>5. Thread-Safe Date Formatting</h1><ul>
<li><strong>Requirement</strong>: Use thread-safe date formatting.</li>
<li><strong>Example</strong>: Use <code>ThreadLocal</code> for <code>SimpleDateFormat</code> or switch to <code>DateTimeFormatter</code> in JDK 8.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DateFormat&gt; df = ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>));</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="6-threadlocal-variable-cleanup"></a></p>
<h1 id="6-ThreadLocal-Variable-Cleanup"><a href="#6-ThreadLocal-Variable-Cleanup" class="headerlink" title="6. ThreadLocal Variable Cleanup"></a>6. ThreadLocal Variable Cleanup</h1><ul>
<li><strong>Requirement</strong>: Clean up <code>ThreadLocal</code> variables, especially in thread pools.</li>
<li><strong>Example</strong>: Use <code>try-finally</code> blocks to ensure cleanup.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">objectThreadLocal.set(userInfo);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    objectThreadLocal.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="7-locking-performance-considerations"></a></p>
<h1 id="7-Locking-Performance-Considerations"><a href="#7-Locking-Performance-Considerations" class="headerlink" title="7. Locking Performance Considerations"></a>7. Locking Performance Considerations</h1><ul>
<li><strong>Requirement</strong>: Minimize the performance impact of locks.</li>
<li><strong>Explanation</strong>: Prefer lock-free data structures, lock only necessary code blocks, and use object-level locks instead of class-level locks.</li>
</ul>
<hr>
<p><a name="8-consistent-locking-order"></a></p>
<h1 id="8-Consistent-Locking-Order"><a href="#8-Consistent-Locking-Order" class="headerlink" title="8. Consistent Locking Order"></a>8. Consistent Locking Order</h1><ul>
<li><strong>Requirement</strong>: Maintain consistent locking order to prevent deadlocks.</li>
<li><strong>Explanation</strong>: Ensure that all threads acquire locks in the same order to avoid circular wait conditions.</li>
</ul>
<hr>
<p><a name="9-exception-handling-in-locking"></a></p>
<h1 id="9-Exception-Handling-in-Locking"><a href="#9-Exception-Handling-in-Locking" class="headerlink" title="9. Exception Handling in Locking"></a>9. Exception Handling in Locking</h1><ul>
<li><strong>Requirement</strong>: Handle exceptions properly to avoid lock leaks.</li>
<li><strong>Example</strong>: Ensure that locks are released even if exceptions occur.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLocked</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line"><span class="keyword">if</span> (isLocked) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doSomething();</span><br><span class="line">        doOthers();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="10-optimistic-and-pessimistic-locking"></a></p>
<h1 id="10-Optimistic-and-Pessimistic-Locking"><a href="#10-Optimistic-and-Pessimistic-Locking" class="headerlink" title="10. Optimistic and Pessimistic Locking"></a>10. Optimistic and Pessimistic Locking</h1><ul>
<li><strong>Requirement</strong>: Use appropriate locking strategies based on conflict probability.</li>
<li><strong>Explanation</strong>: Use optimistic locking for low conflict scenarios and pessimistic locking for high conflict scenarios.</li>
</ul>
<hr>
<p><a name="11-scheduledexecutorservice-for-timed-tasks"></a></p>
<h1 id="11-ScheduledExecutorService-for-Timed-Tasks"><a href="#11-ScheduledExecutorService-for-Timed-Tasks" class="headerlink" title="11. ScheduledExecutorService for Timed Tasks"></a>11. ScheduledExecutorService for Timed Tasks</h1><ul>
<li><strong>Requirement</strong>: Use <code>ScheduledExecutorService</code> instead of <code>Timer</code> for concurrent timed tasks.</li>
<li><strong>Explanation</strong>: <code>Timer</code> can terminate all tasks if one throws an uncaught exception.</li>
</ul>
<hr>
<p><a name="12-countdownlatch-for-synchronization"></a></p>
<h1 id="12-CountDownLatch-for-Synchronization"><a href="#12-CountDownLatch-for-Synchronization" class="headerlink" title="12. CountDownLatch for Synchronization"></a>12. CountDownLatch for Synchronization</h1><ul>
<li><strong>Requirement</strong>: Use <code>CountDownLatch</code> for synchronization in multi-threaded tasks.</li>
<li><strong>Explanation</strong>: Ensure that all threads call <code>countDown</code> and handle exceptions to avoid blocking the main thread.</li>
</ul>
<hr>
<p><a name="13-random-instance-management"></a></p>
<h1 id="13-Random-Instance-Management"><a href="#13-Random-Instance-Management" class="headerlink" title="13. Random Instance Management"></a>13. Random Instance Management</h1><ul>
<li><strong>Requirement</strong>: Avoid sharing <code>Random</code> instances across threads.</li>
<li><strong>Example</strong>: Use <code>ThreadLocalRandom</code> in JDK 7+ or ensure each thread has its own <code>Random</code> instance.</li>
</ul>
<hr>
<p><a name="14-double-checked-locking"></a></p>
<h1 id="14-Double-Checked-Locking"><a href="#14-Double-Checked-Locking" class="headerlink" title="14. Double-Checked Locking"></a>14. Double-Checked Locking</h1><ul>
<li><strong>Requirement</strong>: Use <code>volatile</code> for double-checked locking to avoid initialization issues.</li>
<li><strong>Example</strong>: Declare the target variable as <code>volatile</code>.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">Helper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="15-volatile-and-atomic-operations"></a></p>
<h1 id="15-Volatile-and-Atomic-Operations"><a href="#15-Volatile-and-Atomic-Operations" class="headerlink" title="15. Volatile and Atomic Operations"></a>15. Volatile and Atomic Operations</h1><ul>
<li><strong>Requirement</strong>: Use <code>volatile</code> for one-write-many-read scenarios and <code>Atomic</code> classes for multi-write scenarios.</li>
<li><strong>Example</strong>: Use <code>AtomicInteger</code> or <code>LongAdder</code> for atomic operations.</li>
</ul>
<hr>
<p><a name="hashmap-resize-risks"></a></p>
<h1 id="16-HashMap-Resize-Risks"><a href="#16-HashMap-Resize-Risks" class="headerlink" title="16. HashMap Resize Risks"></a>16. HashMap Resize Risks</h1><ul>
<li><strong>Requirement</strong>: Be cautious of <code>HashMap</code> resizing in high-concurrency scenarios.</li>
<li><strong>Explanation</strong>: Resizing can lead to deadlocks and high CPU usage.</li>
</ul>
<hr>
<p><a name="threadlocal-usage"></a></p>
<h1 id="17-ThreadLocal-Usage"><a href="#17-ThreadLocal-Usage" class="headerlink" title="17. ThreadLocal Usage"></a>17. ThreadLocal Usage</h1><ul>
<li><strong>Requirement</strong>: Use <code>ThreadLocal</code> with static variables carefully.</li>
<li><strong>Explanation</strong>: <code>ThreadLocal</code> variables are shared within a thread but can cause issues if not managed properly.</li>
</ul>
<hr>
<p>By following these best practices, you can ensure that your Java application is thread-safe, scalable, and robust. These guidelines cover a wide range of scenarios, from basic thread safety to advanced concurrency patterns, helping you build high-performance applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/29/Deep-Dive-into-Spring-Boot-Multi-Threading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/29/Deep-Dive-into-Spring-Boot-Multi-Threading/" class="post-title-link" itemprop="url">Deep Dive into Spring Boot Multi-Threading</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-29 00:40:38 / Modified: 00:48:38" itemprop="dateCreated datePublished" datetime="2024-10-29T00:40:38-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Spring-Boot/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction-to-spring-boot-multi-threading">Introduction to Spring Boot Multi-Threading</a></li>
<li><a href="#best-practices-for-spring-boot-multi-threading">Best Practices for Spring Boot Multi-Threading</a></li>
<li><a href="#annotation-based-configuration">Annotation-Based Configuration</a></li>
<li><a href="#diagram-of-multi-threading-in-spring-boot">Diagram of Multi-Threading in Spring Boot</a></li>
<li><a href="#sample-code-with-detailed-comments">Sample Code with Detailed Comments</a><ul>
<li><a href="#configuration-class">Configuration Class</a></li>
<li><a href="#service-class">Service Class</a></li>
<li><a href="#controller-class">Controller Class</a></li>
<li><a href="#application-class">Application Class</a></li>
</ul>
</li>
<li><a href="#complex-scenario-1-flow-control-and-backpressure-handling">Complex Scenario 1: Flow Control and Backpressure Handling</a><ul>
<li><a href="#configuration-class-1">Configuration Class</a></li>
<li><a href="#service-class-1">Service Class</a></li>
<li><a href="#controller-class-1">Controller Class</a></li>
</ul>
</li>
<li><a href="#complex-scenario-2-task-prioritization">Complex Scenario 2: Task Prioritization</a><ul>
<li><a href="#configuration-class-2">Configuration Class</a></li>
<li><a href="#task-decorator">Task Decorator</a></li>
<li><a href="#service-class-2">Service Class</a></li>
<li><a href="#controller-class-2">Controller Class</a></li>
</ul>
</li>
<li><a href="#complex-scenario-3-handling-long-running-tasks">Complex Scenario 3: Handling Long-Running Tasks</a><ul>
<li><a href="#configuration-class-3">Configuration Class</a></li>
<li><a href="#service-class-3">Service Class</a></li>
<li><a href="#controller-class-3">Controller Class</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction-to-spring-boot-multi-threading"></a></p>
<h1 id="Introduction-to-Spring-Boot-Multi-Threading"><a href="#Introduction-to-Spring-Boot-Multi-Threading" class="headerlink" title="Introduction to Spring Boot Multi-Threading"></a>Introduction to Spring Boot Multi-Threading</h1><p>Spring Boot provides robust support for multi-threading, enabling developers to build highly concurrent and scalable applications. Leveraging multi-threading in Spring Boot can significantly improve the performance and responsiveness of your application. This article delves into best practices, annotation-based configuration, and real-life production scenarios to help you master multi-threading in Spring Boot.</p>
<hr>
<p><a name="best-practices-for-spring-boot-multi-threading"></a></p>
<h1 id="Best-Practices-for-Spring-Boot-Multi-Threading"><a href="#Best-Practices-for-Spring-Boot-Multi-Threading" class="headerlink" title="Best Practices for Spring Boot Multi-Threading"></a>Best Practices for Spring Boot Multi-Threading</h1><ol>
<li><strong>Use <code>@Async</code> for Asynchronous Processing</strong>: The <code>@Async</code> annotation allows methods to run in a separate thread, making it easy to implement asynchronous processing.</li>
<li><strong>Configure Thread Pools</strong>: Use <code>TaskExecutor</code> to configure thread pools with specific characteristics like core pool size, max pool size, and queue capacity.</li>
<li><strong>Handle Exceptions Gracefully</strong>: Implement exception handling mechanisms to manage exceptions that occur in asynchronous tasks.</li>
<li><strong>Monitor Thread Pools</strong>: Use Spring Boot Actuator to monitor thread pool metrics and ensure optimal performance.</li>
<li><strong>Avoid Blocking Operations</strong>: Ensure that asynchronous methods do not perform blocking operations, which can degrade performance.</li>
</ol>
<hr>
<p><a name="annotation-based-configuration"></a></p>
<h1 id="Annotation-Based-Configuration"><a href="#Annotation-Based-Configuration" class="headerlink" title="Annotation-Based Configuration"></a>Annotation-Based Configuration</h1><p>Spring Boot provides several annotations to configure and manage multi-threading:</p>
<ul>
<li><strong><code>@EnableAsync</code></strong>: Enables asynchronous processing in the application.</li>
<li><strong><code>@Async</code></strong>: Marks a method as asynchronous, meaning it will run in a separate thread.</li>
<li><strong><code>@Configuration</code></strong>: Indicates that a class declares one or more <code>@Bean</code> methods and may be processed by the Spring container to generate bean definitions.</li>
<li><strong><code>@Bean</code></strong>: Indicates that a method produces a bean to be managed by the Spring container.</li>
</ul>
<hr>
<p><a name="diagram-of-multi-threading-in-spring-boot"></a></p>
<h1 id="Diagram-of-Multi-Threading-in-Spring-Boot"><a href="#Diagram-of-Multi-Threading-in-Spring-Boot" class="headerlink" title="Diagram of Multi-Threading in Spring Boot"></a>Diagram of Multi-Threading in Spring Boot</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">| Spring Boot Application |</span><br><span class="line">| - @EnableAsync          |</span><br><span class="line">| - @Configuration        |</span><br><span class="line">| - @Bean                 |</span><br><span class="line">+-------------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| TaskExecutor      |</span><br><span class="line">| - corePoolSize    |</span><br><span class="line">| - maxPoolSize     |</span><br><span class="line">| - queueCapacity   |</span><br><span class="line">+-------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| @Async Methods    |</span><br><span class="line">| - Method1         |</span><br><span class="line">| - Method2         |</span><br><span class="line">+-------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| Thread Pool       |</span><br><span class="line">| - Thread 1        |</span><br><span class="line">| - Thread 2        |</span><br><span class="line">| - Thread 3        |</span><br><span class="line">+-------------------+</span><br><span class="line">         |</span><br><span class="line">         v</span><br><span class="line">+-------------------+</span><br><span class="line">| Task Execution    |</span><br><span class="line">| - Task 1          |</span><br><span class="line">| - Task 2          |</span><br><span class="line">| - Task 3          |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="sample-code-with-detailed-comments"></a></p>
<h1 id="Sample-Code-with-Detailed-Comments"><a href="#Sample-Code-with-Detailed-Comments" class="headerlink" title="Sample Code with Detailed Comments"></a>Sample Code with Detailed Comments</h1><h3 id="Configuration-Class"><a href="#Configuration-Class" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// Enable asynchronous processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;taskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">20</span>);  <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;AsyncThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class"><a href="#Service-Class" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;taskExecutor&quot;)</span> <span class="comment">// Use the taskExecutor bean for this method</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performAsyncTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Starting task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class"><a href="#Controller-Class" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/performTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">performTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        asyncService.performAsyncTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Task &quot;</span> + taskName + <span class="string">&quot; has been submitted for asynchronous processing.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Application-Class"><a href="#Application-Class" class="headerlink" title="Application Class"></a>Application Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// Enable asynchronous processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(AsyncApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-1-flow-control-and-backpressure-handling"></a></p>
<h1 id="Complex-Scenario-1-Flow-Control-and-Backpressure-Handling"><a href="#Complex-Scenario-1-Flow-Control-and-Backpressure-Handling" class="headerlink" title="Complex Scenario 1: Flow Control and Backpressure Handling"></a>Complex Scenario 1: Flow Control and Backpressure Handling</h1><p>In high-throughput systems, it’s crucial to manage the flow of tasks to avoid overwhelming the system. Backpressure handling ensures that the system can gracefully handle a large number of incoming tasks.</p>
<h3 id="Configuration-Class-1"><a href="#Configuration-Class-1" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackpressureConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;backpressureExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">backpressureExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">5</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>); <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">50</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;BackpressureThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class-1"><a href="#Service-Class-1" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackpressureService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;backpressureExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed handling task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class-1"><a href="#Controller-Class-1" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackpressureController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BackpressureService backpressureService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/handleTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        backpressureService.handleTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Task &quot;</span> + taskName + <span class="string">&quot; has been submitted for backpressure handling.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-2-task-prioritization"></a></p>
<h1 id="Complex-Scenario-2-Task-Prioritization"><a href="#Complex-Scenario-2-Task-Prioritization" class="headerlink" title="Complex Scenario 2: Task Prioritization"></a>Complex Scenario 2: Task Prioritization</h1><p>In some scenarios, certain tasks may need to be prioritized over others. Spring Boot allows you to configure task executors with priority queues to handle such cases.</p>
<h3 id="Configuration-Class-2"><a href="#Configuration-Class-2" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.PriorityBlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;priorityExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">priorityExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">5</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>); <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">50</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;PriorityThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.setTaskDecorator(<span class="keyword">new</span> <span class="title class_">PriorityTaskDecorator</span>()); <span class="comment">// Set task decorator for priority</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Task-Decorator"><a href="#Task-Decorator" class="headerlink" title="Task Decorator"></a>Task Decorator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.core.task.TaskDecorator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityTaskDecorator</span> <span class="keyword">implements</span> <span class="title class_">TaskDecorator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Runnable <span class="title function_">decorate</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">            <span class="comment">// Set priority logic here</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Setting priority for task: &quot;</span> + runnable);</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class-2"><a href="#Service-Class-2" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;priorityExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">prioritizeTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Prioritizing task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed prioritizing task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class-2"><a href="#Controller-Class-2" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PriorityService priorityService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prioritizeTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">prioritizeTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        priorityService.prioritizeTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Task &quot;</span> + taskName + <span class="string">&quot; has been submitted for prioritization.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="complex-scenario-3-handling-long-running-tasks"></a></p>
<h1 id="Complex-Scenario-3-Handling-Long-Running-Tasks"><a href="#Complex-Scenario-3-Handling-Long-Running-Tasks" class="headerlink" title="Complex Scenario 3: Handling Long-Running Tasks"></a>Complex Scenario 3: Handling Long-Running Tasks</h1><p>Long-running tasks can block threads and degrade system performance. Spring Boot provides mechanisms to handle such tasks efficiently.</p>
<h3 id="Configuration-Class-3"><a href="#Configuration-Class-3" class="headerlink" title="Configuration Class"></a>Configuration Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongRunningConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;longRunningExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">longRunningExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">5</span>); <span class="comment">// Core pool size</span></span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>); <span class="comment">// Maximum pool size</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">50</span>); <span class="comment">// Queue capacity</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;LongRunningThread-&quot;</span>); <span class="comment">// Thread name prefix</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Class-3"><a href="#Service-Class-3" class="headerlink" title="Service Class"></a>Service Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongRunningService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;longRunningExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLongRunningTask</span><span class="params">(String taskName)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling long-running task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Simulate long-running task execution time</span></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Completed handling long-running task: &quot;</span> + taskName + <span class="string">&quot; on thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-Class-3"><a href="#Controller-Class-3" class="headerlink" title="Controller Class"></a>Controller Class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LongRunningController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LongRunningService longRunningService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/handleLongRunningTask&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleLongRunningTask</span><span class="params">(<span class="meta">@RequestParam</span> String taskName)</span> &#123;</span><br><span class="line">        longRunningService.handleLongRunningTask(taskName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Long-running task &quot;</span> + taskName + <span class="string">&quot; has been submitted for processing.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Spring Boot’s support for multi-threading allows developers to build highly concurrent and scalable applications. By following best practices and leveraging annotation-based configuration, you can efficiently manage asynchronous tasks, handle backpressure, prioritize tasks, and manage long-running tasks. This article provides a comprehensive guide to mastering multi-threading in Spring Boot, complete with detailed sample code and real-life production scenarios.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Create-a-Java-Thread-Pool-From-Scratch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Create-a-Java-Thread-Pool-From-Scratch/" class="post-title-link" itemprop="url">Create a Java Thread Pool From Scratch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-28 23:32:51" itemprop="dateCreated datePublished" datetime="2024-10-28T23:32:51-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-10-29 09:27:33" itemprop="dateModified" datetime="2024-10-29T09:27:33-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#custom-java-thread-pool-proof-of-concept">Custom Java Thread Pool: Proof of Concept</a><ul>
<li><a href="#implementation-of-simplethreadpool">Implementation of <code>SimpleThreadPool</code></a></li>
<li><a href="#explanation-of-key-concepts">Explanation of Key Concepts</a></li>
<li><a href="#sample-code-to-use-the-simplethreadpool">Sample Code to Use the <code>SimpleThreadPool</code></a><ul>
<li><a href="#explanation-of-sample-usage-code">Explanation of Sample Usage Code</a></li>
<li><a href="#expected-output">Expected Output</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#custom-java-thread-pool-with-separate-task-class">Custom Java Thread Pool with Separate Task Class</a><ul>
<li><a href="#task-class-implementation"><code>Task</code> Class Implementation</a></li>
<li><a href="#simplethreadpool-implementation"><code>SimpleThreadPool</code> Implementation</a></li>
<li><a href="#sample-code-to-use-the-custom-thread-pool-with-task">Sample Code to Use the Custom Thread Pool with <code>Task</code></a><ul>
<li><a href="#explanation-of-sample-usage">Explanation of Sample Usage</a></li>
<li><a href="#expected-output-1">Expected Output</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#wait-but-what-happened-to-the-terminated-thread">Wait but what happened to the terminated thread?</a><ul>
<li><a href="#enhanced-simplethreadpool-implementation">Enhanced <code>SimpleThreadPool</code> Implementation</a></li>
<li><a href="#enhanced-task-class-implementation">Enhanced <code>Task</code> Class Implementation</a></li>
<li><a href="#usage-and-state-transition-simulation">Usage and State Transition Simulation</a></li>
<li><a href="#explanation-of-the-workflow-and-state-transitions">Explanation of the Workflow and State Transitions</a></li>
<li><a href="#expected-output-sample">Expected Output (Sample)</a></li>
</ul>
</li>
<li><a href="#how-thread-being-actually-reused">How thread being actually reused?</a><ul>
<li><a href="#thread-states-in-a-thread-pool">Thread States in a Thread Pool</a></li>
<li><a href="#how-threads-are-reused">How Threads Are Reused</a></li>
<li><a href="#example-of-thread-reuse-in-simplethreadpool">Example of Thread Reuse in <code>SimpleThreadPool</code></a></li>
<li><a href="#code-example">Code Example</a></li>
<li><a href="#key-points">Key Points</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</li>
</ul>
<hr>
<p><a name="custom-java-thread-pool-proof-of-concept"></a></p>
<h1 id="Custom-Java-Thread-Pool-Proof-of-Concept"><a href="#Custom-Java-Thread-Pool-Proof-of-Concept" class="headerlink" title="Custom Java Thread Pool: Proof of Concept"></a>Custom Java Thread Pool: Proof of Concept</h1><p>In this article, we will create a simple but complete custom thread pool. We’ll build a <code>SimpleThreadPool</code> class that includes key features such as managing worker threads, a task queue, and shutdown capabilities. We’ll break down the code into logical components, explain the design concepts, and provide sample usage.</p>
<hr>
<p><a name="implementation-of-simplethreadpool"></a></p>
<h2 id="Implementation-of-SimpleThreadPool"><a href="#Implementation-of-SimpleThreadPool" class="headerlink" title="Implementation of SimpleThreadPool"></a>Implementation of <code>SimpleThreadPool</code></h2><p>The core classes in our implementation are:</p>
<ul>
<li><code>SimpleThreadPool</code>: Manages the thread pool and task queue.</li>
<li><code>Worker</code>: Represents the worker threads that execute tasks.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start worker threads</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>();</span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Submit a task to the thread pool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify workers that a task is available</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiates an orderly shutdown</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupt each worker to stop waiting</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Worker class represents threads in the pool</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Runnable task;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If shutdown and no tasks, end thread</span></span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Take task from queue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">// Execute task outside synchronized block</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="explanation-of-key-concepts"></a></p>
<h2 id="Explanation-of-Key-Concepts"><a href="#Explanation-of-Key-Concepts" class="headerlink" title="Explanation of Key Concepts"></a>Explanation of Key Concepts</h2><ol>
<li><strong>Task Queue</strong>: A <code>LinkedList</code> serves as the task queue, holding <code>Runnable</code> tasks for worker threads.</li>
<li><strong>Worker Threads</strong>: <code>PoolWorker</code> threads execute tasks. Each worker loops to fetch a task from the queue and processes it if available.</li>
<li><strong>Synchronization with <code>wait</code> and <code>notify</code></strong>:<ul>
<li><code>wait()</code>: Called when no tasks are available, putting the thread in a waiting state to save CPU resources.</li>
<li><code>notify()</code>: Called when a new task is added, waking up a worker thread to execute the task.</li>
</ul>
</li>
<li><strong>Graceful Shutdown</strong>:<ul>
<li><code>shutdown()</code>: Sets the <code>isShutdown</code> flag to stop accepting tasks and interrupts all worker threads, allowing them to exit if they’re waiting for a task.</li>
</ul>
</li>
</ol>
<hr>
<p><a name="sample-code-to-use-the-simplethreadpool"></a></p>
<h2 id="Sample-Code-to-Use-the-SimpleThreadPool"><a href="#Sample-Code-to-Use-the-SimpleThreadPool" class="headerlink" title="Sample Code to Use the SimpleThreadPool"></a>Sample Code to Use the <code>SimpleThreadPool</code></h2><p>This example demonstrates how to use the custom <code>SimpleThreadPool</code> to run tasks, including graceful shutdown.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with 3 threads</span></span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; is starting on thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>); <span class="comment">// Simulate task execution time</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the thread pool after tasks complete</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation-of-Sample-Usage-Code"><a href="#Explanation-of-Sample-Usage-Code" class="headerlink" title="Explanation of Sample Usage Code"></a>Explanation of Sample Usage Code</h3><ol>
<li><strong>Creating a Thread Pool</strong>: A <code>SimpleThreadPool</code> instance with 3 threads is created.</li>
<li><strong>Submitting Tasks</strong>: Five tasks are submitted to the pool, each of which simulates a brief work period.</li>
<li><strong>Shutting Down the Pool</strong>: After submitting the tasks, the pool is gracefully shut down using <code>shutdown()</code>.</li>
</ol>
<h3 id="Expected-Output"><a href="#Expected-Output" class="headerlink" title="Expected Output"></a>Expected Output</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Task 1 is starting on thread Thread-0</span><br><span class="line">Task 2 is starting on thread Thread-1</span><br><span class="line">Task 3 is starting on thread Thread-2</span><br><span class="line">Task 1 completed.</span><br><span class="line">Task 2 completed.</span><br><span class="line">Task 3 completed.</span><br><span class="line">Task 4 is starting on thread Thread-0</span><br><span class="line">Task 5 is starting on thread Thread-1</span><br><span class="line">Task 4 completed.</span><br><span class="line">Task 5 completed.</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This <code>SimpleThreadPool</code> is a demonstration of how a basic thread pool is structured and works:</p>
<ul>
<li><strong>Worker Threads</strong> repeatedly pick up and execute tasks from a shared queue.</li>
<li><strong>Synchronization</strong> between task producers and worker threads prevents busy-waiting.</li>
<li><strong>Graceful Shutdown</strong> lets worker threads exit safely after processing all queued tasks.</li>
</ul>
<p>This POC lays the foundation for understanding and extending Java thread pool management by illustrating how resources are managed and synchronized in a concurrent environment.</p>
<hr>
<p><a name="custom-java-thread-pool-with-separate-task-class"></a></p>
<h1 id="Custom-Java-Thread-Pool-with-Separate-Task-Class"><a href="#Custom-Java-Thread-Pool-with-Separate-Task-Class" class="headerlink" title="Custom Java Thread Pool with Separate Task Class"></a>Custom Java Thread Pool with Separate Task Class</h1><p>Separating the <code>Task</code> as an individual class will enhance the code’s modularity and flexibility, making it easier to reuse or extend for specific task-related features. Let’s modify the <code>SimpleThreadPool</code> implementation to include an external <code>Task</code> class.</p>
<p>Here’s the updated implementation:</p>
<ol>
<li><strong><code>SimpleThreadPool</code></strong>: Manages worker threads and the task queue.</li>
<li><strong><code>Task</code></strong>: Represents individual tasks, implementing <code>Runnable</code>.</li>
<li><strong><code>PoolWorker</code></strong>: Represents the worker threads that pick up tasks from the queue and execute them.</li>
</ol>
<hr>
<h2 id="Task-Class-Implementation"><a href="#Task-Class-Implementation" class="headerlink" title="Task Class Implementation"></a><code>Task</code> Class Implementation</h2><p>We’ll define <code>Task</code> as a standalone class that implements <code>Runnable</code>. Each task can have custom logic.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; is starting on thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// Simulate task execution time</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt(); <span class="comment">// Handle interruption</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>taskId</code></strong>: Each task is given an ID to identify it during execution.</li>
<li><strong><code>run()</code> Method</strong>: Defines the task’s actions, including a simulated delay.</li>
</ul>
<hr>
<h2 id="SimpleThreadPool-Implementation"><a href="#SimpleThreadPool-Implementation" class="headerlink" title="SimpleThreadPool Implementation"></a><code>SimpleThreadPool</code> Implementation</h2><p>The <code>SimpleThreadPool</code> class manages the task queue and distributes tasks among worker threads.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize and start each worker thread</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>();</span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Method to submit a task to the thread pool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify a waiting worker thread about the new task</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down and cannot accept tasks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiates shutdown and interrupts all waiting worker threads</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupts workers waiting for tasks</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Worker class that executes tasks from the queue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Runnable task;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a new task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// Exit if shutdown and no tasks are left</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Fetch a task</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">// Execute the task outside the synchronized block</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Sample-Code-to-Use-the-Custom-Thread-Pool-with-Task"><a href="#Sample-Code-to-Use-the-Custom-Thread-Pool-with-Task" class="headerlink" title="Sample Code to Use the Custom Thread Pool with Task"></a>Sample Code to Use the Custom Thread Pool with <code>Task</code></h2><p>This example demonstrates submitting <code>Task</code> instances to the <code>SimpleThreadPool</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with 3 threads</span></span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task</span>(i); <span class="comment">// Create a new Task with a unique ID</span></span><br><span class="line">            threadPool.submit(task);  <span class="comment">// Submit the Task to the thread pool</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the thread pool after tasks are complete</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation-of-Sample-Usage"><a href="#Explanation-of-Sample-Usage" class="headerlink" title="Explanation of Sample Usage"></a>Explanation of Sample Usage</h3><ol>
<li><strong>Task Creation</strong>: Each <code>Task</code> object has a unique ID, making it easy to track execution progress.</li>
<li><strong>Task Submission</strong>: Tasks are added to the <code>SimpleThreadPool</code>’s task queue.</li>
<li><strong>Shutdown</strong>: Once all tasks are submitted, <code>shutdown()</code> stops the pool after finishing queued tasks.</li>
</ol>
<h3 id="Expected-Output-1"><a href="#Expected-Output-1" class="headerlink" title="Expected Output"></a>Expected Output</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Task 1 is starting on thread Thread-0</span><br><span class="line">Task 2 is starting on thread Thread-1</span><br><span class="line">Task 3 is starting on thread Thread-2</span><br><span class="line">Task 1 completed.</span><br><span class="line">Task 2 completed.</span><br><span class="line">Task 3 completed.</span><br><span class="line">Task 4 is starting on thread Thread-0</span><br><span class="line">Task 5 is starting on thread Thread-1</span><br><span class="line">Task 4 completed.</span><br><span class="line">Task 5 completed.</span><br></pre></td></tr></table></figure>

<hr>
<p>This implementation improves modularity by allowing different <code>Task</code> implementations and extends the reusability of <code>SimpleThreadPool</code>. Each component (<code>Task</code>, <code>PoolWorker</code>, and <code>SimpleThreadPool</code>) is designed for flexible use in varied production scenarios.</p>
<hr>
<p><a name="wait-but-what-happened-to-the-terminated-thread"></a></p>
<h1 id="Wait-but-what-happened-to-the-terminated-thread"><a href="#Wait-but-what-happened-to-the-terminated-thread" class="headerlink" title="Wait but what happened to the terminated thread?"></a>Wait but what happened to the terminated thread?</h1><p>To demonstrate the behavior where a terminated thread in a thread pool is repurposed and moves back to the runnable state when a new task is added, we need to tweak the <code>SimpleThreadPool</code> to simulate this behavior. </p>
<p>Typically, when threads in a pool complete their tasks, they wait for new tasks rather than fully terminating (they don’t reach the “TERMINATED” state in Java’s built-in <code>ThreadPoolExecutor</code>). However, for demonstration, I’ll create logic that represents threads reaching a “stopped” state and being reactivated for new tasks.</p>
<p>Let’s add a mechanism to track the states and illustrate the thread reusability behavior.</p>
<hr>
<h3 id="Enhanced-SimpleThreadPool-Implementation"><a href="#Enhanced-SimpleThreadPool-Implementation" class="headerlink" title="Enhanced SimpleThreadPool Implementation"></a>Enhanced <code>SimpleThreadPool</code> Implementation</h3><p>Below is an enhanced version of <code>SimpleThreadPool</code> with thread state tracking. We’ll add logging and state simulation to show when threads are “terminated” and later reactivated when new tasks arrive.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize and start each worker thread</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>(i + <span class="number">1</span>); <span class="comment">// Assign a unique ID to each worker</span></span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Method to submit a task to the thread pool</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify a waiting worker thread about the new task</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down and cannot accept tasks&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiates shutdown and interrupts all waiting worker threads</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupts workers waiting for tasks</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Worker class that executes tasks from the queue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> workerId;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isTerminated</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">PoolWorker</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.workerId = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Runnable task;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is waiting for a task...&quot;</span>);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a new task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is terminated.&quot;</span>);</span><br><span class="line">                            isTerminated = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is terminated as pool shuts down.&quot;</span>);</span><br><span class="line">                        isTerminated = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// Exit if shutdown and no tasks are left</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Fetch a task</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    isTerminated = <span class="literal">false</span>; <span class="comment">// Worker is active</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; is executing task.&quot;</span>);</span><br><span class="line">                    task.run(); <span class="comment">// Execute the task</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;Worker-&quot;</span> + workerId + <span class="string">&quot; completed task and goes back to waiting.&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed in Worker-&quot;</span> + workerId + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Enhanced-Task-Class-Implementation"><a href="#Enhanced-Task-Class-Implementation" class="headerlink" title="Enhanced Task Class Implementation"></a>Enhanced <code>Task</code> Class Implementation</h3><p>The <code>Task</code> class remains mostly the same, but we can add unique identifiers to differentiate tasks.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; is starting on thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// Simulate task execution time</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt(); <span class="comment">// Handle interruption</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Usage-and-State-Transition-Simulation"><a href="#Usage-and-State-Transition-Simulation" class="headerlink" title="Usage and State Transition Simulation"></a>Usage and State Transition Simulation</h3><p>Let’s add a usage example showing how to submit tasks, observe workers entering a “terminated” state, and then reactivating to process new tasks.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with 2 workers</span></span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit initial tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">            threadPool.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait to let initial tasks complete</span></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit additional tasks to show reactivation</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Adding more tasks to test thread reactivation...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">4</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            threadPool.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Give some time for tasks to be picked up</span></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the thread pool</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation-of-the-Workflow-and-State-Transitions"><a href="#Explanation-of-the-Workflow-and-State-Transitions" class="headerlink" title="Explanation of the Workflow and State Transitions"></a>Explanation of the Workflow and State Transitions</h3><ol>
<li><strong>Initial Task Submission</strong>: Three tasks are submitted, and two workers pick them up immediately since the pool size is 2.</li>
<li><strong>Worker Reactivation</strong>: After the initial tasks complete, we add two more tasks, which are picked up by waiting workers.</li>
<li><strong>Shutdown Process</strong>: Finally, we shut down the thread pool, and the workers gracefully terminate after completing their tasks.</li>
</ol>
<h3 id="Expected-Output-Sample"><a href="#Expected-Output-Sample" class="headerlink" title="Expected Output (Sample)"></a>Expected Output (Sample)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Worker-1 is waiting for a task...</span><br><span class="line">Worker-2 is waiting for a task...</span><br><span class="line">Worker-1 is executing task.</span><br><span class="line">Task 1 is starting on thread Worker-1</span><br><span class="line">Worker-2 is executing task.</span><br><span class="line">Task 2 is starting on thread Worker-2</span><br><span class="line">Task 1 completed.</span><br><span class="line">Worker-1 completed task and goes back to waiting.</span><br><span class="line">Task 2 completed.</span><br><span class="line">Worker-2 completed task and goes back to waiting.</span><br><span class="line">Worker-1 is executing task.</span><br><span class="line">Task 3 is starting on thread Worker-1</span><br><span class="line">Task 3 completed.</span><br><span class="line">Worker-1 completed task and goes back to waiting.</span><br><span class="line">Worker-1 is waiting for a task...</span><br><span class="line">Worker-2 is waiting for a task...</span><br><span class="line"></span><br><span class="line">Adding more tasks to test thread reactivation...</span><br><span class="line">Worker-1 is executing task.</span><br><span class="line">Task 4 is starting on thread Worker-1</span><br><span class="line">Worker-2 is executing task.</span><br><span class="line">Task 5 is starting on thread Worker-2</span><br><span class="line">Task 4 completed.</span><br><span class="line">Worker-1 completed task and goes back to waiting.</span><br><span class="line">Task 5 completed.</span><br><span class="line">Worker-2 completed task and goes back to waiting.</span><br><span class="line">Worker-1 is terminated as pool shuts down.</span><br><span class="line">Worker-2 is terminated as pool shuts down.</span><br></pre></td></tr></table></figure>

<p>This output demonstrates that the workers remain active, go back to a waiting state after completing tasks, and terminate only after <code>shutdown()</code> is called.</p>
<p><a name="how-thread-being-acutally-reused"></a></p>
<h1 id="How-thread-being-actually-reused"><a href="#How-thread-being-actually-reused" class="headerlink" title="How thread being actually reused?"></a>How thread being actually reused?</h1><p>In a typical thread pool implementation, once a thread completes its task, it does not transition to the “TERMINATED” state and then back to the “RUNNABLE” state. Instead, the thread remains in a waiting state (often referred to as “idle” or “waiting for work”) until a new task is available. This waiting state is different from the “TERMINATED” state, which indicates that the thread has finished execution and cannot be reused.</p>
<p>Here’s a more detailed explanation:</p>
<h3 id="Thread-States-in-a-Thread-Pool"><a href="#Thread-States-in-a-Thread-Pool" class="headerlink" title="Thread States in a Thread Pool"></a>Thread States in a Thread Pool</h3><ol>
<li><strong>NEW</strong>: The thread has been created but not yet started.</li>
<li><strong>RUNNABLE</strong>: The thread is executing in the JVM.</li>
<li><strong>BLOCKED</strong>: The thread is blocked waiting for a monitor lock.</li>
<li><strong>WAITING</strong>: The thread is waiting indefinitely for another thread to perform a particular action.</li>
<li><strong>TIMED_WAITING</strong>: The thread is waiting for another thread to perform an action for up to a specified waiting time.</li>
<li><strong>TERMINATED</strong>: The thread has completed execution.</li>
</ol>
<p>In a thread pool, threads typically cycle between the <strong>RUNNABLE</strong> and <strong>WAITING</strong> states:</p>
<ul>
<li><strong>RUNNABLE</strong>: When a thread is actively executing a task.</li>
<li><strong>WAITING</strong>: When a thread is idle, waiting for a new task to be added to the queue.</li>
</ul>
<h3 id="How-Threads-Are-Reused"><a href="#How-Threads-Are-Reused" class="headerlink" title="How Threads Are Reused"></a>How Threads Are Reused</h3><p>When a thread completes its task, it checks the task queue for new tasks. If no tasks are available, the thread waits (using <code>wait()</code> or a similar mechanism) until a new task is submitted. This waiting state is not the same as the “TERMINATED” state. A thread in the “TERMINATED” state cannot be reused; it must be recreated, which is inefficient.</p>
<h3 id="Example-of-Thread-Reuse-in-SimpleThreadPool"><a href="#Example-of-Thread-Reuse-in-SimpleThreadPool" class="headerlink" title="Example of Thread Reuse in SimpleThreadPool"></a>Example of Thread Reuse in <code>SimpleThreadPool</code></h3><p>In the <code>SimpleThreadPool</code> example, threads are reused as follows:</p>
<ol>
<li><strong>Thread Creation</strong>: When the thread pool is created, a fixed number of worker threads are started.</li>
<li><strong>Task Execution</strong>: Each worker thread fetches a task from the queue and executes it.</li>
<li><strong>Waiting for New Tasks</strong>: After completing a task, the worker thread checks the queue for new tasks. If no tasks are available, it waits (<code>wait()</code>) until a new task is submitted.</li>
<li><strong>Reactivation</strong>: When a new task is submitted, the waiting threads are notified (<code>notify()</code>), and one of them wakes up to execute the new task.</li>
</ol>
<h3 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h3><p>Here’s a simplified version of the <code>SimpleThreadPool</code> to illustrate this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PoolWorker[] workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isShutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        workers = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>[poolSize];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start worker threads</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            workers[i] = <span class="keyword">new</span> <span class="title class_">PoolWorker</span>();</span><br><span class="line">            workers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShutdown) &#123;</span><br><span class="line">            taskQueue.add(task);</span><br><span class="line">            notify(); <span class="comment">// Notify a waiting worker thread</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ThreadPool is shut down&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        isShutdown = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (PoolWorker worker : workers) &#123;</span><br><span class="line">            worker.interrupt(); <span class="comment">// Interrupt each worker to stop waiting</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PoolWorker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Runnable task;</span><br><span class="line">                <span class="keyword">synchronized</span> (SimpleThreadPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (taskQueue.isEmpty() &amp;&amp; !isShutdown) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SimpleThreadPool.<span class="built_in">this</span>.wait(); <span class="comment">// Wait for a task</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                            <span class="keyword">return</span>; <span class="comment">// Exit if interrupted during shutdown</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isShutdown &amp;&amp; taskQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>; <span class="comment">// Exit if shutdown and no tasks are left</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    task = taskQueue.poll(); <span class="comment">// Take task from queue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run(); <span class="comment">// Execute task</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;Task execution failed: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Key-Points"><a href="#Key-Points" class="headerlink" title="Key Points"></a>Key Points</h3><ul>
<li><strong>Thread Reuse</strong>: Threads do not transition to the “TERMINATED” state after completing a task. Instead, they wait for new tasks.</li>
<li><strong>Task Queue</strong>: The task queue holds tasks that are waiting to be executed. When a new task is submitted, a waiting thread is notified and picks up the task.</li>
<li><strong>Graceful Shutdown</strong>: The <code>shutdown()</code> method sets the <code>isShutdown</code> flag to stop accepting new tasks and interrupts all worker threads to ensure they exit if they are waiting.</li>
</ul>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>In Java’s <code>ThreadPoolExecutor</code> (or our custom pool example), the worker threads do <strong>not</strong> actually terminate after completing a task. Instead, they enter a <strong>waiting</strong> or <strong>idle state</strong> and wait to pick up the next task. The main goal of a thread pool is to reuse threads efficiently, keeping them alive for as long as the pool is running and ready to transition back to the <strong>runnable</strong> state whenever a new task becomes available. </p>
<p>Here’s how it works:</p>
<ol>
<li><strong>Runnable → Running</strong>: A thread in the pool becomes <strong>running</strong> when it starts executing a task.</li>
<li><strong>Running → Waiting&#x2F;Idle</strong>: Once it finishes the task, it doesn’t terminate. Instead, it returns to an <strong>idle state</strong> within the pool, waiting for more tasks to be added to the queue.</li>
<li><strong>Waiting → Runnable</strong>: When a new task is submitted, an idle worker transitions to <strong>runnable</strong> and executes the task.</li>
</ol>
<p>The threads only reach a <strong>terminated state</strong> when the pool itself is <strong>shut down</strong> (e.g., calling <code>shutdown()</code> in <code>ThreadPoolExecutor</code>). Only then will the threads stop, exit the idle&#x2F;waiting state, and go to terminated. This approach keeps the pool flexible and efficient, reducing the overhead of creating and destroying threads for every task. </p>
<p>So in short: threads in a thread pool <strong>do not reach terminated after completing tasks</strong>. They go back to idle&#x2F;waiting and can accept new tasks. And threads in a thread pool do not go back to the “RUNNABLE” state from the “TERMINATED” state neither. Instead, they remain in a waiting state until new tasks are available, ensuring efficient reuse of thread resources.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Deep-Dive-into-Java-Core-Multi-Threading/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Deep-Dive-into-Java-Core-Multi-Threading/" class="post-title-link" itemprop="url">Deep Dive into Java Core Multi-Threading</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 23:17:03 / Modified: 23:31:03" itemprop="dateCreated datePublished" datetime="2024-10-28T23:17:03-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-introduction">1. Introduction</a></li>
<li><a href="#2-java-thread-pool-overview-and-components">2. Java Thread Pool: Overview and Components</a></li>
<li><a href="#3-core-terms-explained">3. Core Terms Explained</a><ul>
<li><a href="#task">Task</a></li>
<li><a href="#thread">Thread</a></li>
<li><a href="#worker">Worker</a></li>
<li><a href="#thread-pool">Thread Pool</a></li>
</ul>
</li>
<li><a href="#4-thread-lifecycle-in-a-thread-pool">4. Thread Lifecycle in a Thread Pool</a></li>
<li><a href="#5-thread-state-transitions">5. Thread State Transitions</a></li>
<li><a href="#6-sample-code-and-explanation">6. Sample Code and Explanation</a></li>
<li><a href="#7-handling-terminated-threads">7. Handling TERMINATED Threads</a><ul>
<li><a href="#what-happens-when-a-thread-reaches-terminated">What Happens When a Thread Reaches TERMINATED?</a></li>
<li><a href="#reuse-in-fixed-pools">Reuse in Fixed Pools</a></li>
<li><a href="#state-machine-transition">State Machine Transition</a></li>
</ul>
</li>
<li><a href="#8-conclusion">8. Conclusion</a></li>
</ul>
<hr>
<p>This article explores Java’s thread pool concept, detailing each component and state involved. We’ll cover tasks, threads, workers, thread pools, and the state transitions that occur during task execution. Detailed diagrams and annotated code examples demonstrate how each part interacts, making this a practical reference for developing multithreaded Java applications.</p>
<hr>
<p><a name="introduction"></a></p>
<h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>Java’s <code>ThreadPoolExecutor</code> provides a robust framework for managing a pool of worker threads that can efficiently process a series of asynchronous tasks. It’s designed to handle tasks without creating new threads for every request, conserving resources and reducing overhead. This article breaks down each term and component involved in a Java thread pool to provide a clear, practical understanding.</p>
<hr>
<p><a name="java-thread-pool-overview-and-components"></a></p>
<h2 id="2-Java-Thread-Pool-Overview-and-Components"><a href="#2-Java-Thread-Pool-Overview-and-Components" class="headerlink" title="2. Java Thread Pool: Overview and Components"></a>2. Java Thread Pool: Overview and Components</h2><p>A thread pool is a collection of threads that are managed to execute tasks concurrently. Rather than creating a new thread for every task, a pool of threads is reused, allowing efficient execution without constant thread creation and destruction.</p>
<p>Here’s a textual diagram illustrating a typical Java thread pool architecture:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------+</span><br><span class="line">|              Thread Pool                  |</span><br><span class="line">|-------------------------------------------|</span><br><span class="line">|                                           |</span><br><span class="line">|   Task Queue --&gt; [Task1] [Task2] [TaskN]  |</span><br><span class="line">|                                           |</span><br><span class="line">|        +-------------------------------+  |</span><br><span class="line">|        |           Worker Thread       |  |</span><br><span class="line">|        |-------------------------------|  |</span><br><span class="line">|        |    |--Thread-1--|--Running--| |  |</span><br><span class="line">|        |    |--Thread-2--|--Runnable-| |  |</span><br><span class="line">|        |    |--Thread-N--|--Waiting--| |  |</span><br><span class="line">|        +-------------------------------+  |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="core-terms-explained"></a></p>
<h2 id="3-Core-Terms-Explained"><a href="#3-Core-Terms-Explained" class="headerlink" title="3. Core Terms Explained"></a>3. Core Terms Explained</h2><h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><ul>
<li><strong>Definition</strong>: A <code>Runnable</code> or <code>Callable</code> object representing a unit of work.</li>
<li><strong>Purpose</strong>: The task contains logic that needs to be executed by a thread in the pool.</li>
</ul>
<h3 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h3><ul>
<li><strong>Definition</strong>: An individual worker capable of executing a task.</li>
<li><strong>States</strong>: Threads can be in various states, including <code>NEW</code>, <code>RUNNABLE</code>, <code>WAITING</code>, <code>TIMED_WAITING</code>, <code>BLOCKED</code>, and <code>TERMINATED</code>.</li>
</ul>
<h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><ul>
<li><strong>Definition</strong>: An entity within the thread pool that wraps a thread, providing task management.</li>
<li><strong>Role</strong>: Handles the execution of tasks by submitting them to a thread in the pool.</li>
</ul>
<h3 id="Thread-Pool"><a href="#Thread-Pool" class="headerlink" title="Thread Pool"></a>Thread Pool</h3><ul>
<li><strong>Definition</strong>: A collection of threads managed by an executor that oversees thread lifecycle and task allocation.</li>
<li><strong>Purpose</strong>: To improve performance by reusing threads for multiple tasks, avoiding the cost of creating and destroying threads frequently.</li>
</ul>
<hr>
<p><a name="thread-lifecycle-in-a-thread-pool"></a></p>
<h2 id="4-Thread-Lifecycle-in-a-Thread-Pool"><a href="#4-Thread-Lifecycle-in-a-Thread-Pool" class="headerlink" title="4. Thread Lifecycle in a Thread Pool"></a>4. Thread Lifecycle in a Thread Pool</h2><p>A thread in a pool goes through multiple states throughout its lifecycle. Let’s illustrate these states and transitions with a state diagram.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+-----------+</span><br><span class="line">|   NEW     |   -- Thread created</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| RUNNABLE  |   -- Thread ready to execute</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| RUNNING   |   -- Thread actively executing a task</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| BLOCKED   |   -- Thread blocked, waiting for a resource</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| WAITING   |   -- Thread waiting indefinitely for a condition</span><br><span class="line">+-----------+</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">+-----------+</span><br><span class="line">| TERMINATED|   -- Thread completed execution or terminated</span><br><span class="line">+-----------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="thread-state-transitions"></a></p>
<h2 id="5-Thread-State-Transitions"><a href="#5-Thread-State-Transitions" class="headerlink" title="5. Thread State Transitions"></a>5. Thread State Transitions</h2><p>Each thread’s state changes as it progresses through its lifecycle:</p>
<ol>
<li><strong>NEW</strong>: The thread is created but has not yet started.</li>
<li><strong>RUNNABLE</strong>: The thread is ready to run but is waiting for CPU availability.</li>
<li><strong>RUNNING</strong>: The thread is actively running its assigned task.</li>
<li><strong>BLOCKED</strong>: The thread is waiting to acquire a lock to access a synchronized resource.</li>
<li><strong>WAITING&#x2F;TIMED_WAITING</strong>: The thread is waiting indefinitely or for a specified time, typically for task completion or resource availability.</li>
<li><strong>TERMINATED</strong>: The thread has completed its task and will either be recycled for a new task or discarded if no longer needed.</li>
</ol>
<hr>
<p><a name="sample-code-and-explanation"></a></p>
<h2 id="6-Sample-Code-and-Explanation"><a href="#6-Sample-Code-and-Explanation" class="headerlink" title="6. Sample Code and Explanation"></a>6. Sample Code and Explanation</h2><p>Below is a sample code demonstrating a thread pool with comments explaining each part of the process.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a thread pool with a fixed number of threads</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Submit multiple tasks to the thread pool</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            threadPool.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown the pool after tasks are completed</span></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Task class implementing Runnable, representing a unit of work for the pool</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> taskId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Executing Task &quot;</span> + taskId + <span class="string">&quot; with &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>); <span class="comment">// Simulate task duration</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example:</p>
<ul>
<li><strong>ThreadPoolExecutor</strong>: Manages a pool of three threads.</li>
<li><strong>Task</strong>: Each task simulates a job that runs for two seconds, allowing us to observe thread reuse.</li>
<li><strong>Thread</strong>: Each task is assigned a thread by the thread pool, which either executes it immediately or queues it until a thread becomes available.</li>
</ul>
<hr>
<p><a name="handling-terminated-threads"></a></p>
<h2 id="7-Handling-TERMINATED-Threads"><a href="#7-Handling-TERMINATED-Threads" class="headerlink" title="7. Handling TERMINATED Threads"></a>7. Handling TERMINATED Threads</h2><h3 id="What-Happens-When-a-Thread-Reaches-TERMINATED"><a href="#What-Happens-When-a-Thread-Reaches-TERMINATED" class="headerlink" title="What Happens When a Thread Reaches TERMINATED?"></a>What Happens When a Thread Reaches TERMINATED?</h3><p>Once a thread in the pool completes its task and reaches the <code>TERMINATED</code> state, it does not automatically return to <code>RUNNABLE</code>. In a fixed pool, the terminated thread is replaced by a new one, ensuring the pool maintains its core size. In cached pools, the thread may be recycled if the task load increases, maintaining efficiency.</p>
<h3 id="Reuse-in-Fixed-Pools"><a href="#Reuse-in-Fixed-Pools" class="headerlink" title="Reuse in Fixed Pools"></a>Reuse in Fixed Pools</h3><p>In fixed-size pools, a thread that terminates due to completion is usually retained within the pool as a worker for future tasks.</p>
<h3 id="State-Machine-Transition"><a href="#State-Machine-Transition" class="headerlink" title="State Machine Transition"></a>State Machine Transition</h3><p>The Java thread pool manages thread lifecycles by detecting <code>TERMINATED</code> threads and maintaining the required pool size by creating new threads as needed. This automatic management ensures the pool maintains availability and task-handling capacity.</p>
<hr>
<p><a name="conclusion"></a></p>
<h2 id="8-Conclusion"><a href="#8-Conclusion" class="headerlink" title="8. Conclusion"></a>8. Conclusion</h2><p>Java’s thread pool provides an efficient way to handle concurrent tasks by reusing threads and managing their lifecycles. Key concepts like tasks, threads, and workers work together to ensure a scalable, resource-efficient application structure. By understanding thread pool states, configurations, and transition mechanisms, developers can design more resilient and optimized concurrent applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Best-Practices-of-Java-Core-ThreadPoolExecutor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Best-Practices-of-Java-Core-ThreadPoolExecutor/" class="post-title-link" itemprop="url">Best Practices of Java Core ThreadPoolExecutor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-28 23:01:49" itemprop="dateCreated datePublished" datetime="2024-10-28T23:01:49-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-10-29 10:28:54" itemprop="dateModified" datetime="2024-10-29T10:28:54-04:00">2024-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-why-executors-is-discouraged">1. Why Executors is Discouraged</a><ul>
<li><a href="#example-code-not-recommended">Example Code (Not Recommended)</a></li>
</ul>
</li>
<li><a href="#2-threadpoolexecutor-introduction">2. ThreadPoolExecutor Introduction</a></li>
<li><a href="#3-overview-of-threadpoolexecutor">3. Overview of <code>ThreadPoolExecutor</code></a></li>
<li><a href="#4-recommended-usage-threadpoolexecutor">4. Recommended Usage: ThreadPoolExecutor</a></li>
<li><a href="#5-core-configuration-parameters">5. Core Configuration Parameters</a><ul>
<li><a href="#best-practice-choose-configuration-values-based-on-workload-type-and-system-capacity">Best Practice: Choose configuration values based on workload type and system capacity.</a></li>
</ul>
</li>
<li><a href="#6-analyzing-executors-source-code">6. Analyzing Executors Source Code</a></li>
<li><a href="#7-threadpoolexecutor-constructors-and-parameters">7. ThreadPoolExecutor Constructors and Parameters</a><ul>
<li><a href="#parameter-breakdown">Parameter Breakdown</a></li>
</ul>
</li>
<li><a href="#8-advanced-queue-management">8. Advanced Queue Management</a><ul>
<li><a href="#relationships-between-corepoolsize-and-maximumpoolsize">Relationships between <code>corePoolSize</code> and <code>maximumPoolSize</code></a></li>
<li><a href="#understanding-workqueue-types">Understanding workQueue Types</a></li>
</ul>
</li>
<li><a href="#9-thread-pool-scaling-strategies">9. Thread Pool Scaling Strategies</a><ul>
<li><a href="#recommended-scaling">Recommended Scaling:</a></li>
</ul>
</li>
<li><a href="#10-rejectedexecutionhandler-strategies-for-handling-excess-tasks">10. RejectedExecutionHandler: Strategies for Handling Excess Tasks</a></li>
<li><a href="#11-enhanced-monitoring-techniques">11. Enhanced Monitoring Techniques</a></li>
<li><a href="#12-backpressure-handling-in-production">12. Backpressure Handling in Production</a><ul>
<li><a href="#diagram-dynamic-task-flow-and-backpressure">Diagram: Dynamic Task Flow and Backpressure</a></li>
</ul>
</li>
<li><a href="#13-example">13. Example</a></li>
<li><a href="#14-conclusion">14. Conclusion</a></li>
</ul>
<p><a name="1-why-executors-is-discouraged"></a></p>
<h2 id="1-Why-Executors-is-Discouraged"><a href="#1-Why-Executors-is-Discouraged" class="headerlink" title="1. Why Executors is Discouraged"></a>1. Why Executors is Discouraged</h2><p>Java’s <strong><code>Executors</code></strong> class provides several factory methods to create various types of thread pools:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newSingleThreadScheduledExecutor</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span></span><br></pre></td></tr></table></figure>

<p>These convenience methods simplify thread pool creation, but they do not allow fine-tuning. <strong>Using <code>Executors</code> to create thread pools is generally discouraged</strong> due to potential risks, such as resource exhaustion. The official guidance is to use <strong><code>ThreadPoolExecutor</code></strong> directly, enabling full control over pool configurations, ensuring stability under varying load conditions.</p>
<h3 id="Example-Code-Not-Recommended"><a href="#Example-Code-Not-Recommended" class="headerlink" title="Example Code (Not Recommended)"></a>Example Code (Not Recommended)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">es</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Why it’s discouraged</strong>: Creating a thread pool this way can lead to issues like uncontrolled resource usage. <strong>Best practice</strong>: use <code>ThreadPoolExecutor</code> instead.</p>
<p><a name="2-threadpoolexecutor-introduction"></a></p>
<h2 id="2-ThreadPoolExecutor-Introduction"><a href="#2-ThreadPoolExecutor-Introduction" class="headerlink" title="2. ThreadPoolExecutor Introduction"></a>2. ThreadPoolExecutor Introduction</h2><p>Java’s <code>ThreadPoolExecutor</code> is a cornerstone of concurrent programming. It provides a high-performance, versatile API for managing threads and handling tasks, but it requires careful configuration to prevent resource wastage, improve system responsiveness, and enhance maintainability.</p>
<hr>
<p><a name="3-overview-of-threadpoolexecutor"></a></p>
<h2 id="3-Overview-of-ThreadPoolExecutor"><a href="#3-Overview-of-ThreadPoolExecutor" class="headerlink" title="3. Overview of ThreadPoolExecutor"></a>3. Overview of <code>ThreadPoolExecutor</code></h2><p>The <code>ThreadPoolExecutor</code> manages thread allocation, scaling, and task queueing while optimizing thread lifecycle to minimize system overhead. Here is a basic textual model of a <code>ThreadPoolExecutor</code> lifecycle and memory model:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">          +-----------------------------+</span><br><span class="line">          |         Task Queue          |</span><br><span class="line">          |   (BlockingQueue&lt;Runnable&gt;) |</span><br><span class="line">          +------------+----------------+</span><br><span class="line">                       |</span><br><span class="line">     +-----------------v-----------------+</span><br><span class="line">     |                                   |</span><br><span class="line">     |       ThreadPoolExecutor          |</span><br><span class="line">     |                                   |</span><br><span class="line">     +----------------+------------------+</span><br><span class="line">                       |</span><br><span class="line">+----------------------+--------------------+</span><br><span class="line">|      Worker Threads                       |</span><br><span class="line">|   +-----------------------------------+   |</span><br><span class="line">|   |           Worker Thread 1         |   |</span><br><span class="line">|   |-----------------------------------|   |</span><br><span class="line">|   |           Worker Thread 2         |   |</span><br><span class="line">|   |-----------------------------------|   |</span><br><span class="line">|   |           Worker Thread N         |   |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Worker Threads</strong>: Execute tasks within a controlled environment.</li>
<li><strong>Task Queue</strong>: Holds tasks awaiting execution, preventing unnecessary thread creation.</li>
<li><strong>ThreadPoolExecutor</strong>: Controls the execution strategy, pool scaling, and task rejection policies.</li>
</ul>
<hr>
<p><a name="4-recommended-usage-threadpoolexecutor"></a></p>
<h2 id="4-Recommended-Usage-ThreadPoolExecutor"><a href="#4-Recommended-Usage-ThreadPoolExecutor" class="headerlink" title="4. Recommended Usage: ThreadPoolExecutor"></a>4. Recommended Usage: ThreadPoolExecutor</h2><p>To avoid risks, <strong>use <code>ThreadPoolExecutor</code></strong> directly for creating thread pools:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">es</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">10</span>), Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="5-core-configuration-parameters"></a></p>
<h2 id="5-Core-Configuration-Parameters"><a href="#5-Core-Configuration-Parameters" class="headerlink" title="5. Core Configuration Parameters"></a>5. Core Configuration Parameters</h2><p>The <code>ThreadPoolExecutor</code> relies on several key configuration parameters:</p>
<ul>
<li><strong>corePoolSize</strong>: Minimum number of threads in the pool.</li>
<li><strong>maximumPoolSize</strong>: Maximum threads allowed in the pool.</li>
<li><strong>keepAliveTime</strong>: The time a thread can remain idle before termination if beyond corePoolSize.</li>
<li><strong>workQueue</strong>: Queue holding tasks before they are assigned to threads.</li>
</ul>
<h4 id="Best-Practice-Choose-configuration-values-based-on-workload-type-and-system-capacity"><a href="#Best-Practice-Choose-configuration-values-based-on-workload-type-and-system-capacity" class="headerlink" title="Best Practice: Choose configuration values based on workload type and system capacity."></a>Best Practice: Choose configuration values based on workload type and system capacity.</h4><hr>
<p><a name="6-analyzing-executors-source-code"></a></p>
<h2 id="6-Analyzing-Executors-Source-Code"><a href="#6-Analyzing-Executors-Source-Code" class="headerlink" title="6. Analyzing Executors Source Code"></a>6. Analyzing Executors Source Code</h2><p>The methods <code>newSingleThreadExecutor()</code>, <code>newFixedThreadPool(int nThreads)</code>, and <code>newCachedThreadPool()</code> all internally use <strong><code>ThreadPoolExecutor</code></strong>. Below are the source code implementations from JDK 8:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;())</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All three methods use <strong><code>ThreadPoolExecutor</code></strong> but provide different default configurations. These static methods abstract parameters, which can lead to undesired behaviors under high loads.</p>
<p><a name="7-threadpoolexecutor-constructors-and-parameters"></a></p>
<h2 id="7-ThreadPoolExecutor-Constructors-and-Parameters"><a href="#7-ThreadPoolExecutor-Constructors-and-Parameters" class="headerlink" title="7. ThreadPoolExecutor Constructors and Parameters"></a>7. ThreadPoolExecutor Constructors and Parameters</h2><p>When creating thread pools with <code>ThreadPoolExecutor</code>, initializing parameters must be specified. One of its constructors takes the following parameters:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize, <span class="type">int</span> maximumPoolSize, <span class="type">long</span> keepAliveTime, TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>

<h3 id="Parameter-Breakdown"><a href="#Parameter-Breakdown" class="headerlink" title="Parameter Breakdown"></a>Parameter Breakdown</h3><ul>
<li><strong><code>corePoolSize</code></strong>: Number of threads to keep in the pool.</li>
<li><strong><code>maximumPoolSize</code></strong>: Maximum number of threads allowed.</li>
<li><strong><code>keepAliveTime</code></strong>: Time limit for idle threads over <code>corePoolSize</code> before termination.</li>
<li><strong><code>unit</code></strong>: Unit of time for <code>keepAliveTime</code>.</li>
<li><strong><code>workQueue</code></strong>: Queue to hold tasks before execution.</li>
<li><strong><code>threadFactory</code></strong>: Factory for creating threads, usually <code>Executors.defaultThreadFactory()</code>.</li>
<li><strong><code>handler</code></strong>: Policy for handling tasks when the pool reaches its limit.</li>
</ul>
<p><a name="8-advanced-queue-management"></a></p>
<h2 id="8-Advanced-Queue-Management"><a href="#8-Advanced-Queue-Management" class="headerlink" title="8. Advanced Queue Management"></a>8. Advanced Queue Management</h2><p><strong>Choosing the Right Queue</strong>:</p>
<ol>
<li><strong>SynchronousQueue</strong>: No internal capacity, ideal for transient spikes.</li>
<li><strong>LinkedBlockingQueue</strong>: Unbounded, suitable for long-running processes.</li>
<li><strong>ArrayBlockingQueue</strong>: Fixed size, optimal for bounded workloads.</li>
</ol>
<blockquote>
<p><strong>Note</strong>: Select a queue type aligned with task load, duration, and resource availability.</p>
</blockquote>
<h3 id="Relationships-between-corePoolSize-and-maximumPoolSize"><a href="#Relationships-between-corePoolSize-and-maximumPoolSize" class="headerlink" title="Relationships between corePoolSize and maximumPoolSize"></a>Relationships between <code>corePoolSize</code> and <code>maximumPoolSize</code></h3><ul>
<li>If <strong><code>thread count &lt; corePoolSize</code></strong>, a new thread is created for each task.</li>
<li>If <strong><code>thread count &gt;= corePoolSize</code></strong>, tasks are added to the <strong>task queue</strong>.</li>
<li>If the <strong>queue is full</strong> and <strong><code>thread count &lt; maximumPoolSize</code></strong>, a new thread is created.</li>
<li>If <strong><code>thread count &gt;= maximumPoolSize</code></strong>, the <code>handler</code> policy determines the behavior.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: These relationships vary with the type of queue (bounded or unbounded). Unbounded queues will prevent maximum thread creation from being reached.</p>
</blockquote>
<p><a name="understanding-workqueue-types"></a></p>
<h3 id="Understanding-workQueue-Types"><a href="#Understanding-workQueue-Types" class="headerlink" title="Understanding workQueue Types"></a>Understanding workQueue Types</h3><p>The <strong><code>workQueue</code></strong> holds pending tasks that await execution. Different queue types handle tasks differently:</p>
<ul>
<li><strong><code>SynchronousQueue</code></strong>: A <strong>direct hand-off</strong> mechanism with no capacity. If no thread is immediately available, a new one is created or the task is rejected based on <code>maximumPoolSize</code>.</li>
<li><strong><code>LinkedBlockingQueue</code></strong>: An <strong>unbounded queue</strong>. When tasks exceed <code>corePoolSize</code>, they are added to the queue instead of creating new threads. <strong>Warning</strong>: Unbounded growth may exhaust memory if tasks are generated faster than processed.</li>
<li></li>
</ul>
<hr>
<p><a name="9-thread-pool-scaling-strategies"></a></p>
<h2 id="9-Thread-Pool-Scaling-Strategies"><a href="#9-Thread-Pool-Scaling-Strategies" class="headerlink" title="9. Thread Pool Scaling Strategies"></a>9. Thread Pool Scaling Strategies</h2><p>Efficient scaling balances resource use against workload demands. Consider using dynamic scaling mechanisms for responsive systems.</p>
<h4 id="Recommended-Scaling"><a href="#Recommended-Scaling" class="headerlink" title="Recommended Scaling:"></a>Recommended Scaling:</h4><ul>
<li><strong>FixedThreadPool</strong>: When task load and timing are predictable.</li>
<li><strong>CachedThreadPool</strong>: For unpredictable or short-lived task loads.</li>
</ul>
<hr>
<p><a name="10-rejectedexecutionhandler-strategies-for-handling-excess-tasks"></a></p>
<h2 id="10-RejectedExecutionHandler-Strategies-for-Handling-Excess-Tasks"><a href="#10-RejectedExecutionHandler-Strategies-for-Handling-Excess-Tasks" class="headerlink" title="10. RejectedExecutionHandler: Strategies for Handling Excess Tasks"></a>10. RejectedExecutionHandler: Strategies for Handling Excess Tasks</h2><p>When the pool and queue are full, the <strong><code>handler</code></strong> parameter specifies a strategy to handle tasks. Java provides four built-in policies:</p>
<ul>
<li><strong><code>DiscardOldestPolicy</code></strong>: Removes the oldest task in the queue to accommodate the new task.</li>
<li><strong><code>CallerRunsPolicy</code></strong>: Executes the task in the <strong>caller thread</strong> if the pool is busy, providing a backpressure mechanism.</li>
<li><strong><code>DiscardPolicy</code></strong>: Silently discards the task without further action.</li>
<li><strong><code>AbortPolicy</code></strong>: Throws an <strong>exception</strong> to signal that the pool is at capacity.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: Customize <code>RejectedExecutionHandler</code> based on workload characteristics. Expecially for applications where resilience is critical, <strong>consider implementing a custom rejection handler</strong> or using <code>CallerRunsPolicy</code> to limit load. Proper configuration can prevent issues like out-of-memory errors.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RejectedExecutionHandler</span> <span class="variable">customHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionHandler</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task rejected: &quot;</span> + r.toString());</span><br><span class="line">        <span class="comment">// custom logic for rejected task</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="11-enhanced-monitoring-techniques"></a></p>
<h2 id="11-Enhanced-Monitoring-Techniques"><a href="#11-Enhanced-Monitoring-Techniques" class="headerlink" title="11. Enhanced Monitoring Techniques"></a>11. Enhanced Monitoring Techniques</h2><p>Monitoring thread and queue activity is essential for real-time scaling and troubleshooting. Use the following tools and approaches:</p>
<ul>
<li><strong>JMX (Java Management Extensions)</strong>: For real-time metrics on threads, tasks, and system load.</li>
<li><strong>Thread Pool Executor’s <code>getPoolSize</code> and <code>getQueue().size()</code> Methods</strong>: To track runtime capacity and pending task counts.</li>
</ul>
<hr>
<p><a name="12-backpressure-handling-in-production"></a></p>
<h2 id="12-Backpressure-Handling-in-Production"><a href="#12-Backpressure-Handling-in-Production" class="headerlink" title="12. Backpressure Handling in Production"></a>12. Backpressure Handling in Production</h2><p>Backpressure handling in high-demand environments prevents overloads by controlling the flow of tasks:</p>
<ul>
<li><strong>Rejection Policies</strong>: Define fallback strategies for rejected tasks.</li>
<li><strong>Queue Sizing</strong>: Set boundaries on task input rate.</li>
</ul>
<h4 id="Diagram-Dynamic-Task-Flow-and-Backpressure"><a href="#Diagram-Dynamic-Task-Flow-and-Backpressure" class="headerlink" title="Diagram: Dynamic Task Flow and Backpressure"></a>Diagram: Dynamic Task Flow and Backpressure</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Client Requests</span><br><span class="line">      |</span><br><span class="line"> +----v----+     Backpressure Control</span><br><span class="line"> | Task    |--------------------+</span><br><span class="line"> | Queue   |                    |</span><br><span class="line"> +---------+                    |</span><br><span class="line">       |                        |</span><br><span class="line">+------v-------+                |</span><br><span class="line">| Thread       |                |</span><br><span class="line">| Pool         |                |</span><br><span class="line">+--------------+----------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="13-example"></a></p>
<h2 id="13-Example"><a href="#13-Example" class="headerlink" title="13. Example"></a>13. Example</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedThreadPoolExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Configure core parameters with scaling strategy</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">4</span>,                <span class="comment">// core pool size</span></span><br><span class="line">            <span class="number">10</span>,               <span class="comment">// maximum pool size</span></span><br><span class="line">            <span class="number">30</span>,               <span class="comment">// keep-alive time</span></span><br><span class="line">            TimeUnit.SECONDS, <span class="comment">// keep-alive time unit</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">100</span>), <span class="comment">// task queue type</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// rejection policy</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Simulate task submission</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">            executor.submit(<span class="keyword">new</span> <span class="title class_">Task</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> taskId;</span><br><span class="line"></span><br><span class="line">        Task(<span class="type">int</span> taskId) &#123;</span><br><span class="line">            <span class="built_in">this</span>.taskId = taskId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Executing Task &quot;</span> + taskId);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>); <span class="comment">// Simulate work</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="14-conclusion"></a></p>
<h2 id="14-Conclusion"><a href="#14-Conclusion" class="headerlink" title="14. Conclusion"></a>14. Conclusion</h2><p><strong>Summary</strong>: Use <code>ThreadPoolExecutor</code> directly with appropriately sized pools, tailored queue types, and effective rejection policies to ensure optimal, safe performance. Mastering <code>ThreadPoolExecutor</code> for complex, production-grade applications requires an understanding of core parameters, workload patterns, and monitoring needs. These best practices are intended to improve performance, efficiency, and system resilience in multithreaded environments.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Best-Practices-of-Java-Core-Multi-Threading-Programming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Best-Practices-of-Java-Core-Multi-Threading-Programming/" class="post-title-link" itemprop="url">Best Practices of Java Core Multi-Threading Programming</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 22:39:28 / Modified: 22:44:41" itemprop="dateCreated datePublished" datetime="2024-10-28T22:39:28-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/" itemprop="url" rel="index"><span itemprop="name">Best Practices</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Best-Practices/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#thread-safety">Thread Safety</a><ul>
<li><a href="#use-synchronization-wisely">Use Synchronization Wisely</a></li>
<li><a href="#avoid-excessive-synchronization">Avoid Excessive Synchronization</a></li>
<li><a href="#use-atomic-classes">Use Atomic Classes</a></li>
</ul>
</li>
<li><a href="#thread-communication">Thread Communication</a><ul>
<li><a href="#use-wait-and-notify">Use wait() and notify()</a></li>
<li><a href="#avoid-busy-waiting">Avoid Busy Waiting</a></li>
</ul>
</li>
<li><a href="#thread-pooling">Thread Pooling</a><ul>
<li><a href="#use-executorservice">Use ExecutorService</a></li>
<li><a href="#custom-thread-pools">Custom Thread Pools</a></li>
</ul>
</li>
<li><a href="#deadlock-prevention">Deadlock Prevention</a><ul>
<li><a href="#lock-ordering">Lock Ordering</a></li>
<li><a href="#timeout-mechanisms">Timeout Mechanisms</a></li>
</ul>
</li>
<li><a href="#concurrency-utilities">Concurrency Utilities</a><ul>
<li><a href="#use-concurrent-collections">Use Concurrent Collections</a></li>
<li><a href="#forkjoin-framework">Fork&#x2F;Join Framework</a></li>
</ul>
</li>
<li><a href="#thread-local-variables">Thread Local Variables</a></li>
<li><a href="#example-concurrent-web-server">Example: Concurrent Web Server</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Java’s multi-threading capabilities are powerful, but they require careful handling to avoid common pitfalls such as race conditions, deadlocks, and excessive synchronization. This article provides a deep dive into best practices for Java core multi-threading programming, including detailed textual diagrams, explanations, and real-life production sample code.</p>
<hr>
<p><a name="thread-safety"></a></p>
<h2 id="Thread-Safety"><a href="#Thread-Safety" class="headerlink" title="Thread Safety"></a>Thread Safety</h2><p><a name="use-synchronization-wisely"></a></p>
<h3 id="Use-Synchronization-Wisely"><a href="#Use-Synchronization-Wisely" class="headerlink" title="Use Synchronization Wisely"></a>Use Synchronization Wisely</h3><p>Synchronization ensures that only one thread can execute a synchronized block or method at a time. However, excessive synchronization can lead to performance bottlenecks.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Thread 1       |&lt;-----&gt;|    Shared Resource|</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Thread 2       |&lt;-----&gt;|    Shared Resource|</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Counter</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Counter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Count: &quot;</span> + counter.getCount()); <span class="comment">// Count: 2000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="avoid-excessive-synchronization"></a></p>
<h3 id="Avoid-Excessive-Synchronization"><a href="#Avoid-Excessive-Synchronization" class="headerlink" title="Avoid Excessive Synchronization"></a>Avoid Excessive Synchronization</h3><p>Excessive synchronization can lead to performance issues. Use finer-grained locks or non-blocking algorithms where possible.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FineGrainedCounter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="use-atomic-classes"></a></p>
<h3 id="Use-Atomic-Classes"><a href="#Use-Atomic-Classes" class="headerlink" title="Use Atomic Classes"></a>Use Atomic Classes</h3><p>Atomic classes provide thread-safe operations on single variables without the need for explicit synchronization.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AtomicCounter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">AtomicCounter</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicCounter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Count: &quot;</span> + counter.getCount()); <span class="comment">// Count: 2000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="thread-communication"></a></p>
<h2 id="Thread-Communication"><a href="#Thread-Communication" class="headerlink" title="Thread Communication"></a>Thread Communication</h2><p><a name="use-wait-and-notify"></a></p>
<h3 id="Use-wait-and-notify"><a href="#Use-wait-and-notify" class="headerlink" title="Use wait() and notify()"></a>Use wait() and notify()</h3><p>Threads can communicate using <code>wait()</code>, <code>notify()</code>, and <code>notifyAll()</code> methods.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Producer       |&lt;-----&gt;|    Consumer       |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Shared Buffer  |&lt;-----&gt;|    Shared Buffer  |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SharedBuffer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] buffer = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(<span class="type">int</span> value)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == buffer.length) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        buffer[count++] = value;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">consume</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> buffer[--count];</span><br><span class="line">        notifyAll();</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SharedBuffer buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(SharedBuffer buffer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.buffer = buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                buffer.produce(i);</span><br><span class="line">                System.out.println(<span class="string">&quot;Produced: &quot;</span> + i);</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SharedBuffer buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(SharedBuffer buffer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.buffer = buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> buffer.consume();</span><br><span class="line">                System.out.println(<span class="string">&quot;Consumed: &quot;</span> + value);</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SharedBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedBuffer</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Producer</span>(buffer)).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(buffer)).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="avoid-busy-waiting"></a></p>
<h3 id="Avoid-Busy-Waiting"><a href="#Avoid-Busy-Waiting" class="headerlink" title="Avoid Busy Waiting"></a>Avoid Busy Waiting</h3><p>Busy waiting is inefficient and should be avoided. Use <code>wait()</code> and <code>notify()</code> instead.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BusyWaitExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setFlag</span><span class="params">(<span class="type">boolean</span> flag)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.flag = flag;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">waitForFlag</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">while</span> (!flag) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="thread-pooling"></a></p>
<h2 id="Thread-Pooling"><a href="#Thread-Pooling" class="headerlink" title="Thread Pooling"></a>Thread Pooling</h2><p><a name="use-executorservice"></a></p>
<h3 id="Use-ExecutorService"><a href="#Use-ExecutorService" class="headerlink" title="Use ExecutorService"></a>Use ExecutorService</h3><p>Thread pooling manages a pool of worker threads to execute tasks concurrently.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Task 1         |&lt;-----&gt;|    Thread Pool    |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Task 2         |&lt;-----&gt;|    Worker Threads |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; is running&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="custom-thread-pools"></a></p>
<h3 id="Custom-Thread-Pools"><a href="#Custom-Thread-Pools" class="headerlink" title="Custom Thread Pools"></a>Custom Thread Pools</h3><p>Custom thread pools can be created using <code>ThreadPoolExecutor</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; is running&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executor.shutdown();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            executor.awaitTermination(<span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="deadlock-prevention"></a></p>
<h2 id="Deadlock-Prevention"><a href="#Deadlock-Prevention" class="headerlink" title="Deadlock Prevention"></a>Deadlock Prevention</h2><p><a name="lock-ordering"></a></p>
<h3 id="Lock-Ordering"><a href="#Lock-Ordering" class="headerlink" title="Lock Ordering"></a>Lock Ordering</h3><p>Ensure that locks are acquired in a consistent order to prevent deadlocks.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Thread 1       |&lt;-----&gt;|    Resource A     |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Thread 2       |&lt;-----&gt;|    Resource B     |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock1) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1: Holding lock 1...&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1: Waiting for lock 2...&quot;</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (lock2) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 1: Holding lock 1 &amp; 2...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock1) &#123; <span class="comment">// Acquire locks in the same order</span></span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2: Holding lock 1...&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2: Waiting for lock 2...&quot;</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (lock2) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 2: Holding lock 1 &amp; 2...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="timeout-mechanisms"></a></p>
<h3 id="Timeout-Mechanisms"><a href="#Timeout-Mechanisms" class="headerlink" title="Timeout Mechanisms"></a>Timeout Mechanisms</h3><p>Use timeouts to avoid waiting indefinitely for a lock.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lock1.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 1: Holding lock 1...&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">                    <span class="keyword">if</span> (lock2.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Thread 1: Holding lock 1 &amp; 2...&quot;</span>);</span><br><span class="line">                        lock2.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                    lock1.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lock1.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 2: Holding lock 1...&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">                    <span class="keyword">if</span> (lock2.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Thread 2: Holding lock 1 &amp; 2...&quot;</span>);</span><br><span class="line">                        lock2.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                    lock1.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="concurrency-utilities"></a></p>
<h2 id="Concurrency-Utilities"><a href="#Concurrency-Utilities" class="headerlink" title="Concurrency Utilities"></a>Concurrency Utilities</h2><p><a name="use-concurrent-collections"></a></p>
<h3 id="Use-Concurrent-Collections"><a href="#Use-Concurrent-Collections" class="headerlink" title="Use Concurrent Collections"></a>Use Concurrent Collections</h3><p>Concurrent collections provide thread-safe data structures.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConcurrentHashMap&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                map.put(<span class="string">&quot;Key&quot;</span> + i, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                map.put(<span class="string">&quot;Key&quot;</span> + i, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t1.join();</span><br><span class="line">            t2.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Map size: &quot;</span> + map.size()); <span class="comment">// Map size: 1000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="fork-join-framework"></a></p>
<h3 id="Fork-Join-Framework"><a href="#Fork-Join-Framework" class="headerlink" title="Fork&#x2F;Join Framework"></a>Fork&#x2F;Join Framework</h3><p>The Fork&#x2F;Join framework is designed for tasks that can be recursively split into smaller tasks.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SumTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] array;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SumTask</span><span class="params">(<span class="type">int</span>[] array, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.array = array;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (end - start &lt;= THRESHOLD) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) &#123;</span><br><span class="line">                sum += array[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (start + end) / <span class="number">2</span>;</span><br><span class="line">            <span class="type">SumTask</span> <span class="variable">leftTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(array, start, mid);</span><br><span class="line">            <span class="type">SumTask</span> <span class="variable">rightTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(array, mid, end);</span><br><span class="line">            leftTask.fork();</span><br><span class="line">            <span class="type">int</span> <span class="variable">rightResult</span> <span class="operator">=</span> rightTask.compute();</span><br><span class="line">            <span class="type">int</span> <span class="variable">leftResult</span> <span class="operator">=</span> leftTask.join();</span><br><span class="line">            <span class="keyword">return</span> leftResult + rightResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">            array[i] = i + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> pool.invoke(<span class="keyword">new</span> <span class="title class_">SumTask</span>(array, <span class="number">0</span>, array.length));</span><br><span class="line">        System.out.println(<span class="string">&quot;Sum: &quot;</span> + sum); <span class="comment">// Sum: 5050</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="thread-local-variables"></a></p>
<h2 id="Thread-Local-Variables"><a href="#Thread-Local-Variables" class="headerlink" title="Thread Local Variables"></a>Thread Local Variables</h2><p>ThreadLocal variables allow each thread to have its own copy of a variable.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1: &quot;</span> + threadLocal.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="number">2</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2: &quot;</span> + threadLocal.get());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="example-concurrent-web-server"></a></p>
<h2 id="Example-Concurrent-Web-Server"><a href="#Example-Concurrent-Web-Server" class="headerlink" title="Example: Concurrent Web Server"></a>Example: Concurrent Web Server</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequestHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Socket clientSocket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RequestHandler</span><span class="params">(Socket clientSocket)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.clientSocket = clientSocket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Handle the client request</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Handling request from &quot;</span> + clientSocket.getInetAddress());</span><br><span class="line">            <span class="comment">// Simulate processing time</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            clientSocket.getOutputStream().write(<span class="string">&quot;HTTP/1.1 200 OK\r\n\r\nHello, World!&quot;</span>.getBytes());</span><br><span class="line">            clientSocket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            executor.submit(<span class="keyword">new</span> <span class="title class_">RequestHandler</span>(clientSocket));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Java’s multi-threading capabilities are powerful, but they require careful handling to avoid common pitfalls such as race conditions, deadlocks, and excessive synchronization. By following the best practices outlined in this article, you can write robust, high-performance Java applications that leverage the full potential of multi-threading. The provided real-life production sample code illustrates how these concepts can be applied in practical scenarios.</p>
<hr>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.amazon.com/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601">Java Concurrency in Practice</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Thread.html">Oracle Java Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html">Java Memory Model</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/ForkJoinPool.html">Fork&#x2F;Join Framework</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/package-summary.html">Concurrent Collections</a></li>
</ol>
<p>By mastering these concepts and practices, you can build robust, high-performance Java applications that leverage the full potential of multi-threading.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Deep-Dive-into-Java-Core-Multi-Threading-Concepts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Deep-Dive-into-Java-Core-Multi-Threading-Concepts/" class="post-title-link" itemprop="url">Deep Dive into Java Core Multi-Threading Concepts</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 22:04:14 / Modified: 22:40:22" itemprop="dateCreated datePublished" datetime="2024-10-28T22:04:14-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/" itemprop="url" rel="index"><span itemprop="name">Deep Dive</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/" itemprop="url" rel="index"><span itemprop="name">Java Core</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Deep-Dive/Java-Core/Multi-Threading/" itemprop="url" rel="index"><span itemprop="name">Multi-Threading</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#1-java-thread-model">1. Java Thread Model</a></li>
<li><a href="#2-java-memory-model-jmm">2. Java Memory Model (JMM)</a><ul>
<li><a href="#java-thread-memory-model-diagram">Java Thread Memory Model Diagram</a></li>
<li><a href="#jmm-key-concepts">JMM Key Concepts:</a></li>
</ul>
</li>
<li><a href="#3-thread-lifecycle-and-state-machine">3. Thread Lifecycle and State Machine</a><ul>
<li><a href="#thread-state-machine-diagram">Thread State Machine Diagram</a></li>
</ul>
</li>
<li><a href="#4-key-threading-classes-in-java">4. Key Threading Classes in Java</a><ul>
<li><a href="#41-thread-class">4.1 Thread Class</a></li>
<li><a href="#42-runnable-interface">4.2 Runnable Interface</a></li>
<li><a href="#43-callable-and-future">4.3 Callable and Future</a></li>
<li><a href="#44-executors-framework">4.4 Executors Framework</a></li>
</ul>
</li>
<li><a href="#5-synchronization-and-locks">5. Synchronization and Locks</a><ul>
<li><a href="#synchronized">Synchronized</a></li>
<li><a href="#reentrantlock">ReentrantLock</a></li>
</ul>
</li>
<li><a href="#6-real-life-production-example">6. Real-Life Production Example</a><ul>
<li><a href="#explanation">Explanation</a></li>
</ul>
</li>
</ul>
<hr>
<p>Java multithreading is a fundamental part of the language that allows concurrent execution of multiple parts of a program to achieve greater efficiency and responsiveness. This article explores the latest Java version’s core multithreading concepts, the Java Memory Model (JMM), thread lifecycle, key classes, and real-life examples.</p>
<p><a name="java-thread-model"></a></p>
<h2 id="1-Java-Thread-Model"><a href="#1-Java-Thread-Model" class="headerlink" title="1. Java Thread Model"></a>1. Java Thread Model</h2><p>Java’s thread model is based on the OS thread model, providing abstraction to manage and create threads directly. Java threads allow programs to perform multiple tasks concurrently, improving resource utilization. Thread priorities help in determining the order of thread execution, though scheduling ultimately depends on the underlying OS.</p>
<p><a name="java-memory-model"></a></p>
<h2 id="2-Java-Memory-Model-JMM"><a href="#2-Java-Memory-Model-JMM" class="headerlink" title="2. Java Memory Model (JMM)"></a>2. Java Memory Model (JMM)</h2><p><a name="java-memory-model-diagram"></a></p>
<h3 id="Java-Thread-Memory-Model-Diagram"><a href="#Java-Thread-Memory-Model-Diagram" class="headerlink" title="Java Thread Memory Model Diagram"></a>Java Thread Memory Model Diagram</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Main Memory    |&lt;-----&gt;|    Thread 1       |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    Thread 2       |&lt;-----&gt;|    Thread 3       |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<p>The Java Memory Model (JMM) defines how threads interact through memory and what values can be read or written by threads. The JMM provides:</p>
<ol>
<li><strong>Visibility</strong>: Changes made by one thread are visible to other threads.</li>
<li><strong>Atomicity</strong>: Certain actions are indivisible or atomic.</li>
<li><strong>Ordering</strong>: The sequence in which instructions are executed.</li>
</ol>
<h3 id="JMM-Key-Concepts"><a href="#JMM-Key-Concepts" class="headerlink" title="JMM Key Concepts:"></a>JMM Key Concepts:</h3><ul>
<li><strong>Happens-Before Relationship</strong>: Ensures that memory writes by one specific action are visible to another specific action.</li>
<li><strong>Volatile Keyword</strong>: Variables declared as <code>volatile</code> ensure visibility of changes across threads.</li>
<li><strong>Synchronized Blocks</strong>: Using <code>synchronized</code> enforces an order of access to variables between threads.</li>
</ul>
<p><a name="thread-lifecycle-and-state-machine"></a></p>
<h2 id="3-Thread-Lifecycle-and-State-Machine"><a href="#3-Thread-Lifecycle-and-State-Machine" class="headerlink" title="3. Thread Lifecycle and State Machine"></a>3. Thread Lifecycle and State Machine</h2><p>Java threads go through several states:</p>
<table>
<thead>
<tr>
<th>State</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>New</td>
<td>The thread is created but not yet started.</td>
</tr>
<tr>
<td>Runnable</td>
<td>The thread is eligible to run but may be waiting for a CPU cycle.</td>
</tr>
<tr>
<td>Blocked</td>
<td>The thread is waiting to acquire a lock to enter a <code>synchronized</code> block.</td>
</tr>
<tr>
<td>Waiting</td>
<td>The thread is waiting indefinitely for another thread to perform an action.</td>
</tr>
<tr>
<td>Timed Waiting</td>
<td>The thread is waiting for another thread for a specified period.</td>
</tr>
<tr>
<td>Terminated</td>
<td>The thread has completed execution.</td>
</tr>
</tbody></table>
<p><a name="java-state-machine-diagram"></a></p>
<h3 id="Thread-State-Machine-Diagram"><a href="#Thread-State-Machine-Diagram" class="headerlink" title="Thread State Machine Diagram"></a>Thread State Machine Diagram</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NEW -&gt; Runnable -&gt; BLOCKED -&gt; WAITING &lt;-&gt; TIMED_WAITING -&gt; TERMINATED</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    NEW            |------&gt;|    RUNNABLE       |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    BLOCKED        |&lt;-----&gt;|    WAITING        |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">        |                           |</span><br><span class="line">        |                           |</span><br><span class="line">        v                           v</span><br><span class="line">+-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |</span><br><span class="line">|    TIMED_WAITING  |&lt;-----&gt;|    TERMINATED     |</span><br><span class="line">|                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<p><a name="key-threading-classes"></a></p>
<h2 id="4-Key-Threading-Classes-in-Java"><a href="#4-Key-Threading-Classes-in-Java" class="headerlink" title="4. Key Threading Classes in Java"></a>4. Key Threading Classes in Java</h2><p><a name="thread-class"></a></p>
<h3 id="4-1-Thread-Class"><a href="#4-1-Thread-Class" class="headerlink" title="4.1 Thread Class"></a>4.1 Thread Class</h3><p>The <code>Thread</code> class provides methods to create, start, and manage threads. You can define a custom thread by extending the <code>Thread</code> class and overriding its <code>run()</code> method.</p>
<p>Example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Thread is running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">MyThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">thread.start();</span><br></pre></td></tr></table></figure>

<p><a name="runnable-interface"></a></p>
<h3 id="4-2-Runnable-Interface"><a href="#4-2-Runnable-Interface" class="headerlink" title="4.2 Runnable Interface"></a>4.2 Runnable Interface</h3><p>The <code>Runnable</code> interface is a functional interface representing a task to be executed on a thread. It separates the task from the thread itself, allowing reusability and flexibility.</p>
<p>Example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Runnable is running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyRunnable</span>());</span><br><span class="line">thread.start();</span><br></pre></td></tr></table></figure>

<p><a name="callable-and-future"></a></p>
<h3 id="4-3-Callable-and-Future"><a href="#4-3-Callable-and-Future" class="headerlink" title="4.3 Callable and Future"></a>4.3 Callable and Future</h3><p><code>Callable</code> allows tasks to return results or throw checked exceptions, while <code>Future</code> represents the result of an asynchronous computation.</p>
<p>Example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Callable&lt;Integer&gt; task = () -&gt; &#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">Future&lt;Integer&gt; future = executor.submit(task);</span><br><span class="line"></span><br><span class="line"><span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> future.get();  <span class="comment">// blocks until the result is available</span></span><br><span class="line">executor.shutdown();</span><br></pre></td></tr></table></figure>

<p><a name="executors-framework"></a></p>
<h3 id="4-4-Executors-Framework"><a href="#4-4-Executors-Framework" class="headerlink" title="4.4 Executors Framework"></a>4.4 Executors Framework</h3><p>The Executors framework provides a higher-level API for thread management, thread pooling, and scheduling, abstracting the creation and management of threads.</p>
<p>Example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    executor.submit(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Task running&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">executor.shutdown();</span><br></pre></td></tr></table></figure>

<p><a name="synchronization-and-locks"></a></p>
<h2 id="5-Synchronization-and-Locks"><a href="#5-Synchronization-and-Locks" class="headerlink" title="5. Synchronization and Locks"></a>5. Synchronization and Locks</h2><p>Java provides several ways to control access to shared resources, including synchronized methods and blocks, the <code>ReentrantLock</code> class, and the <code>ReadWriteLock</code>.</p>
<h3 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h3><p>The <code>synchronized</code> keyword ensures that only one thread can access a method or block at a time.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p><code>ReentrantLock</code> provides explicit lock mechanisms, giving more control over thread coordination.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// critical section</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="real-life-production-example"></a></p>
<h2 id="6-Real-Life-Production-Example"><a href="#6-Real-Life-Production-Example" class="headerlink" title="6. Real-Life Production Example"></a>6. Real-Life Production Example</h2><p>Consider a production scenario where we have multiple tasks needing parallel execution but require control over access to shared resources. Here’s a multithreaded solution using a <code>ScheduledExecutorService</code> in a banking transaction processing system.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">scheduler</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="comment">// Simulate fetching and processing a transaction</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Processing transaction: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);  <span class="comment">// Simulating a transaction processing delay</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Schedule at fixed rate</span></span><br><span class="line">        scheduler.scheduleAtFixedRate(task, <span class="number">0</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">TransactionProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionProcessor</span>();</span><br><span class="line">        processor.startProcessing();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h3><ul>
<li>We use <code>ScheduledExecutorService</code> for periodic transaction processing.</li>
<li>The thread pool’s <code>scheduleAtFixedRate</code> method ensures that the task runs every 5 seconds, enabling controlled execution with set intervals.</li>
<li>This design is beneficial in systems where tasks need continuous or scheduled processing but must prevent overloading resources.</li>
</ul>
<hr>
<p>This article provides an overview of multithreading concepts, memory models, core classes, and real-world examples. Java’s concurrency mechanisms offer flexibility and control, making it essential to use these constructs carefully to manage resources efficiently and avoid pitfalls such as deadlocks and race conditions.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Using-GlusterFS-with-Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Using-GlusterFS-with-Kubernetes/" class="post-title-link" itemprop="url">Using GlusterFS with Kubernetes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 21:46:06 / Modified: 21:47:14" itemprop="dateCreated datePublished" datetime="2024-10-28T21:46:06-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Distributed-File-System/" itemprop="url" rel="index"><span itemprop="name">Distributed File System</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Distributed-File-System/GlusterFS/" itemprop="url" rel="index"><span itemprop="name">GlusterFS</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Distributed-File-System/GlusterFS/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#glusterfs-overview">GlusterFS Overview</a><ul>
<li><a href="#-key-features"> Key Features</a></li>
<li><a href="#-architecture"> Architecture</a></li>
<li><a href="#-use-cases"> Use Cases</a></li>
</ul>
</li>
<li><a href="#mounting-glusterfs-with-kubernetes">Mounting GlusterFS with Kubernetes</a><ul>
<li><a href="#-step-1-install-glusterfs-client"> Step 1: Install GlusterFS Client</a></li>
<li><a href="#-step-2-create-a-glusterfs-volume"> Step 2: Create a GlusterFS Volume</a></li>
<li><a href="#-step-3-create-a-persistent-volume-pv"> Step 3: Create a Persistent Volume (PV)</a></li>
<li><a href="#-step-4-create-a-persistent-volume-claim-pvc"> Step 4: Create a Persistent Volume Claim (PVC)</a></li>
<li><a href="#-step-5-use-the-pvc-in-a-pod"> Step 5: Use the PVC in a Pod</a></li>
</ul>
</li>
<li><a href="#textual-diagram-of-glusterfs-architecture">Textual Diagram of GlusterFS Architecture</a></li>
<li><a href="#comparison-with-other-main-alternatives">Comparison with Other Main Alternatives</a><ul>
<li><a href="#-nfs-network-file-system"> NFS (Network File System)</a></li>
<li><a href="#-ceph"> Ceph</a></li>
<li><a href="#-amazon-efs-elastic-file-system"> Amazon EFS (Elastic File System)</a></li>
<li><a href="#-openebs"> OpenEBS</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This article provides a comprehensive guide on using GlusterFS with Kubernetes. It covers the basics of GlusterFS, its architecture, and how to mount GlusterFS as the file system for a Pod in Kubernetes. Additionally, it compares GlusterFS with other main alternatives in the storage landscape.</p>
<hr>
<p><a name="glusterfs-overview"></a></p>
<h2 id="GlusterFS-Overview"><a href="#GlusterFS-Overview" class="headerlink" title="GlusterFS Overview"></a>GlusterFS Overview</h2><p><strong>GlusterFS</strong> (Gluster File System) is an open-source, distributed file system designed to scale out in building-block fashion to store petabytes of data. It aggregates various storage servers over Ethernet or InfiniBand RDMA interconnects into one large parallel network file system. GlusterFS is part of the Gluster project, an effort by Red Hat to provide a unified distributed storage solution.</p>
<h3 id="Key-Features"><a href="#Key-Features" class="headerlink" title=" Key Features"></a><a name="key-features"></a> Key Features</h3><ol>
<li><strong>Scalability</strong>: GlusterFS can scale to several petabytes and handle thousands of clients.</li>
<li><strong>Flexibility</strong>: It uses a stackable user space design, allowing for flexible topologies for data storage and retrieval.</li>
<li><strong>High Availability</strong>: GlusterFS provides features like replication and failover to ensure data availability and reliability.</li>
<li><strong>Performance</strong>: It uses various data access protocols like NFS, SMB, and native GlusterFS protocol to optimize performance.</li>
<li><strong>Elasticity</strong>: GlusterFS can dynamically add or remove storage resources without disrupting services.</li>
</ol>
<h3 id="Architecture"><a href="#Architecture" class="headerlink" title=" Architecture"></a><a name="architecture"></a> Architecture</h3><p>GlusterFS architecture is based on a client-server model, where the storage servers (bricks) are the servers, and the clients access the data through the GlusterFS client. The architecture is modular, allowing for various configurations and optimizations.</p>
<ol>
<li><strong>Bricks</strong>: Basic units of storage, represented as directories on servers.</li>
<li><strong>Volumes</strong>: Logical collections of bricks. Data is striped, replicated, or distributed across these bricks.</li>
<li><strong>Translators</strong>: Modules that perform various functions like I&#x2F;O, network, and protocol handling.</li>
</ol>
<h3 id="Use-Cases"><a href="#Use-Cases" class="headerlink" title=" Use Cases"></a><a name="use-cases"></a> Use Cases</h3><ul>
<li><strong>Big Data and Analytics</strong>: Suitable for storing and processing large datasets.</li>
<li><strong>Media Streaming</strong>: Efficiently handles large media files.</li>
<li><strong>Backup and Archiving</strong>: Provides reliable storage for backups and archives.</li>
<li><strong>Cloud Storage</strong>: Acts as a scalable storage backend for cloud services.</li>
</ul>
<hr>
<p><a name="mounting-glusterfs-with-kubernetes"></a></p>
<h2 id="Mounting-GlusterFS-with-Kubernetes"><a href="#Mounting-GlusterFS-with-Kubernetes" class="headerlink" title="Mounting GlusterFS with Kubernetes"></a>Mounting GlusterFS with Kubernetes</h2><p>To use GlusterFS as the file system for a Pod in Kubernetes, you need to create a Persistent Volume (PV) and a Persistent Volume Claim (PVC). Below are the steps to achieve this:</p>
<h3 id="Step-1-Install-GlusterFS-Client"><a href="#Step-1-Install-GlusterFS-Client" class="headerlink" title=" Step 1: Install GlusterFS Client"></a><a name="step-1-install-glusterfs-client"></a> Step 1: Install GlusterFS Client</h3><p>Ensure that the GlusterFS client (<code>glusterfs-client</code>) is installed on all Kubernetes nodes. This client is necessary for mounting GlusterFS volumes.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install glusterfs-client</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Create-a-GlusterFS-Volume"><a href="#Step-2-Create-a-GlusterFS-Volume" class="headerlink" title=" Step 2: Create a GlusterFS Volume"></a><a name="step-2-create-a-glusterfs-volume"></a> Step 2: Create a GlusterFS Volume</h3><p>Create a GlusterFS volume on your GlusterFS cluster. For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gluster volume create k8s-volume replica 3 server1:/brick1 server2:/brick2 server3:/brick3 force</span><br><span class="line">gluster volume start k8s-volume</span><br></pre></td></tr></table></figure>

<h3 id="Step-3-Create-a-Persistent-Volume-PV"><a href="#Step-3-Create-a-Persistent-Volume-PV" class="headerlink" title=" Step 3: Create a Persistent Volume (PV)"></a><a name="step-3-create-a-persistent-volume-pv"></a> Step 3: Create a Persistent Volume (PV)</h3><p>Create a PV that references the GlusterFS volume.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gluster-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">glusterfs:</span></span><br><span class="line">    <span class="attr">endpoints:</span> <span class="string">&quot;glusterfs-cluster&quot;</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;k8s-volume&quot;</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-4-Create-a-Persistent-Volume-Claim-PVC"><a href="#Step-4-Create-a-Persistent-Volume-Claim-PVC" class="headerlink" title=" Step 4: Create a Persistent Volume Claim (PVC)"></a><a name="step-4-create-a-persistent-volume-claim-pvc"></a> Step 4: Create a Persistent Volume Claim (PVC)</h3><p>Create a PVC that binds to the PV.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gluster-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure>

<h3 id="Step-5-Use-the-PVC-in-a-Pod"><a href="#Step-5-Use-the-PVC-in-a-Pod" class="headerlink" title=" Step 5: Use the PVC in a Pod"></a><a name="step-5-use-the-pvc-in-a-pod"></a> Step 5: Use the PVC in a Pod</h3><p>Mount the PVC in a Pod.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gluster-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">gluster-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gluster-volume</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">gluster-pvc</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="textual-diagram-of-glusterfs-architecture"></a></p>
<h2 id="Textual-Diagram-of-GlusterFS-Architecture"><a href="#Textual-Diagram-of-GlusterFS-Architecture" class="headerlink" title="Textual Diagram of GlusterFS Architecture"></a>Textual Diagram of GlusterFS Architecture</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+       +-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |       |                   |</span><br><span class="line">|  GlusterFS Client |&lt;-----&gt;|  GlusterFS Server |&lt;-----&gt;|  GlusterFS Server |</span><br><span class="line">|                   |       |                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+       +-------------------+</span><br><span class="line">        |                           |                           |</span><br><span class="line">        |                           |                           |</span><br><span class="line">        v                           v                           v</span><br><span class="line">+-------------------+       +-------------------+       +-------------------+</span><br><span class="line">|                   |       |                   |       |                   |</span><br><span class="line">|    Brick 1        |       |    Brick 2        |       |    Brick 3        |</span><br><span class="line">|                   |       |                   |       |                   |</span><br><span class="line">+-------------------+       +-------------------+       +-------------------+</span><br></pre></td></tr></table></figure>

<hr>
<p><a name="comparison-with-other-main-alternatives"></a></p>
<h2 id="Comparison-with-Other-Main-Alternatives"><a href="#Comparison-with-Other-Main-Alternatives" class="headerlink" title="Comparison with Other Main Alternatives"></a>Comparison with Other Main Alternatives</h2><h3 id="NFS-Network-File-System"><a href="#NFS-Network-File-System" class="headerlink" title=" NFS (Network File System)"></a><a name="nfs-network-file-system"></a> NFS (Network File System)</h3><ul>
<li><strong>Pros</strong>:<ul>
<li>Simple to set up and manage.</li>
<li>Widely supported and well-documented.</li>
</ul>
</li>
<li><strong>Cons</strong>:<ul>
<li>Single point of failure.</li>
<li>Limited scalability compared to GlusterFS.</li>
<li>Performance can degrade with high latency.</li>
</ul>
</li>
</ul>
<h3 id="Ceph"><a href="#Ceph" class="headerlink" title=" Ceph"></a><a name="ceph"></a> Ceph</h3><ul>
<li><strong>Pros</strong>:<ul>
<li>Highly scalable and fault-tolerant.</li>
<li>Supports object, block, and file storage.</li>
<li>Active community and strong support.</li>
</ul>
</li>
<li><strong>Cons</strong>:<ul>
<li>Complex to set up and manage.</li>
<li>Requires significant resources for optimal performance.</li>
</ul>
</li>
</ul>
<h3 id="Amazon-EFS-Elastic-File-System"><a href="#Amazon-EFS-Elastic-File-System" class="headerlink" title=" Amazon EFS (Elastic File System)"></a><a name="amazon-efs-elastic-file-system"></a> Amazon EFS (Elastic File System)</h3><ul>
<li><strong>Pros</strong>:<ul>
<li>Fully managed service.</li>
<li>Highly available and durable.</li>
<li>Scales automatically with no need to provision storage.</li>
</ul>
</li>
<li><strong>Cons</strong>:<ul>
<li>Cloud-specific, not suitable for on-premises deployments.</li>
<li>Higher cost compared to self-managed solutions.</li>
</ul>
</li>
</ul>
<h3 id="OpenEBS"><a href="#OpenEBS" class="headerlink" title=" OpenEBS"></a><a name="openebs"></a> OpenEBS</h3><ul>
<li><strong>Pros</strong>:<ul>
<li>Kubernetes-native storage solution.</li>
<li>Easy to deploy and manage.</li>
<li>Supports various storage engines.</li>
</ul>
</li>
<li><strong>Cons</strong>:<ul>
<li>Younger project with a smaller community.</li>
<li>May require more tuning for performance.</li>
</ul>
</li>
</ul>
<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>GlusterFS is a powerful, scalable, and flexible distributed file system that can be effectively integrated with Kubernetes for persistent storage solutions. By following the steps outlined in this guide, you can mount GlusterFS volumes in your Kubernetes Pods. Additionally, understanding the architecture and comparing GlusterFS with other storage alternatives helps in making informed decisions for your storage needs.</p>
<hr>
<p><a name="references"></a></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://docs.gluster.org/">GlusterFS Official Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.redhat.com/en/technologies/storage/gluster">Red Hat Gluster Storage</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gluster/glusterfs">GlusterFS GitHub Repository</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gluster">GlusterFS Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Kubernetes Documentation - Persistent Volumes</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Network_File_System">NFS Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/pacific/">Ceph Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://aws.amazon.com/efs/">Amazon EFS Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://openebs.io/docs">OpenEBS Documentation</a></li>
</ol>
<p>By following these steps and understanding the architecture and comparisons, you can effectively use GlusterFS with Kubernetes and make informed decisions about storage solutions for your Kubernetes clusters.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.whereq.com/2024/10/28/Troubleshooting-Kubernetes-Pod-Stuck-in-Terminating-State-After-Deletion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dazhi Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhereQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | WhereQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/28/Troubleshooting-Kubernetes-Pod-Stuck-in-Terminating-State-After-Deletion/" class="post-title-link" itemprop="url">Troubleshooting Kubernetes: Pod Stuck in Terminating State After Deletion</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-28 21:10:13 / Modified: 21:45:27" itemprop="dateCreated datePublished" datetime="2024-10-28T21:10:13-04:00">2024-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/Troubleshooting/" itemprop="url" rel="index"><span itemprop="name">Troubleshooting</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#problem-background">Problem Background</a></li>
<li><a href="#cause-analysis">Cause Analysis</a><ul>
<li><a href="#-initial-investigation"> Initial Investigation</a></li>
<li><a href="#-kubelet-logs-analysis"> Kubelet Logs Analysis</a><ul>
<li><a href="#suspicious-point-1-pod-ip-retrieval-failure">Suspicious Point 1: Pod IP Retrieval Failure</a></li>
<li><a href="#suspicious-point-2-unmount-failure">Suspicious Point 2: Unmount Failure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#suspicious-points">Suspicious Points</a><ul>
<li><a href="#-suspicious-point-1-pod-ip-retrieval-failure"> Suspicious Point 1: Pod IP Retrieval Failure</a></li>
<li><a href="#-suspicious-point-2-unmount-failure"> Suspicious Point 2: Unmount Failure</a></li>
</ul>
</li>
<li><a href="#pod-deletion-process">Pod Deletion Process</a></li>
<li><a href="#verification-and-testing">Verification and Testing</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<p><a name="introduction"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This document provides a detailed troubleshooting guide for a common Kubernetes issue where a Pod remains in the <code>Terminating</code> state after being deleted using the <code>kubectl delete</code> command. The analysis includes examining logs, identifying suspicious points, and understanding the underlying causes.</p>
<hr>
<p><a name="problem-background"></a></p>
<h2 id="Problem-Background"><a href="#Problem-Background" class="headerlink" title="Problem Background"></a>Problem Background</h2><p>After deleting a business Pod using the <code>kubectl delete</code> command, the Pod remained in the <code>Terminating</code> state.</p>
<hr>
<p><a name="cause-analysis"></a></p>
<h2 id="Cause-Analysis"><a href="#Cause-Analysis" class="headerlink" title="Cause Analysis"></a>Cause Analysis</h2><h3 id="Initial-Investigation"><a href="#Initial-Investigation" class="headerlink" title=" Initial Investigation"></a><a name="initial-investigation"></a> Initial Investigation</h3><p>To begin with, the <code>kubectl describe</code> command was used to inspect the Pod:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubectl describe pod -n xxx cam1-78b6fc6bc8-cjsw5</span><br></pre></td></tr></table></figure>

<p>No obvious anomalies were found in the output.</p>
<h3 id="Kubelet-Logs-Analysis"><a href="#Kubelet-Logs-Analysis" class="headerlink" title=" Kubelet Logs Analysis"></a><a name="kubelet-logs-analysis"></a> Kubelet Logs Analysis</h3><p>Next, the kubelet component logs were examined for any anomalies during the Pod deletion process. The following logs were filtered for relevance:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I0728 16:24:57.339295    9744 kubelet.go:1904] SyncLoop (DELETE, <span class="string">&quot;api&quot;</span>): <span class="string">&quot;cam1-78b6fc6bc8-cjsw5_cam(5c948341-c030-4996-b888-f032577d97b0)&quot;</span></span><br><span class="line">I0728 16:24:57.339720    9744 kuberuntime_container.go:581] Killing container <span class="string">&quot;docker://a73082a4a9a4cec174bb0d1c256cc11d804d93137551b9bfd3e6fa1522e98589&quot;</span> with 60 second grace period</span><br><span class="line">I0728 16:25:18.259418    9744 kubelet.go:1904] SyncLoop (DELETE, <span class="string">&quot;api&quot;</span>): <span class="string">&quot;cam1-78b6fc6bc8-cjsw5_cam(5c948341-c030-4996-b888-f032577d97b0)&quot;</span></span><br><span class="line">2021-07-28 16:25:19.247 [INFO][394011] ipam.go 1173: Releasing all IPs with handle <span class="string">&#x27;cam.cam1-78b6fc6bc8-cjsw5&#x27;</span></span><br><span class="line">2021-07-28 16:25:19.254 [INFO][393585] k8s.go 498: Teardown processing complete.</span><br></pre></td></tr></table></figure>

<h4 id="Suspicious-Point-1-Pod-IP-Retrieval-Failure"><a href="#Suspicious-Point-1-Pod-IP-Retrieval-Failure" class="headerlink" title="Suspicious Point 1: Pod IP Retrieval Failure"></a>Suspicious Point 1: Pod IP Retrieval Failure</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">W0728 16:25:19.303513    9744 docker_sandbox.go:384] failed to <span class="built_in">read</span> pod IP from plugin/docker: NetworkPlugin cni failed on the status hook <span class="keyword">for</span> pod <span class="string">&quot;cam1-78b6fc6bc8-cjsw5_cam&quot;</span>: Unexpected <span class="built_in">command</span> output Device <span class="string">&quot;eth0&quot;</span> does not exist.</span><br><span class="line"> with error: <span class="built_in">exit</span> status 1</span><br></pre></td></tr></table></figure>

<h4 id="Suspicious-Point-2-Unmount-Failure"><a href="#Suspicious-Point-2-Unmount-Failure" class="headerlink" title="Suspicious Point 2: Unmount Failure"></a>Suspicious Point 2: Unmount Failure</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E0728 16:25:20.939400    9744 nestedpendingoperations.go:301] Operation <span class="keyword">for</span> <span class="string">&quot;&#123;volumeName:kubernetes.io/glusterfs/5c948341-c030-4996-b888-f032577d97b0-cam-pv-50g podName:5c948341-c030-4996-b888-f032577d97b0 nodeName:&#125;&quot;</span> failed. No retries permitted <span class="keyword">until</span> 2021-07-28 16:25:21.439325811 +0800 CST m=+199182.605079651 (durationBeforeRetry 500ms). Error: <span class="string">&quot;UnmountVolume.TearDown failed for volume \&quot;diag-log\&quot; (UniqueName: \&quot;kubernetes.io/glusterfs/5c948341-c030-4996-b888-f032577d97b0-cam-pv-50g\&quot;) pod \&quot;5c948341-c030-4996-b888-f032577d97b0\&quot; (UID: \&quot;5c948341-c030-4996-b888-f032577d97b0\&quot;) : Unmount failed: exit status 32\nUnmounting arguments: /var/lib/kubelet/pods/5c948341-c030-4996-b888-f032577d97b0/volumes/kubernetes.io~glusterfs/cam-pv-50g\nOutput: umount: /var/lib/kubelet/pods/5c948341-c030-4996-b888-f032577d97b0/volumes/kubernetes.io~glusterfs/cam-pv-50g：Target is busy.\n        (In some case using lsof(8) or fuser(1) can\n find useful information about the process using the device)\n\n&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="suspicious-points"></a></p>
<h2 id="Suspicious-Points"><a href="#Suspicious-Points" class="headerlink" title="Suspicious Points"></a>Suspicious Points</h2><h3 id="Suspicious-Point-1-Pod-IP-Retrieval-Failure-1"><a href="#Suspicious-Point-1-Pod-IP-Retrieval-Failure-1" class="headerlink" title=" Suspicious Point 1: Pod IP Retrieval Failure"></a><a name="suspicious-point-1-pod-ip-retrieval-failure"></a> Suspicious Point 1: Pod IP Retrieval Failure</h3><p>The log indicates a failure to retrieve the Pod IP:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">W0728 16:25:19.303513    9744 docker_sandbox.go:384] failed to <span class="built_in">read</span> pod IP from plugin/docker: NetworkPlugin cni failed on the status hook <span class="keyword">for</span> pod <span class="string">&quot;cam1-78b6fc6bc8-cjsw5_cam&quot;</span>: Unexpected <span class="built_in">command</span> output Device <span class="string">&quot;eth0&quot;</span> does not exist.</span><br><span class="line"> with error: <span class="built_in">exit</span> status 1</span><br></pre></td></tr></table></figure>

<p>This error was traced to the <code>getIP</code> method in the <code>docker_sandbox.go</code> file:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ds *dockerService)</span></span> getIP(podSandboxID <span class="type">string</span>, sandbox *dockertypes.ContainerJSON) <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> sandbox.NetworkSettings == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> networkNamespaceMode(sandbox) == runtimeapi.NamespaceMode_NODE &#123;</span><br><span class="line">        <span class="comment">// For sandboxes using host network, the shim is not responsible for</span></span><br><span class="line">        <span class="comment">// reporting the IP.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t bother getting IP if the pod is known and networking isn&#x27;t ready</span></span><br><span class="line">    ready, ok := ds.getNetworkReady(podSandboxID)</span><br><span class="line">    <span class="keyword">if</span> ok &amp;&amp; !ready &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ip, err := ds.getIPFromPlugin(sandbox)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ip</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> sandbox.NetworkSettings.IPAddress != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sandbox.NetworkSettings.IPAddress</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sandbox.NetworkSettings.GlobalIPv6Address != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sandbox.NetworkSettings.GlobalIPv6Address</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Error log here</span></span><br><span class="line">    klog.Warningf(<span class="string">&quot;failed to read pod IP from plugin/docker: %v&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Suspicious-Point-2-Unmount-Failure-1"><a href="#Suspicious-Point-2-Unmount-Failure-1" class="headerlink" title=" Suspicious Point 2: Unmount Failure"></a><a name="suspicious-point-2-unmount-failure"></a> Suspicious Point 2: Unmount Failure</h3><p>The unmount failure was logged as an ERROR:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E0728 16:25:20.939400    9744 nestedpendingoperations.go:301] Operation <span class="keyword">for</span> <span class="string">&quot;&#123;volumeName:kubernetes.io/glusterfs/5c948341-c030-4996-b888-f032577d97b0-cam-pv-50g podName:5c948341-c030-4996-b888-f032577d97b0 nodeName:&#125;&quot;</span> failed. No retries permitted <span class="keyword">until</span> 2021-07-28 16:25:21.439325811 +0800 CST m=+199182.605079651 (durationBeforeRetry 500ms). Error: <span class="string">&quot;UnmountVolume.TearDown failed for volume \&quot;diag-log\&quot; (UniqueName: \&quot;kubernetes.io/glusterfs/5c948341-c030-4996-b888-f032577d97b0-cam-pv-50g\&quot;) pod \&quot;5c948341-c030-4996-b888-f032577d97b0\&quot; (UID: \&quot;5c948341-c030-4996-b888-f032577d97b0\&quot;) : Unmount failed: exit status 32\nUnmounting arguments: /var/lib/kubelet/pods/5c948341-c030-4996-b888-f032577d97b0/volumes/kubernetes.io~glusterfs/cam-pv-50g\nOutput: umount: /var/lib/kubelet/pods/5c948341-c030-4996-b888-f032577d97b0/volumes/kubernetes.io~glusterfs/cam-pv-50g：Target is busy.\n        (In some case using lsof(8) or fuser(1) can\n find useful information about the process using the device)\n\n&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="pod-deletion-process"></a></p>
<h2 id="Pod-Deletion-Process"><a href="#Pod-Deletion-Process" class="headerlink" title="Pod Deletion Process"></a>Pod Deletion Process</h2><p>The deletion of a Pod in Kubernetes follows these steps:</p>
<ol>
<li><strong>API Server DELETE Call</strong>: The <code>kubectl delete</code> command triggers a DELETE request to the Kubernetes API server with a default grace period of 30 seconds.</li>
<li><strong>Update Pod Metadata</strong>: The Pod’s metadata is updated with <code>DeletionTimestamp</code> and <code>DeletionGracePeriodSeconds</code> fields, but the Pod is not yet deleted from etcd.</li>
<li><strong>Kubelet Event Handling</strong>: The kubelet component listens for Pod updates and initiates the <code>killPod()</code> method.</li>
<li><strong>Second DELETE Call</strong>: The kubelet makes a second DELETE request to the API server with a grace period of 0 seconds.</li>
<li><strong>Pod Deletion from etcd</strong>: The API server deletes the Pod from etcd.</li>
</ol>
<hr>
<p><a name="verification-and-testing"></a></p>
<h2 id="Verification-and-Testing"><a href="#Verification-and-Testing" class="headerlink" title="Verification and Testing"></a>Verification and Testing</h2><p>To verify the deletion process, a test was conducted in a test environment:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# kubectl delete pod -n xxx testpodrc2-7b749f6c9c-qh68l</span><br><span class="line">pod <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>Filtered kubelet logs:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">I0730 13:27:31.854178   24588 kubelet.go:1904] SyncLoop (DELETE, <span class="string">&quot;api&quot;</span>): <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l_testpod(85ee282f-a843-4f10-a99c-79d447f83f2a)&quot;</span></span><br><span class="line">I0730 13:27:31.854511   24588 kuberuntime_container.go:581] Killing container <span class="string">&quot;docker://e2a1cd5f2165e12cf0b46e12f9cd4d656d593f75e85c0de058e0a2f376a5557e&quot;</span> with 30 second grace period</span><br><span class="line">I0730 13:27:32.203167   24588 kubelet.go:1904] SyncLoop (DELETE, <span class="string">&quot;api&quot;</span>): <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l_testpod(85ee282f-a843-4f10-a99c-79d447f83f2a)&quot;</span></span><br><span class="line">I0730 13:27:32.993294   24588 kubelet.go:1933] SyncLoop (PLEG): <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l_testpod(85ee282f-a843-4f10-a99c-79d447f83f2a)&quot;</span>, event: &amp;pleg.PodLifecycleEvent&#123;ID:<span class="string">&quot;85ee282f-a843-4f10-a99c-79d447f83f2a&quot;</span>, Type:<span class="string">&quot;ContainerDied&quot;</span>, Data:<span class="string">&quot;e2a1cd5f2165e12cf0b46e12f9cd4d656d593f75e85c0de058e0a2f376a5557e&quot;</span>&#125;</span><br><span class="line">I0730 13:27:32.993428   24588 kubelet.go:1933] SyncLoop (PLEG): <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l_testpod(85ee282f-a843-4f10-a99c-79d447f83f2a)&quot;</span>, event: &amp;pleg.PodLifecycleEvent&#123;ID:<span class="string">&quot;85ee282f-a843-4f10-a99c-79d447f83f2a&quot;</span>, Type:<span class="string">&quot;ContainerDied&quot;</span>, Data:<span class="string">&quot;c6a587614976beed0cbb6e5fabf70a2d039eec6c160154fce007fe2bb1ba3b4f&quot;</span>&#125;</span><br><span class="line">I0730 13:27:34.072494   24588 kubelet_pods.go:1090] Killing unwanted pod <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l&quot;</span></span><br><span class="line">I0730 13:27:40.084182   24588 kubelet.go:1904] SyncLoop (DELETE, <span class="string">&quot;api&quot;</span>): <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l_testpod(85ee282f-a843-4f10-a99c-79d447f83f2a)&quot;</span></span><br><span class="line">I0730 13:27:40.085735   24588 kubelet.go:1898] SyncLoop (REMOVE, <span class="string">&quot;api&quot;</span>): <span class="string">&quot;testpodrc2-7b749f6c9c-qh68l_testpod(85ee282f-a843-4f10-a99c-79d447f83f2a)&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><a name="conclusion"></a></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The analysis revealed that the Pod remained in the <code>Terminating</code> state due to a failure in unmounting the GlusterFS volume. The unmount failure was caused by the volume being busy, which prevented the second DELETE</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dazhi Zhang</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js","integrity":"sha256-YbM1pG3wWnzhyYN49g5fPnen+2CKEFaZfopkkwSpNtY="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
